<html>
<head>
<title>Creating scalable NLP pipelines with Nlphose, Kafka and Kubernetes</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Nlphose、Kafka和Kubernetes创建可扩展的NLP管道</h1>
<blockquote>原文：<a href="https://medium.com/mlearning-ai/creating-scalable-nlp-pipelines-with-nlphose-kafka-and-kubernetes-256feeca8935?source=collection_archive---------1-----------------------#2021-12-13">https://medium.com/mlearning-ai/creating-scalable-nlp-pipelines-with-nlphose-kafka-and-kubernetes-256feeca8935?source=collection_archive---------1-----------------------#2021-12-13</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><figure class="ev ex if ig ih ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es ie"><img src="../Images/ab8ca86a692ef30c8f1de1943626ef72.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*cm5rCoS7vWWWQ1CF.png"/></div></div></figure><p id="e57e" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">一个典型的自然语言处理(NLP)流水线通过使用在不同编程语言和框架中创建的模型包含许多推理任务。今天，有许多基于单一ML模型部署和扩展推理方法的既定方法。但是，扩展管道并不那么简单。在本文中，我们将看到如何使用我的开源项目Nlphose、Kafka和Kubernetes创建一个可伸缩的NLP管道，理论上可以并行处理数千条文本消息。</p><h1 id="3300" class="jn jo hh bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">Nlphose简介</h1><p id="a8cf" class="pw-post-body-paragraph ip iq hh ir b is kl iu iv iw km iy iz ja kn jc jd je ko jg jh ji kp jk jl jm ha bi translated">使用一组简单的命令行工具，可以在几秒钟内创建复杂的NLP管道，用于处理静态文件或流文本。不需要编程！您可以在终端中执行单个命令，对文本执行多种操作，如NER、情感分析、分块、语言识别、Q &amp; A、0-shot分类等。你可以在这里【https://github.com/code2k13/nlphose<a class="ae kq" href="https://github.com/code2k13/nlphose" rel="noopener ugc nofollow" target="_blank">阅读更多关于这个项目的信息。Nlphose还有一个GUI查询生成器工具，允许您通过拖放在浏览器中创建复杂的NLP管道。你可以在这里查看工具:【https://ashishware.com/static/nlphose.html】T4</a></p><h1 id="8f21" class="jn jo hh bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">创建一个管道</h1><p id="426d" class="pw-post-body-paragraph ip iq hh ir b is kl iu iv iw km iy iz ja kn jc jd je ko jg jh ji kp jk jl jm ha bi translated">最近，我在我的项目中添加了两个组件:</p><ul class=""><li id="3825" class="kr ks hh ir b is it iw ix ja kt je ku ji kv jm kw kx ky kz bi translated"><a class="ae kq" href="https://github.com/code2k13/nlphose/wiki/Kafka-Source" rel="noopener ugc nofollow" target="_blank"> Kafka2json.py </a> —该工具类似于<a class="ae kq" href="https://docs.confluent.io/platform/current/app-development/kafkacat-usage.html" rel="noopener ugc nofollow" target="_blank"> kafkacat </a>。它可以监听Kafka主题，并将文本数据传输到管道的其余部分。</li><li id="1c8c" class="kr ks hh ir b is la iw lb ja lc je ld ji le jm kw kx ky kz bi translated"><a class="ae kq" href="https://github.com/code2k13/nlphose/wiki/Kafka-Sink" rel="noopener ugc nofollow" target="_blank"> Kafkasink.py </a> —该工具在NLP管道中充当“接收器”，并将管道的输出写入Kafka主题。</li></ul><p id="a625" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">在本文中，我们将使用图形查询生成器工具来创建一个复杂的NLP管道，如下所示:</p><figure class="lg lh li lj fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es lf"><img src="../Images/83da26c4ce00750b859b60ee3d0d0c29.png" data-original-src="https://miro.medium.com/v2/resize:fit:1252/format:webp/0*IL6huC5Lv_xh1FVj.png"/></div></div></figure><p id="c05a" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">管道做以下事情:</p><ul class=""><li id="370e" class="kr ks hh ir b is it iw ix ja kt je ku ji kv jm kw kx ky kz bi translated">听一个关于卡夫卡的话题，叫做“nlphose”</li><li id="dde3" class="kr ks hh ir b is la iw lb ja lc je ld ji le jm kw kx ky kz bi translated">命名实体识别(位置的自动地理标记)</li><li id="88fd" class="kr ks hh ir b is la iw lb ja lc je ld ji le jm kw kx ky kz bi translated">语言识别</li><li id="c7a7" class="kr ks hh ir b is la iw lb ja lc je ld ji le jm kw kx ky kz bi translated">寻找“有多少颗行星？”这个问题的答案，采用抽取式问答技术。</li><li id="9622" class="kr ks hh ir b is la iw lb ja lc je ld ji le jm kw kx ky kz bi translated">将管道的输出写入Kafka主题“nlpoutput”</li></ul><p id="03b8" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">以上管道的Nlphose命令如下所示:</p><pre class="lg lh li lj fd lk ll lm ln aw lo bi"><span id="05f3" class="lp jo hh ll b fi lq lr l ls lt">./kafka2json.py -topic nlphose -endpoint localhost:9092 -groupId grp1 |\<br/>./entity.py |\<br/>./lang.py |\<br/>./xformer.py --pipeline question-answering --param 'How many planets are there?' |\<br/>./kafkasink.py -topic nlpoutput -endpoint localhost:9092</span></pre><h1 id="f6b6" class="jn jo hh bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">配置Kafka</h1><p id="5a31" class="pw-post-body-paragraph ip iq hh ir b is kl iu iv iw km iy iz ja kn jc jd je ko jg jh ji kp jk jl jm ha bi translated">本文假设您已经有了一个Kafka实例，并在其上创建了两个主题“nlphose”和“nlpoutput”。如果您无法访问Kafka实例，请参考本<a class="ae kq" href="https://kafka.apache.org/quickstart" rel="noopener ugc nofollow" target="_blank">快速入门指南</a>在您的开发机器上安装Kafka。Kafka实例应该可以被所有运行Nlphose管道的机器或Kubernetes集群访问。在本例中,“nlphose”主题有16个分区。我们将在一个组中使用多个消费者来订阅这个主题并并发地处理消息。</p><h1 id="a2ff" class="jn jo hh bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">在Kubernetes部署Nlphose管道</h1><p id="b616" class="pw-post-body-paragraph ip iq hh ir b is kl iu iv iw km iy iz ja kn jc jd je ko jg jh ji kp jk jl jm ha bi translated">Nlphose的<a class="ae kq" href="https://hub.docker.com/r/code2k13/nlphose" rel="noopener ugc nofollow" target="_blank">带有一个docker镜像</a>，包含了它运行所需的所有代码和模型。您只需在Kubernetes中创建一个部署来运行这个管道。下面给出了一个示例部署文件:</p><pre class="lg lh li lj fd lk ll lm ln aw lo bi"><span id="7f5e" class="lp jo hh ll b fi lq lr l ls lt">apiVersion: apps/v1<br/>kind: Deployment<br/>metadata:<br/>  name: nlphose<br/>  labels:<br/>    app: nlphose<br/>spec:<br/>  replicas: 6<br/>  selector:<br/>    matchLabels:<br/>      app: nlphose<br/>  template:<br/>    metadata:<br/>      labels:<br/>        app: nlphose<br/>    spec:<br/>      containers:<br/>      - name: nlphose<br/>        image: code2k13/nlphose:latest<br/>        command: ["/bin/sh"]<br/>        #args: ["-c", "while true; do echo Done Deploying sv-premier; sleep 3600;done"]<br/>        #command: [" "]<br/>        #args: ["pwd "]<br/>        args: ["-c","cd /usr/src/app/nlphose/scripts &amp;&amp; ./kafka2json.py -topic nlphose -endpoint 127.0.0.1:9092 -groupId grp1 | ./entity.py | ./lang.py | ./xformer.py --pipeline question-answering --param 'How many planets are there ?' | ./kafkasink.py -topic nlpoutput -endpoint 127.0.0.1:9092"]</span></pre><blockquote class="lu lv lw"><p id="e1f1" class="ip iq lx ir b is it iu iv iw ix iy iz ly jb jc jd lz jf jg jh ma jj jk jl jm ha bi translated">请确保将“127.0.0.1:9092”更改为Kafka实例的正确IP和端口。</p></blockquote><h1 id="415a" class="jn jo hh bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">在没有Kubernetes的情况下部署Nlphose管道</h1><p id="74f4" class="pw-post-body-paragraph ip iq hh ir b is kl iu iv iw km iy iz ja kn jc jd je ko jg jh ji kp jk jl jm ha bi translated">Kubernetes并不强制使用Nlphose创建可伸缩的管道。由于Nlphose管道只是一组shell命令，因此您可以在多台裸机或虚拟机或PaaS解决方案上运行这些命令。当与Kafka插件一起使用时，Nlphose能够并发处理Kafka消息，只要在运行管道的所有计算机上使用相同的groupId。只需从GUI查询生成器复制粘贴输出，并将其粘贴到目标机器的终端中。您有一个并行执行管道的计算机集群！</p><h1 id="c10c" class="jn jo hh bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">基准和结果</h1><p id="3d74" class="pw-post-body-paragraph ip iq hh ir b is kl iu iv iw km iy iz ja kn jc jd je ko jg jh ji kp jk jl jm ha bi translated">我创建了一个小程序，在Kafka主题“nlphose”上持续发布以下消息:</p><pre class="lg lh li lj fd lk ll lm ln aw lo bi"><span id="c2f0" class="lp jo hh ll b fi lq lr l ls lt">message = {<br/> "id": "uuid",<br/> "text": "The solar system has nine planet. Earth is the only plant with life.Jupiter is the largest planet. Pluto is the smallest planet."<br/>}</span></pre><p id="a6e0" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">管道生成的相应已处理消息如下所示:</p><pre class="lg lh li lj fd lk ll lm ln aw lo bi"><span id="e12f" class="lp jo hh ll b fi lq lr l ls lt">{<br/>  "id": "79bde3c1-3e43-46c0-be00-d730cd240d5a",<br/>  "text": "The solar system has nine planets. Earth is the only plant with life.Jupiter is the largest planet. Pluto is the smallest planet.",<br/>  "entities": [<br/>    {<br/>      "label": "CARDINAL",<br/>      "entity": "nine"<br/>    },<br/>    {<br/>      "label": "LOC",<br/>      "entity": "Earth"<br/>    },<br/>    {<br/>      "label": "LOC",<br/>      "entity": "Jupiter"<br/>    }<br/>  ],<br/>  "lang": "en",<br/>  "xfrmr_question_answering": {<br/>    "score": 0.89333176612854,<br/>    "start": 21,<br/>    "end": 25,<br/>    "answer": "nine"<br/>  }<br/>}</span></pre><p id="a6d0" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">下图显示了我在GKE和一个自主运行的Kafka实例上进行的实验结果。从下面的图表可以清楚地看出，处理请求所需的时间随着实例的增加而减少。</p><figure class="lg lh li lj fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es mb"><img src="../Images/8e9f9ad4868599a95674073b2af54338.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*PR5JFPwCJMkZLzc0.png"/></div></div></figure><h1 id="c711" class="jn jo hh bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">结论</h1><p id="b2f6" class="pw-post-body-paragraph ip iq hh ir b is kl iu iv iw km iy iz ja kn jc jd je ko jg jh ji kp jk jl jm ha bi translated">随着新Kafka插件的加入，Nlphose已经成为一个真正的大数据工具。我一直在努力让它对最终用户更有用，更容易操作。Nlphose可以与Kubernetes、Docker或裸机配合使用。此外，如果你坚持项目的<a class="ae kq" href="https://github.com/code2k13/nlphose/wiki/Architecture-of-nlphose" rel="noopener ugc nofollow" target="_blank">指导原则</a>，你可以很容易地为这些管道定制或添加新工具。希望这篇文章对你有用。随时欢迎建议和评论！</p><div class="mc md ez fb me mf"><a rel="noopener follow" target="_blank" href="/mlearning-ai/mlearning-ai-submission-suggestions-b51e2b130bfb"><div class="mg ab dw"><div class="mh ab mi cl cj mj"><h2 class="bd hi fi z dy mk ea eb ml ed ef hg bi translated">Mlearning.ai提交建议</h2><div class="mm l"><h3 class="bd b fi z dy mk ea eb ml ed ef dx translated">如何成为Mlearning.ai上的作家</h3></div><div class="mn l"><p class="bd b fp z dy mk ea eb ml ed ef dx translated">medium.com</p></div></div><div class="mo l"><div class="mp l mq mr ms mo mt in mf"/></div></div></a></div></div></div>    
</body>
</html>