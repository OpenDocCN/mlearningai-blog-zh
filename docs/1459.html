<html>
<head>
<title>Collaborative Filtering Similarity Calculations</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">协同过滤相似度计算</h1>
<blockquote>原文：<a href="https://medium.com/mlearning-ai/collaborative-filtering-similarity-calculations-a974ae4650?source=collection_archive---------0-----------------------#2021-12-21">https://medium.com/mlearning-ai/collaborative-filtering-similarity-calculations-a974ae4650?source=collection_archive---------0-----------------------#2021-12-21</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><figure class="ev ex if ig ih ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es ie"><img src="../Images/bd7d81a9e9824d90248a4f4dc9314709.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4-AIyan_aMlCmTLeYIAVBQ.jpeg"/></div></div><figcaption class="ip iq et er es ir is bd b be z dx">image of a matrix with user ratings</figcaption></figure><p id="6d2f" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">在<a class="ae jr" href="https://nagendranukala.medium.com/collaborative-filtering-fundamentals-d2d845e1de75" rel="noopener">的上一篇文章</a>中，我们回顾了构成项目-项目协同过滤流程的所有组件的高级概述。在这篇文章中，我们将通过一个电影分级的例子来回顾相似性计算的数学过程。这些计算是今天复杂的推荐系统中发生的事情的简化版本，但是它确实给读者一个在开发一个协同过滤推荐系统中涉及的基础数学的概念。</p><p id="c98b" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">推荐系统由多个过程组成，它们被连接在一起共同工作，因此我们将整个系统称为一个管道，下面是我们将在管道版本中涉及的主要步骤:</p><ol class=""><li id="072c" class="js jt hh iv b iw ix ja jb je ju ji jv jm jw jq jx jy jz ka bi translated">对于属于评级矩阵一部分的活动用户，计算要预测的项目与所有其他项目之间的相似性。</li><li id="7af2" class="js jt hh iv b iw kb ja kc je kd ji ke jm kf jq jx jy jz ka bi translated">根据相似性对项目进行排序。</li><li id="6593" class="js jt hh iv b iw kb ja kc je kd ji ke jm kf jq jx jy jz ka bi translated">选择邻居。</li><li id="deaf" class="js jt hh iv b iw kb ja kc je kd ji ke jm kf jq jx jy jz ka bi translated">计算预测评级。</li></ol><p id="0967" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">这里我们需要做的第一件事是选择一个相似性方法。记住，我们已经在T2的文章中讨论过不同种类的这些。对于这个计算，我们将使用余弦相似度方法。</p><p id="1e67" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">分级矩阵示例，1为电影的最低分级，5为最高分级:</p><figure class="kh ki kj kk fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es kg"><img src="../Images/f0481bd145c324478264ebfdd0e6c64f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fvHMEpRY8VpyZ8XNHWMc6g.png"/></div></div><figcaption class="ip iq et er es ir is bd b be z dx">Movie rating matrix for 6 users rating 6 movies</figcaption></figure><p id="3c19" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated"><strong class="iv hi">相似度计算:</strong>所有用户都给Home Alone (HA)评分，所以我们会依次查看每个用户。用户是Abhilash，他也给《黑客帝国》( Matrix)、《复仇者联盟4：终局之战》、《肖申克的救赎》( Shawshank Redemption)和《教父》( Godfather)评分。我们会把他的评分加入到有Home only(HA)的物品列表中，所以我们有:HA: [TM，AE，SR，TG]。接下来是迪莎，她对以上榜单中的电影加上《宿醉》(TH)进行了评分。一个项目只能添加一次。我们会一行一行的去，把用户评价过的电影放在一起。让我们一起计算所有电影的评分列表，如下所示:</p><ul class=""><li id="67b7" class="js jt hh iv b iw ix ja jb je ju ji jv jm jw jq kl jy jz ka bi translated">HA: [TM，TH，AE，SR，TG]</li><li id="8b88" class="js jt hh iv b iw kb ja kc je kd ji ke jm kf jq kl jy jz ka bi translated">TM: [HA，TH，AE，SR，TG]</li><li id="d595" class="js jt hh iv b iw kb ja kc je kd ji ke jm kf jq kl jy jz ka bi translated">TH: [HA，TM，AE，SR，TG]</li><li id="94c4" class="js jt hh iv b iw kb ja kc je kd ji ke jm kf jq kl jy jz ka bi translated">SR: [HA，TM，TH，AE，TG]</li><li id="c383" class="js jt hh iv b iw kb ja kc je kd ji ke jm kf jq kl jy jz ka bi translated">甲状腺激素:[HA，TM，TH，AE，SR]</li></ul><p id="3d35" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">有了这些列表，我们就可以计算出每个项目与另一个项目的相似性。我们将使用调整后的余弦相似度函数来计算这一点。为了准备这种方法，我们必须根据用户的平均评分来标准化项目评分。该公式定义为:</p><figure class="kh ki kj kk fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es km"><img src="../Images/f196ddbc6b0ee1e4a7b7b8e36d9ef0dd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*xN5ImT8X2c_JbwhG"/></div></div><figcaption class="ip iq et er es ir is bd b be z dx">formula for normalizing the user rating</figcaption></figure><p id="b043" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">下面是按平均用户评分标准化评分后的评分矩阵:</p><figure class="kh ki kj kk fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es kn"><img src="../Images/ff3fa3e15ccb4c430f9fa7166d35cfaf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZWofmZfuH9YoWaMqQLPXRA.png"/></div></div></figure><p id="5d5a" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">如上表中突出显示的用于计算两部电影(Ha，TM)之间的相似性的公式如下:</p><figure class="kh ki kj kk fd ii er es paragraph-image"><div class="er es ko"><img src="../Images/e9eb50aaa672df6ddd1e12e79b3e5f8a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1326/format:webp/1*HUhE3OGyDSZmCFtaafv-Aw.png"/></div></figure><p id="2675" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">让我们用一些数字来表示这个等式，并根据上面的评级得出这两部电影之间的相似性:</p><figure class="kh ki kj kk fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es kp"><img src="../Images/0dbccd11e7cb87a83c2d921286cee66f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*2xPup0Kfh4COOz_Q"/></div></div><figcaption class="ip iq et er es ir is bd b be z dx">calculation for the similarity rating between two items</figcaption></figure><p id="66ee" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">余弦相似度给出-1和1之间的值。</p><p id="3cba" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">下面是根据我们对一双鞋的计算得出的完整评分矩阵。</p><figure class="kh ki kj kk fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es kq"><img src="../Images/04917a8f889d8f452574ec9074febe0f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0lDwiWwrPrvanWCgi3ExMg.png"/></div></div><figcaption class="ip iq et er es ir is bd b be z dx">similarity matrix for the rating array, negative correlation has been marked progressively red and positive has been marked green</figcaption></figure><ul class=""><li id="f770" class="js jt hh iv b iw ix ja jb je ju ji jv jm jw jq kl jy jz ka bi translated"><strong class="iv hi">接近1 </strong>:如果两个项目非常相似，那么值往往更接近1，例如TH和HA，它们彼此之间非常相关，与图表上的任何其他项目都没有相关性。</li><li id="b60a" class="js jt hh iv b iw kb ja kc je kd ji ke jm kf jq kl jy jz ka bi translated"><strong class="iv hi">接近-1: </strong>如果它们非常不相似，则值趋向于接近-1，例如HA和TM彼此非常不相似</li><li id="27c3" class="js jt hh iv b iw kb ja kc je kd ji ke jm kf jq kl jy jz ka bi translated"><strong class="iv hi">接近0: </strong>如果没有太大的相关性，那么数值就趋于0左右。有趣的是，TM和TG似乎没有任何关联，即使是在故事方面，它们似乎是截然相反的，但都是我最喜欢的:-)</li></ul><p id="4a54" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">根据我们对评分所做的计算，我们确实看到HA和TM之间有很大的不同，我非常同意这一点，但我们需要记住，这些相似性计算仅基于评分，这是一个显式值，我们根据用户所说的进行。当我们有较少的重叠评级或较少的用户评级时，计算是不确定的，这被称为冷启动问题。在上面的矩阵中，我们将空值替换为0，通常有更科学的插补方法用于处理缺失值，这本身就可以是一个完整的博客系列。</p><p id="b676" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">这里是我用来计算列的余弦相似性的python代码片段，请随意尝试。</p><pre class="kh ki kj kk fd kr ks kt ku aw kv bi"><span id="e32b" class="kw kx hh ks b fi ky kz l la lb">import numpy as np</span><span id="c990" class="kw kx hh ks b fi lc kz l la lb">from sklearn.metrics.pairwise import cosine_similarity</span><span id="d26d" class="kw kx hh ks b fi lc kz l la lb">from scipy import sparse</span><span id="3ae7" class="kw kx hh ks b fi lc kz l la lb">A = np.array(</span><span id="b82b" class="kw kx hh ks b fi lc kz l la lb">[[-1.80, 1.20, 0, 0.20, -0.80, 1.20],</span><span id="75af" class="kw kx hh ks b fi lc kz l la lb">[0.80, -0.20, 0.80, -1.20, 0, -0.20],</span><span id="7114" class="kw kx hh ks b fi lc kz l la lb">[-0.83, 1.17, -1.83, 1.17, 0.17, 0.17],</span><span id="76ab" class="kw kx hh ks b fi lc kz l la lb">[2, 0, 2, 0, -2, -2],</span><span id="dbbe" class="kw kx hh ks b fi lc kz l la lb">[0.67, -0.33, 0.67, -0.33, -2.33, 1.67],</span><span id="8b75" class="kw kx hh ks b fi lc kz l la lb">[-1.17, 0.83, -0.17, 0.83, 1.83, -2.17]])</span><span id="6785" class="kw kx hh ks b fi lc kz l la lb">A_sparse = sparse.csr_matrix(A)</span><span id="8c77" class="kw kx hh ks b fi lc kz l la lb">similarities = cosine_similarity(A_sparse.transpose())</span><span id="5830" class="kw kx hh ks b fi lc kz l la lb">print('pairwise dense output:\n {}\n'.format(similarities))</span></pre><p id="ded4" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated"><strong class="iv hi">寻找邻居:</strong>现在我们有了相似度矩阵，我们将进入推荐流程的下一步，寻找邻居。主要有两种类型，Top N和threshold，关于它的详细内容在我的<a class="ae jr" href="https://nagendranukala.medium.com/collaborative-filtering-fundamentals-d2d845e1de75" rel="noopener">早前的文章</a>中。为简单起见，我们将使用top 2和0.5作为阈值，这样我们就可以看到在这两种方法中邻居是如何排列的:</p><figure class="kh ki kj kk fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es ld"><img src="../Images/c5d8e4f0d40d94d1d792649fd291ace7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*v3Q-OMrk2fUK5MZfvqZ9BQ.png"/></div></div><figcaption class="ip iq et er es ir is bd b be z dx">neighbour calculation using Top 2 in Top-N and 0.5 as threshold</figcaption></figure><p id="2693" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">根据建议解决方案将解决的使用案例选择正确的方法非常重要，因为您可以看到基于阈值的邻居显示出更强的相似性，但结果较少。Top N型保证了产量，但是质量低，关系弱，因为我们也出现了一些负相关。</p><p id="001b" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated"><strong class="iv hi">计算预测:</strong>有几种方法可以运行预测计算，其中两种是我们之前讨论过的回归和分类方法。在我之前的文章中有更多关于这些的细节。这里我们用回归方法进行预测计算，公式如下:</p><figure class="kh ki kj kk fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es le"><img src="../Images/0650e0910af7afd69ba78cb0b4809985.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*UGymLltMr5KuY945"/></div></div><figcaption class="ip iq et er es ir is bd b be z dx">prediction score calculation formula and explanation of terms</figcaption></figure><p id="4987" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">让我们用公式来计算拉曼对矩阵的评级(TM)。对于这个计算，我们将使用邻域中的电影，我们从上面的邻域表中知道TM: AE: 0.72，SR:0.21。让我们在上面的函数中使用这些数字:</p><figure class="kh ki kj kk fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es lf"><img src="../Images/c3e8fd5d15d49cf208b6e0de4f925640.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fm3V0-SMcrikJ7j1NigC5A.png"/></div></div><figcaption class="ip iq et er es ir is bd b be z dx">calculation of user’s prediction for a movie by plugging values from the formula above</figcaption></figure><p id="ac1f" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">我们非常接近实际评级，拉曼将TM评级为3。现在我们有了预测，很容易生成推荐，我们对许多类似的项目重复这个计算，并将top N返回给请求推荐的客户端，瞧！建议小部件中填充了相关项目。</p><p id="78b4" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">当然，当建议被大规模执行时，有许多操作需要完成，这就是ML ops世界被引入的地方。我们需要评估这种计算密集型计算有多少可以离线完成，如何使数据符合训练和测试的要求，设置输入数据和模型输出的连续验证，模型漂移和数据漂移计算，以及触发模型再训练管道的因素。所有这些项目本身就是一个完整的世界，但现在，让我们高兴的是，我们知道了推荐引擎背后的基本数学。</p><p id="c17f" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">如果你对阅读推荐系统感兴趣，下面提到的这本书绝对是必读的，我在这篇文章中写的大部分内容是这本书的一个章节的总结。</p><ul class=""><li id="c264" class="js jt hh iv b iw ix ja jb je ju ji jv jm jw jq kl jy jz ka bi translated">《实用推荐系统》——作者Kim Falk——可在o'reilly online上找到。</li><li id="8ed5" class="js jt hh iv b iw kb ja kc je kd ji ke jm kf jq kl jy jz ka bi translated">Badrul Sarwar等人的“基于项目的协同过滤推荐算法”——【http://files.grouplens.org/papers/www10_sarwar.pdf】T3<a class="ae jr" href="http://files.grouplens.org/papers/www10_sarwar.pdf" rel="noopener ugc nofollow" target="_blank">T5</a></li></ul><p id="a74e" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated"><em class="lg"> PS:我写这篇文章的时候很开心，部分原因是因为这个话题对我来说很重要，但更重要的是因为评分矩阵中提到的人是我非常亲密的朋友，所以这篇文章让我回到了我的学生时代，让我想起了我们所有人的美好时光。此外，人民是真实的，评级不是他们的，所以请不要用上面的评级来判断他们的选择；——)</em></p><div class="lh li ez fb lj lk"><a rel="noopener follow" target="_blank" href="/mlearning-ai/mlearning-ai-submission-suggestions-b51e2b130bfb"><div class="ll ab dw"><div class="lm ab ln cl cj lo"><h2 class="bd hi fi z dy lp ea eb lq ed ef hg bi translated">Mlearning.ai提交建议</h2><div class="lr l"><h3 class="bd b fi z dy lp ea eb lq ed ef dx translated">如何成为Mlearning.ai上的作家</h3></div><div class="ls l"><p class="bd b fp z dy lp ea eb lq ed ef dx translated">medium.com</p></div></div><div class="lt l"><div class="lu l lv lw lx lt ly in lk"/></div></div></a></div></div></div>    
</body>
</html>