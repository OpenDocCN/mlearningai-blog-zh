<html>
<head>
<title>DeepxG Tutorial Part 1: Train your own Deep Learning Model to predict Expected Goals (xG)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">DeepxG教程第1部分:训练自己的深度学习模型预测预期目标(xG)</h1>
<blockquote>原文：<a href="https://medium.com/mlearning-ai/deep-xg-training-your-own-expected-goals-xg-deep-learning-model-cbb9b9eb5465?source=collection_archive---------3-----------------------#2022-11-02">https://medium.com/mlearning-ai/deep-xg-training-your-own-expected-goals-xg-deep-learning-model-cbb9b9eb5465?source=collection_archive---------3-----------------------#2022-11-02</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><div class=""><h2 id="1302" class="pw-subtitle-paragraph ie hg hh bd b if ig ih ii ij ik il im in io ip iq ir is it iu iv dx translated">使用python、statsbomb、mplsoccer和pandas创建数据集</h2></div><figure class="ix iy iz ja fd jb er es paragraph-image"><div role="button" tabindex="0" class="jc jd di je bf jf"><div class="er es iw"><img src="../Images/1d11b3803922a7661ee0ff7164b58f3f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*oW6l6ADc3nMP8F11"/></div></div><figcaption class="ji jj et er es jk jl bd b be z dx">Photo by <a class="ae jm" href="https://unsplash.com/@skucinic9?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Sven Kucinic</a> on <a class="ae jm" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><h2 id="5006" class="jn jo hh bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">介绍</h2><p id="d9af" class="pw-post-body-paragraph kl km hh kn b ko kp ii kq kr ks il kt jy ku kv kw kc kx ky kz kg la lb lc ld ha bi translated">我们大多数关注足球的人都听说过一个叫做<strong class="kn hi">预期目标</strong>的统计数据，通常被称为<a class="ae jm" href="https://en.wikipedia.org/wiki/Expected_goals" rel="noopener ugc nofollow" target="_blank"> <strong class="kn hi"> xG </strong> </a>。预期目标是一种统计数据，用于量化进球机会的质量。通常xG是在每次射门的基础上计算的，目标是(双关语)找出射门得分的概率。在电视屏幕上显示给我们的统计数据通常是从比赛开始到显示统计数据的时间点所拍摄的所有镜头的总xG，即所有镜头的xG的总和。</p><p id="179b" class="pw-post-body-paragraph kl km hh kn b ko le ii kq kr lf il kt jy lg kv kw kc lh ky kz kg li lb lc ld ha bi translated">xG的使用方法有很多，下面是几个例子:</p><ul class=""><li id="68c9" class="lj lk hh kn b ko le kr lf jy ll kc lm kg ln ld lo lp lq lr bi translated">经理可以评估他们的团队是否创造了高质量的机会。</li><li id="1154" class="lj lk hh kn b ko ls kr lt jy lu kc lv kg lw ld lo lp lq lr bi translated">管理人员和进攻球员可以识别出球场上对应于高xG的区域，这些信息让球员知道是射门还是将球移到不同的区域。</li><li id="80ca" class="lj lk hh kn b ko ls kr lt jy lu kc lv kg lw ld lo lp lq lr bi translated">防御者可以识别他们应该占领的区域。理想情况下，防守者会希望占据对应于高xG的区域，以阻止任何进攻，并将球引导到低xG的区域。</li><li id="835a" class="lj lk hh kn b ko ls kr lt jy lu kc lv kg lw ld lo lp lq lr bi translated">分析师和球探可以根据一个赛季的xG来确定购买哪个前锋。</li></ul><p id="c0ad" class="pw-post-body-paragraph kl km hh kn b ko le ii kq kr lf il kt jy lg kv kw kc lh ky kz kg li lb lc ld ha bi translated">在这一系列文章中，我们将介绍任何人如何构建自己的xG模型。我们将利用<a class="ae jm" href="https://statsbomb.com/" rel="noopener ugc nofollow" target="_blank"> Statsbomb </a>提供的<a class="ae jm" href="https://github.com/statsbomb/open-data" rel="noopener ugc nofollow" target="_blank">这里</a>的开源数据。在本文中，我们使用西甲联赛17个赛季的赛事数据来训练、验证和测试我们的模型。</p><p id="a45b" class="pw-post-body-paragraph kl km hh kn b ko le ii kq kr lf il kt jy lg kv kw kc lh ky kz kg li lb lc ld ha bi translated">本文将由三部分组成:</p><ul class=""><li id="a933" class="lj lk hh kn b ko le kr lf jy ll kc lm kg ln ld lo lp lq lr bi translated"><strong class="kn hi">数据准备</strong>:在这一部分，我们将展示如何创建数据集。数据转换、清理等。参与其中。</li><li id="a31e" class="lj lk hh kn b ko ls kr lt jy lu kc lv kg lw ld lo lp lq lr bi translated"><strong class="kn hi">模型训练:</strong>我们将向您展示如何利用<a class="ae jm" href="https://pytorch.org/" rel="noopener ugc nofollow" target="_blank"> pytorch </a>和<a class="ae jm" href="https://www.pytorchlightning.ai/" rel="noopener ugc nofollow" target="_blank"> pytorch-lightning </a>构建、训练和测试深度学习模型。</li><li id="27b5" class="lj lk hh kn b ko ls kr lt jy lu kc lv kg lw ld lo lp lq lr bi translated"><strong class="kn hi">模型评估:</strong>我们将运行一些实验来进一步评估我们的模型，并展示xG模型的不同使用方式。</li></ul></div><div class="ab cl lx ly go lz" role="separator"><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc"/></div><div class="ha hb hc hd he"><h1 id="00bc" class="me jo hh bd jp mf mg mh jt mi mj mk jx in ml io kb iq mm ir kf it mn iu kj mo bi translated">数据准备</h1><p id="0a20" class="pw-post-body-paragraph kl km hh kn b ko kp ii kq kr ks il kt jy ku kv kw kc kx ky kz kg la lb lc ld ha bi translated">今天的文章将重点关注创建一个数据集，该数据集可用于训练任何机器/深度学习模型来预测xG。我们将主要使用<a class="ae jm" href="https://pandas.pydata.org/" rel="noopener ugc nofollow" target="_blank">熊猫</a>和<a class="ae jm" href="https://mplsoccer.readthedocs.io/en/latest/index.html" rel="noopener ugc nofollow" target="_blank"> MPLSoccer </a>库。在可用的17个赛季的西甲数据中，我们使用15个赛季的数据作为我们的训练集，一个赛季用于验证，另一个赛季用于测试。为了获得每个赛季的赛事数据，我们需要获得statsbomb拥有数据的所有比赛的比赛id。这就是我们在下面的代码片段中所做的。</p><figure class="ix iy iz ja fd jb"><div class="bz dy l di"><div class="mp mq l"/></div></figure><p id="46eb" class="pw-post-body-paragraph kl km hh kn b ko le ii kq kr lf il kt jy lg kv kw kc lh ky kz kg li lb lc ld ha bi translated">请注意，我们已经通过利用statsbomb发布的比赛数据获得了我们想要使用的赛季id。在运行这个函数时，我们将有三个match_id.csv文件，对应于我们将为训练、验证和测试创建的数据集。</p><h2 id="516e" class="jn jo hh bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">特征</h2><p id="129d" class="pw-post-body-paragraph kl km hh kn b ko kp ii kq kr ks il kt jy ku kv kw kc kx ky kz kg la lb lc ld ha bi translated">在下一步中，我们将从每个匹配的事件数据中提取一些特征来创建数据集。我们使用以下特征来训练我们的模型。</p><ul class=""><li id="1cf9" class="lj lk hh kn b ko le kr lf jy ll kc lm kg ln ld lo lp lq lr bi translated"><strong class="kn hi">到球门的距离:</strong>从射门地点到球门中心的距离。</li><li id="2e4c" class="lj lk hh kn b ko ls kr lt jy lu kc lv kg lw ld lo lp lq lr bi translated"><strong class="kn hi">球门柱之间的角度:</strong>在他的书和课程<a class="ae jm" href="https://soccermatics.readthedocs.io/en/latest/lesson2/statisticalModelsIntro.html" rel="noopener ugc nofollow" target="_blank"> Soccermatics </a>中，David Sumpter解释了球门正面的可见性对于射门球员在确定从给定位置射门是容易还是困难时的重要性。从射门的地方到两个球门柱的角度可以很好地估计出球门的正面能被看到多少。</li></ul><figure class="ix iy iz ja fd jb er es paragraph-image"><div role="button" tabindex="0" class="jc jd di je bf jf"><div class="er es mr"><img src="../Images/a985378b8c05b7e084f9a35176ef1ef4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Ly3rRazDygARNg_0pMj_oA.png"/></div></div><figcaption class="ji jj et er es jk jl bd b be z dx">Angle between the goal posts of a shot</figcaption></figure><ul class=""><li id="cccc" class="lj lk hh kn b ko le kr lf jy ll kc lm kg ln ld lo lp lq lr bi translated"><strong class="kn hi">射门结果:</strong>判断射门是否进球。</li><li id="2dd2" class="lj lk hh kn b ko ls kr lt jy lu kc lv kg lw ld lo lp lq lr bi translated"><strong class="kn hi">技术名称:</strong>球员投篮的类型，如截击、半截击等。</li><li id="bdf6" class="lj lk hh kn b ko ls kr lt jy lu kc lv kg lw ld lo lp lq lr bi translated"><strong class="kn hi">压力下:</strong>识别出手的球员是否有压力。球员承受的压力越大，他们就越难有干净利落的一击，所以理论上球员在压力下应该更难得分。</li><li id="9415" class="lj lk hh kn b ko ls kr lt jy lu kc lv kg lw ld lo lp lq lr bi translated"><strong class="kn hi">身体部位名称:</strong>用于拍摄的身体部位。这个特征主要帮助我们区分头球和用双脚触地。</li><li id="ceee" class="lj lk hh kn b ko ls kr lt jy lu kc lv kg lw ld lo lp lq lr bi translated"><strong class="kn hi">位置名称:</strong>出手球员的位置。我们会认为后卫比前锋更不擅长射门。这一功能有助于模型了解优秀的终结者倾向于在哪个位置比赛。</li><li id="8166" class="lj lk hh kn b ko ls kr lt jy lu kc lv kg lw ld lo lp lq lr bi translated"><strong class="kn hi">传球技术名称:</strong>该特征用于描述提供给射门球员的传球类型。它可以用来确定它是否是一个直传球、传中球等。</li><li id="cfc2" class="lj lk hh kn b ko ls kr lt jy lu kc lv kg lw ld lo lp lq lr bi translated"><strong class="kn hi">射门区域:</strong>我们将球场分成80个区域，类似于我们在<a class="ae jm" rel="noopener" href="/@buildingblocks/visualizing-attacking-build-up-play-using-dynamic-passing-networks-33f12329ac87">上一篇文章</a>中创建动态传球网络时的做法。我们使用拍摄的区域作为特征。这是因为某些区域比其他区域更容易得分。</li><li id="870b" class="lj lk hh kn b ko ls kr lt jy lu kc lv kg lw ld lo lp lq lr bi translated"><strong class="kn hi">传球顺序</strong>:我们会跟踪投篮前的所有传球。这背后的意图是，包括传球序列可能表明创造的空间量和机会的类型，例如，如果这是一次反击或由球在球场高处被赢得的反压情况等。</li></ul><p id="9aa5" class="pw-post-body-paragraph kl km hh kn b ko le ii kq kr lf il kt jy lg kv kw kc lh ky kz kg li lb lc ld ha bi translated">所有这些都在下面显示的函数中实现</p><figure class="ix iy iz ja fd jb"><div class="bz dy l di"><div class="mp mq l"/></div></figure><p id="7b3c" class="pw-post-body-paragraph kl km hh kn b ko le ii kq kr lf il kt jy lg kv kw kc lh ky kz kg li lb lc ld ha bi translated">前几行代码(1–7)获取给定匹配id的事件数据。我们根据索引对事件数据帧进行排序，以确保所有事件都处于正确的时间顺序(按时间排序)。对于每个新的匹配，我们初始化两个变量，称为<em class="ms"> prev_possession_team </em>和<em class="ms"> pass_sequence。</em></p><p id="b68f" class="pw-post-body-paragraph kl km hh kn b ko le ii kq kr lf il kt jy lg kv kw kc lh ky kz kg li lb lc ld ha bi translated"><em class="ms"> prev_possession_team </em>跟踪上一场比赛前一直领先的球队。该变量对于确定传递序列是否结束非常重要。当控球的球队完成所有传球，丢球并且不再控球时，传球序列就结束了。</p><p id="69fe" class="pw-post-body-paragraph kl km hh kn b ko le ii kq kr lf il kt jy lg kv kw kc lh ky kz kg li lb lc ld ha bi translated"><em class="ms"> pass_sequence </em>变量跟踪给定移动中的所有走刀(第12-13行)。传球序列可能会被多种方式中断，例如球员被抢走，控球失误，球出界等。第14-15行确保我们跟踪传球的类型，例如传球/内旋传中等等。如果传球导致射门。</p><p id="fb34" class="pw-post-body-paragraph kl km hh kn b ko le ii kq kr lf il kt jy lg kv kw kc lh ky kz kg li lb lc ld ha bi translated">如果事件是一个镜头，则第17–32行收集与该镜头相关的所有特征。我们记下射门的位置，以找到两个球门柱之间的距离和角度。如果在投篮之前没有发现传球技术，这意味着传球技术是一条南线(27-28)。如果比赛是从任意球或点球开始的，我们清空到那个时间点的所有传球序列(第29-30行)。最后，我们在投篮结束时清空传球序列数组，开始我们新的进攻动作。</p><p id="8a00" class="pw-post-body-paragraph kl km hh kn b ko le ii kq kr lf il kt jy lg kv kw kc lh ky kz kg li lb lc ld ha bi translated">第34-38行用于查找传球序列何时结束，而不管是否射门。我们假设，只要第34行提到的列表中有任何事件，并且所有权没有转移到另一个队，传球序列就会继续。<strong class="kn hi">压力</strong>事件适用于对方球员对持球球员施加压力的情况。</p><p id="ee7e" class="pw-post-body-paragraph kl km hh kn b ko le ii kq kr lf il kt jy lg kv kw kc lh ky kz kg li lb lc ld ha bi translated">下面是用于查找到球门的距离以及球门柱和球所在区域之间的角度的函数。stackoverflow上的<em class="ms"> get_shot_angle </em>功能归功于<a class="ae jm" href="https://stackoverflow.com/questions/58953047/issue-with-finding-angle-between-3-points-in-python" rel="noopener ugc nofollow" target="_blank">这个</a>帖子。</p><figure class="ix iy iz ja fd jb"><div class="bz dy l di"><div class="mp mq l"/></div></figure><h2 id="d4f9" class="jn jo hh bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">数据转换</h2><p id="1215" class="pw-post-body-paragraph kl km hh kn b ko kp ii kq kr ks il kt jy ku kv kw kc kx ky kz kg la lb lc ld ha bi translated">数据集准备的最后阶段涉及一些数据转换。我们执行以下转换:</p><ul class=""><li id="d248" class="lj lk hh kn b ko le kr lf jy ll kc lm kg ln ld lo lp lq lr bi translated">将所有<a class="ae jm" href="https://en.wikipedia.org/wiki/Categorical_variable" rel="noopener ugc nofollow" target="_blank">分类</a>变量转换为唯一id。我们有以下分类变量。</li></ul><pre class="ix iy iz ja fd mt mu mv mw aw mx bi"><span id="f2e9" class="jn jo hh mu b fi my mz l na nb">CATEGORICAL_VARIABLES = [SHOT_TECHNIQUE_NAME, BODY_PART_NAME, POSITION_NAME, PASS_TECHNIQUE_NAME]</span></pre><ul class=""><li id="cc34" class="lj lk hh kn b ko le kr lf jy ll kc lm kg ln ld lo lp lq lr bi translated">将拍摄地点和传球地点的坐标转换为区域编号。</li><li id="f3f1" class="lj lk hh kn b ko ls kr lt jy lu kc lv kg lw ld lo lp lq lr bi translated"><a class="ae jm" href="https://towardsdatascience.com/normalization-vs-standardization-explained-209e84d0f81e#:~:text=It%20is%20a%20scaling%20technique,(X%20max%20%E2%80%94%20X%20min)" rel="noopener" target="_blank">标准化</a>两个连续变量，射击距离和角度。以确保两个变量的数量级在模型训练期间不成问题。</li></ul><figure class="ix iy iz ja fd jb"><div class="bz dy l di"><div class="mp mq l"/></div></figure><p id="5c51" class="pw-post-body-paragraph kl km hh kn b ko le ii kq kr lf il kt jy lg kv kw kc lh ky kz kg li lb lc ld ha bi translated">第3–16行使用前面显示的效用函数将射门和传球坐标转换为区域。如果坐标是nan的，我们给出一个默认区域80(记住我们有80个区域，编号从0-79，因为索引从0开始，所以索引80对应一个后备区域)。</p><p id="0fac" class="pw-post-body-paragraph kl km hh kn b ko le ii kq kr lf il kt jy lg kv kw kc lh ky kz kg li lb lc ld ha bi translated">接下来(第18-48行),我们使用一些简单的熊猫技巧来转换我们的分类变量和连续变量。请记住，我们只需要从训练数据中学习数据转换和映射的所有参数。为此，我们计算训练集中每个连续变量的平均值和标准差，并将其保存为一个json文件。加载保存的json文件(第41、49–50行)后，相同的均值和标准差被应用于来自验证和测试集的原始数据。</p><p id="82f0" class="pw-post-body-paragraph kl km hh kn b ko le ii kq kr lf il kt jy lg kv kw kc lh ky kz kg li lb lc ld ha bi translated">对于分类变量，我们将训练中每个变量的所有类别保存在一个字典中，并将字典保存为一个json文件(第29–38行)。当我们转换验证和测试数据时，如果给定的类别不在训练集中，我们给它一个唯一的id，等于类别数的长度，利用索引从0开始并且索引处等于类别列表长度的类别实际上不存在的事实。</p></div><div class="ab cl lx ly go lz" role="separator"><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc"/></div><div class="ha hb hc hd he"><h1 id="f7b7" class="me jo hh bd jp mf mg mh jt mi mj mk jx in ml io kb iq mm ir kf it mn iu kj mo bi translated">结论</h1><p id="15ad" class="pw-post-body-paragraph kl km hh kn b ko kp ii kq kr ks il kt jy ku kv kw kc kx ky kz kg la lb lc ld ha bi translated">现在，我们已经准备好了训练、验证和测试集，可以训练深度学习/机器学习模型。在本系列的第2部分中，我们将浏览一些pytorch和pytorch-lightning代码来设置数据模块、模型架构、训练逻辑等。如果你认为我们可以使用其他一些很酷的功能来训练xG模型，请在下面留言。</p><p id="2beb" class="pw-post-body-paragraph kl km hh kn b ko le ii kq kr lf il kt jy lg kv kw kc lh ky kz kg li lb lc ld ha bi translated"><em class="ms">如果你有兴趣继续了解更多关于数据科学和机器学习如何应用于足球世界的信息，请做</em> <a class="ae jm" rel="noopener" href="/@buildingblocks"> <em class="ms">关注</em> </a> <em class="ms">我们，查看我们之前的一些文章！</em></p><div class="nc nd ez fb ne nf"><a rel="noopener follow" target="_blank" href="/mlearning-ai/mlearning-ai-submission-suggestions-b51e2b130bfb"><div class="ng ab dw"><div class="nh ab ni cl cj nj"><h2 class="bd hi fi z dy nk ea eb nl ed ef hg bi translated">Mlearning.ai提交建议</h2><div class="nm l"><h3 class="bd b fi z dy nk ea eb nl ed ef dx translated">如何成为Mlearning.ai上的作家</h3></div><div class="nn l"><p class="bd b fp z dy nk ea eb nl ed ef dx translated">medium.com</p></div></div><div class="no l"><div class="np l nq nr ns no nt jg nf"/></div></div></a></div></div></div>    
</body>
</html>