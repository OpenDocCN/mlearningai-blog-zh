<html>
<head>
<title/>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1/>
<blockquote>原文：<a href="https://medium.com/mlearning-ai/want-to-boost-python-performance-its-easier-than-you-think-51beddedc844?source=collection_archive---------2-----------------------#2022-09-11">https://medium.com/mlearning-ai/want-to-boost-python-performance-its-easier-than-you-think-51beddedc844?source=collection_archive---------2-----------------------#2022-09-11</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><p id="efa7" class="pw-post-body-paragraph hf hg hh hi b hj hk hl hm hn ho hp hq hr hs ht hu hv hw hx hy hz ia ib ic id ha bi translated"><strong class="hi ie">想要提升Python性能？比你想象的容易</strong></p><figure class="ig ih ii ij fd ik er es paragraph-image"><div role="button" tabindex="0" class="il im di in bf io"><div class="er es if"><img src="../Images/4b83c6fa85a092faa16b247633d270e4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Gt0EB43JhJWAoblR"/></div></div><figcaption class="ir is et er es it iu bd b be z dx">Photo by <a class="ae iv" href="https://unsplash.com/@o5ky?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Oscar Sutton</a> on <a class="ae iv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="d042" class="pw-post-body-paragraph hf hg hh hi b hj hk hl hm hn ho hp hq hr hs ht hu hv hw hx hy hz ia ib ic id ha bi translated">一个被广泛认可的事实是，Python已经成为世界上最流行的编程语言之一。自20世纪80年代吉多·范·罗苏姆率先发展这种语言以来，它已经经历了40年的巨大成功。我相信其中的一个原因是它有一个庞大的社区作为后盾，并且受到谷歌等大公司的欢迎。</p><p id="5ff9" class="pw-post-body-paragraph hf hg hh hi b hj hk hl hm hn ho hp hq hr hs ht hu hv hw hx hy hz ia ib ic id ha bi translated">作为一种<a class="ae iv" href="https://en.wikipedia.org/wiki/Multi-paradigm_programming_language" rel="noopener ugc nofollow" target="_blank">多范例编程语言</a>，python提供了令人敬畏的能力，如<a class="ae iv" href="https://en.wikipedia.org/wiki/Object-oriented_programming" rel="noopener ugc nofollow" target="_blank">面向对象编程</a>和<a class="ae iv" href="https://en.wikipedia.org/wiki/Structured_programming" rel="noopener ugc nofollow" target="_blank">结构化编程</a><a class="ae iv" href="1.%09https:/docs.python.org/3.0/reference/datamodel.html#special-method-names" rel="noopener ugc nofollow" target="_blank">【1】</a>，Python使用<a class="ae iv" href="https://en.wikipedia.org/wiki/Dynamic_typing" rel="noopener ugc nofollow" target="_blank">动态类型化</a>和<a class="ae iv" href="https://en.wikipedia.org/wiki/Reference_counting" rel="noopener ugc nofollow" target="_blank">引用计数</a>以及用于<a class="ae iv" href="https://en.wikipedia.org/wiki/Memory_management" rel="noopener ugc nofollow" target="_blank">内存管理</a><a class="ae iv" href="2.%09https:/docs.python.org/3/extending/extending.html#reference-counts" rel="noopener ugc nofollow" target="_blank">【2】</a>的循环检测垃圾收集器的组合。</p><p id="2107" class="pw-post-body-paragraph hf hg hh hi b hj hk hl hm hn ho hp hq hr hs ht hu hv hw hx hy hz ia ib ic id ha bi translated">由于这种多才多艺的性质，Python已经被开发人员用来构建许多库，特别是用于分析和机器学习。根据<a class="ae iv" href="http://www.tiobe.com/tiobe-index/" rel="noopener ugc nofollow" target="_blank"> TIOBE编程社区指数</a>，Python自2003年以来一直位于前10名语言之列。然而，如果我们看一下趋势，我们现在是在2022年，Python是最流行的语言。</p><figure class="ig ih ii ij fd ik er es paragraph-image"><div class="er es iw"><img src="../Images/b0d17b5c6ee68c65730d907712c014e4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1248/format:webp/1*6kLxdMQblP4PWfABe38EeQ.png"/></div><figcaption class="ir is et er es it iu bd b be z dx">Image Source: <a class="ae iv" href="http://www.tiobe.com" rel="noopener ugc nofollow" target="_blank">www.tiobe.com</a></figcaption></figure><p id="2a9f" class="pw-post-body-paragraph hf hg hh hi b hj hk hl hm hn ho hp hq hr hs ht hu hv hw hx hy hz ia ib ic id ha bi translated">画面看似完整，但真的是这样吗？Python的能力足以构建强大的计算产品吗？根据Dominika Reszke和Micha Jungiewicz在他们的博客<a class="ae iv" href="https://codete.com/blog/c-for-machine-learning-is-it-better-than-python-comparison" rel="noopener ugc nofollow" target="_blank">中的说法，C-for-machine-learning-is-it-better-than-python-comparison</a>:<em class="ix">“通常，当更高级编程效率更高的Python达到其性能极限时，你会碰到一堵砖墙，唯一的出路可能是切换到C++。”</em></p><p id="d209" class="pw-post-body-paragraph hf hg hh hi b hj hk hl hm hn ho hp hq hr hs ht hu hv hw hx hy hz ia ib ic id ha bi translated">这是NumPy的一个例子，它是数据科学家最流行的工具之一。NumPy是一个Python模块，它使用C和C++来提高性能。下面是NumPy官方GitHub页面截图。</p><figure class="ig ih ii ij fd ik er es paragraph-image"><div role="button" tabindex="0" class="il im di in bf io"><div class="er es iy"><img src="../Images/7ee61e6ad75525c0e373a0cd2eb11f10.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*H-cq2kHHZoaWHX7KxB345w.png"/></div></div><figcaption class="ir is et er es it iu bd b be z dx">Image Source: <a class="ae iv" href="https://github.com/numpy/numpy" rel="noopener ugc nofollow" target="_blank">https://github.com/numpy/numpy</a></figcaption></figure><p id="d981" class="pw-post-body-paragraph hf hg hh hi b hj hk hl hm hn ho hp hq hr hs ht hu hv hw hx hy hz ia ib ic id ha bi translated">大多数广为人知的Python分析库中都使用了C++或其他领域语言来提高性能。因此，当一个人安装这些库时，他将立即受益于改进的性能，而无需开发人员的任何进一步干预。</p><p id="6440" class="pw-post-body-paragraph hf hg hh hi b hj hk hl hm hn ho hp hq hr hs ht hu hv hw hx hy hz ia ib ic id ha bi translated">如果你开发了一个基于Python的定制库来解决一个非常具体的问题，但是这个库的性能很差，你有办法解决这个性能问题吗？在本文中，我们将研究一种将改进的C++函数合并到我们的定制python库中的方法，以便更容易地集成和创建可安装包，使用Pybind11<a class="ae iv" href="http://3.&#9;https://pybind11.readthedocs.io/en/stable/basics.html" rel="noopener ugc nofollow" target="_blank">【3】</a>(请参考<a class="ae iv" href="http://3.&#9;https://pybind11.readthedocs.io/en/stable/basics.html" rel="noopener ugc nofollow" target="_blank"> pybind11文档</a>以获得关于py bind 11的深入信息)。</p><p id="f0e7" class="pw-post-body-paragraph hf hg hh hi b hj hk hl hm hn ho hp hq hr hs ht hu hv hw hx hy hz ia ib ic id ha bi translated">为了便于说明，让我们通过3个简单的步骤创建一个示例:</p><p id="cbfe" class="pw-post-body-paragraph hf hg hh hi b hj hk hl hm hn ho hp hq hr hs ht hu hv hw hx hy hz ia ib ic id ha bi translated">步骤1:创建一个基本的Python函数(py_func ),它接受0到指定整数范围内的值，并输出平方和，将文档保存为test.py并放入pbex_py文件夹。</p><figure class="ig ih ii ij fd ik"><div class="bz dy l di"><div class="iz ja l"/></div></figure><p id="ad7c" class="pw-post-body-paragraph hf hg hh hi b hj hk hl hm hn ho hp hq hr hs ht hu hv hw hx hy hz ia ib ic id ha bi translated">第二步:用C++ (c_func)创建一个相同的函数，然后用pybind11在python中执行。创建一个名为test c.cpp的文件，并将其保存在c目录中。</p><figure class="ig ih ii ij fd ik"><div class="bz dy l di"><div class="iz ja l"/></div></figure><p id="c25f" class="pw-post-body-paragraph hf hg hh hi b hj hk hl hm hn ho hp hq hr hs ht hu hv hw hx hy hz ia ib ic id ha bi translated">我们使用PYBIND11_MODULE来定义函数pbex，它将从python导入，第二个参数是m，它将在内部编译我们的C++函数c_func。</p><p id="ad74" class="pw-post-body-paragraph hf hg hh hi b hj hk hl hm hn ho hp hq hr hs ht hu hv hw hx hy hz ia ib ic id ha bi translated">步骤3:为了打包我们的代码，我们需要创建__init__。py和setup.py</p><figure class="ig ih ii ij fd ik"><div class="bz dy l di"><div class="iz ja l"/></div></figure><figure class="ig ih ii ij fd ik"><div class="bz dy l di"><div class="iz ja l"/></div></figure><p id="78fe" class="pw-post-body-paragraph hf hg hh hi b hj hk hl hm hn ho hp hq hr hs ht hu hv hw hx hy hz ia ib ic id ha bi translated">setup.py中有两种设置，首先我们通过指定<em class="ix">包</em>和<em class="ix">包_目录</em>来声明我们的Python函数。其次，我们通过将C++函数添加到<em class="ix"> ext_modules </em>中来为其创建一个共享对象，并为其提供一个<em class="ix"> cmdclass </em>来构建这个扩展。<a class="ae iv" href="http://4.&#9;https://github.com/pybind/python_example" rel="noopener ugc nofollow" target="_blank">【4】</a></p><p id="521c" class="pw-post-body-paragraph hf hg hh hi b hj hk hl hm hn ho hp hq hr hs ht hu hv hw hx hy hz ia ib ic id ha bi translated">现在，我们完整的包目录将如下所示。</p><figure class="ig ih ii ij fd ik er es paragraph-image"><div role="button" tabindex="0" class="il im di in bf io"><div class="er es jb"><img src="../Images/21bc6e13603fbbc75c4c3f1bd2982ec2.png" data-original-src="https://miro.medium.com/v2/resize:fit:850/format:webp/1*JDLuhda2Db95bo8OWU5mdQ.png"/></div></div></figure><p id="76a4" class="pw-post-body-paragraph hf hg hh hi b hj hk hl hm hn ho hp hq hr hs ht hu hv hw hx hy hz ia ib ic id ha bi translated">我们将在我们的Python环境中安装这个包。</p><figure class="ig ih ii ij fd ik er es paragraph-image"><div class="er es jc"><img src="../Images/76f7f72ec34ed65abbbad3ab74ffa416.png" data-original-src="https://miro.medium.com/v2/resize:fit:1252/format:webp/1*1DznVe4XoxD6eHsEdRSd9A.png"/></div></figure><p id="f202" class="pw-post-body-paragraph hf hg hh hi b hj hk hl hm hn ho hp hq hr hs ht hu hv hw hx hy hz ia ib ic id ha bi translated">安装了我们的包之后，我们应该能够在我们的环境的site-packages目录中找到它。</p><figure class="ig ih ii ij fd ik er es paragraph-image"><div class="er es iw"><img src="../Images/ec801cf3f47352183cc0703e145355d0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1248/format:webp/1*-qqDe1V8LGsJTdwSiC08pA.png"/></div></figure><p id="ebd7" class="pw-post-body-paragraph hf hg hh hi b hj hk hl hm hn ho hp hq hr hs ht hu hv hw hx hy hz ia ib ic id ha bi translated">需要注意的是，文件<em class="ix">pbex . cpython-310-x86 _ 64 . so</em>，它是为我们的C++函数创建的<a class="ae iv" href="https://slimmer-ai.github.io/mpire/v2.3.0/usage/workerpool/shared_objects.html" rel="noopener ugc nofollow" target="_blank">共享对象</a>，可以作为<em class="ix"> pbex </em>以及<em class="ix"> pbex_py </em>导入，这是一个可导入的python函数。</p><p id="4ecb" class="pw-post-body-paragraph hf hg hh hi b hj hk hl hm hn ho hp hq hr hs ht hu hv hw hx hy hz ia ib ic id ha bi translated">让我们看看当我们使用<a class="ae iv" href="https://docs.python.org/3/library/timeit.html" rel="noopener ugc nofollow" target="_blank"> <em class="ix"> timeit </em> </a>魔术命令执行10，000次循环时，这些函数的性能如何。</p><figure class="ig ih ii ij fd ik er es paragraph-image"><div class="er es jd"><img src="../Images/32f3d92f3c60f66b37a801a6f65a808f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1220/format:webp/1*eiI1GPGP3XWaEdElFeIvcA.png"/></div></figure><p id="8211" class="pw-post-body-paragraph hf hg hh hi b hj hk hl hm hn ho hp hq hr hs ht hu hv hw hx hy hz ia ib ic id ha bi translated">很明显，我们可以将C++函数作为扩展集成到Python库包中，并获得令人惊叹的结果。例如，对于10，000次循环，C函数的平均时间是549ns(即0.596秒)，而Python函数的平均时间是80秒，这表明C++函数几乎比Python函数快160倍。</p><p id="ad50" class="pw-post-body-paragraph hf hg hh hi b hj hk hl hm hn ho hp hq hr hs ht hu hv hw hx hy hz ia ib ic id ha bi translated">此外，我们可以利用其他方法来提高Python代码的性能。例如，<a class="ae iv" href="https://cython.org/" rel="noopener ugc nofollow" target="_blank">cy thon</a>(Python的C扩展)，或者利用一些预打包的解决方案，比如<a class="ae iv" href="https://numba.pydata.org/" rel="noopener ugc nofollow" target="_blank"> Numba </a>。</p><p id="845a" class="pw-post-body-paragraph hf hg hh hi b hj hk hl hm hn ho hp hq hr hs ht hu hv hw hx hy hz ia ib ic id ha bi translated">完整的代码可以在<a class="ae iv" href="https://github.com/kudeore/pybind11" rel="noopener ugc nofollow" target="_blank">kude ore/py bind 11:c++和Python的比较(github.com)</a>找到</p><p id="e56a" class="pw-post-body-paragraph hf hg hh hi b hj hk hl hm hn ho hp hq hr hs ht hu hv hw hx hy hz ia ib ic id ha bi translated"><strong class="hi ie">参考文献:</strong></p><p id="29a9" class="pw-post-body-paragraph hf hg hh hi b hj hk hl hm hn ho hp hq hr hs ht hu hv hw hx hy hz ia ib ic id ha bi translated">1.<a class="ae iv" href="https://docs.python.org/3.0/reference/datamodel.html#special-method-names" rel="noopener ugc nofollow" target="_blank">https://docs . python . org/3.0/reference/data model . html # special-method-names</a></p><p id="a980" class="pw-post-body-paragraph hf hg hh hi b hj hk hl hm hn ho hp hq hr hs ht hu hv hw hx hy hz ia ib ic id ha bi translated">2.<a class="ae iv" href="https://docs.python.org/3/extending/extending.html#reference-counts" rel="noopener ugc nofollow" target="_blank">https://docs . python . org/3/extending/extending . html # reference-counts</a></p><p id="ea3a" class="pw-post-body-paragraph hf hg hh hi b hj hk hl hm hn ho hp hq hr hs ht hu hv hw hx hy hz ia ib ic id ha bi translated">3.<a class="ae iv" href="https://pybind11.readthedocs.io/en/stable/basics.html" rel="noopener ugc nofollow" target="_blank">https://pybind11.readthedocs.io/en/stable/basics.html</a></p><p id="06ec" class="pw-post-body-paragraph hf hg hh hi b hj hk hl hm hn ho hp hq hr hs ht hu hv hw hx hy hz ia ib ic id ha bi translated">4.<a class="ae iv" href="https://github.com/pybind/python_example" rel="noopener ugc nofollow" target="_blank">https://github.com/pybind/python_example</a></p><div class="je jf ez fb jg jh"><a rel="noopener follow" target="_blank" href="/mlearning-ai/mlearning-ai-submission-suggestions-b51e2b130bfb"><div class="ji ab dw"><div class="jj ab jk cl cj jl"><h2 class="bd ie fi z dy jm ea eb jn ed ef jo bi translated">Mlearning.ai提交建议</h2><div class="jp l"><h3 class="bd b fi z dy jm ea eb jn ed ef dx translated">如何成为Mlearning.ai上的作家</h3></div><div class="jq l"><p class="bd b fp z dy jm ea eb jn ed ef dx translated">medium.com</p></div></div><div class="jr l"><div class="js l jt ju jv jr jw ip jh"/></div></div></a></div></div></div>    
</body>
</html>