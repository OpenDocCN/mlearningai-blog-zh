<html>
<head>
<title>Connecting AWS SageMaker to SnowFlake</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">将AWS SageMaker连接到雪花</h1>
<blockquote>原文：<a href="https://medium.com/mlearning-ai/connecting-aws-sagemaker-to-snowflake-5b377ffa5fc5?source=collection_archive---------2-----------------------#2022-08-15">https://medium.com/mlearning-ai/connecting-aws-sagemaker-to-snowflake-5b377ffa5fc5?source=collection_archive---------2-----------------------#2022-08-15</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><div class=""><h2 id="86b7" class="pw-subtitle-paragraph ie hg hh bd b if ig ih ii ij ik il im in io ip iq ir is it iu iv dx translated">为机器学习摄取数据</h2></div><figure class="ix iy iz ja fd jb er es paragraph-image"><div role="button" tabindex="0" class="jc jd di je bf jf"><div class="er es iw"><img src="../Images/e2204b176f5608ca6509b844a18cc79d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ltMcf7FD2Z4jmUpphNPDNQ.jpeg"/></div></div><figcaption class="ji jj et er es jk jl bd b be z dx">Image: Aaron Burden from unsplash</figcaption></figure><p id="8919" class="pw-post-body-paragraph jm jn hh jo b jp jq ii jr js jt il ju jv jw jx jy jz ka kb kc kd ke kf kg kh ha bi translated">机器学习模型部署中的一个重要任务是让数据从一个平台无缝地流向另一个平台。我们可以使用AWS SageMaker对数据进行预处理，训练模型并进行推理。通常，我们的数据集可能托管在不同的平台上。在本教程中，我将向您展示如何将AWS SageMaker与雪花环境连接起来的一步一步的方法。通过这样做，我们将能够在任何机器学习任务之前摄取存储在雪花环境中的数据。</p><p id="0bf3" class="pw-post-body-paragraph jm jn hh jo b jp jq ii jr js jt il ju jv jw jx jy jz ka kb kc kd ke kf kg kh ha bi translated">在本教程中，我还想提供一个循序渐进的教程，介绍我们如何在AWS参数存储中存储用户名和密码，从而提供一种更安全的方式来连接到雪花。</p><p id="990c" class="pw-post-body-paragraph jm jn hh jo b jp jq ii jr js jt il ju jv jw jx jy jz ka kb kc kd ke kf kg kh ha bi translated"><strong class="jo hi">步骤1: </strong>创建SageMaker笔记本实例</p><ul class=""><li id="abf3" class="ki kj hh jo b jp jq js jt jv kk jz kl kd km kh kn ko kp kq bi translated">从<em class="kr"> SageMaker控制台</em>选择<em class="kr">笔记本实例</em>-&gt;-<em class="kr">创建笔记本实例</em></li><li id="d9c0" class="ki kj hh jo b jp ks js kt jv ku jz kv kd kw kh kn ko kp kq bi translated">附加适当的<em class="kr"> IAM角色</em>:例如SageMakerExecutionRole(稍后，我们还需要为该角色附加一些附加策略)</li></ul><figure class="ix iy iz ja fd jb er es paragraph-image"><div class="ab fe cl kx"><img src="../Images/a3b8eaade2a2dd6baaaf8c9beb635e1e.png" data-original-src="https://miro.medium.com/v2/format:webp/1*8w0DSGJskCN0Xl2xOI4UYA.png"/></div></figure><p id="4407" class="pw-post-body-paragraph jm jn hh jo b jp jq ii jr js jt il ju jv jw jx jy jz ka kb kc kd ke kf kg kh ha bi translated">创建笔记本实例时，还需要设置<em class="kr">网络</em>设置(通常对于SageMaker特定的笔记本，我们倾向于忽略此选项)。此外，如果您有一台现有的笔记本电脑，可能无法更新<em class="kr">网络</em>设置，您必须从新的笔记本电脑开始。</p><figure class="ix iy iz ja fd jb er es paragraph-image"><div class="ab fe cl kx"><img src="../Images/477d4642f93a71b1a8de0ca62d6442d0.png" data-original-src="https://miro.medium.com/v2/format:webp/1*W6i9SGAFdQ2aeKdXxwrSWA.png"/></div></figure><p id="f9a0" class="pw-post-body-paragraph jm jn hh jo b jp jq ii jr js jt il ju jv jw jx jy jz ka kb kc kd ke kf kg kh ha bi translated">请联系您的管理员填写以下字段:</p><pre class="ix iy iz ja fd ky kz la lb aw lc bi"><span id="14b8" class="ld le hh kz b fi lf lg l lh li">VPC: &lt;*********&gt;</span><span id="0c9a" class="ld le hh kz b fi lj lg l lh li">Subnet: &lt;******&gt;</span><span id="f3ad" class="ld le hh kz b fi lj lg l lh li">Security Group: &lt;*******&gt;</span><span id="ce71" class="ld le hh kz b fi lj lg l lh li">Direct Internet Access: Disable</span></pre><p id="d866" class="pw-post-body-paragraph jm jn hh jo b jp jq ii jr js jt il ju jv jw jx jy jz ka kb kc kd ke kf kg kh ha bi translated"><strong class="jo hi">步骤2: </strong>将雪花服务帐户用户和密码存储到AWS参数存储中</p><p id="7686" class="pw-post-body-paragraph jm jn hh jo b jp jq ii jr js jt il ju jv jw jx jy jz ka kb kc kd ke kf kg kh ha bi translated">在创建雪花连接器时，您可以在SageMaker笔记本中对用户/密码进行硬编码。但是最好有一个服务帐户，我们可以将它存储在AWS的密钥或参数存储中。在这个例子中，我将向您展示如何在AWS参数存储中存储和使用用户/密码，并避免使用硬代码模式。</p><p id="3459" class="pw-post-body-paragraph jm jn hh jo b jp jq ii jr js jt il ju jv jw jx jy jz ka kb kc kd ke kf kg kh ha bi translated">转到<em class="kr"> AWS系统管理器</em> - &gt;转到<em class="kr">参数存储</em> - &gt; <em class="kr">创建参数</em></p><pre class="ix iy iz ja fd ky kz la lb aw lc bi"><span id="f774" class="ld le hh kz b fi lf lg l lh li">1. Give a meaningful name for the user — e.g ‘****-user’</span><span id="15c6" class="ld le hh kz b fi lj lg l lh li">2. Choose 'SecureString' Type</span><span id="c7ef" class="ld le hh kz b fi lj lg l lh li">3. Enter the User Name in the ‘Value’ section. (The User is the Snowflake Service Account Name)</span><span id="bece" class="ld le hh kz b fi lj lg l lh li">4. Choose Create Parameter</span><span id="6aaf" class="ld le hh kz b fi lj lg l lh li">5. Repeat step 1 to 4 for storing password also. (In the step 3, now enter the password in the ‘Value’ section)</span></pre><p id="7e84" class="pw-post-body-paragraph jm jn hh jo b jp jq ii jr js jt il ju jv jw jx jy jz ka kb kc kd ke kf kg kh ha bi translated">然后，我们必须在将要创建的策略中提供用户名和密码参数的名称。</p><p id="3279" class="pw-post-body-paragraph jm jn hh jo b jp jq ii jr js jt il ju jv jw jx jy jz ka kb kc kd ke kf kg kh ha bi translated"><strong class="jo hi">步骤3: </strong>创建一个凭证策略，并附加到现有的或新的角色。</p><p id="372f" class="pw-post-body-paragraph jm jn hh jo b jp jq ii jr js jt il ju jv jw jx jy jz ka kb kc kd ke kf kg kh ha bi translated">在我们的例子中，我们将创建一个凭证策略并将其附加到现有的SageMaker执行角色</p><p id="20a6" class="pw-post-body-paragraph jm jn hh jo b jp jq ii jr js jt il ju jv jw jx jy jz ka kb kc kd ke kf kg kh ha bi translated">转到<em class="kr">策略</em>-&gt;-<em class="kr">创建策略</em> - &gt;选择<em class="kr"> JSON </em> - &gt;复制粘贴以下代码</p><pre class="ix iy iz ja fd ky kz la lb aw lc bi"><span id="bfd6" class="ld le hh kz b fi lf lg l lh li">{<br/>    "Version": "2012-10-17",<br/>    "Statement": [<br/>        {<br/>            "Sid": "VisualEditor0",<br/>            "Effect": "Allow",<br/>            "Action": [<br/>                "ssm:PutParameter",<br/>                "ssm:DeleteParameter",<br/>                "kms:Decrypt",<br/>                "ssm:GetParameterHistory",<br/>                "ssm:GetParametersByPath",<br/>                "ssm:GetParameters",<br/>                "ssm:GetParameter",<br/>                "ssm:DeleteParameters"<br/>            ],<br/>            "Resource": [<br/>                "arn:aws:ssm:&lt;region&gt;:&lt;accountid&gt;:parameter/&lt;user&gt;", <br/>                "arn:aws:ssm:&lt;region&gt;:&lt;accountid&gt;:parameter/&lt;pw&gt;"<br/>            ]<br/>        },<br/>        {<br/>            "Sid": "VisualEditor1",<br/>            "Effect": "Allow",<br/>            "Action": [<br/>                "ssm:DescribeParameters",<br/>                "kms:ListAliases"<br/>            ],<br/>            "Resource": "*"<br/>        }<br/>    ]<br/>}</span></pre><p id="e0b6" class="pw-post-body-paragraph jm jn hh jo b jp jq ii jr js jt il ju jv jw jx jy jz ka kb kc kd ke kf kg kh ha bi translated">转到<em class="kr"> AWS系统管理器</em>-&gt;-<em class="kr">参数存储器</em>，找到用户名和密码参数(不是实际的用户/密码)。</p><figure class="ix iy iz ja fd jb er es paragraph-image"><div role="button" tabindex="0" class="jc jd di je bf jf"><div class="er es lk"><img src="../Images/bc515f3c22ca154825b5636709a122cc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*r39Vp8uzEen8itWrBl_VNA.png"/></div></div></figure><ul class=""><li id="a264" class="ki kj hh jo b jp jq js jt jv kk jz kl kd km kh kn ko kp kq bi translated">用用户名替换<user>，例如SF_SERVICE_USER</user></li><li id="53fa" class="ki kj hh jo b jp ks js kt jv ku jz kv kd kw kh kn ko kp kq bi translated">用密码替换<pw>，例如SF_USER_PSS</pw></li><li id="4eb7" class="ki kj hh jo b jp ks js kt jv ku jz kv kd kw kh kn ko kp kq bi translated">给策略起一个有意义的名字:例如“* * * *-参数-存储”</li></ul><p id="c9d1" class="pw-post-body-paragraph jm jn hh jo b jp jq ii jr js jt il ju jv jw jx jy jz ka kb kc kd ke kf kg kh ha bi translated">将策略附加到与笔记本实例相关联的SageMaker执行角色。</p><p id="9883" class="pw-post-body-paragraph jm jn hh jo b jp jq ii jr js jt il ju jv jw jx jy jz ka kb kc kd ke kf kg kh ha bi translated">转到<em class="kr"> IAM </em> - &gt; <em class="kr">选择角色</em> - &gt;选择<em class="kr">亚马逊管理决策者-执行策略</em>(或您拥有的任何策略)</p><p id="49c7" class="pw-post-body-paragraph jm jn hh jo b jp jq ii jr js jt il ju jv jw jx jy jz ka kb kc kd ke kf kg kh ha bi translated"><em class="kr">添加权限</em>-&gt;-<em class="kr">附加策略</em> - &gt;在搜索栏中键入上面创建的策略的名称，并附加该策略</p><figure class="ix iy iz ja fd jb er es paragraph-image"><div role="button" tabindex="0" class="jc jd di je bf jf"><div class="er es ll"><img src="../Images/43fce2b4dad7dafc86bbb4dc2c172046.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BuBiIisG8v4zuzcBByTglA.png"/></div></div></figure><p id="23ff" class="pw-post-body-paragraph jm jn hh jo b jp jq ii jr js jt il ju jv jw jx jy jz ka kb kc kd ke kf kg kh ha bi translated"><strong class="jo hi">步骤4: </strong>将SageMaker笔记本连接到雪花</p><p id="d3ed" class="pw-post-body-paragraph jm jn hh jo b jp jq ii jr js jt il ju jv jw jx jy jz ka kb kc kd ke kf kg kh ha bi translated">打开您在步骤1中创建的笔记本。在笔记本中，复制以下代码，编辑<em class="kr">区域</em>并执行。</p><pre class="ix iy iz ja fd ky kz la lb aw lc bi"><span id="eea7" class="ld le hh kz b fi lf lg l lh li">!pip install snowflake-connector-python</span><span id="ffb0" class="ld le hh kz b fi lj lg l lh li">import sys<br/>import boto3<br/>import snowflake.connector<br/>region = 'us-west-2'</span><span id="fcae" class="ld le hh kz b fi lj lg l lh li"># you need to know which region your Snowflake account is created from your admin</span></pre><p id="8f28" class="pw-post-body-paragraph jm jn hh jo b jp jq ii jr js jt il ju jv jw jx jy jz ka kb kc kd ke kf kg kh ha bi translated">我们将使用Python boto3库来提取雪花连接的用户/密码。下面是一个从AWS参数存储中提取用户和密码的简单函数。</p><pre class="ix iy iz ja fd ky kz la lb aw lc bi"><span id="9a02" class="ld le hh kz b fi lf lg l lh li"># Create a list of user/password from the parameter store, remember this is not the actual user/password</span><span id="9521" class="ld le hh kz b fi lj lg l lh li">params = [‘****-user’, ‘****-pw’] </span><span id="c320" class="ld le hh kz b fi lj lg l lh li">def get_credentials(params):<br/>    ssm = boto3.client('ssm',region)<br/>    response = ssm.get_parameters(<br/>       Names=params,<br/>       WithDecryption=True<br/>    )<br/>    #Build dict of credentials<br/>    param_values={k['Name']:k['Value'] for k in  response['Parameters']}<br/>    return param_values</span><span id="221c" class="ld le hh kz b fi lj lg l lh li">param_values=get_credentials(params)</span></pre><p id="6c8e" class="pw-post-body-paragraph jm jn hh jo b jp jq ii jr js jt il ju jv jw jx jy jz ka kb kc kd ke kf kg kh ha bi translated">浏览将在雪花连接器模块中使用的<em class="kr"> param_values </em>字典。</p><pre class="ix iy iz ja fd ky kz la lb aw lc bi"><span id="60af" class="ld le hh kz b fi lf lg l lh li">con = snowflake.connector.connect(<br/>    user = param_values['****-user'],<br/>    account="********",<br/>    password=param_values['****-pw'],<br/>    database = "&lt;database&gt;",<br/>    schema = "&lt;schema&gt;"<br/>)</span><span id="9bbc" class="ld le hh kz b fi lj lg l lh li">! Note: the 'account' is different from the Service Account you used earlier to store the user/pw</span></pre><p id="734b" class="pw-post-body-paragraph jm jn hh jo b jp jq ii jr js jt il ju jv jw jx jy jz ka kb kc kd ke kf kg kh ha bi translated">下一步是检查连接是否正常。运行下面的代码片段:</p><pre class="ix iy iz ja fd ky kz la lb aw lc bi"><span id="6b59" class="ld le hh kz b fi lf lg l lh li"># Check the connection works<br/>cur = con.cursor()<br/>print(sys.executable)<br/>print(sys.version)<br/>print(sys.version_info)<br/>try:<br/>    cur.execute("select current_date")<br/>    one_row=cur.fetchone()<br/>    print("Current_Date:",one_row[0])<br/>    cur.execute("SELECT current_version()")<br/>    one_row = cur.fetchone()<br/>    print("Snowflake_Version:",one_row[0])<br/>finally:<br/>    cur.close()<br/>cur.close()</span></pre><p id="dbd4" class="pw-post-body-paragraph jm jn hh jo b jp jq ii jr js jt il ju jv jw jx jy jz ka kb kc kd ke kf kg kh ha bi translated">成功连接后，上述代码的输出应该类似于:</p><pre class="ix iy iz ja fd ky kz la lb aw lc bi"><span id="7160" class="ld le hh kz b fi lf lg l lh li">/home/ec2-user/anaconda3/envs/python3/bin/python<br/>3.8.12 | packaged by conda-forge | (default, Oct 12 2021, 21:59:51) <br/>[GCC 9.4.0]<br/>sys.version_info(major=3, minor=8, micro=12, releaselevel='final', serial=0)<br/>Current_Date: 2022-08-08<br/>Snowflake_Version: 6.26.1</span><span id="3de5" class="ld le hh kz b fi lj lg l lh li">False</span></pre><p id="a23c" class="pw-post-body-paragraph jm jn hh jo b jp jq ii jr js jt il ju jv jw jx jy jz ka kb kc kd ke kf kg kh ha bi translated"><strong class="jo hi">第五步:</strong>执行查询并保存到亚马逊S3桶</p><pre class="ix iy iz ja fd ky kz la lb aw lc bi"><span id="c19d" class="ld le hh kz b fi lf lg l lh li">cur = con.cursor()<br/>cur.execute("SELECT TOP 10 * FROM &lt;some_db&gt;")<br/>result = cur.fetchall()</span><span id="92d3" class="ld le hh kz b fi lj lg l lh li"># Save the results into a dataframe<br/>result_df = pd.DataFrame(result)</span></pre><p id="b455" class="pw-post-body-paragraph jm jn hh jo b jp jq ii jr js jt il ju jv jw jx jy jz ka kb kc kd ke kf kg kh ha bi translated">一旦您对查询感到满意，您就可以将我们的数据帧写入S3桶，以进行进一步的预处理、模型训练和推理。将文件写入S3存储桶的示例片段如下:</p><pre class="ix iy iz ja fd ky kz la lb aw lc bi"><span id="a501" class="ld le hh kz b fi lf lg l lh li">import sagemaker <br/>sess = sagemaker.Session()</span><span id="9f56" class="ld le hh kz b fi lj lg l lh li">result_df.to_csv('result.csv')<br/>data = sess.upload_data('result.csv', <br/>                        bucket='&lt;your s3 bucket&gt;',<br/>                        key_prefix='&lt;folder inside your bucket&gt;')</span><span id="a160" class="ld le hh kz b fi lj lg l lh li">Note: Make sure you have a policy attached to the SageMaker Execution Role to access the S3 bucket.</span></pre><p id="2418" class="pw-post-body-paragraph jm jn hh jo b jp jq ii jr js jt il ju jv jw jx jy jz ka kb kc kd ke kf kg kh ha bi translated">Tada！恭喜你把SageMaker和雪花联系起来。如果你有任何建议/意见，请随意写。</p><h2 id="8009" class="ld le hh bd lm ln lo lp lq lr ls lt lu jv lv lw lx jz ly lz ma kd mb mc md me bi translated"><a class="ae mf" href="https://mlearning.substack.com/about" rel="noopener ugc nofollow" target="_blank"> <strong class="ak">成为MLearning.ai作家</strong> </a></h2><div class="mg mh ez fb mi mj"><a rel="noopener follow" target="_blank" href="/mlearning-ai/mlearning-ai-submission-suggestions-b51e2b130bfb"><div class="mk ab dw"><div class="ml ab mm cl cj mn"><h2 class="bd hi fi z dy mo ea eb mp ed ef hg bi translated">Mlearning.ai提交建议</h2><div class="mq l"><h3 class="bd b fi z dy mo ea eb mp ed ef dx translated">如何成为Mlearning.ai上的作家</h3></div><div class="mr l"><p class="bd b fp z dy mo ea eb mp ed ef dx translated">medium.com</p></div></div><div class="ms l"><div class="mt l mu mv mw ms mx jg mj"/></div></div></a></div></div></div>    
</body>
</html>