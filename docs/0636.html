<html>
<head>
<title>Creating a prediction service in Python in less than 5 min</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在不到5分钟的时间内用Python创建预测服务</h1>
<blockquote>原文：<a href="https://medium.com/mlearning-ai/creating-a-prediction-service-in-python-in-less-than-5-min-59bb02c49c40?source=collection_archive---------0-----------------------#2021-06-03">https://medium.com/mlearning-ai/creating-a-prediction-service-in-python-in-less-than-5-min-59bb02c49c40?source=collection_archive---------0-----------------------#2021-06-03</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><p id="02be" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">任何机器学习应用程序的核心，无论是生产优化、异常检测还是简单的信息仪表板，都有一个预测服务。预测服务的作用是接收(原始或处理后的)数据并提供预测，其他服务使用预测来解决手头的问题。</p><figure class="jd je jf jg fd jh er es paragraph-image"><div role="button" tabindex="0" class="ji jj di jk bf jl"><div class="er es jc"><img src="../Images/68e6bb98912e051f00d02174be168f8d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cs0Wsb8mQbv21xBSZ6caLA.png"/></div></div><figcaption class="jo jp et er es jq jr bd b be z dx">A simple prediction service</figcaption></figure><p id="ef53" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">不管最终的用例是什么，将一个训练好的模型转换成一个稳定的服务，并提供一个允许外界访问该服务的接口，这可能是每个机器学习项目中最频繁重复出现的任务之一。在这篇文章中，我将向您展示如何在不到5分钟的时间内使用Daeploy创建一个预测服务！</p><p id="53f4" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">注意:这个示例和其他几个示例的源代码可以在我们的公共<a class="ae js" href="https://github.com/vikinganalytics/daeploy-examples" rel="noopener ugc nofollow" target="_blank">示例库</a>中找到。</p><h1 id="b35d" class="jt ju hh bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">剖析使用Daeploy的预测服务</h1><p id="fbd8" class="pw-post-body-paragraph ie if hh ig b ih kr ij ik il ks in io ip kt ir is it ku iv iw ix kv iz ja jb ha bi translated">让我们从著名的iris flowers数据集的预测服务的示例代码开始。关于如何为鸢尾花数据集训练分类器，有大量的例子。在我们的示例存储库中的“ml_model_serving”文件夹中也有一个<a class="ae js" href="https://github.com/vikinganalytics/daeploy-examples/blob/master/ml_model_serving/train_model.py" rel="noopener ugc nofollow" target="_blank"> train_model.py </a>。在这里，我想重点介绍一下预测服务及其部署。</p><p id="4134" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">让我们先来看看<a class="ae js" href="https://github.com/vikinganalytics/daeploy-examples/blob/master/ml_model_serving/iris_project/service.py" rel="noopener ugc nofollow" target="_blank"> service.py </a>。如您所见，它只有24行代码。</p><figure class="jd je jf jg fd jh er es paragraph-image"><div class="er es kw"><img src="../Images/344a035f62a093c5bb979a2fd0ffc535.png" data-original-src="https://miro.medium.com/v2/resize:fit:1302/format:webp/1*vphbhC086btIM7oLfonSDw.png"/></div><figcaption class="jo jp et er es jq jr bd b be z dx">Anatomy of predictoin service by Daeploy</figcaption></figure><h2 id="841c" class="kx ju hh bd jv ky kz la jz lb lc ld kd ip le lf kh it lg lh kl ix li lj kp lk bi translated">准系统服务(1分钟)</h2><p id="46ae" class="pw-post-body-paragraph ie if hh ig b ih kr ij ik il ks in io ip kt ir is it ku iv iw ix kv iz ja jb ha bi translated">服务总是从导入所需的库开始。第1–3行导入所需的标准Python库。第5行和第6行从Daeploy SDK导入服务和数据类型。</p><p id="a7aa" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">第8行使用Python标准日志库设置了一个日志记录器。最后，第23行和第24行将我们的脚本转换为服务。当我们使用Daeploy命令行界面(CLI)部署脚本时，service.run()告诉Daeploy manager这个脚本是一个服务。然后，Daeploy manager自动构建docker映像，安装requirements.txt中定义的所有依赖项，并运行脚本(稍后将详细介绍)。</p><h2 id="041d" class="kx ju hh bd jv ky kz la jz lb lc ld kd ip le lf kh it lg lh kl ix li lj kp lk bi translated">加载模型(1分钟)</h2><p id="5eb9" class="pw-post-body-paragraph ie if hh ig b ih kr ij ik il ks in io ip kt ir is it ku iv iw ix kv iz ja jb ha bi translated">训练后导出模型有不同的方法。在这个例子中，我们使用scikit学习库，并且使用pickle库导出模型。在项目中创建一个名为“models”的文件夹，并将classifier.pkl文件复制到该文件夹中。</p><p id="038c" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">第9行到第12行共同为分类器的位置设置了正确的路径，并从pickle文件中加载它。</p><h2 id="48ce" class="kx ju hh bd jv ky kz la jz lb lc ld kd ip le lf kh it lg lh kl ix li lj kp lk bi translated">创建API(1分钟)</h2><p id="464b" class="pw-post-body-paragraph ie if hh ig b ih kr ij ik il ks in io ip kt ir is it ku iv iw ix kv iz ja jb ha bi translated">Daeploy SDK的一个强大特性是，它通过修饰将任何Python函数转换成API。第16–20行定义了一个简单的预测函数，它接收dataframe作为输入数据类型，并返回一个数组作为输出。第15行的service.entrypoint装饰器将这个函数转换成一个API。</p><p id="f27a" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我们花了大约3分钟和24行代码来编写一个功能完整的预测服务的代码。接下来，我们将部署和测试我们的服务。</p><h1 id="b3d6" class="jt ju hh bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">部署服务</h1><p id="04e9" class="pw-post-body-paragraph ie if hh ig b ih kr ij ik il ks in io ip kt ir is it ku iv iw ix kv iz ja jb ha bi translated">为了部署我们的服务，我们需要在目标机器上运行Daeploy manager，目标机器可以是工厂中的服务器、云中的虚拟机或者本地的您自己的计算机。管理器将您的代码打包成服务，这些服务可以使用基于HTTP的REST API进行通信。</p><h2 id="be8c" class="kx ju hh bd jv ky kz la jz lb lc ld kd ip le lf kh it lg lh kl ix li lj kp lk bi translated">运行部署管理器(1分钟)</h2><p id="5ea1" class="pw-post-body-paragraph ie if hh ig b ih kr ij ik il ks in io ip kt ir is it ku iv iw ix kv iz ja jb ha bi translated">我将在本地计算机上部署我的预测服务。但是，无论目标主机位于何处，都适用相同的过程。Daeploy manager是一个docker映像，可在<a class="ae js" href="https://hub.docker.com/r/daeploy/manager" rel="noopener ugc nofollow" target="_blank"> docker hub </a>上免费获得。要启动在本地主机上运行的免费试用管理器，请运行以下命令:</p><pre class="jd je jf jg fd ll lm ln lo aw lp bi"><span id="e47d" class="kx ju hh lm b fi lq lr l ls lt">$ docker run -v /var/run/docker.sock:/var/run/docker.sock -p 80:80 -p 443:443 -d daeploy/manager:latest</span></pre><p id="5c6d" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">您可以通过在浏览器中打开<a class="ae js" href="http://localhost/" rel="noopener ugc nofollow" target="_blank"> http://localhost/ </a>来检查它是否正确启动。试用版管理器可以不受限制地使用12个小时，然后必须重新启动。</p><p id="0e87" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi">注意:</strong>使用环境变量管理器是高度可配置的。要了解生产环境的管理器设置，请参见此处的<a class="ae js" href="https://vikinganalytics.github.io/daeploy-docs/1.0.1/content/advanced_tutorials/manager_configuration.html#typical-production-setup" rel="noopener ugc nofollow" target="_blank"/>。</p><h2 id="0b5f" class="kx ju hh bd jv ky kz la jz lb lc ld kd ip le lf kh it lg lh kl ix li lj kp lk bi translated">部署预测服务(1分钟)</h2><p id="cd02" class="pw-post-body-paragraph ie if hh ig b ih kr ij ik il ks in io ip kt ir is it ku iv iw ix kv iz ja jb ha bi translated">Daeploy SDK附带了一个命令行界面(CLI ),可用于与Daeploy manager进行通信。如果您还没有这样做，请安装daeploy库:</p><pre class="jd je jf jg fd ll lm ln lo aw lp bi"><span id="2aa8" class="kx ju hh lm b fi lq lr l ls lt">$ pip install daeploy</span></pre><p id="faa9" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">Daeploy manager带有内置的身份验证。因此，为了能够与管理器通信，我们需要首先登录。默认用户名和密码是“admin”和“admin”。</p><pre class="jd je jf jg fd ll lm ln lo aw lp bi"><span id="1ada" class="kx ju hh lm b fi lq lr l ls lt">$ daeploy login<br/>Enter daeploy host: <a class="ae js" href="http://localhost" rel="noopener ugc nofollow" target="_blank">http://localhost</a></span></pre><p id="c838" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">成功登录后，我们将连接到指定的主机，并能够与Daeploy Manager通信。我们现在准备部署我们的预测服务。使用Daeploy CLI，我们可以使用deploy命令部署我们的服务。三个输入是必需的:服务名、服务版本和服务文件夹的路径。在这个例子中，我们用版本1.0.0调用我们的服务prediction_service。</p><pre class="jd je jf jg fd ll lm ln lo aw lp bi"><span id="2c62" class="kx ju hh lm b fi lq lr l ls lt">$ daeploy deploy prediction_service 1.0.0 &lt;path to the project&gt;</span></pre><p id="ffa7" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">管理器将花费几秒钟时间从我们的service.py构建docker映像，安装requirements.txt中定义的依赖项，并将其作为服务运行。</p><figure class="jd je jf jg fd jh er es paragraph-image"><div role="button" tabindex="0" class="ji jj di jk bf jl"><div class="er es lu"><img src="../Images/25f67964402289065f84459d8dc02813.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6TgKiSCpFmm9Lpw1sUooVg.png"/></div></div></figure><h1 id="b6a6" class="jt ju hh bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">测试我们的预测服务</h1><p id="a637" class="pw-post-body-paragraph ie if hh ig b ih kr ij ik il ks in io ip kt ir is it ku iv iw ix kv iz ja jb ha bi translated">有几种方法可以测试我们新运行的预测服务。我们将研究两种方法:交互式API和Python请求库</p><h2 id="4a7b" class="kx ju hh bd jv ky kz la jz lb lc ld kd ip le lf kh it lg lh kl ix li lj kp lk bi translated">交互式API</h2><p id="b609" class="pw-post-body-paragraph ie if hh ig b ih kr ij ik il ks in io ip kt ir is it ku iv iw ix kv iz ja jb ha bi translated">Daeploy manager带有一个仪表板。访问localhost，使用默认用户名(admin)和密码(admin)登录。您应该能够看到您的预测服务正在运行:</p><figure class="jd je jf jg fd jh er es paragraph-image"><div role="button" tabindex="0" class="ji jj di jk bf jl"><div class="er es lv"><img src="../Images/12afa5ecb0231dc0c669c2e9e58fcc9a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YIVwlQfbgZhcOtWHJQyZug.png"/></div></div><figcaption class="jo jp et er es jq jr bd b be z dx">Daeploy dashboard — prediction_service is running.</figcaption></figure><p id="98c1" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">每个服务都有两个链接:日志和文档。单击服务文档打开交互式API文档。</p><figure class="jd je jf jg fd jh er es paragraph-image"><div role="button" tabindex="0" class="ji jj di jk bf jl"><div class="er es lw"><img src="../Images/3239398b5239b2789f6ed11c6b8c457e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GBasgFl-3-9kCDUSMSA6Eg.png"/></div></div><figcaption class="jo jp et er es jq jr bd b be z dx">The interactive API for prediction_service</figcaption></figure><p id="8ab8" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">正如您所看到的，Daeploy管理器已经将我们的predict方法添加到了一个API中。通过打开predict入口点，您将有可能使用“尝试”按钮与API进行交互。提供测试数据，并从我们的服务中获得预测。</p><figure class="jd je jf jg fd jh er es paragraph-image"><div role="button" tabindex="0" class="ji jj di jk bf jl"><div class="er es lx"><img src="../Images/7cbf47eb13323b8c9093989d4c1c142d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_r3m6K3BQiD1HGa5NNj3Nw.png"/></div></div><figcaption class="jo jp et er es jq jr bd b be z dx">Use the interactive API to try out your endpoint</figcaption></figure><h2 id="f3b6" class="kx ju hh bd jv ky kz la jz lb lc ld kd ip le lf kh it lg lh kl ix li lj kp lk bi translated">Python请求库</h2><p id="8dc9" class="pw-post-body-paragraph ie if hh ig b ih kr ij ik il ks in io ip kt ir is it ku iv iw ix kv iz ja jb ha bi translated">我们还可以使用任何软件发送POST请求，与我们的服务进行交互。在Python中，我们可以使用请求库与我们的服务进行通信。如果还没有，请安装请求库:</p><pre class="jd je jf jg fd ll lm ln lo aw lp bi"><span id="1e31" class="kx ju hh lm b fi lq lr l ls lt">$ pip install requests</span></pre><p id="7167" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">如果您的服务运行在启用了身份验证的管理器上(对于生产设置来说应该如此)，那么对该服务的任何请求都必须通过包含有效的身份验证令牌来进行身份验证。令牌由部署管理器生成。要生成新令牌，请使用Daeploy CLI:</p><pre class="jd je jf jg fd ll lm ln lo aw lp bi"><span id="24ef" class="kx ju hh lm b fi lq lr l ls lt">$ daeploy token</span></pre><p id="289a" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">这将生成一个长期的身份验证令牌。要从我们的预测服务获得预测，我们需要运行以下命令:</p><pre class="jd je jf jg fd ll lm ln lo aw lp bi"><span id="7316" class="kx ju hh lm b fi lq lr l ls lt">TOKEN = "your_token"<br/>response = requests.post(<br/>    "services/prediction_service/predict",<br/>    json={"data": &lt;test data&gt;},<br/>    headers={"Authorization": f"Bearer <strong class="lm hi">{</strong>TOKEN<strong class="lm hi">}</strong>"})</span><span id="6fdb" class="kx ju hh lm b fi ly lr l ls lt">print(f"Response: {response.status_code} - {response.reason}")</span></pre><p id="c075" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">将模型转换为运行预测服务是大多数机器学习解决方案的主要构件之一。使用Daeploy创建这样一个服务会产生一个不到30行代码的python脚本。Daeploy manager解决了部署的困难，并将我们的脚本转换成一个正在运行的服务。整个过程不到5分钟。你应该试试！快乐<a class="ae js" href="http://www.daeploy.com" rel="noopener ugc nofollow" target="_blank">d就业</a>！</p></div></div>    
</body>
</html>