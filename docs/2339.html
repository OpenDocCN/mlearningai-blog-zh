<html>
<head>
<title>Setting up a Local MLOps dev environment — Part 1</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">设置本地MLOps开发环境—第1部分</h1>
<blockquote>原文：<a href="https://medium.com/mlearning-ai/setting-up-a-local-mlops-dev-environment-part-1-a8b468329819?source=collection_archive---------1-----------------------#2022-04-17">https://medium.com/mlearning-ai/setting-up-a-local-mlops-dev-environment-part-1-a8b468329819?source=collection_archive---------1-----------------------#2022-04-17</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><p id="064d" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在这个由两篇文章组成的系列中，我分享了在裸机Ubuntu工作站上从头开始设置本地MLOps开发环境的经验。这一部分是关于在工作站上安装Kubernetes集群，在下一部分，我们将看到如何在Kubernetes集群上安装Kubeflow。</p><figure class="jd je jf jg fd jh er es paragraph-image"><div role="button" tabindex="0" class="ji jj di jk bf jl"><div class="er es jc"><img src="../Images/f9092aafef54edf5abf078626371f78f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*bL5xDKf-9vIihWEQ"/></div></div><figcaption class="jo jp et er es jq jr bd b be z dx">Photo by <a class="ae js" href="https://unsplash.com/@shanerounce?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Shane Rounce</a> on <a class="ae js" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><h1 id="6da2" class="jt ju hh bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">在裸机上安装Kubernetes集群(Ubuntu 20.04)</h1><h1 id="c37c" class="jt ju hh bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">环境信息</h1><ul class=""><li id="86f4" class="kr ks hh ig b ih kt il ku ip kv it kw ix kx jb ky kz la lb bi translated">Ubuntu Server 20.04.4 LTS</li><li id="de76" class="kr ks hh ig b ih lc il ld ip le it lf ix lg jb ky kz la lb bi translated">三个HP Z620塔式工作站，带单个4核/ 8vCPU ( 1个英特尔至强处理器E5–2643/32GB RAM/1tb硬盘</li></ul><p id="64ac" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">三台服务器/工作站应分配如下主机名和IP:</p><ul class=""><li id="512b" class="kr ks hh ig b ih ii il im ip lh it li ix lj jb ky kz la lb bi translated">主-192 . 168 . 1 . 207</li><li id="05c7" class="kr ks hh ig b ih lc il ld ip le it lf ix lg jb ky kz la lb bi translated">工人1–192 . 168 . 1 . 199</li><li id="2b02" class="kr ks hh ig b ih lc il ld ip le it lf ix lg jb ky kz la lb bi translated">工人2–192 . 168 . 1 . 208</li></ul><h1 id="9c85" class="jt ju hh bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">这是怎么回事？</h1><p id="1d02" class="pw-post-body-paragraph ie if hh ig b ih kt ij ik il ku in io ip lk ir is it ll iv iw ix lm iz ja jb ha bi translated">Kubernetes是一个工具，用于在本地服务器上或跨混合云环境大规模编排和管理容器化的应用程序。对于任何MLOps生态系统，Kubernetes都是托管应用程序的首选方式，因此ML应用程序可以扩展并托管在不同的环境中。Kubeadm是Kubernetes提供的一个工具，用于帮助用户安装一个带有隐式验证的生产就绪的Kubernetes集群。本教程将演示如何将Kubernetes集群安装在一组装有Kubeadm的裸机Ubuntu Server 20.04工作站上。</p><p id="9f2b" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">要了解更多关于Kubernetes的信息，请查看Kubernetes   <em class="ln">官方网站的<a class="ae js" href="https://kubernetes.io/docs/concepts/overview/what-is-kubernetes/" rel="noopener ugc nofollow" target="_blank"> <em class="ln">官方文档。</em></a></em></p><p id="dced" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">该实验室包含三台服务器。一个控制或主节点，而另外两个作为工作节点。通过主机名可以很容易地识别它们。</p><h1 id="5ca7" class="jt ju hh bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">步骤0准备装有Ubuntu操作系统的工作站</h1><p id="a98c" class="pw-post-body-paragraph ie if hh ig b ih kt ij ik il ku in io ip lk ir is it ll iv iw ix lm iz ja jb ha bi translated">用Ubuntu Server 20.04.4 LTS操作系统设置工作站。请参考<em class="ln"> </em> <a class="ae js" href="https://ubuntu.com/download/server" rel="noopener ugc nofollow" target="_blank"> <em class="ln">链接</em> </a>选项2，即手动安装服务器，在您的工作站上安装操作系统。如果已经安装了操作系统，甚至可以跳过这一步。</p><p id="e971" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">用相关的别名和主机名更新三台服务器的/etc/hosts文件。</p><pre class="jd je jf jg fd lo lp lq lr aw ls bi"><span id="ecda" class="lt ju hh lp b fi lu lv l lw lx">sudo vi /etc/hosts (make necessary entries for the three workstations)</span></pre><p id="8970" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在节点间启用无密码登录。[ <strong class="ig hi">可选</strong></p><pre class="jd je jf jg fd lo lp lq lr aw ls bi"><span id="d169" class="lt ju hh lp b fi lu lv l lw lx">ssh-keygen -t rsa<br/>ssh-copy-id user@&lt;hostname&gt;</span></pre><p id="151b" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">一旦服务器准备好了，就更新它们。</p><pre class="jd je jf jg fd lo lp lq lr aw ls bi"><span id="00e7" class="lt ju hh lp b fi lu lv l lw lx">sudo apt update<br/>sudo apt -y full-upgrade<br/>[ -f /var/run/reboot-required ] &amp;&amp; sudo reboot -f</span></pre><h1 id="14ef" class="jt ju hh bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">步骤1安装kubelet、kubeadm和kubectl</h1><p id="b778" class="pw-post-body-paragraph ie if hh ig b ih kt ij ik il ku in io ip lk ir is it ll iv iw ix lm iz ja jb ha bi translated">重新启动后，将Ubuntu 20.04的Kubernetes存储库添加到所有节点。</p><pre class="jd je jf jg fd lo lp lq lr aw ls bi"><span id="e37b" class="lt ju hh lp b fi lu lv l lw lx">sudo apt -y install curl apt-transport-https<br/>curl -s https://packages.cloud.google.com/apt/doc/apt-key.gpg | sudo apt-key add -<br/>echo "deb https://apt.kubernetes.io/ kubernetes-xenial main" | sudo tee /etc/apt/sources.list.d/kubernetes.list</span></pre><p id="0517" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">然后安装所需的软件包。</p><p id="bbe5" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><em class="ln">注意:对于MLOps软件，我将安装与版本1.22及更高版本不兼容的Kubeflow 1.5.0，因此我将安装版本1.21.10的Kubernetes CLI。</em></p><pre class="jd je jf jg fd lo lp lq lr aw ls bi"><span id="3759" class="lt ju hh lp b fi lu lv l lw lx">sudo apt update<br/>sudo apt -y install vim git curl wget kubelet=1.21.10-00 kubectl=1.21.10-00 kubeadm=1.21.10-00<br/>sudo apt-mark hold kubelet kubeadm kubectl</span></pre><p id="1711" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">通过检查kubectl的版本来确认安装。</p><pre class="jd je jf jg fd lo lp lq lr aw ls bi"><span id="9cdd" class="lt ju hh lp b fi lu lv l lw lx">kubectl version --client &amp;&amp; kubeadm version</span></pre><h1 id="c6aa" class="jt ju hh bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">禁用交换</h1><p id="86de" class="pw-post-body-paragraph ie if hh ig b ih kt ij ik il ku in io ip lk ir is it ll iv iw ix lm iz ja jb ha bi translated">关闭交换</p><pre class="jd je jf jg fd lo lp lq lr aw ls bi"><span id="2736" class="lt ju hh lp b fi lu lv l lw lx">sudo swapon --show<br/>sudo vi /etc/fstab  (<strong class="lp hi"><em class="ln">comment the swap entry</em></strong>)<br/>sudo swapoff -a<br/>sudo swapon --show</span></pre><p id="c235" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">如果你想知道为什么在安装Kubernetes时需要禁用swap，请参考本期<a class="ae js" href="https://github.com/kubernetes/kubernetes/issues/53533" rel="noopener ugc nofollow" target="_blank"><em class="ln"/></a>。</p><h1 id="b15b" class="jt ju hh bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">步骤4启用内核模块并向sysctl添加配置</h1><p id="a433" class="pw-post-body-paragraph ie if hh ig b ih kt ij ik il ku in io ip lk ir is it ll iv iw ix lm iz ja jb ha bi translated">作为Linux节点的<em class="ln"> iptables </em>正确查看桥接流量的一个要求，您应该确保<em class="ln">net . bridge . bridge-nf-call-iptables</em>在您的<em class="ln"> sysctl </em>配置中设置为1，例如</p><pre class="jd je jf jg fd lo lp lq lr aw ls bi"><span id="8250" class="lt ju hh lp b fi lu lv l lw lx"><strong class="lp hi"><em class="ln"># Enable kernel modules</em></strong><br/>sudo modprobe overlay<br/>sudo modprobe br_netfilter<!-- --> </span><span id="40b2" class="lt ju hh lp b fi ly lv l lw lx"><strong class="lp hi"><em class="ln"># Add settings to sysctl</em></strong><br/>sudo tee /etc/sysctl.d/kubernetes.conf&lt;&lt;EOF<br/>net.bridge.bridge-nf-call-ip6tables = 1<br/>net.bridge.bridge-nf-call-iptables = 1<br/>net.ipv4.ip_forward = 1<br/>EOF</span><span id="4e0c" class="lt ju hh lp b fi ly lv l lw lx"><strong class="lp hi"><em class="ln"># Reload sysctl</em></strong><br/>sudo sysctl --system</span></pre><h1 id="3fdb" class="jt ju hh bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">步骤5安装容器运行时</h1><p id="b9da" class="pw-post-body-paragraph ie if hh ig b ih kt ij ik il ku in io ip lk ir is it ll iv iw ix lm iz ja jb ha bi translated">Kubernetes支持多个容器运行时来运行pod中的容器。但是，在这篇文章里，我只讲Docker。</p><pre class="jd je jf jg fd lo lp lq lr aw ls bi"><span id="1911" class="lt ju hh lp b fi lu lv l lw lx"><strong class="lp hi"># Add repo and Install packages</strong><br/>sudo apt update<br/>sudo apt install -y curl gnupg2 software-properties-common apt-transport-https ca-certificates<br/>curl -fsSL https:<em class="ln">//download.docker.com/linux/ubuntu/gpg | sudo apt-key add -</em><br/>sudo add-apt-repository "deb [arch=amd64] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable"<br/>sudo apt update<br/>sudo apt install -y containerd.io docker-ce docker-ce-cli</span><span id="27e9" class="lt ju hh lp b fi ly lv l lw lx"><strong class="lp hi"># Create required directories</strong><br/>sudo mkdir -p /etc/systemd/system/docker.service.d</span><span id="d28c" class="lt ju hh lp b fi ly lv l lw lx"><strong class="lp hi"># Create daemon json config file</strong><br/>sudo tee /etc/docker/daemon.json &lt;&lt;EOF<br/>{<br/>  "exec-opts": ["native.cgroupdriver=systemd"],<br/>  "log-driver": "json-file",<br/>  "log-opts": {<br/>    "max-size": "100m"<br/>  },<br/>  "storage-driver": "overlay2"<br/>}<br/>EOF</span><span id="3530" class="lt ju hh lp b fi ly lv l lw lx"><strong class="lp hi"># Start and enable Services</strong><br/>sudo systemctl daemon-reload <br/>sudo systemctl restart docker<br/>sudo systemctl enable docker</span></pre><h1 id="3bc5" class="jt ju hh bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">步骤6初始化主节点</h1><p id="4345" class="pw-post-body-paragraph ie if hh ig b ih kt ij ik il ku in io ip lk ir is it ll iv iw ix lm iz ja jb ha bi translated">在主节点上，确保加载了<em class="ln"> br_netfilter </em>模块。</p><pre class="jd je jf jg fd lo lp lq lr aw ls bi"><span id="7cc1" class="lt ju hh lp b fi lu lv l lw lx">lsmod | grep br_netfilter</span></pre><p id="6d7c" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">启用kubelet服务</p><pre class="jd je jf jg fd lo lp lq lr aw ls bi"><span id="82ba" class="lt ju hh lp b fi lu lv l lw lx">sudo systemctl enable kubelet</span></pre><p id="629f" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">接下来，提取容器图像</p><pre class="jd je jf jg fd lo lp lq lr aw ls bi"><span id="698b" class="lt ju hh lp b fi lu lv l lw lx">sudo kubeadm config images pull</span></pre><p id="cda4" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">用kubeadm引导集群。请参考<a class="ae js" href="https://kubernetes.io/docs/reference/setup-tools/kubeadm/kubeadm-init/" rel="noopener ugc nofollow" target="_blank">https://kubernetes . io/docs/reference/setup-tools/kube ADM/kube ADM-init/</a>了解有关kubeadm init的有效参数的更多信息。</p><pre class="jd je jf jg fd lo lp lq lr aw ls bi"><span id="37d6" class="lt ju hh lp b fi lu lv l lw lx">sudo kubeadm init --apiserver-advertise-address=192.168.1.207 --upload-certs --pod-network-cidr=192.168.0.0/16 --control-plane-endpoint=control-k8s</span></pre><p id="3afb" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">接下来，为普通用户设置集群访问</p><pre class="jd je jf jg fd lo lp lq lr aw ls bi"><span id="cd2c" class="lt ju hh lp b fi lu lv l lw lx"><strong class="lp hi">mkdir</strong> -p $HOME/.kube<br/>sudo cp -f /etc/kubernetes/admin.conf $HOME/.kube/config<br/>sudo chown $(id -u):$(id -g) $HOME/.kube/config</span></pre><p id="fde8" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">接下来，使用kubectl检查集群信息</p><pre class="jd je jf jg fd lo lp lq lr aw ls bi"><span id="764f" class="lt ju hh lp b fi lu lv l lw lx">kubectl cluster-info</span></pre><p id="998b" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">检查主节点是否处于哪个状态。</p><pre class="jd je jf jg fd lo lp lq lr aw ls bi"><span id="2fbd" class="lt ju hh lp b fi lu lv l lw lx">kubectl get nodes -o wide</span></pre><p id="9393" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">可以看出，主设备不处于'<em class="ln">未就绪</em>状态。</p><h1 id="e22e" class="jt ju hh bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">步骤7在主节点上安装网络插件</h1><p id="d322" class="pw-post-body-paragraph ie if hh ig b ih kt ij ik il ku in io ip lk ir is it ll iv iw ix lm iz ja jb ha bi translated">接下来，安装一个Pod网络插件。在本练习中，我将使用calico，但请参考<a class="ae js" href="https://kubernetes.io/docs/concepts/cluster-administration/addons/" rel="noopener ugc nofollow" target="_blank"> <em class="ln">支持的网络插件</em> </a>查看支持的插件。</p><pre class="jd je jf jg fd lo lp lq lr aw ls bi"><span id="4c13" class="lt ju hh lp b fi lu lv l lw lx">kubectl create -f https://docs.projectcalico.org/manifests/tigera-operator.yaml <br/>kubectl create -f <a class="ae js" href="https://docs.projectcalico.org/manifests/custom-resources.yaml" rel="noopener ugc nofollow" target="_blank">https://docs.projectcalico.org/manifests/custom-resources.yaml</a></span></pre><p id="e03f" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">检查所有吊舱是否处于运行状态。</p><pre class="jd je jf jg fd lo lp lq lr aw ls bi"><span id="393a" class="lt ju hh lp b fi lu lv l lw lx">kubectl get pods -A</span></pre><p id="680b" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">另外，现在检查主节点的状态。</p><pre class="jd je jf jg fd lo lp lq lr aw ls bi"><span id="e79c" class="lt ju hh lp b fi lu lv l lw lx">kubectl get nodes -o wide</span></pre><h1 id="f1f0" class="jt ju hh bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">步骤8添加工作节点</h1><p id="5b4b" class="pw-post-body-paragraph ie if hh ig b ih kt ij ik il ku in io ip lk ir is it ll iv iw ix lm iz ja jb ha bi translated">现在，由于控制平面或主节点都已设置好，可以在“worker”角色中增加更多的节点，这些节点将主要由Kubernetes用来调度所有的工作负载。</p><p id="9216" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">要加入集群，请使用步骤6中生成的join命令。</p><p id="3df8" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">万岁！！现在，我们已经为自己的本地Kubernetes集群设置了docker运行时。</p><h1 id="5e86" class="jt ju hh bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">结论</h1><p id="080c" class="pw-post-body-paragraph ie if hh ig b ih kt ij ik il ku in io ip lk ir is it ll iv iw ix lm iz ja jb ha bi translated">我们现在已经准备好了一个本地Kubernetes集群，并为下一部分做好了一切准备。同时，尽管这看起来是一个简单明了的练习，但是你可能会像我一样面临某些问题。请在您的评论/反馈中与我分享。可能有一些我们可以谈论的共同话题:)。此外，总的来说，请留下您的反馈/评论，让我知道您是否喜欢这篇文章或任何进一步改进的空间。谢谢！</p><p id="c80b" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">第二部分</p><p id="1291" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi lz translated"><span class="l ma mb mc bm md me mf mg mh di">如果</span> <strong class="ig hi">你想看所有日志&amp;输出的所有动作，参考这个视频。</strong></p><figure class="jd je jf jg fd jh"><div class="bz dy l di"><div class="mi mj l"/></div></figure><div class="mk ml ez fb mm mn"><a rel="noopener follow" target="_blank" href="/mlearning-ai/mlearning-ai-submission-suggestions-b51e2b130bfb"><div class="mo ab dw"><div class="mp ab mq cl cj mr"><h2 class="bd hi fi z dy ms ea eb mt ed ef hg bi translated">Mlearning.ai提交建议</h2><div class="mu l"><h3 class="bd b fi z dy ms ea eb mt ed ef dx translated">如何成为Mlearning.ai上的作家</h3></div><div class="mv l"><p class="bd b fp z dy ms ea eb mt ed ef dx translated">medium.com</p></div></div><div class="mw l"><div class="mx l my mz na mw nb jm mn"/></div></div></a></div></div></div>    
</body>
</html>