<html>
<head>
<title>Control Charts for Machine Learning Using Python</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Python的机器学习控制图</h1>
<blockquote>原文：<a href="https://medium.com/mlearning-ai/control-charts-for-machine-learning-using-python-b8a7866d54fb?source=collection_archive---------2-----------------------#2022-08-28">https://medium.com/mlearning-ai/control-charts-for-machine-learning-using-python-b8a7866d54fb?source=collection_archive---------2-----------------------#2022-08-28</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><h1 id="178c" class="ie if hh bd ig ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb bi translated"><strong class="ak">简介</strong></h1><p id="61b7" class="pw-post-body-paragraph jc jd hh je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ha bi translated">控制图是一种可视化的机制，通过跟踪一段时间内质量特性的独立观察来监控过程。这种方法是由统计学家Walter Shewhart在20世纪初提出的，并在工业环境中得到了许多应用(尤其是在制造业)。控制图的主要思想是通过根据质量特性的概率分布设定下限和上限(即控制极限)来确定过程是否在统计控制之下。然后，您可以使用这些界限随时监控您的流程。虽然有点过时，但我相信控制图是监控部署的机器学习模型的一种有价值的方法<strong class="je hi">。<em class="ka">在本文中，我将展示一个案例，说明我们如何使用最基本的控制图来监控一个已部署的机器学习模型。</em> </strong></p><h1 id="f11e" class="ie if hh bd ig ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb bi translated">控制图在今天有用吗？</h1><p id="cfa1" class="pw-post-body-paragraph jc jd hh je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ha bi translated">有些人认为控制图是一种古老的技术，只适用于制造业。然而，我相信最近的计算进步已经使控制图比以往更加实用。在早期，大多数数据收集都必须手动进行(即物理数据收集)。今天，我们拥有可以自动收集任何过程数据的传感器。我们也有不一定有物理组件的虚拟进程，其数据完全在云上。我们可以将部署的机器学习模型视为虚拟过程。今天，机器学习模型正在各种行业中部署。因此，数据科学家和公司必须监控他们部署的机器学习模型。一种方法是使用控制图。</p><h1 id="8c47" class="ie if hh bd ig ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb bi translated">案例研究:使用控制图监控ML模型性能</h1><p id="d6c1" class="pw-post-body-paragraph jc jd hh je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ha bi translated">假设您在一家医院担任数据科学家，试图实现一个系统，使患者和保险公司能够评估患者出院的成本。<strong class="je hi"> <em class="ka">因此，作为一名数据科学家，你的任务是开发一个机器学习模型，在病人甚至被送入医院之前，预测病人出院的成本。</em> </strong>作为一名数据科学家，你遵循机器学习管道进行模型部署。您收集并清理了数据，对问题进行了建模，并在看不见的数据中测试了这些模型。验证之后，模型就可以部署了。你知道部署模型不是机器学习管道的最后一步。您需要建立一种方法来监控其性能。</p><figure class="kc kd ke kf fd kg er es paragraph-image"><div role="button" tabindex="0" class="kh ki di kj bf kk"><div class="er es kb"><img src="../Images/2190f6e7ec20d2f73e84404b9ef90a68.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Q4LU38tknjCHY1Do"/></div></div><figcaption class="kn ko et er es kp kq bd b be z dx">Photo by <a class="ae kr" href="https://unsplash.com/@lukechesser?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Luke Chesser</a> on <a class="ae kr" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="7862" class="pw-post-body-paragraph jc jd hh je b jf ks jh ji jj kt jl jm jn ku jp jq jr kv jt ju jv kw jx jy jz ha bi translated">有很多方法可以做到这一点。然而，监控您部署的模型总是一项复杂的任务。专注于实验跟踪和模型注册的初创公司Nepute AI写了一篇关于这个主题的有用文章[1]。监控模型的策略之一是使用统计技术来识别用于训练模型的要素的潜在分布变化。虽然这个策略是有帮助的，但可能还不够。如果模型性能受到模型中未包含的特征的影响，该怎么办？在这种情况下，仅监视特征分布可能会导致关于模型性能的错误结论。为此，您可能对监控预测误差感兴趣。</p><h1 id="cc71" class="ie if hh bd ig ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb bi translated">监控模型性能</h1><h2 id="6aba" class="kx if hh bd ig ky kz la ik lb lc ld io jn le lf is jr lg lh iw jv li lj ja lk bi translated">关于控制图:我们的目标是什么？</h2><p id="d86c" class="pw-post-body-paragraph jc jd hh je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ha bi translated">假设在训练过程中，你估计的均方差是228平方美元。部署之后，您希望确保均方差在不同的时间点保持相对恒定(或者至少不会增加)。因此，您决定使用XBar控制图来监控模型性能。假设平均值为228平方美元，这将使您能够建立均方差可能所在的可接受区域。该区域可定义如下:</p><figure class="kc kd ke kf fd kg er es paragraph-image"><div class="er es ll"><img src="../Images/ee0b82ff3f125073a8256716dabf6b94.png" data-original-src="https://miro.medium.com/v2/resize:fit:1012/format:webp/1*KTd08qMLR8a9slc6-R3Akg.png"/></div><figcaption class="kn ko et er es kp kq bd b be z dx">Equation 1: Control Bounds for the XBar Control Chart</figcaption></figure><p id="ea74" class="pw-post-body-paragraph jc jd hh je b jf ks jh ji jj kt jl jm jn ku jp jq jr kv jt ju jv kw jx jy jz ha bi translated">其中xbar是每个时间点的均方误差的平均值，sbar是每个时间点的标准偏差的平均值，c4是偏差控制常数，n是每个时间点的样本大小(即每个时间点有多少个可用的观察值)，k决定了间隔的宽度。使用这些界限，我们可以监控不同时间点的均方误差。如果均方误差在这些界限之外，那么我们说该点失控。它可能表示均方误差分布的偏移。你的目标是开发这样的图表。</p><h1 id="53c3" class="ie if hh bd ig ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb bi translated">实现Xbar控制方案</h1><p id="dced" class="pw-post-body-paragraph jc jd hh je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ha bi translated">作为一名为医院工作的数据科学家，你开始着手开发这张控制图。一旦模型投入生产，您就可以收集关于其性能的数据。您创建了一个数据集，每天有20个随机样本交易，持续25天。您使用前25天来训练和学习控制图的参数，并在第25天后开始监控。在表1中，您可以看到收集的数据的结构。</p><figure class="kc kd ke kf fd kg er es paragraph-image"><div role="button" tabindex="0" class="kh ki di kj bf kk"><div class="er es lm"><img src="../Images/885e8413cabc0f370788213b0e7a1221.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jgK0TEeYo1PrGVTmRomq8w.png"/></div></div><figcaption class="kn ko et er es kp kq bd b be z dx">Table 1: Model Performance Dataset</figcaption></figure><h2 id="f80e" class="kx if hh bd ig ky kz la ik lb lc ld io jn le lf is jr lg lh iw jv li lj ja lk bi translated">数据处理</h2><p id="2b7e" class="pw-post-body-paragraph jc jd hh je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ha bi translated">在收集和清理数据之后，您开始建模。首先，让我们从导入重要且有帮助的python库开始。我们将使用pandas读取数据，使用NumPy进行数值计算，使用Matplotlib进行数据可视化。ControlCharts是我的Python模块，用于生成控制图。</p><pre class="kc kd ke kf fd ln lo lp lq aw lr bi"><span id="d133" class="kx if hh lo b fi ls lt l lu lv">import pandas as pd<br/>import numpy as np<br/>import matplotlib.pyplot as plt<br/>from ControlCharts import ShewhartControlModel</span></pre><p id="4e4d" class="pw-post-body-paragraph jc jd hh je b jf ks jh ji jj kt jl jm jn ku jp jq jr kv jt ju jv kw jx jy jz ha bi translated">导入重要的库之后，我们将继续读取和处理数据。我们将按天分组，然后计算每天采样的交易的平均值和标准差。每天总共对20笔交易进行了抽样。因此，我们说我们的样本量为20。</p><pre class="kc kd ke kf fd ln lo lp lq aw lr bi"><span id="8f3a" class="kx if hh lo b fi ls lt l lu lv"># Read data from csv<br/>data= pd.read_csv('Examples/transaction_data.csv')</span><span id="1339" class="kx if hh lo b fi lw lt l lu lv"># Group data by day and take the average of the Squared Error<br/>grouped_data= data[['Day', 'Squared Error']].groupby(by='Day').mean()<br/>grouped_data_std= data[['Day', 'Squared Error']].groupby(by='Day').std()</span><span id="00ee" class="kx if hh lo b fi lw lt l lu lv"># Train-Test Split<br/>x_train= grouped_data.iloc[:25, :].values.reshape((25,))<br/>x_test= grouped_data.iloc[25:, :].values.reshape((25,))</span></pre><h2 id="8ce1" class="kx if hh bd ig ky kz la ik lb lc ld io jn le lf is jr lg lh iw jv li lj ja lk bi translated">训练控制图模型</h2><p id="446e" class="pw-post-body-paragraph jc jd hh je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ha bi translated">一旦数据导入并准备就绪，我们将继续估计标准偏差并训练控制图模型。为此，我们将样本量定义为n=20(因为每天有20个样本)，然后查找与该样本量相关的偏差控制常数。</p><pre class="kc kd ke kf fd ln lo lp lq aw lr bi"><span id="4ca0" class="kx if hh lo b fi ls lt l lu lv"># Estimate standard deviation<br/>qcc= pd.read_csv('BiasControlConstants/quality_control_constants.csv')<br/>n= 20<br/>c4= qcc['c4'].loc[n-2]<br/>sigma_train=np.average(grouped_data_std.values[:25])/(np.sqrt(n)*c4)</span></pre><p id="3a02" class="pw-post-body-paragraph jc jd hh je b jf ks jh ji jj kt jl jm jn ku jp jq jr kv jt ju jv kw jx jy jz ha bi translated">一旦我们知道了标准偏差，我们就可以继续训练控制模型并获得控制界限。为此，我们将使用QualityTools。</p><pre class="kc kd ke kf fd ln lo lp lq aw lr bi"><span id="475c" class="kx if hh lo b fi ls lt l lu lv"># Build Shewhart Control Model<br/>spc_model= ShewhartControlModel(k=3)<br/>ucl, lcl= spc_model.fit(x_train, sigma= sigma_train)<br/>ooc= spc_model.predict(x_test)<br/>testing_plot=spc_model.plot(x=x_test, dpi= 100)</span><span id="199d" class="kx if hh lo b fi lw lt l lu lv"># Plot all data<br/>complete_plot= spc_model.plot(x=grouped_data.values, dpi= 100)<br/>train_plot= spc_model.plot(x=x_train, dpi= 100)</span></pre><h2 id="62fd" class="kx if hh bd ig ky kz la ik lb lc ld io jn le lf is jr lg lh iw jv li lj ja lk bi translated">结果</h2><p id="0580" class="pw-post-body-paragraph jc jd hh je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ha bi translated">第一步是检查模型性能是否受控。为此，我们观察图1，看到模型在训练期间处于控制状态。现在，我们可以开始用计算出的控制边界来监控我们的模型。</p><figure class="kc kd ke kf fd kg"><div class="bz dy l di"><div class="lx ly l"/></div><figcaption class="kn ko et er es kp kq bd b be z dx">Figure 1: Training XBar Control Chart Model</figcaption></figure><p id="29c3" class="pw-post-body-paragraph jc jd hh je b jf ks jh ji jj kt jl jm jn ku jp jq jr kv jt ju jv kw jx jy jz ha bi translated">在图2中，您在第25天之后开始跟踪模型。然后你意识到，似乎在第40天左右，模型的表现出现了一些变化。下一步是确定是什么导致了这种转变，并迅速确保它不会影响到您的客户。</p><figure class="kc kd ke kf fd kg"><div class="bz dy l di"><div class="lx ly l"/></div><figcaption class="kn ko et er es kp kq bd b be z dx">Figure 2: Training and Testing XBar Control Chart Model</figcaption></figure><h1 id="b745" class="ie if hh bd ig ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb bi translated">结论</h1><p id="b92d" class="pw-post-body-paragraph jc jd hh je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ha bi translated">这篇文章的目的是提出一个想法。我知道在机器学习中实现模型性能的控制图有很多挑战。然而，我认为如果充分研究，这种方法可以成为一个有价值的工具。例如，使用控制图来监控机器学习模型性能可以使工程师能够开发健壮的系统，该系统能够在模型性能发生变化时触发自动警报。然后，数据科学家可以迅速纠正问题，并将潜在影响降至最低。</p><p id="463f" class="pw-post-body-paragraph jc jd hh je b jf ks jh ji jj kt jl jm jn ku jp jq jr kv jt ju jv kw jx jy jz ha bi translated">值得注意的是，为了使这种方法有效，分析师应该了解如何设计和解释控制图。我没有详细阐述正确设计和解释控制图所必需的关于控制图的理论概念。如果有人计划在生产中使用控制图来监控模型，我建议在实施之前学习控制图的理论基础。</p><p id="8e36" class="pw-post-body-paragraph jc jd hh je b jf ks jh ji jj kt jl jm jn ku jp jq jr kv jt ju jv kw jx jy jz ha bi translated">旁注:</p><p id="a4a8" class="pw-post-body-paragraph jc jd hh je b jf ks jh ji jj kt jl jm jn ku jp jq jr kv jt ju jv kw jx jy jz ha bi translated">我用Python创建了一些基本控制图的模块化实现。有许多可用的实现，但是，您可以在本文中找到我的实现以及代码和模拟数据:<a class="ae kr" href="https://github.com/fernando-acosta/QualityTools" rel="noopener ugc nofollow" target="_blank">https://github.com/fernando-acosta/QualityTools</a></p><h1 id="ee94" class="ie if hh bd ig ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb bi translated"><strong class="ak">参考文献</strong></h1><ol class=""><li id="3d95" class="lz ma hh je b jf jg jj jk jn mb jr mc jv md jz me mf mg mh bi translated">奥拉德勒，S. (2022年8月11日)。<em class="ka">关于如何在生产中监控您的模型的全面指南</em>。Neptune . ai .<a class="ae kr" href="https://neptune.ai/blog/how-to-monitor-your-models-in-production-guide" rel="noopener ugc nofollow" target="_blank">https://Neptune . ai/blog/how-to-monitor-your-models-in-production-guide</a></li></ol><div class="mi mj ez fb mk ml"><a rel="noopener follow" target="_blank" href="/mlearning-ai/mlearning-ai-submission-suggestions-b51e2b130bfb"><div class="mm ab dw"><div class="mn ab mo cl cj mp"><h2 class="bd hi fi z dy mq ea eb mr ed ef hg bi translated">Mlearning.ai提交建议</h2><div class="ms l"><h3 class="bd b fi z dy mq ea eb mr ed ef dx translated">如何成为Mlearning.ai上的作家</h3></div><div class="mt l"><p class="bd b fp z dy mq ea eb mr ed ef dx translated">medium.com</p></div></div><div class="mu l"><div class="mv l mw mx my mu mz kl ml"/></div></div></a></div></div></div>    
</body>
</html>