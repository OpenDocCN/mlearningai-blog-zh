<html>
<head>
<title>Functional Programming in R: A Weapon Instantly Buffing Your Coding Power</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">R语言中的函数式编程:一种立即增强您编码能力的武器</h1>
<blockquote>原文：<a href="https://medium.com/mlearning-ai/two-weapons-to-instantly-buff-your-r-coding-power-part-2-de8e95b92dc2?source=collection_archive---------4-----------------------#2021-05-02">https://medium.com/mlearning-ai/two-weapons-to-instantly-buff-your-r-coding-power-part-2-de8e95b92dc2?source=collection_archive---------4-----------------------#2021-05-02</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><figure class="ev ex if ig ih ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es ie"><img src="../Images/c6d76558cbc93abb2e3d2c5a23c35efa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*sUvZ9lobdtGT4p7Te_GJeQ.jpeg"/></div></div></figure><p id="d9f6" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">我已经在第一部分中介绍了管道操作。我将介绍R编程中的另一个强大武器:函数。这个想法是，任何你期望做多次的事情，你都应该考虑使用函数，例如，运行多重回归，或者绘制一系列相似的图。通过将管道操作嵌入到函数中，您可以充分利用R编程的优势。</p><p id="6c1b" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">让我们从一个简单的例子开始。假设你的孩子给你布置了一个小的算术作业，要你找出一个给定的数字，比如4和100之间所有整数的平方和。你不需要一个函数来得到答案:</p><pre class="jo jp jq jr fd js jt ju jv aw jw bi"><span id="7853" class="jx jy hh jt b fi jz ka l kb kc">x=4<br/>value=seq(from=x,to=100,by=1)<br/>sum(value^2)</span></pre><p id="611a" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">但是如果你孩子的老师要求5到20的计算结果呢？或者任何小于100的整数？你当然可以重复上述代码16次或更多。但是R函数提供了一种更简单的方法。</p><p id="f7c6" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">我们现在正式将这个小任务指定给一个函数。我们将从例子中解释写一个R函数需要什么。</p><pre class="jo jp jq jr fd js jt ju jv aw jw bi"><span id="2130" class="jx jy hh jt b fi jz ka l kb kc">myfunc1=function(x){<br/>value=seq(x,to=100,by=2) <br/>y=sum(value^2) <br/>return(y)  <br/>}</span></pre><p id="f4d0" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">要创建一个函数，你需要指定一个函数名(<em class="kd"> myfunc1 </em>此处)，圆括号中的参数，一个名为x的值。你可以随便叫它什么，但要确保这个名字出现在正在工作的函数中。在两个大括号({})之间，您编写希望函数根据您的输入执行的代码。在上面的例子中，x用于生成一个整数序列。你不用标点符号来分隔不同的代码行；使用软回报或硬回报。当您准备好函数时，通过将光标移动到结束大括号(})的最末端，并单击“run”或按“Ctrl”+“Enter”，将它加载到R中。您的函数现在可以被调用使用了。</p><p id="9b48" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">函数<em class="kd"> myfunc1 </em>现在已经创建并加载。要使用myfunc1 来做这项工作，您需要向它提供参数:myfunc1(5)，myfunc1(6)，一直到myfunc1(20)。这也不是一个好方法，因为:1)我们仍然在重复输入一些东西，2)结果没有放在一起。</p><p id="9f85" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">下面的代码是正确的方法。下面我来解释一下。</p><pre class="jo jp jq jr fd js jt ju jv aw jw bi"><span id="89e9" class="jx jy hh jt b fi jz ka l kb kc">v1=5:20<br/>v2=sapply(v1,function(x)myfunc1(x))</span></pre><p id="de0c" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated"><em class="kd"> sapply </em>允许自定义R函数<em class="kd"> myfunc1 </em>应用于向量v1的每个元素，向量v1的序列从5到20。结果存储在一个名为v2的新向量中。您可以使用<em class="kd"> cbind </em> (v1，v2)创建一个矩阵，该矩阵可以使用<em class="kd"> as.data.frame </em>进一步转换为dataframe:</p><pre class="jo jp jq jr fd js jt ju jv aw jw bi"><span id="2066" class="jx jy hh jt b fi jz ka l kb kc">as.data.frame(cbind(v1,v2)</span></pre><p id="748c" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">上面的例子说明了R函数的基本语法和用法。接下来，我们进一步探讨r语言中的函数式编程。</p><ol class=""><li id="31af" class="ke kf hh ir b is it iw ix ja kg je kh ji ki jm kj kk kl km bi translated"><em class="kd">添加警告信息</em></li></ol><p id="38a4" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">现在假设您希望<em class="kd"> myfunc1 </em>发送一条警告消息:如果x不是整数，或者大于100，则停止函数中剩余代码的执行。我们在函数中添加了一个停止句。这条警告消息类似于您遇到的错误执行内置R函数的消息。</p><pre class="jo jp jq jr fd js jt ju jv aw jw bi"><span id="eeaf" class="jx jy hh jt b fi jz ka l kb kc">myfunc2=function(x){<br/>if(round(x)!=x|x&gt;=100) stop('your entered value is not correct!')<br/>value=seq(from=x,to=100,by=1)<br/>sum(value^2) <br/>}</span></pre><p id="1190" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated"><em class="kd"> 2。多种功能输出。</em></p><p id="83d1" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">有时我们期望函数给出多个输出。例如，除了平方和之外，您还想生成平均值和标准差。我们可以添加一个return命令并创建一个多输出列表，而不是有多个函数，一个用于sum，一个用于mean，一个用于sd。</p><pre class="jo jp jq jr fd js jt ju jv aw jw bi"><span id="6d00" class="jx jy hh jt b fi jz ka l kb kc">myfunc3=function(x){<br/>if(round(x)!=x|x&gt;=100) stop('your entered value is not correct')<br/>value=seq(from=x,to=100,by=1)<br/>output1=mean(value^2)<br/>output2=sd(value^2)<br/>output3=sum(value^2)<br/>return(list(output1,output2,output3))<br/>}</span></pre><p id="8a07" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">为了将myfunc3应用于vector v1，并将结果很好地存储在dataframe中，我们使用下面的代码。</p><pre class="jo jp jq jr fd js jt ju jv aw jw bi"><span id="81a5" class="jx jy hh jt b fi jz ka l kb kc">v1 %&gt;% sapply(function(x)myfunc3(x)) %&gt;% t() %&gt;% as.data.frame() %&gt;% setNames(c("mean","sd","sum"))</span></pre><p id="319a" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated"><em class="kd"> t() </em>用于成功转置<em class="kd">的输出</em>，因此结果按列给出。<em class="kd">设置名称</em>用于改变管道操作中的名称。你可以按照我在<a class="ae jn" href="https://martinqiu.medium.com/two-weapons-to-instantly-buff-your-r-coding-power-part-1-79446ddb8cd0" rel="noopener">第1部分</a>中的描述一个管道一个管道地执行代码来查看数据流。结果如下所示。</p><figure class="jo jp jq jr fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es kn"><img src="../Images/17f1b057fecf8d0a2fe56c969c250154.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mV3qL7ajGPo9kJLiLMGBLw.png"/></div></div></figure><p id="f669" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated"><em class="kd"> 3。运行回归的功能</em></p><p id="dacf" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">r函数可以使用对象而不是值(如上例)作为输入。假设我想对不同的数据集进行回归以获得最佳拟合。实际上，这叫做数据挖掘，不推荐使用。但是为了便于说明，我们使用了钻石数据。我们希望对多个数据集的钻石要素运行钻石价格回归模型。</p><pre class="jo jp jq jr fd js jt ju jv aw jw bi"><span id="d2c9" class="jx jy hh jt b fi jz ka l kb kc">reg.func=function(df){<br/>  reg=lm(price~carat+cut+clarity+color,data=df)<br/>  sum=summary(reg)<br/>  result= unlist(sum$coefficients[,c(1,3,4)]) %&gt;% as.data.frame() %&gt;% round(3)%&gt;% setNames(c("Coefficient","t stats","p-value"))<br/>  return(result)<br/>}</span></pre><p id="9bf5" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">我写了函数<em class="kd"> reg.func </em>。它使用dataframe作为输入，并返回另一个dataframe作为输出。我随机取样500颗钻石，并应用<em class="kd"> reg.func </em>。可以查查结果。</p><pre class="jo jp jq jr fd js jt ju jv aw jw bi"><span id="fa53" class="jx jy hh jt b fi jz ka l kb kc">set.seed(450)<br/>dfx=sample_n(diamonds, 500)<br/>reg.func(dfx)</span></pre><p id="05c0" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">其他对象，如公式、变量名也可以作为函数输入。假设我们要对价格和一个分类变量(切割、颜色或净度)进行回归，以比较不同特征维度对价格的影响。重复的工作需要函数编程。(以下代码是学习中的一点跳跃。)</p><pre class="jo jp jq jr fd js jt ju jv aw jw bi"><span id="652d" class="jx jy hh jt b fi jz ka l kb kc">reg.func2=function(x,df){<br/>  lm.formula=as.formula(paste0("price~",x))<br/>  reg=lm(lm.formula,data=df)<br/>  sum=summary(reg)<br/> result=unlist(sum$coefficients[,c(1,3,4)]) %&gt;% as.data.frame() %&gt;% round(3)%&gt;% setNames(c("Coeffcient","t stats","p-value"))<br/>  return(result)<br/>}</span><span id="71af" class="jx jy hh jt b fi ko ka l kb kc">reg.func2("cut", dfx)#"cut" is quoted.</span></pre><p id="300e" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">在上面的代码中，您会注意到我们为一个函数使用了两个参数(x，我们在回归中使用的特性，以及df，回归将在其上运行的数据帧)。您还注意到，我需要为线性回归指定<em class="kd"> lm.formula </em>，这是通过<em class="kd">将</em>和<em class="kd">粘贴为. formula </em>使用函数参数x之一创建的。其余都一样。输出如下。</p><figure class="jo jp jq jr fd ii er es paragraph-image"><div class="er es kp"><img src="../Images/f6ad822800f398c43f23dafe456c1500.png" data-original-src="https://miro.medium.com/v2/resize:fit:1296/format:webp/1*hstS1gNkAye9uSEVeChXLg.png"/></div></figure><p id="1b2e" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">如果有人说她不想在函数中使用字符串类型的输入；她更喜欢不带引号的论点。我们只是添加一行<em class="kd"> deparse(substitute(x)) </em>来从输入中提取字符串值。</p><pre class="jo jp jq jr fd js jt ju jv aw jw bi"><span id="6f85" class="jx jy hh jt b fi jz ka l kb kc">reg.func3=function(x,df){<br/>  x_name &lt;- deparse(substitute(x))<br/>  formula=as.formula(paste0("price~",x_name))<br/>  reg=lm(formula,data=df)<br/>  sum=summary(reg)<br/>  result=unlist(sum$coefficients[,c(1,3,4)]) %&gt;% as.data.frame() %&gt;% round(3)%&gt;% setNames(c("Coefficient","t stats","p-value"))<br/>  return(result)<br/>}<br/>reg.func3(color,dfx)#color has no quotation marks</span></pre><p id="015f" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">在这个新函数中，我们使用颜色作为x的输入，以使输出多样化。</p><p id="cc55" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">函数参数的字符串值对于定制绘图元素(如title)非常有用，这就引出了本文的最后一个例子。</p><p id="d07e" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated"><em class="kd"> 4。创建图的功能</em></p><p id="e6e0" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">假设我们想选择一个分类特征/变量，按其级别分组，并计算每组中有多少菱形。然后，我们使用一个条形图来说明计数，标题为“不同xxx组的钻石计数”，其中xxx是我们选择的特征。我们希望为切割、颜色和透明度这三个分类特征分别创建三个图，并将它们保存到本地驱动器。</p><pre class="jo jp jq jr fd js jt ju jv aw jw bi"><span id="34ae" class="jx jy hh jt b fi jz ka l kb kc">library(ggplot2)<br/>plot.func=function(x){<br/> x_name &lt;- deparse(substitute(x))<br/>plot= diamonds %&gt;% group_by({{x}}) %&gt;% summarize(count=n()) %&gt;% ggplot()+ geom_col(aes(x={{x}},y=count,fill={{x}}))+  <br/>  labs(title=paste("Diamond Counts by Different Groups of" ,toupper(x_name)),x=x_name,y="count")<br/>return(plot)<br/>}</span></pre><p id="1e6d" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">我们首先使用上面的函数<em class="kd"> plot.func </em>来完成绘图工作。注意，x_name是从函数参数x中剥离的字符串，并输入ggplot2的<em class="kd">标题</em>和x实验室参数。若要在数据帧的管道操作中引用函数参数，请使用{{x}}。</p><p id="6f21" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">这里我还提供了函数参数是带引号的字符串的版本。以及保存到文件代码。</p><pre class="jo jp jq jr fd js jt ju jv aw jw bi"><span id="c2c6" class="jx jy hh jt b fi jz ka l kb kc">plot.func1=function(x){<br/> plot= diamonds %&gt;% group_by(!!sym(x)) %&gt;% summarize(count=n()) %&gt;% ggplot()+ geom_col(aes(x=reorder(!!sym(x),-count),y=count,fill=!!sym(x)))+  <br/>  labs(title=paste("Diamond Counts by Different Groups of" ,toupper(x)),x=x,y="count")<br/>ggsave(paste0("F:/count.plot_",x,".jpg"),plot,width = 8, height = 6, units = "in")<br/>}</span></pre><p id="061c" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">在这个版本的函数中，x是一个字符串，所以它可以直接输入到绘图标题和标签中。此外，它还在<em class="kd"> ggsave </em>参数中输入文件名。但是，要引用它所代表的变量的名字，我们需要使用<em class="kd">！！sym(x) </em>。这是本文中最棘手的部分。它为在R函数中生成动态变量名打开了大门，这超出了本文的范围。</p><p id="f6f5" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">最后一步是创建一个菱形特征的向量，并用我们刚刚编写的函数应用它。</p><pre class="jo jp jq jr fd js jt ju jv aw jw bi"><span id="aafe" class="jx jy hh jt b fi jz ka l kb kc">feature=c("cut","clarity","color")<br/>sapply(feature,plot.func1)</span></pre><p id="6808" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">你会看到这三块地静静地躺在你的F盘里。</p><p id="b051" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated"><em class="kd">专门介绍贸易工具的系列文章。我希望这篇文章对你有用。当你掌握了管道操作和函数式编程，写R代码就会变成你喜欢和怀念的东西。</em></p></div></div>    
</body>
</html>