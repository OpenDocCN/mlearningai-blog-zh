<html>
<head>
<title>Distributed batch inference with Hugging Face on Amazon Sagemaker</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Amazon Sagemakerä¸Šå¸¦æ‹¥æŠ±è„¸çš„åˆ†å¸ƒå¼æ‰¹é‡æ¨ç†</h1>
<blockquote>åŸæ–‡ï¼š<a href="https://medium.com/mlearning-ai/distributed-batch-inference-with-hugging-face-on-amazon-sagemaker-51980e460ec1?source=collection_archive---------3-----------------------#2022-11-15">https://medium.com/mlearning-ai/distributed-batch-inference-with-hugging-face-on-amazon-sagemaker-51980e460ec1?source=collection_archive---------3-----------------------#2022-11-15</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><div class=""><h2 id="588b" class="pw-subtitle-paragraph ie hg hh bd b if ig ih ii ij ik il im in io ip iq ir is it iu iv dx translated">ä½¿ç”¨SageMakerå¤„ç†ä½œä¸šï¼Œé€šè¿‡Hugging Faceçš„Transformeræ¨¡å‹è½»æ¾åœ°å¯¹å¤§å‹æ•°æ®é›†è¿›è¡Œæ¨ç†</h2></div><figure class="ix iy iz ja fd jb er es paragraph-image"><div role="button" tabindex="0" class="jc jd di je bf jf"><div class="er es iw"><img src="../Images/a3d9e4ad016ba857d8f32f70e2ec7515.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*XLcyF1qxUgLigTur"/></div></div><figcaption class="ji jj et er es jk jl bd b be z dx">Photo by <a class="ae jm" href="https://unsplash.com/@burntime?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Alex Kulikov</a> on <a class="ae jm" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="ba18" class="pw-post-body-paragraph jn jo hh jp b jq jr ii js jt ju il jv jw jx jy jz ka kb kc kd ke kf kg kh ki ha bi translated">è¿™ç¯‡åšå®¢å°†å‘æ‚¨å®Œæ•´åœ°ä»‹ç»å¦‚ä½•å¯¹ç”Ÿäº§ä¸­çš„å¤§é‡æ•°æ®è¿è¡Œåˆ†å¸ƒå¼æ‰¹é‡æ¨ç†ã€‚æˆ‘ä»¬å°†ä½¿ç”¨äºšé©¬é€ŠSagemakerï¼Œä¸€ç§å®Œå…¨æ‰˜ç®¡çš„æœºå™¨å­¦ä¹ æœåŠ¡ã€‚å€ŸåŠ©Amazon SageMakerï¼Œæ•°æ®ç§‘å­¦å®¶å’Œå¼€å‘äººå‘˜å¯ä»¥å¿«é€Ÿæ„å»ºå’Œè®­ç»ƒæœºå™¨å­¦ä¹ æ¨¡å‹ï¼Œç„¶åå°†å…¶éƒ¨ç½²åˆ°ç”Ÿäº§å°±ç»ªçš„æ‰˜ç®¡ç¯å¢ƒä¸­ã€‚</p><p id="e681" class="pw-post-body-paragraph jn jo hh jp b jq jr ii js jt ju il jv jw jx jy jz ka kb kc kd ke kf kg kh ki ha bi translated">å‡è®¾æˆ‘ä»¬æœ‰æ•°Pbçš„æ•°æ®ï¼Œæˆ‘ä»¬æƒ³ä½¿ç”¨ä¸€ä¸ªé¢„è®­ç»ƒçš„æ¨¡å‹è¿›è¡Œæ‰¹é‡æ¨ç†ã€‚Sagemakerå¤„ç†ä½œä¸šæ˜¯æœ€ç®€å•çš„æ–¹æ³•ä¹‹ä¸€ï¼Œå› ä¸ºå®ƒä¸“æ³¨äºæŠ½è±¡å‡ºæ‰€éœ€çš„åŸºç¡€è®¾æ–½ã€‚å®ƒè¿˜è¦æ±‚å¯¹æˆ‘ä»¬ç°æœ‰çš„ä»£ç è¿›è¡Œæœ€å°çš„æ›´æ”¹ã€‚åœ¨æœ¬æ•™ç¨‹ä¸­ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨æ¥è‡ªHuggin Faceçš„é¢„è®­ç»ƒæ¨¡å‹æ¥è®¡ç®—ä¸€å¯¹å¥å­ä¹‹é—´çš„è¯­ä¹‰ç›¸ä¼¼åº¦ã€‚</p><p id="8b3d" class="pw-post-body-paragraph jn jo hh jp b jq jr ii js jt ju il jv jw jx jy jz ka kb kc kd ke kf kg kh ki ha bi translated"><strong class="jp hi">è¿™ç¯‡åšæ–‡å°†æ¶µç›–ä»¥ä¸‹ä¸»é¢˜:</strong></p><ul class=""><li id="46df" class="kj kk hh jp b jq jr jt ju jw kl ka km ke kn ki ko kp kq kr bi translated">ä¿®æ”¹SageMakerå¤„ç†ä½œä¸šçš„ä»£ç </li><li id="bab3" class="kj kk hh jp b jq ks jt kt jw ku ka kv ke kw ki ko kp kq kr bi translated">ç”¨ä»£ç å’Œä¾èµ–é¡¹æ„å»ºdockerå®¹å™¨ï¼Œå¹¶å°†å…¶æ¨é€åˆ°Amazonå¼¹æ€§å®¹å™¨æ³¨å†Œ(Amazon ECR)å­˜å‚¨åº“</li><li id="e526" class="kj kk hh jp b jq ks jt kt jw ku ka kv ke kw ki ko kp kq kr bi translated">ä½¿ç”¨è‡ªå®šä¹‰dockerå›¾åƒå¯åŠ¨å¤„ç†ä½œä¸š</li></ul></div><div class="ab cl kx ky go kz" role="separator"><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc"/></div><div class="ha hb hc hd he"><h1 id="e996" class="le lf hh bd lg lh li lj lk ll lm ln lo in lp io lq iq lr ir ls it lt iu lu lv bi translated">ä¿®æ”¹ä»£ç </h1><p id="4968" class="pw-post-body-paragraph jn jo hh jp b jq lw ii js jt lx il jv jw ly jy jz ka lz kc kd ke ma kg kh ki ha bi translated">åˆ›å»ºå¤„ç†ä½œä¸šéœ€è¦æŒ‡å®šä¸€ä¸ªäºšé©¬é€Šç®€å•å­˜å‚¨æœåŠ¡(äºšé©¬é€ŠS3) URIæ¥ä¸‹è½½æ•°æ®ï¼Œå¹¶åœ¨dockerå®¹å™¨ä¸­æŒ‡å®šä¸€ä¸ªè·¯å¾„æ¥ä¸‹è½½æ•°æ®ã€‚å¤„ç†å®¹å™¨ä¸­çš„è·¯å¾„å¿…é¡»ä»¥<code class="du mb mc md me b">/opt/ml/processing/</code>å¼€å¤´ã€‚ç¨åå°†å¯¹æ­¤è¿›è¡Œæ›´å¤šè®¨è®ºã€‚</p><blockquote class="mf mg mh"><p id="4b28" class="jn jo mi jp b jq jr ii js jt ju il jv mj jx jy jz mk kb kc kd ml kf kg kh ki ha bi translated">æ³¨æ„:<code class="du mb mc md me b">/opt/ml</code>åŠå…¶æ‰€æœ‰å­ç›®å½•ç”±SageMakerä¿ç•™ã€‚åœ¨æ„å»ºå¤„ç†Dockeræ˜ åƒæ—¶ï¼Œä¸è¦å°†å®¹å™¨æ‰€éœ€çš„ä»»ä½•æ•°æ®æ”¾åœ¨è¿™äº›ç›®å½•ä¸­ã€‚</p></blockquote><p id="bc3c" class="pw-post-body-paragraph jn jo hh jp b jq jr ii js jt ju il jv jw jx jy jz ka kb kc kd ke kf kg kh ki ha bi translated">æˆ‘ä»¬éœ€è¦ä¿®æ”¹æˆ‘ä»¬çš„è„šæœ¬ä»è¿™ä¸ªè·¯å¾„è¯»å–æ•°æ®<code class="du mb mc md me b">/opt/ml/processing/</code></p><p id="aa6b" class="pw-post-body-paragraph jn jo hh jp b jq jr ii js jt ju il jv jw jx jy jz ka kb kc kd ke kf kg kh ki ha bi translated">åœ¨æœ¬ä¾‹ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨æ¥è‡ªä¸Šæ¸¸æ•°æ®ç®¡é“çš„æ•°æ®ï¼Œè¯¥ç®¡é“å°†æ•°æ®åˆ†æˆå¤šä¸ªæ‹¼èŠ±æ–‡ä»¶ï¼Œå¹¶å°†å®ƒä»¬å­˜å‚¨åœ¨S3å­˜å‚¨æ¡¶ä¸­ã€‚å¦‚æœæ‰€é€‰å®ä¾‹ä¸Šæœ‰å¤šä¸ªGPUï¼Œæˆ‘ä»¬å°†ä½¿ç”¨æ¯ä¸ªGPUå¹¶è¡Œæ¨æ–­æ¯ä¸ªæ–‡ä»¶ã€‚è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨äº†ä¸€ä¸ªæ¥è‡ªæ‹¥æŠ±è„¸çš„é¢„è®­ç»ƒå¥å­è½¬æ¢å™¨(æ›´å¤šä¿¡æ¯<a class="ae jm" href="https://huggingface.co/sentence-transformers/distiluse-base-multilingual-cased-v2" rel="noopener ugc nofollow" target="_blank">è¿™é‡Œ</a>)ï¼Œä½†æ˜¯æˆ‘ä»¬å¯ä»¥é€šè¿‡ç®€å•åœ°ä¿®æ”¹ä¸‹é¢çš„è„šæœ¬æ¥ä½¿ç”¨ä»»ä½•æ¨¡å‹ã€‚</p><p id="01d6" class="pw-post-body-paragraph jn jo hh jp b jq jr ii js jt ju il jv jw jx jy jz ka kb kc kd ke kf kg kh ki ha bi translated">ç¤ºä¾‹è„šæœ¬ä»è¾“å…¥ç›®å½•ä¸­è¯»å–æ–‡ä»¶ï¼Œä»å¥å­åµŒå…¥ä¸­æ·»åŠ ä¸€ä¸ªå…·æœ‰ä½™å¼¦ç›¸ä¼¼æ€§çš„æ–°åˆ—ï¼Œå¹¶å°†å…¶ä¿å­˜åœ¨è¾“å‡ºç›®å½•ä¸­ã€‚å¦‚ä¸‹æ‰€ç¤ºï¼Œå¯ä»¥ä»å¤„ç†ä½œä¸šä¸­è¦†ç›–è¿™äº›å‚æ•°ã€‚</p><pre class="ix iy iz ja fd mm me mn bn mo mp bi"><span id="0711" class="mq lf hh me b be mr ms l mt mu">import os<br/>import argparse<br/>import logging<br/>import numpy as np<br/>import pandas as pd<br/>from numpy.linalg import norm<br/>import torch.multiprocessing as mp<br/>from sentence_transformers import SentenceTransformer<br/><br/># set up logger<br/>logging.basicConfig(format="%(asctime)s:%(levelname)s:%(name)s:%(message)s")<br/>logger = logging.getLogger("HuggingFace")<br/>logger.propagate = True<br/>logger.setLevel(logging.INFO)<br/><br/><br/>def get_model_output(cfg, model, df, device_idx):<br/><br/>    # sanity check<br/>    text1 = df["text1"].values<br/>    text2 = df["text2"].values<br/><br/>    # Create the trainer for inference.<br/>    logger.info("Predicting model")<br/>    # Compute embedding for both lists<br/>    embeddings1 = model.encode(<br/>        text1,<br/>        batch_size=cfg.batch_size,<br/>        convert_to_numpy=True,<br/>        device=device_idx,<br/>    )<br/>    embeddings2 = model.encode(<br/>        text2,<br/>        batch_size=cfg.batch_size,<br/>        convert_to_numpy=True,<br/>        device=device_idx,<br/>    )<br/>    df["semanticScore"] = np.hstack(<br/>        [<br/>            (emb1 @ emb2.T) / (norm(emb1) * norm(emb2))<br/>            for emb1, emb2 in zip(embeddings1, embeddings2)<br/>        ]<br/>    )<br/>    return df<br/><br/><br/>def do_infer(cfg, device_idx):<br/><br/>    # Load the model.<br/>    logger.info("Loading model")<br/>    model = SentenceTransformer(cfg.model, device=device_idx)<br/><br/>    # Init file path that this process needs to process.<br/>    if os.path.isdir(cfg.input_dir):<br/>        filepath_list = [<br/>            filepath<br/>            for filepath in os.listdir(cfg.input_dir)<br/>            if filepath.endswith(".parquet")<br/>        ]<br/>        filepath_list = sorted(filepath_list)<br/>        filepath_list = [<br/>            filepath_list[idx]<br/>            for idx in range(len(filepath_list))<br/>            if idx % cfg.num_gpu == device_idx<br/>        ]<br/>    else:<br/>        filepath_list = (<br/>            [cfg.input_dir] if device_idx == 0 else []<br/>        )  # only use the first GPU.<br/><br/>    # Get the input and output filepath.<br/>    input_list = [os.path.join(cfg.input_dir, filepath) for filepath in filepath_list]<br/>    output_list = [os.path.join(cfg.output_dir, filepath) for filepath in filepath_list]<br/>    logger.info(f"Device {device_idx} input: {input_list}")<br/>    logger.info(f"Device {device_idx} output: {output_list}")<br/><br/>    # Start processing.<br/>    for in_filename, out_filename in zip(input_list, output_list):<br/>        # Read the dataset.<br/>        logger.info("Reading file {}".format(in_filename))<br/>        prod_df = pd.read_parquet(in_filename)<br/><br/>        # Run the inference.<br/>        output_df = get_model_output(cfg, model, prod_df, device_idx)<br/><br/>        # Save the results<br/>        logger.info(f"Writing the result to {out_filename}")<br/>        output_df.to_parquet(out_filename)<br/>        logger.info(f"Done writing the result to {out_filename}")<br/><br/><br/>def do_multiprocessing_infer(cfg):<br/><br/>    processes_list = [<br/>        mp.Process(target=do_infer, args=(cfg, device_idx))<br/>        for device_idx in range(cfg.num_gpu)<br/>    ]<br/><br/>    for process in processes_list:<br/>        process.start()<br/><br/>    for process in processes_list:<br/>        process.join()<br/><br/><br/>if __name__ == "__main__":<br/>    parser = argparse.ArgumentParser()<br/>    parser.add_argument("--num_gpu", type=int, default=4)<br/>    parser.add_argument("--batch_size", type=int, default=128)<br/>    parser.add_argument(<br/>        "--input_dir", type=str, default="/opt/ml/processing/data/input"<br/>    )<br/>    parser.add_argument(<br/>        "--output_dir", type=str, default="/opt/ml/processing/data/output"<br/>    )<br/>    parser.add_argument(<br/>        "--model",<br/>        type=str,<br/>        default="sentence-transformers/distiluse-base-multilingual-cased-v2",<br/>    )<br/>    args = parser.parse_args()<br/>    do_multiprocessing_infer(args)</span></pre><h1 id="eb38" class="le lf hh bd lg lh mv lj lk ll mw ln lo in mx io lq iq my ir ls it mz iu lu lv bi translated">æ„å»ºdockeræ˜ åƒå¹¶å°†å…¶æ¨é€åˆ°Amazon ECR</h1><p id="40d3" class="pw-post-body-paragraph jn jo hh jp b jq lw ii js jt lx il jv jw ly jy jz ka lz kc kd ke ma kg kh ki ha bi translated">ä¸€æ—¦æˆ‘ä»¬å®Œæˆäº†ä»£ç ï¼Œæˆ‘ä»¬éœ€è¦æ„å»ºä¸€ä¸ªdockerå®¹å™¨ã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªDOCKERæ–‡ä»¶ç¤ºä¾‹ã€‚åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬æ‰€æœ‰çš„ä»£ç éƒ½åœ¨srcç›®å½•ä¸­</p><pre class="ix iy iz ja fd mm me mn bn mo mp bi"><span id="e522" class="mq lf hh me b be mr ms l mt mu"><br/>FROM python:3.8<br/><br/>RUN apt-get -y update &amp;&amp; apt-get install -y --no-install-recommends \<br/>         wget \<br/>         python3 \<br/>    &amp;&amp; rm -rf /var/lib/apt/lists/*<br/><br/>RUN wget https://bootstrap.pypa.io/get-pip.py &amp;&amp; python3 get-pip.py &amp;&amp; \<br/>        rm -rf /root/.cache<br/><br/>COPY requirements.txt /opt/program/<br/>COPY src/ /opt/program/src/<br/>WORKDIR /opt/program<br/><br/>RUN pip install -r requirements.txt<br/><br/><br/># Set some environment variables. PYTHONUNBUFFERED keeps Python from buffering our standard<br/># output stream, which means that logs can be delivered to the user quickly. PYTHONDONTWRITEBYTECODE<br/># keeps Python from writing the .pyc files which are unnecessary in this case. We also update<br/># PATH so that the train and serve programs are found when the container is invoked.<br/>ENV PYTHONUNBUFFERED=TRUE<br/>ENV PYTHONDONTWRITEBYTECODE=TRUE</span></pre><p id="2e6a" class="pw-post-body-paragraph jn jo hh jp b jq jr ii js jt ju il jv jw jx jy jz ka kb kc kd ke kf kg kh ki ha bi translated">ä¸€æ—¦æˆ‘ä»¬æœ‰äº†DOCKERæ–‡ä»¶ï¼Œæˆ‘ä»¬éœ€è¦æ„å»ºå®ƒæ¥åˆ›å»ºä¸€ä¸ªå›¾åƒï¼Œå¹¶åœ¨å°†å®ƒæ¨é€åˆ°Amazon ECRä¹‹å‰æ ‡è®°è¯¥å›¾åƒã€‚ECRæ˜¯ä¸€ä¸ªç±»ä¼¼Docker Hubçš„å®¹å™¨æ³¨å†Œä¸­å¿ƒï¼Œæˆ‘ä»¬å¯ä»¥åœ¨è¿™é‡Œæ‰˜ç®¡å®¹å™¨æ˜ åƒã€‚</p><p id="1c78" class="pw-post-body-paragraph jn jo hh jp b jq jr ii js jt ju il jv jw jx jy jz ka kb kc kd ke kf kg kh ki ha bi translated">ç¤ºä¾‹bashè„šæœ¬å°†å¤„ç†æ‰€æœ‰ä¸AWSç›¸å…³çš„è®¤è¯ï¼Œåˆ›å»ºä¸€ä¸ªåä¸º<strong class="jp hi"> <em class="mi"> sm-semantic-similarityã€</em> </strong>çš„å­˜å‚¨åº“ï¼Œå¹¶å¯¹å…¶è¿›è¡Œæ ‡è®°ï¼Œæœ€åå°†å…¶æ¨é€åˆ°Amazon ECRå­˜å‚¨åº“ã€‚æˆ‘ä»¬å°†å¾—åˆ°ä¸€ä¸ªç‹¬ç‰¹çš„é“¾æ¥ï¼Œå¦‚"&lt;<strong class="jp hi">ACCOUNT-ID&gt;. dkr . ECR . us-east-1 . Amazon AWS . com/sm-lexical-similarity:v1</strong>"</p><pre class="ix iy iz ja fd mm me mn bn mo mp bi"><span id="5ce9" class="mq lf hh me b be mr ms l mt mu"># Name of algo -&gt; ECR<br/>algorithm_name=sm-semantic-similarity<br/><br/>account=$(aws sts get-caller-identity --query Account --output text)<br/><br/># Region, defaults to us-east-1<br/>region=$(aws configure get region)<br/>region=${region:-us-east-1}<br/><br/>fullname="${account}.dkr.ecr.${region}.amazonaws.com/${algorithm_name}:v1"<br/><br/># If the repository doesn't exist in ECR, create it.<br/>aws ecr describe-repositories --repository-names "${algorithm_name}" --region ${region}&gt; /dev/null 2&gt;&amp;1<br/><br/>if [ $? -ne 0 ]<br/>then<br/>    aws ecr create-repository --repository-name "${algorithm_name}" --region ${region}&gt; /dev/null<br/>fi<br/><br/># Get the login command from ECR and execute it directly<br/>aws ecr get-login-password --region ${region}|docker login --username AWS --password-stdin ${fullname}<br/><br/># Build the docker image locally with the image name and then push it to ECR<br/># with the full name.<br/><br/>docker build -t ${algorithm_name} .<br/>docker tag ${algorithm_name} ${fullname}<br/>docker push ${fullname}</span></pre><h1 id="3d9d" class="le lf hh bd lg lh mv lj lk ll mw ln lo in mx io lq iq my ir ls it mz iu lu lv bi translated">ä½¿ç”¨è‡ªå®šä¹‰å®¹å™¨è¿è¡ŒSageMakerå¤„ç†ä½œä¸š</h1><p id="6794" class="pw-post-body-paragraph jn jo hh jp b jq lw ii js jt lx il jv jw ly jy jz ka lz kc kd ke ma kg kh ki ha bi translated">Amazon SageMakerä»S3å¤åˆ¶æ•°æ®ï¼Œç„¶åæå–å®¹å™¨ã€‚ç¾¤é›†èµ„æºåœ¨ä½œä¸šæœŸé—´è°ƒé…ï¼Œå¹¶åœ¨ä½œä¸šå®Œæˆæ—¶æ¸…ç†ã€‚å¤„ç†ä½œä¸šçš„è¾“å‡ºå­˜å‚¨åœ¨å‚æ•°ä¸­æŒ‡å®šçš„S3å­˜å‚¨æ¡¶ä¸­ã€‚</p><figure class="ix iy iz ja fd jb er es paragraph-image"><div role="button" tabindex="0" class="jc jd di je bf jf"><div class="er es na"><img src="../Images/13906fd9a72770b1f79e092c128dc113.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XHwBSYtk4p4WzSgTsEtsfQ.png"/></div></div></figure><p id="ba91" class="pw-post-body-paragraph jn jo hh jp b jq jr ii js jt ju il jv jw jx jy jz ka kb kc kd ke kf kg kh ki ha bi translated"><code class="du mb mc md me b">Processor</code>ç±»éœ€è¦ä»¥ä¸‹å‚æ•°:</p><ul class=""><li id="0103" class="kj kk hh jp b jq jr jt ju jw kl ka km ke kn ki ko kp kq kr bi translated"><strong class="jp hi">è§’è‰²</strong>:AWS IAMè§’è‰²åæˆ–ARN</li><li id="8bfb" class="kj kk hh jp b jq ks jt kt jw ku ka kv ke kw ki ko kp kq kr bi translated"><strong class="jp hi">image _ uri:</strong>Dockerå›¾åƒçš„å”¯ä¸€é“¾æ¥</li><li id="567e" class="kj kk hh jp b jq ks jt kt jw ku ka kv ke kw ki ko kp kq kr bi translated"><strong class="jp hi"> instance_count: </strong>è¿è¡Œå¤„ç†ä½œä¸šçš„å®ä¾‹æ•°ã€‚</li><li id="b723" class="kj kk hh jp b jq ks jt kt jw ku ka kv ke kw ki ko kp kq kr bi translated"><strong class="jp hi"> instance_type: </strong>ç”¨äºå¤„ç†çš„EC2å®ä¾‹çš„ç±»å‹</li><li id="36e8" class="kj kk hh jp b jq ks jt kt jw ku ka kv ke kw ki ko kp kq kr bi translated"><strong class="jp hi">å…¥å£ç‚¹:</strong>æ„æˆå…¥å£ç‚¹å‘½ä»¤çš„å­—ç¬¦ä¸²åˆ—è¡¨ã€‚è¿™é‡Œæˆ‘ä»¬å¯ä»¥æ ¹æ®instance_typeä¼ é€’<code class="du mb mc md me b">num_gpus</code>å‚æ•°ã€‚ä¾‹å¦‚<code class="du mb mc md me b">ml.p3.16xlarge</code>æœ‰8ä¸ªGPU</li><li id="172f" class="kj kk hh jp b jq ks jt kt jw ku ka kv ke kw ki ko kp kq kr bi translated"><strong class="jp hi"> volume_size_in_gb </strong>:ä»¥gbä¸ºå•ä½çš„å¤§å°ï¼Œç”¨äºåœ¨å¤„ç†ä½œä¸šæœŸé—´å­˜å‚¨æ•°æ®</li></ul><p id="e2ae" class="pw-post-body-paragraph jn jo hh jp b jq jr ii js jt ju il jv jw jx jy jz ka kb kc kd ke kf kg kh ki ha bi translated">å½“è¿è¡Œå¤„ç†ä½œä¸šæ—¶ï¼Œæˆ‘ä»¬éœ€è¦æä¾›ä½œä¸º<code class="du mb mc md me b"><a class="ae jm" href="https://sagemaker.readthedocs.io/en/stable/api/training/processing.html#sagemaker.processing.ProcessingInput" rel="noopener ugc nofollow" target="_blank"><strong class="jp hi">ProcessingInput</strong></a></code>å¯¹è±¡çš„è¾“å…¥æ–‡ä»¶åˆ—è¡¨å’Œä½œä¸ºè¾“å‡ºçš„<code class="du mb mc md me b"><a class="ae jm" href="https://sagemaker.readthedocs.io/en/stable/api/training/processing.html#sagemaker.processing.ProcessingOutput" rel="noopener ugc nofollow" target="_blank"><strong class="jp hi">ProcessingOutput</strong></a></code>å¯¹è±¡åˆ—è¡¨ã€‚è¯·æ³¨æ„å‚æ•°<code class="du mb mc md me b"><strong class="jp hi">s3_data_distribution_type</strong></code>ï¼Œå®ƒå¯ä»¥æ˜¯â€œ<strong class="jp hi">full replicated</strong>æˆ–â€œ<strong class="jp hi"> ShardedByS3Key </strong>â€ï¼Œå…¶ä¸­full replicatedå°†ä½¿ç»™å®šæ•°æ®é›†çš„å‰¯æœ¬åœ¨æ¯ä¸ªå®ä¾‹ä¸­å¯ç”¨ï¼ŒShardedByS3Keyå°†æŠŠ[<strong class="jp hi"># of data files</strong>]/[<strong class="jp hi"># of instances</strong>]æ¡æ•°æ®å¤åˆ¶åˆ°æ¯ä¸ªå®ä¾‹ä¸­ã€‚<br/>æ›´å¤šä¿¡æ¯è¯·å‚è€ƒæ­¤å¤„çš„<a class="ae jm" href="https://sagemaker.readthedocs.io/en/stable/index.html" rel="noopener ugc nofollow" target="_blank">å’Œ</a>ã€‚</p><pre class="ix iy iz ja fd mm me mn bn mo mp bi"><span id="6c8f" class="mq lf hh me b be mr ms l mt mu">import boto3<br/>import sagemaker<br/>from sagemaker import get_execution_role<br/>from sagemaker.processing import Processor<br/>from sagemaker.processing import ProcessingInput, ProcessingOutput<br/><br/>region = boto3.session.Session().region_name<br/>role = get_execution_role()<br/><br/>ecr_image = '&lt;ACCOUNT-ID&gt;.dkr.ecr.us-east-1.amazonaws.com/sm-lexical-similarity:v1'<br/><br/>huggingface_processor = Processor(role=role,<br/>                                  entrypoint=['python', '-u', 'src/infer.py', '--num_gpus=8'],<br/>                                  image_uri=ecr_image,<br/>                                  instance_type='ml.p3.16xlarge',<br/>                                  instance_count=50,<br/>                                  volume_size_in_gb=600,<br/>                                  base_job_name = 'preprocess-semantic'<br/>                                 )<br/><br/>huggingface_processor.run(<br/>    inputs=[<br/>        ProcessingInput(<br/>            source='&lt;s3_uri or local path&gt;',<br/>            s3_data_distribution_type='ShardedByS3Key',<br/>            destination='/opt/ml/processing/data/input')<br/>    ],<br/>    <br/>    outputs=[<br/>        ProcessingOutput(<br/>          source='/opt/ml/processing/data/output/',<br/>          destination='&lt;s3_uri&gt;,<br/>          s3_upload_mode='Continuous'<br/>        )<br/>    ]<br/>                     <br/>)</span></pre><h1 id="7135" class="le lf hh bd lg lh mv lj lk ll mw ln lo in mx io lq iq my ir ls it mz iu lu lv bi translated">ç»“è®º</h1><p id="cd4f" class="pw-post-body-paragraph jn jo hh jp b jq lw ii js jt lx il jv jw ly jy jz ka lz kc kd ke ma kg kh ki ha bi translated">åœ¨è¿™ç¯‡åšå®¢ä¸­ï¼Œæˆ‘ä»¬ä»‹ç»äº†ä¸€ä¸ªç«¯åˆ°ç«¯çš„åˆ†å¸ƒå¼å¤„ç†ä½œä¸šï¼Œå®ƒä½¿ç”¨äº†æ¥è‡ªHugging Faceçš„é¢„è®­ç»ƒçš„transformeræ¨¡å‹ã€‚æˆ‘ä»¬åˆ©ç”¨Amazon SageMakeræŠ½è±¡å‡ºèµ„æºä¾›åº”ã€‚æˆ‘ä»¬å­¦ä¹ äº†å¦‚ä½•æ‰“åŒ…æˆ‘ä»¬çš„ä»£ç ï¼Œåˆ›å»ºdockerå®¹å™¨ï¼Œå¹¶å°†å…¶ä¸Šä¼ åˆ°Amazon ECRã€‚è¿™é‡Œæ˜¯å®˜æ–¹<a class="ae jm" href="https://sagemaker.readthedocs.io/en/stable/amazon_sagemaker_processing.html#learn-more" rel="noopener ugc nofollow" target="_blank"> <strong class="jp hi">äºšé©¬é€ŠSageMakerå¤„ç†ç±»æ–‡æ¡£</strong> </a>äº†è§£æ›´å¤šã€‚</p><p id="19b6" class="pw-post-body-paragraph jn jo hh jp b jq jr ii js jt ju il jv jw jx jy jz ka kb kc kd ke kf kg kh ki ha bi translated">å¸Œæœ›ä½ å–œæ¬¢è¿™ä¸ªæ•™ç¨‹ï¼Œè§‰å¾—æœ‰ç”¨ã€‚å¦‚æœä½ æœ‰ä»»ä½•æƒ³æ³•ã€è¯„è®ºæˆ–é—®é¢˜ï¼Œè¯·åœ¨ä¸‹é¢ç•™ä¸‹è¯„è®ºæˆ–åœ¨<a class="ae jm" href="https://www.linkedin.com/in/ratulghosh1/" rel="noopener ugc nofollow" target="_blank"> LinkedIn </a>ä¸Šè”ç³»æˆ‘ã€‚å¿«ä¹é˜…è¯»ğŸ™‚</p><div class="nb nc ez fb nd ne"><a rel="noopener follow" target="_blank" href="/mlearning-ai/mlearning-ai-submission-suggestions-b51e2b130bfb"><div class="nf ab dw"><div class="ng ab nh cl cj ni"><h2 class="bd hi fi z dy nj ea eb nk ed ef hg bi translated">Mlearning.aiæäº¤å»ºè®®</h2><div class="nl l"><h3 class="bd b fi z dy nj ea eb nk ed ef dx translated">å¦‚ä½•æˆä¸ºMlearning.aiä¸Šçš„ä½œå®¶</h3></div><div class="nm l"><p class="bd b fp z dy nj ea eb nk ed ef dx translated">medium.com</p></div></div><div class="nn l"><div class="no l np nq nr nn ns jg ne"/></div></div></a></div></div></div>    
</body>
</html>