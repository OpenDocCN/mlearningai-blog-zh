<html>
<head>
<title>How I combined 60 csv files from 5 directories with a single function using Python</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">我如何使用Python将5个目录中的60个csv文件合并到一个函数中</h1>
<blockquote>原文：<a href="https://medium.com/mlearning-ai/how-i-combined-60-csv-files-from-5-directories-with-a-single-function-using-python-5e17d31e0db6?source=collection_archive---------0-----------------------#2022-05-14">https://medium.com/mlearning-ai/how-i-combined-60-csv-files-from-5-directories-with-a-single-function-using-python-5e17d31e0db6?source=collection_archive---------0-----------------------#2022-05-14</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><figure class="ev ex if ig ih ii er es paragraph-image"><div class="er es ie"><img src="../Images/9e7305157ca79d3f0dbdf983777b0978.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zuGZvn6oz2nZO46rzX4TaA.png"/></div></figure><h1 id="18e9" class="il im hh bd in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji bi translated"><strong class="ak">摘要:</strong></h1><p id="a8a1" class="pw-post-body-paragraph jj jk hh jl b jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg ha bi translated">本教程是我最近参与的一个项目的一个子集。这里的任务是将多个csv文件中的数据合并成一个文件，这样就不会丢失任何信息，并且合并所有文件中的列时不会出现任何不一致。</p><h1 id="b373" class="il im hh bd in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji bi translated"><strong class="ak">简介:</strong></h1><p id="f5ac" class="pw-post-body-paragraph jj jk hh jl b jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg ha bi translated">您是否遇到过这样的情况:多个表有一个公共列，并且必须根据一个主键合并它们？我相信现在你会认为我在谈论连接。是的，但是如果我说我们把这些表都存储在一个csv文件中，那么每个csv文件就是一个表呢？在5个不同的文件夹中有10个csv。总共50个csv文件。这里的任务是合并每个文件夹中的所有csv文件，并生成一个主csv文件，所以最终我们应该有5个主csv文件。这里的数据集与网站的流量相关</p><h1 id="0a4e" class="il im hh bd in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji bi translated"><strong class="ak">关于数据:</strong></h1><p id="d20f" class="pw-post-body-paragraph jj jk hh jl b jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg ha bi translated">让我快速浏览一下文件夹结构:</p><figure class="ki kj kk kl fd ii er es paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="er es kh"><img src="../Images/0a332477059cef3e7154972a117eca3a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*AJliWUFvJxOkYiPtZzWJdA.png"/></div></div></figure><p id="e8e0" class="pw-post-body-paragraph jj jk hh jl b jm kq jo jp jq kr js jt ju ks jw jx jy kt ka kb kc ku ke kf kg ha bi translated"><em class="kv">年&gt;国家视图&gt; 10 csv文件</em></p><p id="2f6a" class="pw-post-body-paragraph jj jk hh jl b jm kq jo jp jq kr js jt ju ks jw jx jy kt ka kb kc ku ke kf kg ha bi translated">类似地，所有其他4个文件夹也有类似的结构。所有的csv都有两列，一列是参数本身，另一列是收到的参数的值或命中数。每个csv文件代表一年。行数可能会增加或减少，有些可能会在不同的年份重复。因此，我们需要确保在合并时没有数据丢失。</p><p id="5099" class="pw-post-body-paragraph jj jk hh jl b jm kq jo jp jq kr js jt ju ks jw jx jy kt ka kb kc ku ke kf kg ha bi translated">我们可以使用SQL和left outer joins或者使用excel中的VLookUp函数来实现这一点，但是这将非常耗时。在这里，蟒蛇来救我们了。</p><p id="b1bf" class="pw-post-body-paragraph jj jk hh jl b jm kq jo jp jq kr js jt ju ks jw jx jy kt ka kb kc ku ke kf kg ha bi translated">我们将使用python自动完成这项任务，并创建一个函数，该函数将单个输入作为文件夹“Year”的路径，并在单个调用中为我们在每个子目录中创建一个新的主csv。够了，让我们开始工作吧。</p><p id="352c" class="pw-post-body-paragraph jj jk hh jl b jm kq jo jp jq kr js jt ju ks jw jx jy kt ka kb kc ku ke kf kg ha bi translated"><em class="kv">导入必要的库:</em></p><pre class="ki kj kk kl fd kw kx ky kz aw la bi"><span id="7b62" class="lb im hh kx b fi lc ld l le lf">import pandas as pd<br/>import os        #provides functions necessary to interact with os<br/>import glob      #used to extract file paths that match specific                pattern<br/>import re        #regular expression package</span></pre><h1 id="21c9" class="il im hh bd in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji bi translated"><strong class="ak">方法:</strong></h1><ol class=""><li id="e8db" class="lg lh hh jl b jm jn jq jr ju li jy lj kc lk kg ll lm ln lo bi translated">我们的函数将遍历主文件夹“Year”中的所有子文件夹。“子文件夹”列表将存储所有子文件夹的名称。</li><li id="fbc8" class="lg lh hh jl b jm lp jq lq ju lr jy ls kc lt kg ll lm ln lo bi translated">在每个子文件夹中，我们将遍历所有文件，并将每个文件路径存储在列表“all_files”中。</li><li id="4828" class="lg lh hh jl b jm lp jq lq ju lr jy ls kc lt kg ll lm ln lo bi translated">每个文件的数据将被存储为一个数据帧，并且每个数据帧将被存储在一个新的列表‘Li’中。换句话说，我们将创建一个列表，其中每个索引代表一个数据帧(csv)。</li><li id="40d0" class="lg lh hh jl b jm lp jq lq ju lr jy ls kc lt kg ll lm ln lo bi translated">我们还将创建一个“year”列表，该列表将使用库“re”从所有csv文件名中提取并存储年份。</li><li id="e92c" class="lg lh hh jl b jm lp jq lq ju lr jy ls kc lt kg ll lm ln lo bi translated">使用列表“li”的索引，我们将用左外连接合并每个数据帧，从前2个索引开始，然后迭代直到列表索引的结尾。</li><li id="584d" class="lg lh hh jl b jm lp jq lq ju lr jy ls kc lt kg ll lm ln lo bi translated">在我们生成最终的主csv之后，我们将在“年份”列表的帮助下重命名所有的列我们将使用先前创建的“子文件夹”列表，用各自的文件夹名称命名子文件夹中的所有文件。</li></ol><h1 id="7d3b" class="il im hh bd in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji bi translated"><strong class="ak">执行:</strong></h1><p id="47fd" class="pw-post-body-paragraph jj jk hh jl b jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg ha bi translated">我们的函数将是一个迭代器。这里，为了便于理解，我将带你经历一次迭代，然后我们将它转换成一个动态函数。我们将使用太多的列表和for循环。</p><p id="95cd" class="pw-post-body-paragraph jj jk hh jl b jm kq jo jp jq kr js jt ju ks jw jx jy kt ka kb kc ku ke kf kg ha bi translated">第一步:</p><p id="39d6" class="pw-post-body-paragraph jj jk hh jl b jm kq jo jp jq kr js jt ju ks jw jx jy kt ka kb kc ku ke kf kg ha bi translated">解析主文件夹“Year”并存储列表中所有子文件夹的名称。</p><pre class="ki kj kk kl fd kw kx ky kz aw la bi"><span id="5690" class="lb im hh kx b fi lc ld l le lf">data_dir = r’E:\Year’<br/>sub_folders = os.listdir(data_dir)<br/>sub_folders</span></pre><figure class="ki kj kk kl fd ii er es paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="er es lu"><img src="../Images/db764fe0f039461ad395ecc5396df848.png" data-original-src="https://miro.medium.com/v2/resize:fit:1128/format:webp/1*Ng8_gxVgnYwT3gubLnqxUg.png"/></div></div></figure><p id="1c81" class="pw-post-body-paragraph jj jk hh jl b jm kq jo jp jq kr js jt ju ks jw jx jy kt ka kb kc ku ke kf kg ha bi translated">第二步:</p><p id="96d9" class="pw-post-body-paragraph jj jk hh jl b jm kq jo jp jq kr js jt ju ks jw jx jy kt ka kb kc ku ke kf kg ha bi translated">遍历子文件夹“Clicks”中的所有文件，并将它们的文件路径存储在列表“all_files”中</p><pre class="ki kj kk kl fd kw kx ky kz aw la bi"><span id="b6a8" class="lb im hh kx b fi lc ld l le lf">path = os.path.join(data_dir, sub_folders[0])<br/>os.chdir(path)<br/>all_files = glob.glob(path + “/*.csv”)<br/>all_files</span></pre><figure class="ki kj kk kl fd ii er es paragraph-image"><div class="er es lv"><img src="../Images/5a3d72aafe7e7a39aa2465b735868c2c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1028/format:webp/1*j6gsFnirGY7ANcU7pXBW6Q.png"/></div></figure><p id="bebf" class="pw-post-body-paragraph jj jk hh jl b jm kq jo jp jq kr js jt ju ks jw jx jy kt ka kb kc ku ke kf kg ha bi translated">第三步:</p><p id="5cfd" class="pw-post-body-paragraph jj jk hh jl b jm kq jo jp jq kr js jt ju ks jw jx jy kt ka kb kc ku ke kf kg ha bi translated">创建一个新的文件数据列表作为数据帧“li”</p><pre class="ki kj kk kl fd kw kx ky kz aw la bi"><span id="91b9" class="lb im hh kx b fi lc ld l le lf">li = []<br/>for filename in all_files:<br/> df = pd.read_csv(filename,on_bad_lines=’skip’,names=[‘Title’, ‘Frequency’])<br/> li.append(df)<br/>li</span></pre><figure class="ki kj kk kl fd ii er es paragraph-image"><div class="er es lv"><img src="../Images/1c59d22940232a5b56c2bd2eb9c3d0bd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1028/format:webp/1*v4uBBV-rLVbIxzgXvxVzKQ.png"/></div></figure><pre class="ki kj kk kl fd kw kx ky kz aw la bi"><span id="912e" class="lb im hh kx b fi lc ld l le lf">li[0]</span></pre><figure class="ki kj kk kl fd ii er es paragraph-image"><div class="er es lw"><img src="../Images/994ca3eddabdba73f277c063cbc589cb.png" data-original-src="https://miro.medium.com/v2/resize:fit:842/format:webp/1*MsxA30Xxgls80XSnysi1cw.png"/></div></figure><p id="9405" class="pw-post-body-paragraph jj jk hh jl b jm kq jo jp jq kr js jt ju ks jw jx jy kt ka kb kc ku ke kf kg ha bi translated"><em class="kv">一览列表“李”中第一个指标的样子</em></p><p id="ecf6" class="pw-post-body-paragraph jj jk hh jl b jm kq jo jp jq kr js jt ju ks jw jx jy kt ka kb kc ku ke kf kg ha bi translated">第四步:</p><p id="f22d" class="pw-post-body-paragraph jj jk hh jl b jm kq jo jp jq kr js jt ju ks jw jx jy kt ka kb kc ku ke kf kg ha bi translated">创建一个“年份”列表，使用库re从文件名中提取所有年份</p><pre class="ki kj kk kl fd kw kx ky kz aw la bi"><span id="23a2" class="lb im hh kx b fi lc ld l le lf">year = []<br/>for file in range(0,len(all_files)):<br/> x = re.search(“[0–5][0–9][0–5][0–9]”, all_files[file])<br/> year.append(x.group())<br/>year</span></pre><figure class="ki kj kk kl fd ii er es paragraph-image"><div class="er es lx"><img src="../Images/ccc1aca468f7d9d9a01c5f323d4bae93.png" data-original-src="https://miro.medium.com/v2/resize:fit:1112/format:webp/1*2PhGHs1ewHE1RiaQxKlqpw.png"/></div></figure><p id="1bb0" class="pw-post-body-paragraph jj jk hh jl b jm kq jo jp jq kr js jt ju ks jw jx jy kt ka kb kc ku ke kf kg ha bi translated">第五步:</p><p id="7aad" class="pw-post-body-paragraph jj jk hh jl b jm kq jo jp jq kr js jt ju ks jw jx jy kt ka kb kc ku ke kf kg ha bi translated">从索引0和1开始，用左外连接逐一合并每个数据帧中的所有数据。在此之前，我们将添加用0替换所有数据帧中的所有空白值。</p><pre class="ki kj kk kl fd kw kx ky kz aw la bi"><span id="4eb6" class="lb im hh kx b fi lc ld l le lf">li[index].fillna(0)<br/>li[index] = li[index].groupby([‘Title’]).agg(‘sum’)</span><span id="ea7a" class="lb im hh kx b fi ly ld l le lf">left = li[0]<br/>for i in range(0,len(year)-1):<br/> right = li[i+1]<br/> result = pd.merge(left, right, on=”Title”, how=”outer”,suffixes=    (year[i],year[i+1]))<br/> left = result<br/>left.head()</span></pre><figure class="ki kj kk kl fd ii er es paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="er es lz"><img src="../Images/ead3ca16cc64f65462f1aea51cea0f13.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6ud5ndln5TOP7ZtsWK4srw.png"/></div></div></figure><p id="9a33" class="pw-post-body-paragraph jj jk hh jl b jm kq jo jp jq kr js jt ju ks jw jx jy kt ka kb kc ku ke kf kg ha bi translated">第六步:</p><p id="cc31" class="pw-post-body-paragraph jj jk hh jl b jm kq jo jp jq kr js jt ju ks jw jx jy kt ka kb kc ku ke kf kg ha bi translated">让我们重新命名这些列，因为frequency被添加到连接生成的所有新列名中。</p><pre class="ki kj kk kl fd kw kx ky kz aw la bi"><span id="a974" class="lb im hh kx b fi lc ld l le lf">left.columns = year<br/>left.head()</span></pre><figure class="ki kj kk kl fd ii er es paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="er es ma"><img src="../Images/71c37b4b7b709ce02756df4a4f440aab.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WySmQekPPCxBTzAhBkB4EA.png"/></div></div></figure><p id="0daa" class="pw-post-body-paragraph jj jk hh jl b jm kq jo jp jq kr js jt ju ks jw jx jy kt ka kb kc ku ke kf kg ha bi translated">最后，让我们在“Clicks”子文件夹中用适当的文件名导出数据帧</p><pre class="ki kj kk kl fd kw kx ky kz aw la bi"><span id="6d75" class="lb im hh kx b fi lc ld l le lf">left.to_csv(sub_folders[0]+’.csv’)</span></pre><p id="5f9c" class="pw-post-body-paragraph jj jk hh jl b jm kq jo jp jq kr js jt ju ks jw jx jy kt ka kb kc ku ke kf kg ha bi translated">因此，我们成功地完成了手头的任务。现在让我们把所有的代码放在一个函数中。</p><pre class="ki kj kk kl fd kw kx ky kz aw la bi"><span id="2b05" class="lb im hh kx b fi lc ld l le lf">def combine_data(data_dir):<br/> <br/> os.chdir(data_dir)<br/> sub_folders = os.listdir(data_dir) #list of sub_folders</span><span id="b5cc" class="lb im hh kx b fi ly ld l le lf">for folder in range(0,len(sub_folders)): #loop through all sub_folders<br/> path = os.path.join(data_dir, sub_folders[folder])<br/> os.chdir(path)<br/> all_files = glob.glob(path + “/*.csv”) #list of all files in folder</span><span id="b3c8" class="lb im hh kx b fi ly ld l le lf">li = []<br/> for filename in all_files:<br/> df = pd.read_csv(filename,on_bad_lines=’skip’,names=[‘Title’, ‘Frequency’])<br/> li.append(df) #list li of df (each csv as 1 df at each index of li)<br/> <br/> for index in range(0,len(all_files)):<br/> li[index].fillna(0)<br/> li[index] = li[index].groupby([‘Title’]).agg(‘sum’)</span><span id="e892" class="lb im hh kx b fi ly ld l le lf">year = []<br/> for file in range(0,len(all_files)):<br/> x = re.search(“[0–5][0–9][0–5][0–9]”, all_files[file])<br/> year.append(x.group()) #list of year fetched from .csv filenames</span><span id="0fa8" class="lb im hh kx b fi ly ld l le lf">left = li[0]<br/> for i in range(0,len(year)-1):<br/> right = li[i+1]<br/> result = pd.merge(left, right, on=”Title”, how=”outer”,suffixes=(year[i],year[i+1])) #outer merge on 2 consecutive indexes of df<br/> left = result</span><span id="11cb" class="lb im hh kx b fi ly ld l le lf">#year.insert(0,’Title’) <br/> left.columns = year #updating column names of master df</span><span id="129c" class="lb im hh kx b fi ly ld l le lf">left.to_csv(sub_folders[folder]+’.csv’) #exporting the df</span></pre><p id="2ba8" class="pw-post-body-paragraph jj jk hh jl b jm kq jo jp jq kr js jt ju ks jw jx jy kt ka kb kc ku ke kf kg ha bi translated">函数调用:</p><pre class="ki kj kk kl fd kw kx ky kz aw la bi"><span id="5628" class="lb im hh kx b fi lc ld l le lf">data_dir = r’E:Year’<br/>combine_data(data_dir)</span></pre><p id="8b10" class="pw-post-body-paragraph jj jk hh jl b jm kq jo jp jq kr js jt ju ks jw jx jy kt ka kb kc ku ke kf kg ha bi translated"><em class="kv">感谢您阅读这篇文章。请联系任何关于kakadiya95@gmail.com的问题、澄清或版权问题。或者你可以在我的</em><a class="ae mb" href="https://www.linkedin.com/in/kkkakadiya/" rel="noopener ugc nofollow" target="_blank"><em class="kv">Linkedin</em></a><em class="kv">页面给我发消息。还有，结账我的</em><a class="ae mb" href="https://github.com/sh4dowbyt3" rel="noopener ugc nofollow" target="_blank"><em class="kv">github</em></a><em class="kv">账号。</em></p><div class="mc md ez fb me mf"><a rel="noopener follow" target="_blank" href="/mlearning-ai/mlearning-ai-submission-suggestions-b51e2b130bfb"><div class="mg ab dw"><div class="mh ab mi cl cj mj"><h2 class="bd hi fi z dy mk ea eb ml ed ef hg bi translated">Mlearning.ai提交建议</h2><div class="mm l"><h3 class="bd b fi z dy mk ea eb ml ed ef dx translated">如何成为Mlearning.ai上的作家</h3></div><div class="mn l"><p class="bd b fp z dy mk ea eb ml ed ef dx translated">medium.com</p></div></div><div class="mo l"><div class="mp l mq mr ms mo mt ij mf"/></div></div></a></div></div></div>    
</body>
</html>