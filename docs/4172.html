<html>
<head>
<title>Traffic Light Detection and Recognition System — Part 1</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">交通灯检测与识别系统第1部分</h1>
<blockquote>原文：<a href="https://medium.com/mlearning-ai/traffic-light-detection-and-recognition-system-part-1-15a649906977?source=collection_archive---------1-----------------------#2022-12-20">https://medium.com/mlearning-ai/traffic-light-detection-and-recognition-system-part-1-15a649906977?source=collection_archive---------1-----------------------#2022-12-20</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><figure class="ev ex if ig ih ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es ie"><img src="../Images/197e87d2df5ff9afaac26383e985cb0b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*2axW7SRJH6H8pDXw"/></div></div><figcaption class="ip iq et er es ir is bd b be z dx">Photo by <a class="ae it" href="https://unsplash.com/@tjump?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Nik Shuliahin </a>on <a class="ae it" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="2b8c" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">使用计算机视觉、机器学习和深度学习技术可以很容易地构建交通灯检测系统。在本文中，我将整个问题陈述分解为三个部分，并涵盖了第一部分。总共会有3篇文章，到最后，你会有一个交通灯检测和识别系统的工作原型。</p><blockquote class="js jt ju"><p id="0da9" class="iu iv jv iw b ix iy iz ja jb jc jd je jw jg jh ji jx jk jl jm jy jo jp jq jr ha bi translated">这是<strong class="iw hi">不是初学者友好教程</strong>。在开始这个项目之前，你应该知道对象检测和图像分类算法的基本概念。还要稍微熟悉一下Python、Keras、Tensorflow和OpenCV。</p></blockquote><p id="458f" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">因此，这个交通灯检测和识别系统可以分解如下:</p><ol class=""><li id="ec28" class="jz ka hh iw b ix iy jb jc jf kb jj kc jn kd jr ke kf kg kh bi translated">交通灯检测</li><li id="093c" class="jz ka hh iw b ix ki jb kj jf kk jj kl jn km jr ke kf kg kh bi translated">交通灯的分类</li><li id="0362" class="jz ka hh iw b ix ki jb kj jf kk jj kl jn km jr ke kf kg kh bi translated">结合检测和分类系统</li></ol><h1 id="5d63" class="kn ko hh bd kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk bi translated">交通灯检测</h1><p id="0790" class="pw-post-body-paragraph iu iv hh iw b ix ll iz ja jb lm jd je jf ln jh ji jj lo jl jm jn lp jp jq jr ha bi translated">我使用过预训练的交通灯检测模型，因为它们的性能相当不错。<a class="ae it" href="https://github.com/tensorflow/models/blob/master/research/object_detection/g3doc/tf2_detection_zoo.md" rel="noopener ugc nofollow" target="_blank"> TensorFlow 2检测模型Zoo </a>有各种现成可用的对象检测API。你也可以使用YOLO的变体，比如最近的一个<a class="ae it" href="https://github.com/WongKinYiu/yolov7" rel="noopener ugc nofollow" target="_blank"> YOLOv7 </a>。然而，我使用了Tensorflow检测API。你不需要数据集来训练它，因为它已经在<a class="ae it" href="https://cocodataset.org/#home" rel="noopener ugc nofollow" target="_blank"> COCO 2017数据集</a>上训练过了。</p><p id="1b1f" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">您可以根据所需速度(毫秒)、COCO mAP和输出从TensorFlow 2检测模型动物园中挑选任何一个模型。如果你对如何选择模型感到困惑，谷歌研究团队提供了一个名为“<a class="ae it" href="https://arxiv.org/pdf/1611.10012.pdf" rel="noopener ugc nofollow" target="_blank">现代卷积物体探测器的速度/精度权衡</a>的指南，应该可以帮助你。</p><h2 id="05d3" class="lq ko hh bd kp lr ls lt kt lu lv lw kx jf lx ly lb jj lz ma lf jn mb mc lj md bi translated">密码</h2><p id="6136" class="pw-post-body-paragraph iu iv hh iw b ix ll iz ja jb lm jd je jf ln jh ji jj lo jl jm jn lp jp jq jr ha bi translated">现在我们已经熟悉了张量流检测模型，我们可以开始编写代码了。</p><pre class="me mf mg mh fd mi mj mk bn ml mm bi"><span id="4b72" class="mn ko hh mj b be mo mp l mq mr">import numpy as np<br/>import matplotlib.pyplot as plt<br/>import os<br/>import tensorflow as tf<br/>from glob import glob<br/>import sys<br/>import sklearn.metrics as metrics<br/>from tensorflow import keras<br/>from tensorflow.keras.models import load_model<br/>import shutil<br/>from PIL import Image<br/>import cv2<br/>import time</span></pre><p id="86a0" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">这些是整个项目所需的重要依赖项。现在让我们设置路径，</p><pre class="me mf mg mh fd mi mj mk bn ml mm bi"><span id="f2d2" class="mn ko hh mj b be mo mp l mq mr">MODEL_NAME = 'faster_rcnn_inception_resnet_v2_atrous_coco_11_06_2017'<br/>MODEL_FILE = MODEL_NAME + '.tar.gz'<br/>DOWNLOAD_BASE = 'http://download.tensorflow.org/models/object_detection/'<br/><br/>model_path = "./"<br/>OUR_PATH = model_path + MODEL_NAME + '/frozen_inference_graph.pb'</span></pre><p id="1bc6" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">我使用的是“<a class="ae it" href="http://download.tensorflow.org/models/object_detection/tf2/20200711/faster_rcnn_inception_resnet_v2_640x640_coco17_tpu-8.tar.gz" rel="noopener ugc nofollow" target="_blank">更快的R-CNN Inception ResNet V2 640 x640</a>”型号，它更注重精度而不是速度。您可以使用“SSD _ mobilenet _ v1 _ coco _ 11 _ 06 _ 2017”来获得更快的结果，或者使用“rfcn_resnet101_coco_11_06_2017”、“faster _ rcnn _ resnet 101 _ coco _ 11 _ 06 _ 2017”来获得更快的结果。</p><p id="3f86" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated"><em class="jv">‘OUR _ PATH’</em>是到冻结检测图形的路径，该图形是用于对象检测的实际模型。</p><p id="5269" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">现在，我们将创建从模型动物园下载对象检测模型的函数，加载图形并选择最佳边界框。</p><pre class="me mf mg mh fd mi mj mk bn ml mm bi"><span id="dff8" class="mn ko hh mj b be mo mp l mq mr">def download_model():<br/>    import six.moves.urllib as urllib<br/>    import tarfile<br/><br/>    opener = urllib.request.URLopener()<br/>    opener.retrieve(DOWNLOAD_BASE + MODEL_FILE, MODEL_FILE)<br/>    tar_file = tarfile.open(MODEL_FILE)<br/>    for file in tar_file.getmembers():<br/>        file_name = os.path.basename(file.name)<br/>        if 'frozen_inference_graph.pb' in file_name:<br/>            tar_file.extract(file, os.getcwd())<br/><br/>def load_graph():<br/>    if not os.path.exists(OUR_PATH):<br/>        download_model()<br/><br/>    detection_graph = tf.Graph()<br/>    with detection_graph.as_default():<br/>        od_graph_def = tf.compat.v1.GraphDef()<br/>        with tf.compat.v2.io.gfile.GFile(OUR_PATH, 'rb') as fid:<br/>            serialized_graph = fid.read()<br/>            od_graph_def.ParseFromString(serialized_graph)<br/>            tf.import_graph_def(od_graph_def, name='')<br/><br/>    return detection_graph<br/><br/>def select_boxes(boxes, classes, scores, score_threshold=0, target_class=10):<br/>    sq_scores = np.squeeze(scores)<br/>    sq_classes = np.squeeze(classes)<br/>    sq_boxes = np.squeeze(boxes)<br/><br/>    sel_id = np.logical_and(sq_classes == target_class, <br/>                            sq_scores &gt; score_threshold)<br/><br/>    return sq_boxes[sel_id]</span></pre><p id="08ed" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">现在我们已经定义了必要的函数，让我们创建一个交通灯检测器类，</p><pre class="me mf mg mh fd mi mj mk bn ml mm bi"><span id="66f5" class="mn ko hh mj b be mo mp l mq mr">class TLDetector(object):<br/>    def __init__(self):<br/>        self.detection_graph = load_graph()<br/>        self.extract_graph_components()<br/>        self.sess = tf.compat.v1.Session(graph=self.detection_graph)<br/><br/>        # dummy session<br/>        dummy_image = np.zeros((224, 224, 3))<br/>        self.detect_multi_object(dummy_image,0.1)<br/>        self.traffic_light_box = None<br/>        self.classified_index = 0<br/><br/>    def extract_graph_components(self):<br/>        # Definite input and output Tensors for detection_graph<br/>        self.image_tensor = self.detection_graph.get_tensor_by_name('image_tensor:0')<br/>        # Each box represents a part of the image where a particular object was detected.<br/>        self.detection_boxes = self.detection_graph.get_tensor_by_name('detection_boxes:0')<br/>        # Each score represent how level of confidence for each of the objects.<br/>        # Score is shown on the result image, together with the class label.<br/>        self.detection_scores = self.detection_graph.get_tensor_by_name('detection_scores:0')<br/>        self.detection_classes = self.detection_graph.get_tensor_by_name('detection_classes:0')<br/>        self.num_detections = self.detection_graph.get_tensor_by_name('num_detections:0')<br/>    <br/>    def detect_multi_object(self, image_np, score_threshold):<br/><br/>        image_np_expanded = np.expand_dims(image_np, axis=0)<br/><br/>        (boxes, scores, classes, num) = self.sess.run([self.detection_boxes, <br/>                                                       self.detection_scores, <br/>                                                       self.detection_classes, <br/>                                                       self.num_detections],<br/>                                                       feed_dict={self.image_tensor: image_np_expanded})<br/><br/>        sel_boxes = select_boxes(boxes=boxes, <br/>                                 classes=classes, <br/>                                 scores=scores,<br/>                                 score_threshold=score_threshold, <br/>                                 target_class=10) # Class 10 is for Traffic Lights<br/><br/>        return sel_boxes<br/><br/>start_time = time.time()<br/>tld = TLDetector()<br/>print("--- %s seconds ---" % (time.time() - start_time))</span></pre><p id="9a1f" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">这就是我们需要为系统的交通灯检测部分所做的一切。</p><p id="0cdf" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">如果您想测试这个交通灯检测系统，请遵循下面的代码，</p><pre class="me mf mg mh fd mi mj mk bn ml mm bi"><span id="5982" class="mn ko hh mj b be mo mp l mq mr">def get_annots(image_np, sel_box):<br/>    annots_temp = []<br/>    im_height, im_width, _ = image_np.shape<br/>    (left, right, top, bottom) = (sel_box[1] * im_width, sel_box[3] * im_width,<br/>                                  sel_box[0] * im_height, sel_box[2] * im_height)<br/>    annots_temp.extend((left, top,right,  bottom))<br/>    <br/>    return annots_temp<br/><br/>def tl_detection(test_file):<br/>  start_time = time.time()<br/>  im = Image.open(test_file)<br/>  image_np = np.asarray(im)<br/>  boxes=tld.detect_multi_object(image_np,score_threshold=0.2)<br/>  annotations = []<br/>  if len(boxes)&gt;0:<br/>    for box in boxes:<br/>      temp_annots = get_annots(image_np,box)<br/>      annotations.append(temp_annots)<br/><br/>  img = cv2.imread(test_file)<br/>  img = cv2.cvtColor(img, cv2.COLOR_BGR2RGB)<br/>  print("Found {} annotations:".format(len(annotations)))<br/>  i=0<br/>  for anno in annotations:<br/>      anno_left = int(anno[0])<br/>      anno_top = int(anno[1])<br/>      anno_right = int(anno[2])<br/>      anno_bot = int(anno[3])<br/>      print("\tClass: '{}' at [{},{},{},{}]".format("traffic light", anno_left, anno_top, anno_right, anno_bot))<br/><br/>      cv2.rectangle(img, (anno_left, anno_top), (anno_right, anno_bot), (0,0,255), 5)<br/><br/>      plt.rcParams['figure.figsize'] = [14, 10]<br/>  plt.imshow(img)<br/>  plt.show()<br/>  print("--- %s seconds ---" % (time.time() - start_time))</span></pre><p id="4474" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">为了在图像上测试它，</p><pre class="me mf mg mh fd mi mj mk bn ml mm bi"><span id="e901" class="mn ko hh mj b be mo mp l mq mr">test_file = 'test.jpg'<br/>tl_detection(test_file)</span></pre><p id="582b" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">我在属于<a class="ae it" href="https://www.kaggle.com/datasets/mbornoe/lisa-traffic-light-dataset" rel="noopener ugc nofollow" target="_blank"> LISA交通灯数据集</a>的一张图像上测试了它。所以输出是，</p><blockquote class="js jt ju"><p id="e054" class="iu iv jv iw b ix iy iz ja jb jc jd je jw jg jh ji jx jk jl jm jy jo jp jq jr ha bi translated">找到3个注释:</p><p id="1058" class="iu iv jv iw b ix iy iz ja jb jc jd je jw jg jh ji jx jk jl jm jy jo jp jq jr ha bi translated">类别:【839，59，894，166】处的“红绿灯”</p><p id="8c44" class="iu iv jv iw b ix iy iz ja jb jc jd je jw jg jh ji jx jk jl jm jy jo jp jq jr ha bi translated">类别:【718，400，732，436】处的“红绿灯”</p><p id="3bfe" class="iu iv jv iw b ix iy iz ja jb jc jd je jw jg jh ji jx jk jl jm jy jo jp jq jr ha bi translated">类别:【516，50，588，147】处的“红绿灯”</p></blockquote><figure class="me mf mg mh fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es ms"><img src="../Images/ef15840d9546730c38992f8e5e275a49.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7tpF2rz3pOzNS2oteGWbLg.png"/></div></div><figcaption class="ip iq et er es ir is bd b be z dx">Three traffic lights detected</figcaption></figure><p id="6bf1" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">至此，我们终于结束了这个项目的第一部分！</p><p id="c9b7" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">该项目的剩余部分即将推出，敬请关注…</p></div><div class="ab cl mt mu go mv" role="separator"><span class="mw bw bk mx my mz"/><span class="mw bw bk mx my mz"/><span class="mw bw bk mx my"/></div><div class="ha hb hc hd he"><p id="2f42" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated"><strong class="iw hi"> <em class="jv">参考文献</em> </strong></p><div class="na nb ez fb nc nd"><a href="https://github.com/tensorflow/models/blob/master/research/object_detection/g3doc/tf2_detection_zoo.md" rel="noopener  ugc nofollow" target="_blank"><div class="ne ab dw"><div class="nf ab ng cl cj nh"><h2 class="bd hi fi z dy ni ea eb nj ed ef hg bi translated">主tensorflow/models上的models/tf2_detection_zoo.md</h2><div class="nk l"><h3 class="bd b fi z dy ni ea eb nj ed ef dx translated">我们提供了一组在COCO 2017数据集上预先训练的检测模型。这些模型可用于…</h3></div><div class="nl l"><p class="bd b fp z dy ni ea eb nj ed ef dx translated">github.com</p></div></div><div class="nm l"><div class="nn l no np nq nm nr in nd"/></div></div></a></div><p id="0076" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated"><a class="ae it" href="https://arxiv.org/pdf/1611.10012.pdf" rel="noopener ugc nofollow" target="_blank">https://arxiv.org/pdf/1611.10012.pdf</a></p><div class="na nb ez fb nc nd"><a href="https://www.kaggle.com/datasets/mbornoe/lisa-traffic-light-dataset" rel="noopener  ugc nofollow" target="_blank"><div class="ne ab dw"><div class="nf ab ng cl cj nh"><h2 class="bd hi fi z dy ni ea eb nj ed ef hg bi translated">LISA交通灯数据集</h2><div class="nk l"><h3 class="bd b fi z dy ni ea eb nj ed ef dx translated">超过44分钟的带注释的交通灯数据</h3></div><div class="nl l"><p class="bd b fp z dy ni ea eb nj ed ef dx translated">www.kaggle.com</p></div></div><div class="nm l"><div class="ns l no np nq nm nr in nd"/></div></div></a></div><div class="na nb ez fb nc nd"><a rel="noopener follow" target="_blank" href="/mlearning-ai/mlearning-ai-submission-suggestions-b51e2b130bfb"><div class="ne ab dw"><div class="nf ab ng cl cj nh"><h2 class="bd hi fi z dy ni ea eb nj ed ef hg bi translated">Mlearning.ai提交建议</h2><div class="nk l"><h3 class="bd b fi z dy ni ea eb nj ed ef dx translated">如何成为Mlearning.ai上的作家</h3></div><div class="nl l"><p class="bd b fp z dy ni ea eb nj ed ef dx translated">medium.com</p></div></div><div class="nm l"><div class="nt l no np nq nm nr in nd"/></div></div></a></div></div></div>    
</body>
</html>