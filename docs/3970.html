<html>
<head>
<title>Announcing an Open-Source (MIT Licensed) Airflow and Kubernetes-friendly File Streaming Service</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">宣布开源(麻省理工学院许可)气流和Kubernetes友好的文件流服务</h1>
<blockquote>原文：<a href="https://medium.com/mlearning-ai/announcing-an-open-source-mit-licensed-airflow-and-kubernetes-friendly-file-streaming-service-f68d88f548fe?source=collection_archive---------5-----------------------#2022-11-17">https://medium.com/mlearning-ai/announcing-an-open-source-mit-licensed-airflow-and-kubernetes-friendly-file-streaming-service-f68d88f548fe?source=collection_archive---------5-----------------------#2022-11-17</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><p id="fd93" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">到今天为止，我们已经通过开源MIT许可开源了我们的<a class="ae jc" href="https://github.com/Redactics/http-nas" rel="noopener ugc nofollow" target="_blank"> http-nas </a>项目。</p><p id="c824" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">如果您已经开发了需要以文件形式跟踪状态的作业/管道/工作流(我们的主要用例是在Kubernetes上运行的Airflow)，您可能会遇到这样的挑战:拥有一个可以在多个容器之间共享的文件系统，或者您的Airflow DAGs中的并发任务。用Kubernetes的行话来说，缺少的要素是一个<code class="du jd je jf jg b">ReadWriteMany</code>持久卷，根据您的云提供商的不同，这个持久卷通常要么缺少，要么很贵。</p><p id="9dc8" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在<a class="ae jc" href="https://www.redactics.com/?utm_source=hashnode&amp;utm_medium=web&amp;utm_campaign=http_nas" rel="noopener ugc nofollow" target="_blank">redic ics</a>我们的<a class="ae jc" rel="noopener" href="/p/2300a81e63b3">气流控制设备</a>面临这个问题。使用亚马逊S3或类似的网站对我们来说也不是一个好的选择。<a class="ae jc" href="https://www.redactics.com/?utm_source=medium&amp;utm_medium=web&amp;utm_campaign=http_nas#services" rel="noopener ugc nofollow" target="_blank">redic ics智能代理</a>使用Airflow的<code class="du jd je jf jg b">KubernetesPodOperator</code>来执行我们Dag中的许多任务，其中许多任务是并行运行的。这意味着创建了许多短命的pod，并且不得不多次(有时并发地)上传和下载pod所需的相同文件不仅是带宽和性能杀手，而且它打破了我们所有工作在本地运行而数据不被发送到云的安全模型(这包括通过我们探索的基于<a class="ae jc" href="https://github.com/s3fs-fuse/s3fs-fuse" rel="noopener ugc nofollow" target="_blank"> FUSE </a>的文件系统安装S3桶)。我们还研究了基于NFS的解决方案，包括<a class="ae jc" href="https://artifacthub.io/packages/helm/kvaps/nfs-server-provisioner" rel="noopener ugc nofollow" target="_blank"> NFS Kubernetes存储类</a>解决方案和<a class="ae jc" href="https://cloud.google.com/filestore" rel="noopener ugc nofollow" target="_blank">谷歌云文件存储</a>。在我们必须想出如何扩大我们的NFS卷之前，我们与NFS的合作还算幸运，我们也不喜欢缺乏文件传输的可追溯性。最小的GCP文件存储卷大小是1TB，考虑到我们的文件通常要小得多，这在成本上是不允许的。从业务角度来看，我们将Redactics作为一种在您自己的基础架构中运行的设备进行推广，因此找出如何在我们的客户中以某种方式与S3存储桶分担成本或让我们的客户设置他们自己的存储桶是非常困难的。</p><p id="ca33" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">此外，我们希望以尽可能少的内存开销获得尽可能快的性能，这意味着尽可能多地传输文件，而不是将完整的文件读入内存。cURL、pgdump/pgrestore等工具。可以处理与Linux管道耦合的流(稍后将详细介绍)，并且我们希望能够运行代码，比如只依赖于操作系统级的shell脚本，所以这对我们来说是理想的。</p><p id="cfac" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我们将repo <a class="ae jc" href="https://github.com/Redactics/http-nas" rel="noopener ugc nofollow" target="_blank">称为http-nas</a>,<code class="du jd je jf jg b">NAS</code>部分是<a class="ae jc" href="https://en.wikipedia.org/wiki/Network-attached_storage" rel="noopener ugc nofollow" target="_blank">网络连接存储</a>的简称，因为它本质上是一个基于http的NAS。我们确实考虑到了Kubernetes来构建它，但是如果你能为这项技术想出另一个用例，它当然也可以在非Kubernetes环境中使用。</p><p id="236a" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">Http-nas是一个基于Node.js的API，它简单地将文件传入和传出一个目录。我们选择Node是因为它支持<a class="ae jc" href="https://nodejs.org/api/stream.html" rel="noopener ugc nofollow" target="_blank">文件流</a>并且通常非常轻量级(Golang可能是另一个不错的选择)。在Kubernetes上，您可以为这个服务附加一个持久的卷声明，根据需要放大它，作为一个Kubernetes服务，它可以通过http和从服务名派生的自动创建的DNS条目来访问。完全并发是受支持的，至少在我们决定测试这一点时是如此。我们对http作为一个接口感兴趣，因为我们想通过Linux使用cURL访问这个API，而且<a class="ae jc" href="https://everything.curl.dev/http/post/chunked" rel="noopener ugc nofollow" target="_blank"> cURL支持发送和接收分块文件流</a>。该服务旨在运行在与文件来源相同的局域网上，所以我们觉得在第一次迭代中不需要认证。将来，我们可能会通过添加某种认证/验证层(一个简单的选项就是http基本认证)来接受零信任网络的概念。</p><p id="9c79" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">完整的文档可以在repo中找到，但是为了节省您的行程，这里有一个使用该API的两个基本文件操作的示例:</p><ul class=""><li id="66ba" class="jh ji hh ig b ih ii il im ip jj it jk ix jl jb jm jn jo jp bi translated">将文件流(通过http/REST post URL)到服务:<code class="du jd je jf jg b">cat /path/to/cat.jpg | curl -X POST -H "Transfer-Encoding: chunked" -s -f -T - <a class="ae jc" href="http://http-nas:3000/file/cat.jpg" rel="noopener ugc nofollow" target="_blank">http://http-nas:3000/file/cat.jpg</a></code></li><li id="2c87" class="jh ji hh ig b ih jq il jr ip js it jt ix ju jb jm jn jo jp bi translated">附加(通过http/REST put URL)到文件:<code class="du jd je jf jg b">printf "test append" | curl -X PUT -H "Transfer-Encoding: chunked" -s -f -T - <a class="ae jc" href="http://http-nas:3000/file/mydata.csv" rel="noopener ugc nofollow" target="_blank">http://http-nas:3000/file/mydata.csv</a></code></li></ul><p id="a8a7" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">如果您对这个项目有任何反馈，愿意做出贡献等，请在下面发表评论。(你知道整个开源钻！)我们很想知道如何有效地参与OSS社区，所以请让我们知道你的存在！</p><div class="jv jw ez fb jx jy"><a rel="noopener follow" target="_blank" href="/mlearning-ai/mlearning-ai-submission-suggestions-b51e2b130bfb"><div class="jz ab dw"><div class="ka ab kb cl cj kc"><h2 class="bd hi fi z dy kd ea eb ke ed ef hg bi translated">Mlearning.ai提交建议</h2><div class="kf l"><h3 class="bd b fi z dy kd ea eb ke ed ef dx translated">如何成为Mlearning.ai上的作家</h3></div><div class="kg l"><p class="bd b fp z dy kd ea eb ke ed ef dx translated">medium.com</p></div></div><div class="kh l"><div class="ki l kj kk kl kh km kn jy"/></div></div></a></div></div></div>    
</body>
</html>