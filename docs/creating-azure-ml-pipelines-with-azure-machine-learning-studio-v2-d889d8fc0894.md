# 用 Azure 机器学习工作室 V2 创建 Azure ML 管道

> 原文：<https://medium.com/mlearning-ai/creating-azure-ml-pipelines-with-azure-machine-learning-studio-v2-d889d8fc0894?source=collection_archive---------0----------------------->

![](img/08add321226be252f2a6f968dd34ea56.png)

Title Image

如果我们向 5 位不同的数据科学家询问人工智能的定义，得到 5 个不同的答案并不奇怪。虽然人工智能并不新鲜，但它早在 20 世纪 60 年代就被创造出来了，像 IBM 这样的大型科技公司的科学家和工程师在相当长的时间里一直在研究一些特定的用例。但最近十年，随着移动、云和大数据等数字技术的出现，其商业使用案例呈指数级增长。今天，我们总是通过手机连接到互联网，并通过各种应用程序完成许多任务，如网上购物、网上银行、网上交易、社交网络等，并产生大量的数字足迹或数据。这些由人和数字技术产生的数据为公司提供了向客户提供更好服务的机会，也帮助他们增加了客户群。

这就是大数据分析和人工智能发挥作用的地方。如前所述，人工智能有多种定义，但简单地说:

> 人工智能是计算机系统的发展，能够执行通常需要人类智能的任务。它包括视觉感知、语音识别、决策、语言翻译等。

现在人工智能是一个一般的研究领域，但这里我们关注的是人工智能的子集，称为机器学习。

> 机器学习是一种数据科学技术，允许计算机使用算法和现有数据来预测新数据的未来行为、结果和趋势。通过使用机器学习，计算机在没有明确编程的情况下进行学习。

## Azure 机器学习前景

Azure 机器学习是一个产品系列，包括:

1.  Azure 机器学习平台——它是一个完全托管的云服务，带有图形工作室和可视化设计器。它支持流行的 python 库，如 pyTorch 和 scikit-learn。它还支持统计编程语言 R，并支持 Azure Jupyter 笔记本(它是微软托管的 Jupyter 笔记本)。
2.  Azure ML Studio(经典)-这是产品的 v1 版本，现在称为“(经典)”。它是用于训练和部署机器学习模型的低代码或无代码交互式可视工作空间环境。由于这是历史版本，它有自己的问题和痛点，例如有 10gb 的训练数据限制，而且模型格式是专有的和不可移植的。
3.  Azure 认知服务——这些是作为 SaaS 成品提供的 API 集。它已经为情绪和情感检测、视觉和语音识别等事情预先构建了模型。
4.  SQL Server 机器学习服务/ ML 服务器-。SQL Server 机器学习服务提供统计分析和预测分析，支持 SQL Server 数据库的 Python 和 R 编程环境。因此，我们可以在 SQL Server 内部构建和部署 ML 模型。微软机器学习服务器是用于预测分析的独立企业服务器。我们可以使用预处理数据构建和部署模型。它是跨平台的，可以在 Windows Server 和 Linux 上运行。

这里的想法是微软从他们的 v1 ML Studio 产品中学到了很多。他们意识到，他们希望给数据科学团队和人工智能工程师一个统一的工作空间，每个团队成员都可以做自己的工作。我们会发现这个新的 Azure 机器学习工作室支持像 Azure 基于角色的访问控制这样的事情，这样你就可以有可能不是数据科学家的人，但更多的 Azure 基础设施专业人员能够控制底层的计算基础设施，然后数据科学家和人工智能工程师，根据他们的背景，他们可以合作，工具将在他们所在的地方满足他们。

在这个讨论中，我们将严格处理机器学习工作室最新版本的当前版本。

> 在继续之前，我想提一下，这篇文章不是关于 ML 算法或模型的。这篇文章是关于我们如何在不使用任何代码的情况下，使用 Azure Machine Learning Studio 图形界面来构建 ML 管道。

## Azure 机器学习服务入门

要构建 ML 管道，首先登录 Azure 门户网站，即[portal.azure.com](https://portal.azure.com/)。打开所有服务，寻找“ *AI+机器学习*”。它会提供多个选项，我们点击*机器学习*。

![](img/5361bf583687b3687f15d06cdc814f38.png)

Select Machine Learning

正如我们所看到的，有多种服务，现在有我们称为 V2 的机器学习服务，还有称为经典的服务，这是 Studio 的旧版本。现在，这将我们带到一个刀片，并要求我们创建“*机器学习工作区*”。

![](img/1dffbe6fba592506a608cfdb75d54a09.png)

Create ML workspace

在继续之前，让我们先了解什么是 ML 工作空间。

## Azure 机器学习工作区(AML 工作区)

Azure ML Workspace 被认为是 Azure 机器学习家族中的顶级资源。它提供了使用 Azure 机器学习服务的集中场所。因此，它就像一个逻辑容器，包含所有资源，并与 Azure 机器学习服务相关联。Azure 为我们提供了创建 AML 工作空间的不同方法，我们可以通过 Azure 门户、用于编程部署的 ARM 模板、Azure CLI、带有 AML 扩展的 VS 代码来创建它，或者我们可以通过使用 AML SDK for Python 或 r 来创建它。对于本文，我们将使用 Azure 门户来创建资源。

因此，当我们创建新的 Azure 机器学习工作区时，我们需要提供资源组、工作区名称和区域。创建新的 AML workspace 时，它会自动创建存储帐户、密钥库、应用洞察和容器注册表。

![](img/b0f33895a566ce23fdf08626401c7571.png)

Create AML Workspace

现在，单击“下一步”添加网络详细信息。我们可以将这里的连接方法限制为公共，或者附加一个私有端点来限制它与特定网络的连接。我们将保留默认值作为公共端点。

![](img/342d651f7b224b6fae40ab1365f9b0a1.png)

Adding Networking Details

接下来我们将提供数据加密类型。在这里，我们可以配置是否要使用 Microsoft 管理的密钥进行加密，或者是否要在整个企业范围内使用一些自定义密钥，然后我们可以在这里提供这些详细信息。我们将保留 Microsoft 管理的密钥。

![](img/feb5d451a62d02b5b393c9a0e2851bd3.png)

Encryption Type

接下来，我们将添加标签并转到“查看+创建”选项卡。在这里，azure 将验证所提供的细节，如果验证通过，它将允许我们通过单击“创建”来创建工作区。

![](img/7722652fefa09bea21f9ee7cc5c88b47.png)

Validate and Create workspace

一旦我们点击创建，一个新的但是空的 Azure 机器学习工作空间将被创建。正如已经提到的，它是一个容纳所有 Azure 机器学习服务资源的容器，我们在 Azure Machine Learning Studio 中执行所有操作。所以我们点击*启动工作室*按钮打开工作室。此外，还有一个链接可以下载与这个工作区相关联的 config.json。开发人员使用它将项目和源代码注册到工作区中。

![](img/0145a0b5c8b5356b271faefd449fd644.png)

AML Workspace is Created

## Azure 机器学习工作室

当我们点击启动工作室时，它将在一个单独的标签中打开，这将我们带到 ml.azure.com 的。

![](img/47786c2d26bf61135b361bc1e65c9b37.png)

当我们登录到 ml.azure.com，我们会得到机器学习的一般模式。它表示，首先在工作空间中注册数据集，接下来的大量工作将是使用各种机器学习算法来训练模型，以生成准确的预测。接下来，我们将根据测试数据评估模型，并最终使用不同的计算目标将模型部署为 webservice。

![](img/c5673ea67bcdb9c5ccf603c74b6db3b4.png)

General Pattern for Machine Learning

Azure ML Studio 分为 3 个部分，即作者、资产和管理。*作者—* 部分为我们提供了使用 Jupyter 笔记本的代码优先方法。如果我们不确定哪种机器学习算法最适合我们，我们可以进行自动化的 ML 运行，Azure 利用大规模并行计算，可以尝试一系列不同的算法，我们可以选择哪种算法最准确。此外，如果我们不舒服的代码，它为我们提供了使用图形设计器。

资产——这里的概念是协作共享工作空间。我们可以注册数据集、实验、创建共享的管道、模型和端点。我们所做的所有更改都被版本化跟踪。我们将在创建管道时详细介绍。

管理—这一部分包含的是管理 Azure 机器学习基础设施，这是我们计算、数据存储和数据标记的地方。我们将在部署管道时进一步了解细节。

## 构建 Azure 机器学习管道

现在我们了解了 Azure ML workspace 和 Azure ML Studio 的基础知识，让我们使用 Designer 创建第一个 ML 管道。因此，单击 Studio 左侧导航中的设计器图标，它将向您显示以下屏幕，其中包含整批样本。在本次讨论中，我们还将使用一个预先构建的模块，即汽车价格预测。

![](img/c36dfae321785f79721818896d96faff.png)

在新管道下，点击“*易于使用的预建模块*，这将创建一个全新的管道。这将打开一个新的屏幕，具有自动保存功能，这是很好的。我建议你继续戴着它。

![](img/575740bc26f19738e7ad32522941015d.png)

现在，正如我们在“设置”中看到的，计算目标已选中，因此让我们通过单击“选择计算目标”链接来选择一个计算目标:

![](img/6cdc7e8a92c651392ac245dde7cef1a4.png)

现在，它将为我们提供两个选项，要么选择现有计算，要么创建新计算。

![](img/9289c07ca900e0093ba6d50eb9735742.png)

因为我们没有任何现有计算机，所以我们可以选择“*创建新的*”。Azure 将向我们推荐一个预定义的配置，如果我们希望控制该集群的外观，就其 CPU、RAM、存储和节点数的分配而言，我们可以先进行计算，然后训练集群。在这里，我们可以使用预定义的配置，因此我们为训练集群提供名称，并单击“*保存*”。

![](img/33f5bb495b3cb579addf34d3e256550a.png)

保存新的训练集群后，我们必须等待一段时间，因为 Azure 将提供所需的资源。我们可以在设置计算目标中检查状态。

![](img/6bf18c811bc59895f1c76697de092a34.png)

一旦训练群集可用，我们将能够选择它作为计算目标。选择计算目标后，我们可以将管道的名称更新为“测试自动价格预测”。

![](img/26cad1896032d38645844a81823e9e9c.png)

如前所述，我们需要做的第一步是引入数据。接下来，我们将扩展数据集类别和一系列用于示例数据的模块。为了获得自定义数据，我们可以将其存储在数据存储中，然后它们将作为数据集在这里可用，但我们在本文中使用的是示例数据集，因此我们将从示例数据集中选择汽车价格数据，并将其拖到 designer 中。

![](img/c2140792642b46e4baded5d37314d724.png)

现在，我们将打开汽车价格数据的设置选项卡，当我们拖动它时，它会自动打开，如果我们需要再次打开它，我们可以选择任务，设置选项卡将重新打开。我们将转到“输出”选项卡，然后单击“可视化”按钮。

![](img/33716e9b9f0c66bfaa3e6ac50a0bd0a3.png)

这向我们展示了这个数据集中的数据是什么样子的。它告诉我们，我们有 26 列和 205 行。

![](img/8a1d5e0e12adb489dacbac11fc061508.png)

我们可以滚动查看，可以看到我们在这个价格数据集中分析的不同类型的数据。基于这些不同的属性，当我们选择其中一个类别时，我们可以在右侧看到一些统计数据，重要的是，包括唯一值和缺失值。我们希望留意包含缺失数据的列，因为这可能会影响我们的模型准确性。

![](img/ec2f16c6bd5e22bb0021f09a474cc736.png)

要清除数据，我们需要对现有列执行操作。为此，我们将从数据转换部分选择“*选择数据集*中的列”。还要注意，这些模块有一个或多个端口。这里汽车价格数据有输出端口，数据集中的选择列有输入端口，我们可以在两者之间拖放一个连接器。

![](img/2de62495aa972e240d9f49e4e4553e45.png)

接下来，我们将选择“*选择数据集*中的列”以打开设置，并单击“*编辑列*以包含特定的列名。

![](img/2b36e01ea3e3135d4fec4140fb8fb4ab.png)

现在，我们查看了数据集，发现有一个名为“*normalized-loss*的列，其中有许多缺失值，因此我们将排除该列。

![](img/11d044aa02ed7d943ded2c1faa0c1e02.png)

为此，我们将首先包含所有列。

![](img/26f5859565dc198e72d337480c59e335.png)

然后将添加一行并排除列名。

![](img/57ccf01abdfe4a0b4ee07e7ee422d080.png)

当我们选择“Exclude”时，它会弹出一个包含所有列名的窗口，我们将选择“ *normalized-losses* ”列

![](img/1f681d0d90ccac511e44b5f420551059.png)

现在我们点击*保存*来保存我们的更改。

![](img/8205adecbf5047bc14f328949a551aea.png)

现在，我们的列已被选中，我们可以注意到，对于添加到管道中的所有这些元素，我们可以更改计算目标。当我们有资源密集型步骤，并希望在单独的集群上运行它时，这很有用。

![](img/33306f29db84542d57c478a8cd6dd444.png)

现在，我们将通过删除丢失的值行来删除丢失的数据。我们将返回模块列表，并在其中“*清除丢失的数据*”。然后我们将拖拽一个连接器"*选择数据集*中的列"模块。

![](img/c70cd3e29ba350b7a29016ee4b25d8cb.png)

对于清洁行，我们将进入配置，在“*清洁模式*下，我们将选择“*移除整行*”。因此，只要有数据丢失，它就会删除整行。我们还需要选择要清理的列，因此我们将点击“*编辑列*”。

![](img/3129e18abb536e312985bfd249403348.png)

我们将得到一个弹出窗口来选择要包含在清理活动中的列。

![](img/e85d5222cf00e966f53719f700d96995.png)

正如我们之前所做的，我们将添加“*排除*规则，并选择“*归一化损失*”。现在将点击*保存*来保存修改。

![](img/63acc1715f253a200aa50807f27cd916.png)

接下来为了训练，我们将把数据分成 2 个数据集，即一个用于训练，一个用于测试。为此，我们将拖放“*拆分数据*”模块。

![](img/5d1b8690a9330ed904e555427a666379.png)

我们注意到“*清除缺失数据*模块有 2 个输出端口，所以我们将“*分割数据*模块与“清除缺失数据”的左侧端口连接。同样在配置“*第一个输出数据集*中的行的分数”中，我们将通过添加值“0.7”将数据集分割成 70:30 的比例。

![](img/13ef35345f446422be5f2ed261fda66c.png)

接下来，我们将训练模型，我们将在此处选择“*线性回归*”模块，该模块位于“*机器学习算法*”下。

![](img/819ab35722c40b172b5fd81be30d77b9.png)

我们还将引入“*模型培训*”下的“培训模型”模块。

![](img/3177f5994eba61084457526e2b455a20.png)

接下来我们将把“*线性回归*与“*列车模型*模块的左侧输入端口连接起来。还将连接“*分割数据*模块左输出端口的左端口与“*列车模型*的右输入端口。

![](img/5269d634d9ffaa122ba1a97380e84551.png)

我们可以看到“*列车型号*模块上有一个错误图标。接下来我们需要告诉哪些列需要预测(这是错误的原因)。为此，我们将打开“*列车模型*模块的配置部分，然后打开“*编辑栏*”。

![](img/9ee916896e285a94da2977dbf339f916.png)

将弹出*标签栏*，在这里我们将选择名称为*价格*，它将预测并点击*保存*

![](img/2d8e27328b0d62a8d143b1d5c0b90eb6.png)

现在我们可以看到错误已经消失，接下来我们将评估模型。

![](img/98d3ba6c53ae6474e8ee363de1078836.png)

为此，我们将把“*模型评分和评估*”下的“*评分模型*模块拖放到画布上。我们将“训练模型”模块的输出端口与“*得分模型*的左侧输入端口相连。

![](img/f4893a73e233c0590833819704658d90.png)

接下来我们将引入“*评估模型*”，并将“*评分模型*”的输出端口与“*评估模型*”的左侧输入端口相连。

![](img/70533c32e71d1544a2756480d6ab1599.png)

现在，我们不能忘记我们在这里的划分，我们将 70%的数据放在培训过程中，但我们还需要将 30%的数据放在测试过程中。因此，为了做到这一点，我们将把“*分割数据*模块的右输出端口连接到“*得分模型*模块的右输入端口。

![](img/559b197b71fe56aca178c5a788b5823e.png)

## 在测试群集上部署 Azure ML 管道

现在我们的模型完成了，我们准备运行它。让我们点击“*提交*”按钮。

![](img/ea8bc33d17eaf9e52ca0bd26c0d83f99.png)

run pipeline

现在将显示一个弹出窗口，选择“*实验*或创建一个新的实验。这个实验本质上是一个容器，类似的管道一起运行。此外，我们需要选择计算目标，如果我们还没有创建，那么我们必须先创建一个，然后才能提交实验。幸运是，我们已经创建了一个“*测试集群*”。

![](img/a48cc45dad716c7682881f0ec657993a.png)

setup pipeline run

因为我们没有，我们将创建一个新的。

![](img/35604c632e577462051c3a796ac1b541.png)

create new experiment

我们将其命名为“*测试-自动-价格-预测-Exp1* ”然后提交。

![](img/0247f98cd4b032e25f0820874fc51e21.png)

Run pipeline

现在我们等待，我们可以看到它处于运行状态。这将需要几分钟完成。

![](img/7357f3ed75d8270789acb9e26e75309a.png)

Pipeline running

我们可以看到当前正在执行的模块的模式。

![](img/dd501a87a9ad53517eb20faabcd0ab3a.png)

Pipeline running

同时，我们可以去查看计算选项卡。在这里，我们可以看到 2 个节点已经启动并运行。

![](img/5d755560171ebd5d766113e0d1ea97ce.png)

test cluster created

我们可以通过点击“*测试集群*”来查看详细信息

![](img/291a5902133330d3973e94a83b44c5bc.png)

test cluster details

好了，现在我们可以看到所有模块都成功执行了。

![](img/e37b376e5759c851f6b890fffc0bce6e.png)

Pipeline executed

现在我们将首先检查分数模型。我们将转到“*输出+日志*”并点击“*可视化*”图标。

![](img/c6524f1b69e6896571c6a3ae36808c83.png)

Score Model

“*评分模型*”可视化弹出窗口将打开，然后我们将在其中查找“*价格*”字段。请记住，在配置“*列车模型*模块时，它是我们选择用于预测的同一列。“*价格*列包含原始汽车价格，我们也看到它旁边的得分价格。我们的目标是看看我们的线性回归机器学习模型对这些价格的预测有多接近。

![](img/6f5f401e6cce3a75d73df704ecc23bbb.png)

Visualize Score Model

接下来，我们将查看评估数据，为此，我们将“*评估模型*”配置，并再次单击“T10 可视化 T11”图标。

![](img/c4f6283dbe1c4182d0ca687300393a81.png)

Evaluate Model

有各种错误统计数据可用。这些误差统计值越小越好。这里我们将寻找“决定系数”，它应该接近于 1。正如我们在下面看到的，这是一个非常好的模型。

![](img/8b3a3954339e709d1b6f92b377107a72.png)

Visualize Evaluate Model

## 推理管道

接下来，我们将创建推理管道。当我们点击"*提交*按钮旁边的下拉"*创建推理管道*"按钮时，我们会看到两个选项"*实时推理管道*"和"*批量推理管道*"。我们将选择“*实时推理管道*”。

![](img/5fe5aa3f58fa68de9db3aecc9f38b0f9.png)

Select real-time inference pipeline

当我们创建一个将被一般化的推理管道时，训练模块消失了，我们可以注意到 Azure 增加了一个“ *Web 服务输入*和一个“ *Web 服务输出*模块。

![](img/e799a235801070a171c7061c09a9c1b6.png)

Creating real-time inference pipeline

大部分工作已经为我们完成，所以我们需要"*提交*"它，以确保模型仍然工作良好。我们可以重用以前创建并运行过实验。

![](img/9975a5375d5123eb2d6cb41c5d8a182b.png)

Setup pipeline run

为此，我们将使用相同的培训集群，即“*测试集群*”，然后单击“*提交*

![](img/4a94e0fd3ea30206f60ac6735a9e6ba4.png)

Submitting pipeline

我们可以看到它处于运行状态。这样我们就有机会创建“*推理簇*”。

![](img/b622cc25f035bdb2a12e725a07396c90.png)

Pipeline Submitted

我们将转到“*计算*选项卡并打开“*推理集群*”。目前没有可用的群集。我们将创建一个活动的 AKS 集群，为终端本身运行。所以我们会点击*新建*。

![](img/9b745f21fde510a4f6a723492826fb9e.png)

Inference Cluster tan

在“ *Kubernetes Services* 下，我们将选择“*创建新的*”单选按钮，并将位置选择为“*美国东部*”。

![](img/2bc10440d1b711593af8ccbcd041f874.png)

Select VM

现在，它将为我们提供选择虚拟机系列作为计算的选项。我们将选择“*标准 _D2_v2* ”。我们可以根据我们的计算要求选择任何其他虚拟机。

![](img/467f46e8fac3b7b70cee88c34fe69d52.png)

select VM family

接下来，我们必须提供其他配置，如计算机名称、集群用途、网络和 SSL 配置。我们将选择“*开发测试*”作为具有 2 个节点的群集用途，“基本”作为网络配置，对于此演示，将保持 SSL 配置处于禁用状态。现在，我们将点击“创建”。

![](img/0a89309aa4c8f30f02a2d93d1e2549d7.png)

Create AKS cluster

正如我们所看到的，它处于创建状态，创建大约需要 15–20 分钟。

![](img/eb8aa5e232f079fe9b1559fe1dfe742f.png)

AKS cluster creating

一旦群集准备就绪，状态将变为“成功”。

![](img/9b66c1d2f6be4988b9969d6e9e4a8736.png)

AKS cluster created

现在我们将回到已经成功运行的"*实时推理管道*。我们将点击*部署*。

![](img/8dc3b1f919d12560c32ad085e94ea6d3.png)

Deploy

它将要求我们可以"*部署一个新的实时端点*"或者我们可以替换一个现有的。我们将保留名称为“ *testdeployment* ”，并选择计算类型为“ *Azure Kubernetes Service* ”。接下来，我们将从我们刚刚创建的下拉列表中选择我们的计算名称“ *Test-ML-Cluster* ”。然后点击*部署*。

![](img/5da02c25f4da093d9a6ab2c769d91690.png)

Deploy to AKS

正如我们在横幅上看到的，它正在创建端点。

![](img/100fddf3e495b2f758a13b2eb155002e.png)

pipeline deploying

现在部署成功了，我们将点击链接“*查看实时端点*”。

![](img/d1eabe0eeb90778e10d7051c139ca99c.png)

Pipeline deployed

它将在单独的选项卡中打开。在详细信息页面上，我们可以看到端点的实际 URL。它还将提供我们是使用基于密钥还是基于令牌的身份验证的信息。

![](img/50c705623820c09dc92c003b3ed05475.png)

Details tab

它还为我们提供了 swagger 文档的 URL 和草案管道的直接链接。

![](img/bf5f6837561d50188cce378924210141.png)

Details tab

在“消费”选项卡上，我们可以找到将与我们的开发人员和数据科学家共享的信息。我们还可以使用基于密钥或令牌的方式来配置身份验证。然后我们有 C#，python 和 r 的消费源代码。

![](img/8d9cfd943d6f709b861df29c1a3d8dc7.png)

Consume Tab

在“ *Test* ”选项卡 Azure 下，放入一些来自原始训练集的样本数据。目的是我们可以在这里提供实时数据，单击“ *Test* ”并通过管道运行并获得结果。

![](img/d5106e32be54c79596c84978f2bf5742.png)

Test tab

如果我们回到我们的*管道*，看到我们的管道有 3 条

![](img/dc0b70342b860b03274c84b909e00441.png)

Pipelines runs

如果我们转到“数据集”选项卡，我们可以看到我们的训练和测试数据集。

![](img/0903acf54a20238fab89a3e77b03cf17.png)

Datasets

如果我们调查原始资源组。这些是将被创造的资源。

![](img/de0c42cd125abc90b6eec8f24da1a281.png)

Resources in resource group

下一个重要步骤是清理资源，这样我们就不会为消耗的资源付费…