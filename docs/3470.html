<html>
<head>
<title>Deploy Pre-Trained Keras Image Classification Model on AWS SageMaker Endpoint for Inference</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在AWS SageMaker端点上部署预训练的Keras图像分类模型以进行推理</h1>
<blockquote>原文：<a href="https://medium.com/mlearning-ai/deploy-pre-trained-keras-image-classification-model-on-aws-sagemaker-endpoint-for-inference-c120e3e1de90?source=collection_archive---------1-----------------------#2022-09-07">https://medium.com/mlearning-ai/deploy-pre-trained-keras-image-classification-model-on-aws-sagemaker-endpoint-for-inference-c120e3e1de90?source=collection_archive---------1-----------------------#2022-09-07</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><p id="96d3" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在上一篇文章(下面的链接)中，我实现了一个卷积神经网络来对来自CIFAR-10数据集的图像进行分类。这是一个典型的ML工作流，从数据导入、训练、调优和推理的所有步骤都在我们钟爱的IDE中本地进行。</p><figure class="jd je jf jg fd jh er es paragraph-image"><div role="button" tabindex="0" class="ji jj di jk bf jl"><div class="er es jc"><img src="../Images/d054e806cab018eb459730aae4203ce8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*INefJ3pB3Sxeh3pM"/></div></div><figcaption class="jo jp et er es jq jr bd b be z dx">Photo by <a class="ae js" href="https://unsplash.com/@vinhan?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">An Tran</a> on <a class="ae js" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><div class="jt ju ez fb jv jw"><a rel="noopener follow" target="_blank" href="/mlearning-ai/cifar-10-image-classification-linear-model-vs-cnn-e1596ec2be26"><div class="jx ab dw"><div class="jy ab jz cl cj ka"><h2 class="bd hi fi z dy kb ea eb kc ed ef hg bi translated">CIFAR-10图像分类:线性模型与CNN</h2><div class="kd l"><h3 class="bd b fi z dy kb ea eb kc ed ef dx translated">计算机视觉的应用在过去十年里急剧上升，这要归功于…</h3></div><div class="ke l"><p class="bd b fp z dy kb ea eb kc ed ef dx translated">medium.com</p></div></div><div class="kf l"><div class="kg l kh ki kj kf kk jm jw"/></div></div></a></div><p id="04eb" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在本文中，我概述了我第一次尝试将相同的(几乎)模型部署到AWS SageMaker (SM)进行推理。对于那些不太熟悉这项服务的人来说，简而言之，SM是一个云无服务器平台，可以在ML生命周期的所有阶段为您提供帮助，从导入数据、培训、调整和部署经过培训的模型到大规模生产。欲了解更多信息，请访问下面的文章进行概述。</p><div class="jt ju ez fb jv jw"><a href="https://www.analyticsvidhya.com/blog/2022/05/an-introduction-to-aws-sagemaker-for-beginners/" rel="noopener  ugc nofollow" target="_blank"><div class="jx ab dw"><div class="jy ab jz cl cj ka"><h2 class="bd hi fi z dy kb ea eb kc ed ef hg bi translated">AWS Sagemaker初学者入门-分析Vidhya</h2><div class="kd l"><h3 class="bd b fi z dy kb ea eb kc ed ef dx translated">这篇文章作为数据科学博客的一部分发表。数据科学家需要创建、培训和部署…</h3></div><div class="ke l"><p class="bd b fp z dy kb ea eb kc ed ef dx translated">www.analyticsvidhya.com</p></div></div><div class="kf l"><div class="kl l kh ki kj kf kk jm jw"/></div></div></a></div><p id="2a0a" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">然而，训练通常是计算量最大的任务，由于成本或技术不熟悉，使用SM内置训练作业可能不是所有情况下的最理想选择，尤其是当我们都太习惯于在其他地方训练和优化我们的模型时。幸运的是，SM提供了将您训练好的模型用于推理任务的方法。另一方面，这个任务的实际实现并不简单，尤其是对于不熟悉许多云计算概念的初学者(比如我)。有不同的方法来部署一个训练好的模型，并且不同类型的模型(例如，sklearn、keras、torch……)有它们自己的部署变化。</p><p id="c798" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">所有这些使得第一次尝试进入这个美丽的大规模生产水平ML的世界是一个非常陡峭的学习曲线。为了完成这项任务，需要从各种来源进行改编，而网络社区使这成为可能。</p><p id="941c" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">经过几天(痛苦的)学习(和谷歌搜索)，以下是这个特殊案例的主要步骤:</p><ol class=""><li id="94c3" class="km kn hh ig b ih ii il im ip ko it kp ix kq jb kr ks kt ku bi translated">在本地对模型进行定型，然后对其进行测试，以确保正确的模型输入数据类型和推断格式。</li><li id="3e36" class="km kn hh ig b ih kv il kw ip kx it ky ix kz jb kr ks kt ku bi translated">将训练好的模型导出到. h5和。json文件</li><li id="ff20" class="km kn hh ig b ih kv il kw ip kx it ky ix kz jb kr ks kt ku bi translated">将这些文件上传到SM笔记本，并将权重加载到json结构中，以创建加载的模型对象。</li><li id="9524" class="km kn hh ig b ih kv il kw ip kx it ky ix kz jb kr ks kt ku bi translated">将这个模型对象转换成SM使用的<strong class="ig hi">格式和文件结构。</strong></li><li id="7257" class="km kn hh ig b ih kv il kw ip kx it ky ix kz jb kr ks kt ku bi translated">将模型注册到SM模型目录，然后将其部署到一个端点进行推理。</li><li id="43f0" class="km kn hh ig b ih kv il kw ip kx it ky ix kz jb kr ks kt ku bi translated">调用端点进行样本预测。</li></ol><p id="3754" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">现在，让我们深入细节。</p><h1 id="748a" class="la lb hh bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">1.在本地训练、测试和导出模型</h1><p id="91e6" class="pw-post-body-paragraph ie if hh ig b ih ly ij ik il lz in io ip ma ir is it mb iv iw ix mc iz ja jb ha bi translated">我按照上面链接中解释的相同步骤来重新训练CIFAR-10数据集，只是仅针对5个时期，牺牲了时间的准确性(75%)，因为我们只关注部署模型而不是准确性方面。在导出模型之前，让我们做一些测试。注意，在这一整节中，我们还没有触及SM。(你可以在这里找到包括培训、测试和导出<a class="ae js" href="https://github.com/joshuavaple/cifar-10-for-sagemaker.git" rel="noopener ugc nofollow" target="_blank">在内的整个笔记本)。</a></p><p id="c7b9" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">首先，我们可以从测试集中抽取一幅随机图像。这一次，返回index = 8777的飞机图像。</p><figure class="jd je jf jg fd jh"><div class="bz dy l di"><div class="md me l"/></div></figure><figure class="jd je jf jg fd jh er es paragraph-image"><div class="er es mf"><img src="../Images/58f3f92aadfb4649a3b6a9de62dfe492.png" data-original-src="https://miro.medium.com/v2/resize:fit:464/format:webp/1*nfqzs7-1NvblN8QbPcvZGw.png"/></div></figure><p id="445f" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">现在，让我们将图像数组传递回训练好的模型。调用<code class="du mg mh mi mj b">reshape()</code>方法只是为了确保图像尺寸符合模型期望的输入形状。</p><figure class="jd je jf jg fd jh"><div class="bz dy l di"><div class="md me l"/></div></figure><p id="e05b" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">模型返回如下，表示输入图像形状为32×32像素，3个通道，最高类概率为第一个，对应类名飞机。</p><pre class="jd je jf jg fd mk mj ml mm aw mn bi"><span id="8fa7" class="mo lb hh mj b fi mp mq l mr ms">(32, 32, 3)</span><span id="16ad" class="mo lb hh mj b fi mt mq l mr ms">[[9.7909743e-01 1.9577092e-05 1.3614256e-03 3.2661922e-06 7.3834424e-05 1.8172224e-07 8.5703596e-07 9.3790965e-07 1.9413525e-02 2.8970726e-05]]</span><span id="6179" class="mo lb hh mj b fi mt mq l mr ms">airplane</span></pre><p id="ec2c" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">接下来，让我们将此图像导出到一个. jpeg文件，图像索引号用作名称的一部分，以便于识别。然后，我们将导入这个图像并再次运行这个模型。执行此步骤是为了模拟稍后通过导入和外部映像来测试模型的过程，并确认代码可以在SM笔记本环境中重用以测试下游映像。</p><figure class="jd je jf jg fd jh"><div class="bz dy l di"><div class="md me l"/></div><figcaption class="jo jp et er es jq jr bd b be z dx">export the random image to .jpeg</figcaption></figure><figure class="jd je jf jg fd jh"><div class="bz dy l di"><div class="md me l"/></div><figcaption class="jo jp et er es jq jr bd b be z dx">import the .jpeg image and pass it to the model</figcaption></figure><p id="6a81" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">这里不出意外，模型正确返回以下内容，表明它是一架飞机。名为<code class="du mg mh mi mj b">img-9777.jpeg</code>的图像文件(现在与笔记本一起保存在本地目录中)稍后将用于在线测试我们的模型。</p><pre class="jd je jf jg fd mk mj ml mm aw mn bi"><span id="af53" class="mo lb hh mj b fi mp mq l mr ms">[[1. 0. 0. 0. 0. 0. 0. 0. 0. 0.]] </span><span id="143e" class="mo lb hh mj b fi mt mq l mr ms">airplane</span></pre><p id="bd1b" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">由于测试是令人满意的，我们可以通过下面的代码将模型工件导出到两个文件中:一个. json文件和一个. h5文件(改编自本文<a class="ae js" rel="noopener" href="/@baraaalbourghli/deploy-your-keras-or-tensorflow-machine-learning-model-to-aws-using-amazon-sagemaker-how-to-2d88a6e779cc">文章</a>)。运行此代码块后，将在同一本地文件夹中创建这两个文件。我们现在已经完成了前两步。使用本地环境到此结束，让我们转移到SageMaker。</p><figure class="jd je jf jg fd jh"><div class="bz dy l di"><div class="md me l"/></div></figure><h1 id="d0f6" class="la lb hh bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">2.准备在SM笔记本中部署模型</h1><p id="9dcd" class="pw-post-body-paragraph ie if hh ig b ih ly ij ik il lz in io ip ma ir is it mb iv iw ix mc iz ja jb ha bi translated">在我们开始之前，请注意这些步骤可以通过SM控制台上的点击方式来完成(查看下面Mike Chambers的YouTube系列，获得一个很好的演示)。</p><figure class="jd je jf jg fd jh"><div class="bz dy l di"><div class="mu me l"/></div></figure><p id="6453" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">然而，我发现在笔记本环境中执行它们更便于故障排除。我不会过多地探究AWS控制台上的逐步导航或关于AWS角色、可访问性等的细节。，而是专注于手头的核心任务。如果你需要澄清，请给我留下评论/问题。现在让我们继续读下去。</p><p id="7843" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">让我们在SM控制台中启动一个笔记本实例。在里面，创建一个文件夹并上传我们上面创建的两个文件。</p><figure class="jd je jf jg fd jh er es paragraph-image"><div class="er es mv"><img src="../Images/78773708fcb30ddb955d0869600041d0.png" data-original-src="https://miro.medium.com/v2/resize:fit:820/format:webp/1*HgMqkriyRZUd-H9iCXwe5g.png"/></div></figure><p id="1301" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">现在，我们可以通过执行以下代码将这两个文件“组合”成一个加载的模型对象，这些代码改编自<a class="ae js" href="https://www.youtube.com/watch?v=RPnvfxR5DY8&amp;t=537s" rel="noopener ugc nofollow" target="_blank">数据Liam </a>。请注意，上面这个文件夹的目录用于打开和加载必要的文件。</p><figure class="jd je jf jg fd jh"><div class="bz dy l di"><div class="md me l"/></div></figure><p id="8305" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">接下来，我们通过运行下面的代码块来执行前面大纲中的步骤4。这是根据Liam的方法改编的，也是Peter Van Katwyk在这篇<a class="ae js" href="https://stackoverflow.com/questions/67505781/loading-pretrained-keras-to-sagemaker-local-classification-works-but-sagemaker" rel="noopener ugc nofollow" target="_blank">帖子</a>中的贡献，它似乎帮助我解决了目前SM上使用更新的TF版本的问题。总之，这些代码编写了一个特定的文件夹结构(在创建的<code class="du mg mh mi mj b">export </code>文件夹中), SM需要它来注册模型工件，然后将它压缩到一个<code class="du mg mh mi mj b">.tar.gz</code>文件中。在SM笔记本环境中，您应该会在与您的主笔记本文件相同的位置下看到该文件。</p><figure class="jd je jf jg fd jh"><div class="bz dy l di"><div class="md me l"/></div></figure><h1 id="8c02" class="la lb hh bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">3.创建和部署模型</h1><p id="92c2" class="pw-post-body-paragraph ie if hh ig b ih ly ij ik il lz in io ip ma ir is it mb iv iw ix mc iz ja jb ha bi translated">期待已久的步骤来了。模型工件已经压缩好了，下一步是将它上传到S3桶中。一旦完成，就可以基于S3上传的文件建立一个SM模型(这是AWS喜欢做的)，并注册到模型目录中。最后，它被部署到一个端点。请看下面代码中的注释以获得更清晰的内容，改编自上面Liam的视频。</p><figure class="jd je jf jg fd jh"><div class="bz dy l di"><div class="md me l"/></div></figure><p id="f9b5" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">您可以随时检查SM控制台上的以下位置，以查看新型号、端点配置和端点的存在。一旦端点被标记为“InService ”,请记下该端点的名称，以便稍后执行推理任务。</p><figure class="jd je jf jg fd jh er es paragraph-image"><div class="er es mw"><img src="../Images/a6a14540e93f124a8591795cf19aa9e9.png" data-original-src="https://miro.medium.com/v2/resize:fit:532/format:webp/1*7fd76MmC291wL5X_CVAuDA.png"/></div></figure><figure class="jd je jf jg fd jh er es paragraph-image"><div role="button" tabindex="0" class="ji jj di jk bf jl"><div class="er es mx"><img src="../Images/b0f34ce97b5b328e08cdf608f34b9f90.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*afq5kRnPzZn0nUkO90_IAw.png"/></div></div><figcaption class="jo jp et er es jq jr bd b be z dx">endpoint name</figcaption></figure><h1 id="fba3" class="la lb hh bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">4.使用模型端点的推断</h1><p id="fc48" class="pw-post-body-paragraph ie if hh ig b ih ly ij ik il lz in io ip ma ir is it mb iv iw ix mc iz ja jb ha bi translated">最后，为了测试端点是否正常工作，这意味着它可以接收输入，运行模型，并返回预测，我们首先将之前保存的图像<code class="du mg mh mi mj b">img-9777.jpeg</code>上传到SM笔记本目录。然后，在同一个笔记本中调用以下代码来调用端点并使其工作。注意，您必须将自己的端点名传递给变量<code class="du mg mh mi mj b">endpoint_name.</code></p><figure class="jd je jf jg fd jh"><div class="bz dy l di"><div class="md me l"/></div></figure><p id="db8b" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">这种情况下的结果就是<code class="du mg mh mi mj b">airplane</code>。请注意，在测试步骤中，我们使用了与第1节相同的编码结构。因此，在使模型适应SM环境之前，总是离线测试您的代码，并让模型工作。</p><p id="ed98" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">重要提示:完成实验后删除端点，以避免产生额外费用。</p><h1 id="e1b4" class="la lb hh bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">5.结论和今后的改进</h1><p id="0ec3" class="pw-post-body-paragraph ie if hh ig b ih ly ij ik il lz in io ip ma ir is it mb iv iw ix mc iz ja jb ha bi translated">这是我遇到的最陡的学习曲线之一，因为我对云计算，尤其是AWS，知之甚少。然而，在线社区提供的资源极大地帮助了我完成这项工作。我有一个值得注意的观察，Peter在他的帖子中也提到了，SM返回的类概率与本地IDE不一样。他设法用一个旧的TF版本解决了这个问题，这可能是不可持续的，我也没能执行。这将是这个职位的未来修订的机会。</p><p id="941f" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">非常感谢您的评论和建议来改进这篇文章，并随时通过我的<a class="ae js" href="https://www.linkedin.com/in/levuanhphuong/" rel="noopener ugc nofollow" target="_blank"> LinkedIn </a>联系我。</p><p id="ed41" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi"> <em class="my">主要引用:</em> </strong></p><ul class=""><li id="449d" class="km kn hh ig b ih ii il im ip ko it kp ix kq jb mz ks kt ku bi translated"><a class="ae js" rel="noopener" href="/@baraaalbourghli/deploy-your-keras-or-tensorflow-machine-learning-model-to-aws-using-amazon-sagemaker-how-to-2d88a6e779cc">https://medium . com/@ baraalbourghli/deploy-your-keras-or-tensor flow-machine-learning-model-to-AWS-using-Amazon-sage maker-how-to-2d 88 a6e 779 cc</a></li><li id="ac26" class="km kn hh ig b ih kv il kw ip kx it ky ix kz jb mz ks kt ku bi translated"><a class="ae js" href="https://stackoverflow.com/questions/67505781/loading-pretrained-keras-to-sagemaker-local-classification-works-but-sagemaker" rel="noopener ugc nofollow" target="_blank">https://stack overflow . com/questions/67505781/loading-pre trained-keras-to-sage maker-local-class ification-works-but-sage maker</a></li><li id="6584" class="km kn hh ig b ih kv il kw ip kx it ky ix kz jb mz ks kt ku bi translated"><a class="ae js" href="https://stackoverflow.com/questions/56192998/tensorflow-2-0-0a0-attributeerror-module-tensorflow-has-no-attribute-glob" rel="noopener ugc nofollow" target="_blank">https://stack overflow . com/questions/56192998/tensor flow-2-0-0a 0-attribute error-module-tensor flow-has-no-attribute-glob</a></li><li id="3237" class="km kn hh ig b ih kv il kw ip kx it ky ix kz jb mz ks kt ku bi translated"><a class="ae js" href="https://www.youtube.com/watch?v=RPnvfxR5DY8&amp;t=537s" rel="noopener ugc nofollow" target="_blank">https://www.youtube.com/watch?v=RPnvfxR5DY8&amp;t = 537s</a></li><li id="de8b" class="km kn hh ig b ih kv il kw ip kx it ky ix kz jb mz ks kt ku bi translated"><a class="ae js" href="https://aws.amazon.com/blogs/machine-learning/deploy-trained-keras-or-tensorflow-models-using-amazon-sagemaker/" rel="noopener ugc nofollow" target="_blank">https://AWS . Amazon . com/blogs/machine-learning/deploy-trained-keras-or-tensor flow-models-using-Amazon-sage maker/</a></li></ul><div class="jt ju ez fb jv jw"><a rel="noopener follow" target="_blank" href="/mlearning-ai/mlearning-ai-submission-suggestions-b51e2b130bfb"><div class="jx ab dw"><div class="jy ab jz cl cj ka"><h2 class="bd hi fi z dy kb ea eb kc ed ef hg bi translated">Mlearning.ai提交建议</h2><div class="kd l"><h3 class="bd b fi z dy kb ea eb kc ed ef dx translated">如何成为Mlearning.ai上的作家</h3></div><div class="ke l"><p class="bd b fp z dy kb ea eb kc ed ef dx translated">medium.com</p></div></div><div class="kf l"><div class="na l kh ki kj kf kk jm jw"/></div></div></a></div></div></div>    
</body>
</html>