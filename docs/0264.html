<html>
<head>
<title>Tensorflow 2.4 with CUDA 11.2 -GPU training fix</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">带CUDA 11.2的tensor flow 2.4-GPU培训修复</h1>
<blockquote>原文：<a href="https://medium.com/mlearning-ai/tensorflow-2-4-with-cuda-11-2-gpu-training-fix-87f205215419?source=collection_archive---------0-----------------------#2021-03-13">https://medium.com/mlearning-ai/tensorflow-2-4-with-cuda-11-2-gpu-training-fix-87f205215419?source=collection_archive---------0-----------------------#2021-03-13</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><p id="ee5e" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><em class="jc"> Tensorflow 2.4.0培训失败，出现错误“找不到libcusolver.so.10 not】</em></p><p id="8c35" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi">简介:</strong>在这篇文章中，我将分享我的经验，当我的培训从TF 2.3.1的CPU而不是GPU开始时，我通过快速故障排除节省了一些时间。那当然是不可取的:)。有一次升级到2.4.0，在训练的时候崩溃了。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es jd"><img src="../Images/2d6fc1db156b4d037884a4c084c52075.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Pyyzj9jbPFVyoUnWEtRCqw.png"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx"><a class="ae jt" href="https://github.com/tensorflow/docs" rel="noopener ugc nofollow" target="_blank">source</a></figcaption></figure><p id="c3ed" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">系统信息:</p><ul class=""><li id="b411" class="ju jv hh ig b ih ii il im ip jw it jx ix jy jb jz ka kb kc bi translated">操作系统Linux Ubuntu 18.04 Ubuntu 20.04</li><li id="ed90" class="ju jv hh ig b ih kd il ke ip kf it kg ix kh jb jz ka kb kc bi translated">TensorFlow版本:2.4.0(原来是2.3.1后来升级到2.4.0)</li><li id="c632" class="ju jv hh ig b ih kd il ke ip kf it kg ix kh jb jz ka kb kc bi translated">Python版本:3.6.9</li><li id="ac9c" class="ju jv hh ig b ih kd il ke ip kf it kg ix kh jb jz ka kb kc bi translated">使用virtualenv安装</li><li id="25de" class="ju jv hh ig b ih kd il ke ip kf it kg ix kh jb jz ka kb kc bi translated">CUDA 11.2 / cuDNN 8.1</li><li id="cdb8" class="ju jv hh ig b ih kd il ke ip kf it kg ix kh jb jz ka kb kc bi translated">GPU K 80驱动程序版本460.27.04</li></ul><p id="7bf2" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">当我开始我的训练时，它成功地开始了。但是没有使用GPU，而是从CPU开始。我用的是TensorFlow 2.3.1。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es ki"><img src="../Images/f5807ddb4d0518c1d11502ac29ec53fa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*TMszfC5mA_ppWjN2G24rbA.png"/></div></div></figure><p id="e0a5" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi">第一步:查看GPU利用率</strong></p><p id="ebba" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">这是确定GPU是否被利用的基本步骤。</p><pre class="je jf jg jh fd kj kk kl km aw kn bi"><span id="0196" class="ko kp hh kk b fi kq kr l ks kt">&gt;&gt; nvidia-smi <br/></span></pre><p id="1d6b" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我可以清楚地看到我的GPU没有被利用，并且在底部有一个清晰的消息“没有找到正在运行的进程。”</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es ku"><img src="../Images/fd7f9a1e5055d7e3f82bf4aa1a82c8f5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JYcURV2xW6nlmGaxz-ol1w.png"/></div></div></figure><p id="fcc3" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">这时候我升级到2.4.0，然后再次尝试训练模型。现在不是训练，而是训练没有开始。</p><p id="4275" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi">第二步:查看日志</strong></p><p id="e8fb" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我查看了训练日志的开始部分，当时网络已经初始化，TensorFlow框架正在为训练做准备。</p><p id="54ff" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我发现了一个非常有趣的错误，如下</p><pre class="je jf jg jh fd kj kk kl km aw kn bi"><span id="b52b" class="ko kp hh kk b fi kq kr l ks kt">“Could not load dynamic library ‘libcusolver.so.10’; dlerror: libcusolver.so.10: cannot open shared object file: No such file or directory”</span></pre><p id="12df" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">此时，我知道当CUDA试图初始化时，突出显示的链接库有问题。</p><p id="f00b" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi">步骤3:为缺失的-libcusolver . so . 11</strong>创建一个符号链接</p><p id="bdfd" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">谷歌了一下，我发现了下面的修复:我用下面的命令创建了符号链接</p><pre class="je jf jg jh fd kj kk kl km aw kn bi"><span id="2a75" class="ko kp hh kk b fi kq kr l ks kt">&gt;&gt; sudo ln -s /usr/local/cuda-11.1/targets/x86_64-linux/lib/libcusolver.so.11 /usr/local/cuda-11.1/targets/x86_64-linux/lib/libcusolver.so.10</span></pre><p id="4fbe" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">之后，您可以前往以下位置:</p><pre class="je jf jg jh fd kj kk kl km aw kn bi"><span id="47e2" class="ko kp hh kk b fi kq kr l ks kt">&gt;&gt; cd /usr/local/cuda-11.2/targets/x86_64-linux/lib</span><span id="263e" class="ko kp hh kk b fi kv kr l ks kt">&gt;&gt; ll</span></pre><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es kw"><img src="../Images/71f32984b3c17f22e6d8d0f418c19318.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*sRZ5FBXmt2C8FF6lPeJe8g.png"/></div></div></figure><p id="a5c8" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi">第四步:针对GPU运行时利用率的Tensorflow验证。</strong></p><p id="ad9c" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">测试Tensorflow是否在GPU运行时加载以下代码和GPU可用于TensorFlow。</p><pre class="je jf jg jh fd kj kk kl km aw kn bi"><span id="6968" class="ko kp hh kk b fi kq kr l ks kt">import tensorflow as tf</span><span id="c62d" class="ko kp hh kk b fi kv kr l ks kt">tf.test.is_gpu_available(<br/>    cuda_only=False, min_cuda_compute_capability=None<br/>)</span></pre><p id="c3d1" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">如果一切都很好，那么上述结果将为“真”，否则为“假”。我收到了下面的消息。</p><pre class="je jf jg jh fd kj kk kl km aw kn bi"><span id="d54b" class="ko kp hh kk b fi kq kr l ks kt">2021–03–13 04:40:11.366832: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1406] Created TensorFlow device (/device:GPU:0 with 142 MB memory) -&gt; physical GPU (device: 0, name: Tesla K80, pci bus id: 0000:00:1e.0, compute capability: 3.7)<br/>True</span></pre><p id="35d3" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">二者择一地</p><pre class="je jf jg jh fd kj kk kl km aw kn bi"><span id="612a" class="ko kp hh kk b fi kq kr l ks kt">import tensorflow as tf</span><span id="10d2" class="ko kp hh kk b fi kv kr l ks kt">physical_devices = tf.config.list_physical_devices('GPU') <br/>print("Num GPUs:", len(physical_devices))</span></pre><p id="5aa6" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">如果一切正常，上述结果将为0，否则为1。</p><pre class="je jf jg jh fd kj kk kl km aw kn bi"><span id="b174" class="ko kp hh kk b fi kq kr l ks kt">&gt;&gt;&gt; print("Num GPUs:", len(physical_devices))<br/>Num GPUs: 1</span></pre><p id="a470" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi">第五步:开始训练</strong></p><p id="4ab3" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">一旦我完成了上面的修复和验证，我就开始了我的训练，到目前为止一切顺利。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es kx"><img src="../Images/35674e0c5c000108f7b0f07d354c7424.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yQCJBxjJxcaeSmXZGVjASw.png"/></div></div></figure><p id="bc9e" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi">第六步:再次检查GPU</strong></p><pre class="je jf jg jh fd kj kk kl km aw kn bi"><span id="859d" class="ko kp hh kk b fi kq kr l ks kt">&gt;&gt; nvidia-smi</span></pre><p id="5c2e" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">给你:</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es ky"><img src="../Images/107fbaca4265036b099cdf39dc54db9e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*a93XQRGXjrOfTdqVdrzhzw.png"/></div></div></figure><p id="068c" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">当然，它比CPU快得多，至少快50倍。</p><p id="6551" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我希望它有帮助。</p></div></div>    
</body>
</html>