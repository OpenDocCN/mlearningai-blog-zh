<html>
<head>
<title>Cell Instance Segmentation Using Mask R-CNN</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用掩模R-CNN的细胞实例分割</h1>
<blockquote>原文：<a href="https://medium.com/mlearning-ai/cell-instance-segmentation-using-mask-r-cnn-c7a3810192ff?source=collection_archive---------2-----------------------#2022-01-05">https://medium.com/mlearning-ai/cell-instance-segmentation-using-mask-r-cnn-c7a3810192ff?source=collection_archive---------2-----------------------#2022-01-05</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><p id="f2d8" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">通过构建细胞实例解释分割训练和推理</p><p id="d200" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">下面是我们<strong class="ig hi"><em class="jc"/></strong><a class="ae jd" href="https://colab.research.google.com/drive/1zvcp88bTlly_XMkK6G6HXZvA_vk5MP7i?usp=sharing" rel="noopener ugc nofollow" target="_blank"><strong class="ig hi"><em class="jc">Colab笔记本</em> </strong> </a>的链接</p><h2 id="19b7" class="je jf hh bd jg jh ji jj jk jl jm jn jo ip jp jq jr it js jt ju ix jv jw jx jy bi translated">1.简介:</h2><p id="3e2b" class="pw-post-body-paragraph ie if hh ig b ih jz ij ik il ka in io ip kb ir is it kc iv iw ix kd iz ja jb ha bi translated"><a class="ae jd" href="https://www.kaggle.com/c/sartorius-cell-instance-segmentation/overview" rel="noopener ugc nofollow" target="_blank">细胞实例分割</a>:是由生命科学研究和生物制药行业的合作伙伴Sartorius主办的Kaggle竞赛。在这场比赛中，我们的任务是在描述神经疾病研究中常用的神经元细胞类型的生物图像中检测和描绘不同的感兴趣对象。这项任务具有挑战性，因为它需要正确检测图像中的所有对象，同时还需要精确分割每个实例。</p><p id="90aa" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><a class="ae jd" href="https://engineering.matterport.com/splash-of-color-instance-segmentation-with-mask-r-cnn-and-tensorflow-7c761e238b46" rel="noopener ugc nofollow" target="_blank"> Mask R-CNN: </a>(区域卷积神经网络)在图像分割和实例分割方面是最先进的。Mask R-CNN建立在更快的R-CNN之上，这是一个流行的对象检测框架。在这个框架中有两个阶段:</p><ul class=""><li id="93c5" class="ke kf hh ig b ih ii il im ip kg it kh ix ki jb kj kk kl km bi translated">第一阶段称为<strong class="ig hi">区域提议网络</strong> (RPN)，提议候选对象边界框。</li><li id="b093" class="ke kf hh ig b ih kn il ko ip kp it kq ix kr jb kj kk kl km bi translated">第二阶段从每个候选框中提取特征，并执行分类、边界框回归和<strong class="ig hi">二元掩码</strong>。</li></ul><h2 id="c718" class="je jf hh bd jg jh ji jj jk jl jm jn jo ip jp jq jr it js jt ju ix jv jw jx jy bi translated">2.数据集:</h2><p id="81ef" class="pw-post-body-paragraph ie if hh ig b ih jz ij ik il ka in io ip kb ir is it kc iv iw ix kd iz ja jb ha bi translated"><strong class="ig hi"> <em class="jc">数据描述:</em> </strong></p><p id="60cd" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">训练注释以游程编码(RLE)掩码的形式提供，图像是PNG格式的。</p><p id="a06a" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi"> <em class="jc">文件:</em> </strong></p><p id="0f2a" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi"> train.csv </strong>:所有训练对象的id和掩码</p><p id="e359" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi"> sample_submission.csv: </strong>格式正确的样本提交文件</p><p id="407d" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi">列车</strong>:PNG格式的列车图像</p><p id="7d15" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi">测试</strong>:测试PNG格式的图像。</p><p id="5bb3" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi">训练_半监督</strong>:无标签图像</p><p id="0d7d" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi">live cell _ dataset _ 2021</strong>:live cell数据集数据的镜像</p><figure class="kt ku kv kw fd kx er es paragraph-image"><div class="er es ks"><img src="../Images/ed984bc209c06191212d9a47fd6f52bd.png" data-original-src="https://miro.medium.com/v2/resize:fit:536/format:webp/1*7dn9nx3jwLIyFbs9-o1Xhw.png"/></div><figcaption class="la lb et er es lc ld bd b be z dx">Data Explorer</figcaption></figure><blockquote class="le lf lg"><p id="2a5e" class="ie if jc ig b ih ii ij ik il im in io lh iq ir is li iu iv iw lj iy iz ja jb ha bi translated"><strong class="ig hi">注:</strong>我们仅使用<strong class="ig hi"> train.csv </strong>、<strong class="ig hi"> train </strong>和<strong class="ig hi"> test </strong>进行训练和推理。</p></blockquote><p id="86cc" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi"> <em class="jc">游程编码(RLE): </em> </strong>是数据压缩的一种形式。图像可以存储在位图和压缩使用RLE算法。由于掩码是RL编码的，我们需要提供一个RLE解码器来读取这些掩码。</p><figure class="kt ku kv kw fd kx"><div class="bz dy l di"><div class="lk ll l"/></div></figure><h2 id="073d" class="je jf hh bd jg jh ji jj jk jl jm jn jo ip jp jq jr it js jt ju ix jv jw jx jy bi translated">3.配置:</h2><p id="1e51" class="pw-post-body-paragraph ie if hh ig b ih jz ij ik il ka in io ip kb ir is it kc iv iw ix kd iz ja jb ha bi translated">我们用<a class="ae jd" href="https://colab.research.google.com/drive/1zvcp88bTlly_XMkK6G6HXZvA_vk5MP7i?usp=sharing" rel="noopener ugc nofollow" target="_blank"> <strong class="ig hi"> Google Colab </strong> </a>来演示这一点。</p><p id="c544" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi">首先</strong>，我们需要安装一些要求，让Mask R-CNN运行:</p><pre class="kt ku kv kw fd lm ln lo lp aw lq bi"><span id="d450" class="je jf hh ln b fi lr ls l lt lu">!pip3 uninstall -y keras-nightly</span><span id="914e" class="je jf hh ln b fi lv ls l lt lu">!pip3 uninstall -y tensorflow</span><span id="ca66" class="je jf hh ln b fi lv ls l lt lu">!pip3 install keras==2.1.6</span><span id="89a3" class="je jf hh ln b fi lv ls l lt lu">!pip3 install tensorflow==1.15.0</span><span id="c7d9" class="je jf hh ln b fi lv ls l lt lu">!pip install 'h5py&lt;3.0.0'</span><span id="c7f9" class="je jf hh ln b fi lv ls l lt lu">!pip install imgaug # for augmentation</span></pre><p id="9400" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi">第二个</strong>，我们克隆了<a class="ae jd" href="https://github.com/nghi-huynh/Mask_RCNN.git" rel="noopener ugc nofollow" target="_blank"><strong class="ig hi">matter port Mask R-CNN</strong></a><strong class="ig hi"/>资源库:</p><pre class="kt ku kv kw fd lm ln lo lp aw lq bi"><span id="9dad" class="je jf hh ln b fi lr ls l lt lu">!git clone https://github.com/nghi-huynh/Mask_RCNN.git</span><span id="7d64" class="je jf hh ln b fi lv ls l lt lu">!mv -f Mask_RCNN/mrcnn/ .</span><span id="5706" class="je jf hh ln b fi lv ls l lt lu">!mv Mask_RCNN/samples/cell/cell.py .</span><span id="71cf" class="je jf hh ln b fi lv ls l lt lu">!rm -rf Mask_RCNN/</span><span id="a313" class="je jf hh ln b fi lv ls l lt lu">!rm -rf sample_data/</span></pre><p id="b5e9" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi">第三个</strong>，我们导入所需的库:</p><figure class="kt ku kv kw fd kx"><div class="bz dy l di"><div class="lk ll l"/></div><figcaption class="la lb et er es lc ld bd b be z dx">Importing required libraries</figcaption></figure><p id="348f" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi">第四个</strong>，我们通过复制<a class="ae jd" href="https://github.com/nghi-huynh/Mask_RCNN/blob/master/samples/nucleus/nucleus.py" rel="noopener ugc nofollow" target="_blank"> <em class="jc"> nucleus.py </em> </a>创建<a class="ae jd" href="https://github.com/nghi-huynh/Mask_RCNN/blob/master/samples/cell/cell.py" rel="noopener ugc nofollow" target="_blank"><strong class="ig hi"><em class="jc">cell . py</em></strong></a>文件，并根据我们的需要进行修改。在这个文件中，我们从基本掩码R-CNN <code class="du lw lx ly ln b">Config</code>和<code class="du lw lx ly ln b">Dataset</code>类继承了两个类，并覆盖了一些值。</p><ul class=""><li id="d5b0" class="ke kf hh ig b ih ii il im ip kg it kh ix ki jb kj kk kl km bi translated"><code class="du lw lx ly ln b"> CellConfig</code>类看起来是这样的:</li></ul><figure class="kt ku kv kw fd kx"><div class="bz dy l di"><div class="lk ll l"/></div><figcaption class="la lb et er es lc ld bd b be z dx">Customize CellConfig class</figcaption></figure><blockquote class="le lf lg"><p id="3f80" class="ie if jc ig b ih ii ij ik il im in io lh iq ir is li iu iv iw lj iy iz ja jb ha bi translated"><strong class="ig hi">代码提示:</strong>基础配置类在<a class="ae jd" href="https://github.com/nghi-huynh/Mask_RCNN/blob/master/mrcnn/config.py" rel="noopener ugc nofollow" target="_blank"> config.py </a>中。并且NucleusConfig在<a class="ae jd" href="https://github.com/nghi-huynh/Mask_RCNN/blob/master/samples/nucleus/nucleus.py" rel="noopener ugc nofollow" target="_blank"> nucleus.py </a>中</p></blockquote><ul class=""><li id="2f36" class="ke kf hh ig b ih ii il im ip kg it kh ix ki jb kj kk kl km bi translated"><code class="du lw lx ly ln b">CellDataset</code>类看起来像这样:</li></ul><figure class="kt ku kv kw fd kx"><div class="bz dy l di"><div class="lk ll l"/></div><figcaption class="la lb et er es lc ld bd b be z dx">Customize CellDataset class</figcaption></figure><blockquote class="le lf lg"><p id="564c" class="ie if jc ig b ih ii ij ik il im in io lh iq ir is li iu iv iw lj iy iz ja jb ha bi translated"><strong class="ig hi">代码提示</strong>:您可以跟随<a class="ae jd" href="https://github.com/nghi-huynh/Mask_RCNN/tree/master/samples" rel="noopener ugc nofollow" target="_blank">示例</a>并注意每个示例如何使用自己的数据集类，然后编写自己的数据集类来加载数据集的任何格式。</p></blockquote><h2 id="06a3" class="je jf hh bd jg jh ji jj jk jl jm jn jo ip jp jq jr it js jt ju ix jv jw jx jy bi translated">4.数据探索:</h2><p id="eefe" class="pw-post-body-paragraph ie if hh ig b ih jz ij ik il ka in io ip kb ir is it kc iv iw ix kd iz ja jb ha bi translated">一旦我们定制了数据集，我们就通过加载数据集并显示一些随机样本来验证我们的代码。</p><figure class="kt ku kv kw fd kx"><div class="bz dy l di"><div class="lk ll l"/></div><figcaption class="la lb et er es lc ld bd b be z dx">Data visualization</figcaption></figure><p id="c072" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">这是我们可视化的一个例子:</p><figure class="kt ku kv kw fd kx er es paragraph-image"><div role="button" tabindex="0" class="ma mb di mc bf md"><div class="er es lz"><img src="../Images/961a3f64dbf7080eec280999c505f6e5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3n0_YglRmE9SiAX5QDGfOA.png"/></div></div><figcaption class="la lb et er es lc ld bd b be z dx">Sample of our visualization: on the left is the original image, on the right is its corresponding masks</figcaption></figure><p id="0fdc" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">然后，我们通过加载特定图像的源ID，将原始图像和蒙版叠加在一起。</p><figure class="kt ku kv kw fd kx"><div class="bz dy l di"><div class="lk ll l"/></div><figcaption class="la lb et er es lc ld bd b be z dx">Overlaying the original image and mask together</figcaption></figure><p id="cc8a" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">这是我们叠加图像的一个例子:</p><figure class="kt ku kv kw fd kx er es paragraph-image"><div role="button" tabindex="0" class="ma mb di mc bf md"><div class="er es me"><img src="../Images/42a62536fd9be990623904d63df4ef00.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*q5bubDN6fwEqtEEaOjxRnQ.png"/></div></div><figcaption class="la lb et er es lc ld bd b be z dx">Overlay original image and its masks</figcaption></figure><h2 id="6099" class="je jf hh bd jg jh ji jj jk jl jm jn jo ip jp jq jr it js jt ju ix jv jw jx jy bi translated">5.型号:</h2><p id="6ae6" class="pw-post-body-paragraph ie if hh ig b ih jz ij ik il ka in io ip kb ir is it kc iv iw ix kd iz ja jb ha bi translated">现在，我们使用<code class="du lw lx ly ln b">CellDataset</code>加载训练和验证数据集。然后，我们下载并初始化coco为我们的模型训练的权重。最后，我们使用我们创建的<code class="du lw lx ly ln b">CellConfig</code>实例初始化用于训练的Mask R-CNN模型。</p><figure class="kt ku kv kw fd kx"><div class="bz dy l di"><div class="lk ll l"/></div><figcaption class="la lb et er es lc ld bd b be z dx">Initialize our Mask R-CNN model</figcaption></figure><blockquote class="le lf lg"><p id="e2c1" class="ie if jc ig b ih ii ij ik il im in io lh iq ir is li iu iv iw lj iy iz ja jb ha bi translated"><strong class="ig hi">注意:</strong>我们从ResNet50的训练中排除了最后几层</p></blockquote><h2 id="85ee" class="je jf hh bd jg jh ji jj jk jl jm jn jo ip jp jq jr it js jt ju ix jv jw jx jy bi translated">6.数据扩充:</h2><p id="5d4b" class="pw-post-body-paragraph ie if hh ig b ih jz ij ik il ka in io ip kb ir is it kc iv iw ix kd iz ja jb ha bi translated">然后，我们添加我们的增强管道，以增加我们的训练和验证数据集的多样性。我们的管道包括一些随机翻转，仿射和高斯模糊。</p><figure class="kt ku kv kw fd kx"><div class="bz dy l di"><div class="lk ll l"/></div><figcaption class="la lb et er es lc ld bd b be z dx">Augmentation pipeline</figcaption></figure><h2 id="490b" class="je jf hh bd jg jh ji jj jk jl jm jn jo ip jp jq jr it js jt ju ix jv jw jx jy bi translated">7.培训:</h2><p id="70fa" class="pw-post-body-paragraph ie if hh ig b ih jz ij ik il ka in io ip kb ir is it kc iv iw ix kd iz ja jb ha bi translated">我们分两个阶段训练我们的模型:</p><ul class=""><li id="da5f" class="ke kf hh ig b ih ii il im ip kg it kh ix ki jb kj kk kl km bi translated"><strong class="ig hi">第一阶段</strong>:我们只训练头部。这里，我们冻结了所有的主干层，只训练COCO女士随机初始化的预训练权重。为了只训练头部层，我们将<code class="du lw lx ly ln b">layers='heads'</code>传递给<code class="du lw lx ly ln b">train()</code>函数。</li></ul><figure class="kt ku kv kw fd kx"><div class="bz dy l di"><div class="lk ll l"/></div><figcaption class="la lb et er es lc ld bd b be z dx">Head training with higher learning rate</figcaption></figure><blockquote class="le lf lg"><p id="8ad5" class="ie if jc ig b ih ii ij ik il im in io lh iq ir is li iu iv iw lj iy iz ja jb ha bi translated"><strong class="ig hi">代码提示:</strong>训练学习率较高的头部，加快学习进程。</p></blockquote><ul class=""><li id="98dc" class="ke kf hh ig b ih ii il im ip kg it kh ix ki jb kj kk kl km bi translated">第二阶段:我们微调所有图层。为了训练所有层，我们将<code class="du lw lx ly ln b">layers='all'</code>传递给<code class="du lw lx ly ln b">train()</code>函数。</li></ul><figure class="kt ku kv kw fd kx"><div class="bz dy l di"><div class="lk ll l"/></div><figcaption class="la lb et er es lc ld bd b be z dx">All layers training with lower learning rate</figcaption></figure><blockquote class="le lf lg"><p id="1903" class="ie if jc ig b ih ii ij ik il im in io lh iq ir is li iu iv iw lj iy iz ja jb ha bi translated"><strong class="ig hi">注意<em class="hh"> : </em> </strong>每次历元后，我们所有训练过的重量都会自动保存在我们的<code class="du lw lx ly ln b">MODEL_DIR</code>中。但是，我们也可以通过以下代码手动保存它:</p></blockquote><figure class="kt ku kv kw fd kx"><div class="bz dy l di"><div class="lk ll l"/></div><figcaption class="la lb et er es lc ld bd b be z dx">Save our trained weights manually</figcaption></figure><h2 id="a0de" class="je jf hh bd jg jh ji jj jk jl jm jn jo ip jp jq jr it js jt ju ix jv jw jx jy bi translated">8.推论:</h2><p id="ca1a" class="pw-post-body-paragraph ie if hh ig b ih jz ij ik il ka in io ip kb ir is it kc iv iw ix kd iz ja jb ha bi translated">现在，我们要显示由训练好的模型生成的结果。首先，我们在推理模式下创建模型。然后，我们加载之前从训练模型中保存的权重。然后，我们加载一些我们想要检测包围盒、类别和置信度百分比的图像。最后，我们可视化我们的火车预测。</p><figure class="kt ku kv kw fd kx"><div class="bz dy l di"><div class="lk ll l"/></div></figure><figure class="kt ku kv kw fd kx er es paragraph-image"><div role="button" tabindex="0" class="ma mb di mc bf md"><div class="er es mf"><img src="../Images/9cd8fafda735b317eac95f633af7a402.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jZOCDPMR-Si1rl40P0vztA.png"/></div></div><figcaption class="la lb et er es lc ld bd b be z dx">shsy5y</figcaption></figure><figure class="kt ku kv kw fd kx er es paragraph-image"><div role="button" tabindex="0" class="ma mb di mc bf md"><div class="er es mg"><img src="../Images/42d0bd98c66bb02b2c4c97fa708cebdf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vb4UAMN7uPTxpxUXNd_HuQ.png"/></div></div><figcaption class="la lb et er es lc ld bd b be z dx">cort</figcaption></figure><h2 id="39e5" class="je jf hh bd jg jh ji jj jk jl jm jn jo ip jp jq jr it js jt ju ix jv jw jx jy bi translated"><strong class="ak"> 9。结论:</strong></h2><p id="f133" class="pw-post-body-paragraph ie if hh ig b ih jz ij ik il ka in io ip kb ir is it kc iv iw ix kd iz ja jb ha bi translated">我们注意到信心百分比相当低。因此，我们列出了一些可能改进我们模型的因素:</p><ul class=""><li id="dd9d" class="ke kf hh ig b ih ii il im ip kg it kh ix ki jb kj kk kl km bi translated">增加历元的数量</li><li id="7973" class="ke kf hh ig b ih kn il ko ip kp it kq ix kr jb kj kk kl km bi translated">修改学习率</li><li id="f507" class="ke kf hh ig b ih kn il ko ip kp it kq ix kr jb kj kk kl km bi translated">使用另一个主干，如EfficientNetV2，而不是ResNet50</li></ul><div class="mh mi ez fb mj mk"><a rel="noopener follow" target="_blank" href="/mlearning-ai/mlearning-ai-submission-suggestions-b51e2b130bfb"><div class="ml ab dw"><div class="mm ab mn cl cj mo"><h2 class="bd hi fi z dy mp ea eb mq ed ef hg bi translated">Mlearning.ai提交建议</h2><div class="mr l"><h3 class="bd b fi z dy mp ea eb mq ed ef dx translated">如何成为Mlearning.ai上的作家</h3></div><div class="ms l"><p class="bd b fp z dy mp ea eb mq ed ef dx translated">medium.com</p></div></div><div class="mt l"><div class="mu l mv mw mx mt my ky mk"/></div></div></a></div></div></div>    
</body>
</html>