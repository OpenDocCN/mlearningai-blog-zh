<html>
<head>
<title>Neat data preprocessing with Pipeline and ColumnTransformer</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用管道和ColumnTransformer进行整洁的数据预处理</h1>
<blockquote>原文：<a href="https://medium.com/mlearning-ai/neat-data-preprocessing-with-pipeline-and-columntransformer-2a0468865b6b?source=collection_archive---------0-----------------------#2022-05-22">https://medium.com/mlearning-ai/neat-data-preprocessing-with-pipeline-and-columntransformer-2a0468865b6b?source=collection_archive---------0-----------------------#2022-05-22</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><figure class="ev ex if ig ih ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es ie"><img src="../Images/b08349e5d3983f08be58dd35f440741e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-ZGLmQ4UZ8moeyKGjZW-tQ.jpeg"/></div></div></figure><h1 id="cf63" class="ip iq hh bd ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm bi translated">❓为什么要用管道和柱形变压器？</h1><p id="b6d2" class="pw-post-body-paragraph jn jo hh jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ha bi translated">在进行机器学习项目时，最繁琐的步骤通常是数据清理和预处理步骤。主要是当你在Jupyter Notebook中工作时，在许多单元格中运行代码可能会令人困惑。</p><figure class="km kn ko kp fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es kl"><img src="../Images/65a051722d747ebb036afae0a198733e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*MOH5q5_Ryhyq6bj1na2cIw.png"/></div></div><figcaption class="kq kr et er es ks kt bd b be z dx">Source: <a class="ae ku" href="https://therbootcamp.github.io/" rel="noopener ugc nofollow" target="_blank">https://therbootcamp.github.io/</a></figcaption></figure><p id="9f7b" class="pw-post-body-paragraph jn jo hh jp b jq kv js jt ju kw jw jx jy kx ka kb kc ky ke kf kg kz ki kj kk ha bi translated">在训练模型之前，应该将数据分成训练集和测试集。在进入机器学习模型之前，每个数据集都将通过数据清洗和预处理步骤。为训练集和测试集编写重复的代码是没有效率的。这就是管道发挥作用的时候。</p><blockquote class="la lb lc"><p id="6fd4" class="jn jo ld jp b jq kv js jt ju kw jw jx le kx ka kb lf ky ke kf lg kz ki kj kk ha bi translated">管道和列转换器是创建数据预处理工作流的好方法</p></blockquote><figure class="km kn ko kp fd ii er es paragraph-image"><div class="er es lh"><img src="../Images/41ea9cc4083eb1ada62c38b6b8e0d6cc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1308/format:webp/1*3cbyBR99wFWklU6Sy85NEA.png"/></div></figure><p id="44e6" class="pw-post-body-paragraph jn jo hh jp b jq kv js jt ju kw jw jx jy kx ka kb kc ky ke kf kg kz ki kj kk ha bi translated">首先，假设您只能创建一个管道，您可以在其中输入任何数据，这些数据将在模型训练或预测之前转换为适当的格式。它会缩短你的代码，使代码更容易阅读和调整。</p><p id="11f1" class="pw-post-body-paragraph jn jo hh jp b jq kv js jt ju kw jw jx jy kx ka kb kc ky ke kf kg kz ki kj kk ha bi translated">开始编码吧！！</p><h1 id="75b0" class="ip iq hh bd ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm bi translated">💽资料组</h1><p id="a799" class="pw-post-body-paragraph jn jo hh jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ha bi translated">我使用的数据来自</p><div class="li lj ez fb lk ll"><a href="https://www.kaggle.com/datasets/arashnic/hr-analytics-job-change-of-data-scientists?datasetId=1019790&amp;sortBy=voteCount&amp;select=aug_train.csv" rel="noopener  ugc nofollow" target="_blank"><div class="lm ab dw"><div class="ln ab lo cl cj lp"><h2 class="bd hi fi z dy lq ea eb lr ed ef hg bi translated">人力资源分析:数据科学家的工作变化</h2><div class="ls l"><h3 class="bd b fi z dy lq ea eb lr ed ef dx translated">预测谁将跳槽到新的工作岗位</h3></div><div class="lt l"><p class="bd b fp z dy lq ea eb lr ed ef dx translated">www.kaggle.com</p></div></div><div class="lu l"><div class="lv l lw lx ly lu lz in ll"/></div></div></a></div><p id="136e" class="pw-post-body-paragraph jn jo hh jp b jq kv js jt ju kw jw jx jy kx ka kb kc ky ke kf kg kz ki kj kk ha bi translated">您可以在下面的链接中找到我关于这个数据集的数据探索的文章。</p><div class="li lj ez fb lk ll"><a href="https://yannawut.medium.com/data-analysis-job-change-of-data-scientist-685f3de0a983" rel="noopener follow" target="_blank"><div class="lm ab dw"><div class="ln ab lo cl cj lp"><h2 class="bd hi fi z dy lq ea eb lr ed ef hg bi translated">数据分析——数据科学家的工作变化</h2><div class="ls l"><h3 class="bd b fi z dy lq ea eb lr ed ef dx translated">哪些因素导致一个人离开现在的工作？让我们用Power BI来探索数据。</h3></div><div class="lt l"><p class="bd b fp z dy lq ea eb lr ed ef dx translated">yannawut.medium.com</p></div></div><div class="lu l"><div class="ma l lw lx ly lu lz in ll"/></div></div></a></div><p id="4513" class="pw-post-body-paragraph jn jo hh jp b jq kv js jt ju kw jw jx jy kx ka kb kc ky ke kf kg kz ki kj kk ha bi translated">简而言之，这个数据集包含了求职者的信息以及他们是否要换工作的决定。</p><p id="d119" class="pw-post-body-paragraph jn jo hh jp b jq kv js jt ju kw jw jx jy kx ka kb kc ky ke kf kg kz ki kj kk ha bi translated"><strong class="jp hi">目标:</strong>根据应聘者的信息预测其是否会跳槽(分类任务)。</p><h1 id="985e" class="ip iq hh bd ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm bi translated">🛣️管道和柱形变压器</h1><p id="ddf3" class="pw-post-body-paragraph jn jo hh jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ha bi translated">您必须理解Pipeline和ColumnTransformer之间的巨大差异。</p><figure class="km kn ko kp fd ii er es paragraph-image"><div class="er es mb"><img src="../Images/2e79faa6672f11f18428a8ab38677f84.png" data-original-src="https://miro.medium.com/v2/resize:fit:1190/format:webp/1*I0F-ALOL8J8f6V33CDKyrA.png"/></div></figure><p id="a75d" class="pw-post-body-paragraph jn jo hh jp b jq kv js jt ju kw jw jx jy kx ka kb kc ky ke kf kg kz ki kj kk ha bi translated"><strong class="jp hi">管道:</strong>用于相同列的多次转换。</p><p id="ff03" class="pw-post-body-paragraph jn jo hh jp b jq kv js jt ju kw jw jx jy kx ka kb kc ky ke kf kg kz ki kj kk ha bi translated"><strong class="jp hi"> ColumnTransformer: </strong>用于不同地转换每个列集合。</p><p id="b90f" class="pw-post-body-paragraph jn jo hh jp b jq kv js jt ju kw jw jx jy kx ka kb kc ky ke kf kg kz ki kj kk ha bi translated">⚠️:列变换器不是一步一步地变换，而是每一步都单独变换，然后再混合。</p><h1 id="0e18" class="ip iq hh bd ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm bi translated">🗺️数据预处理计划</h1><figure class="km kn ko kp fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es mc"><img src="../Images/d1a2b39ecd1585d00fb1462d97917455.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZT7S2SuhMd4Zazb2lVWmcw.png"/></div></div></figure><p id="6afb" class="pw-post-body-paragraph jn jo hh jp b jq kv js jt ju kw jw jx jy kx ka kb kc ky ke kf kg kz ki kj kk ha bi translated">请注意，为了本文的简单，我跳过了分类特征编码。</p><h2 id="23f9" class="md iq hh bd ir me mf mg iv mh mi mj iz jy mk ml jd kc mm mn jh kg mo mp jl mq bi translated">步骤1:指定定义要以不同方式转换的列集</h2><p id="e5f6" class="pw-post-body-paragraph jn jo hh jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ha bi translated">数值和分类应该以不同的方式进行转换，所以我为数值列(number)定义了num_col，为分类列定义了cat_cols。</p><pre class="km kn ko kp fd mr ms mt mu aw mv bi"><span id="58a5" class="md iq hh ms b fi mw mx l my mz">num_cols = ['city_development_index','relevent_experience', 'experience','last_new_job', 'training_hours']</span><span id="0a17" class="md iq hh ms b fi na mx l my mz">cat_cols = ['gender', 'enrolled_university', 'education_level', 'major_discipline', 'company_size', 'company_type']</span></pre><h2 id="76be" class="md iq hh bd ir me mf mg iv mh mi mj iz jy mk ml jd kc mm mn jh kg mo mp jl mq bi translated">步骤2:将数据拆分为训练集和测试集</h2><p id="bb21" class="pw-post-body-paragraph jn jo hh jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ha bi translated">将20%的数据分割成一个测试集。</p><pre class="km kn ko kp fd mr ms mt mu aw mv bi"><span id="df42" class="md iq hh ms b fi mw mx l my mz">from sklearn.model_selection import train_test_split</span><span id="1c2c" class="md iq hh ms b fi na mx l my mz">X = df[num_cols+cat_cols]<br/>y = df['target']</span><span id="0678" class="md iq hh ms b fi na mx l my mz"># train test split<br/>X_train, X_test, y_train, y_test = train_test_split(X, y, test_size=0.2, stratify=y)</span></pre><p id="b691" class="pw-post-body-paragraph jn jo hh jp b jq kv js jt ju kw jw jx jy kx ka kb kc ky ke kf kg kz ki kj kk ha bi translated">我将为训练集安装管道，并将安装的管道用于测试集，以防止数据从测试集泄漏到模型。</p><h2 id="513c" class="md iq hh bd ir me mf mg iv mh mi mj iz jy mk ml jd kc mm mn jh kg mo mp jl mq bi translated">步骤3:为数字和分类特征创建管道</h2><p id="077a" class="pw-post-body-paragraph jn jo hh jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ha bi translated">管道的语法是</p><blockquote class="la lb lc"><p id="460f" class="jn jo ld jp b jq kv js jt ju kw jw jx le kx ka kb lf ky ke kf lg kz ki kj kk ha bi translated">管道(步骤= [('步骤名'，转换函数)，…])</p></blockquote><p id="4afd" class="pw-post-body-paragraph jn jo hh jp b jq kv js jt ju kw jw jx jy kx ka kb kc ky ke kf kg kz ki kj kk ha bi translated">对于数字特征，我执行<br/> 1。用该列的平均值填充缺失值。<br/> 2。MinMaxScaler将值缩放到范围0到1(这将影响回归性能)。</p><p id="9104" class="pw-post-body-paragraph jn jo hh jp b jq kv js jt ju kw jw jx jy kx ka kb kc ky ke kf kg kz ki kj kk ha bi translated">对于分类特征，我执行<br/> 1。SimpleImputer用该列中出现频率最高的值来填充缺失值。<br/> 2。OneHotEncoder吐槽到很多数值列进行模型训练。(指定handle_unknown='ignore '是为了防止在测试集中发现看不见的类别时出错)</p><pre class="km kn ko kp fd mr ms mt mu aw mv bi"><span id="885b" class="md iq hh ms b fi mw mx l my mz">from sklearn.impute import SimpleImputer<br/>from sklearn.preprocessing import OneHotEncoder, MinMaxScaler<br/>from sklearn.pipeline import Pipeline</span><span id="58aa" class="md iq hh ms b fi na mx l my mz">num_pipeline = Pipeline(steps=[<br/>    ('impute', SimpleImputer(strategy='mean')),<br/>    ('scale',MinMaxScaler())<br/>])</span><span id="e49d" class="md iq hh ms b fi na mx l my mz">cat_pipeline = Pipeline(steps=[<br/>    ('impute', SimpleImputer(strategy='most_frequent')),<br/>    ('one-hot',OneHotEncoder(handle_unknown='ignore', sparse=False))<br/>])</span></pre><h2 id="54a1" class="md iq hh bd ir me mf mg iv mh mi mj iz jy mk ml jd kc mm mn jh kg mo mp jl mq bi translated">步骤4:创建ColumnTransformer，为每个列集应用管道</h2><p id="0efe" class="pw-post-body-paragraph jn jo hh jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ha bi translated">列转换器的语法是</p><blockquote class="la lb lc"><p id="20f3" class="jn jo ld jp b jq kv js jt ju kw jw jx le kx ka kb lf ky ke kf lg kz ki kj kk ha bi translated">column transformer(transformers =[(' step name '，transform function，cols)，…])</p></blockquote><p id="6758" class="pw-post-body-paragraph jn jo hh jp b jq kv js jt ju kw jw jx jy kx ka kb kc ky ke kf kg kz ki kj kk ha bi translated">通过数值管道传递数值列，通过步骤3中创建的分类管道传递分类列。</p><p id="7419" class="pw-post-body-paragraph jn jo hh jp b jq kv js jt ju kw jw jx jy kx ka kb kc ky ke kf kg kz ki kj kk ha bi translated">指定remainder='drop '以忽略dataframe中的其他列。</p><p id="da43" class="pw-post-body-paragraph jn jo hh jp b jq kv js jt ju kw jw jx jy kx ka kb kc ky ke kf kg kz ki kj kk ha bi translated">n_job = -1表示使用所有处理器并行运行。</p><pre class="km kn ko kp fd mr ms mt mu aw mv bi"><span id="6161" class="md iq hh ms b fi mw mx l my mz">from sklearn.compose import ColumnTransformer</span><span id="929b" class="md iq hh ms b fi na mx l my mz">col_trans = ColumnTransformer(transformers=[<br/>    ('num_pipeline',num_pipeline,num_cols),<br/>    ('cat_pipeline',cat_pipeline,cat_cols)<br/>    ],<br/>    remainder='drop',<br/>    n_jobs=-1)</span></pre><h2 id="b1ad" class="md iq hh bd ir me mf mg iv mh mi mj iz jy mk ml jd kc mm mn jh kg mo mp jl mq bi translated">步骤5:向最终管道添加模型</h2><p id="8e6b" class="pw-post-body-paragraph jn jo hh jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ha bi translated">在这个例子中，我使用了逻辑回归模型。</p><p id="3788" class="pw-post-body-paragraph jn jo hh jp b jq kv js jt ju kw jw jx jy kx ka kb kc ky ke kf kg kz ki kj kk ha bi translated">创建一个新管道，将步骤4中的ColumnTransformer与逻辑回归模型混合。在这种情况下，我使用管道，因为整个数据帧必须分别通过ColumnTransformer步骤和建模步骤。</p><pre class="km kn ko kp fd mr ms mt mu aw mv bi"><span id="d952" class="md iq hh ms b fi mw mx l my mz">from sklearn.linear_model import LogisticRegression</span><span id="17fb" class="md iq hh ms b fi na mx l my mz">clf = LogisticRegression(random_state=0)</span><span id="5bca" class="md iq hh ms b fi na mx l my mz">clf_pipeline = Pipeline(steps=[<br/>    ('col_trans', col_trans),<br/>    ('model', clf)<br/>])</span></pre><h2 id="a857" class="md iq hh bd ir me mf mg iv mh mi mj iz jy mk ml jd kc mm mn jh kg mo mp jl mq bi translated"><strong class="ak">第六步:显示流水线</strong></h2><blockquote class="la lb lc"><p id="9525" class="jn jo ld jp b jq kv js jt ju kw jw jx le kx ka kb lf ky ke kf lg kz ki kj kk ha bi translated">显示(管道名称)</p></blockquote><pre class="km kn ko kp fd mr ms mt mu aw mv bi"><span id="c995" class="md iq hh ms b fi mw mx l my mz">from sklearn import set_config<br/>set_config(display='diagram')</span><span id="939b" class="md iq hh ms b fi na mx l my mz">display(clf_pipeline)</span></pre><figure class="km kn ko kp fd ii er es paragraph-image"><div class="er es nb"><img src="../Images/84ec4a4516192c7738094876e54baa44.png" data-original-src="https://miro.medium.com/v2/resize:fit:560/format:webp/1*ZAQ6T65iADOmFx1eCJsjDQ.png"/></div><figcaption class="kq kr et er es ks kt bd b be z dx">Displayed pipeline</figcaption></figure><p id="50f6" class="pw-post-body-paragraph jn jo hh jp b jq kv js jt ju kw jw jx jy kx ka kb kc ky ke kf kg kz ki kj kk ha bi translated">您可以单击显示的图像来查看每个步骤的详细信息。多方便啊！！</p><figure class="km kn ko kp fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es nc"><img src="../Images/178746f43cf0e929cb5fdae4ae2e43f3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gahdAdZlFSICnQmiqbQYvg.png"/></div></div><figcaption class="kq kr et er es ks kt bd b be z dx">Expanded displayed pipeline</figcaption></figure><h2 id="4ccd" class="md iq hh bd ir me mf mg iv mh mi mj iz jy mk ml jd kc mm mn jh kg mo mp jl mq bi translated">步骤7:通过管道传递数据</h2><p id="baee" class="pw-post-body-paragraph jn jo hh jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ha bi translated">fit:通过管道传递数据。也符合模型。</p><p id="6d35" class="pw-post-body-paragraph jn jo hh jp b jq kv js jt ju kw jw jx jy kx ka kb kc ky ke kf kg kz ki kj kk ha bi translated">pipeline.predict:使用pipeline.fit时训练的模型来预测新数据</p><p id="70f1" class="pw-post-body-paragraph jn jo hh jp b jq kv js jt ju kw jw jx jy kx ka kb kc ky ke kf kg kz ki kj kk ha bi translated">pipeline.score:获得管道中模型的分数(在这个例子中是逻辑回归的精确度)</p><pre class="km kn ko kp fd mr ms mt mu aw mv bi"><span id="ddc7" class="md iq hh ms b fi mw mx l my mz">clf_pipeline.fit(X_train, y_train)<br/># preds = clf_pipeline.predict(X_test)<br/>score = clf_pipeline.score(X_test, y_test)<br/>print(f"Model score: {score}") # accuracy</span></pre><figure class="km kn ko kp fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es nd"><img src="../Images/3874231444073c622a155c4031f0d1eb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Y5liijw_WH1kRMnO4S3ung.png"/></div></div></figure><h2 id="72c3" class="md iq hh bd ir me mf mg iv mh mi mj iz jy mk ml jd kc mm mn jh kg mo mp jl mq bi translated">(可选)步骤8:保存管道</h2><p id="1251" class="pw-post-body-paragraph jn jo hh jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ha bi translated">使用joblib库保存管道供以后使用，这样就不需要再次创建和安装管道。当您想要使用保存的管道时，只需使用joblib.load加载文件。</p><pre class="km kn ko kp fd mr ms mt mu aw mv bi"><span id="9dc4" class="md iq hh ms b fi mw mx l my mz">import joblib</span><span id="3ca5" class="md iq hh ms b fi na mx l my mz"># Save pipeline to file "pipe.joblib"<br/>joblib.dump(clf_pipeline,"pipe.joblib")</span><span id="1d5b" class="md iq hh ms b fi na mx l my mz"># Load pipeline when you want to use<br/>same_pipe = joblib.load("pipe.joblib")</span></pre><h1 id="ee6d" class="ip iq hh bd ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm bi translated">结论</h1><p id="c722" class="pw-post-body-paragraph jn jo hh jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ha bi translated">您可以实现从数据清理到数据建模步骤的管道，使您的代码更加整洁。通过显示管线，您可以轻松直观地了解如何构建模型。</p><p id="8735" class="pw-post-body-paragraph jn jo hh jp b jq kv js jt ju kw jw jx jy kx ka kb kc ky ke kf kg kz ki kj kk ha bi translated">欢迎任何反馈！！</p><div class="li lj ez fb lk ll"><a rel="noopener follow" target="_blank" href="/mlearning-ai/mlearning-ai-submission-suggestions-b51e2b130bfb"><div class="lm ab dw"><div class="ln ab lo cl cj lp"><h2 class="bd hi fi z dy lq ea eb lr ed ef hg bi translated">Mlearning.ai提交建议</h2><div class="ls l"><h3 class="bd b fi z dy lq ea eb lr ed ef dx translated">如何成为Mlearning.ai上的作家</h3></div><div class="lt l"><p class="bd b fp z dy lq ea eb lr ed ef dx translated">medium.com</p></div></div><div class="lu l"><div class="ne l lw lx ly lu lz in ll"/></div></div></a></div></div></div>    
</body>
</html>