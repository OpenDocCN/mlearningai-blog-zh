<html>
<head>
<title>TensorFlow Object Detection API with TF1 vs TF2</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">带TF1和TF2的TensorFlow对象检测API</h1>
<blockquote>原文：<a href="https://medium.com/mlearning-ai/tensoflow-object-detection-api-with-tf1-vs-tf2-9d716be1f5d9?source=collection_archive---------0-----------------------#2021-04-26">https://medium.com/mlearning-ai/tensoflow-object-detection-api-with-tf1-vs-tf2-9d716be1f5d9?source=collection_archive---------0-----------------------#2021-04-26</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><figure class="ev ex if ig ih ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es ie"><img src="../Images/198285862287485d6e81186dffed1133.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*gZPh0MB1zLwDElEY"/></div></div><figcaption class="ip iq et er es ir is bd b be z dx">Photo by <a class="ae it" href="https://unsplash.com/@ikukevk?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Kevin Ku</a> on <a class="ae it" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="ffc9" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">我使用TensorFlow对象检测API已经有一段时间了，在创建自定义对象检测器时，我在TF1和TF2版本中都发现了一些有趣的技术。如果你是一个新手，我强烈推荐你试试TensorFlow 提供的这个笔记本，它为你提供了一个关于在Google Colab上构建和训练自定义对象检测器的全面指导。</p><p id="2a3b" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">这是我开发的自定义对象检测器的一些快照，用来识别手绘线框中的UI组件。</p><figure class="jt ju jv jw fd ii er es paragraph-image"><div class="er es js"><img src="../Images/309a2a5e4cae3790ec0350e08c37fdf9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1314/format:webp/1*L-GxDEJxF1cO0GTcaRJPFQ.png"/></div><figcaption class="ip iq et er es ir is bd b be z dx">UI Component Detector</figcaption></figure><figure class="jt ju jv jw fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es jx"><img src="../Images/d0bd02e014265e374b0bcd0ea076b509.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5Rus2kUuRV4johH-4IFJEg.png"/></div></div><figcaption class="ip iq et er es ir is bd b be z dx">UI Component Detector</figcaption></figure><p id="0a15" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">Tensorflow对象检测API为TF2和TF1都提供了包，因此任何人都可以使用其中的任何一个进行实验。如果你已经完成了数据集，你可以使用TensorFlow提供的<a class="ae it" href="https://colab.research.google.com/drive/1MdzgmdYJk947sXyls45V7auMPttHelBZ?usp=sharing" rel="noopener ugc nofollow" target="_blank">笔记本</a>直接开始构建模型。</p><p id="46c3" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">现在，让我们比较一下为什么我们需要选择TF1或TF2来构建或训练我们的数据集。</p><ol class=""><li id="e47a" class="jy jz hh iw b ix iy jb jc jf ka jj kb jn kc jr kd ke kf kg bi translated">默认Google Colab TensorFlow版本</li></ol><p id="89d8" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">Google Colab默认支持TensorFlow 2，因此如果您想在TF1中构建和训练您的模型，您必须首先设置环境。</p><pre class="jt ju jv jw fd kh ki kj kk aw kl bi"><span id="83f4" class="km kn hh ki b fi ko kp l kq kr">%tensorflow_version 1.x</span><span id="06cf" class="km kn hh ki b fi ks kp l kq kr">import tensorflow<br/>print(tensorflow.__version__)</span></pre><figure class="jt ju jv jw fd ii er es paragraph-image"><div class="er es kt"><img src="../Images/d44243f13a8d201b44c9f1a6db87a814.png" data-original-src="https://miro.medium.com/v2/resize:fit:724/format:webp/1*cskoLt-NbIfuK7AQl--ihA.png"/></div><figcaption class="ip iq et er es ir is bd b be z dx">Selecting TF1 in Colab</figcaption></figure><p id="6c7f" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">一旦选择了环境，请确保安装了与您的环境相关的正确软件包。</p><pre class="jt ju jv jw fd kh ki kj kk aw kl bi"><span id="bea0" class="km kn hh ki b fi ko kp l kq kr">!git clone https://github.com/tensorflow/models.git</span><span id="f0a1" class="km kn hh ki b fi ks kp l kq kr">%cd /content/models/research/<br/>!protoc object_detection/protos/*.proto --python_out=.</span><span id="c31d" class="km kn hh ki b fi ks kp l kq kr"># Install TensorFlow Object Detection API for TF1.</span><span id="47c3" class="km kn hh ki b fi ks kp l kq kr">!cp object_detection/packages/<strong class="ki hi">tf1</strong>/setup.py .<br/>!python -m pip install .</span></pre><p id="7d62" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">2.选择预训练模型</p><p id="8b75" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">TensorFlow从他们的模型动物园为<a class="ae it" href="https://github.com/tensorflow/models/blob/master/research/object_detection/g3doc/tf1_detection_zoo.md" rel="noopener ugc nofollow" target="_blank"> TF1 </a>和<a class="ae it" href="https://github.com/tensorflow/models/blob/master/research/object_detection/g3doc/tf2_detection_zoo.md" rel="noopener ugc nofollow" target="_blank"> TF2 </a>提供预训练的检测模型。他们在<a class="ae it" href="https://github.com/tensorflow/models/tree/master/research/object_detection/samples/configs" rel="noopener ugc nofollow" target="_blank"> TF1配置</a>和<a class="ae it" href="https://github.com/tensorflow/models/tree/master/research/object_detection/configs/tf2" rel="noopener ugc nofollow" target="_blank"> TF2配置</a>中为这些模型提供了配置文件，以便您可以从头开始训练模型。为两种环境制作的预训练模型的数量并不相同。你只能在不支持TF1的TF2找到一些更快的型号，如<a class="ae it" href="http://download.tensorflow.org/models/object_detection/tf2/20200711/efficientdet_d0_coco17_tpu-32.tar.gz" rel="noopener ugc nofollow" target="_blank"> EfficientDet D0 512x512 </a>。因此，你必须从TF2建立模型来训练，并从特定的模型中获得预测。在特定环境中训练模型之前，对两组预训练模型进行比较，并根据需要选择最佳模型。</p><p id="d738" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">下载TF1预训练检测模型</p><pre class="jt ju jv jw fd kh ki kj kk aw kl bi"><span id="62eb" class="km kn hh ki b fi ko kp l kq kr">%cd /content</span><span id="7d2c" class="km kn hh ki b fi ks kp l kq kr">!wget <a class="ae it" href="http://download.tensorflow.org/models/object_detection/faster_rcnn_resnet101_coco_2018_01_28.tar.gz" rel="noopener ugc nofollow" target="_blank"><strong class="ki hi">http://download.tensorflow.org/models/object_detection/faster_rcnn_resnet101_coco_2018_01_28.tar.gz</strong></a><br/>!tar -xvf faster_rcnn_resnet101_coco_2018_01_28.tar.gz<br/>!rm faster_rcnn_resnet101_coco_2018_01_28.tar.gz</span><span id="b1a3" class="km kn hh ki b fi ks kp l kq kr">!wget <a class="ae it" href="https://raw.githubusercontent.com/tensorflow/models/master/research/object_detection/samples/configs/faster_rcnn_resnet101_coco.config" rel="noopener ugc nofollow" target="_blank"><strong class="ki hi">https://raw.githubusercontent.com/tensorflow/models/master/research/object_detection/samples/configs/faster_rcnn_resnet101_coco.config</strong></a><br/>!mv faster_rcnn_resnet101_coco.config faster_rcnn_resnet101.config</span></pre><p id="33f1" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">下载TF2预训练检测模型</p><pre class="jt ju jv jw fd kh ki kj kk aw kl bi"><span id="b0d3" class="km kn hh ki b fi ko kp l kq kr">%cd /content</span><span id="23c6" class="km kn hh ki b fi ks kp l kq kr">!wget <a class="ae it" href="http://download.tensorflow.org/models/object_detection/tf2/20200711/efficientdet_d0_coco17_tpu-32.tar.gz" rel="noopener ugc nofollow" target="_blank"><strong class="ki hi">http://download.tensorflow.org/models/object_detection/tf2/20200711/efficientdet_d0_coco17_tpu-32.tar.gz</strong></a><br/>!tar -xvf efficientdet_d0_coco17_tpu-32.tar.gz<br/>!rm efficientdet_d0_coco17_tpu-32.tar.gz</span><span id="fdc5" class="km kn hh ki b fi ks kp l kq kr">!wget <a class="ae it" href="https://raw.githubusercontent.com/tensorflow/models/master/research/object_detection/configs/tf2/ssd_efficientdet_d0_512x512_coco17_tpu-8.config" rel="noopener ugc nofollow" target="_blank"><strong class="ki hi">https://raw.githubusercontent.com/tensorflow/models/master/research/object_detection/configs/tf2/ssd_efficientdet_d0_512x512_coco17_tpu-8.config</strong></a><br/>!mv ssd_efficientdet_d0_512x512_coco17_tpu-8.config efficientdet_d0_coco17_tpu-32.config</span></pre><p id="cafd" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">微调配置文件后，您可以训练模型。确保为给定环境的培训python脚本提供正确的路径</p><p id="c3b5" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">培训路径TF1</p><pre class="jt ju jv jw fd kh ki kj kk aw kl bi"><span id="4973" class="km kn hh ki b fi ko kp l kq kr">!python <strong class="ki hi">/content/models/research/object_detection/model_main.py</strong> --pipeline_config_path={pipeline_config_path} --model_dir=training --alsologtostderr</span></pre><p id="9c98" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">TF2培训路径</p><pre class="jt ju jv jw fd kh ki kj kk aw kl bi"><span id="47fb" class="km kn hh ki b fi ko kp l kq kr">!python <strong class="ki hi">/content/models/research/object_detection/model_main_tf2.py </strong>--pipeline_config_path={pipeline_config_path} --model_dir=training --alsologtostderr</span></pre><p id="387d" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">3.导出推理图</p><p id="2c85" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">这是您在为项目选择最佳环境时必须考虑的要点之一。当您将训练好的模型导出到推理图时，可以导出到保存的模型或冻结的推理图。冻结的模型不能再次用于训练。检查此<a class="ae it" href="https://stackoverflow.com/questions/52934795/what-is-difference-frozen-inference-graph-pb-and-saved-model-pb" rel="noopener ugc nofollow" target="_blank">链接</a>以清楚了解冻结图形。问题是……在TF2，不允许直接导出冻结的推理图。</p><p id="f145" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">在TF1中，您可以使用以下命令来导出冻结的图形</p><pre class="jt ju jv jw fd kh ki kj kk aw kl bi"><span id="46e2" class="km kn hh ki b fi ko kp l kq kr">output_dir="inference_graph"</span><span id="48d5" class="km kn hh ki b fi ks kp l kq kr">!python /content/models/research/object_detection/export_inference_graph.py \<br/>--input_type=image_tensor \<br/>--pipeline_config_path={pipeline_config_path} \<br/>--output_directory={output_dir} \<br/>--trained_checkpoint_prefix={last_model_path}</span></pre><figure class="jt ju jv jw fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es ku"><img src="../Images/79d6e30613776c6b4cbb1acc66c8bc8d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xnH7bx_rfpB-mJmklCI1pg.png"/></div></div><figcaption class="ip iq et er es ir is bd b be z dx">Exported Frozen Graph</figcaption></figure><p id="f4de" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated"><em class="kv">export _ inference _ graph . py</em>脚本<strong class="iw hi">只支持TF1中的包！</strong></p><p id="1fec" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">在TF2，您可以使用以下命令导出推理图</p><pre class="jt ju jv jw fd kh ki kj kk aw kl bi"><span id="083d" class="km kn hh ki b fi ko kp l kq kr">output_directory = 'inference_graph'</span><span id="34fc" class="km kn hh ki b fi ks kp l kq kr">!python /content/models/research/object_detection/exporter_main_v2.py \<br/>--trained_checkpoint_dir {model_dir} \<br/>--output_directory {output_directory} \<br/>--pipeline_config_path {pipeline_config_path}</span></pre><figure class="jt ju jv jw fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es kw"><img src="../Images/472bf6a9307eeb1af87313c956b315d2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mPZxDLTxaXWIDUkwsiT57g.png"/></div></div><figcaption class="ip iq et er es ir is bd b be z dx">Export Inference Graph</figcaption></figure><p id="8567" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">因此，如果你想在训练结束时得到一个冻结的图表，最好选择TF1而不是TF2。但是如果你选择了一个只支持TF2的预训练模型，并且如果你想要一个冻结的图形，你可能需要做一些工作。这里有一个在TF2导出冻结图形的好办法。</p></div><div class="ab cl kx ky go kz" role="separator"><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc"/></div><div class="ha hb hc hd he"><p id="4a23" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">TensorFlow对象检测API是构建自定义对象检测器的强大工具。然而，当根据不同的需求创建模型时，会有一些缺点。如果你被困在某个地方，希望这有所帮助…:)</p></div></div>    
</body>
</html>