<html>
<head>
<title>Azure Machine learning managed spark — Preview</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Azure机器学习管理的spark —预览</h1>
<blockquote>原文：<a href="https://medium.com/mlearning-ai/azure-machine-learning-managed-spark-preview-fe54a98ec0cd?source=collection_archive---------5-----------------------#2022-11-12">https://medium.com/mlearning-ai/azure-machine-learning-managed-spark-preview-fe54a98ec0cd?source=collection_archive---------5-----------------------#2022-11-12</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><h1 id="160a" class="ie if hh bd ig ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb bi translated">使用Azure机器学习服务的托管Spark简介</h1><h1 id="6bde" class="ie if hh bd ig ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb bi translated">先决条件</h1><ul class=""><li id="0e9f" class="jc jd hh je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt bi translated">Azure帐户</li><li id="b805" class="jc jd hh je b jf ju jh jv jj jw jl jx jn jy jp jq jr js jt bi translated">Azure机器学习服务</li><li id="4ccc" class="jc jd hh je b jf ju jh jv jj jw jl jx jn jy jp jq jr js jt bi translated">泰坦尼克号数据集</li></ul><h1 id="f6af" class="ie if hh bd ig ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb bi translated">管理火花步骤</h1><ul class=""><li id="38f4" class="jc jd hh je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt bi translated">首先转到笔记本</li><li id="3136" class="jc jd hh je b jf ju jh jv jj jw jl jx jn jy jp jq jr js jt bi translated">创建新笔记本</li><li id="2535" class="jc jd hh je b jf ju jh jv jj jw jl jx jn jy jp jq jr js jt bi translated">在计算选择旁边，单击新建并选择AzureML spark计算</li></ul><figure class="ka kb kc kd fd ke er es paragraph-image"><div class="er es jz"><img src="../Images/c6baca8f87d663db556946ef6e26bc7d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1016/format:webp/0*vrHUTP8Y5CoC0oea.jpg"/></div></figure><ul class=""><li id="07ad" class="jc jd hh je b jf kh jh ki jj kj jl kk jn kl jp jq jr js jt bi translated">现在回到笔记本电脑，你应该看到计算创建。通常需要3-5分钟</li></ul><figure class="ka kb kc kd fd ke er es paragraph-image"><div role="button" tabindex="0" class="kn ko di kp bf kq"><div class="er es km"><img src="../Images/d71c0cc93881739b45260edb6b73ba6e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*06F0lLHFdqBDpILo.jpg"/></div></div></figure><ul class=""><li id="4982" class="jc jd hh je b jf kh jh ki jj kj jl kk jn kl jp jq jr js jt bi translated">如果您想更改会话，请单击笔记本左侧底部的“配置会话”</li></ul><figure class="ka kb kc kd fd ke er es paragraph-image"><div class="er es kr"><img src="../Images/3d78baf673761bf69cdc9a08cc0ce1b7.png" data-original-src="https://miro.medium.com/v2/resize:fit:992/format:webp/0*vKk5e7HArif4yIJU.jpg"/></div></figure><ul class=""><li id="1d92" class="jc jd hh je b jf kh jh ki jj kj jl kk jn kl jp jq jr js jt bi translated">默认情况下，当我创建它是火花3.2</li><li id="ee30" class="jc jd hh je b jf ju jh jv jj jw jl jx jn jy jp jq jr js jt bi translated">现在让我们从外部文件加载一些数据</li><li id="1c8f" class="jc jd hh je b jf ju jh jv jj jw jl jx jn jy jp jq jr js jt bi translated">下面是开源的可用数据集</li></ul><pre class="ka kb kc kd fd ks kt ku kv aw kw bi"><span id="9ee0" class="kx if hh kt b fi ky kz l la lb">df = spark.read.option("header", "true").csv("wasbs://demo@dprepdata.blob.core.windows.net/Titanic.csv")</span></pre><ul class=""><li id="b0be" class="jc jd hh je b jf kh jh ki jj kj jl kk jn kl jp jq jr js jt bi translated">让我们做一些数据处理</li></ul><pre class="ka kb kc kd fd ks kt ku kv aw kw bi"><span id="ffd1" class="kx if hh kt b fi ky kz l la lb">from pyspark.sql.functions import col, desc</span><span id="79c1" class="kx if hh kt b fi lc kz l la lb">df.filter(col('Survived') == 1).groupBy('Age').count().orderBy(desc('count')).show(10)</span></pre><figure class="ka kb kc kd fd ke er es paragraph-image"><div role="button" tabindex="0" class="kn ko di kp bf kq"><div class="er es ld"><img src="../Images/ab70791245952c789d596db35824b559.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*wncFk6YmP2Ca6cWD.jpg"/></div></div></figure><ul class=""><li id="3b1a" class="jc jd hh je b jf kh jh ki jj kj jl kk jn kl jp jq jr js jt bi translated">现在让我们从Azure机器学习数据集加载</li></ul><pre class="ka kb kc kd fd ks kt ku kv aw kw bi"><span id="3d90" class="kx if hh kt b fi ky kz l la lb">import azureml.core<br/>print(azureml.core.VERSION)</span><span id="5378" class="kx if hh kt b fi lc kz l la lb">from azureml.core import Workspace, Dataset<br/>ws = Workspace.get(name='workspacename', subscription_id='xxxxxxx', resource_group='rgname')<br/>ds = Dataset.get_by_name(ws, "titanic")<br/>df = ds.to_spark_dataframe()</span></pre><figure class="ka kb kc kd fd ke er es paragraph-image"><div role="button" tabindex="0" class="kn ko di kp bf kq"><div class="er es le"><img src="../Images/ccfbf3db801396aaeca607df6b43ff96.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*s6g49Up5Y-wreUZX.jpg"/></div></div></figure><h1 id="fd56" class="ie if hh bd ig ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb bi translated">机器学习</h1><ul class=""><li id="bc11" class="jc jd hh je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt bi translated">现在让我们建立一个简单的机器学习模型</li></ul><pre class="ka kb kc kd fd ks kt ku kv aw kw bi"><span id="5c3f" class="kx if hh kt b fi ky kz l la lb">from pyspark.sql import SparkSession<br/>from pyspark.ml import Pipeline<br/>from pyspark.sql.functions import mean,col,split, col, regexp_extract, when, lit<br/>from pyspark.ml.feature import StringIndexer<br/>from pyspark.ml.feature import VectorAssembler<br/>from pyspark.ml.evaluation import MulticlassClassificationEvaluator<br/>from pyspark.ml.feature import QuantileDiscretizer</span></pre><ul class=""><li id="15b6" class="jc jd hh je b jf kh jh ki jj kj jl kk jn kl jp jq jr js jt bi translated">让我们看看数据帧的统计数据</li></ul><pre class="ka kb kc kd fd ks kt ku kv aw kw bi"><span id="791a" class="kx if hh kt b fi ky kz l la lb">df.describe().show()</span></pre><ul class=""><li id="45fa" class="jc jd hh je b jf kh jh ki jj kj jl kk jn kl jp jq jr js jt bi translated">显示模式</li></ul><pre class="ka kb kc kd fd ks kt ku kv aw kw bi"><span id="493f" class="kx if hh kt b fi ky kz l la lb">df.printSchema()</span></pre><ul class=""><li id="9317" class="jc jd hh je b jf kh jh ki jj kj jl kk jn kl jp jq jr js jt bi translated">让我们做一些数据工程</li></ul><pre class="ka kb kc kd fd ks kt ku kv aw kw bi"><span id="e849" class="kx if hh kt b fi ky kz l la lb">df.select("Survived","Pclass","Embarked").show()</span></pre><ul class=""><li id="8702" class="jc jd hh je b jf kh jh ki jj kj jl kk jn kl jp jq jr js jt bi translated">分组依据和计数</li></ul><pre class="ka kb kc kd fd ks kt ku kv aw kw bi"><span id="28f1" class="kx if hh kt b fi ky kz l la lb">df.groupBy("Sex","Survived").count().show()</span></pre><figure class="ka kb kc kd fd ke er es paragraph-image"><div role="button" tabindex="0" class="kn ko di kp bf kq"><div class="er es lf"><img src="../Images/b1a0dcab1cc19c2ae11c38293f552cad.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*UsItc4o-8ZA0JVwm.jpg"/></div></div></figure><ul class=""><li id="a31a" class="jc jd hh je b jf kh jh ki jj kj jl kk jn kl jp jq jr js jt bi translated">现在填入NA值</li></ul><pre class="ka kb kc kd fd ks kt ku kv aw kw bi"><span id="a057" class="kx if hh kt b fi ky kz l la lb">df = df.na.fill({"Embarked" : 'S'})<br/>df = df.drop("Cabin")</span></pre><ul class=""><li id="6bf3" class="jc jd hh je b jf kh jh ki jj kj jl kk jn kl jp jq jr js jt bi translated">创建新的列值</li></ul><pre class="ka kb kc kd fd ks kt ku kv aw kw bi"><span id="adb1" class="kx if hh kt b fi ky kz l la lb">df = df.withColumn("Family_Size",col('SibSp')+col('Parch'))</span></pre><ul class=""><li id="b8e9" class="jc jd hh je b jf kh jh ki jj kj jl kk jn kl jp jq jr js jt bi translated">索引值</li></ul><pre class="ka kb kc kd fd ks kt ku kv aw kw bi"><span id="8cfe" class="kx if hh kt b fi ky kz l la lb">indexers = [StringIndexer(inputCol=column, outputCol=column+"_index").fit(df) for column in ["Sex","Embarked"]]<br/>pipeline = Pipeline(stages=indexers)<br/>df = pipeline.fit(df).transform(df)</span></pre><ul class=""><li id="66bc" class="jc jd hh je b jf kh jh ki jj kj jl kk jn kl jp jq jr js jt bi translated">删除不必要的列</li></ul><pre class="ka kb kc kd fd ks kt ku kv aw kw bi"><span id="279b" class="kx if hh kt b fi ky kz l la lb">df = df.drop("PassengerId","Name","Ticket","Cabin","Embarked","Sex")</span></pre><ul class=""><li id="71dc" class="jc jd hh je b jf kh jh ki jj kj jl kk jn kl jp jq jr js jt bi translated">填充空值</li></ul><pre class="ka kb kc kd fd ks kt ku kv aw kw bi"><span id="30ce" class="kx if hh kt b fi ky kz l la lb">df = df.na.fill({"Age" : 10})</span></pre><ul class=""><li id="6b99" class="jc jd hh je b jf kh jh ki jj kj jl kk jn kl jp jq jr js jt bi translated">将列更改为双精度字符串</li></ul><pre class="ka kb kc kd fd ks kt ku kv aw kw bi"><span id="518f" class="kx if hh kt b fi ky kz l la lb">#Using withColumn() examples<br/>df = df.withColumn("Age",df.Age.cast('double'))<br/>df = df.withColumn("SibSp",df.SibSp.cast('double'))<br/>df = df.withColumn("Parch",df.Parch.cast('double'))<br/>df = df.withColumn("Fare",df.Fare.cast('double'))<br/>df = df.withColumn("Pclass",df.Pclass.cast('double'))<br/>df = df.withColumn("Survived",df.Survived.cast('double'))</span></pre><ul class=""><li id="64a8" class="jc jd hh je b jf kh jh ki jj kj jl kk jn kl jp jq jr js jt bi translated">特色化</li></ul><pre class="ka kb kc kd fd ks kt ku kv aw kw bi"><span id="b8db" class="kx if hh kt b fi ky kz l la lb">feature = VectorAssembler(inputCols=df.columns[1:],outputCol="features")<br/>feature_vector= feature.transform(df)</span></pre><ul class=""><li id="a066" class="jc jd hh je b jf kh jh ki jj kj jl kk jn kl jp jq jr js jt bi translated">分割训练和测试数据</li></ul><pre class="ka kb kc kd fd ks kt ku kv aw kw bi"><span id="e7a5" class="kx if hh kt b fi ky kz l la lb">(trainingData, testData) = feature_vector.randomSplit([0.8, 0.2],seed = 11)</span></pre><ul class=""><li id="ba4a" class="jc jd hh je b jf kh jh ki jj kj jl kk jn kl jp jq jr js jt bi translated">逻辑回归</li></ul><pre class="ka kb kc kd fd ks kt ku kv aw kw bi"><span id="f315" class="kx if hh kt b fi ky kz l la lb">from pyspark.ml.classification import LogisticRegression<br/>lr = LogisticRegression(labelCol="Survived", featuresCol="features")<br/>#Training algo<br/>lrModel = lr.fit(trainingData)<br/>lr_prediction = lrModel.transform(testData)<br/>lr_prediction.select("prediction", "Survived", "features").show()<br/>evaluator = MulticlassClassificationEvaluator(labelCol="Survived", predictionCol="prediction", metricName="accuracy")</span></pre><ul class=""><li id="02be" class="jc jd hh je b jf kh jh ki jj kj jl kk jn kl jp jq jr js jt bi translated">公制计算</li></ul><pre class="ka kb kc kd fd ks kt ku kv aw kw bi"><span id="8935" class="kx if hh kt b fi ky kz l la lb">lr_accuracy = evaluator.evaluate(lr_prediction)<br/>print("Accuracy of LogisticRegression is = %g"% (lr_accuracy))<br/>print("Test Error of LogisticRegression = %g " % (1.0 - lr_accuracy))</span></pre><ul class=""><li id="1fc4" class="jc jd hh je b jf kh jh ki jj kj jl kk jn kl jp jq jr js jt bi translated">现在决策树</li></ul><pre class="ka kb kc kd fd ks kt ku kv aw kw bi"><span id="3d53" class="kx if hh kt b fi ky kz l la lb">from pyspark.ml.classification import DecisionTreeClassifier<br/>dt = DecisionTreeClassifier(labelCol="Survived", featuresCol="features")<br/>dt_model = dt.fit(trainingData)<br/>dt_prediction = dt_model.transform(testData)<br/>dt_prediction.select("prediction", "Survived", "features").show()</span><span id="16dc" class="kx if hh kt b fi lc kz l la lb">dt_accuracy = evaluator.evaluate(dt_prediction)<br/>print("Accuracy of DecisionTreeClassifier is = %g"% (dt_accuracy))<br/>print("Test Error of DecisionTreeClassifier = %g " % (1.0 - dt_accuracy))</span></pre><ul class=""><li id="fdc6" class="jc jd hh je b jf kh jh ki jj kj jl kk jn kl jp jq jr js jt bi translated">梯度增强树的另一种模型</li></ul><pre class="ka kb kc kd fd ks kt ku kv aw kw bi"><span id="dc33" class="kx if hh kt b fi ky kz l la lb">from pyspark.ml.classification import GBTClassifier<br/>gbt = GBTClassifier(labelCol="Survived", featuresCol="features",maxIter=10)<br/>gbt_model = gbt.fit(trainingData)<br/>gbt_prediction = gbt_model.transform(testData)<br/>gbt_prediction.select("prediction", "Survived", "features").show()</span></pre><ul class=""><li id="0616" class="jc jd hh je b jf kh jh ki jj kj jl kk jn kl jp jq jr js jt bi translated">公制计算</li></ul><pre class="ka kb kc kd fd ks kt ku kv aw kw bi"><span id="8b59" class="kx if hh kt b fi ky kz l la lb">gbt_accuracy = evaluator.evaluate(gbt_prediction)<br/>print("Accuracy of Gradient-boosted tree classifie is = %g"% (gbt_accuracy))<br/>print("Test Error of Gradient-boosted tree classifie %g"% (1.0 - gbt_accuracy))</span></pre><figure class="ka kb kc kd fd ke er es paragraph-image"><div role="button" tabindex="0" class="kn ko di kp bf kq"><div class="er es lg"><img src="../Images/7bf4da679a76f97a59496ddf6d8272d2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*8spy2y11OJOAsyEL.jpg"/></div></div></figure><p id="fcaa" class="pw-post-body-paragraph lh li hh je b jf kh lj lk jh ki ll lm jj ln lo lp jl lq lr ls jn lt lu lv jp ha bi translated">原文—<a class="ae lw" href="https://github.com/balakreshnan/Samples2022/blob/main/AzureMLV2/managedspark1.md" rel="noopener ugc nofollow" target="_blank">samples 2022/managed spark 1 . MD at main balakreshnan/samples 2022(github.com)</a></p><div class="lx ly ez fb lz ma"><a rel="noopener follow" target="_blank" href="/mlearning-ai/mlearning-ai-submission-suggestions-b51e2b130bfb"><div class="mb ab dw"><div class="mc ab md cl cj me"><h2 class="bd hi fi z dy mf ea eb mg ed ef hg bi translated">Mlearning.ai提交建议</h2><div class="mh l"><h3 class="bd b fi z dy mf ea eb mg ed ef dx translated">如何成为Mlearning.ai上的作家</h3></div><div class="mi l"><p class="bd b fp z dy mf ea eb mg ed ef dx translated">medium.com</p></div></div><div class="mj l"><div class="mk l ml mm mn mj mo kf ma"/></div></div></a></div></div></div>    
</body>
</html>