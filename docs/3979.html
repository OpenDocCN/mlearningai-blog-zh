<html>
<head>
<title>Azure Machine Learning Auto Encoder Anomaly Detection Sample</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Azure机器学习自动编码器异常检测示例</h1>
<blockquote>原文：<a href="https://medium.com/mlearning-ai/azure-machine-learning-auto-encoder-anomaly-detection-sample-4f8f71170517?source=collection_archive---------1-----------------------#2022-11-19">https://medium.com/mlearning-ai/azure-machine-learning-auto-encoder-anomaly-detection-sample-4f8f71170517?source=collection_archive---------1-----------------------#2022-11-19</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><h1 id="b7e8" class="ie if hh bd ig ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb bi translated">使用自动编码器的异常检测</h1><h1 id="dd93" class="ie if hh bd ig ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb bi translated">先决条件</h1><ul class=""><li id="ae61" class="jc jd hh je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt bi translated">Azure帐户</li><li id="6429" class="jc jd hh je b jf ju jh jv jj jw jl jx jn jy jp jq jr js jt bi translated">Azure机器学习服务</li></ul><pre class="jz ka kb kc fd kd ke kf kg aw kh bi"><span id="87eb" class="ki if hh ke b fi kj kk l kl km">Note: This sample is from Tensorflow to show how it works in Azure Machine Learning.<br/>I have not installed any libraries in the Azure Machine Learning environment.<br/>I am using python 3.8 Tensorflow and Pytorch as kernel</span></pre><ul class=""><li id="5d28" class="jc jd hh je b jf kn jh ko jj kp jl kq jn kr jp jq jr js jt bi translated">下面是来自</li><li id="d63a" class="jc jd hh je b jf ju jh jv jj jw jl jx jn jy jp jq jr js jt bi translated"><a class="ae ks" href="https://www.tensorflow.org/tutorials/generative/autoencoder" rel="noopener ugc nofollow" target="_blank">https://www.tensorflow.org/tutorials/generative/autoencoder</a></li><li id="1ff4" class="jc jd hh je b jf ju jh jv jj jw jl jx jn jy jp jq jr js jt bi translated">也使用开源数据集</li></ul><h1 id="86c7" class="ie if hh bd ig ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb bi translated">密码</h1><ul class=""><li id="c81c" class="jc jd hh je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt bi translated">首先下载数据集</li></ul><pre class="jz ka kb kc fd kd ke kf kg aw kh bi"><span id="b606" class="ki if hh ke b fi kj kk l kl km"># Download the dataset<br/>dataframe = pd.read_csv('http://storage.googleapis.com/download.tensorflow.org/data/ecg.csv', header=None)<br/>raw_data = dataframe.values<br/>dataframe.head()</span></pre><ul class=""><li id="9560" class="jc jd hh je b jf kn jh ko jj kp jl kq jn kr jp jq jr js jt bi translated">将数据分为训练和测试</li></ul><pre class="jz ka kb kc fd kd ke kf kg aw kh bi"><span id="a328" class="ki if hh ke b fi kj kk l kl km"># The last element contains the labels<br/>labels = raw_data[:, -1]</span><span id="38f7" class="ki if hh ke b fi kt kk l kl km"># The other data points are the electrocadriogram data<br/>data = raw_data[:, 0:-1]</span><span id="9a8d" class="ki if hh ke b fi kt kk l kl km">train_data, test_data, train_labels, test_labels = train_test_split(<br/>    data, labels, test_size=0.2, random_state=21<br/>)</span></pre><ul class=""><li id="7571" class="jc jd hh je b jf kn jh ko jj kp jl kq jn kr jp jq jr js jt bi translated">数据集之上的过程</li></ul><pre class="jz ka kb kc fd kd ke kf kg aw kh bi"><span id="71a3" class="ki if hh ke b fi kj kk l kl km">min_val = tf.reduce_min(train_data)<br/>max_val = tf.reduce_max(train_data)</span><span id="1a33" class="ki if hh ke b fi kt kk l kl km">train_data = (train_data - min_val) / (max_val - min_val)<br/>test_data = (test_data - min_val) / (max_val - min_val)</span><span id="57ad" class="ki if hh ke b fi kt kk l kl km">train_data = tf.cast(train_data, tf.float32)<br/>test_data = tf.cast(test_data, tf.float32)</span></pre><ul class=""><li id="6238" class="jc jd hh je b jf kn jh ko jj kp jl kq jn kr jp jq jr js jt bi translated">设置标签</li></ul><pre class="jz ka kb kc fd kd ke kf kg aw kh bi"><span id="55d1" class="ki if hh ke b fi kj kk l kl km">train_labels = train_labels.astype(bool)<br/>test_labels = test_labels.astype(bool)</span><span id="20c6" class="ki if hh ke b fi kt kk l kl km">normal_train_data = train_data[train_labels]<br/>normal_test_data = test_data[test_labels]</span><span id="4a68" class="ki if hh ke b fi kt kk l kl km">anomalous_train_data = train_data[~train_labels]<br/>anomalous_test_data = test_data[~test_labels]</span></pre><ul class=""><li id="7d1b" class="jc jd hh je b jf kn jh ko jj kp jl kq jn kr jp jq jr js jt bi translated">绘制数据</li></ul><pre class="jz ka kb kc fd kd ke kf kg aw kh bi"><span id="bf05" class="ki if hh ke b fi kj kk l kl km">plt.grid()<br/>plt.plot(np.arange(140), normal_train_data[0])<br/>plt.title("A Normal ECG")<br/>plt.show()</span></pre><figure class="jz ka kb kc fd kv er es paragraph-image"><div class="er es ku"><img src="../Images/318edf87f91a16ec1f6a4096bcc72dec.png" data-original-src="https://miro.medium.com/v2/resize:fit:1374/format:webp/0*Omh9Vc_jC0DC2jfw.jpg"/></div></figure><pre class="jz ka kb kc fd kd ke kf kg aw kh bi"><span id="9df6" class="ki if hh ke b fi kj kk l kl km">plt.grid()<br/>plt.plot(np.arange(140), anomalous_train_data[0])<br/>plt.title("An Anomalous ECG")<br/>plt.show()</span></pre><figure class="jz ka kb kc fd kv er es paragraph-image"><div role="button" tabindex="0" class="kz la di lb bf lc"><div class="er es ky"><img src="../Images/f497ab4128f2f3deaea764d16ff7f330.png" data-original-src="https://miro.medium.com/v2/resize:fit:1214/format:webp/0*pgdMc3RgEGj6JytZ.jpg"/></div></div></figure><ul class=""><li id="7041" class="jc jd hh je b jf kn jh ko jj kp jl kq jn kr jp jq jr js jt bi translated">创建模型</li></ul><pre class="jz ka kb kc fd kd ke kf kg aw kh bi"><span id="893a" class="ki if hh ke b fi kj kk l kl km">class AnomalyDetector(Model):<br/>  def __init__(self):<br/>    super(AnomalyDetector, self).__init__()<br/>    self.encoder = tf.keras.Sequential([<br/>      layers.Dense(32, activation="relu"),<br/>      layers.Dense(16, activation="relu"),<br/>      layers.Dense(8, activation="relu")])</span><span id="9550" class="ki if hh ke b fi kt kk l kl km">    self.decoder = tf.keras.Sequential([<br/>      layers.Dense(16, activation="relu"),<br/>      layers.Dense(32, activation="relu"),<br/>      layers.Dense(140, activation="sigmoid")])</span><span id="4460" class="ki if hh ke b fi kt kk l kl km">  def call(self, x):<br/>    encoded = self.encoder(x)<br/>    decoded = self.decoder(encoded)<br/>    return decoded</span><span id="c309" class="ki if hh ke b fi kt kk l kl km">autoencoder = AnomalyDetector()</span></pre><ul class=""><li id="b53d" class="jc jd hh je b jf kn jh ko jj kp jl kq jn kr jp jq jr js jt bi translated">设置优化器</li></ul><pre class="jz ka kb kc fd kd ke kf kg aw kh bi"><span id="d25d" class="ki if hh ke b fi kj kk l kl km">autoencoder.compile(optimizer='adam', loss='mae')</span></pre><ul class=""><li id="7d1c" class="jc jd hh je b jf kn jh ko jj kp jl kq jn kr jp jq jr js jt bi translated">训练模型</li></ul><pre class="jz ka kb kc fd kd ke kf kg aw kh bi"><span id="afb3" class="ki if hh ke b fi kj kk l kl km">history = autoencoder.fit(normal_train_data, normal_train_data, <br/>          epochs=20, <br/>          batch_size=512,<br/>          validation_data=(test_data, test_data),<br/>          shuffle=True)</span></pre><ul class=""><li id="192e" class="jc jd hh je b jf kn jh ko jj kp jl kq jn kr jp jq jr js jt bi translated">绘制损失指标</li></ul><pre class="jz ka kb kc fd kd ke kf kg aw kh bi"><span id="2d7c" class="ki if hh ke b fi kj kk l kl km">plt.plot(history.history["loss"], label="Training Loss")<br/>plt.plot(history.history["val_loss"], label="Validation Loss")<br/>plt.legend()</span></pre><figure class="jz ka kb kc fd kv er es paragraph-image"><div class="er es ld"><img src="../Images/34639fc87db0edf69c10993fadc72f87.png" data-original-src="https://miro.medium.com/v2/resize:fit:1290/format:webp/0*RWgmPeydSLgngKAi.jpg"/></div></figure><ul class=""><li id="e342" class="jc jd hh je b jf kn jh ko jj kp jl kq jn kr jp jq jr js jt bi translated">现在错误是</li></ul><pre class="jz ka kb kc fd kd ke kf kg aw kh bi"><span id="7cca" class="ki if hh ke b fi kj kk l kl km">encoded_data = autoencoder.encoder(normal_test_data).numpy()<br/>decoded_data = autoencoder.decoder(encoded_data).numpy()</span><span id="2889" class="ki if hh ke b fi kt kk l kl km">plt.plot(normal_test_data[0], 'b')<br/>plt.plot(decoded_data[0], 'r')<br/>plt.fill_between(np.arange(140), decoded_data[0], normal_test_data[0], color='lightcoral')<br/>plt.legend(labels=["Input", "Reconstruction", "Error"])<br/>plt.show()</span></pre><figure class="jz ka kb kc fd kv er es paragraph-image"><div role="button" tabindex="0" class="kz la di lb bf lc"><div class="er es le"><img src="../Images/5c48e1ee7ba80d8bb56a51709a23e4c4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1208/format:webp/0*YheXBTsbzI9Xd_Dc.jpg"/></div></div></figure><pre class="jz ka kb kc fd kd ke kf kg aw kh bi"><span id="79c1" class="ki if hh ke b fi kj kk l kl km">encoded_data = autoencoder.encoder(anomalous_test_data).numpy()<br/>decoded_data = autoencoder.decoder(encoded_data).numpy()</span><span id="ce6b" class="ki if hh ke b fi kt kk l kl km">plt.plot(anomalous_test_data[0], 'b')<br/>plt.plot(decoded_data[0], 'r')<br/>plt.fill_between(np.arange(140), decoded_data[0], anomalous_test_data[0], color='lightcoral')<br/>plt.legend(labels=["Input", "Reconstruction", "Error"])<br/>plt.show()</span></pre><figure class="jz ka kb kc fd kv er es paragraph-image"><div class="er es lf"><img src="../Images/61e800c296a8d9cdc368543fb8508e96.png" data-original-src="https://miro.medium.com/v2/resize:fit:1164/format:webp/0*H_Zv_ALI_Q61aQ9n.jpg"/></div></figure><ul class=""><li id="c876" class="jc jd hh je b jf kn jh ko jj kp jl kq jn kr jp jq jr js jt bi translated">现在预测</li></ul><p id="7981" class="pw-post-body-paragraph lg lh hh je b jf kn li lj jh ko lk ll jj lm ln lo jl lp lq lr jn ls lt lu jp ha bi translated">re constructions = auto encoder . predict(normal_train_data)train _ loss = TF . keras . loss . Mae(re constructions，normal _ train _ data)</p><pre class="jz ka kb kc fd kd ke kf kg aw kh bi"><span id="61a4" class="ki if hh ke b fi kj kk l kl km">plt.hist(train_loss[None,:], bins=50)<br/>plt.xlabel("Train loss")<br/>plt.ylabel("No of examples")<br/>plt.show()</span></pre><figure class="jz ka kb kc fd kv er es paragraph-image"><div role="button" tabindex="0" class="kz la di lb bf lc"><div class="er es lv"><img src="../Images/892117cee44aeae77cce9dff5c99de81.png" data-original-src="https://miro.medium.com/v2/resize:fit:1352/format:webp/0*ZRsXHXUArCUJrZu7.jpg"/></div></div></figure><ul class=""><li id="c959" class="jc jd hh je b jf kn jh ko jj kp jl kq jn kr jp jq jr js jt bi translated">阈值计算</li></ul><pre class="jz ka kb kc fd kd ke kf kg aw kh bi"><span id="1818" class="ki if hh ke b fi kj kk l kl km">threshold = np.mean(train_loss) + np.std(train_loss)<br/>print("Threshold: ", threshold)</span><span id="1784" class="ki if hh ke b fi kt kk l kl km">reconstructions = autoencoder.predict(anomalous_test_data)<br/>test_loss = tf.keras.losses.mae(reconstructions, anomalous_test_data)</span><span id="3f52" class="ki if hh ke b fi kt kk l kl km">plt.hist(test_loss[None, :], bins=50)<br/>plt.xlabel("Test loss")<br/>plt.ylabel("No of examples")<br/>plt.show()</span></pre><figure class="jz ka kb kc fd kv er es paragraph-image"><div role="button" tabindex="0" class="kz la di lb bf lc"><div class="er es lw"><img src="../Images/ed6f19d597ea7ce037ada0af8829e415.png" data-original-src="https://miro.medium.com/v2/resize:fit:1328/format:webp/0*SLTxuhOmIEVoHeVh.jpg"/></div></div></figure><ul class=""><li id="b2ff" class="jc jd hh je b jf kn jh ko jj kp jl kq jn kr jp jq jr js jt bi translated">预测功能</li></ul><pre class="jz ka kb kc fd kd ke kf kg aw kh bi"><span id="9879" class="ki if hh ke b fi kj kk l kl km">def predict(model, data, threshold):<br/>  reconstructions = model(data)<br/>  loss = tf.keras.losses.mae(reconstructions, data)<br/>  return tf.math.less(loss, threshold)</span><span id="0cc2" class="ki if hh ke b fi kt kk l kl km">def print_stats(predictions, labels):<br/>  print("Accuracy = {}".format(accuracy_score(labels, predictions)))<br/>  print("Precision = {}".format(precision_score(labels, predictions)))<br/>  print("Recall = {}".format(recall_score(labels, predictions)))</span></pre><ul class=""><li id="11f0" class="jc jd hh je b jf kn jh ko jj kp jl kq jn kr jp jq jr js jt bi translated">预测并打印统计数据</li></ul><pre class="jz ka kb kc fd kd ke kf kg aw kh bi"><span id="7abf" class="ki if hh ke b fi kj kk l kl km">preds = predict(autoencoder, test_data, threshold)<br/>print_stats(preds, test_labels)</span></pre><figure class="jz ka kb kc fd kv er es paragraph-image"><div role="button" tabindex="0" class="kz la di lb bf lc"><div class="er es lx"><img src="../Images/f6aeed8ac5f18b00835c05f8eaf43806.png" data-original-src="https://miro.medium.com/v2/resize:fit:1308/format:webp/0*7EO3UEwRghZtcfn8.jpg"/></div></div></figure><p id="9ea6" class="pw-post-body-paragraph lg lh hh je b jf kn li lj jh ko lk ll jj lm ln lo jl lp lq lr jn ls lt lu jp ha bi translated">原文章在【github.com T2】samples 2022/auto encoder sample 1 . MD在主balakreshnan/samples 2022</p><div class="ly lz ez fb ma mb"><a rel="noopener follow" target="_blank" href="/mlearning-ai/mlearning-ai-submission-suggestions-b51e2b130bfb"><div class="mc ab dw"><div class="md ab me cl cj mf"><h2 class="bd hi fi z dy mg ea eb mh ed ef hg bi translated">Mlearning.ai提交建议</h2><div class="mi l"><h3 class="bd b fi z dy mg ea eb mh ed ef dx translated">如何成为Mlearning.ai上的作家</h3></div><div class="mj l"><p class="bd b fp z dy mg ea eb mh ed ef dx translated">medium.com</p></div></div><div class="mk l"><div class="ml l mm mn mo mk mp kw mb"/></div></div></a></div></div></div>    
</body>
</html>