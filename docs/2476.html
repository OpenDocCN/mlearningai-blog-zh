<html>
<head>
<title>Scheduling Google Cloud Functions to Run Periodically</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">安排谷歌云功能定期运行</h1>
<blockquote>原文：<a href="https://medium.com/mlearning-ai/scheduling-google-cloud-functions-to-run-periodically-4fd3e763e78f?source=collection_archive---------3-----------------------#2022-05-07">https://medium.com/mlearning-ai/scheduling-google-cloud-functions-to-run-periodically-4fd3e763e78f?source=collection_archive---------3-----------------------#2022-05-07</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><blockquote class="ie if ig"><p id="796f" class="ih ii ij ik b il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf ha bi translated">周期性地触发GCP云功能</p></blockquote><figure class="jh ji jj jk fd jl er es paragraph-image"><div role="button" tabindex="0" class="jm jn di jo bf jp"><div class="er es jg"><img src="../Images/f98ad25cec5deb3d87c5db6952fcd71c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*DGC_pwe3abzNgr-_"/></div></div><figcaption class="js jt et er es ju jv bd b be z dx">Photo by <a class="ae jw" href="https://unsplash.com/@alex_vicol?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">alexandru vicol</a> on <a class="ae jw" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure></div><div class="ab cl jx jy go jz" role="separator"><span class="ka bw bk kb kc kd"/><span class="ka bw bk kb kc kd"/><span class="ka bw bk kb kc"/></div><div class="ha hb hc hd he"><p id="a35f" class="pw-post-body-paragraph ih ii hh ik b il im in io ip iq ir is ke iu iv iw kf iy iz ja kg jc jd je jf ha bi translated">很多时候，我们需要定期运行一段代码。它可以在机器学习模型上执行推理、处理日志文件、调用API端点和存储结果等。手动运行此类作业效率非常低，因此我们寻找一种自动化的解决方案。这里有一个好消息。我们可以使用谷歌云平台的云调度器来安排GCP计算服务定期运行。万岁！！</p><p id="aea3" class="pw-post-body-paragraph ih ii hh ik b il im in io ip iq ir is ke iu iv iw kf iy iz ja kg jc jd je jf ha bi translated">在这篇文章中，我们将看到如何使用GCP的云调度器来调度谷歌云功能(T1)，这是一个由GCP提供的<a class="ae jw" rel="noopener" href="/mlearning-ai/serverless-computing-your-new-friend-from-the-world-of-cloud-6606117deeaf">无服务器计算服务(T3)。<strong class="ik hi">注:</strong></a></p><ol class=""><li id="9d45" class="kh ki hh ik b il im ip iq ke kj kf kk kg kl jf km kn ko kp bi translated"><em class="ij">本文假设您已经拥有一个GCP账户。如果你没有，请在这里</em>  <em class="ij">注册</em> <a class="ae jw" href="https://cloud.google.com/" rel="noopener ugc nofollow" target="_blank"> <em class="ij">。在GCP，激活后的前90天，您可以获得价值300美元的积分。</em></a></li></ol><p id="6ed8" class="pw-post-body-paragraph ih ii hh ik b il im in io ip iq ir is ke iu iv iw kf iy iz ja kg jc jd je jf ha bi translated"><em class="ij"> 2。确保在您的GCP项目中使用</em> <a class="ae jw" href="https://console.developers.google.com/" rel="noopener ugc nofollow" target="_blank"> <em class="ij"> API控制台</em> </a> <em class="ij">为Google云存储、功能和调度器</em> <a class="ae jw" href="https://cloud.google.com/service-usage/docs/enable-disable" rel="noopener ugc nofollow" target="_blank"> <em class="ij">启用API</em></a><em class="ij">。</em></p><p id="7252" class="pw-post-body-paragraph ih ii hh ik b il im in io ip iq ir is ke iu iv iw kf iy iz ja kg jc jd je jf ha bi translated">不要再耽搁了，让我们开始吧。</p></div><div class="ab cl jx jy go jz" role="separator"><span class="ka bw bk kb kc kd"/><span class="ka bw bk kb kc kd"/><span class="ka bw bk kb kc"/></div><div class="ha hb hc hd he"><p id="afe3" class="pw-post-body-paragraph ih ii hh ik b il im in io ip iq ir is ke iu iv iw kf iy iz ja kg jc jd je jf ha bi translated">我们的任务</p><p id="9c26" class="pw-post-body-paragraph ih ii hh ik b il im in io ip iq ir is ke iu iv iw kf iy iz ja kg jc jd je jf ha bi translated">出于本文的目的，我们希望调度一个云函数，它每分钟在一个<strong class="ik hi"> <em class="ij"> google云存储</em> </strong>桶中存储一个文本文件。云架构看起来是这样的:</p><figure class="jh ji jj jk fd jl er es paragraph-image"><div role="button" tabindex="0" class="jm jn di jo bf jp"><div class="er es kq"><img src="../Images/4d767adc8056e2a6c25872709308eff4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Y1IK83p9US3ipifTYW-AoA.png"/></div></div><figcaption class="js jt et er es ju jv bd b be z dx">Cloud Architecture (source: author)</figcaption></figure><p id="cd2e" class="pw-post-body-paragraph ih ii hh ik b il im in io ip iq ir is ke iu iv iw kf iy iz ja kg jc jd je jf ha bi translated">我们将使用GCP的3个服务来完成我们的任务。</p><ol class=""><li id="67f9" class="kh ki hh ik b il im ip iq ke kj kf kk kg kl jf km kn ko kp bi translated"><strong class="ik hi">云调度器:</strong>来自GCP云调度器文档-<em class="ij"/><em class="ij">云调度器是一款完全托管的企业级cron作业调度器。它允许您安排几乎任何作业，包括批处理、大数据作业、云基础架构操作等。您可以自动执行所有操作，包括失败时的重试，以减少手动操作和干预。”它基本上可以安排任何事情。在我们的例子中，我们使用它每60秒发送一次HTTP请求来触发我们的云功能。</em></li><li id="d77d" class="kh ki hh ik b il kr ip ks ke kt kf ku kg kv jf km kn ko kp bi translated"><strong class="ik hi">云功能:</strong>云功能允许我们在云中运行代码，无需管理服务器或容器。Cloud Functions是一款可扩展、现收现付的功能即服务(FaaS)产品，帮助我们用简单、单一用途的代码构建和连接事件驱动的服务。可以使用HTTP请求、发布/订阅事件、云Firestore等来触发云功能。这里，我们将使用HTTP请求来触发我们的云功能。</li><li id="8ef8" class="kh ki hh ik b il kr ip ks ke kt kf ku kg kv jf km kn ko kp bi translated"><strong class="ik hi">云存储:</strong>这是谷歌提供的一种存储服务，允许我们存储和检索我们的数据。在GCS中，我们将数据存储在桶中。</li></ol></div><div class="ab cl jx jy go jz" role="separator"><span class="ka bw bk kb kc kd"/><span class="ka bw bk kb kc kd"/><span class="ka bw bk kb kc"/></div><div class="ha hb hc hd he"><p id="7bc0" class="pw-post-body-paragraph ih ii hh ik b il im in io ip iq ir is ke iu iv iw kf iy iz ja kg jc jd je jf ha bi translated"><strong class="ik hi">实现架构</strong></p><ol class=""><li id="57b4" class="kh ki hh ik b il im ip iq ke kj kf kk kg kl jf km kn ko kp bi translated"><strong class="ik hi">创建一个谷歌云存储桶</strong></li></ol><p id="3773" class="pw-post-body-paragraph ih ii hh ik b il im in io ip iq ir is ke iu iv iw kf iy iz ja kg jc jd je jf ha bi translated">在GCP控制台中，搜索云存储的存储。进入云存储部分后，点击<strong class="ik hi"> <em class="ij">创建桶</em> </strong>。</p><figure class="jh ji jj jk fd jl er es paragraph-image"><div class="er es kw"><img src="../Images/d5be24d05c4af79b467a303f423aa3ff.png" data-original-src="https://miro.medium.com/v2/resize:fit:1204/format:webp/1*QRPvDxYaSPNZn2pxCgP2BQ.png"/></div><figcaption class="js jt et er es ju jv bd b be z dx">Cloud Storage Creation (source: author)</figcaption></figure><p id="2df2" class="pw-post-body-paragraph ih ii hh ik b il im in io ip iq ir is ke iu iv iw kf iy iz ja kg jc jd je jf ha bi translated">给bucket一个合适的名称，并确保在计划运行云函数的同一区域创建bucket。为了简单起见，我们让其余的设置保持原样，并点击<strong class="ik hi">创建</strong>。</p><p id="ada7" class="pw-post-body-paragraph ih ii hh ik b il im in io ip iq ir is ke iu iv iw kf iy iz ja kg jc jd je jf ha bi translated"><strong class="ik hi"> 2。配置云功能</strong></p><p id="fc81" class="pw-post-body-paragraph ih ii hh ik b il im in io ip iq ir is ke iu iv iw kf iy iz ja kg jc jd je jf ha bi translated">在GCP控制台中，搜索云存储的存储。进入云存储部分后，点击<strong class="ik hi"> <em class="ij">创建功能</em> </strong>。恰当地命名云函数。将<strong class="ik hi"> <em class="ij">的触发类型设置为HTTP。</em> </strong> <em class="ij"> </em>你必须看到一个网址显示出来。这个URL将用于触发云功能。复制这个网址，因为我们很快就会用到它。勾选认证部分的<em class="ij"> ' </em> <strong class="ik hi"> <em class="ij">要求认证</em> </strong> <em class="ij"> ' </em>选项。点击<strong class="ik hi">保存</strong>。</p><figure class="jh ji jj jk fd jl er es paragraph-image"><div class="er es kx"><img src="../Images/d78b1eb7c35963c1d79abadd2e6e13fd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1092/format:webp/1*biJ54gqqrPD_MYXgjdx-Gg.png"/></div><figcaption class="js jt et er es ju jv bd b be z dx">Cloud Function Configuration (source: Authour)</figcaption></figure><p id="5cd1" class="pw-post-body-paragraph ih ii hh ik b il im in io ip iq ir is ke iu iv iw kf iy iz ja kg jc jd je jf ha bi translated">为了简单起见，我们不会涉及<strong class="ik hi">运行时、构建、连接和安全设置</strong>。现在点击下一步。</p><p id="3871" class="pw-post-body-paragraph ih ii hh ik b il im in io ip iq ir is ke iu iv iw kf iy iz ja kg jc jd je jf ha bi translated">3.<strong class="ik hi">编写功能代码</strong></p><p id="1970" class="pw-post-body-paragraph ih ii hh ik b il im in io ip iq ir is ke iu iv iw kf iy iz ja kg jc jd je jf ha bi translated">现在我们将编写代码来存储所需的文本文件。我们将使用内联源代码编辑器窗口来编写代码。</p><figure class="jh ji jj jk fd jl er es paragraph-image"><div role="button" tabindex="0" class="jm jn di jo bf jp"><div class="er es ky"><img src="../Images/641a1100bfeeb65a0dcf873f21b57e4f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8nzCD9pHbhUMPNcHrvE7HA.png"/></div></div><figcaption class="js jt et er es ju jv bd b be z dx">Inline Code Editor (source: author)</figcaption></figure><p id="b418" class="pw-post-body-paragraph ih ii hh ik b il im in io ip iq ir is ke iu iv iw kf iy iz ja kg jc jd je jf ha bi translated">首先，我们将选择<strong class="ik hi">运行时环境</strong>作为Python 3.9，因为我们将用Python编码。</p><p id="416e" class="pw-post-body-paragraph ih ii hh ik b il im in io ip iq ir is ke iu iv iw kf iy iz ja kg jc jd je jf ha bi translated">我们有两个文件，main.py和requirements.txt。</p><p id="c77a" class="pw-post-body-paragraph ih ii hh ik b il im in io ip iq ir is ke iu iv iw kf iy iz ja kg jc jd je jf ha bi translated"><strong class="ik hi"> main.py </strong>文件包含每当函数被触发时将被执行的代码。当然，它有一个名为“hello_word”的函数。如果我们看到<strong class="ik hi">入口点</strong>字段，我们将在那里找到函数名。hello_word函数是代码的入口点。我们可以更改这个函数的名称，但是我们需要确保在<strong class="ik hi">入口点</strong>函数名称选项卡中相应地更新它。在这里，我们将使用“hello-world”这个名称。</p><p id="9176" class="pw-post-body-paragraph ih ii hh ik b il im in io ip iq ir is ke iu iv iw kf iy iz ja kg jc jd je jf ha bi translated"><strong class="ik hi"> requirements.txt: </strong>这是我们声明需要安装在云函数环境中以执行我们的函数的库的地方。默认情况下，环境<a class="ae jw" href="https://cloud.google.com/functions/docs/writing/specifying-dependencies-python#python38" rel="noopener ugc nofollow" target="_blank">预装了一堆库</a>。既然，我们将使用<strong class="ik hi"> <em class="ij">云客户端库</em> </strong> <em class="ij"> </em>为<strong class="ik hi"> <em class="ij"> Google云存储API </em> </strong> <em class="ij">，</em>我们需要将它添加到requirements.txt中</p><p id="3c3e" class="pw-post-body-paragraph ih ii hh ik b il im in io ip iq ir is ke iu iv iw kf iy iz ja kg jc jd je jf ha bi translated">请在下面找到完整的代码。</p><figure class="jh ji jj jk fd jl"><div class="bz dy l di"><div class="kz la l"/></div></figure><p id="98dd" class="pw-post-body-paragraph ih ii hh ik b il im in io ip iq ir is ke iu iv iw kf iy iz ja kg jc jd je jf ha bi translated">现在我们可以点击<strong class="ik hi">部署</strong>按钮。</p><p id="0cc7" class="pw-post-body-paragraph ih ii hh ik b il im in io ip iq ir is ke iu iv iw kf iy iz ja kg jc jd je jf ha bi translated">部署通常只需要几分钟，因为云功能环境已经建立，所有的需求都已经安装。</p><p id="e531" class="pw-post-body-paragraph ih ii hh ik b il im in io ip iq ir is ke iu iv iw kf iy iz ja kg jc jd je jf ha bi translated">函数名称旁边的绿色对勾表示该函数已成功部署。</p><figure class="jh ji jj jk fd jl er es paragraph-image"><div role="button" tabindex="0" class="jm jn di jo bf jp"><div class="er es lb"><img src="../Images/a58a85d790257bb99f2921ebb3713137.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Z2qN9XphBufivYVpPmmIPw.png"/></div></div><figcaption class="js jt et er es ju jv bd b be z dx">Function Deployed (source: author)</figcaption></figure><p id="28b2" class="pw-post-body-paragraph ih ii hh ik b il im in io ip iq ir is ke iu iv iw kf iy iz ja kg jc jd je jf ha bi translated"><strong class="ik hi"> 4。调度功能</strong></p><p id="b2e7" class="pw-post-body-paragraph ih ii hh ik b il im in io ip iq ir is ke iu iv iw kf iy iz ja kg jc jd je jf ha bi translated">在GCP控制台中，搜索<strong class="ik hi">云调度器</strong>的存储。进入云调度器部分后，点击<strong class="ik hi"> <em class="ij">创建作业</em> </strong>。恰当地命名工作。</p><figure class="jh ji jj jk fd jl er es paragraph-image"><div class="er es lc"><img src="../Images/d9beda638cf7dd14f5a2c8f169a42b59.png" data-original-src="https://miro.medium.com/v2/resize:fit:1066/format:webp/1*TPTAvI9F4eaPMfvZdY2pXQ.png"/></div><figcaption class="js jt et er es ju jv bd b be z dx">Scheduler(source:author)</figcaption></figure><p id="9b9a" class="pw-post-body-paragraph ih ii hh ik b il im in io ip iq ir is ke iu iv iw kf iy iz ja kg jc jd je jf ha bi translated">在<strong class="ik hi">下定义作业</strong>部分，给出一个合适的名称，并使用<a class="ae jw" href="https://cloud.google.com/scheduler/docs/configuring/cron-job-schedules?authuser=2&amp;_ga=2.31043967.-1173050656.1648539756&amp;_gac=1.248893941.1650463643.Cj0KCQjw3v6SBhCsARIsACyrRAm38_2oMi078HoUjTF87cat_MwgO8osjfQCpRxIKHF5jDXbW5Rxo9gaAkgAEALw_wcB#defining_the_job_schedule" rel="noopener ugc nofollow" target="_blank"> unix-cron格式</a>，指定调度频率。因为我们想安排我们的函数每分钟运行一次，所以我们使用<strong class="ik hi">* * * *</strong>作为频率。选择合适的时区。</p><p id="551f" class="pw-post-body-paragraph ih ii hh ik b il im in io ip iq ir is ke iu iv iw kf iy iz ja kg jc jd je jf ha bi translated">现在，在配置执行部分，选择<strong class="ik hi"> HTTP </strong>作为目标类型。粘贴云函数的URL(我们之前复制的那个)并在HTTP方法中选择<strong class="ik hi"> GET </strong>。</p><p id="7981" class="pw-post-body-paragraph ih ii hh ik b il im in io ip iq ir is ke iu iv iw kf iy iz ja kg jc jd je jf ha bi translated">现在点击<strong class="ik hi">创建。</strong></p><p id="7dbb" class="pw-post-body-paragraph ih ii hh ik b il im in io ip iq ir is ke iu iv iw kf iy iz ja kg jc jd je jf ha bi translated">这应该每60秒触发一次我们的云功能。但是，我们可以点击调度程序作业页面中的<strong class="ik hi">立即运行</strong>，立即运行该功能。</p><p id="64a9" class="pw-post-body-paragraph ih ii hh ik b il im in io ip iq ir is ke iu iv iw kf iy iz ja kg jc jd je jf ha bi translated">您应该能够在云存储桶中看到一个文本文件，它是在您单击<strong class="ik hi"> run now </strong>时创建的。如果出现错误，请检查日志进行诊断。</p><p id="7282" class="pw-post-body-paragraph ih ii hh ik b il im in io ip iq ir is ke iu iv iw kf iy iz ja kg jc jd je jf ha bi translated">您应该会看到每60秒钟就有新文件上传到bucket中。</p><figure class="jh ji jj jk fd jl er es paragraph-image"><div role="button" tabindex="0" class="jm jn di jo bf jp"><div class="er es ld"><img src="../Images/009dea787de2560984e9177c9d41c06d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YDnXjA2TX0Gb-E9vhEoF4w.png"/></div></div><figcaption class="js jt et er es ju jv bd b be z dx">A new file getting added after every 60 seconds(source: author)</figcaption></figure><p id="b7fc" class="pw-post-body-paragraph ih ii hh ik b il im in io ip iq ir is ke iu iv iw kf iy iz ja kg jc jd je jf ha bi translated"><strong class="ik hi">暂停云调度器</strong></p><p id="5ca4" class="pw-post-body-paragraph ih ii hh ik b il im in io ip iq ir is ke iu iv iw kf iy iz ja kg jc jd je jf ha bi translated">强烈建议在不需要时暂停调度程序作业。否则，它将继续触发您的功能，并不断增加成本。</p><p id="fc8a" class="pw-post-body-paragraph ih ii hh ik b il im in io ip iq ir is ke iu iv iw kf iy iz ja kg jc jd je jf ha bi translated"><strong class="ik hi">结论</strong></p><p id="ab85" class="pw-post-body-paragraph ih ii hh ik b il im in io ip iq ir is ke iu iv iw kf iy iz ja kg jc jd je jf ha bi translated">恭喜你！！您已经使用GCP云调度器和云功能成功调度了您的代码。定期运行代码并存储其结果有无数的用例。现在，使用cloud scheduler来调度其他类型的任务对你来说应该不是什么难事。我希望你喜欢这篇文章。下一篇文章再见。</p><p id="cda1" class="pw-post-body-paragraph ih ii hh ik b il im in io ip iq ir is ke iu iv iw kf iy iz ja kg jc jd je jf ha bi translated"><strong class="ik hi"> <em class="ij">你可能也会喜欢我的这些文章:</em> </strong></p><div class="le lf ez fb lg lh"><a rel="noopener follow" target="_blank" href="/mlearning-ai/serverless-computing-your-new-friend-from-the-world-of-cloud-6606117deeaf"><div class="li ab dw"><div class="lj ab lk cl cj ll"><h2 class="bd hi fi z dy lm ea eb ln ed ef hg bi translated">无服务器计算—您来自云计算世界的新朋友</h2><div class="lo l"><h3 class="bd b fi z dy lm ea eb ln ed ef dx translated">它在你需要的时候服务，并且你可以随时付款</h3></div><div class="lp l"><p class="bd b fp z dy lm ea eb ln ed ef dx translated">medium.com</p></div></div><div class="lq l"><div class="lr l ls lt lu lq lv jq lh"/></div></div></a></div><div class="le lf ez fb lg lh"><a rel="noopener follow" target="_blank" href="/mlearning-ai/topic-modelling-with-lda-on-the-tweets-mentioning-elon-musk-687076a2c86b"><div class="li ab dw"><div class="lj ab lk cl cj ll"><h2 class="bd hi fi z dy lm ea eb ln ed ef hg bi translated">在提到埃隆·马斯克的推特上用LDA进行主题建模</h2><div class="lo l"><h3 class="bd b fi z dy lm ea eb ln ed ef dx translated">发现推文中的潜在话题，了解人们在Twitter上谈论埃隆·马斯克</h3></div><div class="lp l"><p class="bd b fp z dy lm ea eb ln ed ef dx translated">medium.com</p></div></div><div class="lq l"><div class="lw l ls lt lu lq lv jq lh"/></div></div></a></div><div class="le lf ez fb lg lh"><a rel="noopener follow" target="_blank" href="/mlearning-ai/mlearning-ai-submission-suggestions-b51e2b130bfb"><div class="li ab dw"><div class="lj ab lk cl cj ll"><h2 class="bd hi fi z dy lm ea eb ln ed ef hg bi translated">Mlearning.ai提交建议</h2><div class="lo l"><h3 class="bd b fi z dy lm ea eb ln ed ef dx translated">如何成为Mlearning.ai上的作家</h3></div><div class="lp l"><p class="bd b fp z dy lm ea eb ln ed ef dx translated">medium.com</p></div></div><div class="lq l"><div class="lx l ls lt lu lq lv jq lh"/></div></div></a></div></div></div>    
</body>
</html>