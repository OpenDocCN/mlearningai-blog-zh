<html>
<head>
<title>Azure ML SDK V2 sample for forecasting a time series</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用于预测时间序列的Azure ML SDK V2示例</h1>
<blockquote>原文：<a href="https://medium.com/mlearning-ai/azure-ml-sdk-v2-sample-for-forecasting-a-time-series-610508b14f5e?source=collection_archive---------2-----------------------#2022-09-10">https://medium.com/mlearning-ai/azure-ml-sdk-v2-sample-for-forecasting-a-time-series-610508b14f5e?source=collection_archive---------2-----------------------#2022-09-10</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><h1 id="ec7f" class="ie if hh bd ig ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb bi translated">Azure ML SDK V2简介</h1><h1 id="70f5" class="ie if hh bd ig ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb bi translated">先决条件</h1><ul class=""><li id="9b34" class="jc jd hh je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt bi translated">Azure帐户</li><li id="58c8" class="jc jd hh je b jf ju jh jv jj jw jl jx jn jy jp jq jr js jt bi translated">Azure机器学习资源</li><li id="29b6" class="jc jd hh je b jf ju jh jv jj jw jl jx jn jy jp jq jr js jt bi translated">默认AML存储</li><li id="cfd3" class="jc jd hh je b jf ju jh jv jj jw jl jx jn jy jp jq jr js jt bi translated">创建培训、测试和验证文件夹</li><li id="583c" class="jc jd hh je b jf ju jh jv jj jw jl jx jn jy jp jq jr js jt bi translated">以上文件夹的ml表配置</li><li id="da5c" class="jc jd hh je b jf ju jh jv jj jw jl jx jn jy jp jq jr js jt bi translated">安装预览功能</li><li id="728b" class="jc jd hh je b jf ju jh jv jj jw jl jx jn jy jp jq jr js jt bi translated">请记住，预览的打印版本只能使用_version。版本</li></ul><pre class="jz ka kb kc fd kd ke kf kg aw kh bi"><span id="dbb5" class="ki if hh ke b fi kj kk l kl km">import azure.ai.ml<br/>print(azure.ai.ml._version.VERSION)</span></pre><h1 id="e3d8" class="ie if hh bd ig ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb bi translated">密码</h1><h1 id="547a" class="ie if hh bd ig ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb bi translated">连接现有工作空间的代码</h1><pre class="jz ka kb kc fd kd ke kf kg aw kh bi"><span id="d10a" class="ki if hh ke b fi kj kk l kl km"># import required libraries<br/>from azure.ai.ml import MLClient<br/>from azure.ai.ml.entities import Workspace<br/>from azure.identity import DefaultAzureCredential</span></pre><ul class=""><li id="8869" class="jc jd hh je b jf kn jh ko jj kp jl kq jn kr jp jq jr js jt bi translated">现在指定工作区名称和订阅id</li></ul><pre class="jz ka kb kc fd kd ke kf kg aw kh bi"><span id="3b45" class="ki if hh ke b fi kj kk l kl km"># Enter details of your AML workspace<br/>subscription_id = "xxxxxxxxxxxxxxxxxxxxxxxxx"<br/>resource_group = "rgname"<br/>workspace = "workspacename"</span></pre><ul class=""><li id="2861" class="jc jd hh je b jf kn jh ko jj kp jl kq jn kr jp jq jr js jt bi translated">现在给工作区打电话</li></ul><pre class="jz ka kb kc fd kd ke kf kg aw kh bi"><span id="3b23" class="ki if hh ke b fi kj kk l kl km"># get a handle to the workspace<br/>ml_client = MLClient(<br/>    DefaultAzureCredential(), subscription_id, resource_group, workspace<br/>)</span></pre><h1 id="b1f9" class="ie if hh bd ig ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb bi translated">现在让我们创建一个训练实验</h1><ul class=""><li id="0c6a" class="jc jd hh je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt bi translated">导入必要的库</li></ul><pre class="jz ka kb kc fd kd ke kf kg aw kh bi"><span id="6c02" class="ki if hh ke b fi kj kk l kl km"># Import required libraries<br/>from azure.ai.ml import MLClient</span></pre><ul class=""><li id="1112" class="jc jd hh je b jf kn jh ko jj kp jl kq jn kr jp jq jr js jt bi translated">获取默认身份验证</li></ul><pre class="jz ka kb kc fd kd ke kf kg aw kh bi"><span id="a187" class="ki if hh ke b fi kj kk l kl km">from azure.identity import DefaultAzureCredential, InteractiveBrowserCredential</span><span id="e8f1" class="ki if hh ke b fi ks kk l kl km">try:<br/>    credential = DefaultAzureCredential()<br/>    # Check if given credential can get token successfully.<br/>    credential.get_token("https://management.azure.com/.default")<br/>except Exception as ex:<br/>    # Fall back to InteractiveBrowserCredential in case DefaultAzureCredential not work<br/>    # This will open a browser page for<br/>    credential = InteractiveBrowserCredential()</span></pre><ul class=""><li id="3d43" class="jc jd hh je b jf kn jh ko jj kp jl kq jn kr jp jq jr js jt bi translated">现在加载工作区</li></ul><pre class="jz ka kb kc fd kd ke kf kg aw kh bi"><span id="061e" class="ki if hh ke b fi kj kk l kl km">try:<br/>    ml_client = MLClient.from_config(credential=credential)<br/>except Exception as ex:<br/>    # NOTE: Update following workspace information if not correctly configure before<br/>    client_config = {<br/>        "subscription_id": "xxxxxxxxxxxxxxxxxxxxxxxxxxx",<br/>        "resource_group": "rgname",<br/>        "workspace_name": "workspacename",<br/>    }</span><span id="c034" class="ki if hh ke b fi ks kk l kl km">    if client_config["subscription_id"].startswith("&lt;"):<br/>        print(<br/>            "please update your &lt;SUBSCRIPTION_ID&gt; &lt;RESOURCE_GROUP&gt; &lt;AML_WORKSPACE_NAME&gt; in notebook cell"<br/>        )<br/>        raise ex<br/>    else:  # write and reload from config file<br/>        import json, os</span><span id="c5c7" class="ki if hh ke b fi ks kk l kl km">        config_path = "../.azureml/config.json"<br/>        os.makedirs(os.path.dirname(config_path), exist_ok=True)<br/>        with open(config_path, "w") as fo:<br/>            fo.write(json.dumps(client_config))<br/>        ml_client = MLClient.from_config(credential=credential, path=config_path)<br/>print(ml_client)</span></pre><ul class=""><li id="0b95" class="jc jd hh je b jf kn jh ko jj kp jl kq jn kr jp jq jr js jt bi translated">现在创建计算目标</li></ul><pre class="jz ka kb kc fd kd ke kf kg aw kh bi"><span id="7c2a" class="ki if hh ke b fi kj kk l kl km">from azure.ai.ml.entities import AmlCompute</span><span id="996b" class="ki if hh ke b fi ks kk l kl km"># specify aml compute name.<br/>cpu_compute_target = "cpu-cluster"</span><span id="068d" class="ki if hh ke b fi ks kk l kl km">try:<br/>    ml_client.compute.get(cpu_compute_target)<br/>except Exception:<br/>    print("Creating a new cpu compute target...")<br/>    compute = AmlCompute(<br/>        name=cpu_compute_target, size="STANDARD_D2_V2", min_instances=0, max_instances=4<br/>    )<br/>    ml_client.compute.begin_create_or_update(compute)</span></pre><ul class=""><li id="d1ca" class="jc jd hh je b jf kn jh ko jj kp jl kq jn kr jp jq jr js jt bi translated">让我们包括其他库</li></ul><pre class="jz ka kb kc fd kd ke kf kg aw kh bi"><span id="f6f0" class="ki if hh ke b fi kj kk l kl km"># import required libraries<br/>from azure.identity import DefaultAzureCredential, InteractiveBrowserCredential</span><span id="111b" class="ki if hh ke b fi ks kk l kl km">from azure.ai.ml import MLClient, Input, command, Output<br/>from azure.ai.ml.dsl import pipeline<br/>from azure.ai.ml.automl import forecasting<br/>from azure.ai.ml.entities._job.automl.tabular.forecasting_settings import ForecastingSettings</span><span id="881e" class="ki if hh ke b fi ks kk l kl km"># add environment variable to enable private preview feature<br/>import os<br/>os.environ["AZURE_ML_CLI_PRIVATE_FEATURES_ENABLED"] = "true"</span><span id="5f80" class="ki if hh ke b fi ks kk l kl km">try:<br/>    credential = DefaultAzureCredential()<br/>    # Check if given credential can get token successfully.<br/>    credential.get_token("https://management.azure.com/.default")<br/>except Exception as ex:<br/>    # Fall back to InteractiveBrowserCredential in case DefaultAzureCredential not work<br/>    credential = InteractiveBrowserCredential()</span></pre><ul class=""><li id="8a51" class="jc jd hh je b jf kn jh ko jj kp jl kq jn kr jp jq jr js jt bi translated">获取集群名称</li></ul><pre class="jz ka kb kc fd kd ke kf kg aw kh bi"><span id="a37f" class="ki if hh ke b fi kj kk l kl km"># Get a handle to workspace<br/>ml_client = MLClient.from_config(credential=credential)</span><span id="bc9c" class="ki if hh ke b fi ks kk l kl km"># Retrieve an already attached Azure Machine Learning Compute.<br/>cluster_name = "cpu-cluster"<br/>print(ml_client.compute.get(cluster_name))</span></pre><ul class=""><li id="711b" class="jc jd hh je b jf kn jh ko jj kp jl kq jn kr jp jq jr js jt bi translated">现在设置管道</li></ul><pre class="jz ka kb kc fd kd ke kf kg aw kh bi"><span id="b9db" class="ki if hh ke b fi kj kk l kl km"># Define pipeline<br/>@pipeline(<br/>    description="AutoML Forecasting Pipeline",<br/>    )<br/>def automl_forecasting(<br/>    forecasting_train_data,<br/>):<br/>    # define forecasting settings<br/>    forecasting_settings = ForecastingSettings(time_column_name="timeStamp", forecast_horizon=12, frequency="H", target_lags=[ 12 ], target_rolling_window_size=4)<br/>    <br/>    # define the automl forecasting task with automl function<br/>    forecasting_node = forecasting(<br/>        training_data=forecasting_train_data,<br/>        target_column_name="demand",<br/>        primary_metric="normalized_root_mean_squared_error",<br/>        n_cross_validations=2,<br/>        forecasting_settings=forecasting_settings,<br/>        # currently need to specify outputs "mlflow_model" explictly to reference it in following nodes <br/>        outputs={"best_model": Output(type="mlflow_model")},<br/>    )<br/>    <br/>    forecasting_node.set_limits(timeout_minutes=180)</span><span id="72f4" class="ki if hh ke b fi ks kk l kl km">    command_func = command(<br/>        inputs=dict(<br/>            automl_output=Input(type="mlflow_model")<br/>        ),<br/>        command="ls ${{inputs.automl_output}}",<br/>        environment="AzureML-sklearn-0.24-ubuntu18.04-py37-cpu:1"<br/>    )<br/>    show_output = command_func(automl_output=forecasting_node.outputs.best_model)<br/></span><span id="3039" class="ki if hh ke b fi ks kk l kl km">data_folder = "./data"<br/>pipeline = automl_forecasting(<br/>    forecasting_train_data=Input(path=f"{data_folder}/training-mltable-folder/", type="mltable"),<br/>)</span><span id="218e" class="ki if hh ke b fi ks kk l kl km"># set pipeline level compute<br/>pipeline.settings.default_compute="cpu-cluster"</span></pre><ul class=""><li id="b6dd" class="jc jd hh je b jf kn jh ko jj kp jl kq jn kr jp jq jr js jt bi translated">现在运行管道</li></ul><pre class="jz ka kb kc fd kd ke kf kg aw kh bi"><span id="83ae" class="ki if hh ke b fi kj kk l kl km"># submit the pipeline job<br/>pipeline_job = ml_client.jobs.create_or_update(<br/>    pipeline, experiment_name="pipeline_samples"<br/>)<br/>pipeline_job</span></pre><figure class="jz ka kb kc fd ku er es paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="er es kt"><img src="../Images/20256c13261b211bfdd19d1827da4c2a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*IKxTIPJNZHWKsPX8.jpg"/></div></div></figure><ul class=""><li id="8767" class="jc jd hh je b jf kn jh ko jj kp jl kq jn kr jp jq jr js jt bi translated">现在获取URL来观察管道作业的执行</li></ul><pre class="jz ka kb kc fd kd ke kf kg aw kh bi"><span id="dfc0" class="ki if hh ke b fi kj kk l kl km"># Wait until the job completes<br/>ml_client.jobs.stream(pipeline_job.name)</span></pre><figure class="jz ka kb kc fd ku er es paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="er es lb"><img src="../Images/e41492a49ae74ab812385b3928321349.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*9fOcxd9IJ_MjPg8Y.jpg"/></div></div></figure><ul class=""><li id="43fd" class="jc jd hh je b jf kn jh ko jj kp jl kq jn kr jp jq jr js jt bi translated">等待它完成</li><li id="72bc" class="jc jd hh je b jf ju jh jv jj jw jl jx jn jy jp jq jr js jt bi translated">监控作业状态</li></ul><figure class="jz ka kb kc fd ku er es paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="er es lc"><img src="../Images/25ed04163e21f8cb9ae43f9dd419878e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*oUYveVHHkXOofCO3.jpg"/></div></div></figure><ul class=""><li id="794b" class="jc jd hh je b jf kn jh ko jj kp jl kq jn kr jp jq jr js jt bi translated">最终管道输出</li></ul><figure class="jz ka kb kc fd ku er es paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="er es ld"><img src="../Images/e89ac2bfc452b63b932df0635f388ba0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*9sCxe3sSO2C5E4Dn.jpg"/></div></div></figure></div><div class="ab cl le lf go lg" role="separator"><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj"/></div><div class="ha hb hc hd he"><h2 id="e412" class="ki if hh bd ig ll lm ln ik lo lp lq io jj lr ls is jl lt lu iw jn lv lw ja lx bi translated"><em class="ly">最初发表于</em><a class="ae lz" href="https://github.com/balakreshnan/Samples2022/blob/main/AzureMLV2/forecastv2.md" rel="noopener ugc nofollow" target="_blank"><em class="ly">【https://github.com】</em></a><em class="ly">。</em></h2><div class="ma mb ez fb mc md"><a rel="noopener follow" target="_blank" href="/mlearning-ai/mlearning-ai-submission-suggestions-b51e2b130bfb"><div class="me ab dw"><div class="mf ab mg cl cj mh"><h2 class="bd hi fi z dy mi ea eb mj ed ef hg bi translated">Mlearning.ai提交建议</h2><div class="mk l"><h3 class="bd b fi z dy mi ea eb mj ed ef dx translated">如何成为Mlearning.ai上的作家</h3></div><div class="ml l"><p class="bd b fp z dy mi ea eb mj ed ef dx translated">medium.com</p></div></div><div class="mm l"><div class="mn l mo mp mq mm mr kz md"/></div></div></a></div></div></div>    
</body>
</html>