<html>
<head>
<title>Pytorch &amp; C++ #4: Using Torchvision Models</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Pytorch &amp; C++ #4:使用Torchvision模型</h1>
<blockquote>原文：<a href="https://medium.com/mlearning-ai/pytorch-c-4-using-torchvision-models-f12bd25f4744?source=collection_archive---------2-----------------------#2022-09-25">https://medium.com/mlearning-ai/pytorch-c-4-using-torchvision-models-f12bd25f4744?source=collection_archive---------2-----------------------#2022-09-25</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><figure class="ev ex if ig ih ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es ie"><img src="../Images/2df193ef8fcb85dc3308b62b246c4add.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*CCzSulsaZvXvQktwYMRTPw.png"/></div></div></figure><h1 id="88eb" class="ip iq hh bd ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm bi translated">介绍</h1><p id="73c4" class="pw-post-body-paragraph jn jo hh jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ha bi translated">在本系列中，我将尝试提供使用Pytorch c++ API的示例/实践/项目。如果你是这个系列的新手，你可以在潜水前查看<a class="ae kl" rel="noopener" href="/@yozkose3/pytorch-c-intro-b50571762162">的第一篇博客</a>。在这个故事中，我们将用Python导出Torchvision模型，并在c++代码中使用它们。模型在Imagenet上接受训练。我们还将使用<a class="ae kl" href="https://github.com/opencv/opencv" rel="noopener ugc nofollow" target="_blank"> OpenCV </a>来读取图像。所有代码都可以在<a class="ae kl" href="https://github.com/EmreOzkose/pytorch_cpp" rel="noopener ugc nofollow" target="_blank">这个Github repo </a>中找到。</p><h1 id="d224" class="ip iq hh bd ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm bi translated">内容</h1><ol class=""><li id="67cb" class="km kn hh jp b jq jr ju jv jy ko kc kp kg kq kk kr ks kt ku bi translated">装置</li><li id="7b75" class="km kn hh jp b jq kv ju kw jy kx kc ky kg kz kk kr ks kt ku bi translated">导出模型</li><li id="e06a" class="km kn hh jp b jq kv ju kw jy kx kc ky kg kz kk kr ks kt ku bi translated">在c++中使用导出的预训练模型</li></ol><h1 id="2d7c" class="ip iq hh bd ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm bi translated">装置</h1><p id="b039" class="pw-post-body-paragraph jn jo hh jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ha bi translated">我们必须安装OpenCV来读取图像。要安装它，请遵循以下说明</p><pre class="la lb lc ld fd le lf lg lh aw li bi"><span id="8b3e" class="lj iq hh lf b fi lk ll l lm ln">git clone <a class="ae kl" href="https://github.com/opencv/opencv.git" rel="noopener ugc nofollow" target="_blank">https://github.com/opencv/opencv.git</a><br/>cd opencv<br/>mkdir build &amp;&amp; cd build<br/>cmake -D GLIBCXX_USE_CXX11_ABI=0 ..<br/>make -j12<br/>sudo make install</span></pre><p id="22a6" class="pw-post-body-paragraph jn jo hh jp b jq lo js jt ju lp jw jx jy lq ka kb kc lr ke kf kg ls ki kj kk ha bi translated">libtorch和opencv之间可能存在不匹配问题。当你在没有<code class="du lt lu lv lf b">-D GLIBCXX_USE_CXX11_ABI=0</code>的情况下安装openCV，你可能会面临以下问题。</p><pre class="la lb lc ld fd le lf lg lh aw li bi"><span id="13fc" class="lj iq hh lf b fi lk ll l lm ln">undefined reference <strong class="lf hi">to</strong> `cv::imread(std::string <strong class="lf hi">const</strong>&amp;, int)<em class="lw">'</em> collect2: <strong class="lf hi">error</strong>: ld returned 1 <strong class="lf hi">exit</strong> status</span></pre><p id="5ac7" class="pw-post-body-paragraph jn jo hh jp b jq lo js jt ju lp jw jx jy lq ka kb kc lr ke kf kg ls ki kj kk ha bi translated">有两种方法可以解决这个问题:</p><ol class=""><li id="91c7" class="km kn hh jp b jq lo ju lp jy lx kc ly kg lz kk kr ks kt ku bi translated">构建openCV时使用<code class="du lt lu lv lf b">-D GLIBCXX_USE_CXX11_ABI=0</code></li><li id="0ec4" class="km kn hh jp b jq kv ju kw jy kx kc ky kg kz kk kr ks kt ku bi translated">使用<a class="ae kl" href="https://pytorch.org/get-started/locally/" rel="noopener ugc nofollow" target="_blank"> cxx11-ABI代替cxx11之前的ABI </a>。</li></ol><h1 id="e946" class="ip iq hh bd ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm bi translated">导出模型</h1><p id="070d" class="pw-post-body-paragraph jn jo hh jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ha bi translated">如果你读了之前的博客，你可能对jit模型很熟悉。我们应该将Pytorch模型转换成Python中自身的jit版本。</p><figure class="la lb lc ld fd ii"><div class="bz dy l di"><div class="ma mb l"/></div></figure><p id="1085" class="pw-post-body-paragraph jn jo hh jp b jq lo js jt ju lp jw jx jy lq ka kb kc lr ke kf kg ls ki kj kk ha bi translated">现在，我们有一个跟踪的jit模型加载到c++代码中。为了简单起见，我选择了Alexnet，但还有许多模型，如Resnet，VGG等…</p><h1 id="e47f" class="ip iq hh bd ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm bi translated">使用导出的预训练模型</h1><p id="35eb" class="pw-post-body-paragraph jn jo hh jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ha bi translated">在深入主要代码之前，我们应该添加下面几行代码来使用openCV。</p><pre class="la lb lc ld fd le lf lg lh aw li bi"><span id="5b3e" class="lj iq hh lf b fi lk ll l lm ln">find_package(OpenCV REQUIRED)<br/>include_directories(${OpenCV_INCLUDE_DIRS})<br/>target_link_libraries(simple-tensor-operations "${OpenCV_LIBS}")</span></pre><p id="dd69" class="pw-post-body-paragraph jn jo hh jp b jq lo js jt ju lp jw jx jy lq ka kb kc lr ke kf kg ls ki kj kk ha bi translated">由于预训练模型是在ImageNet上训练的，所以我们需要知道索引对应的类名。</p><figure class="la lb lc ld fd ii"><div class="bz dy l di"><div class="ma mb l"/></div></figure><p id="0d81" class="pw-post-body-paragraph jn jo hh jp b jq lo js jt ju lp jw jx jy lq ka kb kc lr ke kf kg ls ki kj kk ha bi translated">这样，我们就可以创建一个map对象，从获得的索引中获取相应的类名。现在，我们应该用openCV读取图像。</p><figure class="la lb lc ld fd ii"><div class="bz dy l di"><div class="ma mb l"/></div></figure><p id="551b" class="pw-post-body-paragraph jn jo hh jp b jq lo js jt ju lp jw jx jy lq ka kb kc lr ke kf kg ls ki kj kk ha bi translated">我们应该根据预训练模型的训练来归一化图像。用平均值[0.485，0.456，0.406]和标准差[0.229，0.224，0.225]对预训练的火炬视觉模型进行归一化。在规范化之后，我们应该加载我们的模型并向前运行。</p><figure class="la lb lc ld fd ii"><div class="bz dy l di"><div class="ma mb l"/></div></figure><p id="bd39" class="pw-post-body-paragraph jn jo hh jp b jq lo js jt ju lp jw jx jy lq ka kb kc lr ke kf kg ls ki kj kk ha bi translated">现在我们可以构建和测试。</p><pre class="la lb lc ld fd le lf lg lh aw li bi"><span id="9374" class="lj iq hh lf b fi lk ll l lm ln">cmake -DCMAKE_PREFIX_PATH=/path/to/libtorch .. &amp;&amp; cmake --build . --config Release &amp;&amp; ./detection /path/to/bees/16838648_415acd9e3f.jpg</span></pre><p id="4a96" class="pw-post-body-paragraph jn jo hh jp b jq lo js jt ju lp jw jx jy lq ka kb kc lr ke kf kg ls ki kj kk ha bi translated">这应该给</p><pre class="la lb lc ld fd le lf lg lh aw li bi"><span id="d3f8" class="lj iq hh lf b fi lk ll l lm ln">Prediction: bee</span></pre><h1 id="49a3" class="ip iq hh bd ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm bi translated">结论</h1><p id="8c19" class="pw-post-body-paragraph jn jo hh jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ha bi translated">在这篇博客中，我们用Python导出Alexnet，并用c++来预测图像。我们使用openCV读取图像。所有代码都可以在<a class="ae kl" href="https://github.com/EmreOzkose/pytorch_cpp" rel="noopener ugc nofollow" target="_blank">这个Github Repo </a>中找到。</p><div class="mc md ez fb me mf"><a rel="noopener follow" target="_blank" href="/mlearning-ai/mlearning-ai-submission-suggestions-b51e2b130bfb"><div class="mg ab dw"><div class="mh ab mi cl cj mj"><h2 class="bd hi fi z dy mk ea eb ml ed ef hg bi translated">Mlearning.ai提交建议</h2><div class="mm l"><h3 class="bd b fi z dy mk ea eb ml ed ef dx translated">如何成为Mlearning.ai上的作家</h3></div><div class="mn l"><p class="bd b fp z dy mk ea eb ml ed ef dx translated">medium.com</p></div></div><div class="mo l"><div class="mp l mq mr ms mo mt in mf"/></div></div></a></div></div></div>    
</body>
</html>