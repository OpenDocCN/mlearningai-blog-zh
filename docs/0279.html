<html>
<head>
<title>Calling APIs with Authentication Token</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用身份验证令牌调用API</h1>
<blockquote>原文：<a href="https://medium.com/mlearning-ai/calling-apis-with-authentication-token-5e4412bd75b5?source=collection_archive---------1-----------------------#2021-03-15">https://medium.com/mlearning-ai/calling-apis-with-authentication-token-5e4412bd75b5?source=collection_archive---------1-----------------------#2021-03-15</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><figure class="ev ex if ig ih ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es ie"><img src="../Images/e000daaa36e64ccb1e557e011fdc2cd8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*uutTL-yWQaD7Liojv03RPg.png"/></div></div></figure><p id="0fbe" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">我不得不写一个python脚本来调用一系列基于业务逻辑的API。问题是这些API需要一个认证令牌来执行。在缺少令牌的情况下，我得到了<code class="du jn jo jp jq b">403 Forbidden</code>错误，因为API无法识别调用(来自程序)是否来自真正的来源。</p><p id="3dd0" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">我谷歌了如何从python代码调用API，但我看到的每篇文章都假设API是开放的、公共的，不需要通过令牌进行任何授权。这篇文章是我的研究和各种不成功的代码执行的结果，最终找到了用认证令牌从python代码调用API的方法。</p><h1 id="f042" class="jr js hh bd jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko bi translated">你需要什么？</h1><p id="669a" class="pw-post-body-paragraph ip iq hh ir b is kp iu iv iw kq iy iz ja kr jc jd je ks jg jh ji kt jk jl jm ha bi translated">你应该知道生成令牌的API的细节。这通常是第一个API，所有后续API都使用第一个API生成的相同令牌进行身份验证。让我们将第一个API称为<strong class="ir hi">登录API </strong>，它需要一个用户id和密码作为输入。首先应该知道正确的用户id和密码。我们把第二个叫做<strong class="ir hi">报表API </strong>。您还应该知道登录API头中的哪个键值对包含web令牌，以及web令牌应该传递到的报告API头中的正确键值对。</p><h1 id="3f51" class="jr js hh bd jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko bi translated">先决条件</h1><p id="d903" class="pw-post-body-paragraph ip iq hh ir b is kp iu iv iw kq iy iz ja kr jc jd je ks jg jh ji kt jk jl jm ha bi translated">登录API URL、报告API URL、用户id和密码的详细信息已经存储在特定文件夹的配置文件中。我们知道web令牌是登录API的响应头中的当前键<code class="du jn jo jp jq b">at</code>。</p><h1 id="8f1d" class="jr js hh bd jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko bi translated">假定</h1><p id="e947" class="pw-post-body-paragraph ip iq hh ir b is kp iu iv iw kq iy iz ja kr jc jd je ks jg jh ji kt jk jl jm ha bi translated">由于用户id和密码的敏感性，我没有将它们放在代码中，而是放在一个单独的配置文件中，该文件可以读取url、用户id和密码等细节。我在下面写的代码假设你已经使用过python中的<code class="du jn jo jp jq b">configparser</code>和<code class="du jn jo jp jq b">logging</code>包。请阅读我的另一篇文章<a class="ae ku" href="https://divijsharma.medium.com/config-files-and-logging-a7b4cc377fd5" rel="noopener">配置文件和日志</a>了解更多细节。<code class="du jn jo jp jq b">read_config</code>和<code class="du jn jo jp jq b">set_logging_basics</code>功能在<a class="ae ku" href="https://divijsharma.medium.com/config-files-and-logging-a7b4cc377fd5" rel="noopener">那篇文章</a>中有描述。</p><p id="7b0f" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">所以让我们开始吧！</p><p id="25d3" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">配置文件看起来像这样</p><figure class="kv kw kx ky fd ii"><div class="bz dy l di"><div class="kz la l"/></div><figcaption class="lb lc et er es ld le bd b be z dx">main_config.ini</figcaption></figure><p id="7fdc" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">首先，让我们为配置文件中的节和键名定义一些静态变量。</p><figure class="kv kw kx ky fd ii"><div class="bz dy l di"><div class="kz la l"/></div><figcaption class="lb lc et er es ld le bd b be z dx">Static variables in the code</figcaption></figure><p id="fd4e" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">接下来，我们将定义2个小函数来从字典中读取URL和登录详细信息，并返回相关的详细信息。</p><figure class="kv kw kx ky fd ii"><div class="bz dy l di"><div class="kz la l"/></div><figcaption class="lb lc et er es ld le bd b be z dx">Function to get the API URL details</figcaption></figure><figure class="kv kw kx ky fd ii"><div class="bz dy l di"><div class="kz la l"/></div><figcaption class="lb lc et er es ld le bd b be z dx">Function to get the login details</figcaption></figure><p id="9e2c" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">在定义了函数和静态变量之后，是时候获取日志详细信息了。</p><figure class="kv kw kx ky fd ii"><div class="bz dy l di"><div class="kz la l"/></div><figcaption class="lb lc et er es ld le bd b be z dx">Details of file where logs will be written</figcaption></figure><p id="707a" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">获取登录详细信息，并创建用户名和密码的键值对。键名应该与API中的编码完全相同。</p><figure class="kv kw kx ky fd ii"><div class="bz dy l di"><div class="kz la l"/></div><figcaption class="lb lc et er es ld le bd b be z dx">User ID and password details</figcaption></figure><p id="329d" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">设置完成后，就该调用登录API并获取身份验证令牌了。身份验证令牌是登录API响应的一部分。它出现在关键字<code class="du jn jo jp jq b">at</code>的标题中。令牌必须在有效载荷报头的同一个<code class="du jn jo jp jq b">at</code>密钥中传递给后续的报告API。</p><figure class="kv kw kx ky fd ii"><div class="bz dy l di"><div class="kz la l"/></div><figcaption class="lb lc et er es ld le bd b be z dx">Get Authentication Token</figcaption></figure><p id="3956" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">到目前为止，我们已经为带有身份验证令牌的报告API请求创建了头部。现在调用报告API。</p><figure class="kv kw kx ky fd ii"><div class="bz dy l di"><div class="kz la l"/></div><figcaption class="lb lc et er es ld le bd b be z dx">Report API</figcaption></figure><p id="213c" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">现在我们知道了如何从一个API读取认证令牌，并将其传递给另一个API。如果出现错误，我就终止程序——相关的业务逻辑可以放在<code class="du jn jo jp jq b">if resp_login.status_code != 200</code>中处理优雅的退出。</p></div></div>    
</body>
</html>