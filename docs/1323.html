<html>
<head>
<title>COVID-19 Infection and Lung Segmentation using CT Scans</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">新冠肺炎感染和使用CT扫描的肺分割</h1>
<blockquote>原文：<a href="https://medium.com/mlearning-ai/covid-19-infection-and-lung-segmentation-using-ct-scans-a5ab5b379272?source=collection_archive---------2-----------------------#2021-11-22">https://medium.com/mlearning-ai/covid-19-infection-and-lung-segmentation-using-ct-scans-a5ab5b379272?source=collection_archive---------2-----------------------#2021-11-22</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><p id="5afb" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">最近，我在为期末计算机科学项目作业寻找项目想法时，偶然发现了一个有趣的数据集。它有20个详细的、全分辨率的被诊断患有SARS-COV-2的患者的肺部扫描，以及医学专家对肺部和感染的分割。</p><figure class="jd je jf jg fd jh er es paragraph-image"><div class="er es jc"><img src="../Images/d83b4bd74452a3eefee29a43f4066c42.png" data-original-src="https://miro.medium.com/v2/resize:fit:1204/format:webp/1*RUfN6QHSbT3pkyXSgwAHZw.png"/></div><figcaption class="jk jl et er es jm jn bd b be z dx">2-dimensional render of a CT scan showing the segmentation of healthy and infected pulmonary tissue</figcaption></figure><p id="d019" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">阅读人们利用数据集制作的python脚本和笔记本让我思考，在成功完成我的学术要求的同时，我可以利用这些数据在现实生活中应用什么？最后，在与我的队友进行了多次不和谐的会议讨论后，我们得出了一个结论，即我们将尝试创建一个应用程序，在赶往医院要求世界各地已经超负荷工作的医务人员进行侵入性手术之前，告诉你在正在进行的疫情中感染冠状病毒的可能性。</p><p id="e8e3" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在我们开始研究用户如何与我们的应用程序交互之前，我们必须在我找到的数据集上选择和训练深度学习模型，然后测试和验证建立在新扫描上的模型，以便我们的程序可以预测、分类和分割扫描中看到的肺部感染部位。</p><p id="7134" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">经过一些研究，我们发现，与通用的CNN模型或直接处理数字数据的机器学习模型(如线性支持向量机和逻辑回归模型)相比，专门设计用于处理医学扫描图像的模型(如<a class="ae jo" href="https://arxiv.org/abs/1505.04597" rel="noopener ugc nofollow" target="_blank">、UNET </a>和新的改进的UNET++能够产生更高的平均精度。因此，我们对任务进行了分工，最终我负责CT扫描，而我团队中的其他人则负责X射线和最终应用的前端功能。</p><p id="1e43" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在这篇文章中，我将尝试解释为这类项目准备原始数据的基本方法和步骤，以及如何使用Python和流行的深度学习技术解决图像分割问题(我们的第一个任务)。此外，我尽可能地包含了代码片段和输出，以帮助理解所遵循的过程。</p></div><div class="ab cl jp jq go jr" role="separator"><span class="js bw bk jt ju jv"/><span class="js bw bk jt ju jv"/><span class="js bw bk jt ju"/></div><div class="ha hb hc hd he"><p id="05d9" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我们首先导入所需的库，并将整个数据集下载到我们选择的环境中。(我使用谷歌的<a class="ae jo" href="https://colab.research.google.com/" rel="noopener ugc nofollow" target="_blank"> Colab </a>平台，以获得额外的ram和GPU优势)</p><figure class="jd je jf jg fd jh er es paragraph-image"><div class="er es jc"><img src="../Images/0eeff2c6fd47fd94650d69602c4f1fdc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1204/format:webp/1*AokBH55X4aCDyLQ6zrM_7w.png"/></div><figcaption class="jk jl et er es jm jn bd b be z dx">Downloading the dataset as a .zip</figcaption></figure><figure class="jd je jf jg fd jh er es paragraph-image"><div class="er es jc"><img src="../Images/ff2c99ef1394ac05bcc155f32bacc064.png" data-original-src="https://miro.medium.com/v2/resize:fit:1204/format:webp/1*qCiqJ8JvnmakJzk5_21r1A.png"/></div><figcaption class="jk jl et er es jm jn bd b be z dx">Extracting and accessing the metadata file</figcaption></figure><p id="ec3d" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我们的数据集的元数据有4个主要类别的图像，分别标记为原始扫描、肺部屏蔽、感染屏蔽和数据集中所有图像的组合屏蔽。运行我们得到的shape命令，</p><figure class="jd je jf jg fd jh er es paragraph-image"><div class="er es jw"><img src="../Images/fb6adbce250e43a505dafcb755b24c60.png" data-original-src="https://miro.medium.com/v2/resize:fit:734/format:webp/1*zT_pYZLIH3DqJxPMlGW4_g.png"/></div></figure><p id="4aaf" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">20张完整的图像，在4个标签下都有相应的副本，突出显示原始扫描的不同方面。</p><p id="4df7" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在浏览数据后，我们在每个ML/DL问题中需要的第一个主要步骤是分析和充分的预处理，这将有助于我们减少常见问题，如偏差、代码复杂性、训练时间等。我在预处理阶段遵循的主要步骤是:</p><p id="2771" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi"> 1。移除不完整和有缺陷的图像</strong></p><p id="0e84" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">当使用来自多个来源的大量未经验证的数据时，这是一个重要步骤，因为您下载使用的许多图像最终可能会被裁剪、分辨率较低且颜色不均匀，这可能会导致模型训练过程中出现问题。我们可以进行插值来解释丢失的数字数据，但通常有缺陷的图像数据会被截断，以避免后续步骤中出现问题。</p><p id="dca8" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi"> 2。用于空掩模预测的单独模型</strong></p><p id="2ef9" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">为了确保我们的模型不会过度补偿不包含任何感染部分的切片，我们将创建一个独立的模型来计算输入CT中的空遮罩，并且仅在渲染中具有可见感染的切片上训练我们的第一个模型。在计算出497个切片是完整的黑色遮罩时，我们将从预处理中排除这些，因为我们不想用这些来打扰分割模型。</p><figure class="jd je jf jg fd jh er es paragraph-image"><div role="button" tabindex="0" class="jx jy di jz bf ka"><div class="er es jc"><img src="../Images/7848072483b7dfd26d04e189f5935dbd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1204/format:webp/1*U1G4TjAmNSMwMkcB9rsbbQ.png"/></div></div></figure><p id="64f3" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi"> 3。使用增强算法提高整体性能</strong></p><p id="1283" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在单次扫描中使用流行的图像增强技术，我们可以通过帮助模型更容易地区分健康组织和感染组织来大幅提高模型的性能。在这种方法中，我使用了对比度受限的自适应直方图均衡化(CLAHE)来增强肺部细胞之间交织的感染细胞片段之间的差异。</p><figure class="jd je jf jg fd jh er es paragraph-image"><div class="er es kb"><img src="../Images/91e0dd1294f991e19e82202f388721ac.png" data-original-src="https://miro.medium.com/v2/resize:fit:1132/format:webp/1*iJuVCieufTZo_colHZ0Z3w.png"/></div><figcaption class="jk jl et er es jm jn bd b be z dx">CLAHE function</figcaption></figure><p id="c8a4" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">控件使用自定义读取函数。nii格式的扫描(read_nii)并绘制原始和增强扫描以及它们各自的直方图，我们可以很容易地看到单个函数在分离我们的模型所需的图像部分上的效果。</p><figure class="jd je jf jg fd jh er es paragraph-image"><div class="er es jc"><img src="../Images/d1f2096bd26f68babe86b324ff6f6b9c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1204/format:webp/1*k949zQ58_Qu66Z8QON_CYw.png"/></div></figure><p id="5d15" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi"> 4。使用Otsu二值化和其他方法裁剪感兴趣区域(ROI)</strong></p><p id="969b" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">图像中有很多黑色空间，不包含任何感染部分和我们不感兴趣的部分，如肺部下方的隔膜。这些将占用宝贵的RAM空间和不必要的计算能力。一个可能的解决方案是根据问题陈述和用例裁剪切片，使其仅包含ROI。在裁剪之后，我们使用Otsu的阈值方法来避免必须选择由算法动态分配的离散值，以返回感染和/或肺部遮罩。</p><figure class="jd je jf jg fd jh er es paragraph-image"><div class="er es jc"><img src="../Images/3e717cae404b27227035cb8e69555d4f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1204/format:webp/1*wpMCdBVea1Bjb-jysiNYPA.png"/></div></figure><p id="72f4" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi"> 5。数据扩充</strong></p><p id="1310" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">神经网络的好坏取决于你提供给它的数据的质量和数量。特别是在图像分割和分类问题中，如果不同标签下的图像数量的比率是倾斜的，或者不同训练标签下的图像过于相似，则可能导致偏差误差，这将导致非常不正确的分类。数据扩充方法旨在通过使用现有数据创建与其来源略有不同的新迭代来消除这一问题，以使您的模型对新变量敏感，这反过来有助于提高模型从未遇到过的新数据的性能。这也有助于增加训练示例的数量，因为模型将每个新的迭代视为不同的示例。为了在我们的数据集中实现有效的扩充，我们将定义一个管道，该管道接收我们已经存在的图像，并在我们的用户定义的变换已经应用于它之后返回一系列扫描切片。</p><figure class="jd je jf jg fd jh er es paragraph-image"><div class="er es jc"><img src="../Images/76589c291df4dfba6091aba05a9dd63a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1204/format:webp/1*7nFwujJ-HfPIHF0zHLrFkQ.png"/></div><figcaption class="jk jl et er es jm jn bd b be z dx">The Augmentation Pipeline</figcaption></figure><p id="72a7" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">执行后，我们可以绘制一些随机切片，以查看在通过管道传递原始数据集后创建的新图像集的一部分。</p><figure class="jd je jf jg fd jh er es paragraph-image"><div class="er es jc"><img src="../Images/821b19df916c8d03a616e0dd52fb31e8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1204/format:webp/1*BIpi7G4i-HqFHinbso3YMw.png"/></div><figcaption class="jk jl et er es jm jn bd b be z dx">Newly Generated Slices</figcaption></figure><p id="7328" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我们的预处理阶段现在已经完成，现在我们将把我们的感染遮罩覆盖在它们相应的CT扫描上，然后在扩充的数据集上创建和运行我们的模型。</p><figure class="jd je jf jg fd jh er es paragraph-image"><div class="er es jc"><img src="../Images/838f07102c50516aec99296b4a52ecbd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1204/format:webp/1*CJeLiAqJJSHr_VCsO8pAMQ.png"/></div><figcaption class="jk jl et er es jm jn bd b be z dx">Overlay Function</figcaption></figure><figure class="jd je jf jg fd jh er es paragraph-image"><div class="er es jc"><img src="../Images/7220a4534e7462e9c8dc3796a445c734.png" data-original-src="https://miro.medium.com/v2/resize:fit:1204/format:webp/1*DbW3CyYoAAGr-FzfLzhcFQ.png"/></div><figcaption class="jk jl et er es jm jn bd b be z dx">Scans with infection masks added on top</figcaption></figure><p id="6488" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">现在，我们分离测试和训练数据，并定义用于我们模型的损失函数和度量。</p><figure class="jd je jf jg fd jh er es paragraph-image"><div class="er es jc"><img src="../Images/5746850b290d6d1b2c8c76532a78d22d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1204/format:webp/1*-U8n-dWO6S42lINh0nE4XQ.png"/></div></figure><figure class="jd je jf jg fd jh er es paragraph-image"><div class="er es kc"><img src="../Images/2355638c0f93b0dde3d7a8b417d2efb8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1066/format:webp/1*eHYg-odFOirFDj-IyQ8Egg.png"/></div></figure><p id="37bc" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我们现在必须做的就是定义、编译和拟合我们的数据模型，然后使用我们选择的指标来评估我们模型的性能。调整我们的模型超参数在这里是必不可少的，因为这可能意味着一个高度准确和高效的程序与一个不准确、较慢的模型之间的差异。最佳学习率将取决于损失景观的拓扑结构，而这又取决于模型架构和数据集。虽然使用默认学习速率(由深度学习库设置的默认值)可能会提供不错的结果，但您通常可以通过搜索最佳学习速率来提高性能或加快训练。使用指数衰减学习率和余弦退火调度器是产生良好结果的流行方法。</p><figure class="jd je jf jg fd jh er es paragraph-image"><div class="er es jc"><img src="../Images/19ed2e1c9a9e575a19d4a733c7e2f6a7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1204/format:webp/1*FQJoY4UAAG5yZ-gMcZeaOA.png"/></div><figcaption class="jk jl et er es jm jn bd b be z dx">Setting optimal learning rates</figcaption></figure><figure class="jd je jf jg fd jh er es paragraph-image"><div class="er es jc"><img src="../Images/9448aa5729416658e8f1ef246c777135.png" data-original-src="https://miro.medium.com/v2/resize:fit:1204/format:webp/1*Qn2zVrxYyF4E4D4rF5itrA.png"/></div><figcaption class="jk jl et er es jm jn bd b be z dx">Running UNet on our data</figcaption></figure><p id="0a63" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">拟合后，我们现在可以在测试数据扫描上查看我们模型的预测感染掩码。</p><figure class="jd je jf jg fd jh er es paragraph-image"><div class="er es jc"><img src="../Images/db3a3c752790d7b6fe7617f3bae25ec0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1204/format:webp/1*uknxXexgoEzUSfKYkb3Opw.png"/></div></figure><p id="7fdb" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">通过使用我们之前定义的指标分析DICE和IOU分数，可以在后处理中获得更多信息。</p><figure class="jd je jf jg fd jh er es paragraph-image"><div class="er es jc"><img src="../Images/4b42dd1c0636c7d005528863aef23c29.png" data-original-src="https://miro.medium.com/v2/resize:fit:1204/format:webp/1*r4AQkrmEVWUAmd7Pz3eYVQ.png"/></div></figure><figure class="jd je jf jg fd jh er es paragraph-image"><div class="er es jc"><img src="../Images/dc2617cb971f14320848db1f07e73745.png" data-original-src="https://miro.medium.com/v2/resize:fit:1204/format:webp/1*9NrBtbT6F4OSimuAue8I6w.png"/></div></figure><p id="366c" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">使用其他度量，如精确度和召回率，也可以用来测试模型的性能。</p><figure class="jd je jf jg fd jh er es paragraph-image"><div class="er es jc"><img src="../Images/6bfd22a4bc4e3cb59d2bc5c36719bdc1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1204/format:webp/1*5APaCTbIox7zCAjKfAHWzQ.png"/></div></figure><figure class="jd je jf jg fd jh er es paragraph-image"><div class="er es kd"><img src="../Images/4aadfa2a001d65f4f8be3127b4a9db53.png" data-original-src="https://miro.medium.com/v2/resize:fit:1130/format:webp/1*O3XI-hPsCALUEyfsasuGZw.png"/></div></figure></div><div class="ab cl jp jq go jr" role="separator"><span class="js bw bk jt ju jv"/><span class="js bw bk jt ju jv"/><span class="js bw bk jt ju"/></div><div class="ha hb hc hd he"><p id="9a27" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">正如您所看到的，我们的模型在相对较少的扫描次数上表现得令人惊讶地好，这是因为我们在预处理和扩充现有数据的过程中关注扫描的质量，以允许模型针对来自较小数据集的更多种类的图像进行训练。通过使用更新的图像增强技术和通过增加为每个切片创建的副本的数量和/或向增强管道添加更多的变换函数来创建更大的增强图像数据集，可以对这种CT分割方法进行进一步的改进。此外，需要创建一个用于CT扫描分类的UNet++模型，使用我们在此定义的代码预测的感染掩码显示患者是否患有新冠肺炎或其他肺部缺陷(整个项目的任务2和3)。最后，一切都必须链接到Python web框架，如<a class="ae jo" href="https://www.streamlit.io/" rel="noopener ugc nofollow" target="_blank"> Streamlit </a>或<a class="ae jo" href="https://palletsprojects.com/p/flask/" rel="noopener ugc nofollow" target="_blank"> Flask </a>，以创建一个每个人都可以作为实用程序轻松使用的用户界面。你也可以尝试使用多个模型的迁移学习方法来完成这个问题的分类任务，这将允许你通过转发上一代所犯的错误来改进每个后续模型。</p><p id="e864" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">自北半球冬季开始以来，随着第三波病例开始在世界各地出现，开源社区为我们的社会和医疗行业提供额外支持的研究和产品正在慢慢成为维持全球生活质量的关键。</p><p id="6eb6" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">本文中使用的数据集可以在以下位置找到:</p><div class="ke kf ez fb kg kh"><a href="https://www.kaggle.com/andrewmvd/covid19-ct-scans" rel="noopener  ugc nofollow" target="_blank"><div class="ki ab dw"><div class="kj ab kk cl cj kl"><h2 class="bd hi fi z dy km ea eb kn ed ef hg bi translated">新冠肺炎CT扫描</h2><div class="ko l"><h3 class="bd b fi z dy km ea eb kn ed ef dx translated">新冠肺炎患者的20次CT扫描和专家分段</h3></div><div class="kp l"><p class="bd b fp z dy km ea eb kn ed ef dx translated">www.kaggle.com</p></div></div><div class="kq l"><div class="kr l ks kt ku kq kv ji kh"/></div></div></a></div><div class="ke kf ez fb kg kh"><a rel="noopener follow" target="_blank" href="/mlearning-ai/mlearning-ai-submission-suggestions-b51e2b130bfb"><div class="ki ab dw"><div class="kj ab kk cl cj kl"><h2 class="bd hi fi z dy km ea eb kn ed ef hg bi translated">Mlearning.ai提交建议</h2><div class="ko l"><h3 class="bd b fi z dy km ea eb kn ed ef dx translated">如何成为Mlearning.ai上的作家</h3></div><div class="kp l"><p class="bd b fp z dy km ea eb kn ed ef dx translated">medium.com</p></div></div><div class="kq l"><div class="kw l ks kt ku kq kv ji kh"/></div></div></a></div></div></div>    
</body>
</html>