<html>
<head>
<title>ElegantRL Demo: Stock Trading Using DDPG (Part II)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">ElegantRL演示:使用DDPG进行股票交易(第二部分)</h1>
<blockquote>原文：<a href="https://medium.com/mlearning-ai/elegantrl-demo-stock-trading-using-ddpg-part-ii-d3d97e01999f?source=collection_archive---------0-----------------------#2021-04-19">https://medium.com/mlearning-ai/elegantrl-demo-stock-trading-using-ddpg-part-ii-d3d97e01999f?source=collection_archive---------0-----------------------#2021-04-19</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><p id="d43b" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">深度确定性策略梯度算法教程(DDPG)</p><p id="a7da" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">本文由Steven Li、<a class="ae jc" href="https://twitter.com/XiaoYangLiu10" rel="noopener ugc nofollow" target="_blank">、</a>和Zeng在<a class="ae jc" href="https://towardsdatascience.com/elegantrl-a-lightweight-and-stable-deep-reinforcement-learning-library-95cef5f3460b" rel="noopener" target="_blank"> ElegantRL </a>中描述了一个使用深度确定性策略梯度(DDPG)的股票交易应用。有两个主要部分，股票交易环境和训练回溯测试过程。在股票交易环境中，我们解释了健身房风格的股票交易环境及其易于定制的特性。在训练-回测过程中，我们描述了ElegantRL中交易代理的训练过程及其技巧，以及评估其性能的回测过程。</p><p id="105f" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">请查看<a class="ae jc" href="https://towardsdatascience.com/elegantrl-a-lightweight-and-stable-deep-reinforcement-learning-library-95cef5f3460b" rel="noopener" target="_blank">介绍文章</a>以了解ElegantRL库的概述，以及<a class="ae jc" rel="noopener" href="/mlearning-ai/elegantrl-demo-stock-trading-using-ddpg-part-i-e77d7dc9d208"> ElegantRL演示:使用股票交易应用程序和DDPG算法的DDPG(第一部分)</a>进行股票交易。</p></div><div class="ab cl jd je go jf" role="separator"><span class="jg bw bk jh ji jj"/><span class="jg bw bk jh ji jj"/><span class="jg bw bk jh ji"/></div><div class="ha hb hc hd he"><h1 id="cf26" class="jk jl hh bd jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh bi translated"><strong class="ak">股票交易环境</strong></h1><p id="ecc3" class="pw-post-body-paragraph ie if hh ig b ih ki ij ik il kj in io ip kk ir is it kl iv iw ix km iz ja jb ha bi translated">该环境是按照OpenAI gym风格设计的，被认为是强化学习环境的标准实现。环境分为三个部分，每个部分是一个功能:</p><ul class=""><li id="ac9b" class="kn ko hh ig b ih ii il im ip kp it kq ix kr jb ks kt ku kv bi translated"><strong class="ig hi">初始化</strong>:预处理来自雅虎财经的股票数据，初始化与股票交易任务相关的变量。初始化函数创建一个新的环境，并在训练期间与代理交互。</li></ul><pre class="kw kx ky kz fd la lb lc ld aw le bi"><span id="e224" class="lf jl hh lb b fi lg lh l li lj"><strong class="lb hi">def __init__(...):<br/>    # Download and Preprocess data</strong><br/>    train_df, eval_df = self.load_stock_trading_data(start_date,   <br/>                        start_eval_date, env_eval_date)        <br/>      <br/>    self.price_ary, self.tech_ary = self.convert_df_to_ary(df, <br/>                                    tech_indicator_list)</span><span id="f457" class="lf jl hh lb b fi lk lh l li lj"><strong class="lb hi">    # Initialize parameters</strong><br/>    stock_dim = self.price_ary.shape[1]         <br/>    self.gamma = gamma        <br/>    self.max_stock = max_stock        <br/>    ...        <br/>    self.initial_stocks = np.zeros(stock_dim, dtype=np.float32) if <br/>                          initial_stocks is None else initial_stocks<br/>         <br/>    <strong class="lb hi"># reset()        </strong><br/>    self.day = None         <br/>    self.stocks = None        <br/>    ...<br/>    self.total_asset = None   <br/>      <br/>    <strong class="lb hi"># environment information  </strong>      <br/>    self.env_name = 'StockTradingEnv-v1'        <br/>    self.state_dim = 1 + 2 * stock_dim + self.tech_ary.shape[1]          <br/>    self.action_dim = stock_dim        <br/>    ...        <br/>    self.target_return = 3.5  # 4.3        </span></pre><ul class=""><li id="434a" class="kn ko hh ig b ih ii il im ip kp it kq ix kr jb ks kt ku kv bi translated"><strong class="ig hi">复位</strong>:环境的状态和变量被复位到初始设置。一旦模拟情节停止并且需要重新开始，就调用该函数。</li></ul><pre class="kw kx ky kz fd la lb lc ld aw le bi"><span id="5446" class="lf jl hh lb b fi lg lh l li lj"><strong class="lb hi">def reset():</strong><br/>    self.day = 0        <br/>    price = self.price_ary[self.day]         <br/>    self.stocks = self.initial_stocks + rd.randint(0, 64,    <br/>                  size=self.initial_stocks.shape)        <br/>    self.amount = self.initial_amount * rd.uniform(0.95, 1.05) -   <br/>                  (self.stocks * price).sum()         <br/>    self.total_asset = self.amount + (self.stocks * price).sum()          <br/>    self.initial_total_asset = self.total_asset        <br/>    self.gamma_reward = 0.0         <br/>    state = np.hstack((self.amount * 2 ** -13,<br/>                       price,                           <br/>                       self.stocks,                            <br/>                       self.tech_ary[self.day],))<br/>            .astype(np.float32) * 2 ** -5        <br/>    return state</span></pre><ul class=""><li id="fd07" class="kn ko hh ig b ih ii il im ip kp it kq ix kr jb ks kt ku kv bi translated"><strong class="ig hi">步骤</strong>:状态从代理处采取一个动作，然后返回三件事的列表——下一个状态、奖励、当前剧集是否完成的指示。环境根据前一篇博客中的状态-动作转换计算下一个状态和奖励。代理调用step函数来收集转换。</li></ul><pre class="kw kx ky kz fd la lb lc ld aw le bi"><span id="c387" class="lf jl hh lb b fi lg lh l li lj"><strong class="lb hi">def step():<br/>    # Get actions and price of the day</strong><br/>    actions = (actions * self.max_stock).astype(int)<br/>    self.day += 1<br/>    price = self.price_ary[self.day]</span><span id="2487" class="lf jl hh lb b fi lk lh l li lj"><strong class="lb hi">    # Execute the action: sell first then buy</strong><br/>   <strong class="lb hi"> # Sell</strong><br/>    for index in np.where(actions &lt; 0)[0]:<br/>        if price[index] &gt; 0:  # Sell only if current asset is &gt; 0<br/>            sell_num_shares = min(self.stocks[index], -<br/>                              actions[index])<br/>            self.stocks[index] -= sell_num_shares<br/>            self.amount += price[index] * sell_num_shares * (1 - <br/>                           self.sell_cost_pct)</span><span id="a57e" class="lf jl hh lb b fi lk lh l li lj">   <strong class="lb hi"> # Buy</strong><br/>    for index in np.where(actions &gt; 0)[0]:  <br/>        ...</span><span id="0f93" class="lf jl hh lb b fi lk lh l li lj">    state = np.hstack((self.amount * 2 ** -13,<br/>                       price,<br/>                       self.stocks,<br/>                       self.tech_ary[self.day],))<br/>                       .astype(np.float32) * 2 ** -5</span><span id="1c08" class="lf jl hh lb b fi lk lh l li lj"> <strong class="lb hi">   # Calculate reward</strong><br/>    total_asset = self.amount + (self.stocks * price).sum()<br/>    reward = (total_asset - self.total_asset) * 2 ** -14  # reward scaling<br/>    self.total_asset = total_asset<br/>    self.gamma_reward = self.gamma_reward * self.gamma + reward</span><span id="f0b7" class="lf jl hh lb b fi lk lh l li lj"><strong class="lb hi">    # Check if the episode is done</strong><br/>    done = self.day == self.max_step<br/>    if done:<br/>        reward = self.gamma_reward<br/>        self.episode_return = total_asset / self.initial_total_asset<br/>    return state, reward, done, dict()</span></pre><p id="88c6" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi">易于定制的环境特性</strong></p><p id="7f4d" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">ElegantRL中股票交易环境最重要的特性之一是其易于定制的特性。通过将参数传递到环境中，用户能够根据特定需求定义自己的股票交易环境。一般来说，用户可以定制以下功能:</p><ul class=""><li id="3040" class="kn ko hh ig b ih ii il im ip kp it kq ix kr jb ks kt ku kv bi translated"><strong class="ig hi"> initial_capital </strong>:用户想要投入的初始资金。</li></ul><pre class="kw kx ky kz fd la lb lc ld aw le bi"><span id="3515" class="lf jl hh lb b fi lg lh l li lj"><strong class="lb hi"># The unit is in dollar</strong><br/>initial_capital = 1e6</span></pre><ul class=""><li id="807b" class="kn ko hh ig b ih ii il im ip kp it kq ix kr jb ks kt ku kv bi translated"><strong class="ig hi"> tickers </strong>:用户想要交易的股票。</li></ul><pre class="kw kx ky kz fd la lb lc ld aw le bi"><span id="667d" class="lf jl hh lb b fi lg lh l li lj"><strong class="lb hi"># finrl.config.NAS_74_TICKER</strong><br/>tickers = ['AAPL', 'ADBE', 'ADI', 'ADP', 'ADSK', 'ALGN', 'ALXN', 'AMAT', 'AMD', 'AMGN', 'AMZN', 'ASML', 'ATVI', 'BIIB', 'BKNG',</span><span id="8200" class="lf jl hh lb b fi lk lh l li lj">...,</span><span id="da76" class="lf jl hh lb b fi lk lh l li lj">'SNPS', 'SWKS', 'TTWO', 'TXN', 'VRSN', 'VRTX', 'WBA', 'WDC', 'WLTW', 'XEL', 'XLNX'] </span></pre><ul class=""><li id="fe02" class="kn ko hh ig b ih ii il im ip kp it kq ix kr jb ks kt ku kv bi translated"><strong class="ig hi"> initial_stocks </strong>:每只股票的初始股数，默认值为零。</li></ul><pre class="kw kx ky kz fd la lb lc ld aw le bi"><span id="cacb" class="lf jl hh lb b fi lg lh l li lj">initial_stocks = np.zeros(len(tickers), dtype=np.float32)</span></pre><ul class=""><li id="1c09" class="kn ko hh ig b ih ii il im ip kp it kq ix kr jb ks kt ku kv bi translated"><strong class="ig hi"> buy_cost_pct，sell_cost_pct </strong>:每笔买入或卖出交易的交易手续费。</li></ul><pre class="kw kx ky kz fd la lb lc ld aw le bi"><span id="5524" class="lf jl hh lb b fi lg lh l li lj">buy_cost_pct = 1e-3</span><span id="e01d" class="lf jl hh lb b fi lk lh l li lj">sell_cost_pct = 1e-3</span></pre><ul class=""><li id="f716" class="kn ko hh ig b ih ii il im ip kp it kq ix kr jb ks kt ku kv bi translated"><strong class="ig hi"> max_stock </strong>:用户可以定义每笔交易允许交易的最大股票数量。用户还可以设置投资每只股票的最大资金百分比。</li></ul><pre class="kw kx ky kz fd la lb lc ld aw le bi"><span id="3a38" class="lf jl hh lb b fi lg lh l li lj">max_stock = 1e2</span></pre><ul class=""><li id="2dc9" class="kn ko hh ig b ih ii il im ip kp it kq ix kr jb ks kt ku kv bi translated"><strong class="ig hi"> tech_indicator_list </strong>:考虑的财务指标列表，用于定义<em class="ll">状态</em>。</li></ul><pre class="kw kx ky kz fd la lb lc ld aw le bi"><span id="15a6" class="lf jl hh lb b fi lg lh l li lj"><strong class="lb hi">#finrl.config.TECHNICAL_INDICATORS_LIST</strong><br/>tech_indicator_list = ['macd', 'boll_ub', 'boll_lb', 'rsi_30', 'cci_30', 'dx_30', 'close_30_sma', 'close_60_sma']</span></pre><ul class=""><li id="2982" class="kn ko hh ig b ih ii il im ip kp it kq ix kr jb ks kt ku kv bi translated"><strong class="ig hi"> start_date，start_eval_date，end_eval_date </strong>:训练和回溯测试时间间隔。使用时间日期(或时间戳),一旦指定了训练周期，剩下的就是回溯测试。</li></ul><pre class="kw kx ky kz fd la lb lc ld aw le bi"><span id="ecff" class="lf jl hh lb b fi lg lh l li lj">start_date = '2008-03-19'</span><span id="dc85" class="lf jl hh lb b fi lk lh l li lj">start_eval_date = '2016-01-01'</span><span id="aa33" class="lf jl hh lb b fi lk lh l li lj">end_eval_date = '2021-01-01'</span></pre><p id="d175" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">一旦用户定义了所有可定制的特性，她就可以相应地创建一个独特的交易环境。</p><pre class="kw kx ky kz fd la lb lc ld aw le bi"><span id="ce88" class="lf jl hh lb b fi lg lh l li lj">env = StockTradingEnv('./envs/FinRL', gamma, max_stock, initial_capital, buy_cost_pct, sell_cost_pct, start_date, start_eval_date, end_eval_date, tickers, tech_indicator_list, initial_stocks, if_eval=False)</span></pre></div><div class="ab cl jd je go jf" role="separator"><span class="jg bw bk jh ji jj"/><span class="jg bw bk jh ji jj"/><span class="jg bw bk jh ji"/></div><div class="ha hb hc hd he"><h1 id="5fe3" class="jk jl hh bd jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh bi translated"><strong class="ak">ElegantRL中的培训和回溯测试流程</strong></h1><h2 id="498f" class="lf jl hh bd jm lm ln lo jq lp lq lr ju ip ls lt jy it lu lv kc ix lw lx kg ly bi translated"><strong class="ak">准备:</strong></h2><p id="090a" class="pw-post-body-paragraph ie if hh ig b ih ki ij ik il kj in io ip kk ir is it kl iv iw ix km iz ja jb ha bi translated">第一步:安装ElegantRL和相关的软件包</p><ul class=""><li id="d30e" class="kn ko hh ig b ih ii il im ip kp it kq ix kr jb ks kt ku kv bi translated"><strong class="ig hi">优雅</strong></li><li id="afc7" class="kn ko hh ig b ih lz il ma ip mb it mc ix md jb ks kt ku kv bi translated">yfinance的目标是通过提供一种可靠的、线程化的、Pythonic式的方法从雅虎下载历史市场数据来解决这个问题。金融。</li><li id="82c2" class="kn ko hh ig b ih lz il ma ip mb it mc ix md jb ks kt ku kv bi translated"><strong class="ig hi"> Stockstats: </strong> stockstats对熊猫的继承和延伸。支持股票统计和股票指标的数据框架。</li></ul><pre class="kw kx ky kz fd la lb lc ld aw le bi"><span id="43c8" class="lf jl hh lb b fi lg lh l li lj">!pip install git+https://github.com/AI4Finance-LLC/ElegantRL.git<br/>!pip install yfinance stockstats</span></pre><p id="d3b0" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi">第二步:导入包</strong></p><pre class="kw kx ky kz fd la lb lc ld aw le bi"><span id="e075" class="lf jl hh lb b fi lg lh l li lj">from elegantrl.run import *<br/>from elegantrl.agent import AgentDDPG<br/>from elegantrl.envs.FinRL.FinRL import StockTradingEnv<br/>import yfinance as yf<br/>from stockstats import StockDataFrame as Sdf</span></pre><h2 id="bf72" class="lf jl hh bd jm lm ln lo jq lp lq lr ju ip ls lt jy it lu lv kc ix lw lx kg ly bi translated"><strong class="ak">培训渠道:</strong></h2><p id="b122" class="pw-post-body-paragraph ie if hh ig b ih ki ij ik il kj in io ip kk ir is it kl iv iw ix km iz ja jb ha bi translated"><strong class="ig hi">第一步:指定代理和环境</strong></p><pre class="kw kx ky kz fd la lb lc ld aw le bi"><span id="a1e7" class="lf jl hh lb b fi lg lh l li lj"><strong class="lb hi"># Agent<br/></strong>args = Arguments(if_on_policy=True)<br/>args.agent = AgentDDPG() </span><span id="22d0" class="lf jl hh lb b fi lk lh l li lj"><strong class="lb hi"># Environment<br/></strong>...<br/>args.env = StockTradingEnv('./envs/FinRL', gamma, max_stock, initial_capital, buy_cost_pct, sell_cost_pct, start_date, start_eval_date, end_eval_date, tickers, tech_indicator_list, initial_stocks, if_eval=False)</span></pre><p id="4b09" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi">步骤2:初始化超参数</strong></p><pre class="kw kx ky kz fd la lb lc ld aw le bi"><span id="8d39" class="lf jl hh lb b fi lg lh l li lj">args.gamma = 0.995<br/>args.break_step = int(2e5)<br/>args.net_dim = 2 ** 9<br/>...<br/>args.if_allow_break = False<br/>args.rollout_num = 2 # the number of rollout workers (larger is not always faster)</span></pre><p id="47ec" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi">第三步:培训和评估代理</strong></p><pre class="kw kx ky kz fd la lb lc ld aw le bi"><span id="9251" class="lf jl hh lb b fi lg lh l li lj"><strong class="lb hi"># the training process will terminate once it reaches the target reward.</strong><br/>train_and_evaluate_mp(args)</span></pre><p id="2f1e" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi">回测和评估:</strong></p><pre class="kw kx ky kz fd la lb lc ld aw le bi"><span id="b50b" class="lf jl hh lb b fi lg lh l li lj"><strong class="lb hi"># Backtesting</strong><br/>args = Arguments(if_on_policy=True)<br/>args.agent = AgentDDPG()<br/>args.env = StockTradingEnv(cwd='./', if_eval=True)<br/>args.if_remove = False<br/>args.cwd = './AgentDDPG/StockTradingEnv-v1_0'<br/>args.init_before_training()</span><span id="d159" class="lf jl hh lb b fi lk lh l li lj"><strong class="lb hi"># Draw the graph</strong><br/>env.draw_cumulative_return(args, torch)</span></pre><figure class="kw kx ky kz fd mf er es paragraph-image"><div class="er es me"><img src="../Images/d98f9f4aa90161070dac505d655a1706.png" data-original-src="https://miro.medium.com/v2/resize:fit:1280/format:webp/1*4V9skJCoxmF7keX3vnoMlA.jpeg"/></div><figcaption class="mi mj et er es mk ml bd b be z dx">Fig 1. The cumulative return from the Stock Trading agent. [Image by authors].</figcaption></figure><figure class="kw kx ky kz fd mf er es paragraph-image"><div class="er es me"><img src="../Images/37b51d5b41e6c46d443c45bc117d6c09.png" data-original-src="https://miro.medium.com/v2/resize:fit:1280/format:webp/1*dVvpMMB2AYJJUKpvaCQI4A.jpeg"/></div><figcaption class="mi mj et er es mk ml bd b be z dx">Fig 2. The Episode return and the learning curve. [Image by authors].</figcaption></figure><p id="1f40" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">查看这个股票交易演示的<a class="ae jc" href="https://github.com/AI4Finance-LLC/ElegantRL/blob/master/eRL_demo_StockTrading.ipynb" rel="noopener ugc nofollow" target="_blank"> Colab </a>代码。</p></div></div>    
</body>
</html>