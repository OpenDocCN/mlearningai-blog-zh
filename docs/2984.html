<html>
<head>
<title>Integrating Custom PyTorch Models Into an Android App</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">将定制PyTorch模型集成到Android应用程序中</h1>
<blockquote>原文：<a href="https://medium.com/mlearning-ai/integrating-custom-pytorch-models-into-an-android-app-a2cdfce14fe8?source=collection_archive---------0-----------------------#2022-07-05">https://medium.com/mlearning-ai/integrating-custom-pytorch-models-into-an-android-app-a2cdfce14fe8?source=collection_archive---------0-----------------------#2022-07-05</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><p id="8a95" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">最近一直在学习安卓app开发。虽然从头构建一个应用程序真的很酷，但我想知道是否有可能将PyTorch模型集成到我的应用程序中。我不想做任何后端调用，因为那需要一段时间，而且我不得不使用一个数据库服务，这将花费金钱。幸运的是，PyTorch支持Android，我将介绍如何轻松地将您的定制模型放入您的应用程序。</p><p id="dc60" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我也有一个代码的<a class="ae jc" href="https://github.com/gmongaras/PyTorchLite_Demo" rel="noopener ugc nofollow" target="_blank">报告来配合这个教程。</a></p><h1 id="63d7" class="jd je hh bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">设置</h1><p id="33bc" class="pw-post-body-paragraph ie if hh ig b ih kb ij ik il kc in io ip kd ir is it ke iv iw ix kf iz ja jb ha bi translated">首先，你需要安装android studio，你可以<a class="ae jc" href="https://developer.android.com/studio/install" rel="noopener ugc nofollow" target="_blank">免费获得它！</a></p><p id="fd98" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">接下来，让我们创建一个空项目。</p><figure class="kh ki kj kk fd kl er es paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="er es kg"><img src="../Images/52d4f825fed93a90af5ac248e49eaeac.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cPOuaeTG54Y2PVJ0Lp1jWA.png"/></div></div><figcaption class="ks kt et er es ku kv bd b be z dx">Selecting a new project</figcaption></figure><p id="f24c" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">确保您选择Java作为这个项目的语言，因为我将在本教程中使用它。您可以随意命名该项目。我将把这个项目命名为PyTorch_App。下面是您的配置应该是什么样的:</p><figure class="kh ki kj kk fd kl er es paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="er es kw"><img src="../Images/d1fcfa88e1896bf1097c8d3169b73212.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rXh-9MnTOROPnaVU1WqkMQ.png"/></div></div><figcaption class="ks kt et er es ku kv bd b be z dx">New project configuration example</figcaption></figure><p id="fff9" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">以下是我的初始设置文件，以防你想和我一样使用相同的库版本:</p><figure class="kh ki kj kk fd kl er es paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="er es kx"><img src="../Images/9bd2b63288b5e5cd2a003469476b3787.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jwu6o9iT533z8DTZ18HEtg.png"/></div></div><figcaption class="ks kt et er es ku kv bd b be z dx">App-level build.gradle</figcaption></figure><figure class="kh ki kj kk fd kl er es paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="er es ky"><img src="../Images/24bffd3c587afc1a6a411272fa48def2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*w5vUFXF1QAIx5KAED6S0XQ.png"/></div></div><figcaption class="ks kt et er es ku kv bd b be z dx">Project-level build.gradle</figcaption></figure><p id="e57c" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">如果你没有设备模拟器设置，你应该<a class="ae jc" href="https://developer.android.com/studio/run/managing-avds" rel="noopener ugc nofollow" target="_blank">设置一个</a>，这样你就可以运行这个应用程序。</p><p id="6f4b" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">创建好项目后，让我们将PyTorch库添加到我们的应用程序中。这样做很容易，只需要在应用程序级build.gradle文件中添加一行代码:</p><figure class="kh ki kj kk fd kl er es paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="er es kz"><img src="../Images/f26b17824b121ec72b89c5a905ad6cdf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KlgKOZPVpd9jL6OwIhwjxw.png"/></div></div><figcaption class="ks kt et er es ku kv bd b be z dx">Updated app-level build.gradle</figcaption></figure><p id="67ab" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">单击右上角的“立即同步”,项目应该会更新。现在设置完成了，我们可以开始创建我们的应用程序了！</p><h1 id="4864" class="jd je hh bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">模型创建</h1><p id="9c03" class="pw-post-body-paragraph ie if hh ig b ih kb ij ik il kc in io ip kd ir is it ke iv iw ix kf iz ja jb ha bi translated">为了展示PyTorch如何与模型一起使用，我将创建一个简单的模型，该模型将<em class="la"> N </em>个噪声向量作为输入，输出0到9之间的<em class="la"> N </em>个数字。所以，我们开始编码吧！</p><pre class="kh ki kj kk fd lb lc ld le aw lf bi"><span id="2a44" class="lg je hh lc b fi lh li l lj lk">import torch<br/>from torch import nn<br/>class Model(nn.Module):<br/>    def __init__(self):<br/>        super(Model, self).__init__()<br/>        <br/>        # Basic MLP with 2 inputs, 4 hidden layers<br/>        # and 10 outputs where each output is<br/>        # the softmax probabilities of a number 0 to 9<br/>        self.MLP = nn.Sequential(<br/>            nn.Linear(2, 5),<br/>            nn.Linear(5, 10),<br/>            nn.Linear(10, 15),<br/>            nn.Linear(15, 20),<br/>            nn.Linear(20, 15),<br/>            nn.Linear(15, 10),<br/>            nn.Softmax(-1)<br/>        )<br/>    <br/>    def forward(self, X):<br/>        return torch.argmax(self.MLP(X), dim=-1)</span></pre><p id="9c90" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">该模型将接受一个包含2个元素的向量(这只是我选择的某个任意数字)，并输出一个包含10个元素的向量，其中输出向量中的每个元素都是该模型认为应该选择该数字的概率。当然，模型没有经过训练，所以概率输出没有任何上下文。尽管如此，我们可以只取向量中最大输出值(argmax)的索引来获得预测值。下面的函数用于显示我们如何通过输入<em class="la"> N </em>个噪声向量从模型中获得一个由<em class="la"> N </em>个基本随机数组成的样本。</p><pre class="kh ki kj kk fd lb lc ld le aw lf bi"><span id="3861" class="lg je hh lc b fi lh li l lj lk">def main():<br/>    # Create the model<br/>    model = Model()<br/>    <br/>    # Create 4 random noise vectors<br/>    # meaning we want 4 random numbers<br/>    X = torch.distributions.uniform.Uniform(-10000,\<br/>        10000).sample((4, 2))<br/>    <br/>    # Send the noise vectors through the model<br/>    # to get the argmax outputs<br/>    outputs = model(X)<br/>    <br/>    # Print the outputs<br/>    for o in outputs:<br/>        print(f"{o.item()} ")<br/>    <br/>    # Save the model to a file named model.pkl<br/>    torch.save(model.state_dict(), "model.pkl")</span></pre><p id="d500" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">然后，该模型被保存到一个名为“model.pkl”的文件中，我们将使用该文件作为Android应用程序的模型。</p><p id="abcb" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在开发应用程序之前，你可以想象一个正常的模型有几个问题。例如:</p><ul class=""><li id="6334" class="ll lm hh ig b ih ii il im ip ln it lo ix lp jb lq lr ls lt bi translated">一个好的模型可能非常大</li><li id="76e7" class="ll lm hh ig b ih lu il lv ip lw it lx ix ly jb lq lr ls lt bi translated">加载模型可能需要一段时间</li><li id="20fb" class="ll lm hh ig b ih lu il lv ip lw it lx ix ly jb lq lr ls lt bi translated">模型可能需要一段时间才能做出预测</li></ul><p id="7f64" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">为了减少这些问题，PyTorch有一个非常有用的特性叫做<a class="ae jc" href="https://pytorch.org/docs/stable/jit.html" rel="noopener ugc nofollow" target="_blank"> TorchScript </a>，它优化了模型的部署。当然，减少的也只能有这么多。所以，不要指望它会神奇地把海量模型变成更小的模型。此外，在加载模型时不必定义模型结构，这使得它在我们的应用程序中非常容易使用。下面的代码采用我们保存的模型，针对移动设备进行优化，然后将其保存到一个新文件中。</p><pre class="kh ki kj kk fd lb lc ld le aw lf bi"><span id="dfae" class="lg je hh lc b fi lh li l lj lk">from torch.utils.mobile_optimizer import optimize_for_mobile<br/>def optimizeSave():<br/>    # Load in the model<br/>    model = Model()<br/>    model.load_state_dict(torch.load("model.pkl", \<br/>        map_location=torch.device("cpu")))<br/>    model.eval() # Put the model in inference mode<br/>    <br/>    # Generate some random noise<br/>    X = torch.distributions.uniform.Uniform(-10000, \<br/>        10000).sample((4, 2))<br/>    <br/>    # Generate the optimized model<br/>    traced_script_module = torch.jit.trace(model, X)<br/>    traced_script_module_optimized = optimize_for_mobile(\<br/>        traced_script_module)<br/>    <br/>    # Save the optimzied model<br/>    traced_script_module_optimized._save_for_lite_interpreter(\<br/>        "model.pt")</span></pre><p id="bfc7" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">现在我们有一个优化的模型放在我们的应用程序中！</p><h1 id="8a9b" class="jd je hh bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">创建应用程序</h1><p id="5514" class="pw-post-body-paragraph ie if hh ig b ih kb ij ik il kc in io ip kd ir is it ke iv iw ix kf iz ja jb ha bi translated">该应用程序将包括一个基本的编辑文本字段，供用户指定要生成的随机数的数量，一个生成一些随机数的按钮，以及一个显示随机数的文本字段。“activity_main.xml”中的代码如下:</p><pre class="kh ki kj kk fd lb lc ld le aw lf bi"><span id="92a0" class="lg je hh lc b fi lh li l lj lk">&lt;?xml version="1.0" encoding="utf-8"?&gt;<br/>&lt;androidx.constraintlayout.widget.ConstraintLayout<br/>    xmlns:android="<a class="ae jc" href="http://schemas.android.com/apk/res/android" rel="noopener ugc nofollow" target="_blank">http://schemas.android.com/apk/res/android</a>"<br/>    xmlns:app="<a class="ae jc" href="http://schemas.android.com/apk/res-auto" rel="noopener ugc nofollow" target="_blank">http://schemas.android.com/apk/res-auto</a>"<br/>    xmlns:tools="<a class="ae jc" href="http://schemas.android.com/tools" rel="noopener ugc nofollow" target="_blank">http://schemas.android.com/tools</a>"<br/>    android:layout_width="match_parent"<br/>    android:layout_height="match_parent"<br/>    tools:context=".MainActivity"&gt;</span><span id="8814" class="lg je hh lc b fi lz li l lj lk">&lt;TextView<br/>        android:id="@+id/textView"<br/>        android:layout_width="wrap_content"<br/>        android:layout_height="wrap_content"<br/>        android:layout_marginBottom="100dp"<br/>        android:text="Number of digits to generate"<br/>        android:textColor="<a class="ae jc" href="http://twitter.com/color/black" rel="noopener ugc nofollow" target="_blank">@color/black</a>"<br/>        android:textSize="20sp"<br/>        app:layout_constraintBottom_toBottomOf="parent"<br/>        app:layout_constraintEnd_toEndOf="parent"<br/>        app:layout_constraintStart_toStartOf="parent"<br/>        app:layout_constraintTop_toTopOf="parent" /&gt;</span><span id="3bf5" class="lg je hh lc b fi lz li l lj lk">&lt;EditText<br/>        android:id="@+id/etNumber"<br/>        android:layout_width="wrap_content"<br/>        android:layout_height="wrap_content"<br/>        android:ems="10"<br/>        android:hint="digits"<br/>        android:inputType="number"<br/>        android:minHeight="48dp"<br/>        app:layout_constraintEnd_toEndOf="parent"<br/>        app:layout_constraintStart_toStartOf="parent"<br/>        app:layout_constraintTop_toBottomOf="@+id/textView" /&gt;</span><span id="fffe" class="lg je hh lc b fi lz li l lj lk">&lt;Button<br/>        android:id="@+id/btnInfer"<br/>        android:layout_width="wrap_content"<br/>        android:layout_height="wrap_content"<br/>        android:layout_marginTop="10dp"<br/>        android:text="Infer"<br/>        app:layout_constraintEnd_toEndOf="parent"<br/>        app:layout_constraintStart_toStartOf="parent"<br/>        app:layout_constraintTop_toBottomOf="@+id/etNumber" /&gt;</span><span id="d788" class="lg je hh lc b fi lz li l lj lk">&lt;TextView<br/>        android:id="@+id/tvDigits"<br/>        android:layout_width="wrap_content"<br/>        android:layout_height="wrap_content"<br/>        android:layout_marginTop="10dp"<br/>        android:textColor="<a class="ae jc" href="http://twitter.com/color/black" rel="noopener ugc nofollow" target="_blank">@color/black</a>"<br/>        android:textSize="20sp"<br/>        app:layout_constraintEnd_toEndOf="parent"<br/>        app:layout_constraintStart_toStartOf="parent"<br/>        app:layout_constraintTop_toBottomOf="@+id/btnInfer"<br/>        tools:text="123456789" /&gt;<br/>&lt;/androidx.constraintlayout.widget.ConstraintLayout&gt;</span></pre><p id="7a77" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">现在我们已经有了应用程序的结构，让我们添加模型。首先，在<em class="la"> app/src/main </em>中创建一个名为<em class="la"> assets </em>的新目录。然后将“model.pt”文件放在<em class="la">资产</em>文件夹中。您的文件系统应该如下所示</p><figure class="kh ki kj kk fd kl er es paragraph-image"><div class="er es ma"><img src="../Images/0199870963d0cac64a48fd600038a56a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1032/format:webp/1*q--SKS9uOSmeRQNFHoKZBQ.png"/></div><figcaption class="ks kt et er es ku kv bd b be z dx">Image showing the proper location of the assets directory</figcaption></figure><p id="2e1c" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">现在我们可以开始加载模型了。在“MainActivity.java”中，让我们在<em class="la"> onCreate </em>之外添加一些全局变量，这将有助于我们在视图中存储模型和元素。</p><pre class="kh ki kj kk fd lb lc ld le aw lf bi"><span id="544e" class="lg je hh lc b fi lh li l lj lk">// Elements in the view<br/>EditText etNumber;<br/>Button btnInfer;<br/>TextView tvDigits;<br/><br/>// Tag used for logging<br/>private static final String <em class="la">TAG </em>= "MainActivity";<br/><br/>// PyTorch model<br/>Module module;</span></pre><p id="dd4c" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">现在，让我们在<em class="la"> onCreate </em>方法中加载模型。</p><pre class="kh ki kj kk fd lb lc ld le aw lf bi"><span id="0241" class="lg je hh lc b fi lh li l lj lk">// Get all the elements<br/>etNumber = findViewById(R.id.<em class="la">etNumber</em>);<br/>btnInfer = findViewById(R.id.<em class="la">btnInfer</em>);<br/>tvDigits = findViewById(R.id.<em class="la">tvDigits</em>);<br/><br/>// Load in the model<br/>try {<br/>    module = LiteModuleLoader.<em class="la">load</em>(assetFilePath("model.pt"));<br/>} catch (IOException e) {<br/>    Log.<em class="la">e</em>(<em class="la">TAG</em>, "Unable to load model", e);<br/>}</span></pre><p id="c744" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><em class="la"> assetFilePath </em>是我们需要定义的一个函数。它所做的只是创建“model.pt”的路径，假设它在<em class="la"> app/src/main/assets </em>文件夹中。</p><pre class="kh ki kj kk fd lb lc ld le aw lf bi"><span id="cfd4" class="lg je hh lc b fi lh li l lj lk">// Given the name of the pytorch model, get the path for that model<br/>public String assetFilePath(String assetName) throws IOException {<br/>    File file = new File(this.getFilesDir(), assetName);<br/>    if (file.exists() &amp;&amp; file.length() &gt; 0) {<br/>        return file.getAbsolutePath();<br/>    }<br/><br/>    try (InputStream is = this.getAssets().open(assetName)) {<br/>        try (OutputStream os = new FileOutputStream(file)) {<br/>            byte[] buffer = new byte[4 * 1024];<br/>            int read;<br/>            while ((read = is.read(buffer)) != -1) {<br/>                os.write(buffer, 0, read);<br/>            }<br/>            os.flush();<br/>        }<br/>        return file.getAbsolutePath();<br/>    }<br/>}</span></pre><p id="9746" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">此外，应该定义另一个辅助函数，它以一个大小作为输入，并输出该大小的张量。</p><pre class="kh ki kj kk fd lb lc ld le aw lf bi"><span id="3c44" class="lg je hh lc b fi lh li l lj lk">// Generate a tensor of random numbers given the size of that tensor.<br/>public Tensor generateTensor(long[] Size) {<br/>    // Create a random array of floats<br/>    Random rand = new Random();<br/>    float[] arr = new float[(int)(Size[0]*Size[1])];<br/>    for (int i = 0; i &lt; Size[0]*Size[1]; i++) {<br/>        arr[i] = -10000 + rand.nextFloat() * (20000);<br/>    }<br/><br/>    // Create the tensor and return it<br/>    return Tensor.<em class="la">fromBlob</em>(arr, Size);<br/>}</span></pre><p id="556f" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">最后，让我们为按钮创建一个<em class="la"> onClick </em>事件，这样当它被点击时就会生成一个新的数字序列。该函数将在模型加载后立即定义</p><pre class="kh ki kj kk fd lb lc ld le aw lf bi"><span id="a8e9" class="lg je hh lc b fi lh li l lj lk">// When the button is clicked, generate a noise tensor<br/>// and get the output from the model<br/>btnInfer.setOnClickListener(new View.OnClickListener() {<br/>    @Override<br/>    public void onClick(View view) {<br/>        // Error checking<br/>        if (etNumber.getText().toString().length() == 0) {<br/>            Toast.<em class="la">makeText</em>(MainActivity.this, "A number must be supplied", Toast.<em class="la">LENGTH_SHORT</em>).show();<br/>            return;<br/>        }<br/><br/>        // Get the number of numbers to generate from the edit text<br/>        int N = Integer.<em class="la">parseInt</em>(etNumber.getText().toString());<br/><br/>        // More error checking<br/>        if (N &lt; 1 || N &gt; 10) {<br/>            Toast.<em class="la">makeText</em>(MainActivity.this, "Digits must be greater than 0 and less than 10", Toast.<em class="la">LENGTH_SHORT</em>).show();<br/>            return;<br/>        }<br/><br/>        // Prepare the input tensor (N, 2)<br/>        long[] shape = new long[]{N, 2};<br/>        Tensor inputTensor = generateTensor(shape);<br/><br/>        // Get the output from the model<br/>        long[] output = module.forward(IValue.<em class="la">from</em>(inputTensor)).toTensor().getDataAsLongArray();<br/><br/>        // Get the output as a string<br/>        String out = "";<br/>        for (long l : output) {<br/>            out += String.<em class="la">valueOf</em>(l);<br/>        }<br/><br/>        // Show the output<br/>        tvDigits.setText(out);<br/>    }<br/>});</span></pre><p id="ac23" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">这种方法与Python代码中的main函数非常相似，因为它创建一个噪声向量，将其传递给模型，然后迭代输出以显示输出的字符。</p><p id="3fd1" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">如果你现在运行应用程序，你应该能够在点击按钮时生成随机字符</p><figure class="kh ki kj kk fd kl er es paragraph-image"><div class="er es mb"><img src="../Images/9e798798938894cab10dc90502765222.png" data-original-src="https://miro.medium.com/v2/resize:fit:736/1*BIttt6nU1UC7aaTuKSRyUw.gif"/></div><figcaption class="ks kt et er es ku kv bd b be z dx">Demo of the app we created!</figcaption></figure><p id="10bd" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi">注意</strong>:如果你在向前传递时得到一个<em class="la"> null </em>错误，模型文件可能在错误的目录中。确保<em class="la">资产</em>目录位于<em class="la"> app/src/main/ </em>中，而不是<em class="la">app/src/【Android test】</em>中。</p><h1 id="8eab" class="jd je hh bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">图像生成</h1><p id="3ad8" class="pw-post-body-paragraph ie if hh ig b ih kb ij ik il kc in io ip kd ir is it ke iv iw ix kf iz ja jb ha bi translated">和点击按钮生成随机数一样有趣的是，图像呢？</p><p id="daa1" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我已经训练了一个StyleGAN3模型，我们将使用它来生成图像。虽然模型非常大，但它仍然是一个很好的例子，说明了如何在Android中使用图像模型。首先，创建一个名为<em class="la"> MainActivity2 </em>的新的空活动。然后进入Android Manifest将初始活动从<em class="la">主活动</em>更改为<em class="la">主活动2 </em>。Android清单应该如下所示</p><figure class="kh ki kj kk fd kl er es paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="er es mc"><img src="../Images/06e1900874d93fb17f618ec7b0d605fd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6fi-uDBTxVJSAUHeJA7H6w.png"/></div></div><figcaption class="ks kt et er es ku kv bd b be z dx">Updated AndroidManifest.xml</figcaption></figure><p id="a497" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">注意<em class="la"> &lt;意图过滤&gt; </em>位置从<em class="la">主活动</em>到<em class="la">主活动2 </em>的切换。这就是改变开始活动的原因。现在让我们创建XML文件。XML文件中有几个视图，用于在单击按钮时显示图像</p><pre class="kh ki kj kk fd lb lc ld le aw lf bi"><span id="bd18" class="lg je hh lc b fi lh li l lj lk">&lt;?xml version="1.0" encoding="utf-8"?&gt;<br/>&lt;androidx.constraintlayout.widget.ConstraintLayout xmlns:android="<a class="ae jc" href="http://schemas.android.com/apk/res/android" rel="noopener ugc nofollow" target="_blank">http://schemas.android.com/apk/res/android</a>"<br/>    xmlns:app="<a class="ae jc" href="http://schemas.android.com/apk/res-auto" rel="noopener ugc nofollow" target="_blank">http://schemas.android.com/apk/res-auto</a>"<br/>    xmlns:tools="<a class="ae jc" href="http://schemas.android.com/tools" rel="noopener ugc nofollow" target="_blank">http://schemas.android.com/tools</a>"<br/>    android:layout_width="match_parent"<br/>    android:layout_height="match_parent"<br/>    tools:context=".MainActivity2"&gt;</span><span id="c099" class="lg je hh lc b fi lz li l lj lk">&lt;Button<br/>        android:id="@+id/btnGenerate"<br/>        android:layout_width="wrap_content"<br/>        android:layout_height="wrap_content"<br/>        android:text="Create new image"<br/>        app:layout_constraintBottom_toBottomOf="parent"<br/>        app:layout_constraintEnd_toEndOf="parent"<br/>        app:layout_constraintStart_toStartOf="parent"<br/>        app:layout_constraintTop_toTopOf="parent" /&gt;</span><span id="8575" class="lg je hh lc b fi lz li l lj lk">&lt;ImageView<br/>        android:id="@+id/ivImage"<br/>        android:layout_width="wrap_content"<br/>        android:layout_height="wrap_content"<br/>        app:layout_constraintBottom_toTopOf="@+id/btnGenerate"<br/>        app:layout_constraintEnd_toEndOf="parent"<br/>        app:layout_constraintStart_toStartOf="parent"<br/>        app:layout_constraintTop_toTopOf="parent"<br/>        tools:srcCompat="<a class="ae jc" href="http://twitter.com/tools" rel="noopener ugc nofollow" target="_blank">@tools</a>:sample/avatars" /&gt;</span><span id="a6f7" class="lg je hh lc b fi lz li l lj lk">&lt;TextView<br/>        android:id="@+id/tvWaiting"<br/>        android:layout_width="wrap_content"<br/>        android:layout_height="wrap_content"<br/>        android:text="Generating image..."<br/>        android:textColor="<a class="ae jc" href="http://twitter.com/color/black" rel="noopener ugc nofollow" target="_blank">@color/black</a>"<br/>        android:textSize="20sp"<br/>        android:visibility="invisible"<br/>        app:layout_constraintBottom_toTopOf="@+id/btnGenerate"<br/>        app:layout_constraintEnd_toEndOf="parent"<br/>        app:layout_constraintStart_toStartOf="parent"<br/>        app:layout_constraintTop_toTopOf="parent" /&gt;<br/>&lt;/androidx.constraintlayout.widget.ConstraintLayout&gt;</span></pre><p id="80a8" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">现在，让我们开始编写活动代码。首先，让我们添加一些全局变量，以便在稍后的活动中有所帮助。</p><pre class="kh ki kj kk fd lb lc ld le aw lf bi"><span id="22f8" class="lg je hh lc b fi lh li l lj lk">// Elements in the view<br/>Button btnGenerate;<br/>ImageView ivImage;<br/>TextView tvWaiting;<br/><br/>// Tag used for logging<br/>private static final String <em class="la">TAG </em>= "MainActivity2";<br/><br/>// PyTorch model<br/>Module module;<br/><br/>// Size of the input tensor<br/>int inSize = 512;<br/><br/>// Width and height of the output image<br/>int width = 256;<br/>int height = 256;</span></pre><p id="3f8a" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">stylegan模型将512维噪声向量作为输入，并输出形状256✕256✕3的图像，其中3是RGB通道。</p><p id="aa91" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">现在，让我们使用上一个活动中使用的相同函数来获取资产的路径。该功能与上一个活动中的功能完全相同。</p><pre class="kh ki kj kk fd lb lc ld le aw lf bi"><span id="5cea" class="lg je hh lc b fi lh li l lj lk">// Given the name of the pytorch model, get the path for that model<br/>public String assetFilePath(String assetName) throws IOException {<br/>    File file = new File(this.getFilesDir(), assetName);<br/>    if (file.exists() &amp;&amp; file.length() &gt; 0) {<br/>        return file.getAbsolutePath();<br/>    }<br/><br/>    try (InputStream is = this.getAssets().open(assetName)) {<br/>        try (OutputStream os = new FileOutputStream(file)) {<br/>            byte[] buffer = new byte[4 * 1024];<br/>            int read;<br/>            while ((read = is.read(buffer)) != -1) {<br/>                os.write(buffer, 0, read);<br/>            }<br/>            os.flush();<br/>        }<br/>        return file.getAbsolutePath();<br/>    }<br/>}</span></pre><p id="56b2" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">至于<em class="la"> generateTensor </em>函数，我们需要稍微改一下。因为我们一次只生成一个图像，所以我们想生成一个有512个元素的张量。此外，stylegan噪声是专门从高斯分布中采样的，因此我们可以将rand.nextrand()更改为rand.nextGaussian()。因为模型实际上是经过训练的，所以我们不需要像在其他活动中那样将噪声乘以任何值。</p><pre class="kh ki kj kk fd lb lc ld le aw lf bi"><span id="32ef" class="lg je hh lc b fi lh li l lj lk">// Generate a tensor of random doubles given the size of<br/>// the tensor to generate<br/>public Tensor generateTensor(int size) {<br/>    // Create a random array of doubles<br/>    Random rand = new Random();<br/>    double[] arr = new double[size];<br/>    for (int i = 0; i &lt; size; i++) {<br/>        arr[i] = rand.nextGaussian();<br/>    }<br/><br/>    // Create the tensor and return it<br/>    long[] s = {1, size};<br/>    return Tensor.<em class="la">fromBlob</em>(arr, s);<br/>}</span></pre><p id="6b46" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">现在，助手变量和函数已经就绪，下载<a class="ae jc" href="https://github.com/gmongaras/PyTorchLite_Demo/tree/main/app/src/main/assets" rel="noopener ugc nofollow" target="_blank"> <em class="la"> imageGen.pt </em> </a>模型，并将其放入<em class="la"> assets </em>目录，就像您对其他模型所做的那样。</p><p id="ad2a" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我不打算解释这个<em class="la">是怎么来的。pt </em>模型的创建过程与数字生成模型非常相似，但是如果您有兴趣查看生成模型的脚本，您可以在本文附带的代码的<a class="ae jc" href="https://github.com/gmongaras/PyTorchLite_Demo/blob/main/Python/stylegan3-main/optimize.py" rel="noopener ugc nofollow" target="_blank">部分找到它。</a></p><p id="1a66" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">有了模型，我们就可以开始编写<em class="la"> onCreate </em>函数了。首先，让我们添加基本的视图查找和模型加载。</p><pre class="kh ki kj kk fd lb lc ld le aw lf bi"><span id="5618" class="lg je hh lc b fi lh li l lj lk">// Get the elements in the activity<br/>btnGenerate = findViewById(R.id.<em class="la">btnGenerate</em>);<br/>ivImage = findViewById(R.id.<em class="la">ivImage</em>);<br/>tvWaiting = findViewById(R.id.<em class="la">tvWaiting</em>);<br/><br/>// Load in the model<br/>try {<br/>    module = LiteModuleLoader.<em class="la">load</em>(assetFilePath("imageGen.pt"));<br/>} catch (IOException e) {<br/>    Log.<em class="la">e</em>(<em class="la">TAG</em>, "Unable to load model", e);<br/>}</span></pre><p id="53df" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">最后，我们要做的就是在按钮上放置一个onClick监听器。</p><pre class="kh ki kj kk fd lb lc ld le aw lf bi"><span id="d90f" class="lg je hh lc b fi lh li l lj lk">// When the button is clicked, generate a new image<br/>btnGenerate.setOnClickListener(new View.OnClickListener() {<br/>    @Override<br/>    public void onClick(View view) {<br/>        // Error handing<br/>        btnGenerate.setClickable(false);<br/>        ivImage.setVisibility(View.<em class="la">INVISIBLE</em>);<br/>        tvWaiting.setVisibility(View.<em class="la">VISIBLE</em>);<br/><br/>        // Prepare the input tensor. This time, its a<br/>        // a single integer value.<br/>        Tensor inputTensor = generateTensor(inSize);<br/><br/>        // Run the process on a background thread<br/>        new Thread(new Runnable() {<br/>            @Override<br/>            public void run() {<br/>                // Get the output from the model. The<br/>                // length should be 256*256*3 or 196608<br/>                // Note that the output is in the layout<br/>                // [R, G, B, R, G, B, ..., B] and we<br/>                // have to deal with that.<br/>                float[] outputArr = module.forward(IValue.<em class="la">from</em>(inputTensor)).toTensor().getDataAsFloatArray();<br/><br/>                // Ensure the output array has values between 0 and 255<br/>                for (int i = 0; i &lt; outputArr.length; i++) {<br/>                    outputArr[i] = Math.<em class="la">min</em>(Math.<em class="la">max</em>(outputArr[i], 0), 255);<br/>                }<br/><br/>                // Create a RGB bitmap of the correct shape<br/>                Bitmap bmp = Bitmap.<em class="la">createBitmap</em>(width, height, Bitmap.Config.<em class="la">RGB_565</em>);<br/><br/>                // Iterate over all values in the output tensor<br/>                // and put them into the bitmap<br/>                int loc = 0;<br/>                for (int y = 0; y &lt; width; y++) {<br/>                    for (int x = 0; x &lt; height; x++) {<br/>                        bmp.setPixel(x, y, Color.<em class="la">rgb</em>((int)outputArr[loc], (int)outputArr[loc+1], (int)outputArr[loc+2]));<br/>                        loc += 3;<br/>                    }<br/>                }<br/><br/>                // The output of the network is no longer needed<br/>                outputArr = null;<br/><br/>                // Resize the bitmap to a larger image<br/>                bmp = Bitmap.<em class="la">createScaledBitmap</em>(<br/>                        bmp, 512, 512, false);<br/><br/>                // Display the image<br/>                Bitmap finalBmp = bmp;<br/>                runOnUiThread(new Runnable() {<br/>                    @Override<br/>                    public void run() {<br/>                        ivImage.setImageBitmap(finalBmp);<br/><br/>                        // Error handing<br/>                        btnGenerate.setClickable(true);<br/>                        tvWaiting.setVisibility(View.<em class="la">INVISIBLE</em>);<br/>                        ivImage.setVisibility(View.<em class="la">VISIBLE</em>);<br/>                    }<br/>                });<br/><br/>            }<br/>        }).start();<br/><br/>    }<br/>});</span></pre><p id="73b9" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">这个函数看起来有点吓人，我来分解一下:</p><ol class=""><li id="f577" class="ll lm hh ig b ih ii il im ip ln it lo ix lp jb md lr ls lt bi translated">单击按钮时，禁用按钮并生成输入张量。</li><li id="c472" class="ll lm hh ig b ih lu il lv ip lw it lx ix ly jb md lr ls lt bi translated">在一个后台线程上，通过模型发送噪声以获得一个名为<em class="la"> outputArr </em>的浮点输出数组。<br/> -这个输出数组有1个数据维，256*256*3或196608个浮点值。<br/> -数组被构造成一个扁平的图像，其中前256*3或768个值属于图像中的第一行像素。<br/> -在数组中，RGB值按如下顺序存储:[R，G，B，R，G，B，… R，G，B]。因此，第一个像素由数组中的前三个值表示，第二个像素由后三个值表示，依此类推。</li><li id="fe19" class="ll lm hh ig b ih lu il lv ip lw it lx ix ly jb md lr ls lt bi translated">获得浮点数组后，我们需要将值限制在0到255之间，因为这是RGB值的范围。</li><li id="d9ad" class="ll lm hh ig b ih lu il lv ip lw it lx ix ly jb md lr ls lt bi translated">然后，我们可以使用数组的属性将这些值转换为RGB位图。</li><li id="65dd" class="ll lm hh ig b ih lu il lv ip lw it lx ix ly jb md lr ls lt bi translated">为了更好地观看，位图从256✕256调整到512✕512。</li><li id="4127" class="ll lm hh ig b ih lu il lv ip lw it lx ix ly jb md lr ls lt bi translated">最后，在主线程上，我们可以用新创建的图像更改图像视图，并允许单击按钮。</li></ol><p id="d17a" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">下面显示了一个输出示例</p><figure class="kh ki kj kk fd kl er es paragraph-image"><div class="er es me"><img src="../Images/1f02f60a9a92e3e780c5ecd2c3a1fbc6.png" data-original-src="https://miro.medium.com/v2/resize:fit:824/format:webp/1*tyuoQUA-8zuB_IPTfkEVaA.png"/></div><figcaption class="ks kt et er es ku kv bd b be z dx">Example output</figcaption></figure><p id="3610" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi">注意</strong>:如果你的应用在生成新图像时崩溃，那么它可能耗尽了内存或者有相关的问题。我不知道有多少方法可以在不改变模型的情况下解决这个问题，但为了以防万一，我在Windows笔记本电脑上使用了带有API 32 (Sv2)的Pixel 4模拟器。</p><p id="06a3" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">由于stylegan模型非常大，并且使用了大量的内存，它可能会使您的仿真器崩溃，但是从张量中提取图像数据的过程对于其他图像生成模型应该是相同的。在实践中，如果一个图像生成模型被放在一个Android应用程序上，它可能需要为移动设备进行更多的优化。</p><p id="bdfe" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">这就是将PyTorch模型集成到Android应用程序的全部内容。这不是很难，虽然处理图像输出可能有点乏味。不管怎样，我希望这篇文章对你有所帮助！</p><div class="mf mg ez fb mh mi"><a rel="noopener follow" target="_blank" href="/mlearning-ai/mlearning-ai-submission-suggestions-b51e2b130bfb"><div class="mj ab dw"><div class="mk ab ml cl cj mm"><h2 class="bd hi fi z dy mn ea eb mo ed ef hg bi translated">Mlearning.ai提交建议</h2><div class="mp l"><h3 class="bd b fi z dy mn ea eb mo ed ef dx translated">如何成为Mlearning.ai上的作家</h3></div><div class="mq l"><p class="bd b fp z dy mn ea eb mo ed ef dx translated">medium.com</p></div></div><div class="mr l"><div class="ms l mt mu mv mr mw kq mi"/></div></div></a></div></div></div>    
</body>
</html>