<html>
<head>
<title>Azure Machine learning SDK V2 — AutoML Vision</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Azure机器学习SDK V2 — AutoML视觉</h1>
<blockquote>原文：<a href="https://medium.com/mlearning-ai/azure-machine-learning-sdk-v2-automl-vision-29e70e551f4f?source=collection_archive---------5-----------------------#2022-07-30">https://medium.com/mlearning-ai/azure-machine-learning-sdk-v2-automl-vision-29e70e551f4f?source=collection_archive---------5-----------------------#2022-07-30</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><h1 id="4852" class="ie if hh bd ig ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb bi translated">azure Machine learning SDK V2 AutoML视觉实验，使用mlflow进行对象检测</h1><h1 id="3f97" class="ie if hh bd ig ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb bi translated">先决条件</h1><ul class=""><li id="38c9" class="jc jd hh je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt bi translated">Azure帐户</li><li id="d92b" class="jc jd hh je b jf ju jh jv jj jw jl jx jn jy jp jq jr js jt bi translated">Azure机器学习资源</li><li id="ed77" class="jc jd hh je b jf ju jh jv jj jw jl jx jn jy jp jq jr js jt bi translated">默认AML存储</li><li id="f4c1" class="jc jd hh je b jf ju jh jv jj jw jl jx jn jy jp jq jr js jt bi translated">创建培训、测试和验证文件夹</li><li id="329d" class="jc jd hh je b jf ju jh jv jj jw jl jx jn jy jp jq jr js jt bi translated">以上文件夹的ml表配置</li><li id="0665" class="jc jd hh je b jf ju jh jv jj jw jl jx jn jy jp jq jr js jt bi translated">安装预览功能</li><li id="c430" class="jc jd hh je b jf ju jh jv jj jw jl jx jn jy jp jq jr js jt bi translated">请记住，预览的打印版本只能使用_version。版本</li><li id="fc57" class="jc jd hh je b jf ju jh jv jj jw jl jx jn jy jp jq jr js jt bi translated">下面显示了组织数据的文件夹结构</li><li id="74a9" class="jc jd hh je b jf ju jh jv jj jw jl jx jn jy jp jq jr js jt bi translated">这里有数据—<a class="ae jz" href="https://github.com/Azure/azureml-examples/tree/sdk-preview/sdk/jobs/automl-standalone-jobs/automl-image-object-detection-task-fridge-items" rel="noopener ugc nofollow" target="_blank">https://github . com/Azure/Azure ml-examples/tree/SDK-preview/SDK/jobs/automl-standalone-jobs/automl-image-object-detection-task-冰箱-items </a></li></ul><figure class="kb kc kd ke fd kf er es paragraph-image"><div role="button" tabindex="0" class="kg kh di ki bf kj"><div class="er es ka"><img src="../Images/67a2116e93393ea200038e3d4967addf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*CSyNyRL-6iySamyy.jpg"/></div></div></figure><ul class=""><li id="bd04" class="jc jd hh je b jf km jh kn jj ko jl kp jn kq jp jq jr js jt bi translated">对于基于文件夹的MlTable，这里有一个示例训练代码</li><li id="5441" class="jc jd hh je b jf ju jh jv jj jw jl jx jn jy jp jq jr js jt bi translated">整个代码流</li></ul><figure class="kb kc kd ke fd kf er es paragraph-image"><div role="button" tabindex="0" class="kg kh di ki bf kj"><div class="er es kr"><img src="../Images/428dd28cc43a44747fc8392498d0f7df.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*qJKNgrJMKCp3JqLa.jpg"/></div></div></figure><pre class="kb kc kd ke fd ks kt ku kv aw kw bi"><span id="fa68" class="kx if hh kt b fi ky kz l la lb">paths:<br/>  - file: ./train_annotations.jsonl<br/>transformations:<br/>  - read_json_lines:<br/>        encoding: utf8<br/>        invalid_lines: error<br/>        include_path_column: false<br/>  - convert_column_types:<br/>      - columns: image_url<br/>        column_type: stream_info</span></pre><ul class=""><li id="f47c" class="jc jd hh je b jf km jh kn jj ko jl kp jn kq jp jq jr js jt bi translated">对于文本数据，它可能是。csv文件</li><li id="8edb" class="jc jd hh je b jf ju jh jv jj jw jl jx jn jy jp jq jr js jt bi translated">文件:是提供实际培训文件名的地方</li><li id="6f6c" class="jc jd hh je b jf ju jh jv jj jw jl jx jn jy jp jq jr js jt bi translated">在这里，我们将创建一个数据文件夹，然后放置所有数据文件夹</li><li id="dfd8" class="jc jd hh je b jf ju jh jv jj jw jl jx jn jy jp jq jr js jt bi translated">确保安装了AML SDK v2</li></ul><pre class="kb kc kd ke fd ks kt ku kv aw kw bi"><span id="c903" class="kx if hh kt b fi ky kz l la lb">import azure.ai.ml<br/>print(azure.ai.ml._version.VERSION)</span></pre><ul class=""><li id="5573" class="jc jd hh je b jf km jh kn jj ko jl kp jn kq jp jq jr js jt bi translated">如果没有安装，请安装mlflow</li></ul><pre class="kb kc kd ke fd ks kt ku kv aw kw bi"><span id="c046" class="kx if hh kt b fi ky kz l la lb">pip install azureml-mlflow</span><span id="9cf4" class="kx if hh kt b fi lc kz l la lb">pip install mlflow</span></pre><h1 id="b20b" class="ie if hh bd ig ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb bi translated">密码</h1><h1 id="c99d" class="ie if hh bd ig ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb bi translated">连接现有工作空间的代码</h1><pre class="kb kc kd ke fd ks kt ku kv aw kw bi"><span id="fb5e" class="kx if hh kt b fi ky kz l la lb"># Import required libraries<br/>from azure.identity import DefaultAzureCredential<br/>from azure.ai.ml import MLClient</span><span id="a49a" class="kx if hh kt b fi lc kz l la lb">from azure.ai.ml.constants import AssetTypes<br/>from azure.ai.ml import Input<br/>from azure.ai.ml.automl import ImageObjectDetectionSearchSpace<br/>from azure.ai.ml.sweep import (<br/>    Choice,<br/>    Uniform,<br/>    BanditPolicy,<br/>)</span><span id="b22b" class="kx if hh kt b fi lc kz l la lb">from azure.ai.ml import automl</span></pre><ul class=""><li id="e196" class="jc jd hh je b jf km jh kn jj ko jl kp jn kq jp jq jr js jt bi translated">现在让我们加载现有的工作空间</li></ul><pre class="kb kc kd ke fd ks kt ku kv aw kw bi"><span id="6016" class="kx if hh kt b fi ky kz l la lb">from azure.identity import DefaultAzureCredential<br/>from azure.ai.ml import MLClient</span><span id="2193" class="kx if hh kt b fi lc kz l la lb">credential = DefaultAzureCredential()<br/>ml_client = None<br/>try:<br/>    ml_client = MLClient.from_config(credential)<br/>except Exception as ex:<br/>    print(ex)<br/>    # Enter details of your AzureML workspace<br/>    subscription_id = "subid"<br/>    resource_group = "rgname"<br/>    workspace = "workspacename"<br/>    ml_client = MLClient(credential, subscription_id, resource_group, workspace)</span></pre><ul class=""><li id="c1d4" class="jc jd hh je b jf km jh kn jj ko jl kp jn kq jp jq jr js jt bi translated">让我们下载图像数据</li></ul><pre class="kb kc kd ke fd ks kt ku kv aw kw bi"><span id="1faa" class="kx if hh kt b fi ky kz l la lb">import os<br/>import urllib<br/>from zipfile import ZipFile</span><span id="7653" class="kx if hh kt b fi lc kz l la lb"># download data<br/>download_url = "https://cvbp-secondary.z19.web.core.windows.net/datasets/object_detection/odFridgeObjects.zip"<br/>data_file = "./data/odFridgeObjects.zip"<br/>urllib.request.urlretrieve(download_url, filename=data_file)</span><span id="82e9" class="kx if hh kt b fi lc kz l la lb"># extract files<br/>with ZipFile(data_file, "r") as zip:<br/>    print("extracting files...")<br/>    zip.extractall(path="./data")<br/>    print("done")<br/># delete zip file<br/>os.remove(data_file)</span></pre><ul class=""><li id="d7fd" class="jc jd hh je b jf km jh kn jj ko jl kp jn kq jp jq jr js jt bi translated">显示样本图像</li></ul><pre class="kb kc kd ke fd ks kt ku kv aw kw bi"><span id="21c9" class="kx if hh kt b fi ky kz l la lb">from IPython.display import Image</span><span id="4be2" class="kx if hh kt b fi lc kz l la lb">sample_image = "./data/odFridgeObjects/images/31.jpg"<br/>Image(filename=sample_image)</span></pre><ul class=""><li id="bd66" class="jc jd hh je b jf km jh kn jj ko jl kp jn kq jp jq jr js jt bi translated">将图像上传到适当的文件夹</li></ul><pre class="kb kc kd ke fd ks kt ku kv aw kw bi"><span id="1ecb" class="kx if hh kt b fi ky kz l la lb"># Uploading image files by creating a 'data asset URI FOLDER':</span><span id="fabb" class="kx if hh kt b fi lc kz l la lb">from azure.ai.ml.entities import Data<br/>from azure.ai.ml.constants import AssetTypes</span><span id="5599" class="kx if hh kt b fi lc kz l la lb">my_data = Data(<br/>    path="./data/odFridgeObjects",<br/>    type=AssetTypes.URI_FOLDER,<br/>    description="Fridge-items images Object detection",<br/>    name="fridge-items-images-object-detection",<br/>)</span><span id="5a87" class="kx if hh kt b fi lc kz l la lb">uri_folder_data_asset = ml_client.data.create_or_update(my_data)</span><span id="b248" class="kx if hh kt b fi lc kz l la lb">print(uri_folder_data_asset)<br/>print("")<br/>print("Path to folder in Blob Storage:")<br/>print(uri_folder_data_asset.path)</span></pre><ul class=""><li id="c7a6" class="jc jd hh je b jf km jh kn jj ko jl kp jn kq jp jq jr js jt bi translated">现在让我们为训练创建jsonl文件</li></ul><pre class="kb kc kd ke fd ks kt ku kv aw kw bi"><span id="c8c2" class="kx if hh kt b fi ky kz l la lb">import json<br/>import os<br/>import xml.etree.ElementTree as ET</span><span id="d655" class="kx if hh kt b fi lc kz l la lb">src_images = "./data/odFridgeObjects/"</span><span id="6ab6" class="kx if hh kt b fi lc kz l la lb"># We'll copy each JSONL file within its related MLTable folder<br/>training_mltable_path = "./data/training-mltable-folder/"<br/>validation_mltable_path = "./data/validation-mltable-folder/"</span><span id="ef6b" class="kx if hh kt b fi lc kz l la lb">train_validation_ratio = 5</span><span id="543f" class="kx if hh kt b fi lc kz l la lb"># Path to the training and validation files<br/>train_annotations_file = os.path.join(training_mltable_path, "train_annotations.jsonl")<br/>validation_annotations_file = os.path.join(<br/>    validation_mltable_path, "validation_annotations.jsonl"<br/>)</span><span id="77a1" class="kx if hh kt b fi lc kz l la lb"># Baseline of json line dictionary<br/>json_line_sample = {<br/>    "image_url": uri_folder_data_asset.path,<br/>    "image_details": {"format": None, "width": None, "height": None},<br/>    "label": [],<br/>}</span><span id="4dd6" class="kx if hh kt b fi lc kz l la lb"># Path to the annotations<br/>annotations_folder = os.path.join(src_images, "annotations")</span><span id="a4c2" class="kx if hh kt b fi lc kz l la lb"># Read each annotation and convert it to jsonl line<br/>with open(train_annotations_file, "w") as train_f:<br/>    with open(validation_annotations_file, "w") as validation_f:<br/>        for i, filename in enumerate(os.listdir(annotations_folder)):<br/>            if filename.endswith(".xml"):<br/>                print("Parsing " + os.path.join(src_images, filename))</span><span id="ab98" class="kx if hh kt b fi lc kz l la lb">                root = ET.parse(os.path.join(annotations_folder, filename)).getroot()</span><span id="7e80" class="kx if hh kt b fi lc kz l la lb">                width = int(root.find("size/width").text)<br/>                height = int(root.find("size/height").text)</span><span id="37bf" class="kx if hh kt b fi lc kz l la lb">                labels = []<br/>                for object in root.findall("object"):<br/>                    name = object.find("name").text<br/>                    xmin = object.find("bndbox/xmin").text<br/>                    ymin = object.find("bndbox/ymin").text<br/>                    xmax = object.find("bndbox/xmax").text<br/>                    ymax = object.find("bndbox/ymax").text<br/>                    isCrowd = int(object.find("difficult").text)<br/>                    labels.append(<br/>                        {<br/>                            "label": name,<br/>                            "topX": float(xmin) / width,<br/>                            "topY": float(ymin) / height,<br/>                            "bottomX": float(xmax) / width,<br/>                            "bottomY": float(ymax) / height,<br/>                            "isCrowd": isCrowd,<br/>                        }<br/>                    )<br/>                # build the jsonl file<br/>                image_filename = root.find("filename").text<br/>                _, file_extension = os.path.splitext(image_filename)<br/>                json_line = dict(json_line_sample)<br/>                json_line["image_url"] = (<br/>                    json_line["image_url"] + "images/" + image_filename<br/>                )<br/>                json_line["image_details"]["format"] = file_extension[1:]<br/>                json_line["image_details"]["width"] = width<br/>                json_line["image_details"]["height"] = height<br/>                json_line["label"] = labels</span><span id="21d6" class="kx if hh kt b fi lc kz l la lb">                if i % train_validation_ratio == 0:<br/>                    # validation annotation<br/>                    validation_f.write(json.dumps(json_line) + "\n")<br/>                else:<br/>                    # train annotation<br/>                    train_f.write(json.dumps(json_line) + "\n")<br/>            else:<br/>                print("Skipping unknown file: {}".format(filename))</span></pre><ul class=""><li id="c3c2" class="jc jd hh je b jf km jh kn jj ko jl kp jn kq jp jq jr js jt bi translated">配置培训和验证文件夹</li></ul><pre class="kb kc kd ke fd ks kt ku kv aw kw bi"><span id="a723" class="kx if hh kt b fi ky kz l la lb"># Training MLTable defined locally, with local data to be uploaded<br/>my_training_data_input = Input(type=AssetTypes.MLTABLE, path=training_mltable_path)</span><span id="fdff" class="kx if hh kt b fi lc kz l la lb"># Validation MLTable defined locally, with local data to be uploaded<br/>my_validation_data_input = Input(type=AssetTypes.MLTABLE, path=validation_mltable_path)</span><span id="8285" class="kx if hh kt b fi lc kz l la lb"># WITH REMOTE PATH: If available already in the cloud/workspace-blob-store<br/># my_training_data_input = Input(type=AssetTypes.MLTABLE, path="azureml://datastores/workspaceblobstore/paths/vision-classification/train")<br/># my_validation_data_input = Input(type=AssetTypes.MLTABLE, path="azureml://datastores/workspaceblobstore/paths/vision-classification/valid")</span></pre><ul class=""><li id="8dd8" class="jc jd hh je b jf km jh kn jj ko jl kp jn kq jp jq jr js jt bi translated">现在设置实验名称</li></ul><pre class="kb kc kd ke fd ks kt ku kv aw kw bi"><span id="8dea" class="kx if hh kt b fi ky kz l la lb"># general job parameters<br/>compute_name = "gpu-cluster"<br/>exp_name = "automlv2-image-object-detection-experiment"</span></pre><ul class=""><li id="0e07" class="jc jd hh je b jf km jh kn jj ko jl kp jn kq jp jq jr js jt bi translated">创建自动配置</li></ul><pre class="kb kc kd ke fd ks kt ku kv aw kw bi"><span id="8c85" class="kx if hh kt b fi ky kz l la lb"># Create the AutoML job with the related factory-function.</span><span id="7d9b" class="kx if hh kt b fi lc kz l la lb">image_object_detection_job = automl.image_object_detection(<br/>    compute=compute_name,<br/>    experiment_name=exp_name,<br/>    training_data=my_training_data_input,<br/>    validation_data=my_validation_data_input,<br/>    target_column_name="label",<br/>    primary_metric="mean_average_precision",<br/>    tags={"my_custom_tag": "My custom value"},<br/>)</span></pre><ul class=""><li id="01a9" class="jc jd hh je b jf km jh kn jj ko jl kp jn kq jp jq jr js jt bi translated">设定限制</li></ul><pre class="kb kc kd ke fd ks kt ku kv aw kw bi"><span id="2558" class="kx if hh kt b fi ky kz l la lb"># Set limits<br/>image_object_detection_job.set_limits(timeout_minutes=60)</span></pre><ul class=""><li id="2627" class="jc jd hh je b jf km jh kn jj ko jl kp jn kq jp jq jr js jt bi translated">现在参数</li></ul><pre class="kb kc kd ke fd ks kt ku kv aw kw bi"><span id="eaab" class="kx if hh kt b fi ky kz l la lb"># Pass the fixed settings or parameters<br/>image_object_detection_job.set_image_model(early_stopping=True, evaluation_frequency=1)</span></pre><ul class=""><li id="141d" class="jc jd hh je b jf km jh kn jj ko jl kp jn kq jp jq jr js jt bi translated">配置参数扫描设置</li></ul><pre class="kb kc kd ke fd ks kt ku kv aw kw bi"><span id="1aeb" class="kx if hh kt b fi ky kz l la lb"># Configure sweep settings<br/>image_object_detection_job.set_sweep(<br/>    max_trials=10,<br/>    max_concurrent_trials=2,<br/>    sampling_algorithm="random",<br/>    early_termination=BanditPolicy(<br/>        evaluation_interval=2, slack_factor=0.2, delay_evaluation=6<br/>    ),<br/>)</span></pre><ul class=""><li id="a192" class="jc jd hh je b jf km jh kn jj ko jl kp jn kq jp jq jr js jt bi translated">现在定义搜索空间</li></ul><pre class="kb kc kd ke fd ks kt ku kv aw kw bi"><span id="1a26" class="kx if hh kt b fi ky kz l la lb"># Define search space<br/>image_object_detection_job.extend_search_space(<br/>    [<br/>        ImageObjectDetectionSearchSpace(<br/>            model_name=Choice(["yolov5"]),<br/>            learning_rate=Uniform(0.0001, 0.01),<br/>            model_size=Choice(["small", "medium"]),  # model-specific<br/>            # image_size=Choice(640, 704, 768),  # model-specific; might need GPU with large memory<br/>        ),<br/>        ImageObjectDetectionSearchSpace(<br/>            model_name=Choice(["fasterrcnn_resnet50_fpn"]),<br/>            learning_rate=Uniform(0.0001, 0.001),<br/>            optimizer=Choice(["sgd", "adam", "adamw"]),<br/>            min_size=Choice([600, 800]),  # model-specific<br/>            # warmup_cosine_lr_warmup_epochs=Choice([0, 3]),<br/>        ),<br/>    ]<br/>)</span></pre><ul class=""><li id="ea56" class="jc jd hh je b jf km jh kn jj ko jl kp jn kq jp jq jr js jt bi translated">现在是创建实验并提交的时候了</li></ul><pre class="kb kc kd ke fd ks kt ku kv aw kw bi"><span id="3ba0" class="kx if hh kt b fi ky kz l la lb"># Submit the AutoML job<br/>returned_job = ml_client.jobs.create_or_update(<br/>    image_object_detection_job<br/>)  # submit the job to the backend</span><span id="6204" class="kx if hh kt b fi lc kz l la lb">print(f"Created job: {returned_job}")</span></pre><ul class=""><li id="7db2" class="jc jd hh je b jf km jh kn jj ko jl kp jn kq jp jq jr js jt bi translated">进行实验</li></ul><pre class="kb kc kd ke fd ks kt ku kv aw kw bi"><span id="7a72" class="kx if hh kt b fi ky kz l la lb">ml_client.jobs.stream(returned_job.name)</span></pre><ul class=""><li id="0022" class="jc jd hh je b jf km jh kn jj ko jl kp jn kq jp jq jr js jt bi translated">等待作业完成</li></ul><figure class="kb kc kd ke fd kf er es paragraph-image"><div role="button" tabindex="0" class="kg kh di ki bf kj"><div class="er es ld"><img src="../Images/d1ab39173f55986c02acea8fc5760d90.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*ZjsCX8NZr11JGQoA.jpg"/></div></div></figure><figure class="kb kc kd ke fd kf er es paragraph-image"><div role="button" tabindex="0" class="kg kh di ki bf kj"><div class="er es le"><img src="../Images/6c4d8cdcbf372db6c64a87de028886ba.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*61RZYGiJF7wSgreu.jpg"/></div></div></figure><ul class=""><li id="1a31" class="jc jd hh je b jf km jh kn jj ko jl kp jn kq jp jq jr js jt bi translated">现在让我们使用mlflow来跟踪作业</li></ul><pre class="kb kc kd ke fd ks kt ku kv aw kw bi"><span id="e34e" class="kx if hh kt b fi ky kz l la lb">import mlflow</span><span id="48c3" class="kx if hh kt b fi lc kz l la lb"># Obtain the tracking URL from MLClient<br/>MLFLOW_TRACKING_URI = ml_client.workspaces.get(<br/>    name=ml_client.workspace_name<br/>).mlflow_tracking_uri</span><span id="bf5d" class="kx if hh kt b fi lc kz l la lb">print(MLFLOW_TRACKING_URI)</span></pre><ul class=""><li id="8007" class="jc jd hh je b jf km jh kn jj ko jl kp jn kq jp jq jr js jt bi translated">设置跟踪URI</li></ul><pre class="kb kc kd ke fd ks kt ku kv aw kw bi"><span id="9d8c" class="kx if hh kt b fi ky kz l la lb"># Set the MLFLOW TRACKING URI</span><span id="e376" class="kx if hh kt b fi lc kz l la lb">mlflow.set_tracking_uri(MLFLOW_TRACKING_URI)</span><span id="10dd" class="kx if hh kt b fi lc kz l la lb">print("\nCurrent tracking uri: {}".format(mlflow.get_tracking_uri()))</span></pre><ul class=""><li id="1f6e" class="jc jd hh je b jf km jh kn jj ko jl kp jn kq jp jq jr js jt bi translated">启用mlflow客户端</li></ul><pre class="kb kc kd ke fd ks kt ku kv aw kw bi"><span id="b92b" class="kx if hh kt b fi ky kz l la lb">from mlflow.tracking.client import MlflowClient</span><span id="f650" class="kx if hh kt b fi lc kz l la lb"># Initialize MLFlow client<br/>mlflow_client = MlflowClient()</span></pre><ul class=""><li id="89be" class="jc jd hh je b jf km jh kn jj ko jl kp jn kq jp jq jr js jt bi translated">获取作业详细信息</li></ul><pre class="kb kc kd ke fd ks kt ku kv aw kw bi"><span id="5bf2" class="kx if hh kt b fi ky kz l la lb">job_name = returned_job.name</span><span id="1aa3" class="kx if hh kt b fi lc kz l la lb"># Example if providing an specific Job name/ID<br/># job_name = "salmon_camel_5sdf05xvb3"</span><span id="6734" class="kx if hh kt b fi lc kz l la lb"># Get the parent run<br/>mlflow_parent_run = mlflow_client.get_run(job_name)</span><span id="d026" class="kx if hh kt b fi lc kz l la lb">print("Parent Run: ")<br/>print(mlflow_parent_run)</span></pre><ul class=""><li id="6ebc" class="jc jd hh je b jf km jh kn jj ko jl kp jn kq jp jq jr js jt bi translated">打印工作标签</li></ul><pre class="kb kc kd ke fd ks kt ku kv aw kw bi"><span id="dc09" class="kx if hh kt b fi ky kz l la lb"># Print parent run tags. 'automl_best_child_run_id' tag should be there.<br/>print(mlflow_parent_run.data.tags)</span></pre><ul class=""><li id="3026" class="jc jd hh je b jf km jh kn jj ko jl kp jn kq jp jq jr js jt bi translated">现在让孩子跑得最好</li></ul><pre class="kb kc kd ke fd ks kt ku kv aw kw bi"><span id="2ace" class="kx if hh kt b fi ky kz l la lb"># Get the best model's child run</span><span id="cd9e" class="kx if hh kt b fi lc kz l la lb">best_child_run_id = mlflow_parent_run.data.tags["automl_best_child_run_id"]<br/>print("Found best child run id: ", best_child_run_id)</span><span id="2d61" class="kx if hh kt b fi lc kz l la lb">best_run = mlflow_client.get_run(best_child_run_id)</span><span id="413d" class="kx if hh kt b fi lc kz l la lb">print("Best child run: ")<br/>print(best_run)</span></pre><ul class=""><li id="1143" class="jc jd hh je b jf km jh kn jj ko jl kp jn kq jp jq jr js jt bi translated">打印指标</li></ul><pre class="kb kc kd ke fd ks kt ku kv aw kw bi"><span id="c12f" class="kx if hh kt b fi ky kz l la lb">import pandas as pd</span><span id="4755" class="kx if hh kt b fi lc kz l la lb">pd.DataFrame(best_run.data.metrics, index=[0]).T</span></pre><ul class=""><li id="f843" class="jc jd hh je b jf km jh kn jj ko jl kp jn kq jp jq jr js jt bi translated">现在让我们下载工件，模型文件来注册</li></ul><pre class="kb kc kd ke fd ks kt ku kv aw kw bi"><span id="468a" class="kx if hh kt b fi ky kz l la lb"># Create local folder<br/>local_dir = "./artifact_downloads"<br/>if not os.path.exists(local_dir):<br/>    os.mkdir(local_dir)</span><span id="dec3" class="kx if hh kt b fi lc kz l la lb"># Download run's artifacts/outputs<br/>local_path = mlflow_client.download_artifacts(<br/>    best_run.info.run_id, "outputs", local_dir<br/>)<br/>print("Artifacts downloaded in: {}".format(local_path))<br/>print("Artifacts: {}".format(os.listdir(local_path)))</span></pre><ul class=""><li id="0e58" class="jc jd hh je b jf km jh kn jj ko jl kp jn kq jp jq jr js jt bi translated">现在设置模型文件夹</li></ul><pre class="kb kc kd ke fd ks kt ku kv aw kw bi"><span id="cf65" class="kx if hh kt b fi ky kz l la lb">import os</span><span id="9b69" class="kx if hh kt b fi lc kz l la lb"># Show the contents of the MLFlow model folder<br/>os.listdir("./artifact_downloads/outputs/mlflow-model")</span></pre><ul class=""><li id="997e" class="jc jd hh je b jf km jh kn jj ko jl kp jn kq jp jq jr js jt bi translated">必需的库</li></ul><pre class="kb kc kd ke fd ks kt ku kv aw kw bi"><span id="16c8" class="kx if hh kt b fi ky kz l la lb"># import required libraries<br/>from azure.ai.ml.entities import (<br/>    ManagedOnlineEndpoint,<br/>    ManagedOnlineDeployment,<br/>    Model,<br/>    Environment,<br/>    CodeConfiguration,<br/>)</span></pre><ul class=""><li id="66dc" class="jc jd hh je b jf km jh kn jj ko jl kp jn kq jp jq jr js jt bi translated">现在让我们创建一个受管理的在线端点</li></ul><pre class="kb kc kd ke fd ks kt ku kv aw kw bi"><span id="01df" class="kx if hh kt b fi ky kz l la lb"># Creating a unique endpoint name with current datetime to avoid conflicts<br/>import datetime</span><span id="fa9c" class="kx if hh kt b fi lc kz l la lb">online_endpoint_name = "od-fridge-items-" + datetime.datetime.now().strftime(<br/>    "%m%d%H%M%f"<br/>)</span><span id="7cad" class="kx if hh kt b fi lc kz l la lb"># create an online endpoint<br/>endpoint = ManagedOnlineEndpoint(<br/>    name=online_endpoint_name,<br/>    description="this is a sample online endpoint for deploying model",<br/>    auth_mode="key",<br/>    tags={"foo": "bar"},<br/>)</span><span id="05b3" class="kx if hh kt b fi lc kz l la lb">ml_client.begin_create_or_update(endpoint)</span></pre><ul class=""><li id="e935" class="jc jd hh je b jf km jh kn jj ko jl kp jn kq jp jq jr js jt bi translated">注册模型</li></ul><pre class="kb kc kd ke fd ks kt ku kv aw kw bi"><span id="7c67" class="kx if hh kt b fi ky kz l la lb">model_name = "od-fridge-items-model"<br/>model = Model(<br/>    path=f"azureml://jobs/{best_run.info.run_id}/outputs/artifacts/outputs/model.pt",<br/>    name=model_name,<br/>    description="my sample object detection model",<br/>)</span><span id="d170" class="kx if hh kt b fi lc kz l la lb"># for downloaded file<br/># model = Model(path="artifact_downloads/outputs/model.pt", name=model_name)</span><span id="801a" class="kx if hh kt b fi lc kz l la lb">registered_model = ml_client.models.create_or_update(model)</span><span id="235f" class="kx if hh kt b fi lc kz l la lb">registered_model.id</span></pre><ul class=""><li id="d050" class="jc jd hh je b jf km jh kn jj ko jl kp jn kq jp jq jr js jt bi translated">设置环境</li></ul><pre class="kb kc kd ke fd ks kt ku kv aw kw bi"><span id="b1ab" class="kx if hh kt b fi ky kz l la lb">env = Environment(<br/>    name="automl-images-env",<br/>    description="environment for automl images inference",<br/>    image="mcr.microsoft.com/azureml/openmpi4.1.0-cuda11.1-cudnn8-ubuntu18.04",<br/>    conda_file="artifact_downloads/outputs/conda_env_v_1_0_0.yml",<br/>)</span></pre><ul class=""><li id="0c3b" class="jc jd hh je b jf km jh kn jj ko jl kp jn kq jp jq jr js jt bi translated">评分文件</li></ul><pre class="kb kc kd ke fd ks kt ku kv aw kw bi"><span id="e1e8" class="kx if hh kt b fi ky kz l la lb">code_configuration = CodeConfiguration(<br/>    code="artifact_downloads/outputs/", scoring_script="scoring_file_v_1_0_0.py"<br/>)</span></pre><ul class=""><li id="b7cc" class="jc jd hh je b jf km jh kn jj ko jl kp jn kq jp jq jr js jt bi translated">部署配置</li></ul><pre class="kb kc kd ke fd ks kt ku kv aw kw bi"><span id="4014" class="kx if hh kt b fi ky kz l la lb">deployment = ManagedOnlineDeployment(<br/>    name="od-fridge-items-deploy",<br/>    endpoint_name=online_endpoint_name,<br/>    model=registered_model.id,<br/>    environment=env,<br/>    code_configuration=code_configuration,<br/>    instance_type="Standard_DS3_V2",<br/>    instance_count=1,<br/>)</span></pre><ul class=""><li id="49cb" class="jc jd hh je b jf km jh kn jj ko jl kp jn kq jp jq jr js jt bi translated">部署受管理端点</li></ul><pre class="kb kc kd ke fd ks kt ku kv aw kw bi"><span id="09b1" class="kx if hh kt b fi ky kz l la lb">ml_client.online_deployments.begin_create_or_update(deployment)</span></pre><ul class=""><li id="135e" class="jc jd hh je b jf km jh kn jj ko jl kp jn kq jp jq jr js jt bi translated">等待端点创建</li></ul><figure class="kb kc kd ke fd kf er es paragraph-image"><div role="button" tabindex="0" class="kg kh di ki bf kj"><div class="er es lf"><img src="../Images/e7b05d7bf032c4a9927532ec867f3edd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*p0xpxmWVOAWU5UkZ.jpg"/></div></div></figure><ul class=""><li id="1c37" class="jc jd hh je b jf km jh kn jj ko jl kp jn kq jp jq jr js jt bi translated">现在更新流量到100%</li></ul><pre class="kb kc kd ke fd ks kt ku kv aw kw bi"><span id="79c6" class="kx if hh kt b fi ky kz l la lb"># od fridge items deployment to take 100% traffic<br/>endpoint.traffic = {"od-fridge-items-deploy": 100}<br/>ml_client.begin_create_or_update(endpoint)</span></pre><ul class=""><li id="0c30" class="jc jd hh je b jf km jh kn jj ko jl kp jn kq jp jq jr js jt bi translated">现在让新的REST APi来评分</li></ul><pre class="kb kc kd ke fd ks kt ku kv aw kw bi"><span id="dba7" class="kx if hh kt b fi ky kz l la lb"># Get the details for online endpoint<br/>endpoint = ml_client.online_endpoints.get(name=online_endpoint_name)</span><span id="3eb4" class="kx if hh kt b fi lc kz l la lb"># existing traffic details<br/>print(endpoint.traffic)</span><span id="22ef" class="kx if hh kt b fi lc kz l la lb"># Get the scoring URI<br/>print(endpoint.scoring_uri)</span></pre><ul class=""><li id="c870" class="jc jd hh je b jf km jh kn jj ko jl kp jn kq jp jq jr js jt bi translated">现在加载一个验证图像并用上面的REST API评分</li></ul><pre class="kb kc kd ke fd ks kt ku kv aw kw bi"><span id="0258" class="kx if hh kt b fi ky kz l la lb">import requests</span><span id="63cd" class="kx if hh kt b fi lc kz l la lb"># URL for the endpoint<br/>scoring_uri = endpoint.scoring_uri</span><span id="de83" class="kx if hh kt b fi lc kz l la lb"># If the endpoint is authenticated, set the key or token<br/>key = ml_client.online_endpoints.list_keys(name=online_endpoint_name).primary_key</span><span id="38a2" class="kx if hh kt b fi lc kz l la lb">sample_image = "./data/odFridgeObjects/images/1.jpg"</span><span id="5f90" class="kx if hh kt b fi lc kz l la lb"># Load image data<br/>data = open(sample_image, "rb").read()</span><span id="3fbf" class="kx if hh kt b fi lc kz l la lb"># Set the content type<br/>headers = {"Content-Type": "application/octet-stream"}</span><span id="73eb" class="kx if hh kt b fi lc kz l la lb"># If authentication is enabled, set the authorization header<br/>headers["Authorization"] = f"Bearer {key}"</span><span id="2120" class="kx if hh kt b fi lc kz l la lb"># Make the request and display the response<br/>resp = requests.post(scoring_uri, data, headers=headers)<br/>print(resp.text)</span></pre><ul class=""><li id="3a8b" class="jc jd hh je b jf km jh kn jj ko jl kp jn kq jp jq jr js jt bi translated">最后删除端点</li></ul><pre class="kb kc kd ke fd ks kt ku kv aw kw bi"><span id="9f3c" class="kx if hh kt b fi ky kz l la lb">ml_client.online_endpoints.begin_delete(name=online_endpoint_name)</span></pre><ul class=""><li id="1415" class="jc jd hh je b jf km jh kn jj ko jl kp jn kq jp jq jr js jt bi translated">等待端点删除</li></ul></div><div class="ab cl lg lh go li" role="separator"><span class="lj bw bk lk ll lm"/><span class="lj bw bk lk ll lm"/><span class="lj bw bk lk ll"/></div><div class="ha hb hc hd he"><p id="1434" class="pw-post-body-paragraph ln lo hh je b jf km lp lq jh kn lr ls jj lt lu lv jl lw lx ly jn lz ma mb jp ha bi translated"><em class="mc">最初发表于</em><a class="ae jz" href="https://github.com/balakreshnan/Samples2022/blob/main/AzureMLV2/visionsdkv2.md" rel="noopener ugc nofollow" target="_blank">T5【https://github.com】</a><em class="mc">。</em></p><div class="md me ez fb mf mg"><a rel="noopener follow" target="_blank" href="/mlearning-ai/mlearning-ai-submission-suggestions-b51e2b130bfb"><div class="mh ab dw"><div class="mi ab mj cl cj mk"><h2 class="bd hi fi z dy ml ea eb mm ed ef hg bi translated">Mlearning.ai提交建议</h2><div class="mn l"><h3 class="bd b fi z dy ml ea eb mm ed ef dx translated">如何成为Mlearning.ai上的作家</h3></div><div class="mo l"><p class="bd b fp z dy ml ea eb mm ed ef dx translated">medium.com</p></div></div><div class="mp l"><div class="mq l mr ms mt mp mu kk mg"/></div></div></a></div></div></div>    
</body>
</html>