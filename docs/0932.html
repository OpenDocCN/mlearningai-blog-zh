<html>
<head>
<title>Quantization — The way of using ML model in Edge Devices.</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">量化——ML模型在边缘设备中的应用。</h1>
<blockquote>原文：<a href="https://medium.com/mlearning-ai/quantization-the-way-of-using-ml-model-in-edge-devices-bdf74e48b4aa?source=collection_archive---------1-----------------------#2021-08-27">https://medium.com/mlearning-ai/quantization-the-way-of-using-ml-model-in-edge-devices-bdf74e48b4aa?source=collection_archive---------1-----------------------#2021-08-27</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><p id="531a" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在数据科学界，有很多关于使用Spark、Hadoop等大数据工具来扩展机器学习模型的讨论。与此同时，在数据科学中还有另一个与他们相反的有趣领域，即创建一个适用于边缘设备的轻量级机器学习模型。</p><p id="3521" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">微控制器、可穿戴设备(fit band、智能手表等)等设备过去的内存非常少，大多以MB为单位。它们通常被称为边缘设备。<strong class="ig hi">量化</strong>是一个减少模型大小的过程，这样就可以在边缘设备上运行。在这篇文章中，我们将看到量化是如何在高层次上工作的，以及相应的python代码。</p><p id="1ee6" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi">量子化:</strong></p><p id="f5ae" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">量化是一个通用术语，它涵盖了将大量输入值转换为较小集合中的输出值的许多不同技术。通常它会用其他类型的参数和输入替换float32，如float16，INT32，INT16，INT8，INT4，INT1等。最常见的选择是INT8。</p><p id="3b44" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">有各种用于量化转换的技术，如比例量化、仿射量化等。网上有这方面的研究论文可供参考。因为我们更关注python实现，所以让我们看看下面的细节。</p><p id="5619" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi">有两种方法来执行量化。</strong></p><ol class=""><li id="18b1" class="jc jd hh ig b ih ii il im ip je it jf ix jg jb jh ji jj jk bi translated"><strong class="ig hi">训练后量化(TF模型→Tf.lite转换→应用量化)</strong></li><li id="4ae6" class="jc jd hh ig b ih jl il jm ip jn it jo ix jp jb jh ji jj jk bi translated"><strong class="ig hi">量化感知训练(TF模型→应用量化模型→再次训练并微调→Tf.lite.convert) </strong></li></ol><p id="9cd7" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">如上所述，两种方法的区别在于何时应用量化技术。如果在最后一个阶段应用量化过程，我们习惯称之为<strong class="ig hi">后训练量化</strong>。如果我们在模型训练后立即应用量化，并再次微调量化模型，则称为<strong class="ig hi">量化感知训练</strong>。</p><p id="4236" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我们采用现有的简单神经网络模型进行分析。各型号详情如下。</p><figure class="jr js jt ju fd jv er es paragraph-image"><div role="button" tabindex="0" class="jw jx di jy bf jz"><div class="er es jq"><img src="../Images/2187b3ea2e84fd9def0a10648d181c25.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*IfdqJhQ3dmMrKn8DcMgpYg.png"/></div></div><figcaption class="kc kd et er es ke kf bd b be z dx">Model Summary</figcaption></figure><figure class="jr js jt ju fd jv er es paragraph-image"><div role="button" tabindex="0" class="jw jx di jy bf jz"><div class="er es kg"><img src="../Images/54f185f00dcc075bfd3746933e67734b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1Ypr47XuhTNZJRVwbOvspg.png"/></div></div><figcaption class="kc kd et er es ke kf bd b be z dx">Model performance before conversion</figcaption></figure><p id="26b2" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi">岗位培训量化:</strong></p><p id="0e5a" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">对于训练后量化，我们首先将模型转换为tf-lite模型。</p><figure class="jr js jt ju fd jv er es paragraph-image"><div role="button" tabindex="0" class="jw jx di jy bf jz"><div class="er es kh"><img src="../Images/780f4b4925b7f2083a1875c1703c45a0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*m0IUAMHleGxT9E88sAqTIg.png"/></div></div><figcaption class="kc kd et er es ke kf bd b be z dx">Converting Model to tflite model</figcaption></figure><p id="2f4c" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">量化技术将应用于tf-lite模型，如下所示。</p><figure class="jr js jt ju fd jv er es paragraph-image"><div role="button" tabindex="0" class="jw jx di jy bf jz"><div class="er es ki"><img src="../Images/cfec13237193d16854f5356eed1ef22c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*AH1zNsTaLJfpxFE941JvfA.png"/></div></div></figure><p id="d785" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi">量化感知训练:</strong></p><p id="f092" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在量化感知训练中，首先将量化方法直接应用于模型。然后，相同的模型将被编译，并用少量的历元进行训练。</p><p id="84af" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">tensorflow_model_optimization是单独的tf lib，我们需要使用PIP命令安装它。下面给出了使用tf lib将神经网络模型转换成量化模型。</p><figure class="jr js jt ju fd jv er es paragraph-image"><div role="button" tabindex="0" class="jw jx di jy bf jz"><div class="er es kj"><img src="../Images/5a90a4f46ea5da4035659b04e300740f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ws6A_4ODX51ksY7jzoPmKg.png"/></div></div></figure><p id="79d2" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">根据上面的截图，模型的性能也没有受到这种转换的太大影响。</p><p id="88bf" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">第二步是将quant模型转换为tf-lite模型，下面给出了相应的python代码细节。</p><figure class="jr js jt ju fd jv er es paragraph-image"><div role="button" tabindex="0" class="jw jx di jy bf jz"><div class="er es kk"><img src="../Images/18faeadb37b7dcf73b20b9fca60c2ab7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*L9s9vh4P-vqjpCq85JzE7Q.png"/></div></div></figure><figure class="jr js jt ju fd jv er es paragraph-image"><div role="button" tabindex="0" class="jw jx di jy bf jz"><div class="er es kl"><img src="../Images/783623736ad7a1c4020f4f5f637e1324.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mpSUbkxDjS6ZVDQeuqRj0w.png"/></div></div></figure><p id="ebfc" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi">观察:</strong></p><p id="bc2e" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">可以使用以下python代码将模型保存到本地机器。</p><figure class="jr js jt ju fd jv er es paragraph-image"><div role="button" tabindex="0" class="jw jx di jy bf jz"><div class="er es km"><img src="../Images/ef98c6176e5c53205384b28d085d7e44.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cMu8uq-0BYnMyNoGN5OPBA.png"/></div></div></figure><p id="75b8" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">下面给出了常规模型、训练后量化方法和量化感知训练方法之间的大小比较。</p><figure class="jr js jt ju fd jv er es paragraph-image"><div role="button" tabindex="0" class="jw jx di jy bf jz"><div class="er es kn"><img src="../Images/798018e487e9465b286fa3e3acb6ce83.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2E1Z2QoJW6JqcDmzSl9nXw.png"/></div></div></figure><p id="3899" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在这两种情况下，模型的大小几乎减少到四分之一。然而，为了良好的准确性，量化感知训练优于训练后量化方法。同时，岗位培训量化也是一个不可忽视的容易实现的途径。</p></div></div>    
</body>
</html>