<html>
<head>
<title>Select Columns and Add New Columns in an ML Pipeline with Code Example</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用代码示例在ML管道中选择列并添加新列</h1>
<blockquote>原文：<a href="https://medium.com/mlearning-ai/select-columns-and-add-new-columns-in-an-ml-pipeline-with-code-example-bd90ccba1891?source=collection_archive---------3-----------------------#2022-12-15">https://medium.com/mlearning-ai/select-columns-and-add-new-columns-in-an-ml-pipeline-with-code-example-bd90ccba1891?source=collection_archive---------3-----------------------#2022-12-15</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><figure class="ev ex if ig ih ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es ie"><img src="../Images/f5af0977e0824c7bd6ac28e3b4d0762f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*zvXSj-Y9Dg-ke9UJ"/></div></div><figcaption class="ip iq et er es ir is bd b be z dx">Photo by <a class="ae it" href="https://unsplash.com/@alessandroerbetta?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Alessandro Erbetta</a> on <a class="ae it" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="d786" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">在这篇文章中，我们将讨论如何创建类来选择特定的列/特性，添加新的列/特性，并使用Python和Sklearn将它们组合在一起以构建一个整洁的管道。在后面的文章中，我将继续管道主题，用代码示例展示如何使用<code class="du js jt ju jv b">ColumnTransformer</code>和<code class="du js jt ju jv b">FeatureUnion</code>。</p><p id="01ab" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">事不宜迟，我们来深究一下。</p></div><div class="ab cl jw jx go jy" role="separator"><span class="jz bw bk ka kb kc"/><span class="jz bw bk ka kb kc"/><span class="jz bw bk ka kb"/></div><div class="ha hb hc hd he"><h1 id="b459" class="kd ke hh bd kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la bi translated"><strong class="ak"> 0。准备数据</strong></h1><p id="2fbd" class="pw-post-body-paragraph iu iv hh iw b ix lb iz ja jb lc jd je jf ld jh ji jj le jl jm jn lf jp jq jr ha bi translated">首先，我们来准备数据。在这里，我将使用我最近的跑步比赛排名预测项目中的一个小数据样本来创建一个小数据集进行说明。这里的<em class="lg"> X_train </em>只有4列/特征，包括参与者的性别、年龄、距离、距离单位。目标变量y_train是导出的比赛持续时间(以分钟为单位)。</p><pre class="lh li lj lk fd ll jv lm bn ln lo bi"><span id="91fb" class="lp ke hh jv b be lq lr l ls lt"># get the X,y<br/>X = train_df.drop('time', axis=1)<br/>y = train_df['time']<br/><br/># Split the data into training and test datasets<br/>X_train, X_test, y_train, y_test = train_test_split(X, y,test_size=0.5,random_state=0)<br/>print(X_train.shape, y_train.shape)<br/>X_train.sample(3)</span></pre><figure class="lh li lj lk fd ii er es paragraph-image"><div class="er es lu"><img src="../Images/405c2f667ce0d3c881c73c8f3ddfa1a8.png" data-original-src="https://miro.medium.com/v2/resize:fit:640/format:webp/1*S3jZKYOEg8SiDulqis_ycQ.png"/></div><figcaption class="ip iq et er es ir is bd b be z dx">raw X_train data frame samples</figcaption></figure></div><div class="ab cl jw jx go jy" role="separator"><span class="jz bw bk ka kb kc"/><span class="jz bw bk ka kb kc"/><span class="jz bw bk ka kb"/></div><div class="ha hb hc hd he"><h1 id="8e13" class="kd ke hh bd kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la bi translated"><strong class="ak"> 1。选择自定义列</strong></h1><p id="7294" class="pw-post-body-paragraph iu iv hh iw b ix lb iz ja jb lc jd je jf ld jh ji jj le jl jm jn lf jp jq jr ha bi translated">准备好数据后，让我们创建一个简单的<code class="du js jt ju jv b">ColumnSelector</code>类，从给定的数据集中定制选择一个列子集。这样做的好处是，一旦我们建立了类，它就可以直接用作管道中的一个步骤。我们将在本文后面看到它。</p><pre class="lh li lj lk fd ll jv lm bn ln lo bi"><span id="94b2" class="lp ke hh jv b be lq lr l ls lt"># first, create a custom column selector to select specific columns <br/>from sklearn.base import BaseEstimator, TransformerMixin<br/><br/>class ColumnSelector(BaseEstimator, TransformerMixin):<br/>    '''select specific columns of a given dataset'''<br/>    def __init__(self, subset):<br/>        self.subset = subset<br/>        <br/>    def fit(self, X, y=None):<br/>        return self<br/>    <br/>    def transform(self, X, y=None):<br/>        return X.loc[:, self.subset]<br/><br/>customized_cols = ['distance','unit']<br/>    <br/>## test the ColumnSelector class<br/>selected_cols = ColumnSelector(customized_cols)<br/>selected_cols.transform(X_train).head()</span></pre><figure class="lh li lj lk fd ii er es paragraph-image"><div class="er es lv"><img src="../Images/5550c741bd0dab9454ad020106226bb9.png" data-original-src="https://miro.medium.com/v2/resize:fit:572/format:webp/1*Caxw-KBOuVdZIWI3SvVTDQ.png"/></div><figcaption class="ip iq et er es ir is bd b be z dx">transformed output samples from ColumnSelector</figcaption></figure><p id="3b59" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">很好，我们已经成功地选择了我们感兴趣的列/特性，并准备好对减少的数据执行其他转换。</p><p id="6103" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">但是等等，如果我们对不同的数据类型需要不同的转换呢？例如，单位列的一键编码和距离列的缩放？一种解决方案是创建两个类来区分数据类型。</p></div><div class="ab cl jw jx go jy" role="separator"><span class="jz bw bk ka kb kc"/><span class="jz bw bk ka kb kc"/><span class="jz bw bk ka kb"/></div><div class="ha hb hc hd he"><h1 id="69b5" class="kd ke hh bd kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la bi translated"><strong class="ak"> 2。选择所有数字和所有分类列</strong></h1><p id="3161" class="pw-post-body-paragraph iu iv hh iw b ix lb iz ja jb lc jd je jf ld jh ji jj le jl jm jn lf jp jq jr ha bi translated">接下来，让我们创建一个<code class="du js jt ju jv b">NumColSelector</code>类来选择所有数字列，并创建另一个类来选择训练数据中的所有分类列。</p><pre class="lh li lj lk fd ll jv lm bn ln lo bi"><span id="65bc" class="lp ke hh jv b be lq lr l ls lt"># second, create a numeric-column selector and a categorical-column selector<br/>class NumColSelector(BaseEstimator, TransformerMixin):<br/>    '''select all numeric columns of a given dataset'''        <br/>    def fit(self, X, y=None):<br/>        return self<br/>    <br/>    def transform(self, X, y=None):<br/>        return X.select_dtypes(include='number')<br/><br/>class CatColSelector(BaseEstimator, TransformerMixin):<br/>    '''select all categorical columns of a given dataset'''        <br/>    def fit(self, X, y=None):<br/>        return self<br/>    <br/>    def transform(self, X, y=None):<br/>        return X.select_dtypes(include='object')<br/>    <br/>    <br/>## test the NumericColSelector class<br/>NumColSelector().transform(X_train).head()<br/># CatColSelector().transform(X_train).head()</span></pre><figure class="lh li lj lk fd ii er es paragraph-image"><div class="er es lw"><img src="../Images/e30f4d90517d98af962815b70aa43ca2.png" data-original-src="https://miro.medium.com/v2/resize:fit:570/format:webp/1*vo8VLRJEeWwphYjtjIwUGA.png"/></div><figcaption class="ip iq et er es ir is bd b be z dx">transformed output samples from NumColSelector</figcaption></figure><figure class="lh li lj lk fd ii er es paragraph-image"><div class="er es lx"><img src="../Images/94154b86eb77b75d46b08b9eee68d5cd.png" data-original-src="https://miro.medium.com/v2/resize:fit:540/format:webp/1*HtZXsjh_1hQHuFICPlc_PQ.png"/></div><figcaption class="ip iq et er es ir is bd b be z dx">transformed output samples from CatColSelector</figcaption></figure><p id="a657" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">很好。我们可以使用这两个类轻松地将分类列和数字列分开，并在以后对它们进行不同的数据转换。</p><p id="e980" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">如果我们想要包含原始训练数据中没有的新列/特征，该怎么办？例如，我们希望创建一个新要素来描述每个距离组的中值年龄，这可能有助于预测目标可变时间。</p></div><div class="ab cl jw jx go jy" role="separator"><span class="jz bw bk ka kb kc"/><span class="jz bw bk ka kb kc"/><span class="jz bw bk ka kb"/></div><div class="ha hb hc hd he"><h1 id="64df" class="kd ke hh bd kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la bi translated"><strong class="ak"> 3。添加新列</strong></h1><p id="fb68" class="pw-post-body-paragraph iu iv hh iw b ix lb iz ja jb lc jd je jf ld jh ji jj le jl jm jn lf jp jq jr ha bi translated">现在，让我们创建另一个类<code class="du js jt ju jv b">AgeMedianByDistGroup</code>来添加这个新的列/特性。</p><pre class="lh li lj lk fd ll jv lm bn ln lo bi"><span id="f057" class="lp ke hh jv b be lq lr l ls lt"># create a class to add a new feature AgeMedianByDistGroup<br/>class AgeMedianByDistGroup(BaseEstimator, TransformerMixin):<br/>    '''get the median age of each distance group''' <br/>    def __init__(self, train):<br/>        self.age_median_by_dist_group = train.groupby('distance').apply(lambda x: x['age'].median())<br/>        self.age_median_by_dist_group.name = 'age_median_by_dist_group'<br/>        <br/>    def fit(self, X=None, y=None):<br/>        return self<br/>    <br/>    def transform(self, X, y=None):<br/>        new_X = pd.merge(X, self.age_median_by_dist_group, <br/>                         left_on = 'distance', right_index=True, how='left')        <br/>        X['age_median_by_dist_group'] = new_X['age_median_by_dist_group']<br/>        return X</span></pre><figure class="lh li lj lk fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es ly"><img src="../Images/ed049cff872c737a16fce3c0ada14c1f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HE0FV1bHYsbAf2wHpkfWhA.png"/></div></div><figcaption class="ip iq et er es ir is bd b be z dx">transformed output samples from AgeMedianByDistGroup</figcaption></figure><p id="079c" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">我们可以看到，跑5公里的年龄中位数是36岁，跑8公里的年龄中位数是30岁。</p></div><div class="ab cl jw jx go jy" role="separator"><span class="jz bw bk ka kb kc"/><span class="jz bw bk ka kb kc"/><span class="jz bw bk ka kb"/></div><div class="ha hb hc hd he"><h1 id="bef7" class="kd ke hh bd kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la bi translated"><strong class="ak"> 4。设置最终管道</strong></h1><p id="478d" class="pw-post-body-paragraph iu iv hh iw b ix lb iz ja jb lc jd je jf ld jh ji jj le jl jm jn lf jp jq jr ha bi translated">最后，让我们通过使用我们之前创建的类将所有的连接在一起来构建一个<code class="du js jt ju jv b"><strong class="iw hi">pipeline</strong></code>。基本上，我们将对训练数据执行以下步骤:</p><ul class=""><li id="adf1" class="lz ma hh iw b ix iy jb jc jf mb jj mc jn md jr me mf mg mh bi translated">步骤1:用<code class="du js jt ju jv b">AgeMedianByDistGroup</code>添加一个新的列/特征</li><li id="44bf" class="lz ma hh iw b ix mi jb mj jf mk jj ml jn mm jr me mf mg mh bi translated">步骤2:用<code class="du js jt ju jv b">NumColSelector</code>选择所有数字列/特征</li><li id="1947" class="lz ma hh iw b ix mi jb mj jf mk jj ml jn mm jr me mf mg mh bi translated">第三步:用<code class="du js jt ju jv b">SimpleImputer</code>将所有nan值固定到中间值</li><li id="77da" class="lz ma hh iw b ix mi jb mj jf mk jj ml jn mm jr me mf mg mh bi translated">第四步:用<code class="du js jt ju jv b">MinMaxScaler</code>将数值归一化到[0，1]范围</li></ul><pre class="lh li lj lk fd ll jv lm bn ln lo bi"><span id="5913" class="lp ke hh jv b be lq lr l ls lt"># build the final pipeline<br/>from sklearn.pipeline import Pipeline<br/>from sklearn.impute import SimpleImputer<br/>from sklearn.preprocessing import MinMaxScaler<br/><br/>pipe = Pipeline([<br/>                ('add_new_col', AgeMedianByDistGroup(X_train)),<br/>                ('get_num_cols', NumColSelector()),<br/>                ('fix_nan', SimpleImputer(missing_values=np.nan, strategy='median')),<br/>                ('scale_data', MinMaxScaler())<br/>])<br/><br/>pipe.fit(X_train)</span></pre><p id="b12d" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">最终的管道看起来很简单，对吗？使用管道的最大优势之一是它自动化了这个过程，并保持我们的代码整洁有序。</p><figure class="lh li lj lk fd ii er es paragraph-image"><div class="er es lu"><img src="../Images/d60ac0d3e3cc853ecda7a8da98463509.png" data-original-src="https://miro.medium.com/v2/resize:fit:640/format:webp/1*OBTZuo3OIygrows187RaDQ.png"/></div><figcaption class="ip iq et er es ir is bd b be z dx">pipeline diagram</figcaption></figure><p id="b60d" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">通过这一系列步骤，测试数据集和维持数据集也可以使用同一管道轻松转换，而无需重复编码。如下所示，最终转换后的训练数据是一个归一化的数据框，在我们选择的列/要素中没有任何NaN值。</p><figure class="lh li lj lk fd ii er es paragraph-image"><div class="er es lu"><img src="../Images/1d4f543e9650119cf785fe8a6aa9a823.png" data-original-src="https://miro.medium.com/v2/resize:fit:640/format:webp/1*Tm2w2k5cDl4oPwE5yrVKYw.png"/></div><figcaption class="ip iq et er es ir is bd b be z dx">transformed X_train data frame &amp; NaN values sum output</figcaption></figure><p id="e48a" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">瞧啊。我们建立了几个变压器，并结合在一个优雅的管道！我们可以将准备好的训练数据用于以后的建模。</p></div><div class="ab cl jw jx go jy" role="separator"><span class="jz bw bk ka kb kc"/><span class="jz bw bk ka kb kc"/><span class="jz bw bk ka kb"/></div><div class="ha hb hc hd he"><p id="1911" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">感谢阅读我的文章！我希望这个演练对您当前或下一个项目有所帮助。我的下一篇文章将讨论如何在管道中使用<code class="du js jt ju jv b"><strong class="iw hi">ColumnTransformer</strong></code>和<code class="du js jt ju jv b"><strong class="iw hi">FeatureUnion</strong></code>进行列转换。</p><p id="ca2c" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">关注我，敬请期待！😺 🍁 ☃️</p><div class="mn mo ez fb mp mq"><a rel="noopener follow" target="_blank" href="/mlearning-ai/mlearning-ai-submission-suggestions-b51e2b130bfb"><div class="mr ab dw"><div class="ms ab mt cl cj mu"><h2 class="bd hi fi z dy mv ea eb mw ed ef hg bi translated">Mlearning.ai提交建议</h2><div class="mx l"><h3 class="bd b fi z dy mv ea eb mw ed ef dx translated">如何成为Mlearning.ai上的作家</h3></div><div class="my l"><p class="bd b fp z dy mv ea eb mw ed ef dx translated">medium.com</p></div></div><div class="mz l"><div class="na l nb nc nd mz ne in mq"/></div></div></a></div></div></div>    
</body>
</html>