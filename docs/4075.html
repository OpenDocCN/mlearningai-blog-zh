<html>
<head>
<title>How To Get the Most Out of Airflow’s Dynamic Task Mapping</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何充分利用Airflow的动态任务映射</h1>
<blockquote>原文：<a href="https://medium.com/mlearning-ai/how-to-get-the-most-out-of-airflows-dynamic-task-mapping-7feb3d766645?source=collection_archive---------7-----------------------#2022-12-05">https://medium.com/mlearning-ai/how-to-get-the-most-out-of-airflows-dynamic-task-mapping-7feb3d766645?source=collection_archive---------7-----------------------#2022-12-05</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><p id="0e1f" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">动态任务映射(DTM)是一个主要特性，它增加了构建Dag的灵活性。然而，它不能提供无限的灵活性，也不能让你摆脱气流模式的束缚。例如，您的任务映射受到XCom支持的数据类型的约束，即Python字典和列表。例如，我还没有找到为<code class="du jc jd je jf b">KubernetesPodOperator</code>动态设置Kubernetes秘密的方法。</p><p id="9c8a" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">Python允许你<a class="ae jg" href="https://docs.python.org/3/library/pickle.html" rel="noopener ugc nofollow" target="_blank"> pickle </a>一个像Kubernetes secret这样的对象，它将这样的对象转换成一个字节流，XCom确实支持pickle数据，但是我还没有找到一种方法将它与DTM结合使用。</p><p id="fd94" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">以下是我们在<a class="ae jg" href="https://www.redactics.com/" rel="noopener ugc nofollow" target="_blank">redic ics</a>与DTM一起工作时收集到的一些有用的提示和观察:</p><h1 id="9d4e" class="jh ji hh bd jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke bi translated">使用全局变量</h1><p id="432f" class="pw-post-body-paragraph ie if hh ig b ih kf ij ik il kg in io ip kh ir is it ki iv iw ix kj iz ja jb ha bi translated">请理解，在任务映射函数内部设置的值是在将值赋给这些映射函数外部的变量之后，在运行时设置的。因此，例如，您不能在任务映射中为全局变量赋值，并期望该值在这些映射函数之外可用:</p><pre class="kk kl km kn fd ko jf kp bn kq kr bi"><span id="0fca" class="ks ji hh jf b be kt ku l kv kw">secrets = []<br/><br/>@task()<br/>def set_vars(**context):<br/>    global secrets<br/>    secrets.append(Secret('volume', "/secretpath/" + context["params"]["secretname"], context["params"]["secretname"]))<br/>    return secrets<br/><br/>@task()<br/>def init_wf(secrets, **context):<br/>    print(secrets)<br/>    return "hello"<br/><br/>init_workflow = init_wf.partial().expand(<br/>    secrets=set_vars()<br/>)<br/><br/>start_job = KubernetesPodOperator(<br/>    task_id="start-job",<br/>    image="postgres:12"<br/>    cmds=["uname"],<br/>    secrets=secrets ### this value is going to be null<br/>    )<br/>init_workflow &gt;&gt; start_job</span></pre><p id="0408" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">KubernetesPodOperator中的<code class="du jc jd je jf b">secrets</code>值将为空，因为在初始化<code class="du jc jd je jf b">start_job</code>时，<code class="du jc jd je jf b">set_vars</code>还没有运行。</p><h1 id="2f45" class="jh ji hh bd jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke bi translated">您可以复制Dag，使其在不同的环境中运行，例如不同的计划</h1><p id="735d" class="pw-post-body-paragraph ie if hh ig b ih kf ij ik il kg in io ip kh ir is it ki iv iw ix kj iz ja jb ha bi translated">不是最漂亮的模式，但您可以复制您的Dag，例如使用Docker entrypoint脚本:</p><pre class="kk kl km kn fd ko jf kp bn kq kr bi"><span id="909e" class="ks ji hh jf b be kt ku l kv kw">#!/bin/bash<br/><br/>arr=( "workflow1" "workflow2" )<br/><br/>for workflow_id in "${arr[@]}"<br/>do<br/>    cp /tmp/dag-template.py /opt/airflow/dags/${workflow_id}-mydag.py<br/>done</span></pre><p id="4e3b" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">然后，您的DAG可以从API、环境变量、文件或任何对您的DAG提供这些变化最有意义的东西中提取配置。这似乎是显而易见的，当然也不好看，但我们必须咬紧牙关，因为我们需要某些参数(如时间表)可用，而这不是DTM的地盘。</p><p id="f5cd" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">如果您选择通过API检索一些值，这将允许更多的DAG是动态的，因此当您想要更改值时，它不需要更新。我们选择在文件名中使用那个<code class="du jc jd je jf b">workflow_id</code>来传递给API:</p><pre class="kk kl km kn fd ko jf kp bn kq kr bi"><span id="f768" class="ks ji hh jf b be kt ku l kv kw">dag_file = os.path.basename(__file__).split('.')[0]<br/>dag_id = dag_file.replace('-mydag','')<br/><br/>API_KEY = os.environ['API_KEY']<br/>API_HOST = "https://api.yourthing.com"<br/>headers = {'Content-type': 'application/json', 'Accept': 'text/plain', 'x-api-key': API_KEY}<br/>apiUrl = API_HOST + '/airflowconfigs/' + dag_id<br/>request = requests.get(apiUrl, headers=headers)<br/>wf_config = request.json()</span></pre><p id="576f" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在DAG的顶部附近运行这个程序可以确保<code class="du jc jd je jf b">wf_config</code>作为一个全局变量在整个DAG中可用。您可以控制API被轮询的频率，如果您关心如何扩展，可以用Redis缓存这些配置。</p><h1 id="f92d" class="jh ji hh bd jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke bi translated">访问上下文对象(包括DagRun参数)需要任务流API</h1><p id="3da8" class="pw-post-body-paragraph ie if hh ig b ih kf ij ik il kg in io ip kh ir is it ki iv iw ix kj iz ja jb ha bi translated">例如，如果您正在使用<a class="ae jg" href="https://airflow.apache.org/docs/apache-airflow/stable/stable-rest-api-ref.html" rel="noopener ugc nofollow" target="_blank"> Airflow REST API </a>和<a class="ae jg" href="https://airflow.apache.org/docs/apache-airflow/stable/stable-rest-api-ref.html#operation/post_dag_run" rel="noopener ugc nofollow" target="_blank">向DAGRun端点</a>传递一个conf对象，那么您不能从<code class="du jc jd je jf b">classic</code>样式的操作符(如<code class="du jc jd je jf b">PythonOperator</code>)中访问这些参数。相反，您必须使用专为DTM设计的任务流API。例如:</p><pre class="kk kl km kn fd ko jf kp bn kq kr bi"><span id="e4f1" class="ks ji hh jf b be kt ku l kv kw">@task()<br/>def start_job(**context):<br/>    print(context["params"]["myparam"])</span></pre><div class="kx ky ez fb kz la"><a rel="noopener follow" target="_blank" href="/mlearning-ai/mlearning-ai-submission-suggestions-b51e2b130bfb"><div class="lb ab dw"><div class="lc ab ld cl cj le"><h2 class="bd hi fi z dy lf ea eb lg ed ef hg bi translated">Mlearning.ai提交建议</h2><div class="lh l"><h3 class="bd b fi z dy lf ea eb lg ed ef dx translated">如何成为Mlearning.ai上的作家</h3></div><div class="li l"><p class="bd b fp z dy lf ea eb lg ed ef dx translated">medium.com</p></div></div><div class="lj l"><div class="lk l ll lm ln lj lo lp la"/></div></div></a></div></div></div>    
</body>
</html>