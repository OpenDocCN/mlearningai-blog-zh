<html>
<head>
<title>Understanding the patterns of a demand question (part 2)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">理解需求问题的模式(第二部分)</h1>
<blockquote>原文：<a href="https://medium.com/mlearning-ai/understanding-the-patterns-of-a-demand-question-part-2-9eaaf17d890d?source=collection_archive---------4-----------------------#2022-12-22">https://medium.com/mlearning-ai/understanding-the-patterns-of-a-demand-question-part-2-9eaaf17d890d?source=collection_archive---------4-----------------------#2022-12-22</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><div class=""><h2 id="749d" class="pw-subtitle-paragraph ie hg hh bd b if ig ih ii ij ik il im in io ip iq ir is it iu iv dx translated">应用我不想应用的模型</h2></div><p id="66e6" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">因此，在之前的博客文章中，我已经展示了来自服务中心的数据，突出了一年中收到的电话和电子邮件的数量。我还<a class="ae js" rel="noopener" href="/@marc.jacobs012/understanding-the-patterns-of-a-demand-question-f5b34362249">向</a>展示了这个问题是一个间歇性需求问题。因此，我不会重复使用我已经制作的数据或图形，而是快速切换到我从未想要应用但最终还是应用了的模型。</p><p id="bb0b" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">数据由传统的时间序列数据组成，但随后在一刻钟内。看看那些零。他们让我的生活非常非常艰难。</p><pre class="jt ju jv jw fd jx jy jz bn ka kb bi"><span id="3ed8" class="kc kd hh jy b be ke kf l kg kh">df_tbl&lt;-df%&gt;%<br/>  dplyr::mutate(newdate = with(., ymd(Date) + hms(QuarterHour)))%&gt;%<br/>  #dplyr::mutate(newdate = with(., ymd(Date)))%&gt;%<br/>  group_by(RecordType, newdate)%&gt;%<br/>  filter(!RecordType %in% c("AgentState", "Callback call"))%&gt;%<br/>  filter(CallDirection=="Incoming" &amp; <br/>           DoneInIVR==0 &amp; AgentSequence==1)%&gt;%<br/>  count()%&gt;%<br/>  group_by(RecordType) %&gt;%<br/>  imputeTS::na_kalman(.) %&gt;% <br/>  select(RecordType, newdate, n)%&gt;%<br/>  as_tsibble(key = RecordType, index = newdate) %&gt;%<br/>  fill_gaps(n = 0, .full = end())<br/>&gt; df_tbl<br/># A tsibble: 101,999 x 3 [15m] &lt;UTC&gt;<br/># Key:       RecordType [3]<br/># Groups:    RecordType [3]<br/>   RecordType newdate                 n<br/>   &lt;chr&gt;      &lt;dttm&gt;              &lt;dbl&gt;<br/> 1 Chat call  2022-11-28 09:30:00     8<br/> 2 Chat call  2022-11-28 09:45:00     1<br/> 3 Chat call  2022-11-28 10:00:00     1<br/> 4 Chat call  2022-11-28 10:15:00     0<br/> 5 Chat call  2022-11-28 10:30:00     0<br/> 6 Chat call  2022-11-28 10:45:00     0<br/> 7 Chat call  2022-11-28 11:00:00     0<br/> 8 Chat call  2022-11-28 11:15:00     0<br/> 9 Chat call  2022-11-28 11:30:00     0<br/>10 Chat call  2022-11-28 11:45:00     0<br/># ... with 101,989 more rows</span></pre><p id="7a23" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">这里你可以看到我从未想过要应用的模型，但最终还是应用了:先知模型。关于这个模型已经写了很多，所以我不会重写已经有的。我不想使用它的原因和我不想使用XGboost的原因是一样的——每个人都在这么做。但是后来我更深入地研究了Prophet模型，发现我可以做多少调整。确实有很多调整的可能，并且该模型本质上是一个分解模型。我可以用傅立叶术语来表达。这最终为我处理数据的周期、事件和间歇性质提供了必要的基础。</p><p id="f553" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">像大多数模型一样，您可以通过让它们自动找到可能的最佳解决方案来相当简单地部署它们。</p><pre class="jt ju jv jw fd jx jy jz bn ka kb bi"><span id="1831" class="kc kd hh jy b be ke kf l kg kh">fit_prophet &lt;- df_tbl%&gt;%<br/>  filter(RecordType =="VOIP call")%&gt;%<br/>  select(newdate, n)%&gt;%<br/>  rename(ds=newdate,<br/>         y=n)%&gt;%<br/>  prophet::prophet()<br/>&gt; str(fit_prophet)<br/>List of 32<br/> $ growth                 : chr "linear"<br/> $ changepoints           : POSIXct[1:25], format: "2021-07-24 09:45:00" "2021-08-10 04:15:00" "2021-08-26 22:45:00" "2021-09-12 17:15:00" ...<br/> $ n.changepoints         : num 25<br/> $ changepoint.range      : num 0.8<br/> $ yearly.seasonality     : chr "auto"<br/> $ weekly.seasonality     : chr "auto"<br/> $ daily.seasonality      : chr "auto"<br/> $ holidays               : NULL<br/> $ seasonality.mode       : chr "additive"<br/> $ seasonality.prior.scale: num 10<br/> $ changepoint.prior.scale: num 0.05<br/> $ holidays.prior.scale   : num 10<br/> $ mcmc.samples           : num 0<br/> $ interval.width         : num 0.8<br/> $ uncertainty.samples    : num 1000<br/> $ specified.changepoints : logi FALSE<br/> $ start                  : POSIXct[1:1], format: "2021-07-07 15:15:00"<br/> $ y.scale                : num 32<br/> $ logistic.floor         : logi FALSE<br/> $ t.scale                : num 45279900<br/> $ changepoints.t         : num [1:25] 0.032 0.064 0.096 0.128 0.16 ...<br/> $ seasonalities          :List of 2<br/></span></pre><pre class="ki jx jy jz bn ka kb bi"><span id="5332" class="kc kd hh jy b be ke kf l kg kh">future &lt;- prophet::make_future_dataframe(fit_prophet, periods = 672)<br/>&gt; tail(future)<br/>                       ds<br/>50979 2024-10-10 17:00:00<br/>50980 2024-10-11 17:00:00<br/>50981 2024-10-12 17:00:00<br/>50982 2024-10-13 17:00:00<br/>50983 2024-10-14 17:00:00<br/>50984 2024-10-15 17:00:00<br/><br/>forecast &lt;- predict(fit_prophet, future)<br/>&gt; forecast<br/>                    ds    trend additive_terms additive_terms_lower additive_terms_upper       daily daily_lower<br/>1  2021-07-07 15:15:00 1.333013      4.7732225            4.7732225            4.7732225  3.68798132  3.68798132<br/>2  2021-07-07 15:30:00 1.334092      4.4641217            4.4641217            4.4641217  3.37616930  3.37616930<br/>3  2021-07-07 15:45:00 1.335171      4.0699476            4.0699476            4.0699476  2.97948387  2.97948387<br/>4  2021-07-07 16:00:00 1.336250      3.5940486            3.5940486            3.5940486  2.50127591  2.50127591<br/>5  2021-07-07 16:15:00 1.337329      3.0452312            3.0452312            3.0452312  1.95035390  1.95035390<br/>6  2021-07-07 16:30:00 1.338408      2.4373052            2.4373052            2.4373052  1.34052959  1.34052959<br/>7  2021-07-07 16:45:00 1.339487      1.7882858            1.7882858            1.7882858  0.68981959  0.68981959<br/>8  2021-07-07 17:00:00 1.340566      1.1193054            1.1193054            1.1193054  0.01935782  0.01935782<br/>9  2021-07-07 17:15:00 1.341645      0.4533124            0.4533124            0.4533124 -0.64790649 -0.64790649<br/>10 2021-07-07 17:30:00 1.342724     -0.1863574           -0.1863574           -0.1863574 -1.28863655 -1.28863655<br/>11 2021-07-07 17:45:00 1.343803     -0.7774364           -0.7774364           -0.7774364 -1.88056435 -1.88056435<br/>12 2021-07-07 18:00:00 1.344882     -1.3001123           -1.3001123           -1.3001123 -2.40387714 -2.40387714<br/>13 2021-07-07 18:15:00 1.345961     -1.7382506           -1.7382506           -1.7382506 -2.84244059 -2.84244059<br/>14 2021-07-07 18:30:00 1.347040     -2.0803734           -2.0803734           -2.0803734 -3.18477684 -3.18477684<br/>15 2021-07-07 18:45:00 1.348119     -2.3203270           -2.3203270           -2.3203270 -3.42473282 -3.42473282<br/>16 2021-07-07 19:00:00 1.349198     -2.4575977           -2.4575977           -2.4575977 -3.56179544 -3.56179544<br/>17 2021-07-07 19:15:00 1.350277     -2.4972545           -2.4972545           -2.4972545 -3.60103475 -3.60103475<br/>18 2021-07-07 19:30:00 1.351356     -2.4495272           -2.4495272           -2.4495272 -3.55268160 -3.55268160<br/>19 2021-07-07 19:45:00 1.352436     -2.3290493           -2.3290493           -2.3290493 -3.43137120 -3.43137120<br/>20 2021-07-07 20:00:00 1.353515     -2.1538225           -2.1538225           -2.1538225 -3.25510674 -3.25510674<br/>21 2021-07-07 20:15:00 1.354594     -1.9439726           -1.9439726           -1.9439726 -3.04401598 -3.04401598<br/>22 2021-07-07 20:30:00 1.355673     -1.7203859           -1.7203859           -1.7203859 -2.81898742 -2.81898742<br/>23 2021-07-07 20:45:00 1.356752     -1.5033194           -1.5033194           -1.5033194 -2.60028047 -2.60028047<br/>24 2021-07-07 21:00:00 1.357831     -1.3110805           -1.3110805           -1.3110805 -2.40620508 -2.40620508<br/>25 2021-07-07 21:15:00 1.358910     -1.1588659           -1.1588659           -1.1588659 -2.25196080 -2.25196080<br/>26 2021-07-07 21:30:00 1.359989     -1.0578387           -1.0578387           -1.0578387 -2.14871382 -2.14871382<br/>27 2021-07-07 21:45:00 1.361068     -1.0145046           -1.0145046           -1.0145046 -2.10297311 -2.10297311<br/>28 2021-07-07 22:00:00 1.362147     -1.0304275           -1.0304275           -1.0304275 -2.11630588 -2.11630588<br/>29 2021-07-07 22:15:00 1.363226     -1.1023000           -1.1023000           -1.1023000 -2.18540855 -2.18540855<br/>30 2021-07-07 22:30:00 1.364305     -1.2223612           -1.2223612           -1.2223612 -2.30252414 -2.30252414<br/>31 2021-07-07 22:45:00 1.365384     -1.3791279           -1.3791279           -1.3791279 -2.45617324 -2.45617324<br/>32 2021-07-07 23:00:00 1.366463     -1.5583830           -1.5583830           -1.5583830 -2.63214321 -2.63214321<br/>33 2021-07-07 23:15:00 1.367542     -1.7443506           -1.7443506           -1.7443506 -2.81466253 -2.81466253<br/>34 2021-07-07 23:30:00 1.368621     -1.9209694           -1.9209694           -1.9209694 -2.98767445 -2.98767445<br/>35 2021-07-07 23:45:00 1.369700     -2.0731725           -2.0731725           -2.0731725 -3.13611688 -3.13611688<br/>36 2021-07-08 00:00:00 1.370779     -2.1880808           -2.1880808           -2.1880808 -3.24711549 -3.24711549<br/>37 2021-07-08 00:15:00 1.371858     -2.2560218           -2.2560218           -2.2560218 -3.31100301 -3.31100301<br/>38 2021-07-08 00:30:00 1.372937     -2.2713012           -2.2713012           -2.2713012 -3.32209028 -3.32209028<br/>39 2021-07-08 00:45:00 1.374016     -2.2326683           -2.2326683           -2.2326683 -3.27913189 -3.27913189<br/>40 2021-07-08 01:00:00 1.375095     -2.1434409           -2.1434409           -2.1434409 -3.18545134 -3.18545134<br/>41 2021-07-08 01:15:00 1.376174     -2.0112795           -2.0112795           -2.0112795 -3.04871452 -3.04871452<br/>42 2021-07-08 01:30:00 1.377253     -1.8476225           -1.8476225           -1.8476225 -2.88036564 -2.88036564<br/>43 2021-07-08 01:45:00 1.378332     -1.6668231           -1.6668231           -1.6668231 -2.69476377 -2.69476377<br/>44 2021-07-08 02:00:00 1.379411     -1.4850463           -1.4850463           -1.4850463 -2.50807993 -2.50807993<br/>45 2021-07-08 02:15:00 1.380490     -1.3190045           -1.3190045           -1.3190045 -2.33703236 -2.33703236<br/>46 2021-07-08 02:30:00 1.381570     -1.1846198           -1.1846198           -1.1846198 -2.19754947 -2.19754947<br/>47 2021-07-08 02:45:00 1.382649     -1.0957113           -1.0957113           -1.0957113 -2.10345652 -2.10345652<br/>48 2021-07-08 03:00:00 1.383728     -1.0628003           -1.0628003           -1.0628003 -2.06528115 -2.06528115<br/>49 2021-07-08 03:15:00 1.384807     -1.0921230           -1.0921230           -1.0921230 -2.08926583 -2.08926583<br/>50 2021-07-08 03:30:00 1.385886     -1.1849243           -1.1849243           -1.1849243 -2.17666186 -2.17666186<br/>51 2021-07-08 03:45:00 1.386965     -1.3370892           -1.3370892           -1.3370892 -2.32336081 -2.32336081<br/>52 2021-07-08 04:00:00 1.388044     -1.5391453           -1.5391453           -1.5391453 -2.51989662 -2.51989662<br/></span></pre><pre class="ki jx jy jz bn ka kb bi"><span id="3476" class="kc kd hh jy b be ke kf l kg kh">&gt; str(forecast)<br/>'data.frame': 50984 obs. of  19 variables:<br/> $ ds                        : POSIXct, format: "2021-07-07 15:15:00" "2021-07-07 15:30:00" "2021-07-07 15:45:00" "2021-07-07 16:00:00" ...<br/> $ trend                     : num  1.33 1.33 1.34 1.34 1.34 ...<br/> $ additive_terms            : num  4.77 4.46 4.07 3.59 3.05 ...<br/> $ additive_terms_lower      : num  4.77 4.46 4.07 3.59 3.05 ...<br/> $ additive_terms_upper      : num  4.77 4.46 4.07 3.59 3.05 ...<br/> $ daily                     : num  3.69 3.38 2.98 2.5 1.95 ...<br/> $ daily_lower               : num  3.69 3.38 2.98 2.5 1.95 ...<br/> $ daily_upper               : num  3.69 3.38 2.98 2.5 1.95 ...<br/> $ weekly                    : num  1.09 1.09 1.09 1.09 1.09 ...<br/> $ weekly_lower              : num  1.09 1.09 1.09 1.09 1.09 ...<br/> $ weekly_upper              : num  1.09 1.09 1.09 1.09 1.09 ...<br/> $ multiplicative_terms      : num  0 0 0 0 0 0 0 0 0 0 ...<br/> $ multiplicative_terms_lower: num  0 0 0 0 0 0 0 0 0 0 ...<br/> $ multiplicative_terms_upper: num  0 0 0 0 0 0 0 0 0 0 ...<br/> $ yhat_lower                : num  1.9493 1.7188 1.4521 0.7926 0.0558 ...<br/> $ yhat_upper                : num  10.14 10.24 9.56 8.76 8.35 ...<br/> $ trend_lower               : num  1.33 1.33 1.34 1.34 1.34 ...<br/> $ trend_upper               : num  1.33 1.33 1.34 1.34 1.34 ...<br/> $ yhat                      : num  6.11 5.8 5.41 4.93 4.38 ...</span></pre><pre class="ki jx jy jz bn ka kb bi"><span id="3174" class="kc kd hh jy b be ke kf l kg kh">plot(fit_prophet, forecast)<br/>prophet::prophet_plot_components(fit_prophet, forecast)</span></pre><figure class="jt ju jv jw fd kk er es paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="er es kj"><img src="../Images/cb2b691b5f2f6a28c171cd717a695f42.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8GPTFEviARmCwV7brnLFHQ.png"/></div></div><figcaption class="kr ks et er es kt ku bd b be z dx">Easy to make, but this is NOT a good model. In fact, this is a horrible fit and forecast. What a rocky start.</figcaption></figure><figure class="jt ju jv jw fd kk er es paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="er es kv"><img src="../Images/40f9b6748b88c64425d5b0e9ab071fbf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zLyPi-CLfkb5CoWwF-Yi2g.png"/></div></div><figcaption class="kr ks et er es kt ku bd b be z dx">In this plot you can see the components applied in the model. Like I said, the Prophet model is a decomposition model, and here I used the most basic of components. Much more tweaking is needed for me to tackle this model.</figcaption></figure><p id="07cc" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">我知道一些事件，比如假期，会对需求产生影响。如果某一天服务中心关门了，第二天你会接到更多的电话。让我们加上荷兰国定假日。</p><pre class="jt ju jv jw fd jx jy jz bn ka kb bi"><span id="5d90" class="kc kd hh jy b be ke kf l kg kh"># Adding holidays <br/>holiday&lt;-c("Nieuwjaarsdag", "Goedevrijdag", "Paasdag1", "Paasdag2",<br/>           "Koningsdag","Bevrijdsdag","Hemelvaartsdag","Pinksteren1", "Pinkesteren2",<br/>           "Kerstmis1", "Kerstmis2", "Oudjaarsdag")<br/>ds&lt;-c(as.Date('2022-01-01'),<br/>      as.Date('2022-04-15'),<br/>      as.Date('2022-04-17'),<br/>      as.Date('2022-04-18'),<br/>      as.Date('2022-04-27'),<br/>      as.Date('2022-05-05'),<br/>      as.Date('2022-05-26'),<br/>      as.Date('2022-06-05'),<br/>      as.Date('2022-06-06'),<br/>      as.Date('2022-12-25'),<br/>      as.Date('2022-12-26'),<br/>      as.Date('2022-12-31'))<br/>lower_window&lt;-rep(0,12)<br/>upper_window&lt;-rep(1,12)<br/>holidays &lt;- dplyr::bind_cols(holiday, ds, lower_window, upper_window)<br/>colnames(holidays)&lt;-c("holiday", "ds", "lower_window", "upper_window")<br/>&gt; holidays<br/># A tibble: 12 x 4<br/>   holiday        ds         lower_window upper_window<br/>   &lt;chr&gt;          &lt;date&gt;            &lt;dbl&gt;        &lt;dbl&gt;<br/> 1 Nieuwjaarsdag  2022-01-01            0            1<br/> 2 Goedevrijdag   2022-04-15            0            1<br/> 3 Paasdag1       2022-04-17            0            1<br/> 4 Paasdag2       2022-04-18            0            1<br/> 5 Koningsdag     2022-04-27            0            1<br/> 6 Bevrijdsdag    2022-05-05            0            1<br/> 7 Hemelvaartsdag 2022-05-26            0            1<br/> 8 Pinksteren1    2022-06-05            0            1<br/> 9 Pinkesteren2   2022-06-06            0            1<br/>10 Kerstmis1      2022-12-25            0            1<br/>11 Kerstmis2      2022-12-26            0            1<br/>12 Oudjaarsdag    2022-12-31            0            1</span></pre><pre class="ki jx jy jz bn ka kb bi"><span id="618b" class="kc kd hh jy b be ke kf l kg kh">fit_prophet &lt;- df_tbl%&gt;%<br/>  filter(RecordType =="VOIP call")%&gt;%<br/>  select(newdate, n)%&gt;%<br/>  rename(ds=newdate,<br/>         y=n)%&gt;%<br/>  prophet::prophet(., holidays=holidays)<br/>future &lt;- prophet::make_future_dataframe(fit_prophet, <br/>                                         periods = 672, <br/>                                         freq = 900)<br/>forecast &lt;- predict(fit_prophet, future)<br/>plot(fit_prophet, forecast)<br/>prophet::prophet_plot_components(fit_prophet, forecast)</span></pre><figure class="jt ju jv jw fd kk er es paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="er es kw"><img src="../Images/3689dfa7d8ef21cfb2f4cbe39d8aad55.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mkaNZHaVWsjJeuVAPjP-Mg.png"/></div></div><figcaption class="kr ks et er es kt ku bd b be z dx">Cannot say it looks better.</figcaption></figure><figure class="jt ju jv jw fd kk er es paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="er es kx"><img src="../Images/ef95a38b8a02355e4dee1323e0dc5be5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zNJOEcSW70x2kdD5Efl9nQ.png"/></div></div><figcaption class="kr ks et er es kt ku bd b be z dx">The holidays are now a component in the decomposed model.</figcaption></figure><p id="680f" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">我想看看每小时和每天我实际得到了什么样的预报。它们有意义吗？</p><pre class="jt ju jv jw fd jx jy jz bn ka kb bi"><span id="a69f" class="kc kd hh jy b be ke kf l kg kh">forecast_week&lt;-forecast%&gt;%<br/>  filter(ds&gt;max(df_tbl$newdate))%&gt;%<br/>  select(ds, yhat)%&gt;%<br/>  mutate(yhat=round(yhat))<br/>forecast_week%&gt;%<br/>  mutate(yhat = if_else(yhat&lt;0, 0, yhat), <br/>         day = factor(weekdays(ds), <br/>                      level=c("Monday", "Tuesday", "Wednesday",<br/>                              "Thursday", "Friday", "Saturday", "Sunday")))%&gt;%<br/>  arrange(day, ds)%&gt;%<br/>  ggplot(., <br/>         aes(x=ds, y=yhat))+<br/>  geom_bar(stat="identity")+<br/>  theme_bw()+<br/>  facet_wrap(~day, <br/>             scales="free", <br/>             ncol=2)+<br/>  labs(x="Date &amp; Time", <br/>       y="Incoming calls per quarterhour")</span></pre><figure class="jt ju jv jw fd kk er es paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="er es ky"><img src="../Images/9d4ce569c713a32923491ae532ac5249.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7vc6egPhOV1CXbgRlUvBAg.png"/></div></div><figcaption class="kr ks et er es kt ku bd b be z dx">Well, it does make sense. I am not predicting any calls in the evening or at night.. The pyramid form also seems to be okay to me.</figcaption></figure><p id="a9ea" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">让我们将预测汇总成每小时的数据。</p><pre class="jt ju jv jw fd jx jy jz bn ka kb bi"><span id="be99" class="kc kd hh jy b be ke kf l kg kh">forecast_week%&gt;%<br/>  timetk::summarise_by_time(<br/>    ds, .by="hour",<br/>    n=sum(yhat))%&gt;%<br/>  mutate(n = if_else(n&lt;0, 0, n), <br/>         day = factor(weekdays(ds), <br/>                      level=c("Monday", "Tuesday", "Wednesday",<br/>                              "Thursday", "Friday", "Saturday", "Sunday")))%&gt;%<br/>  arrange(day, ds)%&gt;%<br/>  ggplot(., <br/>       aes(x=ds, y=n))+<br/>  geom_bar(stat="identity")+<br/>  theme_bw()+<br/>  facet_wrap(~day, <br/>             scales="free_x", <br/>             ncol=2)+<br/>  labs(x="Date &amp; Time", <br/>       y="Incoming calls per hour")</span></pre><figure class="jt ju jv jw fd kk er es paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="er es kz"><img src="../Images/7ff3bce59ee5df992e98a50f8967e1cb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*q2VdzqTLw3T8darUlNttEw.png"/></div></div><figcaption class="kr ks et er es kt ku bd b be z dx">Looking okay to me again — Monday has the highest amount of calls which makes sense after the weekend. We see the pyramid form again and each day we have periods with no expected calls.</figcaption></figure><p id="47cd" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">如果我每天总结，这样我就有一个完整的星期，看起来怎么样？</p><pre class="jt ju jv jw fd jx jy jz bn ka kb bi"><span id="851f" class="kc kd hh jy b be ke kf l kg kh">forecast_week%&gt;%<br/>  timetk::summarise_by_time(<br/>    ds, .by="day",<br/>    n=sum(yhat))%&gt;%<br/>  mutate(n = if_else(n&lt;0, 0, n), <br/>         day = factor(weekdays(ds), <br/>                      level=c("Monday", "Tuesday", "Wednesday",<br/>                              "Thursday", "Friday", "Saturday", "Sunday")))%&gt;%<br/>  arrange(day, ds)<br/># A tibble: 8 x 3<br/>  ds                      n day      <br/>  &lt;dttm&gt;              &lt;dbl&gt; &lt;fct&gt;    <br/>1 2022-12-19 00:00:00   403 Monday   <br/>2 2022-12-13 00:00:00    17 Tuesday  <br/>3 2022-12-20 00:00:00   337 Tuesday  <br/>4 2022-12-14 00:00:00   344 Wednesday<br/>5 2022-12-15 00:00:00   334 Thursday <br/>6 2022-12-16 00:00:00   287 Friday   <br/>7 2022-12-17 00:00:00     4 Saturday <br/>8 2022-12-18 00:00:00    11 Sunday  </span></pre><p id="49e0" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">看起来不错，除了13号星期二。不知道那里发生了什么，但它可能不是一个完整的时间范围。这就解释了上面周二奇怪的图表。但总的来说，在我看来整体还不错。同样，本周的高峰是在周一，然后我们有一个下降，直到周五，周末几乎没有电话预测。</p><p id="c2cb" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">如果我应用ARIMA模型，预测会是什么样的呢？只是为了好玩，也因为我需要比较先知模型和另一个模型。<em class="la"> auto.arima </em>是一个简单而强大的建模功能。除此之外，我还会附赠季节性朴素模型。</p><pre class="jt ju jv jw fd jx jy jz bn ka kb bi"><span id="c30e" class="kc kd hh jy b be ke kf l kg kh">df_tbl%&gt;%<br/>  filter(RecordType =="VOIP call")%&gt;%<br/>  auto.arima %&gt;% <br/>  forecast(h=672) %&gt;% autoplot+theme_bw() <br/>df_tbl%&gt;%<br/>  filter(RecordType =="VOIP call")%&gt;%<br/>  auto.arima %&gt;% <br/>  checkresiduals(test=FALSE)+theme_bw()<br/><br/>arima_model&lt;-df_tbl%&gt;%<br/>  filter(RecordType =="VOIP call")%&gt;%<br/>  auto.arima %&gt;% <br/>  forecast(h=672)<br/><br/>&gt; arima_model<br/>         Point Forecast       Lo 80     Hi 80       Lo 95     Hi 95<br/>2545.597              0  -5.9371424  5.937142  -9.0800758  9.080076<br/>2545.608              0  -5.9371424  5.937142  -9.0800758  9.080076<br/>2545.618              0  -5.9371424  5.937142  -9.0800758  9.080076<br/>2545.629              0  -5.9371424  5.937142  -9.0800758  9.080076<br/>2545.639              0  -5.9371424  5.937142  -9.0800758  9.080076<br/>2545.649              0  -5.9371424  5.937142  -9.0800758  9.080076<br/>2545.660              0  -5.9371424  5.937142  -9.0800758  9.080076<br/>2545.670              0  -5.9371424  5.937142  -9.0800758  9.080076<br/>2545.681              0  -5.9371424  5.937142  -9.0800758  9.080076<br/>2545.691              0  -5.9371424  5.937142  -9.0800758  9.080076<br/>2545.702              0  -5.9371424  5.937142  -9.0800758  9.080076<br/>2545.712              0  -5.9371424  5.937142  -9.0800758  9.080076<br/>2545.722              0  -5.9371424  5.937142  -9.0800758  9.080076<br/>2545.733              0  -5.9371424  5.937142  -9.0800758  9.080076<br/>2545.743              0  -5.9371424  5.937142  -9.0800758  9.080076<br/>2545.754              0  -5.9371424  5.937142  -9.0800758  9.080076<br/>2545.764              0  -5.9371424  5.937142  -9.0800758  9.080076<br/>2545.774              0  -5.9371424  5.937142  -9.0800758  9.080076<br/>2545.785              0  -5.9371424  5.937142  -9.0800758  9.080076<br/>2545.795              0  -5.9371424  5.937142  -9.0800758  9.080076<br/>2545.806              0  -5.9371424  5.937142  -9.0800758  9.080076<br/>2545.816              0  -5.9371424  5.937142  -9.0800758  9.080076<br/>2545.827              0  -5.9371424  5.937142  -9.0800758  9.080076<br/>2545.837              0  -5.9371424  5.937142  -9.0800758  9.080076<br/>2545.847              0  -5.9371424  5.937142  -9.0800758  9.080076<br/><br/><br/>fit_snaive &lt;- df_tbl%&gt;%<br/>  filter(RecordType =="VOIP call")%&gt;%<br/>  snaive(.,h=672) <br/>plot(fit_snaive)<br/>fit_snaive&lt;-fit_snaive%&gt;%<br/>  as.data.frame()%&gt;%<br/>  slice_tail(., n=672)<br/></span></pre><div class="jt ju jv jw fd ab cb"><figure class="lb kk lc ld le lf lg paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><img src="../Images/996707c5c7c9f3e7179f07943c452691.png" data-original-src="https://miro.medium.com/v2/resize:fit:910/format:webp/1*CrlxCdaddx7v5VS0a98s4A.png"/></div></figure><figure class="lb kk lh ld le lf lg paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><img src="../Images/e21c9cb193e977afe3d38014419aed6b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1092/format:webp/1*Yv6K5w5nJBsdieSkuoWVAw.png"/></div><figcaption class="kr ks et er es kt ku bd b be z dx li di lj lk">They look okay, these models, but in fact are not. They are not picking up the pyramid form the Prophet model did pick up.</figcaption></figure></div><p id="dee7" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">ARIMA的残差显示了一个周期和相当多的长尾-这相当于基础数据的波峰和波谷。</p><figure class="jt ju jv jw fd kk er es paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="er es ll"><img src="../Images/eb8b2b7dc24c2775b8ad572000fd9e36.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LKSXLS0hBhyTne9_yEyZCg.png"/></div></div><figcaption class="kr ks et er es kt ku bd b be z dx">Autocorrelation is still present.</figcaption></figure><p id="df8d" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">那么，如果我们比较这三种模式呢？哪个看起来最擅长针对数据？</p><pre class="jt ju jv jw fd jx jy jz bn ka kb bi"><span id="e027" class="kc kd hh jy b be ke kf l kg kh">forecast%&gt;%<br/>  filter(ds&gt;max(df_tbl$newdate))%&gt;%<br/>  select(ds, yhat)%&gt;%<br/>  mutate(n_prophet = round(yhat))%&gt;%<br/>  mutate(n_arima   = as.numeric(round(arima_model$mean)))%&gt;%<br/>  mutate(n_snaive  = as.numeric(round(fit_snaive$`Point Forecast`)))%&gt;%<br/>  select(-yhat)%&gt;%<br/>  mutate(n_prophet = if_else(n_prophet&lt;0,0, n_prophet),<br/>         n_arima   = if_else(n_arima&lt;0,  0, n_arima),<br/>         n_snaive  = if_else(n_snaive&lt;0, 0, n_snaive),<br/>         day = factor(weekdays(ds), <br/>                     level=c("Monday", "Tuesday", "Wednesday",<br/>                             "Thursday", "Friday", "Saturday", "Sunday")))%&gt;%<br/>  arrange(day, ds)%&gt;%<br/>  ggplot(.)+<br/>  geom_line(aes(x=ds, y=n_prophet, color="Prophet Model"))+<br/>  geom_line(aes(x=ds, y=n_arima, color="ARIMA Model"))+<br/>  geom_line(aes(x=ds, y=n_snaive, color="Seasonal NAIVE Model"))+<br/>  theme_bw()+<br/>  facet_wrap(~day, <br/>             scales="free", <br/>             ncol=2)+<br/>  labs(x="Date &amp; Time", <br/>       y="Incoming calls per quarterhour")</span></pre><figure class="jt ju jv jw fd kk er es paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="er es lm"><img src="../Images/43f05ce35a13b59648d92f6e08cbac46.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*24IT1DGERjwCEWesbqlLFQ.png"/></div></div><figcaption class="kr ks et er es kt ku bd b be z dx">The ARIMA seems lost, or it is completely in agreement with the seasonal naïve model. I am not really sure at this point. Also, I find the seasonal naïve model to be very unwieldy, going up and down. The Prophet model seems more stable in terms of steps.</figcaption></figure><p id="9f20" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">当然，上面的图对于决定使用哪个模型并没有真正的帮助，因为您也希望在图中有底层数据。如果我们放大呢？</p><pre class="jt ju jv jw fd jx jy jz bn ka kb bi"><span id="adad" class="kc kd hh jy b be ke kf l kg kh"><br/>forecast%&gt;%<br/>  filter(ds&gt;max(df_tbl$newdate))%&gt;%<br/>  select(ds, yhat)%&gt;%<br/>  mutate(n_prophet=round(yhat))%&gt;%<br/>  mutate(n_arima = as.numeric(round(arima_model$mean)))%&gt;%<br/>  select(-yhat)%&gt;%<br/>  timetk::summarise_by_time(<br/>    ds, .by="hour",<br/>    n_prophet=sum(n_prophet),<br/>    n_arima=sum(n_arima))%&gt;%<br/>  mutate(hour=hour(ds))%&gt;%<br/>  filter(hour&gt;=8 &amp; hour&lt;=17)%&gt;%<br/>  mutate(n_prophet = if_else(n_prophet&lt;0, 0, n_prophet),<br/>         n_arima = if_else(n_arima&lt;0, 0, n_arima),<br/>         day = factor(weekdays(ds), <br/>                      level=c("Monday", "Tuesday", "Wednesday",<br/>                              "Thursday", "Friday", "Saturday", "Sunday")))%&gt;%<br/>  arrange(day, ds)%&gt;%<br/>  ggplot(.)+<br/>  geom_line(aes(x=ds, y=n_prophet, color="Prophet Model"))+<br/>  geom_line(aes(x=ds, y=n_arima, color="ARIMA Model"))+<br/>  theme_bw()+<br/>  facet_wrap(~day, <br/>             scales="free", <br/>             ncol=2)+<br/>  labs(x="Date &amp; Time", <br/>       y="Incoming calls per hour")</span></pre><figure class="jt ju jv jw fd kk er es paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="er es ln"><img src="../Images/a9b616bf9e7f8007908511ec5538971c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5RHKI81w4cruOesprqwtKg.png"/></div></div><figcaption class="kr ks et er es kt ku bd b be z dx">At the very least, the ARIMA model did provide forecasts. Once again, you cannot really see which model is best using plots like these, but you can see how they stack up. The problem with demand forecasting is that the room for error is very limited. And here the ARIMA model is continuously predicting higher than the Prophet model.</figcaption></figure><p id="e45a" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">如果您总结一整周每天的数据，这一点就变得很清楚了。事实上，ARIMA模型每天都给出完全相同的需求预测。</p><pre class="jt ju jv jw fd jx jy jz bn ka kb bi"><span id="4890" class="kc kd hh jy b be ke kf l kg kh">forecast%&gt;%<br/>  filter(ds&gt;max(df_tbl$newdate))%&gt;%<br/>  select(ds, yhat)%&gt;%<br/>  mutate(n_prophet=round(yhat))%&gt;%<br/>  mutate(n_arima = as.numeric(round(arima_model$mean)))%&gt;%<br/>  select(-yhat)%&gt;%<br/>  timetk::summarise_by_time(<br/>    ds, .by="hour",<br/>    n_prophet=sum(n_prophet),<br/>    n_arima=sum(n_arima))%&gt;%<br/>  mutate(hour=hour(ds))%&gt;%<br/>  filter(hour&gt;=8 &amp; hour&lt;=17)%&gt;%<br/>  mutate(n_prophet = if_else(n_prophet&lt;0, 0, n_prophet),<br/>         n_arima = if_else(n_arima&lt;0, 0, n_arima),<br/>         day = factor(weekdays(ds), <br/>                      level=c("Monday", "Tuesday", "Wednesday",<br/>                              "Thursday", "Friday", "Saturday", "Sunday")))%&gt;%<br/>  arrange(day, ds)%&gt;%<br/>  timetk::summarise_by_time(<br/>    ds, .by="day",<br/>    n_prophet=sum(n_prophet),<br/>    n_arima=sum(n_arima))<br/><br/># A tibble: 8 x 3<br/>  ds                  n_prophet n_arima<br/>  &lt;dttm&gt;                  &lt;dbl&gt;   &lt;dbl&gt;<br/>1 2022-12-13 00:00:00         6       0<br/>2 2022-12-14 00:00:00       298     389<br/>3 2022-12-15 00:00:00       290     389<br/>4 2022-12-16 00:00:00       275     389<br/>5 2022-12-17 00:00:00       150     389<br/>6 2022-12-18 00:00:00       155     389<br/>7 2022-12-19 00:00:00       335     389<br/>8 2022-12-20 00:00:00       288     389</span></pre><p id="f75f" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">从这一刻起，我专注于先知模型，但不是因为ARIMA表现不好，而是因为我如何对待它。因为我可以很容易地调整ARIMA模型，甚至包括傅立叶项，我将进入先知模型。</p><p id="ebba" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">使用Prophet模型的真正潜在原因是因为我还可以添加边界，这允许我通过添加事件和完全分解数据来处理数据的间歇部分。让我告诉你怎么做。</p><pre class="jt ju jv jw fd jx jy jz bn ka kb bi"><span id="98c8" class="kc kd hh jy b be ke kf l kg kh">TC_df&lt;-df%&gt;%<br/>  #dplyr::mutate(newdate = with(., ymd(Date) + hms(QuarterHour)),<br/>                #RecordTpe = factor(RecordType))%&gt;%<br/>  dplyr::mutate(newdate = with(., ymd(Date) + hours(Hour)),<br/>                RecordTpe = factor(RecordType))%&gt;%<br/>  group_by(RecordType, newdate)%&gt;%<br/>  filter(!RecordType %in% c("AgentState", "Callback call"))%&gt;%<br/>  filter(CallDirection=="Incoming" &amp; <br/>           DoneInIVR==0 &amp; AgentSequence==1)%&gt;%<br/>  count()%&gt;%<br/>  group_by(RecordType) %&gt;%<br/>  imputeTS::na_kalman(.) %&gt;% <br/>  select(RecordType, newdate, n)%&gt;%<br/>  as_tsibble(key = RecordType, index = newdate) %&gt;%<br/>  fill_gaps(n = 0, .full = end())%&gt;%<br/>  as_tibble()%&gt;%<br/>  arrange(RecordType, newdate)%&gt;%<br/>  ungroup()%&gt;%<br/>  select(RecordType, newdate, n)<br/>TC_df%&gt;%<br/>  mutate(dayname = weekdays(newdate, abbreviate = TRUE))%&gt;%<br/>  mutate(dayname = factor(dayname,levels=c("Mon", "Tue", "Wed",<br/>                                           "Thu","Fri","Sat","Sun")))%&gt;%<br/>  dplyr::filter(newdate&gt;"2022-10-10 00:00:00" &amp; newdate&lt;"2022-10-23 23:00:00")%&gt;%<br/>  ggplot(., aes(x=newdate, y=n, fill=factor(dayname)), alpha=0.5)+<br/>  geom_bar(stat="identity")+<br/>  theme_bw()+<br/>  facet_grid(rows=vars(RecordType), scales="free_y")+<br/>  labs(x="Date", <br/>       y="Incoming need", <br/>       fill="Dayname",<br/>       title="Actual calls between 8am and 5 pm for each day of the week")</span></pre><figure class="jt ju jv jw fd kk er es paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="er es lo"><img src="../Images/d48e3786daa1afe85889e163a163c1bc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-xnDgYo3cOKOyB1cZZORJA.png"/></div></div><figcaption class="kr ks et er es kt ku bd b be z dx">Here you see the actual incoming telephone calls and number of e-mails received between 8 am and 5 pm for each day of the week in a range of 2 weeks.</figcaption></figure><p id="ab13" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">我会再加上假期。</p><pre class="jt ju jv jw fd jx jy jz bn ka kb bi"><span id="92d4" class="kc kd hh jy b be ke kf l kg kh">holiday&lt;-c("Kerstmis1", "Kerstmis2", "Oudjaarsdag", <br/>           "Nieuwjaarsdag", "Goedevrijdag", "Paasdag1", "Paasdag2",<br/>           "Koningsdag","Bevrijdsdag","Hemelvaartsdag","Pinksteren1", "Pinkesteren2",<br/>           "Kerstmis1", "Kerstmis2", "Oudjaarsdag",<br/>           "Nieuwjaarsdag", "Goedevrijdag", "Paasdag1", "Paasdag2",<br/>           "Koningsdag","Bevrijdsdag","Hemelvaartsdag","Pinksteren1", "Pinkesteren2",<br/>           "Kerstmis1", "Kerstmis2", "Oudjaarsdag")<br/>ds&lt;-c(as.Date('2021-12-25'),<br/>      as.Date('2021-12-26'),<br/>      as.Date('2021-12-31'),<br/>      as.Date('2022-01-01'),<br/>      as.Date('2022-04-15'),<br/>      as.Date('2022-04-17'),<br/>      as.Date('2022-04-18'),<br/>      as.Date('2022-04-27'),<br/>      as.Date('2022-05-05'),<br/>      as.Date('2022-05-26'),<br/>      as.Date('2022-06-05'),<br/>      as.Date('2022-06-06'),<br/>      as.Date('2022-12-25'),<br/>      as.Date('2022-12-26'),<br/>      as.Date('2022-12-31'),<br/>      as.Date('2023-01-01'),<br/>      as.Date('2023-04-07'),<br/>      as.Date('2023-04-09'),<br/>      as.Date('2023-04-10'),<br/>      as.Date('2023-04-27'),<br/>      as.Date('2023-05-05'),<br/>      as.Date('2023-05-18'),<br/>      as.Date('2023-05-28'),<br/>      as.Date('2023-05-29'),<br/>      as.Date('2023-12-25'),<br/>      as.Date('2023-12-26'),<br/>      as.Date('2023-12-31'))<br/>lower_window&lt;-rep(0,length(ds))<br/>upper_window&lt;-rep(1,length(ds))<br/>df_holiday &lt;- dplyr::bind_cols(holiday, ds, lower_window, upper_window)<br/>colnames(df_holiday)&lt;-c("holiday", "ds", "lower_window", "upper_window")<br/>df_holiday<br/># A tibble: 27 x 4<br/>   holiday        ds         lower_window upper_window<br/>   &lt;chr&gt;          &lt;date&gt;            &lt;dbl&gt;        &lt;dbl&gt;<br/> 1 Kerstmis1      2021-12-25            0            1<br/> 2 Kerstmis2      2021-12-26            0            1<br/> 3 Oudjaarsdag    2021-12-31            0            1<br/> 4 Nieuwjaarsdag  2022-01-01            0            1<br/> 5 Goedevrijdag   2022-04-15            0            1<br/> 6 Paasdag1       2022-04-17            0            1<br/> 7 Paasdag2       2022-04-18            0            1<br/> 8 Koningsdag     2022-04-27            0            1<br/> 9 Bevrijdsdag    2022-05-05            0            1<br/>10 Hemelvaartsdag 2022-05-26            0            1<br/>11 Pinksteren1    2022-06-05            0            1<br/>12 Pinkesteren2   2022-06-06            0            1<br/>13 Kerstmis1      2022-12-25            0            1<br/>14 Kerstmis2      2022-12-26            0            1<br/>15 Oudjaarsdag    2022-12-31            0            1<br/>16 Nieuwjaarsdag  2023-01-01            0            1<br/>17 Goedevrijdag   2023-04-07            0            1<br/>18 Paasdag1       2023-04-09            0            1<br/>19 Paasdag2       2023-04-10            0            1<br/>20 Koningsdag     2023-04-27            0            1<br/>21 Bevrijdsdag    2023-05-05            0            1<br/>22 Hemelvaartsdag 2023-05-18            0            1<br/>23 Pinksteren1    2023-05-28            0            1<br/>24 Pinkesteren2   2023-05-29            0            1<br/>25 Kerstmis1      2023-12-25            0            1<br/>26 Kerstmis2      2023-12-26            0            1<br/>27 Oudjaarsdag    2023-12-31            0            1</span></pre><p id="8a08" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">现在，开始真正有趣的事情。接下来，您将看到我删除模型的一些标准部分，并替换它们。如您所见，我将删除自动的每日、每周和每年季节性，将季节性设置为乘法，将增长设置为逻辑，并输入假期。</p><p id="b127" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">从线性增长转变为逻辑增长使我能够更有效地处理边界问题。通过删除自动成分，我可以输入我自己的成分，包括傅立叶项——每小时、每天、每周、每月、每季度和每年。让我们看看我的结局。</p><pre class="jt ju jv jw fd jx jy jz bn ka kb bi"><span id="8071" class="kc kd hh jy b be ke kf l kg kh">m1 &lt;- prophet::prophet(weekly.seasonality=FALSE,<br/>                       yearly.seasonality=FALSE,<br/>                       daily.seasonality=FALSE,<br/>                       growth="logistic",<br/>                       seasonality.mode = 'multiplicative',<br/>                       holidays=df_holiday,<br/>                       changepoint.prior.scale = 0.5)<br/>                       #mcmc.samples=100)<br/>m1 &lt;- prophet::add_seasonality(m1, name='monthly', <br/>                               period=30.5, <br/>                               fourier.order=20)<br/>m1 &lt;- prophet::add_seasonality(m1, name='hourly', <br/>                               period=1/24, <br/>                               fourier.order=20)<br/>m1 &lt;- prophet::add_seasonality(m1, name='daily', <br/>                               period=1, <br/>                               fourier.order=20)<br/>m1 &lt;- prophet::add_seasonality(m1, name='weekly', <br/>                               period=7, <br/>                               fourier.order=20)<br/>m1 &lt;- prophet::add_seasonality(m1, name='yearly', <br/>                               period=365.25, <br/>                               fourier.order=20)<br/>m1 &lt;- prophet::add_seasonality(m1, name='quarterly', <br/>                               period=(365.25/4), <br/>                               fourier.order=20)</span></pre><p id="8e55" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">接下来，我将设置地板和天花板标高，并将其添加到模型中。然后，我将对VOIP通话时间序列运行模型，并从我设置的预测窗口中获取我的预测。</p><pre class="jt ju jv jw fd jx jy jz bn ka kb bi"><span id="cac7" class="kc kd hh jy b be ke kf l kg kh">TC_df$cap &lt;- 100<br/>TC_df$floor &lt;- 0<br/>fit &lt;- TC_df%&gt;%<br/>  filter(RecordType=="VOIP call")%&gt;%<br/>  select(newdate,n, cap, floor)%&gt;%<br/>  rename(ds=newdate, y=n)%&gt;%<br/>  select(ds,y, cap, floor)%&gt;%<br/>  prophet::fit.prophet(m1,.)<br/>saveRDS(fit, file="ProphetVOIPmodel.RDS")  # Save model<br/>fitVOIP &lt;- readRDS(file="ProphetVOIPmodel.RDS")           # Load model<br/>future &lt;- prophet::make_future_dataframe(fit,periods=7*24*4, <br/>                                         freq= 3600, <br/>                                         include_history = TRUE)<br/>future$cap &lt;- 100<br/>future$floor &lt;- 0<br/>forecast &lt;- predict(fit, future)<br/>plot(fit, forecast)</span></pre><figure class="jt ju jv jw fd kk er es paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="er es lp"><img src="../Images/b8b7f79c1af0322e0ae8c15cce479483.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*w3EQD40HJuAtaQLRuK_5hw.png"/></div></div><figcaption class="kr ks et er es kt ku bd b be z dx">This looking much much better. Okay, the bottom is being neglected at all it seems, but I am seeing the patterns I want to see.</figcaption></figure><p id="ccbb" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">让我们看看组件。</p><pre class="jt ju jv jw fd jx jy jz bn ka kb bi"><span id="c402" class="kc kd hh jy b be ke kf l kg kh">prophet::prophet_plot_components(fit, forecast)</span></pre><figure class="jt ju jv jw fd kk er es paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="er es lq"><img src="../Images/75cf8ac245c914f60b11b7d3bb388b3e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*d4Z6XsHNPh3PIqV9Ra3Bjw.png"/></div></div><figcaption class="kr ks et er es kt ku bd b be z dx">Quite some components included. Good to remember that all these components make up the model predictions. Hence, the time-series is first decomposed and then assessed for its ability to reproduce what it has observed. Maximum Likelihood in a nutshell.</figcaption></figure><p id="b700" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">我的预测看起来怎么样？</p><pre class="jt ju jv jw fd jx jy jz bn ka kb bi"><span id="5add" class="kc kd hh jy b be ke kf l kg kh">forecast%&gt;%<br/>  dplyr::select(ds, <br/>         yhat, <br/>         yhat_lower, <br/>         yhat_upper)%&gt;%<br/>  dplyr::filter(ds&gt;"2022-12-11")%&gt;%<br/>  mutate(hour = hour(ds), <br/>         day=day(ds))%&gt;%<br/>  dplyr::filter(hour&gt;=8 &amp; hour&lt;=17)%&gt;%<br/>  ggplot(., aes(x=ds, y=yhat))+<br/>  geom_point()+<br/>  geom_ribbon(aes(x=ds, y=yhat, ymin=yhat_lower, ymax=yhat_upper), <br/>              fill="black",alpha=0.2)+<br/>  theme_bw()</span></pre><figure class="jt ju jv jw fd kk er es paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="er es lr"><img src="../Images/96d782f87074a82f35e39c777e1a431f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Si9I5nA6f6SgHwCQITVg3w.png"/></div></div><figcaption class="kr ks et er es kt ku bd b be z dx">Looks good to me!</figcaption></figure><pre class="jt ju jv jw fd jx jy jz bn ka kb bi"><span id="4d9a" class="kc kd hh jy b be ke kf l kg kh">forecast%&gt;%<br/>  dplyr::select(ds, <br/>                yhat, <br/>                yhat_lower, <br/>                yhat_upper)%&gt;%<br/>  dplyr::filter(ds&gt;"2022-12-31")%&gt;%<br/>  mutate(hour = hour(ds), <br/>         day=day(ds), <br/>         date=date(ds))%&gt;%<br/>  dplyr::filter(hour&gt;=8 &amp; hour&lt;=17)%&gt;%<br/>  mutate(dayname = weekdays(ds, abbreviate = TRUE))%&gt;%<br/>  mutate(dayname = factor(dayname,levels=c("Mon", "Tue", "Wed",<br/>                                           "Thu","Fri","Sat","Sun")))%&gt;%<br/>  <br/>  filter(!dayname %in% c("Sat", "Sun"))%&gt;%<br/>  ggplot(., aes(x=hour, y=yhat, label=round(yhat)))+<br/>  geom_point()+<br/>  geom_ribbon(aes(x=hour, y=yhat, ymin=yhat_lower, ymax=yhat_upper, <br/>              fill=dayname),alpha=0.2)+<br/>  geom_text(check_overlap = TRUE,hjust = 1, vjust=-1,nudge_x = 0.05, size=4)+<br/>  theme_bw()+<br/>  facet_grid(~date, scale="free_x")+<br/>  scale_x_continuous(breaks = seq(8,17, by = 1))</span></pre><figure class="jt ju jv jw fd kk er es paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="er es ls"><img src="../Images/f11ffd436ff9d1274ad11a4807dbfba8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6qgHQ_Q5HQYndKqjQwZ4HA.png"/></div></div><figcaption class="kr ks et er es kt ku bd b be z dx">And the predictions shown as a function of time and date. What I am looking for is an early steep rise in calls and then a soft decline towards the end of the day. I am also looking for that spike on Monday.</figcaption></figure><p id="d5b4" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">让我们缩小一点，看看我是否真的得到了那个模式。</p><pre class="jt ju jv jw fd jx jy jz bn ka kb bi"><span id="dff0" class="kc kd hh jy b be ke kf l kg kh">forecast%&gt;%<br/>  dplyr::select(ds, <br/>                yhat, <br/>                yhat_lower, <br/>                yhat_upper)%&gt;%<br/>  dplyr::filter(ds&gt;"2022-12-11")%&gt;%<br/>  mutate(hour = hour(ds))%&gt;%<br/>  dplyr::filter(hour&gt;=8 &amp; hour&lt;=17)%&gt;%<br/>  summarise_by_time(ds, <br/>                    .by = "day", <br/>                    .type = "round", <br/>                    value = sum(yhat))%&gt;%<br/>  mutate(dayname = weekdays(ds, abbreviate = TRUE))%&gt;%<br/>  mutate(dayname = factor(dayname,levels=c("Mon", "Tue", "Wed",<br/>                                           "Thu","Fri","Sat","Sun")))%&gt;%<br/>  filter(!dayname %in% c("Sat", "Sun"))%&gt;%<br/>  ggplot(., aes(x=ds, y=value, fill=factor(dayname)), alpha=0.5)+<br/>  geom_bar(stat="identity")+<br/>  theme_bw()+<br/>  labs(x="Date", <br/>       y="Telephone calls", <br/>       fill="Dayname",<br/>       title="Predicted telephone calls between 8am and 5 pm for each day of the week")</span></pre><figure class="jt ju jv jw fd kk er es paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="er es lt"><img src="../Images/5180abae53db3cd2ae15e450152ee54e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Wxd7qcsiiWq2dB0L1FUdMw.png"/></div></div><figcaption class="kr ks et er es kt ku bd b be z dx">Yes I do.</figcaption></figure><p id="35e7" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">让我们来看看概率。</p><pre class="jt ju jv jw fd jx jy jz bn ka kb bi"><span id="6ffc" class="kc kd hh jy b be ke kf l kg kh">forecast%&gt;%<br/>  dplyr::select(ds, <br/>                yhat, <br/>                yhat_lower, <br/>                yhat_upper)%&gt;%<br/>  dplyr::filter(ds&gt;"2022-12-12")%&gt;%<br/>  mutate(hour = hour(ds), <br/>         day=day(ds), <br/>         date=date(ds))%&gt;%<br/>  dplyr::filter(hour&gt;=8 &amp; hour&lt;=17)%&gt;%<br/>  mutate(dayname = weekdays(ds, abbreviate = TRUE))%&gt;%<br/>  mutate(dayname = factor(dayname,levels=c("Mon", "Tue", "Wed",<br/>                                           "Thu","Fri","Sat","Sun")))%&gt;%<br/>  filter(!dayname %in% c("Sat", "Sun"))%&gt;%<br/>  select(ds, yhat, yhat_lower, yhat_upper)%&gt;%<br/>  mutate(ds=round(ds),<br/>         yhat=round(yhat),<br/>         yhat_lower=round(yhat_lower), <br/>         yhat_upper=round(yhat_upper))%&gt;%<br/>  rename(date=ds, <br/>         VOIP_predicted=yhat, <br/>         VOIP_predicted_lower=yhat_lower, <br/>         VOIP_predicted_higher=yhat_upper)<br/><br/>                   date VOIP_predicted VOIP_predicted_lower VOIP_predicted_higher<br/>1   2022-12-12 08:00:00             42                   32                    51<br/>2   2022-12-12 09:00:00             64                   54                    75<br/>3   2022-12-12 10:00:00             63                   53                    73<br/>4   2022-12-12 11:00:00             59                   49                    68<br/>5   2022-12-12 12:00:00             44                   34                    55<br/>6   2022-12-12 13:00:00             46                   36                    55<br/>7   2022-12-12 14:00:00             43                   34                    53<br/>8   2022-12-12 15:00:00             42                   32                    52<br/>9   2022-12-12 16:00:00             31                   21                    41<br/>10  2022-12-12 17:00:00             -3                  -13                     6<br/>11  2022-12-13 08:00:00             33                   23                    43<br/>12  2022-12-13 09:00:00             48                   38                    58<br/>13  2022-12-13 10:00:00             49                   39                    59</span></pre><p id="3d98" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">对我来说，这些数字看起来不错。由于模型是概率，我们将提供一系列数字。但出于某种原因，尽管最低值为零，该模型还是预测到了负数。我将不得不在未来对此进行进一步的评估。</p><p id="ed45" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">为了评估模型的有效性，我可以应用交叉验证。在这里，我将要求以30天为周期分割数据。</p><pre class="jt ju jv jw fd jx jy jz bn ka kb bi"><span id="e7ea" class="kc kd hh jy b be ke kf l kg kh">TC_df.cv &lt;- prophet::cross_validation(fit, initial = 30, period = 30, horizon = 30, units = 'days')<br/>prophet::plot_cross_validation_metric(TC_df.cv, metric = 'mape')<br/>TC_df.cv<br/># A tibble: 3,039 x 6<br/>       y ds                     yhat yhat_lower yhat_upper cutoff             <br/>   &lt;dbl&gt; &lt;dttm&gt;                &lt;dbl&gt;      &lt;dbl&gt;      &lt;dbl&gt; &lt;dttm&gt;             <br/> 1    48 2021-08-23 08:00:00  14.4         6.75      21.9  2021-08-20 17:00:00<br/> 2    77 2021-08-23 09:00:00  34.7        27.3       42.1  2021-08-20 17:00:00<br/> 3    57 2021-08-23 10:00:00  30.0        22.8       37.0  2021-08-20 17:00:00<br/> 4    62 2021-08-23 11:00:00  21.7        14.5       29.3  2021-08-20 17:00:00<br/> 5    61 2021-08-23 12:00:00  -0.240      -7.48       6.93 2021-08-20 17:00:00<br/> 6    62 2021-08-23 13:00:00  -1.50       -9.06       6.09 2021-08-20 17:00:00<br/> 7    56 2021-08-23 14:00:00  -5.02      -12.1        2.76 2021-08-20 17:00:00<br/> 8    58 2021-08-23 15:00:00 -14.0       -21.4       -6.63 2021-08-20 17:00:00<br/> 9    42 2021-08-23 16:00:00 -29.9       -36.7      -22.3  2021-08-20 17:00:00<br/>10    39 2021-08-24 08:00:00 -24.5       -32.1      -17.3  2021-08-20 17:00:00<br/># ... with 3,029 more rows</span></pre><figure class="jt ju jv jw fd kk er es paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="er es lu"><img src="../Images/cfb4f6acc731c446f4877a9d879190f6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WAeYgSVtMwSnf15Tf2f3-A.png"/></div></div><figcaption class="kr ks et er es kt ku bd b be z dx">Looking good over time. The outliers are mostly events I have not modelled yet. Something for the future.</figcaption></figure><pre class="jt ju jv jw fd jx jy jz bn ka kb bi"><span id="0b18" class="kc kd hh jy b be ke kf l kg kh">TC_df.p &lt;- prophet::performance_metrics(TC_df.cv)<br/>TC_df.p<br/>      horizon        mse      rmse      mae      mape     mdape     smape  coverage<br/>1    87 hours   827.3958  28.76449 20.35292 0.7142706 0.3594042 0.6124057 0.3663366<br/>2    88 hours   884.7252  29.74433 21.15144 0.7301427 0.3838585 0.6372713 0.3557756<br/>3    89 hours   943.8874  30.72275 21.97208 0.7452976 0.3965911 0.6628596 0.3392739<br/>4    90 hours   991.3885  31.48632 22.62120 0.7573581 0.3992891 0.6833342 0.3372937<br/>5    91 hours  1044.0739  32.31213 23.27287 0.7748281 0.4054236 0.7074297 0.3359736<br/>6    92 hours  1085.8181  32.95175 23.90657 0.7899180 0.4126654 0.7288895 0.3267327<br/>7    93 hours  1129.4854  33.60782 24.44831 0.8046231 0.4274603 0.7466365 0.3227723<br/>8    94 hours  1169.2230  34.19390 25.04196 0.8151764 0.4335314 0.7568633 0.3156316<br/>9    95 hours  1186.1815  34.44099 25.21167 0.8302762 0.4378025 0.7647722 0.3165317<br/>10   96 hours  1183.3540  34.39991 25.19690 0.8937962 0.4378025 0.7689431 0.3156316<br/>11  111 hours  1241.9208  35.24090 25.60396 0.9087479 0.4485662 0.7787953 0.3180318<br/>12  112 hours  1298.6121  36.03626 26.08307 0.9197898 0.4485662 0.7870496 0.3162316<br/>13  113 hours  1326.8614  36.42611 26.33218 0.9237472 0.4485662 0.7881559 0.3129313<br/>14  114 hours  1373.9662  37.06705 26.73836 0.9302271 0.4417954 0.7913998 0.3096310<br/>15  115 hours  1427.0944  37.77690 27.21232 0.9438990 0.4649363 0.7978453 0.3039304<br/>16  116 hours  1473.2762  38.38328 27.65111 0.9576387 0.4724837 0.8039432 0.2955296<br/>17  117 hours  1503.6625  38.77709 27.89451 0.9590604 0.4724837 0.8029143 0.2916292<br/>18  118 hours  1526.2041  39.06666 27.97210 0.8396388 0.4511389 0.7897167 0.2948295<br/>19  119 hours  1545.1412  39.30828 27.96781 0.8489682 0.4500697 0.7915213 0.2978548<br/>20  120 hours  1577.3210  39.71550 28.28425 1.3285633 0.4500697 0.8007789 0.2962046<br/>21  135 hours  1664.4476  40.79764 28.86563 1.3454675 0.4649363 0.8098595 0.2937294<br/>22  136 hours  1722.3524  41.50123 29.33171 1.3693806 0.4516746 0.8138840 0.2931793<br/>23  137 hours  1761.7773  41.97353 29.52384 1.3710233 0.4511389 0.8084394 0.2915292<br/>24  138 hours  1837.7364  42.86883 29.98473 1.3796956 0.4385938 0.8036610 0.2838284<br/>25  139 hours  1909.4537  43.69730 30.47415 1.3983215 0.4385938 0.8046136 0.2772277<br/>26  140 hours  1973.7674  44.42710 30.87739 1.4144755 0.4306182 0.8027825 0.2717272<br/>27  141 hours  2050.6867  45.28451 31.31982 1.4234553 0.4306182 0.8006392 0.2698020<br/>28  142 hours  2104.4469  45.87425 31.62569 1.4238621 0.4258125 0.7939464 0.2706271<br/>29  143 hours  2180.6383  46.69730 31.98080 1.3437806 0.4170105 0.7895738 0.2764026<br/>30  144 hours  2205.8794  46.96679 32.14368 1.7070054 0.4211839 0.7964796 0.2780528<br/>31  159 hours  2377.8927  48.76364 32.88574 1.7325492 0.4170105 0.7945434 0.2849285<br/>32  160 hours  2532.7136  50.32607 33.66352 1.7564765 0.4170105 0.7919632 0.2945545<br/>33  161 hours  2668.3920  51.65648 34.42589 1.8835151 0.4170105 0.7908198 0.3003300<br/>34  162 hours  2802.9861  52.94323 35.24607 1.9811052 0.4170105 0.7886301 0.2926293<br/>35  163 hours  2995.5727  54.73183 36.35064 2.0170405 0.4211839 0.7901189 0.2871287<br/>36  164 hours  3224.9815  56.78892 37.56338 2.0377829 0.4258125 0.7919723 0.2882288<br/>37  165 hours  3388.1239  58.20759 38.57397 2.1084925 0.4336581 0.7943699 0.2816282<br/>38  166 hours  3631.8703  60.26500 39.84352 2.1232605 0.4322039 0.7962240 0.2698020<br/>39  167 hours  3851.3188  62.05899 41.07109 2.0939748 0.4336581 0.7979080 0.2596260<br/>40  183 hours  4076.1588  63.84480 42.18438 2.1616346 0.4322039 0.8018336 0.2541254<br/>41  184 hours  4312.0095  65.66589 43.42222 2.1938510 0.4336581 0.8067529 0.2486249<br/>42  185 hours  4633.1511  68.06725 45.10975 2.2234641 0.4487351 0.8186872 0.2355236<br/>43  186 hours  4915.7172  70.11218 46.48087 2.2466009 0.4582281 0.8240190 0.2359736<br/>44  187 hours  5224.6978  72.28207 47.85008 2.2728217 0.4582281 0.8288225 0.2343234</span></pre><p id="2eaf" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">我们可以看到，误差随着视界的增加而增加。现在，MAPE ( <em class="la">平均绝对百分比误差</em>)并不是一个真正用于需求数据的好值，因此从这个意义上说，我们可以使用RMSE <em class="la">(均方根误差)</em>或平均绝对误差(<em class="la"> mae) </em>。mae为20意味着我对特定时间段的预测绝对差20点。这是相当大的，但主要取决于你希望预报多远，这里是提前87小时。</p><p id="b9fb" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">本质上，先知模型给了我第一个模型一个很好的基础。我没有将其与基线模型或任何类似的东西进行比较，这是我开始构建ML Ops部分后的未来工作。正是在这里，模型将自动运行，消化数据，生成预测并检查准确性。</p><p id="3995" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">就目前而言，我很高兴建立了一个模型，它能够足够充分地处理间歇数据，并能检测出这一时间序列中固有的模式。</p><div class="lv lw ez fb lx ly"><a rel="noopener follow" target="_blank" href="/mlearning-ai/mlearning-ai-submission-suggestions-b51e2b130bfb"><div class="lz ab dw"><div class="ma ab mb cl cj mc"><h2 class="bd hi fi z dy md ea eb me ed ef hg bi translated">Mlearning.ai提交建议</h2><div class="mf l"><h3 class="bd b fi z dy md ea eb me ed ef dx translated">如何成为Mlearning.ai上的作家</h3></div><div class="mg l"><p class="bd b fp z dy md ea eb me ed ef dx translated">medium.com</p></div></div><div class="mh l"><div class="mi l mj mk ml mh mm kp ly"/></div></div></a></div></div></div>    
</body>
</html>