<html>
<head>
<title>Azure Machine Learning Automated ML with Mlflow</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Mlflow的Azure机器学习自动化ML</h1>
<blockquote>原文：<a href="https://medium.com/mlearning-ai/azure-machine-learning-automated-ml-with-mlflow-c04538ee440f?source=collection_archive---------6-----------------------#2022-12-10">https://medium.com/mlearning-ai/azure-machine-learning-automated-ml-with-mlflow-c04538ee440f?source=collection_archive---------6-----------------------#2022-12-10</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><figure class="ev ex if ig ih ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es ie"><img src="../Images/f48aa251134cd6644f351f8c8aa6c277.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*il_yHo9kqtLV6DVP"/></div></div></figure><h1 id="e6a6" class="ip iq hh bd ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm bi translated">将MLFlow与Azure机器学习和自动化ML结合使用</h1><h1 id="ffac" class="ip iq hh bd ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm bi translated">先决条件</h1><ul class=""><li id="47b1" class="jn jo hh jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke bi translated">Azure订阅</li><li id="36cf" class="jn jo hh jp b jq kf js kg ju kh jw ki jy kj ka kb kc kd ke bi translated">Azure机器学习工作区</li><li id="1b27" class="jn jo hh jp b jq kf js kg ju kh jw ki jy kj ka kb kc kd ke bi translated">Azure存储帐户</li><li id="1f70" class="jn jo hh jp b jq kf js kg ju kh jw ki jy kj ka kb kc kd ke bi translated">创建数据文件夹</li><li id="a8cf" class="jn jo hh jp b jq kf js kg ju kh jw ki jy kj ka kb kc kd ke bi translated">将数据文件上传到数据文件夹</li></ul><h1 id="b5cf" class="ip iq hh bd ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm bi translated">图书馆</h1><ul class=""><li id="b47c" class="jn jo hh jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke bi translated">安装Azure.ai.ml</li></ul><pre class="kk kl km kn fd ko kp kq bn kr ks bi"><span id="5a7b" class="kt iq hh kp b be ku kv l kw kx">pip install azure.ai.ml</span></pre><ul class=""><li id="45d4" class="jn jo hh jp b jq ky js kz ju la jw lb jy lc ka kb kc kd ke bi translated">安装mlflow</li></ul><pre class="kk kl km kn fd ko kp kq bn kr ks bi"><span id="20a1" class="kt iq hh kp b be ku kv l kw kx">pip install mlflow</span></pre><h1 id="c48f" class="ip iq hh bd ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm bi translated">密码</h1><ul class=""><li id="537c" class="jn jo hh jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke bi translated">安装库</li></ul><pre class="kk kl km kn fd ko kp kq bn kr ks bi"><span id="cd4e" class="kt iq hh kp b be ku kv l kw kx">from azure.identity import DefaultAzureCredential<br/>from azure.identity import AzureCliCredential<br/>from azure.ai.ml import automl, Input, MLClient</span></pre><pre class="ld ko kp le lf aw lg bi"><span id="7dd6" class="lh iq hh kp b fi li lj l lk kx">from azure.ai.ml.constants import AssetTypes<br/>from azure.ai.ml.automl import (<br/>    classification,<br/>    ClassificationPrimaryMetrics,<br/>    ClassificationModels,<br/>)</span></pre><ul class=""><li id="871d" class="jn jo hh jp b jq ky js kz ju la jw lb jy lc ka kb kc kd ke bi translated">向Azure机器学习工作区进行身份验证</li></ul><pre class="kk kl km kn fd ko kp kq bn kr ks bi"><span id="2cd0" class="kt iq hh kp b be ku kv l kw kx">from azure.identity import DefaultAzureCredential<br/>from azure.ai.ml import MLClient</span></pre><pre class="ld ko kp le lf aw lg bi"><span id="7160" class="lh iq hh kp b fi li lj l lk kx">credential = DefaultAzureCredential()<br/>ml_client = None<br/>try:<br/>    ml_client = MLClient.from_config(credential)<br/>except Exception as ex:<br/>    print(ex)<br/>    # Enter details of your AzureML workspace<br/>    subscription_id = "xxxxxxxxxxxxxxx"<br/>    resource_group = "rgname"<br/>    workspace = "wkspacename"<br/>    ml_client = MLClient(credential, subscription_id, resource_group, workspace)</span></pre><ul class=""><li id="a91c" class="jn jo hh jp b jq ky js kz ju la jw lb jy lc ka kb kc kd ke bi translated">显示工作空间</li></ul><pre class="kk kl km kn fd ko kp kq bn kr ks bi"><span id="ce94" class="kt iq hh kp b be ku kv l kw kx">workspace = ml_client.workspaces.get(name=ml_client.workspace_name)</span></pre><pre class="ld ko kp le lf aw lg bi"><span id="874f" class="lh iq hh kp b fi li lj l lk kx">subscription_id = ml_client.connections._subscription_id<br/>resource_group = workspace.resource_group<br/>workspace_name = ml_client.workspace_name</span><span id="50a3" class="lh iq hh kp b fi ll lj l lk kx">output = {}<br/>output["Workspace"] = workspace_name<br/>output["Subscription ID"] = subscription_id<br/>output["Resource Group"] = resource_group<br/>output["Location"] = workspace.location<br/>output</span></pre><ul class=""><li id="1206" class="jn jo hh jp b jq ky js kz ju la jw lb jy lc ka kb kc kd ke bi translated">创建数据集</li></ul><pre class="kk kl km kn fd ko kp kq bn kr ks bi"><span id="056a" class="kt iq hh kp b be ku kv l kw kx">my_training_data_input = Input(<br/>    type=AssetTypes.MLTABLE, path="./data/"<br/>)<br/>my_training_data_test = Input(<br/>    type=AssetTypes.MLTABLE, path="./data/"<br/>)<br/>my_training_data_validate = Input(<br/>    type=AssetTypes.MLTABLE, path="./data/"<br/>)</span></pre><ul class=""><li id="ca44" class="jn jo hh jp b jq ky js kz ju la jw lb jy lc ka kb kc kd ke bi translated">设置实验名称</li></ul><pre class="kk kl km kn fd ko kp kq bn kr ks bi"><span id="eb33" class="kt iq hh kp b be ku kv l kw kx"># General job parameters<br/>compute_name = "cpu-cluster"<br/>max_trials = 5<br/>exp_name = "automlv2-Titanic-experiment"</span></pre><ul class=""><li id="81f5" class="jn jo hh jp b jq ky js kz ju la jw lb jy lc ka kb kc kd ke bi translated">配置实验</li></ul><pre class="kk kl km kn fd ko kp kq bn kr ks bi"><span id="7a6c" class="kt iq hh kp b be ku kv l kw kx">classification_job = automl.classification(<br/>    compute=compute_name,<br/>    experiment_name=exp_name,<br/>    training_data=my_training_data_input,<br/>    target_column_name="Survived",<br/>    primary_metric="accuracy",<br/>    n_cross_validations=5,<br/>    enable_model_explainability=True,<br/>    tags={"my_custom_tag": "Titanic Training"},<br/>)</span></pre><pre class="ld ko kp le lf aw lg bi"><span id="8df6" class="lh iq hh kp b fi li lj l lk kx"># Limits are all optional<br/>classification_job.set_limits(<br/>    timeout_minutes=600,<br/>    trial_timeout_minutes=20,<br/>    max_trials=max_trials,<br/>    # max_concurrent_trials = 4,<br/>    # max_cores_per_trial: -1,<br/>    enable_early_termination=True,<br/>)</span><span id="ba68" class="lh iq hh kp b fi ll lj l lk kx"># Training properties are optional<br/>classification_job.set_training(<br/>    blocked_training_algorithms=[ClassificationModels.LOGISTIC_REGRESSION],<br/>    enable_onnx_compatible_models=True,<br/>)</span></pre><ul class=""><li id="bb23" class="jn jo hh jp b jq ky js kz ju la jw lb jy lc ka kb kc kd ke bi translated">进行实验</li></ul><pre class="kk kl km kn fd ko kp kq bn kr ks bi"><span id="8448" class="kt iq hh kp b be ku kv l kw kx"># Submit the AutoML job<br/>returned_job = ml_client.jobs.create_or_update(<br/>    classification_job<br/>)  # submit the job to the backend</span></pre><pre class="ld ko kp le lf aw lg bi"><span id="aad8" class="lh iq hh kp b fi li lj l lk kx">print(f"Created job: {returned_job}")</span></pre><ul class=""><li id="5c16" class="jn jo hh jp b jq ky js kz ju la jw lb jy lc ka kb kc kd ke bi translated">流日志</li></ul><pre class="kk kl km kn fd ko kp kq bn kr ks bi"><span id="dc83" class="kt iq hh kp b be ku kv l kw kx">ml_client.jobs.stream(returned_job.name)</span></pre><ul class=""><li id="6b73" class="jn jo hh jp b jq ky js kz ju la jw lb jy lc ka kb kc kd ke bi translated">导入mlflow</li></ul><pre class="kk kl km kn fd ko kp kq bn kr ks bi"><span id="74fa" class="kt iq hh kp b be ku kv l kw kx">import mlflow</span></pre><pre class="ld ko kp le lf aw lg bi"><span id="0bcd" class="lh iq hh kp b fi li lj l lk kx"># Obtain the tracking URL from MLClient<br/>MLFLOW_TRACKING_URI = ml_client.workspaces.get(<br/>    name=ml_client.workspace_name<br/>).mlflow_tracking_uri</span><span id="0b2a" class="lh iq hh kp b fi ll lj l lk kx">print(MLFLOW_TRACKING_URI)</span></pre><ul class=""><li id="14ef" class="jn jo hh jp b jq ky js kz ju la jw lb jy lc ka kb kc kd ke bi translated">设置跟踪URI</li></ul><pre class="kk kl km kn fd ko kp kq bn kr ks bi"><span id="5119" class="kt iq hh kp b be ku kv l kw kx"># Set the MLFLOW TRACKING URI</span></pre><pre class="ld ko kp le lf aw lg bi"><span id="a304" class="lh iq hh kp b fi li lj l lk kx">mlflow.set_tracking_uri(MLFLOW_TRACKING_URI)</span><span id="558f" class="lh iq hh kp b fi ll lj l lk kx">print("\nCurrent tracking uri: {}".format(mlflow.get_tracking_uri()))</span></pre><ul class=""><li id="bfec" class="jn jo hh jp b jq ky js kz ju la jw lb jy lc ka kb kc kd ke bi translated">调用MLflow</li></ul><pre class="kk kl km kn fd ko kp kq bn kr ks bi"><span id="70c7" class="kt iq hh kp b be ku kv l kw kx">from mlflow.tracking.client import MlflowClient</span></pre><pre class="ld ko kp le lf aw lg bi"><span id="839b" class="lh iq hh kp b fi li lj l lk kx"># Initialize MLFlow client<br/>mlflow_client = MlflowClient()</span></pre><ul class=""><li id="e137" class="jn jo hh jp b jq ky js kz ju la jw lb jy lc ka kb kc kd ke bi translated">获取运行id</li></ul><pre class="kk kl km kn fd ko kp kq bn kr ks bi"><span id="730a" class="kt iq hh kp b be ku kv l kw kx">job_name = returned_job.name</span></pre><pre class="ld ko kp le lf aw lg bi"><span id="9f37" class="lh iq hh kp b fi li lj l lk kx"># Example if providing an specific Job name/ID<br/># job_name = "xxxxxx"</span><span id="9e74" class="lh iq hh kp b fi ll lj l lk kx"># Get the parent run<br/>mlflow_parent_run = mlflow_client.get_run(job_name)</span><span id="3b2c" class="lh iq hh kp b fi ll lj l lk kx">print("Parent Run: ")<br/>print(mlflow_parent_run)</span></pre><ul class=""><li id="a591" class="jn jo hh jp b jq ky js kz ju la jw lb jy lc ka kb kc kd ke bi translated">让孩子跑起来</li></ul><pre class="kk kl km kn fd ko kp kq bn kr ks bi"><span id="a12c" class="kt iq hh kp b be ku kv l kw kx">best_child_run_id = mlflow_parent_run.data.tags["automl_best_child_run_id"]<br/>print("Found best child run id: ", best_child_run_id)</span></pre><pre class="ld ko kp le lf aw lg bi"><span id="62af" class="lh iq hh kp b fi li lj l lk kx">best_run = mlflow_client.get_run(best_child_run_id)</span><span id="f4e4" class="lh iq hh kp b fi ll lj l lk kx">print("Best child run: ")<br/>print(best_run)</span></pre><ul class=""><li id="4325" class="jn jo hh jp b jq ky js kz ju la jw lb jy lc ka kb kc kd ke bi translated">韵律学</li></ul><pre class="kk kl km kn fd ko kp kq bn kr ks bi"><span id="99a0" class="kt iq hh kp b be ku kv l kw kx">best_run.data.metrics</span></pre><ul class=""><li id="853e" class="jn jo hh jp b jq ky js kz ju la jw lb jy lc ka kb kc kd ke bi translated">目录</li></ul><pre class="kk kl km kn fd ko kp kq bn kr ks bi"><span id="27bf" class="kt iq hh kp b be ku kv l kw kx">import os</span></pre><pre class="ld ko kp le lf aw lg bi"><span id="a74c" class="lh iq hh kp b fi li lj l lk kx"># Create local folder<br/>local_dir = "./artifact_downloads"<br/>if not os.path.exists(local_dir):<br/>    os.mkdir(local_dir)</span><span id="51ec" class="lh iq hh kp b fi ll lj l lk kx"># Download run's artifacts/outputs<br/>local_path = mlflow_client.download_artifacts(<br/>    best_run.info.run_id, "outputs", local_dir<br/>)<br/>print("Artifacts downloaded in: {}".format(local_path))<br/>print("Artifacts: {}".format(os.listdir(local_path)))</span></pre><ul class=""><li id="9e2d" class="jn jo hh jp b jq ky js kz ju la jw lb jy lc ka kb kc kd ke bi translated">列出目录</li></ul><pre class="kk kl km kn fd ko kp kq bn kr ks bi"><span id="3adf" class="kt iq hh kp b be ku kv l kw kx">os.listdir("./artifact_downloads/outputs/mlflow-model")</span></pre><ul class=""><li id="253e" class="jn jo hh jp b jq ky js kz ju la jw lb jy lc ka kb kc kd ke bi translated">部署端点</li></ul><pre class="kk kl km kn fd ko kp kq bn kr ks bi"><span id="23e3" class="kt iq hh kp b be ku kv l kw kx"># import required libraries<br/># import required libraries<br/>from azure.ai.ml import MLClient<br/>from azure.ai.ml.entities import (<br/>    ManagedOnlineEndpoint,<br/>    ManagedOnlineDeployment,<br/>    Model,<br/>    Environment,<br/>    CodeConfiguration,<br/>    ProbeSettings,<br/>)<br/>from azure.ai.ml.constants import ModelType</span></pre><ul class=""><li id="cfff" class="jn jo hh jp b jq ky js kz ju la jw lb jy lc ka kb kc kd ke bi translated">创建端点</li></ul><pre class="kk kl km kn fd ko kp kq bn kr ks bi"><span id="e674" class="kt iq hh kp b be ku kv l kw kx">import datetime</span></pre><pre class="ld ko kp le lf aw lg bi"><span id="7ff1" class="lh iq hh kp b fi li lj l lk kx">online_endpoint_name = "titanic-" + datetime.datetime.now().strftime("%m%d%H%M%f")</span><span id="2683" class="lh iq hh kp b fi ll lj l lk kx"># create an online endpoint<br/>endpoint = ManagedOnlineEndpoint(<br/>    name=online_endpoint_name,<br/>    description="this is a sample online endpoint for mlflow model",<br/>    auth_mode="key",<br/>    tags={"foo": "bar"},<br/>)<br/>ml_client.begin_create_or_update(endpoint)</span></pre><ul class=""><li id="7143" class="jn jo hh jp b jq ky js kz ju la jw lb jy lc ka kb kc kd ke bi translated">注册模型</li></ul><pre class="kk kl km kn fd ko kp kq bn kr ks bi"><span id="a25e" class="kt iq hh kp b be ku kv l kw kx">model_name = "titanic-model"<br/>model = Model(<br/>    path=f"azureml://jobs/{best_run.info.run_id}/outputs/artifacts/outputs/model.pkl",<br/>    name=model_name,<br/>    description="my sample mlflow model",<br/>)</span></pre><pre class="ld ko kp le lf aw lg bi"><span id="6c11" class="lh iq hh kp b fi li lj l lk kx"># for downloaded file<br/># model = Model(path="artifact_downloads/outputs/model.pkl", name=model_name)</span><span id="dc3a" class="lh iq hh kp b fi ll lj l lk kx">registered_model = ml_client.models.create_or_update(model)<br/>registered_model.id</span></pre><ul class=""><li id="e692" class="jn jo hh jp b jq ky js kz ju la jw lb jy lc ka kb kc kd ke bi translated">环境</li></ul><pre class="kk kl km kn fd ko kp kq bn kr ks bi"><span id="aa26" class="kt iq hh kp b be ku kv l kw kx">env = Environment(<br/>    name="automl-tabular-env",<br/>    description="environment for automl inference",<br/>    image="mcr.microsoft.com/azureml/openmpi3.1.2-ubuntu18.04:20210727.v1",<br/>    conda_file="artifact_downloads/outputs/conda_env_v_1_0_0.yml",<br/>)</span></pre><ul class=""><li id="3248" class="jn jo hh jp b jq ky js kz ju la jw lb jy lc ka kb kc kd ke bi translated">康达构型</li></ul><pre class="kk kl km kn fd ko kp kq bn kr ks bi"><span id="3d1d" class="kt iq hh kp b be ku kv l kw kx">code_configuration = CodeConfiguration(<br/>    code="artifact_downloads/outputs/", scoring_script="scoring_file_v_2_0_0.py"<br/>)</span></pre><ul class=""><li id="3313" class="jn jo hh jp b jq ky js kz ju la jw lb jy lc ka kb kc kd ke bi translated">受管理端点配置</li></ul><pre class="kk kl km kn fd ko kp kq bn kr ks bi"><span id="d43d" class="kt iq hh kp b be ku kv l kw kx">deployment = ManagedOnlineDeployment(<br/>    name="titanic-deploy",<br/>    endpoint_name=online_endpoint_name,<br/>    model=registered_model.id,<br/>    environment=env,<br/>    code_configuration=code_configuration,<br/>    instance_type="Standard_DS2_V2",<br/>    instance_count=1,<br/>)</span></pre><ul class=""><li id="1c7f" class="jn jo hh jp b jq ky js kz ju la jw lb jy lc ka kb kc kd ke bi translated">部署端点</li></ul><pre class="kk kl km kn fd ko kp kq bn kr ks bi"><span id="1092" class="kt iq hh kp b be ku kv l kw kx">ml_client.online_deployments.begin_create_or_update(deployment)</span></pre><ul class=""><li id="3e91" class="jn jo hh jp b jq ky js kz ju la jw lb jy lc ka kb kc kd ke bi translated">检验推论</li></ul><pre class="kk kl km kn fd ko kp kq bn kr ks bi"><span id="527e" class="kt iq hh kp b be ku kv l kw kx"># test the blue deployment with some sample data<br/>ml_client.online_endpoints.invoke(<br/>    endpoint_name=online_endpoint_name,<br/>    deployment_name="titanic-deploy",<br/>    request_file="sample-titanic-data.json",<br/>)</span></pre><ul class=""><li id="3c0f" class="jn jo hh jp b jq ky js kz ju la jw lb jy lc ka kb kc kd ke bi translated">示例json文件</li></ul><pre class="kk kl km kn fd ko kp kq bn kr ks bi"><span id="e7ba" class="kt iq hh kp b be ku kv l kw kx">{<br/>  "Inputs": {<br/>    "data": [<br/>      {<br/>        "PassengerId": 10,<br/>        "Pclass": 1,<br/>        "Name": "Name goes here",<br/>        "Sex": "Male",<br/>        "Age": 35.0,<br/>        "SibSp": 2,<br/>        "Parch": 1,<br/>        "Ticket": "F123",<br/>        "Fare": 10.0,<br/>        "Cabin": "S",<br/>        "Embarked": "E"<br/>      }<br/>    ]<br/>  },<br/>  "GlobalParameters": {<br/>    "method": "predict"<br/>  }<br/>}</span></pre><ul class=""><li id="f431" class="jn jo hh jp b jq ky js kz ju la jw lb jy lc ka kb kc kd ke bi translated">删除端点</li></ul><pre class="kk kl km kn fd ko kp kq bn kr ks bi"><span id="231c" class="kt iq hh kp b be ku kv l kw kx">ml_client.online_endpoints.begin_delete(name=online_endpoint_name)</span></pre></div><div class="ab cl lm ln go lo" role="separator"><span class="lp bw bk lq lr ls"/><span class="lp bw bk lq lr ls"/><span class="lp bw bk lq lr"/></div><div class="ha hb hc hd he"><p id="a776" class="pw-post-body-paragraph lt lu hh jp b jq ky lv lw js kz lx ly ju lz ma mb jw mc md me jy mf mg mh ka ha bi translated"><em class="mi">最初发表于</em><a class="ae mj" href="https://github.com/balakreshnan/Samples2022/blob/main/AzureMLV2/titanicautoml.md" rel="noopener ugc nofollow" target="_blank"><em class="mi">【https://github.com】</em></a><em class="mi">。</em></p><div class="mk ml ez fb mm mn"><a rel="noopener follow" target="_blank" href="/mlearning-ai/mlearning-ai-submission-suggestions-b51e2b130bfb"><div class="mo ab dw"><div class="mp ab mq cl cj mr"><h2 class="bd hi fi z dy ms ea eb mt ed ef hg bi translated">Mlearning.ai提交建议</h2><div class="mu l"><h3 class="bd b fi z dy ms ea eb mt ed ef dx translated">如何成为Mlearning.ai上的作家</h3></div><div class="mv l"><p class="bd b fp z dy ms ea eb mt ed ef dx translated">medium.com</p></div></div><div class="mw l"><div class="mx l my mz na mw nb in mn"/></div></div></a></div></div></div>    
</body>
</html>