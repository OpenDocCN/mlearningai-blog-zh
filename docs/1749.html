<html>
<head>
<title>Creating scalable NLP pipelines using PySpark and Nlphose</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">ä½¿ç”¨PySparkå’ŒNlphoseåˆ›å»ºå¯ä¼¸ç¼©çš„NLPç®¡é“</h1>
<blockquote>åŸæ–‡ï¼š<a href="https://medium.com/mlearning-ai/creating-scalable-nlp-pipelines-using-pyspark-and-nlphose-b93afa3097c1?source=collection_archive---------6-----------------------#2022-01-25">https://medium.com/mlearning-ai/creating-scalable-nlp-pipelines-using-pyspark-and-nlphose-b93afa3097c1?source=collection_archive---------6-----------------------#2022-01-25</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><p id="b45c" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬å°†äº†è§£å¦‚ä½•ä½¿ç”¨<a class="ae jc" href="https://github.com/code2k13/nlphose" rel="noopener ugc nofollow" target="_blank">NLP hoste</a>å’ŒPysparkæ¥æ‰§è¡ŒNLPç®¡é“ï¼Œå¹¶æ”¶é›†å…³äºå„’å‹’Â·å‡¡å°”çº³çš„è‘—ä½œã€Š80å¤©ç¯æ¸¸ä¸–ç•Œã€‹ä¸­çš„è‘—åæ—…ç¨‹çš„ä¿¡æ¯ã€‚è¿™é‡Œæ˜¯æœ¬æ–‡ä¸­ä½¿ç”¨çš„â¬‡ï¸ <a class="ae jc" href="https://github.com/code2k13/nlphose/blob/main/Nlphose_Pyspark.ipynb" rel="noopener ugc nofollow" target="_blank"> Pysparkç¬”è®°æœ¬çš„é“¾æ¥ã€‚</a></p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es jd"><img src="../Images/47370a9c399940216f6062427501617f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*clWtLxBpj_cvVnXI.png"/></div></div></figure><p id="1a28" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">æ ¹æ®æˆ‘çš„ä¸ªäººç»éªŒï¼Œæˆ‘å‘ç°ä»éç»“æ„åŒ–æ•°æ®ä¸­æŒ–æ˜æ•°æ®éœ€è¦ä½¿ç”¨å¤šç§æŠ€æœ¯ã€‚æ²¡æœ‰ä¸€ä¸ªå•ä¸€çš„æ¨¡å‹æˆ–åº“å¯ä»¥æä¾›æ‚¨éœ€è¦çš„ä¸€åˆ‡ã€‚é€šå¸¸ï¼Œæ‚¨å¯èƒ½éœ€è¦ä½¿ç”¨ç”¨ä¸åŒç¼–ç¨‹è¯­è¨€/æ¡†æ¶ç¼–å†™çš„ç»„ä»¶ã€‚è¿™å°±æ˜¯æˆ‘çš„å¼€æºé¡¹ç›®<a class="ae jc" href="https://github.com/code2k13/nlphose" rel="noopener ugc nofollow" target="_blank"> Nlphose </a>å‡ºç°çš„åœ°æ–¹ã€‚Nlphoseæ”¯æŒä½¿ç”¨ä¸€ç»„ç®€å•çš„å‘½ä»¤è¡Œå·¥å…·ï¼Œåœ¨å‡ ç§’é’Ÿå†…åˆ›å»ºå¤æ‚çš„NLPç®¡é“ï¼Œç”¨äºå¤„ç†é™æ€æ–‡ä»¶æˆ–æµæ–‡æœ¬ã€‚æ‚¨å¯ä»¥åœ¨ç»ˆç«¯ä¸­æ‰§è¡Œå•ä¸ªå‘½ä»¤ï¼Œå¯¹æ–‡æœ¬æ‰§è¡Œå¤šç§æ“ä½œï¼Œå¦‚NERã€æƒ…æ„Ÿåˆ†æã€åˆ†å—ã€è¯­è¨€è¯†åˆ«ã€Q &amp; Aã€0-shotåˆ†ç±»ç­‰ã€‚Sparkæ˜¯å¹¿æ³›ä½¿ç”¨çš„å¤§æ•°æ®å¤„ç†å·¥å…·ï¼Œå¯ç”¨äºå¹¶è¡ŒåŒ–å·¥ä½œè´Ÿè½½ã€‚</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es jp"><img src="../Images/8d37ff8f4695e8585d2effabc7938664.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*8MmfrBUvBywGLJO0.jpg"/></div></div></figure><p id="f9d9" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><a class="ae jc" href="https://github.com/code2k13/nlphose" rel="noopener ugc nofollow" target="_blank"> Nlphose </a>åŸºäºâ€œ<a class="ae jc" href="https://tldp.org/LDP/GNU-Linux-Tools-Summary/html/c1089.htm" rel="noopener ugc nofollow" target="_blank"> Unixå·¥å…·å“²å­¦</a>â€ã€‚è¿™ä¸ªæƒ³æ³•æ˜¯åˆ›é€ ç®€å•çš„å·¥å…·ï¼Œå®ƒä»¬å¯ä»¥ä¸€èµ·å·¥ä½œæ¥å®Œæˆå¤šé¡¹ä»»åŠ¡ã€‚Nlphoseè„šæœ¬ä¾é æ ‡å‡†çš„â€œæ–‡ä»¶æµâ€æ¥è¯»å†™æ•°æ®ï¼Œå¹¶ä¸”å¯ä»¥é€šè¿‡ç®¡é“è¿æ¥åœ¨ä¸€èµ·ï¼Œä»¥åˆ›å»ºå¤æ‚çš„è‡ªç„¶è¯­è¨€å¤„ç†ç®¡é“ã€‚æ¯ä¸ªè„šæœ¬ä»â€œæ ‡å‡†è¾“å…¥â€è¯»å–JSONï¼Œå¹¶å†™å…¥â€œæ ‡å‡†è¾“å‡ºâ€ã€‚æ‰€æœ‰çš„è„šæœ¬éƒ½æœŸæœ›JSONä»¥nlphoseå…¼å®¹æ ¼å¼ç¼–ç ï¼Œå¹¶ä¸”è¾“å‡ºä¹Ÿéœ€è¦æ˜¯nlphoseå…¼å®¹çš„ã€‚ä½ å¯ä»¥åœ¨è¿™é‡Œé˜…è¯»å…³äºNLP hose<a class="ae jc" href="https://github.com/code2k13/nlphose/wiki/Architecture-of-nlphose" rel="noopener ugc nofollow" target="_blank">æ¶æ„çš„æ›´å¤šç»†èŠ‚ã€‚</a></p><h1 id="d0b0" class="jq jr hh bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">Nlphoseæœ‰ä»€ä¹ˆä¸åŒï¼Ÿ</h1><p id="3793" class="pw-post-body-paragraph ie if hh ig b ih ko ij ik il kp in io ip kq ir is it kr iv iw ix ks iz ja jb ha bi translated">Nlphoseåœ¨è®¾è®¡ä¸Šä¸åƒSparkMLé‚£æ ·æ”¯æŒSpark/Pysparkã€‚Pysparkä¸­çš„Nlphoseä¾èµ–äºå®‰è£…åœ¨sparké›†ç¾¤æ‰€æœ‰èŠ‚ç‚¹ä¸Šçš„â€œDockerâ€ã€‚å½“åœ¨<a class="ae jc" href="https://cloud.google.com/dataproc/" rel="noopener ugc nofollow" target="_blank"> Google Dataproc </a>ä¸­åˆ›å»ºä¸€ä¸ªæ–°çš„é›†ç¾¤æ—¶ï¼Œè¿™æ˜¯å¾ˆå®¹æ˜“åšåˆ°çš„(å¯¹äºä»»ä½•å…¶ä»–Sparkåˆ†å¸ƒä¹Ÿåº”è¯¥æ˜¯ä¸€æ ·çš„)ã€‚é™¤äº†Dockerä¹‹å¤–ï¼ŒNlphoseä¸éœ€è¦åœ¨Sparké›†ç¾¤çš„å·¥ä½œèŠ‚ç‚¹ä¸Šå®‰è£…ä»»ä½•å…¶ä»–ä¾èµ–é¡¹ã€‚æˆ‘ä»¬ä½¿ç”¨ä¸‹é¢æè¿°çš„â€œPipeLineExecutorâ€ç±»ä»Pysparkä¸­æ‰§è¡ŒNlphoseç®¡é“ã€‚</p><p id="d27d" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">åœ¨å¹•åï¼Œè¿™ä¸ªç±»ä½¿ç”¨â€œ<a class="ae jc" href="https://docs.python.org/3/library/subprocess.html" rel="noopener ugc nofollow" target="_blank">å­è¿›ç¨‹</a>æ¨¡å—ä¸ºä¸€ä¸ªSparkä»»åŠ¡ç”Ÿæˆä¸€ä¸ªæ–°çš„dockerå®¹å™¨ï¼Œå¹¶æ‰§è¡Œä¸€ä¸ªNlphoseç®¡é“ã€‚ä½¿ç”¨stdoutå’Œstdinæ‰§è¡ŒI/Oã€‚è¿™å¬èµ·æ¥å¾ˆç®€å•ï¼Œä½†è¿™å°±æ˜¯æˆ‘æ„å»ºNlphoseçš„æ–¹å¼ã€‚å®ƒä»æœªè¢«è®¾æƒ³ä¸ºæ”¯æŒä»»ä½•ç‰¹å®šçš„è®¡ç®—æ¡†æ¶æˆ–åº“ã€‚æ‚¨å¯ä»¥ç”¨è®¸å¤šä¸åŒçš„æ–¹å¼è¿è¡ŒNlphoseï¼Œè¿™é‡Œå°†ä»‹ç»å…¶ä¸­ä¸€ç§æ–¹å¼ã€‚</p><h1 id="82f4" class="jq jr hh bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">æˆ‘ä»¬å¼€å§‹å§</h1><p id="8c56" class="pw-post-body-paragraph ie if hh ig b ih ko ij ik il kp in io ip kq ir is it kr iv iw ix ks iz ja jb ha bi translated">é¦–å…ˆï¼Œæˆ‘ä»¬å®‰è£…ä¸€ä¸ªåŒ…ï¼Œç¨åæˆ‘ä»¬å°†ä½¿ç”¨å®ƒæ¥æ„å»ºä¸€ä¸ªå¯è§†åŒ–ã€‚</p><p id="691a" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">ï¼pipå®‰è£…å­—æ•°</p><p id="f646" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">ä¸‹é¢çš„å‘½ä»¤ä»gutenber.orgçš„<a class="ae jc" href="https://ashishware.com/2022/01/23/PysparkNlphose/gutenber.org" rel="noopener ugc nofollow" target="_blank">ä¸‹è½½ç”µå­ä¹¦ã€Š80å¤©ç¯æ¸¸ä¸–ç•Œã€‹ï¼Œå¹¶ä½¿ç”¨Nlphoseæä¾›çš„å·¥å…·å°†å•ä¸ªæ–‡æœ¬æ–‡ä»¶åˆ†å‰²æˆè¡Œåˆ†éš”çš„jsonã€‚æ¯ä¸ªjsonå¯¹è±¡éƒ½æœ‰ä¸€ä¸ªâ€œidâ€å’Œâ€œtextâ€å±æ€§ã€‚</a></p><pre class="je jf jg jh fd kt ku kv kw aw kx bi"><span id="c6da" class="ky jr hh ku b fi kz la l lb lc">!docker run code2k13/nlphose:latest \<br/>/bin/bash -c â€œwget <a class="ae jc" href="https://www.gutenberg.org/files/103/103-0.txt" rel="noopener ugc nofollow" target="_blank">https://www.gutenberg.org/files/103/103-0.txt</a> &amp;&amp; ./file2json.py 103â€“0.txt -n 2â€ &gt; ebook.json</span></pre><p id="34d8" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">æˆ‘ä»¬åˆ é™¤æ‰€æœ‰ä¸å†éœ€è¦çš„dockerå®¹å™¨ã€‚</p><pre class="je jf jg jh fd kt ku kv kw aw kx bi"><span id="7bd0" class="ky jr hh ku b fi kz la l lb lc">!docker system prune -f</span></pre><p id="7090" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">è®©æˆ‘ä»¬å¯¼å…¥æ‰€æœ‰éœ€è¦çš„åº“ã€‚è¯»å–æˆ‘ä»¬ä¹‹å‰åˆ›å»ºçš„jsonæ–‡ä»¶ï¼Œå¹¶å°†å…¶è½¬æ¢ä¸ºpandasæ•°æ®æ¡†ã€‚ç„¶åï¼Œæˆ‘ä»¬å°†ä¸€ä¸ªâ€œgroup_idâ€åˆ—æ·»åŠ åˆ°è¡Œä¸­ï¼Œè¯¥åˆ—ä»0åˆ°3ä¹‹é—´éšæœºåˆ†é…ä¸€ä¸ªgroupIdã€‚å®Œæˆåï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªæ–°çš„PySparkæ•°æ®æ¡†æ¶å¹¶æ˜¾ç¤ºä¸€äº›ç»“æœã€‚</p><pre class="je jf jg jh fd kt ku kv kw aw kx bi"><span id="6553" class="ky jr hh ku b fi kz la l lb lc">import pandas as pd<br/>from pyspark.sql.types import StructType,StructField, StringType, IntegerType<br/>from pyspark.sql.functions import desc<br/>from pyspark.sql.functions import udf</span><span id="c8b7" class="ky jr hh ku b fi ld la l lb lc">df_pd = pd.read_json(â€œebook.jsonâ€,lines=True) <br/>df_pd[â€˜group_idâ€™] = [i for i in range(0,3)]*347<br/>df= spark.createDataFrame(df_pd)<br/>df= spark.createDataFrame(df_pd)</span><span id="773c" class="ky jr hh ku b fi ld la l lb lc">+ â€” â€” â€” â€” -+ â€” â€” â€” â€” â€” â€” â€” â€” â€” â€” + â€” â€” â€” â€” â€” â€” â€” â€” â€” â€” + â€” â€” â€” â€” +<br/>|file_name| id| text|group_id|<br/>+ â€” â€” â€” â€” -+ â€” â€” â€” â€” â€” â€” â€” â€” â€” â€” + â€” â€” â€” â€” â€” â€” â€” â€” â€” â€” + â€” â€” â€” â€” +<br/>|103â€“0.txt|2bbbfe64â€“7c1e-11eâ€¦| The Project Guteâ€¦| 0|<br/>|103â€“0.txt|2bbea7ea-7c1e-11eâ€¦| Title: Around thâ€¦| 1|<br/>|103â€“0.txt|2bbf2eb8â€“7c1e-11eâ€¦|IN WHICH PHILEAS â€¦| 2|<br/>|103â€“0.txt|2bbfdbd8â€“7c1e-11eâ€¦| Certainly an Engâ€¦| 0|<br/>|103â€“0.txt|2bbff29e-7c1e-11eâ€¦| Phileas Fogg wasâ€¦| 1|<br/>|103â€“0.txt|2bc00734â€“7c1e-11eâ€¦| The way in whichâ€¦| 2|<br/>|103â€“0.txt|2bc02570â€“7c1e-11eâ€¦| He was recommendâ€¦| 0|<br/>|103â€“0.txt|2bc095f0â€“7c1e-11eâ€¦| Was Phileas Foggâ€¦| 1|<br/>|103â€“0.txt|2bc0ed20â€“7c1e-11eâ€¦| Had he travelledâ€¦| 2|<br/>|103â€“0.txt|2bc159d6â€“7c1e-11eâ€¦| It was at least â€¦| 0|<br/>|103â€“0.txt|2bc1a3be-7c1e-11eâ€¦| Phileas Fogg wasâ€¦| 1|<br/>|103â€“0.txt|2bc2a2aa-7c1e-11eâ€¦|He breakfasted anâ€¦| 2|<br/>|103â€“0.txt|2bc2c280â€“7c1e-11eâ€¦| If to live in thâ€¦| 0|<br/>|103â€“0.txt|2bc30b3c-7c1e-11eâ€¦| The mansion in Sâ€¦| 1|<br/>|103â€“0.txt|2bc34dd6â€“7c1e-11eâ€¦| Phileas Fogg wasâ€¦| 2|<br/>|103â€“0.txt|2bc35f88â€“7c1e-11eâ€¦|Fogg would, accorâ€¦| 0|<br/>|103â€“0.txt|2bc3772a-7c1e-11eâ€¦| A rap at this moâ€¦| 1|<br/>|103â€“0.txt|2bc3818e-7c1e-11eâ€¦| â€œThe new servantâ€¦| 2|<br/>|103â€“0.txt|2bc38e0e-7c1e-11eâ€¦| A young man of tâ€¦| 0|<br/>|103â€“0.txt|2bc45c6c-7c1e-11eâ€¦| â€œYou are a Frencâ€¦| 1|<br/>+ â€” â€” â€” â€” -+ â€” â€” â€” â€” â€” â€” â€” â€” â€” â€” + â€” â€” â€” â€” â€” â€” â€” â€” â€” â€” + â€” â€” â€” â€” +</span></pre><h1 id="6b1f" class="jq jr hh bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">ä½¿ç”¨Pysparkè¿è¡Œnlphoseç®¡é“</h1><p id="2e48" class="pw-post-body-paragraph ie if hh ig b ih ko ij ik il kp in io ip kq ir is it kr iv iw ix ks iz ja jb ha bi translated">å¦‚å‰æ‰€è¿°ï¼ŒNlphoseæ²¡æœ‰ä¸Pyspark/Sparkçš„æœ¬åœ°é›†æˆã€‚å› æ­¤ï¼Œæˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªåä¸ºâ€œPipeLineExecutorâ€çš„ç±»ï¼Œå®ƒå¯åŠ¨ä¸€ä¸ªdockerå®¹å™¨å¹¶æ‰§è¡Œä¸€ä¸ªNlphoseå‘½ä»¤ã€‚è¿™ä¸ªç±»ä½¿ç”¨â€œæ ‡å‡†è¾“å…¥â€å’Œâ€œæ ‡å‡†è¾“å‡ºâ€ä¸dockerå®¹å™¨é€šä¿¡ã€‚æœ€åï¼Œå½“dockerå®¹å™¨å®Œæˆæ‰§è¡Œæ—¶ï¼Œæˆ‘ä»¬æ‰§è¡Œâ€˜docker system prune-fâ€™æ¥æ¸…é™¤ä»»ä½•æœªä½¿ç”¨çš„å®¹å™¨ã€‚â€œexecute_pipelineâ€æ–¹æ³•å°†æ•°æ®ä»dataframeå†™å…¥stdin(é€è¡Œ)ï¼Œä»stdoutè¯»å–è¾“å‡ºï¼Œå¹¶è¿”å›ä»è¾“å‡ºåˆ›å»ºçš„dataframeã€‚</p><pre class="je jf jg jh fd kt ku kv kw aw kx bi"><span id="9b74" class="ky jr hh ku b fi kz la l lb lc">import subprocess<br/>import pandas as pd<br/>import json<br/><br/>class PipeLineExecutor:<br/>  def __init__(self, nlphose_command,data,id_column='id',text_column='text'):<br/>    self.nlphose_command = nlphose_command<br/>    self.id_column = id_column<br/>    self.text_column = text_column<br/>    self.data = data<br/><br/>  def execute_pipeline(self):<br/>    try:<br/>     prune_proc = subprocess.Popen(["docker system prune -f"],shell=True)<br/>     prune_proc.communicate()<br/>        <br/>     proc = subprocess.Popen([self.nlphose_command],shell=True,stdout=subprocess.PIPE, stdin=subprocess.PIPE,stderr=subprocess.PIPE)<br/>     for idx,row in self.data.iterrows():       <br/>        proc.stdin.write(bytes(json.dumps({"id":row[self.id_column],"text":row[self.text_column]}),"utf8"))<br/>        proc.stdin.write(b"\n")<br/>        proc.stdin.flush()<br/>    <br/>     output,error = proc.communicate()<br/>     output_str = str(output,'utf-8')<br/>     output_str = output_str<br/>     data = output_str.split("\n")    <br/>     data = [d for d in data if len(d) &gt; 2]<br/>    finally:<br/>        prune_proc = subprocess.Popen(["docker system prune -f"],shell=True)<br/>        prune_proc.communicate()<br/>    return pd.DataFrame(data)</span></pre><h1 id="143d" class="jq jr hh bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">Nlphoseå‘½ä»¤</h1><p id="8360" class="pw-post-body-paragraph ie if hh ig b ih ko ij ik il kp in io ip kq ir is it kr iv iw ix ks iz ja jb ha bi translated">ä»¥ä¸‹å‘½ä»¤æ‰§è¡Œå¤šé¡¹ä»»åŠ¡:</p><ul class=""><li id="fb33" class="le lf hh ig b ih ii il im ip lg it lh ix li jb lj lk ll lm bi translated">å®ƒä½¿ç”¨dockerhubä¸­çš„<a class="ae jc" href="https://hub.docker.com/r/code2k13/nlphose#!" rel="noopener ugc nofollow" target="_blank"> code2k13/nlphose:latest </a>å›¾åƒå¯åŠ¨dockerå®¹å™¨ã€‚</li><li id="3e58" class="le lf hh ig b ih ln il lo ip lp it lq ix lr jb lj lk ll lm bi translated">å®ƒå°†ä¸»æœºçš„stdinã€stdoutå’Œstderré‡å®šå‘åˆ°dockerå®¹å™¨ä¸­ã€‚</li><li id="0691" class="le lf hh ig b ih ln il lo ip lp it lq ix lr jb lj lk ll lm bi translated">ç„¶åï¼Œå®ƒåœ¨dockerå®¹å™¨ä¸­è¿è¡Œnlphoseå‘½ä»¤ï¼Œè¯¥å‘½ä»¤å¯¹æ¥è‡ªâ€œstdinâ€çš„jsonæ‰§è¡Œä»¥ä¸‹æ“ä½œï¼Œå¹¶å°†è¾“å‡ºå†™å…¥â€œstdoutâ€:</li><li id="2f1e" class="le lf hh ig b ih ln il lo ip lp it lq ix lr jb lj lk ll lm bi translated"><a class="ae jc" href="https://github.com/code2k13/nlphose/wiki/Name-Entity-Recognition" rel="noopener ugc nofollow" target="_blank">å®ä½“è¯†åˆ«</a></li><li id="cea4" class="le lf hh ig b ih ln il lo ip lp it lq ix lr jb lj lk ll lm bi translated">å¯»æ‰¾â€œä»–ä»¬æºå¸¦äº†ä»€ä¹ˆâ€è¿™ä¸ªé—®é¢˜çš„ç­”æ¡ˆ<a class="ae jc" href="https://github.com/code2k13/nlphose/wiki/Question-Answering" rel="noopener ugc nofollow" target="_blank">ä½¿ç”¨åŸºäºå˜å‹å™¨çš„æ¨¡å‹</a>ã€‚</li></ul><pre class="je jf jg jh fd kt ku kv kw aw kx bi"><span id="41ac" class="ky jr hh ku b fi kz la l lb lc">command = '''<br/>docker run -a stdin -a stdout -a stderr -i code2k13/nlphose:latest /bin/bash -c â€œ./entity.py |\<br/>./xformer.py â€” pipeline question-answering â€” param â€˜what did they carry?â€™ <br/>â€œ <br/>'''</span></pre><p id="87b4" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">ä¸‹é¢çš„å‡½æ•°æ ¼å¼åŒ–PipelineExecutorä»»åŠ¡è¿”å›çš„æ•°æ®ã€‚â€œpipeline executor . execute _ pipelineâ€è¿”å›çš„dataframeæœ‰ä¸€ä¸ªå­—ç¬¦ä¸²åˆ—ï¼Œå…¶ä¸­åŒ…å«Nlphoseå‘½ä»¤çš„è¾“å‡ºã€‚æ•°æ®å¸§ä¸­çš„æ¯ä¸€è¡Œä»£è¡¨Nlphoseå‘½ä»¤çš„ä¸€è¡Œ/ä¸€ä¸ªæ–‡æ¡£è¾“å‡ºã€‚</p><pre class="je jf jg jh fd kt ku kv kw aw kx bi"><span id="3d38" class="ky jr hh ku b fi kz la l lb lc">def get_answer(row):<br/>  try:<br/>    x =  json.loads(row[0],strict=False)<br/>    row['json_obj'] = json.dumps(x)<br/>    if x['xfrmr_question_answering']['score'] &gt; 0.80:<br/>        row['id'] =  str(x['id'])<br/>        row['answer'] = x['xfrmr_question_answering']['answer']        <br/>    else:<br/>        row['id'] = str(x['id'])<br/>        row['answer'] = None<br/>        <br/>  except Exception as e:<br/>    row['id'] = None<br/>    row['answer'] = "ERROR " + str(e) #.message<br/>    row['json_obj'] = None<br/>    <br/>  return row</span></pre><p id="eccf" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">ä¸‹é¢çš„å‡½æ•°åˆ›å»ºä¸€ä¸ªâ€œPipeLineExecutorâ€å¯¹è±¡ï¼Œå°†æ•°æ®ä¼ é€’ç»™å®ƒï¼Œç„¶åå¯¹è¯¥å¯¹è±¡è°ƒç”¨â€œexecute_pipelineâ€æ–¹æ³•ã€‚ç„¶åï¼Œå®ƒä½¿ç”¨â€œget_answerâ€æ–¹æ³•æ¥æ ¼å¼åŒ–â€œexecute_pipelineâ€æ–¹æ³•çš„è¾“å‡ºã€‚</p><pre class="je jf jg jh fd kt ku kv kw aw kx bi"><span id="1dc9" class="ky jr hh ku b fi kz la l lb lc">def run_pipeline(data):<br/>  nlphose_executor = PipeLineExecutor(command,data,"id","text")<br/>  result = nlphose_executor.execute_pipeline()<br/>  result =  result.apply(get_answer,axis=1)     <br/>  return  result[["id","answer","json_obj"]]</span></pre><h1 id="646f" class="jq jr hh bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">ä½¿ç”¨PySparkæ‰©å±•ç®¡é“</h1><p id="d098" class="pw-post-body-paragraph ie if hh ig b ih ko ij ik il kp in io ip kq ir is it kr iv iw ix ks iz ja jb ha bi translated">æˆ‘ä»¬ä½¿ç”¨PySparkçš„â€œ<a class="ae jc" href="https://spark.apache.org/docs/latest/api/python/reference/api/pyspark.sql.GroupedData.applyInPandas.html" rel="noopener ugc nofollow" target="_blank"> applyInPandas </a>â€æ¥å¹¶è¡ŒåŒ–å’Œå¤§è§„æ¨¡å¤„ç†æ–‡æœ¬ã€‚PySparkè‡ªåŠ¨å¤„ç†Sparké›†ç¾¤ä¸ŠNlphoseç®¡é“çš„ç¼©æ”¾ã€‚å¯¹è¾“å…¥æ•°æ®çš„æ¯ä¸ªâ€œç»„â€è°ƒç”¨â€œrun_pipelineâ€æ–¹æ³•ã€‚é‡è¦çš„æ˜¯æ ¹æ®èŠ‚ç‚¹æ•°é‡è®¾ç½®é€‚å½“æ•°é‡çš„ç»„ï¼Œä»¥ä¾¿åœ¨Sparké›†ç¾¤ä¸Šæœ‰æ•ˆåœ°å¤„ç†æ•°æ®ã€‚</p><pre class="je jf jg jh fd kt ku kv kw aw kx bi"><span id="29c1" class="ky jr hh ku b fi kz la l lb lc">output = df.groupby(â€œgroup_idâ€).applyInPandas(run_pipeline, schema=â€id string,answer string,json_obj stringâ€)<br/>output.cache()</span></pre><h1 id="147d" class="jq jr hh bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">å¯è§†åŒ–æˆ‘ä»¬çš„å‘ç°</h1><p id="0bfe" class="pw-post-body-paragraph ie if hh ig b ih ko ij ik il kp in io ip kq ir is it kr iv iw ix ks iz ja jb ha bi translated">ä¸€æ—¦æˆ‘ä»¬å®Œæˆäº†nlphoseç®¡é“çš„æ‰§è¡Œï¼Œæˆ‘ä»¬å°±å¼€å§‹å¯è§†åŒ–æˆ‘ä»¬çš„å‘ç°ã€‚æˆ‘å·²ç»åˆ›å»ºäº†ä¸¤ä¸ªå¯è§†åŒ–:</p><ul class=""><li id="698c" class="le lf hh ig b ih ii il im ip lg it lh ix li jb lj lk ll lm bi translated">æ˜¾ç¤ºä¹¦ä¸­æåˆ°çš„åœ°æ–¹çš„åœ°å›¾ã€‚</li><li id="44d0" class="le lf hh ig b ih ln il lo ip lp it lq ix lr jb lj lk ll lm bi translated">äººç‰©æ—…é€”ä¸­æºå¸¦çš„æ‰€æœ‰é‡è¦ç‰©å“çš„å•è¯äº‘ã€‚</li></ul><h1 id="96b0" class="jq jr hh bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">åœ¨ä¸–ç•Œåœ°å›¾ä¸Šæ ‡å‡ºä¹¦ä¸­æœ€å¸¸è§çš„ä½ç½®</h1><p id="9dbd" class="pw-post-body-paragraph ie if hh ig b ih ko ij ik il kp in io ip kq ir is it kr iv iw ix ks iz ja jb ha bi translated">ä¸‹é¢çš„ä»£ç ä»Nlphoseç®¡é“ä¸­æå–çº¬åº¦å’Œç»åº¦ä¿¡æ¯ï¼Œå¹¶åˆ›å»ºä¸€ä¸ªæœ€å¸¸è§ä½ç½®çš„åˆ—è¡¨ã€‚</p><blockquote class="ls lt lu"><p id="1640" class="ie if lv ig b ih ii ij ik il im in io lw iq ir is lx iu iv iw ly iy iz ja jb ha bi translated"><em class="hh">ğŸ’¡æ³¨æ„:Nlphoseå®ä½“æå–å°†ä½¿ç”¨åŸºäºå­—å…¸çš„æ–¹æ³•è‡ªåŠ¨çŒœæµ‹å·²çŸ¥ä½ç½®çš„åæ ‡</em></p></blockquote><pre class="je jf jg jh fd kt ku kv kw aw kx bi"><span id="7352" class="ky jr hh ku b fi kz la l lb lc">def get_latlon2(data):<br/>        json_obj = json.loads(data)<br/>        if 'entities' in json_obj.keys():<br/>            for e in json_obj['entities']:<br/>                if e['label'] == 'GPE' and 'cords' in e.keys():<br/>                    return json.dumps({'data':[e['entity'],e['cords']['lat'],e['cords']['lon']]})<br/>        return None<br/>        <br/>get_latlon_udf2 = udf(get_latlon2)  <br/>df_locations = output.withColumn("locations",get_latlon_udf2(output["json_obj"]))<br/>top_locations = df_locations.filter("`locations` != 'null'").groupby("locations").count().sort(desc("count")).filter("`count` &gt;= 1")<br/>top_locations.cache() <br/>top_locations.show()</span></pre><p id="3f07" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">ç„¶åï¼Œæˆ‘ä»¬ä½¿ç”¨â€œgeopandasâ€åŒ…åœ¨ä¸–ç•Œåœ°å›¾ä¸Šç»˜åˆ¶è¿™äº›ä½ç½®ã€‚åœ¨æ­¤ä¹‹å‰ï¼Œæˆ‘ä»¬å¿…é¡»å°†æ•°æ®å¸§è½¬æ¢æˆâ€œgeopandasâ€èƒ½å¤Ÿç†è§£çš„æ ¼å¼ã€‚è¿™æ˜¯é€šè¿‡åº”ç”¨å‡½æ•°â€˜add _ lat _ longâ€™æ¥å®Œæˆçš„</p><pre class="je jf jg jh fd kt ku kv kw aw kx bi"><span id="2b3f" class="ky jr hh ku b fi kz la l lb lc">def add_lat_long(row):<br/>     obj =  json.loads(row[0])["data"]<br/>     row["lat"] = obj[1]<br/>     row["lon"] = obj[2]<br/>     return row</span><span id="0e3d" class="ky jr hh ku b fi ld la l lb lc">import geopandas<br/><br/>df_locations = top_locations.toPandas()<br/>df_locations = df_locations.apply(add_lat_long,axis=1)<br/><br/>gdf = geopandas.GeoDataFrame(df_locations, geometry=geopandas.points_from_xy(df_locations.lon, df_locations.lat))<br/>world = geopandas.read_file(geopandas.datasets.get_path('naturalearth_lowres'))<br/>ax = world.plot(color=(25/255,211/255,243/255) ,edgecolor=(25/255,211/255,243/255),<br/>                    linewidth=0.4,edgecolors='none',figsize=(15, 15))<br/>ax.axis('off')   <br/>gdf.plot(ax=ax,alpha=0.5,marker=".",markersize=df_locations['count']*100,color='seagreen')</span></pre><p id="e30f" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">å¦‚æœä½ ç†Ÿæ‚‰è¿™æœ¬ä¹¦ï¼Œä½ ä¼šæ„è¯†åˆ°æˆ‘ä»¬å‡ ä¹æç»˜äº†ç¦æ ¼åœ¨ä»–è‘—åçš„æ—…ç¨‹ä¸­æ‰€èµ°çš„å®é™…è·¯çº¿ã€‚</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es lz"><img src="../Images/c7e8f8614232ff12f293995b2685a293.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*jM8UmQYw5hAqcEoV.png"/></div></div></figure><p id="eb45" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">ä½œä¸ºå‚è€ƒï¼Œä¸‹é¢æ˜¯ä»–ä»ç»´åŸºç™¾ç§‘ä¸Šæˆªå–çš„å®é™…è·¯çº¿çš„å›¾ç‰‡</p><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es ma"><img src="../Images/53209d7243962798057c59962208ac88.png" data-original-src="https://miro.medium.com/v2/resize:fit:1024/format:webp/0*GkZC0VxBvf0nO6WK.png"/></div></figure><p id="6336" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">å…«åå¤©ç¯æ¸¸ä¸–ç•Œåœ°å›¾</p><p id="68b8" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><a class="ae jc" href="https://commons.wikimedia.org/wiki/File:Around_the_World_in_Eighty_Days_map.png" rel="noopener ugc nofollow" target="_blank"> Roke </a>ï¼Œ<a class="ae jc" href="https://creativecommons.org/licenses/by-sa/3.0/" rel="noopener ugc nofollow" target="_blank"> CC BY-SA 3.0 </a>ï¼Œé€šè¿‡ç»´åŸºå…±äº«</p><h1 id="1db7" class="jq jr hh bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">åˆ›å»ºä¸€ä¸ªç¦æ ¼æ—…é€”ä¸­æºå¸¦ç‰©å“çš„å•è¯äº‘</h1><p id="e142" class="pw-post-body-paragraph ie if hh ig b ih ko ij ik il kp in io ip kq ir is it kr iv iw ix ks iz ja jb ha bi translated">ä¸‹é¢çš„ä»£ç ä½¿ç”¨â€œæå–é—®é¢˜å›ç­”â€æ‰¾åˆ°æ—…è¡Œè€…æºå¸¦çš„æœ€å¸¸è§çš„ç‰©å“ï¼Œå¹¶åˆ›å»ºä¸€ä¸ªå•è¯äº‘ã€‚</p><pre class="je jf jg jh fd kt ku kv kw aw kx bi"><span id="c816" class="ky jr hh ku b fi kz la l lb lc">from wordcloud import WordCloud, STOPWORDS<br/>import matplotlib.pyplot as plt<br/>from matplotlib.pyplot import figure</span><span id="0ec0" class="ky jr hh ku b fi ld la l lb lc">figure(figsize=(12, 6), dpi=120)<br/>wordcloud = WordCloud(background_color=â€™whiteâ€™,width=1024,height=500).generate(â€˜ â€˜.join(output.filter(â€œ`answer` != â€˜nullâ€™â€).toPandas()[â€˜answerâ€™].tolist()))<br/>plt.imshow(wordcloud)<br/>plt.axis(â€œoffâ€)<br/>plt.show()</span></pre><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es mb"><img src="../Images/c30c84e0ea50f33524d0023aff05a4c3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*EcZf1yB7oPDJmzsc.png"/></div></div></figure><h1 id="754a" class="jq jr hh bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">ç»“è®º</h1><p id="8f60" class="pw-post-body-paragraph ie if hh ig b ih ko ij ik il kp in io ip kq ir is it kr iv iw ix ks iz ja jb ha bi translated">PySparkæ˜¯æ•°æ®ç§‘å­¦å®¶å’ŒMLå®è·µè€…æœ€å–œæ¬¢çš„å·¥å…·çš„åŸå› ä¹‹ä¸€æ˜¯å› ä¸ºä½¿ç”¨æ•°æ®æ¡†æ¶éå¸¸æ–¹ä¾¿ã€‚æœ¬æ–‡å±•ç¤ºäº†å¦‚ä½•ä½¿ç”¨PySparkåœ¨Sparké›†ç¾¤ä¸Šè¿è¡ŒNlphoseã€‚ä½¿ç”¨æœ¬æ–‡æè¿°çš„æ–¹æ³•ï¼Œæˆ‘ä»¬å¯ä»¥éå¸¸å®¹æ˜“åœ°å°†Nlphoseç®¡é“ä½œä¸ºæ•°æ®å¤„ç†ç®¡é“çš„ä¸€éƒ¨åˆ†åµŒå…¥ã€‚å¸Œæœ›ä½ å–œæ¬¢è¿™ç¯‡æ–‡ç« ã€‚éšæ—¶æ¬¢è¿åé¦ˆå’Œè¯„è®ºï¼Œè°¢è°¢ï¼</p><div class="mc md ez fb me mf"><a rel="noopener follow" target="_blank" href="/mlearning-ai/mlearning-ai-submission-suggestions-b51e2b130bfb"><div class="mg ab dw"><div class="mh ab mi cl cj mj"><h2 class="bd hi fi z dy mk ea eb ml ed ef hg bi translated">Mlearning.aiæäº¤å»ºè®®</h2><div class="mm l"><h3 class="bd b fi z dy mk ea eb ml ed ef dx translated">å¦‚ä½•æˆä¸ºMlearning.aiä¸Šçš„ä½œå®¶</h3></div><div class="mn l"><p class="bd b fp z dy mk ea eb ml ed ef dx translated">medium.com</p></div></div><div class="mo l"><div class="mp l mq mr ms mo mt jn mf"/></div></div></a></div></div></div>    
</body>
</html>