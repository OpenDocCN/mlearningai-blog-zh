<html>
<head>
<title>Understanding TorchServe’s BaseHandler</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">了解TorchServe的BaseHandler</h1>
<blockquote>原文：<a href="https://medium.com/mlearning-ai/understanding-torchserves-basehandler-4d139d12b5f9?source=collection_archive---------4-----------------------#2022-10-10">https://medium.com/mlearning-ai/understanding-torchserves-basehandler-4d139d12b5f9?source=collection_archive---------4-----------------------#2022-10-10</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><div class=""><h2 id="2744" class="pw-subtitle-paragraph ie hg hh bd b if ig ih ii ij ik il im in io ip iq ir is it iu iv dx translated">部署PyTorch模型的Torchserve第二部分</h2></div><figure class="ix iy iz ja fd jb er es paragraph-image"><div role="button" tabindex="0" class="jc jd di je bf jf"><div class="er es iw"><img src="../Images/5631b5b7105b4ccae4df5f634273f333.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Tuhq4wOsZ4cF1NcB"/></div></div><figcaption class="ji jj et er es jk jl bd b be z dx">Photo by <a class="ae jm" href="https://unsplash.com/@xoforoct?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">EJ Strat</a> on <a class="ae jm" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="f1a0" class="pw-post-body-paragraph jn jo hh jp b jq jr ii js jt ju il jv jw jx jy jz ka kb kc kd ke kf kg kh ki ha bi translated">这是一个系列的第二篇文章，我们试图熟悉TorchServe。在第一篇文章中，我们学习了在给定默认设置的情况下使用TorchServe部署模型的工作流程。主要步骤是创建一个”。mar”文件，使用命令<a class="ae jm" href="https://github.com/pytorch/serve/blob/master/model-archiver/README.md" rel="noopener ugc nofollow" target="_blank"> torch-model-archiver </a>。这个文件包含了我们部署模型所需的所有信息。我们需要在此包含一个文件”。mar”文件是<em class="kj">处理程序</em>，它包含我们进行预测所需的关于预处理、推理和后处理的所有信息。在之前的帖子中，我们使用了默认的处理程序<em class="kj"> ImageClassifier </em>，它可以用于在ImageNet上训练的图像分类问题，并预测至少5个类。更多详情，请看这里:</p><div class="kk kl ez fb km kn"><a rel="noopener follow" target="_blank" href="/mlearning-ai/understanding-the-workflow-of-torchserve-using-densenet-c4d93458c19"><div class="ko ab dw"><div class="kp ab kq cl cj kr"><h2 class="bd hi fi z dy ks ea eb kt ed ef hg bi translated">🔥使用Densenet了解TorchServe的工作流程</h2><div class="ku l"><h3 class="bd b fi z dy ks ea eb kt ed ef dx translated">部署PyTorch模型的TorchServe第一部分</h3></div><div class="kv l"><p class="bd b fp z dy ks ea eb kt ed ef dx translated">medium.com</p></div></div><div class="kw l"><div class="kx l ky kz la kw lb jg kn"/></div></div></a></div><p id="67f8" class="pw-post-body-paragraph jn jo hh jp b jq jr ii js jt ju il jv jw jx jy jz ka kb kc kd ke kf kg kh ki ha bi translated">然而，在大多数应用程序中，我们需要定义一个定制的处理程序脚本。TorchServe提供了一个名为<em class="kj"> BaseHandler </em>的类，其中的预处理、推理和后处理步骤是针对默认设置进行处理的。为了部署我们自己的模型，我们可以创建自己的处理程序类，它继承自BaseHandler。我们只改变必要的部分。为此，这篇文章只致力于BaseHandler类和理解它做什么。<a class="ae jm" href="https://github.com/pytorch/serve/blob/master/ts/torch_handler/base_handler.py" rel="noopener ugc nofollow" target="_blank"> <em class="kj"> BaseHandler </em> </a>的完整代码可以在<a class="ae jm" href="https://github.com/pytorch/serve/blob/master/ts/torch_handler/base_handler.py" rel="noopener ugc nofollow" target="_blank"> GitHub </a>上找到。在这里，我们将只查看需要定制的部分。该课程的结构如下:</p><figure class="ix iy iz ja fd jb er es paragraph-image"><div role="button" tabindex="0" class="jc jd di je bf jf"><div class="er es lc"><img src="../Images/dec17b16e747493db0a0ee4391487394.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4hAKUSTmVHw_oBPxpzNcoQ.png"/></div></div></figure><p id="19db" class="pw-post-body-paragraph jn jo hh jp b jq jr ii js jt ju il jv jw jx jy jz ka kb kc kd ke kf kg kh ki ha bi translated">类包含更多的方法，但通常情况下，我们只需要关心<em class="kj">预处理</em>、<em class="kj">推理、</em>和<em class="kj">后处理</em>方法，当然还有在<em class="kj"> __init__ </em>方法中初始化额外的变量。让我们更详细地看看上面的方法。</p><h2 id="6ac3" class="ld le hh bd lf lg lh li lj lk ll lm ln jw lo lp lq ka lr ls lt ke lu lv lw lx bi translated">__init__</h2><p id="8eb7" class="pw-post-body-paragraph jn jo hh jp b jq ly ii js jt lz il jv jw ma jy jz ka mb kc kd ke mc kg kh ki ha bi translated">一如既往，在这一部分中，定义了所需的变量。一些重要的是:模型、映射和上下文:</p><figure class="ix iy iz ja fd jb er es paragraph-image"><div role="button" tabindex="0" class="jc jd di je bf jf"><div class="er es md"><img src="../Images/18e7e85aa8e6d31f51e54e7cd5716f3d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0o9aC4PFaB07IiwXLwNRKw.png"/></div></div><figcaption class="ji jj et er es jk jl bd b be z dx">Some important initialized variables in the base handler</figcaption></figure><p id="c031" class="pw-post-body-paragraph jn jo hh jp b jq jr ii js jt ju il jv jw jx jy jz ka kb kc kd ke kf kg kh ki ha bi translated">在这里，我们可能会额外添加转换或我们的模型需要的任何东西。</p><h2 id="e22e" class="ld le hh bd lf lg lh li lj lk ll lm ln jw lo lp lq ka lr ls lt ke lu lv lw lx bi translated">初始化</h2><p id="3141" class="pw-post-body-paragraph jn jo hh jp b jq ly ii js jt lz il jv jw ma jy jz ka mb kc kd ke mc kg kh ki ha bi translated">该方法加载model.pt文件，并将其设置为<a class="ae jm" href="https://www.tutorialexample.com/an-introduction-to-pytorch-model-eval-for-beginners-pytorch-tutorial/" rel="noopener ugc nofollow" target="_blank"> <em class="kj"> eval-mode </em> </a>。首先，它尝试加载<a class="ae jm" href="https://pytorch.org/docs/stable/jit.html" rel="noopener ugc nofollow" target="_blank"> <em class="kj"> torchscript </em> </a>否则它加载基于<em class="kj"> state_dict </em>的模型。作为输入，它获取<a class="ae jm" href="https://pytorch.org/serve/_modules/ts/context.html" rel="noopener ugc nofollow" target="_blank"> <em class="kj">上下文</em> </a> -json文件，其中包含加载模型所需的所有信息，例如它的位置。当model.py文件丢失时，它会引发错误。它还设置了<a class="ae jm" href="https://pytorch.org/docs/stable/generated/torch.cuda.device.html" rel="noopener ugc nofollow" target="_blank"><em class="kj"/></a>和<a class="ae jm" href="https://pytorch.org/docs/stable/generated/torch.load.html" rel="noopener ugc nofollow" target="_blank"><em class="kj">map _ location</em></a><em class="kj"/>变量。</p><h2 id="ab65" class="ld le hh bd lf lg lh li lj lk ll lm ln jw lo lp lq ka lr ls lt ke lu lv lw lx bi translated">预处理</h2><p id="ae4e" class="pw-post-body-paragraph jn jo hh jp b jq ly ii js jt lz il jv jw ma jy jz ka mb kc kd ke mc kg kh ki ha bi translated">在这种方法中，定义了在应用模型之前需要对数据执行的预处理步骤。作为输入，它以列表的形式获取数据，并以张量的形式返回预处理后的数据。这些步骤需要定制！</p><h2 id="5762" class="ld le hh bd lf lg lh li lj lk ll lm ln jw lo lp lq ka lr ls lt ke lu lv lw lx bi translated">推理</h2><p id="5829" class="pw-post-body-paragraph jn jo hh jp b jq ly ii js jt lz il jv jw ma jy jz ka mb kc kd ke mc kg kh ki ha bi translated">在这种方法中，应用模型并创建实际预测。它接收预处理函数返回的数据。这应该与模型输入形状相匹配。预测以张量的形式返回。</p><h2 id="5c45" class="ld le hh bd lf lg lh li lj lk ll lm ln jw lo lp lq ka lr ls lt ke lu lv lw lx bi translated">后处理</h2><p id="252f" class="pw-post-body-paragraph jn jo hh jp b jq ly ii js jt lz il jv jw ma jy jz ka mb kc kd ke mc kg kh ki ha bi translated">该方法接收从推理函数返回的预测作为输入数据。然后，它将模型的实际输出创建为一个列表。这些步骤需要定制！</p><p id="91e0" class="pw-post-body-paragraph jn jo hh jp b jq jr ii js jt ju il jv jw jx jy jz ka kb kc kd ke kf kg kh ki ha bi translated">👉在下一篇文章中，我们将使用这个BaseHandler并为<a class="ae jm" href="http://yann.lecun.com/exdb/mnist/" rel="noopener ugc nofollow" target="_blank"> MNIST </a>数据集定制它来预测手写数字。👀</p><div class="kk kl ez fb km kn"><a rel="noopener follow" target="_blank" href="/@pumalinML/use-torchserve-with-a-customized-handler-script-f7d329e78ba4"><div class="ko ab dw"><div class="kp ab kq cl cj kr"><h2 class="bd hi fi z dy ks ea eb kt ed ef hg bi translated">🔥使用带有自定义处理程序脚本的TorchServe</h2><div class="ku l"><h3 class="bd b fi z dy ks ea eb kt ed ef dx translated">部署PyTorch模型的Torchserve第三部分</h3></div><div class="kv l"><p class="bd b fp z dy ks ea eb kt ed ef dx translated">medium.com</p></div></div><div class="kw l"><div class="me l ky kz la kw lb jg kn"/></div></div></a></div><h2 id="be14" class="ld le hh bd lf lg lh li lj lk ll lm ln jw lo lp lq ka lr ls lt ke lu lv lw lx bi translated">进一步阅读</h2><ul class=""><li id="c0d4" class="mf mg hh jp b jq ly jt lz jw mh ka mi ke mj ki mk ml mm mn bi translated"><a class="ae jm" href="https://cceyda.github.io/blog/torchserve/streamlit/dashboard/2020/10/15/torchserve.html" rel="noopener ugc nofollow" target="_blank">https://ccey da . github . io/blog/torch serve/streamlit/dashboard/2020/10/15/torch serve . html</a></li></ul><div class="kk kl ez fb km kn"><a rel="noopener follow" target="_blank" href="/@frauke.albrecht/subscribe"><div class="ko ab dw"><div class="kp ab kq cl cj kr"><h2 class="bd hi fi z dy ks ea eb kt ed ef hg bi translated">每当弗劳克·阿尔布雷特出版时，就收到一封电子邮件。</h2><div class="ku l"><h3 class="bd b fi z dy ks ea eb kt ed ef dx translated">每当弗劳克·阿尔布雷特出版时，就收到一封电子邮件。通过注册，您将创建一个中型帐户，如果您还没有…</h3></div><div class="kv l"><p class="bd b fp z dy ks ea eb kt ed ef dx translated">medium.com</p></div></div><div class="kw l"><div class="mo l ky kz la kw lb jg kn"/></div></div></a></div><div class="kk kl ez fb km kn"><a rel="noopener follow" target="_blank" href="/@frauke.albrecht/subscribe"><div class="ko ab dw"><div class="kp ab kq cl cj kr"><h2 class="bd hi fi z dy ks ea eb kt ed ef hg bi translated">每当弗劳克·阿尔布雷特出版时，就收到一封电子邮件。</h2><div class="ku l"><h3 class="bd b fi z dy ks ea eb kt ed ef dx translated">每当弗劳克·阿尔布雷特出版时，就收到一封电子邮件。通过注册，您将创建一个中型帐户，如果您还没有…</h3></div><div class="kv l"><p class="bd b fp z dy ks ea eb kt ed ef dx translated">medium.com</p></div></div><div class="kw l"><div class="mo l ky kz la kw lb jg kn"/></div></div></a></div><div class="kk kl ez fb km kn"><a rel="noopener follow" target="_blank" href="/mlearning-ai/mlearning-ai-submission-suggestions-b51e2b130bfb"><div class="ko ab dw"><div class="kp ab kq cl cj kr"><h2 class="bd hi fi z dy ks ea eb kt ed ef hg bi translated">Mlearning.ai提交建议</h2><div class="ku l"><h3 class="bd b fi z dy ks ea eb kt ed ef dx translated">如何成为Mlearning.ai上的作家</h3></div><div class="kv l"><p class="bd b fp z dy ks ea eb kt ed ef dx translated">medium.com</p></div></div><div class="kw l"><div class="mp l ky kz la kw lb jg kn"/></div></div></a></div></div></div>    
</body>
</html>