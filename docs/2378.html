<html>
<head>
<title>Migrating an Sklearn model training Pipeline to Tensorflow Keras.</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">将Sklearn模型训练管道迁移到Tensorflow Keras。</h1>
<blockquote>原文：<a href="https://medium.com/mlearning-ai/migrating-an-sklearn-model-training-pipeline-to-tensorflow-keras-d248754f991d?source=collection_archive---------0-----------------------#2022-04-24">https://medium.com/mlearning-ai/migrating-an-sklearn-model-training-pipeline-to-tensorflow-keras-d248754f991d?source=collection_archive---------0-----------------------#2022-04-24</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><figure class="ev ex if ig ih ii er es paragraph-image"><div class="er es ie"><img src="../Images/c2d99b7b91ca3fa1534b01e24e450101.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tAOraGyTG26uLs7HGxSQkw.png"/></div><figcaption class="il im et er es in io bd b be z dx">Image source: <a class="ae ip" rel="noopener" href="/towards-data-science/from-scikit-learn-to-tensorflow-part-1-9ee0b96d4c85">https://medium.com/towards-data-science/from-scikit-learn-to-tensorflow-part-1-9ee0b96d4c85</a></figcaption></figure><p id="d2f9" class="pw-post-body-paragraph iq ir hh is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn ha bi translated">在本帖中，我们将探讨将Sklearn培训管道迁移到Tensorflow Keras的方法。从Sklearn转到Tensorflow可能有几个原因。</p><h2 id="daab" class="jo jp hh bd jq jr js jt ju jv jw jx jy jb jz ka kb jf kc kd ke jj kf kg kh ki bi translated">可能的好处:</h2><ul class=""><li id="64ed" class="kj kk hh is b it kl ix km jb kn jf ko jj kp jn kq kr ks kt bi translated">基本上任何ML模型架构的灵活性。</li><li id="a508" class="kj kk hh is b it ku ix kv jb kw jf kx jj ky jn kq kr ks kt bi translated">利用GPU的分布式培训。</li><li id="4ab7" class="kj kk hh is b it ku ix kv jb kw jf kx jj ky jn kq kr ks kt bi translated">再培训的灵活性。</li><li id="d5dd" class="kj kk hh is b it ku ix kv jb kw jf kx jj ky jn kq kr ks kt bi translated">Tensorflow服务。</li><li id="6f6a" class="kj kk hh is b it ku ix kv jb kw jf kx jj ky jn kq kr ks kt bi translated">等等。</li></ul><h2 id="32df" class="jo jp hh bd jq jr js jt ju jv jw jx jy jb jz ka kb jf kc kd ke jj kf kg kh ki bi translated">目标</h2><ul class=""><li id="084b" class="kj kk hh is b it kl ix km jb kn jf ko jj kp jn kq kr ks kt bi translated">我们将与Sklearn一起实现一个模型训练管道。</li><li id="aa36" class="kj kk hh is b it ku ix kv jb kw jf kx jj ky jn kq kr ks kt bi translated">仅使用Tensorflow Keras模块实现相同的管道。这里将使用预处理层。</li><li id="8146" class="kj kk hh is b it ku ix kv jb kw jf kx jj ky jn kq kr ks kt bi translated">将<strong class="is hi"> EasyFlow </strong>用于等效管道，如Sklearn的管道和ColumnTransformer模块。</li></ul><p id="25d7" class="pw-post-body-paragraph iq ir hh is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn ha bi translated">可能最常见的用例来自于设计一个ML管道，其中预处理在Sklearn中实现，模型在Keras中实现。我们将有不同的工件的每一部分。有了Keras和EasyFlow模块，实现一个本地Keras解决方案将变得很容易。</p><p id="33c2" class="pw-post-body-paragraph iq ir hh is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn ha bi translated">对于我们的数据集，我们将使用流行的心脏数据集。它由混合的特征类型组成，如编码为整数和字符串的数字、分类特征。</p><figure class="kz la lb lc fd ii"><div class="bz dy l di"><div class="ld le l"/></div></figure><p id="ba4c" class="pw-post-body-paragraph iq ir hh is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn ha bi translated">让我们建立我们的Sklearn培训渠道:</p><figure class="kz la lb lc fd ii"><div class="bz dy l di"><div class="ld le l"/></div></figure><p id="06d8" class="pw-post-body-paragraph iq ir hh is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn ha bi translated">上面的管道不是很复杂，很容易实现。这里的想法是展示我们如何在Tensorflow Keras中实现一个等价的管道。</p></div><div class="ab cl lf lg go lh" role="separator"><span class="li bw bk lj lk ll"/><span class="li bw bk lj lk ll"/><span class="li bw bk lj lk"/></div><div class="ha hb hc hd he"><h1 id="e7a8" class="lm jp hh bd jq ln lo lp ju lq lr ls jy lt lu lv kb lw lx ly ke lz ma mb kh mc bi translated">将Sklearn管道迁移到Tensorflow Keras</h1><p id="4d11" class="pw-post-body-paragraph iq ir hh is b it kl iv iw ix km iz ja jb md jd je jf me jh ji jj mf jl jm jn ha bi translated">让我们在Keras中本地创建我们的特征预处理管道。我们将复制Sklearn部分中实现的相同管道。Keras最近增加了预处理层。<strong class="is hi">标准缩放器</strong>和<strong class="is hi"> OneHotEncoder </strong>的Keras等效预处理分别为<strong class="is hi">归一化</strong>和<strong class="is hi">整数查找</strong>。当我们的分类特征是字符串类型时，我们首先需要应用StringLookup预处理层，然后是IntegerLookup层。</p><p id="18fe" class="pw-post-body-paragraph iq ir hh is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn ha bi translated">我们最不需要的是管道和ColumnTransformer的Keras实现。目前在Keras中没有实现，所以我们将使用另一个包来实现:</p><p id="328c" class="pw-post-body-paragraph iq ir hh is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn ha bi translated"><code class="du mg mh mi mj b">EasyFlow</code>:<a class="ae ip" href="https://pypi.org/project/easy-tensorflow/" rel="noopener ugc nofollow" target="_blank">https://pypi.org/project/easy-tensorflow/</a></p><p id="7869" class="pw-post-body-paragraph iq ir hh is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn ha bi translated"><strong class="is hi"> <em class="mk"> pip安装简易张量流</em> </strong></p><p id="a71e" class="pw-post-body-paragraph iq ir hh is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn ha bi translated"><strong class="is hi"> EasyFlow </strong>利用Keras预处理层。在<strong class="is hi"> EasyFlow </strong>中的所有高级管道，如<strong class="is hi"> FeatureUnion </strong>都包含tf.keras.layers.Layer的子类，因此其行为类似于任何其他keras层。(<strong class="is hi"> FeatureUnion </strong>相当于Sklearn的<strong class="is hi"> ColumnTransformer </strong>。</p><figure class="kz la lb lc fd ii"><div class="bz dy l di"><div class="ld le l"/></div></figure><p id="1874" class="pw-post-body-paragraph iq ir hh is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn ha bi translated">我们将利用Keras功能API。所以我们首先需要创建一个要素输入层。下面我们有一个数据类型映射字典作为<strong class="is hi"> FeatureInputLayer的输入。</strong>接下来我们将使用EasyFlow模块中的<strong class="is hi"> FeatureUnion </strong>来实现类似于ColumnTransformer的预处理管道。我们将通过对我们的数据运行<em class="mk"> adapt </em>方法来更新预处理层状态。Keras预处理层使用<em class="mk">。</em><a class="ae ip" href="https://gist.github.com/fernandonieuwveldt/ebb5a67415f462f1aa09ebd2913eca1a" rel="noopener ugc nofollow" target="_blank"><strong class="is hi"><em class="mk">adap</em></strong></a><strong class="is hi"><em class="mk">t</em></strong><em class="mk"/>来更新状态，在这种情况下类似于<em class="mk">。</em> <strong class="is hi"> <em class="mk">合体</em> </strong>。</p><figure class="kz la lb lc fd ii"><div class="bz dy l di"><div class="ld le l"/></div></figure><p id="5476" class="pw-post-body-paragraph iq ir hh is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn ha bi translated">如上所述，EasyFlow中的FeatureUnion和所有其他管道都是Keras层，也是可调用的。下面我们设置我们的模型。</p><figure class="kz la lb lc fd ii"><div class="bz dy l di"><div class="ld le l"/></div></figure><p id="358d" class="pw-post-body-paragraph iq ir hh is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn ha bi translated">结果类似于Sklearn的结果。</p><figure class="kz la lb lc fd ii"><div class="bz dy l di"><div class="ld le l"/></div></figure><p id="27f4" class="pw-post-body-paragraph iq ir hh is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn ha bi translated">就是这样！通过利用预处理层和EasyFlow的特征预处理管道，我们成功地将Sklearn训练管道移植到Tensorflow Keras。我们还持久化了模型，并加载它进行推理，以展示它是真正的端到端。该结果与我们的Sklearn实现相比较。这里的一个巨大优势是预处理是网络的一部分，并以此方式持续存在。没有Keras预处理层和EasyFlow的管道实现，我们通常有一个单独的Sklearn工件用于预处理。使用Sklearn进行预处理，然后将数据提供给Keras模型，这曾经是一种常见的设计模式。Tensorflow serving等服务容器无需安装python或Tensorflow就可以为我们的模型提供服务，这使得迁移到本机Tensorflow Keras实现非常有吸引力。你只需要一个保存的模型。</p><p id="854e" class="pw-post-body-paragraph iq ir hh is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn ha bi translated">我们可以更进一步提高我们的训练速度。参见下一节。</p></div><div class="ab cl lf lg go lh" role="separator"><span class="li bw bk lj lk ll"/><span class="li bw bk lj lk ll"/><span class="li bw bk lj lk"/></div><div class="ha hb hc hd he"><h1 id="31bb" class="lm jp hh bd jq ln lo lp ju lq lr ls jy lt lu lv kb lw lx ly ke lz ma mb kh mc bi translated">提高Keras训练速度的快速笔记。</h1><p id="edcd" class="pw-post-body-paragraph iq ir hh is b it kl iv iw ix km iz ja jb md jd je jf me jh ji jj mf jl jm jn ha bi translated">接下来，我们将通过创建1)应用预处理步骤的Keras模型对象和2)进行训练以加速过程的Keras模型对象，使用通用模式进行训练。当我们从例子中的原始数据开始时。我们需要预处理CPU上的所有预处理操作，然后将数据馈送到GPU。预处理也不是我们训练的内容，它独立于前向传递。这将降低我们的吞吐量，因为GPU在等待数据时将处于空闲状态。为了加快速度，我们将预取批量预处理数据。这将确保当我们在GPU上处理一批数据时，CPU正在准备下一批预处理数据。</p><figure class="kz la lb lc fd ii er es paragraph-image"><div role="button" tabindex="0" class="mm mn di mo bf mp"><div class="er es ml"><img src="../Images/f75eb1957405675679f9c8fc963a34bd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Vrxz6GDA4TKSUMnEKKFHpQ.png"/></div></div><figcaption class="il im et er es in io bd b be z dx"><em class="mq">Image taken from </em><a class="ae ip" href="https://www.tensorflow.org/" rel="noopener ugc nofollow" target="_blank"><em class="mq">https://www.tensorflow.org</em></a></figcaption></figure><p id="1ec2" class="pw-post-body-paragraph iq ir hh is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn ha bi translated">下面我们实现一个预处理模型和一个训练模型:</p><figure class="kz la lb lc fd ii"><div class="bz dy l di"><div class="ld le l"/></div></figure><p id="efb2" class="pw-post-body-paragraph iq ir hh is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn ha bi translated">接下来，我们将Pandas数据框映射到tf.data.Dataset类型。上述预处理模型将被映射到我们的特征数据上:</p><figure class="kz la lb lc fd ii"><div class="bz dy l di"><div class="ld le l"/></div></figure><p id="8740" class="pw-post-body-paragraph iq ir hh is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn ha bi translated">这与我们在上一节中的实现给出了相似的结果，但是速度更快。</p><p id="d6b4" class="pw-post-body-paragraph iq ir hh is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn ha bi translated">我们需要最后一步来创建一个可用于推理的模型。因为我们将模型分成了预处理和训练步骤，所以我们不能保存training_model。我们需要将预处理和训练合并到一个模型中。让我们创建我们的推理模型。</p><figure class="kz la lb lc fd ii"><div class="bz dy l di"><div class="ld le l"/></div></figure><p id="d192" class="pw-post-body-paragraph iq ir hh is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn ha bi translated">总之，我们展示了如何将Sklearn培训管道迁移到Tensorflow和Keras。我们首先在Sklearn中构建了由预处理步骤组成的训练管道，并使用LogisticRegression作为我们的估计器。我们使用相同的Sklearn管道，并使用预处理层和EasyFlow管道模块将其迁移到Keras。我们的模型架构是一个简单的线性模型(LogisticRegression equivalent ),没有隐藏层。我们的特征预处理是我们的网络架构的一部分，我们保存并加载模型以应用推理。我们以最后一节结束，这一节讨论了通过分割训练的预处理和建模步骤来提高训练速度。最后，我们将预处理添加回训练模型，以创建我们的推理模型。</p><p id="e359" class="pw-post-body-paragraph iq ir hh is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn ha bi translated"><strong class="is hi"> <em class="mk"> Google Colab笔记本</em> </strong> : <a class="ae ip" href="https://colab.research.google.com/github/fernandonieuwveldt/easyflow/blob/develop/examples/migrating_from_sklearn_to_keras/migrate_sklearn_pipeline.ipynb" rel="noopener ugc nofollow" target="_blank">笔记本链接</a></p><p id="f682" class="pw-post-body-paragraph iq ir hh is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn ha bi translated"><strong class="is hi"> <em class="mk">参考文献:</em></strong><a class="ae ip" href="https://pypi.org/project/easy-tensorflow/" rel="noopener ugc nofollow" target="_blank">https://pypi.org/project/easy-tensorflow/</a></p><p id="9323" class="pw-post-body-paragraph iq ir hh is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn ha bi translated"><strong class="is hi"> <em class="mk"> Github回购</em></strong>:<a class="ae ip" href="https://github.com/fernandonieuwveldt/easyflow" rel="noopener ugc nofollow" target="_blank">https://github.com/fernandonieuwveldt/easyflow</a></p><div class="mr ms ez fb mt mu"><a rel="noopener follow" target="_blank" href="/mlearning-ai/mlearning-ai-submission-suggestions-b51e2b130bfb"><div class="mv ab dw"><div class="mw ab mx cl cj my"><h2 class="bd hi fi z dy mz ea eb na ed ef hg bi translated">Mlearning.ai提交建议</h2><div class="nb l"><h3 class="bd b fi z dy mz ea eb na ed ef dx translated">如何成为Mlearning.ai上的作家</h3></div><div class="nc l"><p class="bd b fp z dy mz ea eb na ed ef dx translated">medium.com</p></div></div><div class="nd l"><div class="ne l nf ng nh nd ni ij mu"/></div></div></a></div></div></div>    
</body>
</html>