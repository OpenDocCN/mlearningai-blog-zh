<html>
<head>
<title>A Beginner’s Guide to Data Pipelines with Tensorflow</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Tensorflow数据管道初学者指南</h1>
<blockquote>原文：<a href="https://medium.com/mlearning-ai/how-to-use-data-pipelines-with-python-a9b662fadec2?source=collection_archive---------0-----------------------#2021-08-27">https://medium.com/mlearning-ai/how-to-use-data-pipelines-with-python-a9b662fadec2?source=collection_archive---------0-----------------------#2021-08-27</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><div class=""><h2 id="25f0" class="pw-subtitle-paragraph ie hg hh bd b if ig ih ii ij ik il im in io ip iq ir is it iu iv dx translated">如何使用Tensorflow为文本、图像和numpy数组数据集构建数据管道？</h2></div><figure class="ix iy iz ja fd jb er es paragraph-image"><div role="button" tabindex="0" class="jc jd di je bf jf"><div class="er es iw"><img src="../Images/d1ec91eda6d6a5eeb60cf6c45063aca7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*OFmtGhO4gBRYUFHW"/></div></div><figcaption class="ji jj et er es jk jl bd b be z dx">Photo by <a class="ae jm" href="https://unsplash.com/@jeremybishop?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Jeremy Bishop</a> on <a class="ae jm" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="676e" class="pw-post-body-paragraph jn jo hh jp b jq jr ii js jt ju il jv jw jx jy jz ka kb kc kd ke kf kg kh ki ha bi translated">在构建模型时，将数据转换为适当的格式非常重要。数据分析中最重要的步骤之一是数据预处理。数据预处理占用了数据科学家的大部分时间。自动化数据预处理步骤简化了数据分析。数据管道是从不同来源获取原始数据并将数据移动到目的地进行加载、转换和分析的一系列步骤。</p><p id="631d" class="pw-post-body-paragraph jn jo hh jp b jq jr ii js jt ju il jv jw jx jy jz ka kb kc kd ke kf kg kh ki ha bi translated">在这篇文章中，我将讨论以下主题</p><ul class=""><li id="ef0b" class="kj kk hh jp b jq jr jt ju jw kl ka km ke kn ki ko kp kq kr bi translated">为文本数据集构建数据管道</li><li id="421b" class="kj kk hh jp b jq ks jt kt jw ku ka kv ke kw ki ko kp kq kr bi translated">为影像数据集构建数据管道</li><li id="4de6" class="kj kk hh jp b jq ks jt kt jw ku ka kv ke kw ki ko kp kq kr bi translated">为numpy数组数据集构建数据管道</li></ul><p id="3be8" class="pw-post-body-paragraph jn jo hh jp b jq jr ii js jt ju il jv jw jx jy jz ka kb kc kd ke kf kg kh ki ha bi translated">请不要忘记订阅<a class="ae jm" href="https://youtube.com/c/tirendazacademy" rel="noopener ugc nofollow" target="_blank">我们的youtube频道</a>，在那里我创建了关于人工智能、数据科学、机器学习和深度学习的内容。</p><p id="62e3" class="pw-post-body-paragraph jn jo hh jp b jq jr ii js jt ju il jv jw jx jy jz ka kb kc kd ke kf kg kh ki ha bi translated">让我们开始吧！</p><h1 id="a69e" class="kx ky hh bd kz la lb lc ld le lf lg lh in li io lj iq lk ir ll it lm iu ln lo bi translated">文本数据集的数据管道</h1><figure class="ix iy iz ja fd jb er es paragraph-image"><div role="button" tabindex="0" class="jc jd di je bf jf"><div class="er es lp"><img src="../Images/92eea9e8bcddb602d68519da3500ad8e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*_Y5uSlHBmieR7D8Z"/></div></div><figcaption class="ji jj et er es jk jl bd b be z dx">Photo by <a class="ae jm" href="https://unsplash.com/@rvignes?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Romain Vignes</a> on <a class="ae jm" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="b781" class="pw-post-body-paragraph jn jo hh jp b jq jr ii js jt ju il jv jw jx jy jz ka kb kc kd ke kf kg kh ki ha bi translated">要分析文本数据，您需要正确地组织目录结构。例如，您必须将训练文本组织成阳性和阴性，以进行如下文本分类:</p><pre class="ix iy iz ja fd lq lr ls lt aw lu bi"><span id="f813" class="lv ky hh lr b fi lw lx l ly lz">main_directory/<br/>....pos <br/>........pst1.txt <br/>........pst2.txt <br/>....neg <br/>........ngt1.txt <br/>........ngt2.txt</span></pre><p id="bbab" class="pw-post-body-paragraph jn jo hh jp b jq jr ii js jt ju il jv jw jx jy jz ka kb kc kd ke kf kg kh ki ha bi translated">您可以使用TensorFlow中的text_dataset_from_directory方法为文本数据集创建管道。这个方法将返回一个<code class="du ma mb mc lr b"><a class="ae jm" href="https://www.tensorflow.org/api_docs/python/tf/data/Dataset" rel="noopener ugc nofollow" target="_blank">tf.data.Dataset</a></code>，它给出了来自子目录pos和neg的一批文本。让我们想到互联网电影数据库(IMDB)数据集，将电影评论分为正面和负面。该数据集通常用于教授文本分析，由25，000条用于训练的高度极性电影评论和25，000条用于测试的电影评论组成。</p><h2 id="738b" class="lv ky hh bd kz md me mf ld mg mh mi lh jw mj mk lj ka ml mm ll ke mn mo ln mp bi translated">下载数据集</h2><p id="2f33" class="pw-post-body-paragraph jn jo hh jp b jq mq ii js jt mr il jv jw ms jy jz ka mt kc kd ke mu kg kh ki ha bi translated">首先，我来导入库。</p><pre class="ix iy iz ja fd lq lr ls lt aw lu bi"><span id="8f2e" class="lv ky hh lr b fi lw lx l ly lz">import io<br/>import os<br/>import re<br/>import shutil<br/>import string<br/>import tensorflow as tf</span></pre><p id="cdcd" class="pw-post-body-paragraph jn jo hh jp b jq jr ii js jt ju il jv jw jx jy jz ka kb kc kd ke kf kg kh ki ha bi translated">现在，我将加载IMDb数据集。如果你想直接下载，你可以使用get_file方法。get_file方法从一个URL下载一个不在缓存中的文件。为此，让我创建一个名为url的变量。</p><pre class="ix iy iz ja fd lq lr ls lt aw lu bi"><span id="7857" class="lv ky hh lr b fi lw lx l ly lz">url = "https://ai.stanford.edu/~amaas/data/sentiment/aclImdb_v1.tar.gz"</span></pre><p id="7237" class="pw-post-body-paragraph jn jo hh jp b jq jr ii js jt ju il jv jw jx jy jz ka kb kc kd ke kf kg kh ki ha bi translated">接下来，让我使用get_file方法，如下所示:</p><pre class="ix iy iz ja fd lq lr ls lt aw lu bi"><span id="e224" class="lv ky hh lr b fi lw lx l ly lz">data = tf.keras.utils.get_file(<br/>          "aclImdb_v1.tar.gz", <br/>          url,<br/>          untar=True, <br/>          cache_dir='.', <br/>          cache_subdir='')</span></pre><figure class="ix iy iz ja fd jb er es paragraph-image"><div class="er es mv"><img src="../Images/e35b5de0fafacd053051ca266de91d71.png" data-original-src="https://miro.medium.com/v2/resize:fit:1306/format:webp/1*WuajGNM0zRN2gs2t_HV46Q.png"/></div></figure><p id="7f88" class="pw-post-body-paragraph jn jo hh jp b jq jr ii js jt ju il jv jw jx jy jz ka kb kc kd ke kf kg kh ki ha bi translated">因此，数据集被下载，并在当前目录中创建了一个名为aclImdb的目录。我将创建一个变量，它代表这个文件路径。</p><pre class="ix iy iz ja fd lq lr ls lt aw lu bi"><span id="3373" class="lv ky hh lr b fi lw lx l ly lz">data_dir = os.path.join(os.path.dirname(data), 'aclImdb')</span></pre><p id="96d9" class="pw-post-body-paragraph jn jo hh jp b jq jr ii js jt ju il jv jw jx jy jz ka kb kc kd ke kf kg kh ki ha bi translated">让我们看看data_dir目录中train_dir的内部。</p><pre class="ix iy iz ja fd lq lr ls lt aw lu bi"><span id="d436" class="lv ky hh lr b fi lw lx l ly lz">train_dir = os.path.join(data_dir, 'train')<br/>os.listdir(train_dir)</span></pre><figure class="ix iy iz ja fd jb er es paragraph-image"><div role="button" tabindex="0" class="jc jd di je bf jf"><div class="er es mw"><img src="../Images/340a1a79b28b3d3f57db0415c38b3d01.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*sxHJgg8Lj5vkO-NYjKmxWg.png"/></div></div></figure><p id="3b8e" class="pw-post-body-paragraph jn jo hh jp b jq jr ii js jt ju il jv jw jx jy jz ka kb kc kd ke kf kg kh ki ha bi translated">如您所见，有一个名为unsup的目录。我不需要unsup目录。让我删除这个目录。</p><pre class="ix iy iz ja fd lq lr ls lt aw lu bi"><span id="3932" class="lv ky hh lr b fi lw lx l ly lz">unused_dir = os.path.join(train_dir, 'unsup')<br/>shutil.rmtree(unused_dir)</span></pre><p id="287b" class="pw-post-body-paragraph jn jo hh jp b jq jr ii js jt ju il jv jw jx jy jz ka kb kc kd ke kf kg kh ki ha bi translated">我要去看看train_dir。</p><pre class="ix iy iz ja fd lq lr ls lt aw lu bi"><span id="50ea" class="lv ky hh lr b fi lw lx l ly lz">os.listdir(train_dir)</span></pre><figure class="ix iy iz ja fd jb er es paragraph-image"><div role="button" tabindex="0" class="jc jd di je bf jf"><div class="er es mx"><img src="../Images/38c91cc1ba4d3d93dd4c389ff9e01a23.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*SCKXrp_q5uBI0CcuknJATg.png"/></div></div></figure><p id="cb5a" class="pw-post-body-paragraph jn jo hh jp b jq jr ii js jt ju il jv jw jx jy jz ka kb kc kd ke kf kg kh ki ha bi translated">如您所见，unsup已从数据目录中删除。确保只有目录名被用作标签。让我看看培训目录里的内容。</p><pre class="ix iy iz ja fd lq lr ls lt aw lu bi"><span id="a9c1" class="lv ky hh lr b fi lw lx l ly lz">ls aclImdb\train</span></pre><figure class="ix iy iz ja fd jb er es paragraph-image"><div role="button" tabindex="0" class="jc jd di je bf jf"><div class="er es my"><img src="../Images/1edfd45df4037dba92976638a3cf32c4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_3HFFZsztHgsrNz3hXFKIQ.png"/></div></div></figure><p id="7e99" class="pw-post-body-paragraph jn jo hh jp b jq jr ii js jt ju il jv jw jx jy jz ka kb kc kd ke kf kg kh ki ha bi translated">如你所见，有pos和neg目录。</p><h2 id="de66" class="lv ky hh bd kz md me mf ld mg mh mi lh jw mj mk lj ka ml mm ll ke mn mo ln mp bi translated">创建数据管道</h2><p id="3121" class="pw-post-body-paragraph jn jo hh jp b jq mq ii js jt mr il jv jw ms jy jz ka mt kc kd ke mu kg kh ki ha bi translated">现在我要创建一个管道。首先，让我创建一个batch_size和种子变量:</p><pre class="ix iy iz ja fd lq lr ls lt aw lu bi"><span id="ab9d" class="lv ky hh lr b fi lw lx l ly lz">batch_size = 1024<br/>seed = 123</span></pre><p id="6a2c" class="pw-post-body-paragraph jn jo hh jp b jq jr ii js jt ju il jv jw jx jy jz ka kb kc kd ke kf kg kh ki ha bi translated">批量大小使用在一次训练迭代中使用多少样本。我指定了seed参数来以相同的顺序传输文件。现在我将使用test_dataset_from_directory()方法创建一个数据管道。</p><pre class="ix iy iz ja fd lq lr ls lt aw lu bi"><span id="a305" class="lv ky hh lr b fi lw lx l ly lz">train_ds = tf.keras.preprocessing.text_dataset_from_directory(    <br/>    'aclImdb/train', <br/>    batch_size = batch_size, <br/>    validation_split=0.2, <br/>    subset='training', <br/>    seed=seed)</span></pre><figure class="ix iy iz ja fd jb er es paragraph-image"><div role="button" tabindex="0" class="jc jd di je bf jf"><div class="er es mz"><img src="../Images/a8d1a32cef49fa7e929652fc83235d82.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Wu2OY4c2Z5AOYO0uuA4Ddg.png"/></div></div></figure><p id="33d0" class="pw-post-body-paragraph jn jo hh jp b jq jr ii js jt ju il jv jw jx jy jz ka kb kc kd ke kf kg kh ki ha bi translated">所以我很容易地使用管道创建了训练数据集。为了微调超参数，我将使用一个验证数据集。让我们创建一个验证数据集。</p><pre class="ix iy iz ja fd lq lr ls lt aw lu bi"><span id="b4bb" class="lv ky hh lr b fi lw lx l ly lz">val_ds = tf.keras.preprocessing.text_dataset_from_directory( <br/>        'aclImdb/train', <br/>        batch_size=batch_size,   <br/>        validation_split=0.2, <br/>        subset='validation', <br/>        seed=seed)</span></pre><figure class="ix iy iz ja fd jb er es paragraph-image"><div role="button" tabindex="0" class="jc jd di je bf jf"><div class="er es na"><img src="../Images/da32d83dc113764820eaa5347cd5331e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pxPLDygOY22ARLnmes43Eg.png"/></div></div></figure><h2 id="b47b" class="lv ky hh bd kz md me mf ld mg mh mi lh jw mj mk lj ka ml mm ll ke mn mo ln mp bi translated">探索数据集</h2><p id="836d" class="pw-post-body-paragraph jn jo hh jp b jq mq ii js jt mr il jv jw ms jy jz ka mt kc kd ke mu kg kh ki ha bi translated">现在我将探究这些文件的内容。让我们在第一批中随机选择5行并打印出来。</p><pre class="ix iy iz ja fd lq lr ls lt aw lu bi"><span id="da9f" class="lv ky hh lr b fi lw lx l ly lz">import random<br/>idx = random.sample(range(1, batch_size), 5)<br/>for text_batch, label_batch in train_ds.take(1):<br/>    for i in idx:<br/>        print(label_batch[i].numpy(),      <br/>              text_batch.numpy()[i])</span></pre><figure class="ix iy iz ja fd jb er es paragraph-image"><div role="button" tabindex="0" class="jc jd di je bf jf"><div class="er es nb"><img src="../Images/b7d05ac39dcad748b6765c95add13e17.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dCLrD9PUJZq82Ztw6SvokQ.png"/></div></div></figure><figure class="ix iy iz ja fd jb er es paragraph-image"><div role="button" tabindex="0" class="jc jd di je bf jf"><div class="er es nc"><img src="../Images/a70877b87fa9f379c63426e56083a6b4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*26lcAkbng1cILbIELPQrsQ.png"/></div></div></figure><p id="b3e7" class="pw-post-body-paragraph jn jo hh jp b jq jr ii js jt ju il jv jw jx jy jz ka kb kc kd ke kf kg kh ki ha bi translated">在这一节中，我展示了如何使用管道处理文本数据集。如您所见，使用管道可以轻松完成数据预处理。</p><h1 id="7d8e" class="kx ky hh bd kz la lb lc ld le lf lg lh in li io lj iq lk ir ll it lm iu ln lo bi translated">图像数据集的数据管道</h1><figure class="ix iy iz ja fd jb er es paragraph-image"><div role="button" tabindex="0" class="jc jd di je bf jf"><div class="er es nd"><img src="../Images/06911694befc4be0a079faf40a4c7be2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*CaB84btm7IyrayVM"/></div></div><figcaption class="ji jj et er es jk jl bd b be z dx">Photo by <a class="ae jm" href="https://unsplash.com/@nowyouknowgini?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">virginia lackinger</a> on <a class="ae jm" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="7047" class="pw-post-body-paragraph jn jo hh jp b jq jr ii js jt ju il jv jw jx jy jz ka kb kc kd ke kf kg kh ki ha bi translated">您可以将管道用于图像模型，该模型可以从分布式文件系统中的文件聚合数据，对每个图像应用随机扰动，并将随机选择的图像合并到一个批处理中进行训练。</p><p id="72c9" class="pw-post-body-paragraph jn jo hh jp b jq jr ii js jt ju il jv jw jx jy jz ka kb kc kd ke kf kg kh ki ha bi translated">例如，在同一个文件中有多个图像。该文件包括两列:一列包含所有文件名，另一列包含标签。在这一节中，我将展示如何在同一个文件中处理图像数据集的数据管道。</p><p id="3c68" class="pw-post-body-paragraph jn jo hh jp b jq jr ii js jt ju il jv jw jx jy jz ka kb kc kd ke kf kg kh ki ha bi translated">为了展示如何为图像数据集创建管道，我将使用<a class="ae jm" href="https://data.mendeley.com/datasets/jxmfrvhpyz/1" rel="noopener ugc nofollow" target="_blank">花卉数据集</a>。我将数据集下载到工作目录中的flower_photos文件中。</p><h2 id="69ec" class="lv ky hh bd kz md me mf ld mg mh mi lh jw mj mk lj ka ml mm ll ke mn mo ln mp bi translated">探索数据集</h2><p id="e0eb" class="pw-post-body-paragraph jn jo hh jp b jq mq ii js jt mr il jv jw ms jy jz ka mt kc kd ke mu kg kh ki ha bi translated">让我导入库，这将在本节中使用。</p><pre class="ix iy iz ja fd lq lr ls lt aw lu bi"><span id="3a2f" class="lv ky hh lr b fi lw lx l ly lz">import tensorflow as tf<br/>import tensorflow_hub as hub<br/>import pandas as pd<br/>import numpy as np<br/>import matplotlib.pyplot as plt</span></pre><p id="de2f" class="pw-post-body-paragraph jn jo hh jp b jq jr ii js jt ju il jv jw jx jy jz ka kb kc kd ke kf kg kh ki ha bi translated">请注意，数据集有一个标签文件。我将使用熊猫图书馆查看它的内容。</p><pre class="ix iy iz ja fd lq lr ls lt aw lu bi"><span id="397c" class="lv ky hh lr b fi lw lx l ly lz">traindf=pd.read_csv(<br/>    'flower_photos/all_labels.csv',<br/>    dtype=str)<br/># Take a look first five fows of the dataset<br/>traindf.head()</span></pre><figure class="ix iy iz ja fd jb er es paragraph-image"><div class="er es ne"><img src="../Images/9c2f8ad03abed057602681e023e2f472.png" data-original-src="https://miro.medium.com/v2/resize:fit:1228/format:webp/1*ZPUctlPJZt3yAOHlHQ0CtQ.png"/></div></figure><h2 id="9e3f" class="lv ky hh bd kz md me mf ld mg mh mi lh jw mj mk lj ka ml mm ll ke mn mo ln mp bi translated">创建数据管道</h2><p id="2ddc" class="pw-post-body-paragraph jn jo hh jp b jq mq ii js jt mr il jv jw ms jy jz ka mt kc kd ke mu kg kh ki ha bi translated">让我们建立一个数据管道，将这些图像输入图像分类模型。为了构建模型，我将使用TensorFlow Hub中预先构建的ResNet模型。</p><p id="7b22" class="pw-post-body-paragraph jn jo hh jp b jq jr ii js jt ju il jv jw jx jy jz ka kb kc kd ke kf kg kh ki ha bi translated">现在我要创建一些超参数，稍后会用到。请注意，ResNet模型期望图像的像素尺寸为224*224，我需要确定批量大小。</p><pre class="ix iy iz ja fd lq lr ls lt aw lu bi"><span id="b9fe" class="lv ky hh lr b fi lw lx l ly lz">data_root = 'flower_photos/flowers'<br/>IMAGE_SIZE = (224, 224)<br/>TRAINING_DATA_DIR = str(data_root)<br/>BATCH_SIZE = 32</span></pre><p id="db22" class="pw-post-body-paragraph jn jo hh jp b jq jr ii js jt ju il jv jw jx jy jz ka kb kc kd ke kf kg kh ki ha bi translated">让我们标准化数据集，并为验证数据集保留20%的图像。让我用一个字典结构。</p><pre class="ix iy iz ja fd lq lr ls lt aw lu bi"><span id="42f0" class="lv ky hh lr b fi lw lx l ly lz">datagen_kwargs = dict(<br/>    rescale=1./255, <br/>    validation_split=.20)</span></pre><p id="ba89" class="pw-post-body-paragraph jn jo hh jp b jq jr ii js jt ju il jv jw jx jy jz ka kb kc kd ke kf kg kh ki ha bi translated">现在让我创建一个新变量，并将datagen_kwargs传递到这个变量中。</p><pre class="ix iy iz ja fd lq lr ls lt aw lu bi"><span id="0b7e" class="lv ky hh lr b fi lw lx l ly lz">dataflow_kwargs = dict(<br/>    target_size=IMAGE_SIZE,<br/>    batch_size=BATCH_SIZE, <br/>    interpolation="bilinear")</span></pre><p id="3aa7" class="pw-post-body-paragraph jn jo hh jp b jq jr ii js jt ju il jv jw jx jy jz ka kb kc kd ke kf kg kh ki ha bi translated">您可以使用ImageDataGenerator将这些图像流式传输到培训过程中。为此，我将定义一个生成器，并将datagen_kwargs传递给这个生成器。</p><pre class="ix iy iz ja fd lq lr ls lt aw lu bi"><span id="6aa4" class="lv ky hh lr b fi lw lx l ly lz">train_datagen =   tf.keras.preprocessing.image.ImageDataGenerator(<br/>**datagen_kwargs)</span></pre><p id="f384" class="pw-post-body-paragraph jn jo hh jp b jq jr ii js jt ju il jv jw jx jy jz ka kb kc kd ke kf kg kh ki ha bi translated">为了创建数据管道，我将使用flow_from_dataframe方法。</p><pre class="ix iy iz ja fd lq lr ls lt aw lu bi"><span id="bee9" class="lv ky hh lr b fi lw lx l ly lz">train_generator = train_datagen.flow_from_dataframe(<br/>    dataframe=traindf, <br/>    directory=data_root, <br/>    x_col="file_name", <br/>    y_col="label", <br/>    subset="training", <br/>    seed=10, shuffle=True, <br/>    class_mode="categorical", <br/>    **dataflow_kwargs)</span></pre><h2 id="0089" class="lv ky hh bd kz md me mf ld mg mh mi lh jw mj mk lj ka ml mm ll ke mn mo ln mp bi translated">检查数据集</h2><p id="582c" class="pw-post-body-paragraph jn jo hh jp b jq mq ii js jt mr il jv jw ms jy jz ka mt kc kd ke mu kg kh ki ha bi translated">让我展示数据集中的图像。</p><pre class="ix iy iz ja fd lq lr ls lt aw lu bi"><span id="d3c3" class="lv ky hh lr b fi lw lx l ly lz">image_batch, label_batch = next(iter(train_generator))<br/>fig, axes = plt.subplots(8, 4, figsize=(20, 40))<br/>axes = axes.flatten()<br/>for img, lbl, ax in zip(image_batch, label_batch, axes):<br/>    ax.imshow(img)<br/>    label_ = np.argmax(lbl)<br/>    label = idx_labels[label_]<br/>    ax.set_title(label)<br/>    ax.axis('off')<br/>    plt.show()</span></pre><figure class="ix iy iz ja fd jb er es paragraph-image"><div role="button" tabindex="0" class="jc jd di je bf jf"><div class="er es nf"><img src="../Images/78a94c850e5d95be2d366ddcc6287662.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*smjYJmUtURcyslzaKv6nJQ.png"/></div></div></figure><p id="bc8f" class="pw-post-body-paragraph jn jo hh jp b jq jr ii js jt ju il jv jw jx jy jz ka kb kc kd ke kf kg kh ki ha bi translated">因此，数据接收管道已经可以使用了。让我们训练模型。</p><h2 id="ec05" class="lv ky hh bd kz md me mf ld mg mh mi lh jw mj mk lj ka ml mm ll ke mn mo ln mp bi translated">训练模型</h2><p id="9883" class="pw-post-body-paragraph jn jo hh jp b jq mq ii js jt mr il jv jw ms jy jz ka mt kc kd ke mu kg kh ki ha bi translated">我将使用ResNet模型来构建模型。</p><pre class="ix iy iz ja fd lq lr ls lt aw lu bi"><span id="b050" class="lv ky hh lr b fi lw lx l ly lz">model = tf.keras.Sequential([<br/>    tf.keras.layers.InputLayer(<br/>        input_shape=IMAGE_SIZE + (3,)),<br/>    hub.KerasLayer( <br/>        "https://tfhub.dev/tensorflow/resnet_50/feature_vector/1", trainable=False),<br/>    tf.keras.layers.Dense(<br/>        5, activation='softmax', <br/>        name = 'custom_class')])<br/>model.build([None, 224, 224, 3])</span></pre><p id="5a6d" class="pw-post-body-paragraph jn jo hh jp b jq jr ii js jt ju il jv jw jx jy jz ka kb kc kd ke kf kg kh ki ha bi translated">让我们编译模型。</p><pre class="ix iy iz ja fd lq lr ls lt aw lu bi"><span id="7837" class="lv ky hh lr b fi lw lx l ly lz">model.compile(<br/>    optimizer=tf.keras.optimizers.SGD(lr=0.005, momentum=0.9),       <br/>    loss=tf.keras.losses.CategoricalCrossentropy(<br/>        from_logits=True, label_smoothing=0.1), <br/>    metrics=['accuracy'])</span></pre><p id="38bd" class="pw-post-body-paragraph jn jo hh jp b jq jr ii js jt ju il jv jw jx jy jz ka kb kc kd ke kf kg kh ki ha bi translated">现在我要训练模型了。</p><pre class="ix iy iz ja fd lq lr ls lt aw lu bi"><span id="d7e6" class="lv ky hh lr b fi lw lx l ly lz">steps_per_epoch = train_generator.samples // train_generator.batch_size</span><span id="0625" class="lv ky hh lr b fi ng lx l ly lz">validation_steps = valid_generator.samples // valid_generator.batch_size</span><span id="8d18" class="lv ky hh lr b fi ng lx l ly lz">model.fit(<br/>    train_generator, <br/>    epochs=13, <br/>    steps_per_epoch=steps_per_epoch,   <br/>    validation_data=valid_generator, <br/>    validation_steps=validation_steps)</span></pre><figure class="ix iy iz ja fd jb er es paragraph-image"><div role="button" tabindex="0" class="jc jd di je bf jf"><div class="er es nh"><img src="../Images/e1e02c6de3235a9edfe14c803885e4e2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KSeAhGkl8rQwH3gGE5P4MA.png"/></div></div></figure><p id="23d1" class="pw-post-body-paragraph jn jo hh jp b jq jr ii js jt ju il jv jw jx jy jz ka kb kc kd ke kf kg kh ki ha bi translated">如您所见，训练图像生成器和验证图像生成器被传递到训练过程中。训练精度和验证精度都可以。在本节中，我展示了如何对图像数据集使用数据接收管道。</p><h1 id="0d14" class="kx ky hh bd kz la lb lc ld le lf lg lh in li io lj iq lk ir ll it lm iu ln lo bi translated">NumPy数组数据集的数据管道</h1><p id="84b3" class="pw-post-body-paragraph jn jo hh jp b jq mq ii js jt mr il jv jw ms jy jz ka mt kc kd ke mu kg kh ki ha bi translated">到目前为止，您已经看到了如何将数据管道用于文本和图像数据集。在这一节中，我将展示如何为NumPy数组数据集创建数据管道。为此，我将使用from_tensor_slices方法。</p><p id="1530" class="pw-post-body-paragraph jn jo hh jp b jq jr ii js jt ju il jv jw jx jy jz ka kb kc kd ke kf kg kh ki ha bi translated">让我们使用时尚MNIST数据集，它由10种灰度服装组成。这些图像使用NumPy结构表示，而不是典型的图像格式，如JPEG或PNG。你可以用tf轻松下载。Keras API。</p><h2 id="171c" class="lv ky hh bd kz md me mf ld mg mh mi lh jw mj mk lj ka ml mm ll ke mn mo ln mp bi translated">加载数据集</h2><p id="ea18" class="pw-post-body-paragraph jn jo hh jp b jq mq ii js jt mr il jv jw ms jy jz ka mt kc kd ke mu kg kh ki ha bi translated">首先，我来导入库。</p><pre class="ix iy iz ja fd lq lr ls lt aw lu bi"><span id="08c0" class="lv ky hh lr b fi lw lx l ly lz">import tensorflow as tf<br/>import numpy as np<br/>import matplotlib.pyplot as plt</span></pre><p id="085e" class="pw-post-body-paragraph jn jo hh jp b jq jr ii js jt ju il jv jw jx jy jz ka kb kc kd ke kf kg kh ki ha bi translated">让我们使用tf.keras API中的load_data函数加载数据集。</p><pre class="ix iy iz ja fd lq lr ls lt aw lu bi"><span id="ada2" class="lv ky hh lr b fi lw lx l ly lz">fashion_mnist = tf.keras.datasets.fashion_mnist<br/>(train_images, train_labels), (test_images, test_labels) = fashion_mnist.load_data()</span></pre><p id="c294" class="pw-post-body-paragraph jn jo hh jp b jq jr ii js jt ju il jv jw jx jy jz ka kb kc kd ke kf kg kh ki ha bi translated">让我看看数据集的结构。</p><pre class="ix iy iz ja fd lq lr ls lt aw lu bi"><span id="bcff" class="lv ky hh lr b fi lw lx l ly lz">print(type(train_images), type(train_labels))</span></pre><figure class="ix iy iz ja fd jb er es paragraph-image"><div role="button" tabindex="0" class="jc jd di je bf jf"><div class="er es ni"><img src="../Images/27b181ac94ae0376ee5867437637a543.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_VIJS--ymIvuWXFOsEHddA.png"/></div></div></figure><p id="9b7a" class="pw-post-body-paragraph jn jo hh jp b jq jr ii js jt ju il jv jw jx jy jz ka kb kc kd ke kf kg kh ki ha bi translated">如您所见，数据集的结构是NumPy数组。现在，我将使用shape属性查看数据集的形状。</p><pre class="ix iy iz ja fd lq lr ls lt aw lu bi"><span id="3844" class="lv ky hh lr b fi lw lx l ly lz">print(train_images.shape, train_labels.shape)</span></pre><figure class="ix iy iz ja fd jb er es paragraph-image"><div role="button" tabindex="0" class="jc jd di je bf jf"><div class="er es nj"><img src="../Images/696e28d43b14d9e8ecf7173bf7536169.png" data-original-src="https://miro.medium.com/v2/resize:fit:1398/format:webp/1*pMAT2nWwcG91S9EcbJ0cEQ.png"/></div></div></figure><h2 id="bd29" class="lv ky hh bd kz md me mf ld mg mh mi lh jw mj mk lj ka ml mm ll ke mn mo ln mp bi translated">探索数据集</h2><p id="3cf4" class="pw-post-body-paragraph jn jo hh jp b jq mq ii js jt mr il jv jw ms jy jz ka mt kc kd ke mu kg kh ki ha bi translated">为了可视化一个NumPy数组，我将使用matplotlib库。</p><pre class="ix iy iz ja fd lq lr ls lt aw lu bi"><span id="488f" class="lv ky hh lr b fi lw lx l ly lz">plt.figure()<br/>plt.imshow(train_images[5])<br/>plt.colorbar()<br/>plt.grid(False)<br/>plt.show()</span></pre><figure class="ix iy iz ja fd jb er es paragraph-image"><div class="er es nk"><img src="../Images/b010eb57df2f9e8326fdc67bddbe92b2.png" data-original-src="https://miro.medium.com/v2/resize:fit:626/format:webp/1*mFG8u5sFRnwp1jPWbXOsJw.png"/></div></figure><h2 id="6dad" class="lv ky hh bd kz md me mf ld mg mh mi lh jw mj mk lj ka ml mm ll ke mn mo ln mp bi translated">预处理数据集</h2><p id="aab0" class="pw-post-body-paragraph jn jo hh jp b jq mq ii js jt mr il jv jw ms jy jz ka mt kc kd ke mu kg kh ki ha bi translated">图像由0到255之间的像素值组成。为了更快地构建模型并获得更好的准确性，我将对像素值进行归一化。</p><pre class="ix iy iz ja fd lq lr ls lt aw lu bi"><span id="2892" class="lv ky hh lr b fi lw lx l ly lz">train_images = train_images/255</span></pre><p id="c40e" class="pw-post-body-paragraph jn jo hh jp b jq jr ii js jt ju il jv jw jx jy jz ka kb kc kd ke kf kg kh ki ha bi translated">我将使用from_tensor_slices方法建立一个流管道。</p><pre class="ix iy iz ja fd lq lr ls lt aw lu bi"><span id="aa3f" class="lv ky hh lr b fi lw lx l ly lz">train_dataset = tf.data.Dataset.from_tensor_slices(<br/>        (train_images, train_labels))</span></pre><p id="c8af" class="pw-post-body-paragraph jn jo hh jp b jq jr ii js jt ju il jv jw jx jy jz ka kb kc kd ke kf kg kh ki ha bi translated">让我将这个数据集分成训练集和验证集。超参数用验证数据集微调，模型用训练数据集建立。</p><pre class="ix iy iz ja fd lq lr ls lt aw lu bi"><span id="0097" class="lv ky hh lr b fi lw lx l ly lz">SHUFFLE_BUFFER_SIZE = 10000<br/>TRAIN_BATCH_SIZE = 50<br/>VALIDATION_BATCH_SIZE = 10000</span><span id="e734" class="lv ky hh lr b fi ng lx l ly lz">#Creating the data pipelines<br/>validation_ds = train_dataset.shuffle( SHUFFLE_BUFFER_SIZE).take( VALIDATION_SAMPLE_SIZE).batch(VALIDATION_BATCH_SIZE)</span><span id="1f4b" class="lv ky hh lr b fi ng lx l ly lz">train_ds = train_dataset.skip( VALIDATION_BATCH_SIZE).batch( TRAIN_BATCH_SIZE).repeat()</span></pre><h2 id="ebae" class="lv ky hh bd kz md me mf ld mg mh mi lh jw mj mk lj ka ml mm ll ke mn mo ln mp bi translated">构建模型</h2><p id="06f6" class="pw-post-body-paragraph jn jo hh jp b jq mq ii js jt mr il jv jw ms jy jz ka mt kc kd ke mu kg kh ki ha bi translated">数据集已准备好构建模型。为了训练模型，我将使用序列模型。</p><pre class="ix iy iz ja fd lq lr ls lt aw lu bi"><span id="15c0" class="lv ky hh lr b fi lw lx l ly lz"># Build the model<br/>model = tf.keras.Sequential([<br/>    tf.keras.layers.Flatten(input_shape=(28, 28)),    <br/>    tf.keras.layers.Dense(30, activation='relu'),   <br/>    tf.keras.layers.Dense(10)</span><span id="9781" class="lv ky hh lr b fi ng lx l ly lz"># Compiling the model<br/>model.compile(<br/>    optimizer=tf.keras.optimizers.RMSprop(),   <br/>    loss=tf.keras.losses.SparseCategoricalCrossentropy( from_logits=True), <br/>    metrics=['sparse_categorical_accuracy'])</span><span id="7ca8" class="lv ky hh lr b fi ng lx l ly lz">#Trainging the model<br/>model.fit(<br/>    train_ds, <br/>    epochs=13, <br/>    steps_per_epoch=steps_per_epoch,    <br/>    validation_data=validation_ds,   <br/>    validation_steps=validation_steps)</span></pre><figure class="ix iy iz ja fd jb er es paragraph-image"><div role="button" tabindex="0" class="jc jd di je bf jf"><div class="er es nl"><img src="../Images/40515f9665931305c0431584971bd7ee.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WDIGY24ocHrieryU-NuGRA.png"/></div></div></figure><figure class="ix iy iz ja fd jb er es paragraph-image"><div role="button" tabindex="0" class="jc jd di je bf jf"><div class="er es nc"><img src="../Images/5d9e413a873653155c1cbd03568423bf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-v1gvxmpN_GNmRYrc3H4eQ.png"/></div></div></figure><p id="8493" class="pw-post-body-paragraph jn jo hh jp b jq jr ii js jt ju il jv jw jx jy jz ka kb kc kd ke kf kg kh ki ha bi translated">因此train_ds和validation_ds被传递到训练过程中。在这一节中，我展示了如何使用from_tensor_slices为包含NumPy数组的数据集创建数据管道。</p><h1 id="e750" class="kx ky hh bd kz la lb lc ld le lf lg lh in li io lj iq lk ir ll it lm iu ln lo bi translated">摘要</h1><p id="dd55" class="pw-post-body-paragraph jn jo hh jp b jq mq ii js jt mr il jv jw ms jy jz ka mt kc kd ke mu kg kh ki ha bi translated">您可以使用文本、图像和Numpy数组数据集的数据管道轻松构建模型。使用数据管道，您可以从存储数据的位置访问数据，转换、缩放数据，然后将数据传递给模型。</p></div><div class="ab cl nm nn go no" role="separator"><span class="np bw bk nq nr ns"/><span class="np bw bk nq nr ns"/><span class="np bw bk nq nr"/></div><div class="ha hb hc hd he"><p id="0c04" class="pw-post-body-paragraph jn jo hh jp b jq jr ii js jt ju il jv jw jx jy jz ka kb kc kd ke kf kg kh ki ha bi translated">在这里可以找到笔记本<a class="ae jm" href="https://github.com/TirendazAcademy/DEEP-LEARNING-WITH-TENSORFLOW/blob/main/08-How%20to%20Use%20Data%20Pipelines%20with%20Python.ipynb" rel="noopener ugc nofollow" target="_blank">。感谢您的阅读。我希望你喜欢它。别忘了关注我们的</a><a class="ae jm" href="https://youtube.com/c/TirendazAcademy" rel="noopener ugc nofollow" target="_blank">YouTube</a>|<a class="ae jm" href="https://github.com/tirendazacademy" rel="noopener ugc nofollow" target="_blank">GitHub</a>||<a class="ae jm" href="https://twitter.com/TirendazAcademy" rel="noopener ugc nofollow" target="_blank">|<em class="nt">Twitter</em></a><em class="nt"/>|<a class="ae jm" href="https://www.kaggle.com/tirendazacademy" rel="noopener ugc nofollow" target="_blank">ka ggle</a>|<em class="nt">|</em><a class="ae jm" href="https://www.linkedin.com/in/tirendaz-academy" rel="noopener ugc nofollow" target="_blank"><em class="nt">LinkedIn</em></a><em class="nt"/>👍</p><div class="nu nv ez fb nw nx"><a href="https://levelup.gitconnected.com/7-differences-between-deep-learning-and-machine-learning-b5f2ff0ae00a" rel="noopener  ugc nofollow" target="_blank"><div class="ny ab dw"><div class="nz ab oa cl cj ob"><h2 class="bd hi fi z dy oc ea eb od ed ef hg bi translated">深度学习和机器学习的7个区别</h2><div class="oe l"><h3 class="bd b fi z dy oc ea eb od ed ef dx translated">深度学习与机器学习——有什么区别？</h3></div><div class="of l"><p class="bd b fp z dy oc ea eb od ed ef dx translated">levelup.gitconnected.com</p></div></div><div class="og l"><div class="oh l oi oj ok og ol jg nx"/></div></div></a></div><div class="nu nv ez fb nw nx"><a rel="noopener follow" target="_blank" href="/geekculture/6-steps-to-become-a-machine-learning-expert-5a1f155f7207"><div class="ny ab dw"><div class="nz ab oa cl cj ob"><h2 class="bd hi fi z dy oc ea eb od ed ef hg bi translated">成为机器学习专家的6个步骤</h2><div class="oe l"><h3 class="bd b fi z dy oc ea eb od ed ef dx translated">成为机器学习专家需要知道的一切。</h3></div><div class="of l"><p class="bd b fp z dy oc ea eb od ed ef dx translated">medium.com</p></div></div><div class="og l"><div class="om l oi oj ok og ol jg nx"/></div></div></a></div><h1 id="18f5" class="kx ky hh bd kz la lb lc ld le lf lg lh in li io lj iq lk ir ll it lm iu ln lo bi translated">资源</h1><ul class=""><li id="6f5f" class="kj kk hh jp b jq mq jt mr jw on ka oo ke op ki ko kp kq kr bi translated"><a class="ae jm" href="https://www.oreilly.com/library/view/tensorflow-2-pocket/9781492089179/" rel="noopener ugc nofollow" target="_blank"> TensorFlow 2袖珍参考</a></li><li id="e2b9" class="kj kk hh jp b jq ks jt kt jw ku ka kv ke kw ki ko kp kq kr bi translated"><a class="ae jm" href="https://www.tensorflow.org/tutorials" rel="noopener ugc nofollow" target="_blank"> TensorFlow教程</a></li></ul><p id="fb7a" class="pw-post-body-paragraph jn jo hh jp b jq jr ii js jt ju il jv jw jx jy jz ka kb kc kd ke kf kg kh ki ha bi translated">如果这篇文章有帮助，请点击拍手👏按钮几下，以示支持👇</p></div></div>    
</body>
</html>