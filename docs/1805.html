<html>
<head>
<title>Deploy a face mask detection web app with Flask</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Flask部署口罩检测web应用程序</h1>
<blockquote>原文：<a href="https://medium.com/mlearning-ai/deploy-a-face-mask-detection-web-app-with-flask-part-1-10c19722bf0?source=collection_archive---------5-----------------------#2022-01-31">https://medium.com/mlearning-ai/deploy-a-face-mask-detection-web-app-with-flask-part-1-10c19722bf0?source=collection_archive---------5-----------------------#2022-01-31</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><p id="7f16" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">如何部署面具检测应用程序-即使用模型预测图片中是否存在面具的应用程序。</p><figure class="jd je jf jg fd jh er es paragraph-image"><div role="button" tabindex="0" class="ji jj di jk bf jl"><div class="er es jc"><img src="../Images/ea434fbec009c8b3534736013c17e451.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*swvV3JfqMzma6Mkp"/></div></div><figcaption class="jo jp et er es jq jr bd b be z dx">Photo by <a class="ae js" href="https://unsplash.com/@anastasiiachepinska?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Anastasiia Chepinska</a> on <a class="ae js" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="466b" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">要构建这个web应用程序，我们需要几样东西:</p><ol class=""><li id="e3f5" class="jt ju hh ig b ih ii il im ip jv it jw ix jx jb jy jz ka kb bi translated">获取数据。</li><li id="fbe0" class="jt ju hh ig b ih kc il kd ip ke it kf ix kg jb jy jz ka kb bi translated">训练和评估一个CNN(卷积神经网络)来检测面罩。</li><li id="ff9b" class="jt ju hh ig b ih kc il kd ip ke it kf ix kg jb jy jz ka kb bi translated">使用Flask为web应用程序构建后端。</li><li id="53ec" class="jt ju hh ig b ih kc il kd ip ke it kf ix kg jb jy jz ka kb bi translated">使用HTML和CSS构建前端。</li><li id="73dc" class="jt ju hh ig b ih kc il kd ip ke it kf ix kg jb jy jz ka kb bi translated">使用Heroku测试和部署我们的web应用程序。</li></ol><p id="7a4f" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在本文中，我们将讨论列表的前两部分；收集数据，训练和评估我们的CNN。</p><p id="6c4c" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">你可能知道，神经网络通常非常渴望数据，所以我们可能需要大量数据来训练一个。虽然如果你用<a class="ae js" href="https://machinelearningmastery.com/transfer-learning-for-deep-learning/" rel="noopener ugc nofollow" target="_blank">转移学习</a> ( <em class="kh">剧透:我们会</em>)，你可能没那么需要<em class="kh">。</em>对于这个项目，我们将使用来自Kaggle 的以下<a class="ae js" href="https://www.kaggle.com/ashishjangra27/face-mask-12k-images-dataset" rel="noopener ugc nofollow" target="_blank">数据集作为我们的数据源。这个数据集包含我们两个类的12 k以上的图像；戴口罩，不戴口罩。</a></p><p id="79e0" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">现在我们有了数据，让我们继续，看看我们要用它做什么。首先，我们需要将数据导入我们的Jupyter(或Colab)笔记本。这是通过以下API命令完成的:</p><pre class="jd je jf jg fd ki kj kk kl aw km bi"><span id="fe3c" class="kn ko hh kj b fi kp kq l kr ks">kaggle datasets download -d ashishjangra27/face-mask-12k-images-dataset</span></pre><p id="5fc3" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">现在，我们获得了训练集、验证集和测试集的路径，并导入了必要的库:</p><pre class="jd je jf jg fd ki kj kk kl aw km bi"><span id="7b53" class="kn ko hh kj b fi kp kq l kr ks">import numpy as np<br/>import tensorflow as tf<br/>from tensorflow import keras<br/>from tensorflow.keras.models import Sequential<br/>from tensorflow.keras.layers import Activation, Dense, Flatten, BatchNormalization, Conv2D, MaxPool2D, Dropout<br/>from tensorflow.keras.optimizers import Adam<br/>from tensorflow.keras.metrics import categorical_crossentropy<br/>from tensorflow.keras.preprocessing.image import ImageDataGenerator<br/>from sklearn.metrics import confusion_matrix<br/>import os<br/>import matplotlib.pyplot as plt<br/>import seaborn as sns</span></pre><p id="7362" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">为了继续我们的图像预处理，我们必须选择是训练我们自己的定制模型，还是使用使用迁移学习的预训练模型。通过迭代几个定制模型和预训练模型，MobileNet给出了最快和最准确的结果。</p><p id="93f8" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">MobileNet架构使用深度方向可分离卷积来构建轻量级深度神经网络。你可以在这里阅读MobileNet论文<a class="ae js" href="https://arxiv.org/abs/1704.04861" rel="noopener ugc nofollow" target="_blank">。</a></p><p id="5405" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">为了帮助预处理图像，Tensorflow有一个非常有用的工具，叫做<em class="kh"> preprocess_input </em>，我们将使用它来处理我们的<a class="ae js" href="https://www.tensorflow.org/api_docs/python/tf/keras/preprocessing/image/ImageDataGenerator" rel="noopener ugc nofollow" target="_blank"><em class="kh">imagedata generator</em></a>。我们将使用<a class="ae js" href="https://keras.io/api/preprocessing/image/" rel="noopener ugc nofollow" target="_blank"><em class="kh">flow _ from _ directory</em></a><em class="kh"/>函数将我们的图像流入生成器</p><pre class="jd je jf jg fd ki kj kk kl aw km bi"><span id="44f0" class="kn ko hh kj b fi kp kq l kr ks">train_batches =     ImageDataGenerator(preprocessing_function=tf.keras.applications.mobilenet.preprocess_input).flow_from_directory(<br/>directory=train_path,<br/>color_mode='rgb',<br/>classes=['WithMask','WithoutMask'],<br/>batch_size=32)</span><span id="b934" class="kn ko hh kj b fi kt kq l kr ks">valid_batches = ImageDataGenerator(preprocessing_function=tf.keras.applications.mobilenet.preprocess_input).flow_from_directory(<br/>directory=valid_path,<br/>color_mode='rgb',<br/>classes=['WithMask','WithoutMask'],<br/>batch_size=32)</span><span id="2d9f" class="kn ko hh kj b fi kt kq l kr ks">test_batches = ImageDataGenerator(preprocessing_function=tf.keras.applications.mobilenet.preprocess_input).flow_from_directory(<br/>directory=test_path,<br/>color_mode='rgb',<br/>classes=['WithMask','WithoutMask'],<br/>batch_size=32,<br/>shuffle=False)</span><span id="f169" class="kn ko hh kj b fi kt kq l kr ks">&gt;&gt;&gt; Found 10000 images belonging to 2 classes. <br/>&gt;&gt;&gt; Found 800 images belonging to 2 classes.<br/>&gt;&gt;&gt; Found 992 images belonging to 2 classes.</span></pre><p id="717f" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我们现在可以看到这些图像。</p><figure class="jd je jf jg fd jh er es paragraph-image"><div role="button" tabindex="0" class="ji jj di jk bf jl"><div class="er es ku"><img src="../Images/2cb4406671279fc5d1bad8517c496b0a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DPfwkWE-ZWhRNDAql-bwtg.png"/></div></div><figcaption class="jo jp et er es jq jr bd b be z dx">Sample from train_batch</figcaption></figure><p id="85ca" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我们可以使用下面的代码行来检查我们的训练集中有多少幅图像:</p><pre class="jd je jf jg fd ki kj kk kl aw km bi"><span id="891c" class="kn ko hh kj b fi kp kq l kr ks">np.unique(train_batches.labels,return_counts=True)</span><span id="856a" class="kn ko hh kj b fi kt kq l kr ks">&gt;&gt;&gt; (array([0, 1], dtype=int32), array([5000, 5000]))</span></pre><p id="3058" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我们有5000张戴面具的人的照片，和5000张不戴面具的人的照片；平衡良好的数据集。</p><p id="b8a4" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">现在，我们需要下载我们的预训练模型MobileNet，并删除最后一层，即1000级softmax激活层。代替最后一层，我们将添加我们自己的二进制类Sigmoid层。</p><pre class="jd je jf jg fd ki kj kk kl aw km bi"><span id="8a7f" class="kn ko hh kj b fi kp kq l kr ks">mobile = tf.keras.applications.mobilenet.MobileNet()</span></pre><figure class="jd je jf jg fd jh er es paragraph-image"><div role="button" tabindex="0" class="ji jj di jk bf jl"><div class="er es kv"><img src="../Images/4917a74f854197f82d299c3013225c84.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DFfYXbN7FPExJqaAroMneg.jpeg"/></div></div><figcaption class="jo jp et er es jq jr bd b be z dx">Graphic representation of Transfer Learning</figcaption></figure><p id="7d61" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">对于我们预训练的MobileNet模型，我们将选择n层来训练自己，以确保我们的模型具有最高的准确性和尽可能最小的损失。通过几个选项进行迭代，让模型的最后23层(共91层)未经训练给出了最好的结果。</p><pre class="jd je jf jg fd ki kj kk kl aw km bi"><span id="17d3" class="kn ko hh kj b fi kp kq l kr ks">for layer in model.layers[:-23]:<br/>    layer.trainable = False</span></pre><figure class="jd je jf jg fd jh er es paragraph-image"><div role="button" tabindex="0" class="ji jj di jk bf jl"><div class="er es kw"><img src="../Images/e8dc0920fafd34a084caaab579829a4d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ee6C9mOHZU5TlgBmeKQIMw.png"/></div></div><figcaption class="jo jp et er es jq jr bd b be z dx">Visual representation of our MobileNet model</figcaption></figure><p id="a9c3" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">既然我们的模型已经准备好了，我们只需要编译它，并训练它。我们将使用一些正则化的方法，比如提前停止以避免过度拟合…但是什么是提前停止呢？早期停止是一种优化技术，用于在不影响模型精度的情况下减少过拟合。主要想法是在模型开始过度适应之前停止训练。有几种方法可以使用早期停止，但在我们的情况下，当我们的验证集损失开始增加或更新变小时，我们将基本上停止训练。</p><pre class="jd je jf jg fd ki kj kk kl aw km bi"><span id="3331" class="kn ko hh kj b fi kp kq l kr ks">model.compile(optimizer=Adam(learning_rate=0.0001),<br/>    loss='binary_crossentropy', metrics=['accuracy'])</span><span id="efca" class="kn ko hh kj b fi kt kq l kr ks">history = model.fit(x=train_batches,<br/>    steps_per_epoch=len(train_batches),<br/>    validation_data=valid_batches,<br/>    validation_steps=len(valid_batches),<br/>    epochs=30,<br/>    verbose=2,<br/>    callbacks=[tf.keras.callbacks.EarlyStopping(<br/>        monitor="val_loss",<br/>        min_delta=0,<br/>        patience=5,<br/>        verbose=0,<br/>        mode="auto",<br/>        baseline=None,<br/>        restore_best_weights=False,)])</span></pre><p id="a542" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">如果您一直在撰写本文，您可能会发现我们已经获得了很好的性能。绘制准确度和损失的图表显示，由于提前停止，我们只需要训练20个纪元。</p><pre class="jd je jf jg fd ki kj kk kl aw km bi"><span id="14fb" class="kn ko hh kj b fi kp kq l kr ks">print(history.history.keys())</span><span id="a4c3" class="kn ko hh kj b fi kt kq l kr ks">#  "Accuracy"<br/>plt.plot(history.history['accuracy'])<br/>plt.plot(history.history['val_accuracy'])<br/>plt.title('model accuracy')<br/>plt.ylabel('accuracy')<br/>plt.xlabel('epoch')<br/>plt.legend(['train', 'validation'], loc='upper left')<br/>plt.show()</span><span id="b970" class="kn ko hh kj b fi kt kq l kr ks"># "Loss"<br/>plt.plot(history.history['loss'])<br/>plt.plot(history.history['val_loss'])<br/>plt.title('model loss')<br/>plt.ylabel('loss')<br/>plt.xlabel('epoch')<br/>plt.legend(['train', 'validation'], loc='upper left')<br/>plt.show()</span></pre><figure class="jd je jf jg fd jh er es paragraph-image"><div class="er es kx"><img src="../Images/aa7c9688d3046a50fab0a8db3bb773da.png" data-original-src="https://miro.medium.com/v2/resize:fit:796/format:webp/1*pN6WhXIJ8t5KSVd4YTBfyQ.png"/></div><figcaption class="jo jp et er es jq jr bd b be z dx">Model accuracy vs epochs</figcaption></figure><figure class="jd je jf jg fd jh er es paragraph-image"><div class="er es ky"><img src="../Images/32e953fd65b889ba660b70df80ac2d0f.png" data-original-src="https://miro.medium.com/v2/resize:fit:784/format:webp/1*nSd09PVJUzwRkHkaovJ2SQ.png"/></div><figcaption class="jo jp et er es jq jr bd b be z dx">Model loss vs epochs</figcaption></figure><p id="3146" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">这些成绩太棒了！但是，让我们确保我们没有过度适应训练和验证集。让我们使用一个混淆矩阵，它将显示我们的模型预测的真阳性、假阳性、真阴性和假阴性的数量。</p><pre class="jd je jf jg fd ki kj kk kl aw km bi"><span id="86c5" class="kn ko hh kj b fi kp kq l kr ks">predictions = model.predict(x=test_batches,verbose=0)</span><span id="1a38" class="kn ko hh kj b fi kt kq l kr ks">cm = confusion_matrix(y_true=test_labels,y_pred=predictions.argmax(axis=1))</span><span id="1d50" class="kn ko hh kj b fi kt kq l kr ks">plt.figure(figsize=(10,10))<br/>sns.heatmap(cm,annot=True,fmt='g',cmap='Blues',vmin=0)</span></pre><figure class="jd je jf jg fd jh er es paragraph-image"><div class="er es kz"><img src="../Images/1683bd9bad6bc7e7fa711e9f2d9b3921.png" data-original-src="https://miro.medium.com/v2/resize:fit:1116/format:webp/1*H3_MVf6nqKbu3V8EGV9hWA.png"/></div><figcaption class="jo jp et er es jq jr bd b be z dx">Confusion Matrix for the test set</figcaption></figure><p id="8376" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在我们的测试集预测中，我们得到了483个真阳性，0个假阳性，4个假阴性和505个真阴性。总的来说，准确率为100%，召回率为99.17%。对于这个项目的范围来说，这些分数是很棒的！现在，我们只需要保存模型，以便在现实生活中进行测试。</p><pre class="jd je jf jg fd ki kj kk kl aw km bi"><span id="b23f" class="kn ko hh kj b fi kp kq l kr ks">import os.path<br/>if os.path.isfile('/content/drive/MyDrive/mask_detection.h5') is False:<br/>    model.save('/content/drive/MyDrive/mask_detection.h5')</span></pre><p id="204b" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">恭喜你！您刚刚训练了自己的定制MobileNet网络。请务必关注以保持最新状态。:)</p><p id="82c9" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">感谢您抽出时间阅读本文。</p><div class="la lb ez fb lc ld"><a rel="noopener follow" target="_blank" href="/mlearning-ai/mlearning-ai-submission-suggestions-b51e2b130bfb"><div class="le ab dw"><div class="lf ab lg cl cj lh"><h2 class="bd hi fi z dy li ea eb lj ed ef hg bi translated">Mlearning.ai提交建议</h2><div class="lk l"><h3 class="bd b fi z dy li ea eb lj ed ef dx translated">如何成为Mlearning.ai上的作家</h3></div><div class="ll l"><p class="bd b fp z dy li ea eb lj ed ef dx translated">medium.com</p></div></div><div class="lm l"><div class="ln l lo lp lq lm lr jm ld"/></div></div></a></div></div></div>    
</body>
</html>