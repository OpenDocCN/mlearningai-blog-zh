<html>
<head>
<title>Reinforcement Learning Snake Algorithm</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">强化学习Snake算法</h1>
<blockquote>原文：<a href="https://medium.com/mlearning-ai/reinforcement-learning-snake-algorithm-14a8d20dec7f?source=collection_archive---------3-----------------------#2022-02-20">https://medium.com/mlearning-ai/reinforcement-learning-snake-algorithm-14a8d20dec7f?source=collection_archive---------3-----------------------#2022-02-20</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><p id="5e90" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">训练snake算法是与强化学习相关的最基本的项目之一。这有点像强化学习的“Hello World”。我最近发现了python工程师的youtube系列，其中他使用pytorch从头构建了一个强化学习算法，但我觉得他没有很好地解释概念或模型。我写这篇文章是为了解释算法的基本原理，也许还有它背后的一些数学知识。Python工程师的Youtube视频:<a class="ae jc" href="https://youtu.be/PJl4iabBEz0" rel="noopener ugc nofollow" target="_blank">https://youtu.be/PJl4iabBEz0</a>。我们从简单地编写一个可以用pygame制作的贪吃蛇游戏开始</p><pre class="jd je jf jg fd jh ji jj jk aw jl bi"><span id="7b37" class="jm jn hh ji b fi jo jp l jq jr">import pygame</span><span id="b41f" class="jm jn hh ji b fi js jp l jq jr">import random</span><span id="fba7" class="jm jn hh ji b fi js jp l jq jr">from enum import Enum</span><span id="e278" class="jm jn hh ji b fi js jp l jq jr">from collections import namedtuple</span><span id="8bd2" class="jm jn hh ji b fi js jp l jq jr">import time</span><span id="e69c" class="jm jn hh ji b fi js jp l jq jr">pygame.init()</span><span id="b81c" class="jm jn hh ji b fi js jp l jq jr">font = pygame.font.Font('arial.ttf', 25)</span><span id="9e50" class="jm jn hh ji b fi js jp l jq jr">#font = pygame.font.SysFont('arial', 25)</span><span id="50cf" class="jm jn hh ji b fi js jp l jq jr">class Direction(Enum):</span><span id="8b63" class="jm jn hh ji b fi js jp l jq jr">RIGHT = 1</span><span id="c394" class="jm jn hh ji b fi js jp l jq jr">LEFT = 2</span><span id="53d8" class="jm jn hh ji b fi js jp l jq jr">UP = 3</span><span id="6927" class="jm jn hh ji b fi js jp l jq jr">DOWN = 4</span><span id="9eea" class="jm jn hh ji b fi js jp l jq jr">Point = namedtuple('Point', 'x, y')</span><span id="9e2b" class="jm jn hh ji b fi js jp l jq jr"># rgb colors</span><span id="1466" class="jm jn hh ji b fi js jp l jq jr">WHITE = (255, 255, 255)</span><span id="c03e" class="jm jn hh ji b fi js jp l jq jr">RED = (200,0,0)</span><span id="6c8e" class="jm jn hh ji b fi js jp l jq jr">BLUE1 = (0, 0, 255)</span><span id="6eeb" class="jm jn hh ji b fi js jp l jq jr">BLUE2 = (0, 100, 255)</span><span id="0f9c" class="jm jn hh ji b fi js jp l jq jr">BLACK = (0,0,0)</span><span id="cc21" class="jm jn hh ji b fi js jp l jq jr">BLOCK_SIZE = 20</span><span id="b9bc" class="jm jn hh ji b fi js jp l jq jr">SPEED = 20</span><span id="09c6" class="jm jn hh ji b fi js jp l jq jr">class Snake:</span><span id="c0de" class="jm jn hh ji b fi js jp l jq jr">def __init__(self, w=640, h=480):</span><span id="2dae" class="jm jn hh ji b fi js jp l jq jr">self.w = w</span><span id="e65e" class="jm jn hh ji b fi js jp l jq jr">self.h = h</span><span id="675f" class="jm jn hh ji b fi js jp l jq jr"># init display</span><span id="091a" class="jm jn hh ji b fi js jp l jq jr">self.display = pygame.display.set_mode((self.w, self.h))</span><span id="57c3" class="jm jn hh ji b fi js jp l jq jr">pygame.display.set_caption('Snake')</span><span id="c5d4" class="jm jn hh ji b fi js jp l jq jr">self.clock = pygame.time.Clock()</span><span id="2209" class="jm jn hh ji b fi js jp l jq jr"># init game state</span><span id="04b6" class="jm jn hh ji b fi js jp l jq jr">self.direction = Direction.RIGHT</span><span id="e5e7" class="jm jn hh ji b fi js jp l jq jr">self.head = Point(self.w/2, self.h/2)</span><span id="d687" class="jm jn hh ji b fi js jp l jq jr">self.snake = [self.head,</span><span id="7eb3" class="jm jn hh ji b fi js jp l jq jr">Point(self.head.x-BLOCK_SIZE, self.head.y),</span><span id="aed3" class="jm jn hh ji b fi js jp l jq jr">Point(self.head.x-(2*BLOCK_SIZE), self.head.y)]</span><span id="9aa8" class="jm jn hh ji b fi js jp l jq jr">self.score = 0</span><span id="8102" class="jm jn hh ji b fi js jp l jq jr">self.food = None</span><span id="e7fe" class="jm jn hh ji b fi js jp l jq jr">self._place_food()</span><span id="601d" class="jm jn hh ji b fi js jp l jq jr">def _place_food(self):</span><span id="0033" class="jm jn hh ji b fi js jp l jq jr">x = random.randint(0, (self.w-BLOCK_SIZE )//BLOCK_SIZE )*BLOCK_SIZE</span><span id="f44a" class="jm jn hh ji b fi js jp l jq jr">y = random.randint(0, (self.h-BLOCK_SIZE )//BLOCK_SIZE )*BLOCK_SIZE</span><span id="382f" class="jm jn hh ji b fi js jp l jq jr">self.food = Point(x, y)</span><span id="f9d3" class="jm jn hh ji b fi js jp l jq jr">if self.food in self.snake:</span><span id="0eab" class="jm jn hh ji b fi js jp l jq jr">self._place_food()</span><span id="0cc7" class="jm jn hh ji b fi js jp l jq jr">def play_step(self):</span><span id="f7c0" class="jm jn hh ji b fi js jp l jq jr"># 1. collect user input</span><span id="8b26" class="jm jn hh ji b fi js jp l jq jr">for event in pygame.event.get():</span><span id="c78c" class="jm jn hh ji b fi js jp l jq jr">if event.type == pygame.QUIT:</span><span id="1ee9" class="jm jn hh ji b fi js jp l jq jr">pygame.quit()</span><span id="9952" class="jm jn hh ji b fi js jp l jq jr">quit()</span><span id="8a83" class="jm jn hh ji b fi js jp l jq jr">if event.type == pygame.KEYDOWN:</span><span id="7347" class="jm jn hh ji b fi js jp l jq jr">if event.key == pygame.K_LEFT:</span><span id="ac31" class="jm jn hh ji b fi js jp l jq jr">if self.direction == Direction.RIGHT:</span><span id="283c" class="jm jn hh ji b fi js jp l jq jr">self.direction = Direction.RIGHT</span><span id="1750" class="jm jn hh ji b fi js jp l jq jr">else:</span><span id="b8bb" class="jm jn hh ji b fi js jp l jq jr">self.direction = Direction.LEFT</span><span id="fa66" class="jm jn hh ji b fi js jp l jq jr">time.sleep(0.03)</span><span id="08be" class="jm jn hh ji b fi js jp l jq jr">elif event.key == pygame.K_RIGHT:</span><span id="d35a" class="jm jn hh ji b fi js jp l jq jr">if self.direction == Direction.LEFT:</span><span id="a38d" class="jm jn hh ji b fi js jp l jq jr">self.direction = Direction.LEFT</span><span id="7b01" class="jm jn hh ji b fi js jp l jq jr">else:</span><span id="3ab8" class="jm jn hh ji b fi js jp l jq jr">self.direction = Direction.RIGHT</span><span id="1790" class="jm jn hh ji b fi js jp l jq jr">time.sleep(0.03)</span><span id="4159" class="jm jn hh ji b fi js jp l jq jr">elif event.key == pygame.K_UP:</span><span id="b810" class="jm jn hh ji b fi js jp l jq jr">if self.direction == Direction.DOWN:</span><span id="a013" class="jm jn hh ji b fi js jp l jq jr">self.direction = Direction.DOWN</span><span id="e1c6" class="jm jn hh ji b fi js jp l jq jr">else:</span><span id="7250" class="jm jn hh ji b fi js jp l jq jr">self.direction = Direction.UP</span><span id="6931" class="jm jn hh ji b fi js jp l jq jr">time.sleep(0.03)</span><span id="c307" class="jm jn hh ji b fi js jp l jq jr">elif event.key == pygame.K_DOWN:</span><span id="0c33" class="jm jn hh ji b fi js jp l jq jr">if self.direction == Direction.UP:</span><span id="1ce1" class="jm jn hh ji b fi js jp l jq jr">self.direction = Direction.UP</span><span id="3caf" class="jm jn hh ji b fi js jp l jq jr">else:</span><span id="1bdb" class="jm jn hh ji b fi js jp l jq jr">self.direction = Direction.DOWN</span><span id="3d04" class="jm jn hh ji b fi js jp l jq jr">time.sleep(0.03)</span><span id="c51d" class="jm jn hh ji b fi js jp l jq jr"># 2. move</span><span id="76af" class="jm jn hh ji b fi js jp l jq jr">self._move(self.direction) # update the head</span><span id="4b11" class="jm jn hh ji b fi js jp l jq jr">self.snake.insert(0, self.head)</span><span id="3a77" class="jm jn hh ji b fi js jp l jq jr"># 3. check if game over</span><span id="4fd8" class="jm jn hh ji b fi js jp l jq jr">game_over = False</span><span id="1176" class="jm jn hh ji b fi js jp l jq jr">if self._is_collision():</span><span id="5356" class="jm jn hh ji b fi js jp l jq jr">game_over = True</span><span id="45e0" class="jm jn hh ji b fi js jp l jq jr">return game_over, self.score</span><span id="e6b7" class="jm jn hh ji b fi js jp l jq jr"># 4. place new food or just move</span><span id="42df" class="jm jn hh ji b fi js jp l jq jr">if self.head == self.food:</span><span id="cc81" class="jm jn hh ji b fi js jp l jq jr">self.score += 1</span><span id="93ba" class="jm jn hh ji b fi js jp l jq jr">self._place_food()</span><span id="ee9c" class="jm jn hh ji b fi js jp l jq jr">else:</span><span id="2e3c" class="jm jn hh ji b fi js jp l jq jr">self.snake.pop()</span><span id="ff77" class="jm jn hh ji b fi js jp l jq jr"># 5. update ui and clock</span><span id="a32f" class="jm jn hh ji b fi js jp l jq jr">self._update_ui()</span><span id="86ea" class="jm jn hh ji b fi js jp l jq jr">self.clock.tick(SPEED)</span><span id="be2e" class="jm jn hh ji b fi js jp l jq jr"># 6. return game over and score</span><span id="2f3d" class="jm jn hh ji b fi js jp l jq jr">return game_over, self.score</span><span id="b053" class="jm jn hh ji b fi js jp l jq jr">def _is_collision(self):</span><span id="78da" class="jm jn hh ji b fi js jp l jq jr"># hits boundary</span><span id="0407" class="jm jn hh ji b fi js jp l jq jr">if self.head.x &gt; self.w - BLOCK_SIZE or self.head.x &lt; 0 or self.head.y &gt; self.h - BLOCK_SIZE or self.head.y &lt; 0:</span><span id="d956" class="jm jn hh ji b fi js jp l jq jr">return True</span><span id="5457" class="jm jn hh ji b fi js jp l jq jr"># hits itself</span><span id="9155" class="jm jn hh ji b fi js jp l jq jr">if self.head in self.snake[1:]:</span><span id="fdff" class="jm jn hh ji b fi js jp l jq jr">return True</span><span id="dab5" class="jm jn hh ji b fi js jp l jq jr">return False</span><span id="d301" class="jm jn hh ji b fi js jp l jq jr">def _update_ui(self):</span><span id="5abe" class="jm jn hh ji b fi js jp l jq jr">self.display.fill(BLACK)</span><span id="9556" class="jm jn hh ji b fi js jp l jq jr">for pt in self.snake:</span><span id="04b9" class="jm jn hh ji b fi js jp l jq jr">pygame.draw.rect(self.display, BLUE1, pygame.Rect(pt.x, pt.y, BLOCK_SIZE, BLOCK_SIZE))</span><span id="d3cd" class="jm jn hh ji b fi js jp l jq jr">pygame.draw.rect(self.display, BLUE2, pygame.Rect(pt.x+4, pt.y+4, 12, 12))</span><span id="6caf" class="jm jn hh ji b fi js jp l jq jr">pygame.draw.rect(self.display, RED, pygame.Rect(self.food.x, self.food.y, BLOCK_SIZE, BLOCK_SIZE))</span><span id="5ba9" class="jm jn hh ji b fi js jp l jq jr">text = font.render("Score: " + str(self.score), True, WHITE)</span><span id="d58b" class="jm jn hh ji b fi js jp l jq jr">self.display.blit(text, [0, 0])</span><span id="43e4" class="jm jn hh ji b fi js jp l jq jr">pygame.display.flip()</span><span id="73c1" class="jm jn hh ji b fi js jp l jq jr">def _move(self, direction):</span><span id="e13d" class="jm jn hh ji b fi js jp l jq jr">x = self.head.x</span><span id="473a" class="jm jn hh ji b fi js jp l jq jr">y = self.head.y</span><span id="984b" class="jm jn hh ji b fi js jp l jq jr">if direction == Direction.RIGHT:</span><span id="bf13" class="jm jn hh ji b fi js jp l jq jr">x += BLOCK_SIZE</span><span id="04e4" class="jm jn hh ji b fi js jp l jq jr">elif direction == Direction.LEFT:</span><span id="ebe4" class="jm jn hh ji b fi js jp l jq jr">x -= BLOCK_SIZE</span><span id="1b4a" class="jm jn hh ji b fi js jp l jq jr">elif direction == Direction.DOWN:</span><span id="7ace" class="jm jn hh ji b fi js jp l jq jr">y += BLOCK_SIZE</span><span id="886e" class="jm jn hh ji b fi js jp l jq jr">elif direction == Direction.UP:</span><span id="8357" class="jm jn hh ji b fi js jp l jq jr">y -= BLOCK_SIZE</span><span id="3ef4" class="jm jn hh ji b fi js jp l jq jr">self.head = Point(x, y)</span><span id="c8f2" class="jm jn hh ji b fi js jp l jq jr">if __name__ == '__main__':</span><span id="0c10" class="jm jn hh ji b fi js jp l jq jr">game = Snake()</span><span id="6786" class="jm jn hh ji b fi js jp l jq jr"># game loop</span><span id="d2b7" class="jm jn hh ji b fi js jp l jq jr">while True:</span><span id="c946" class="jm jn hh ji b fi js jp l jq jr">game_over, score = game.play_step()</span><span id="9abb" class="jm jn hh ji b fi js jp l jq jr">if game_over == True:</span><span id="ba3a" class="jm jn hh ji b fi js jp l jq jr">break</span><span id="840f" class="jm jn hh ji b fi js jp l jq jr">print('Final Score', score)</span><span id="c1f7" class="jm jn hh ji b fi js jp l jq jr">pygame.quit()</span></pre><p id="359d" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">这是游戏的代码。让我们走一遍</p><pre class="jd je jf jg fd jh ji jj jk aw jl bi"><span id="759b" class="jm jn hh ji b fi jo jp l jq jr">class Direction(Enum):</span><span id="4f15" class="jm jn hh ji b fi js jp l jq jr">RIGHT = 1</span><span id="c5ec" class="jm jn hh ji b fi js jp l jq jr">LEFT = 2</span><span id="76d5" class="jm jn hh ji b fi js jp l jq jr">UP = 3</span><span id="ae50" class="jm jn hh ji b fi js jp l jq jr">DOWN = 4</span></pre><p id="91b8" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我们首先实例化一个方向类来简化用四个基本方向改变蛇的方向的过程。游戏的其余部分用碰撞检测系统就很容易理解了。</p><pre class="jd je jf jg fd jh ji jj jk aw jl bi"><span id="f766" class="jm jn hh ji b fi jo jp l jq jr">def _is_collision(self):</span><span id="c48a" class="jm jn hh ji b fi js jp l jq jr"># hits boundary</span><span id="5ccd" class="jm jn hh ji b fi js jp l jq jr">if self.head.x &gt; self.w - BLOCK_SIZE or self.head.x &lt; 0 or self.head.y &gt; self.h - BLOCK_SIZE or self.head.y &lt; 0:</span><span id="0ef6" class="jm jn hh ji b fi js jp l jq jr">return True</span><span id="d6bb" class="jm jn hh ji b fi js jp l jq jr"># hits itself</span><span id="37ab" class="jm jn hh ji b fi js jp l jq jr">if self.head in self.snake[1:]:</span><span id="5b1a" class="jm jn hh ji b fi js jp l jq jr">return True</span><span id="4d02" class="jm jn hh ji b fi js jp l jq jr">return False</span></pre><p id="a6a5" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">检查蛇是否离开了地图，或者查看蛇的头部是否撞到了自己的头部以外的点。它还实现了一个非常简单的移动系统</p><pre class="jd je jf jg fd jh ji jj jk aw jl bi"><span id="ec91" class="jm jn hh ji b fi jo jp l jq jr">def _move(self, direction):</span><span id="006b" class="jm jn hh ji b fi js jp l jq jr">x = self.head.x</span><span id="d8e1" class="jm jn hh ji b fi js jp l jq jr">y = self.head.y</span><span id="8e38" class="jm jn hh ji b fi js jp l jq jr">if direction == Direction.RIGHT:</span><span id="3f47" class="jm jn hh ji b fi js jp l jq jr">x += BLOCK_SIZE</span><span id="446d" class="jm jn hh ji b fi js jp l jq jr">elif direction == Direction.LEFT:</span><span id="68d8" class="jm jn hh ji b fi js jp l jq jr">x -= BLOCK_SIZE</span><span id="0831" class="jm jn hh ji b fi js jp l jq jr">elif direction == Direction.DOWN:</span><span id="2724" class="jm jn hh ji b fi js jp l jq jr">y += BLOCK_SIZE</span><span id="70f5" class="jm jn hh ji b fi js jp l jq jr">elif direction == Direction.UP:</span><span id="1b54" class="jm jn hh ji b fi js jp l jq jr">y -= BLOCK_SIZE</span><span id="6eff" class="jm jn hh ji b fi js jp l jq jr">self.head = Point(x, y)</span></pre><p id="399c" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">它只是更新蛇的头部和身体，并根据蛇的当前方向向左、向右、向上或向下移动身体。通过pygames内置输入系统实现的简单按键系统有助于改变方向</p><pre class="jd je jf jg fd jh ji jj jk aw jl bi"><span id="3124" class="jm jn hh ji b fi jo jp l jq jr">for event in pygame.event.get():</span><span id="e9ae" class="jm jn hh ji b fi js jp l jq jr">if event.type == pygame.QUIT:</span><span id="7898" class="jm jn hh ji b fi js jp l jq jr">pygame.quit()</span><span id="5fd8" class="jm jn hh ji b fi js jp l jq jr">quit()</span><span id="ba3c" class="jm jn hh ji b fi js jp l jq jr">if event.type == pygame.KEYDOWN:</span><span id="8b8b" class="jm jn hh ji b fi js jp l jq jr">if event.key == pygame.K_LEFT:</span><span id="86df" class="jm jn hh ji b fi js jp l jq jr">if self.direction == Direction.RIGHT:</span><span id="3bf5" class="jm jn hh ji b fi js jp l jq jr">self.direction = Direction.RIGHT</span><span id="3ffb" class="jm jn hh ji b fi js jp l jq jr">else:</span><span id="5fff" class="jm jn hh ji b fi js jp l jq jr">self.direction = Direction.LEFT</span><span id="fb03" class="jm jn hh ji b fi js jp l jq jr">time.sleep(0.03)</span><span id="ed4c" class="jm jn hh ji b fi js jp l jq jr">elif event.key == pygame.K_RIGHT:</span><span id="37c2" class="jm jn hh ji b fi js jp l jq jr">if self.direction == Direction.LEFT:</span><span id="7f27" class="jm jn hh ji b fi js jp l jq jr">self.direction = Direction.LEFT</span><span id="8711" class="jm jn hh ji b fi js jp l jq jr">else:</span><span id="6a6d" class="jm jn hh ji b fi js jp l jq jr">self.direction = Direction.RIGHT</span><span id="4f95" class="jm jn hh ji b fi js jp l jq jr">time.sleep(0.03)</span><span id="f8c4" class="jm jn hh ji b fi js jp l jq jr">elif event.key == pygame.K_UP:</span><span id="2017" class="jm jn hh ji b fi js jp l jq jr">if self.direction == Direction.DOWN:</span><span id="e8a8" class="jm jn hh ji b fi js jp l jq jr">self.direction = Direction.DOWN</span><span id="5d35" class="jm jn hh ji b fi js jp l jq jr">else:</span><span id="42dd" class="jm jn hh ji b fi js jp l jq jr">self.direction = Direction.UP</span><span id="30b2" class="jm jn hh ji b fi js jp l jq jr">time.sleep(0.03)</span><span id="373b" class="jm jn hh ji b fi js jp l jq jr">elif event.key == pygame.K_DOWN:</span><span id="dc81" class="jm jn hh ji b fi js jp l jq jr">if self.direction == Direction.UP:</span><span id="e3e3" class="jm jn hh ji b fi js jp l jq jr">self.direction = Direction.UP</span><span id="e9b2" class="jm jn hh ji b fi js jp l jq jr">else:</span><span id="b0e8" class="jm jn hh ji b fi js jp l jq jr">self.direction = Direction.DOWN</span><span id="f54c" class="jm jn hh ji b fi js jp l jq jr">time.sleep(0.03)</span></pre><p id="d09c" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我们还添加了一个caviet，它可以防止我们朝着与PE没有实现的方向相反的方向前进。我们还添加了一个0.03秒的time.sleep()来防止快速按键意外杀死播放器，PE也没有实现这个功能。这就是游戏的基础。现在我们来谈谈环境。</p><pre class="jd je jf jg fd jh ji jj jk aw jl bi"><span id="c50f" class="jm jn hh ji b fi jo jp l jq jr">import pygame</span><span id="e9af" class="jm jn hh ji b fi js jp l jq jr">import random</span><span id="fcc9" class="jm jn hh ji b fi js jp l jq jr">from enum import Enum</span><span id="a51e" class="jm jn hh ji b fi js jp l jq jr">from collections import namedtuple</span><span id="5c2a" class="jm jn hh ji b fi js jp l jq jr">import numpy as np</span><span id="a187" class="jm jn hh ji b fi js jp l jq jr">pygame.init()</span><span id="1cc5" class="jm jn hh ji b fi js jp l jq jr">font = pygame.font.Font('arial.ttf', 25)</span><span id="e9d1" class="jm jn hh ji b fi js jp l jq jr">#font = pygame.font.SysFont('arial', 25)</span><span id="ff94" class="jm jn hh ji b fi js jp l jq jr">class Direction(Enum):</span><span id="df2b" class="jm jn hh ji b fi js jp l jq jr">RIGHT = 1</span><span id="97d7" class="jm jn hh ji b fi js jp l jq jr">LEFT = 2</span><span id="c851" class="jm jn hh ji b fi js jp l jq jr">UP = 3</span><span id="1637" class="jm jn hh ji b fi js jp l jq jr">DOWN = 4</span><span id="bb3a" class="jm jn hh ji b fi js jp l jq jr">Point = namedtuple('Point', 'x, y')</span><span id="6e10" class="jm jn hh ji b fi js jp l jq jr"># rgb colors</span><span id="6b59" class="jm jn hh ji b fi js jp l jq jr">WHITE = (255, 255, 255)</span><span id="ec19" class="jm jn hh ji b fi js jp l jq jr">RED = (200,0,0)</span><span id="632c" class="jm jn hh ji b fi js jp l jq jr">BLUE1 = (0, 0, 255)</span><span id="1754" class="jm jn hh ji b fi js jp l jq jr">BLUE2 = (0, 100, 255)</span><span id="2fd0" class="jm jn hh ji b fi js jp l jq jr">BLACK = (0,0,0)</span><span id="5bf1" class="jm jn hh ji b fi js jp l jq jr">BLOCK_SIZE = 20</span><span id="7eb2" class="jm jn hh ji b fi js jp l jq jr">SPEED = 100</span><span id="28f2" class="jm jn hh ji b fi js jp l jq jr">class SnakeGameAI:</span><span id="b21b" class="jm jn hh ji b fi js jp l jq jr">def __init__(self, w=640, h=480):</span><span id="d4a5" class="jm jn hh ji b fi js jp l jq jr">self.w = w</span><span id="5b21" class="jm jn hh ji b fi js jp l jq jr">self.h = h</span><span id="5bf2" class="jm jn hh ji b fi js jp l jq jr"># init display</span><span id="8db3" class="jm jn hh ji b fi js jp l jq jr">self.display = pygame.display.set_mode((self.w, self.h))</span><span id="1837" class="jm jn hh ji b fi js jp l jq jr">pygame.display.set_caption('Snake')</span><span id="5490" class="jm jn hh ji b fi js jp l jq jr">self.clock = pygame.time.Clock()</span><span id="a7b0" class="jm jn hh ji b fi js jp l jq jr">self.reset()</span><span id="c5a2" class="jm jn hh ji b fi js jp l jq jr">def reset(self):</span><span id="7210" class="jm jn hh ji b fi js jp l jq jr"># init game state</span><span id="9b9a" class="jm jn hh ji b fi js jp l jq jr">self.direction = Direction.RIGHT</span><span id="665b" class="jm jn hh ji b fi js jp l jq jr">self.head = Point(self.w/2, self.h/2)</span><span id="461f" class="jm jn hh ji b fi js jp l jq jr">self.snake = [self.head,</span><span id="f3a7" class="jm jn hh ji b fi js jp l jq jr">Point(self.head.x-BLOCK_SIZE, self.head.y),</span><span id="1218" class="jm jn hh ji b fi js jp l jq jr">Point(self.head.x-(2*BLOCK_SIZE), self.head.y)]</span><span id="cf4d" class="jm jn hh ji b fi js jp l jq jr">self.score = 0</span><span id="84c2" class="jm jn hh ji b fi js jp l jq jr">self.food = None</span><span id="7330" class="jm jn hh ji b fi js jp l jq jr">self._place_food()</span><span id="e1b2" class="jm jn hh ji b fi js jp l jq jr">self.frame_iteration = 0</span><span id="edda" class="jm jn hh ji b fi js jp l jq jr">def _place_food(self):</span><span id="89c8" class="jm jn hh ji b fi js jp l jq jr">x = random.randint(0, (self.w-BLOCK_SIZE )//BLOCK_SIZE )*BLOCK_SIZE</span><span id="59cc" class="jm jn hh ji b fi js jp l jq jr">y = random.randint(0, (self.h-BLOCK_SIZE )//BLOCK_SIZE )*BLOCK_SIZE</span><span id="31dd" class="jm jn hh ji b fi js jp l jq jr">self.food = Point(x, y)</span><span id="a6e9" class="jm jn hh ji b fi js jp l jq jr">if self.food in self.snake:</span><span id="bb3f" class="jm jn hh ji b fi js jp l jq jr">self._place_food()</span><span id="3f8e" class="jm jn hh ji b fi js jp l jq jr">def play_step(self, action):</span><span id="4f91" class="jm jn hh ji b fi js jp l jq jr">self.frame_iteration += 1</span><span id="3a49" class="jm jn hh ji b fi js jp l jq jr"># 1. collect user input</span><span id="e23d" class="jm jn hh ji b fi js jp l jq jr">for event in pygame.event.get():</span><span id="b2bc" class="jm jn hh ji b fi js jp l jq jr">if event.type == pygame.QUIT:</span><span id="96c8" class="jm jn hh ji b fi js jp l jq jr">pygame.quit()</span><span id="cd4d" class="jm jn hh ji b fi js jp l jq jr">quit()</span><span id="3588" class="jm jn hh ji b fi js jp l jq jr"># 2. move</span><span id="7899" class="jm jn hh ji b fi js jp l jq jr">self._move(action) # update the head</span><span id="5921" class="jm jn hh ji b fi js jp l jq jr">self.snake.insert(0, self.head)</span><span id="7c10" class="jm jn hh ji b fi js jp l jq jr"># 3. check if game over</span><span id="3862" class="jm jn hh ji b fi js jp l jq jr">reward = 0</span><span id="0a5c" class="jm jn hh ji b fi js jp l jq jr">game_over = False</span><span id="2ea5" class="jm jn hh ji b fi js jp l jq jr">if self.is_collision() or self.frame_iteration &gt; 100*len(self.snake):</span><span id="2756" class="jm jn hh ji b fi js jp l jq jr">game_over = True</span><span id="aa87" class="jm jn hh ji b fi js jp l jq jr">reward = -10</span><span id="fc30" class="jm jn hh ji b fi js jp l jq jr">return reward, game_over, self.score</span><span id="33d7" class="jm jn hh ji b fi js jp l jq jr"># 4. place new food or just move</span><span id="dbc4" class="jm jn hh ji b fi js jp l jq jr">if self.head == self.food:</span><span id="27b6" class="jm jn hh ji b fi js jp l jq jr">self.score += 1</span><span id="9741" class="jm jn hh ji b fi js jp l jq jr">reward = 10</span><span id="50ae" class="jm jn hh ji b fi js jp l jq jr">self._place_food()</span><span id="e94e" class="jm jn hh ji b fi js jp l jq jr">else:</span><span id="96a6" class="jm jn hh ji b fi js jp l jq jr">self.snake.pop()</span><span id="0d0c" class="jm jn hh ji b fi js jp l jq jr"># 5. update ui and clock</span><span id="eaaa" class="jm jn hh ji b fi js jp l jq jr">self._update_ui()</span><span id="8a5c" class="jm jn hh ji b fi js jp l jq jr">self.clock.tick(SPEED)</span><span id="52a9" class="jm jn hh ji b fi js jp l jq jr"># 6. return game over and score</span><span id="6d58" class="jm jn hh ji b fi js jp l jq jr">return reward, game_over, self.score</span><span id="1738" class="jm jn hh ji b fi js jp l jq jr">def is_collision(self, pt=None):</span><span id="9c08" class="jm jn hh ji b fi js jp l jq jr">if pt is None:</span><span id="4def" class="jm jn hh ji b fi js jp l jq jr">pt = self.head</span><span id="a28c" class="jm jn hh ji b fi js jp l jq jr"># hits boundary</span><span id="42e4" class="jm jn hh ji b fi js jp l jq jr">if pt.x &gt; self.w - BLOCK_SIZE or pt.x &lt; 0 or pt.y &gt; self.h - BLOCK_SIZE or pt.y &lt; 0:</span><span id="782f" class="jm jn hh ji b fi js jp l jq jr">return True</span><span id="50f8" class="jm jn hh ji b fi js jp l jq jr"># hits itself</span><span id="203b" class="jm jn hh ji b fi js jp l jq jr">if pt in self.snake[1:]:</span><span id="1f96" class="jm jn hh ji b fi js jp l jq jr">return True</span><span id="8658" class="jm jn hh ji b fi js jp l jq jr">return False</span><span id="725f" class="jm jn hh ji b fi js jp l jq jr">def _update_ui(self):</span><span id="e5eb" class="jm jn hh ji b fi js jp l jq jr">self.display.fill(BLACK)</span><span id="04d6" class="jm jn hh ji b fi js jp l jq jr">for pt in self.snake:</span><span id="8c55" class="jm jn hh ji b fi js jp l jq jr">pygame.draw.rect(self.display, BLUE1, pygame.Rect(pt.x, pt.y, BLOCK_SIZE, BLOCK_SIZE))</span><span id="cd1f" class="jm jn hh ji b fi js jp l jq jr">pygame.draw.rect(self.display, BLUE2, pygame.Rect(pt.x+4, pt.y+4, 12, 12))</span><span id="96f5" class="jm jn hh ji b fi js jp l jq jr">pygame.draw.rect(self.display, RED, pygame.Rect(self.food.x, self.food.y, BLOCK_SIZE, BLOCK_SIZE))</span><span id="d050" class="jm jn hh ji b fi js jp l jq jr">text = font.render("Score: " + str(self.score), True, WHITE)</span><span id="c79f" class="jm jn hh ji b fi js jp l jq jr">self.display.blit(text, [0, 0])</span><span id="09eb" class="jm jn hh ji b fi js jp l jq jr">pygame.display.flip()</span><span id="e5ab" class="jm jn hh ji b fi js jp l jq jr">def _move(self, action):</span><span id="be4a" class="jm jn hh ji b fi js jp l jq jr"># [straight, right, left]</span><span id="8eba" class="jm jn hh ji b fi js jp l jq jr">clock_wise = [Direction.RIGHT, Direction.DOWN, Direction.LEFT, Direction.UP]</span><span id="6059" class="jm jn hh ji b fi js jp l jq jr">idx = clock_wise.index(self.direction)</span><span id="d3b9" class="jm jn hh ji b fi js jp l jq jr">if np.array_equal(action, [1, 0, 0]):</span><span id="23ac" class="jm jn hh ji b fi js jp l jq jr">new_dir = clock_wise[idx] # no change</span><span id="12d9" class="jm jn hh ji b fi js jp l jq jr">elif np.array_equal(action, [0, 1, 0]):</span><span id="95a4" class="jm jn hh ji b fi js jp l jq jr">next_idx = (idx + 1) % 4</span><span id="44e7" class="jm jn hh ji b fi js jp l jq jr">new_dir = clock_wise[next_idx] # right turn r -&gt; d -&gt; l -&gt; u</span><span id="b94f" class="jm jn hh ji b fi js jp l jq jr">else: # [0, 0, 1]</span><span id="b87b" class="jm jn hh ji b fi js jp l jq jr">next_idx = (idx - 1) % 4</span><span id="3a8c" class="jm jn hh ji b fi js jp l jq jr">new_dir = clock_wise[next_idx] # left turn r -&gt; u -&gt; l -&gt; d</span><span id="6706" class="jm jn hh ji b fi js jp l jq jr">self.direction = new_dir</span><span id="2d47" class="jm jn hh ji b fi js jp l jq jr">x = self.head.x</span><span id="94f5" class="jm jn hh ji b fi js jp l jq jr">y = self.head.y</span><span id="bccc" class="jm jn hh ji b fi js jp l jq jr">if self.direction == Direction.RIGHT:</span><span id="ad50" class="jm jn hh ji b fi js jp l jq jr">x += BLOCK_SIZE</span><span id="f50c" class="jm jn hh ji b fi js jp l jq jr">elif self.direction == Direction.LEFT:</span><span id="f3dd" class="jm jn hh ji b fi js jp l jq jr">x -= BLOCK_SIZE</span><span id="c073" class="jm jn hh ji b fi js jp l jq jr">elif self.direction == Direction.DOWN:</span><span id="96d8" class="jm jn hh ji b fi js jp l jq jr">y += BLOCK_SIZE</span><span id="45ab" class="jm jn hh ji b fi js jp l jq jr">elif self.direction == Direction.UP:</span><span id="ba7d" class="jm jn hh ji b fi js jp l jq jr">y -= BLOCK_SIZE</span><span id="4102" class="jm jn hh ji b fi js jp l jq jr">self.head = Point(x, y)</span></pre><p id="4d76" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">env与游戏非常相似，但有几个额外的函数使算法能够学习，包括play_step函数、reset函数和_move函数。play_step函数处理在move函数之后发生的所有更新，move函数采用一维数组[1，0，0]、[0，1，0]或[0，0，1]，控制代理是顺时针、逆时针移动还是不执行任何操作。这些操作在_move函数中执行。接下来我们来看代理</p><pre class="jd je jf jg fd jh ji jj jk aw jl bi"><span id="ffe0" class="jm jn hh ji b fi jo jp l jq jr">import torch</span><span id="c2e6" class="jm jn hh ji b fi js jp l jq jr">import random</span><span id="607f" class="jm jn hh ji b fi js jp l jq jr">import numpy as np</span><span id="55d7" class="jm jn hh ji b fi js jp l jq jr">from collections import deque</span><span id="bb25" class="jm jn hh ji b fi js jp l jq jr">from env import SnakeGameAI, Direction, Point</span><span id="9e34" class="jm jn hh ji b fi js jp l jq jr">from model import Linear_QNet, QTrainer</span><span id="16ce" class="jm jn hh ji b fi js jp l jq jr">MAX_MEMORY = 100_000</span><span id="b2f5" class="jm jn hh ji b fi js jp l jq jr">BATCH_SIZE = 1000</span><span id="09b6" class="jm jn hh ji b fi js jp l jq jr">LR = 0.001</span><span id="fe9e" class="jm jn hh ji b fi js jp l jq jr">class Agent:</span><span id="5b45" class="jm jn hh ji b fi js jp l jq jr">def __init__(self):</span><span id="49fa" class="jm jn hh ji b fi js jp l jq jr">self.n_games = 0</span><span id="601e" class="jm jn hh ji b fi js jp l jq jr">self.epsilon = 0 # randomness</span><span id="d097" class="jm jn hh ji b fi js jp l jq jr">self.gamma = 0.9 # discount rate</span><span id="030c" class="jm jn hh ji b fi js jp l jq jr">self.memory = deque(maxlen=MAX_MEMORY) # popleft()</span><span id="82be" class="jm jn hh ji b fi js jp l jq jr">self.model = Linear_QNet(11, 256, 3)#.to(device=torch.device('cuda:0'))</span><span id="2591" class="jm jn hh ji b fi js jp l jq jr">self.trainer = QTrainer(self.model, lr=LR, gamma=self.gamma)#.to(device=torch.device('cuda:0'))</span><span id="506d" class="jm jn hh ji b fi js jp l jq jr">def get_state(self, game):</span><span id="e515" class="jm jn hh ji b fi js jp l jq jr">head = game.snake[0]</span><span id="936b" class="jm jn hh ji b fi js jp l jq jr">point_l = Point(head.x - 20, head.y)</span><span id="ef1d" class="jm jn hh ji b fi js jp l jq jr">point_r = Point(head.x + 20, head.y)</span><span id="d870" class="jm jn hh ji b fi js jp l jq jr">point_u = Point(head.x, head.y - 20)</span><span id="77b9" class="jm jn hh ji b fi js jp l jq jr">point_d = Point(head.x, head.y + 20)</span><span id="07f1" class="jm jn hh ji b fi js jp l jq jr">dir_l = game.direction == Direction.LEFT</span><span id="bbb6" class="jm jn hh ji b fi js jp l jq jr">dir_r = game.direction == Direction.RIGHT</span><span id="5ae5" class="jm jn hh ji b fi js jp l jq jr">dir_u = game.direction == Direction.UP</span><span id="54ba" class="jm jn hh ji b fi js jp l jq jr">dir_d = game.direction == Direction.DOWN</span><span id="d31d" class="jm jn hh ji b fi js jp l jq jr">state = [</span><span id="0b42" class="jm jn hh ji b fi js jp l jq jr"># Danger straight</span><span id="ea20" class="jm jn hh ji b fi js jp l jq jr">(dir_r and game.is_collision(point_r)) or</span><span id="3128" class="jm jn hh ji b fi js jp l jq jr">(dir_l and game.is_collision(point_l)) or</span><span id="e690" class="jm jn hh ji b fi js jp l jq jr">(dir_u and game.is_collision(point_u)) or</span><span id="f517" class="jm jn hh ji b fi js jp l jq jr">(dir_d and game.is_collision(point_d)),</span><span id="68c5" class="jm jn hh ji b fi js jp l jq jr"># Danger right</span><span id="239f" class="jm jn hh ji b fi js jp l jq jr">(dir_u and game.is_collision(point_r)) or</span><span id="6292" class="jm jn hh ji b fi js jp l jq jr">(dir_d and game.is_collision(point_l)) or</span><span id="51cc" class="jm jn hh ji b fi js jp l jq jr">(dir_l and game.is_collision(point_u)) or</span><span id="12c5" class="jm jn hh ji b fi js jp l jq jr">(dir_r and game.is_collision(point_d)),</span><span id="d395" class="jm jn hh ji b fi js jp l jq jr"># Danger left</span><span id="4577" class="jm jn hh ji b fi js jp l jq jr">(dir_d and game.is_collision(point_r)) or</span><span id="6f42" class="jm jn hh ji b fi js jp l jq jr">(dir_u and game.is_collision(point_l)) or</span><span id="df0a" class="jm jn hh ji b fi js jp l jq jr">(dir_r and game.is_collision(point_u)) or</span><span id="e7a3" class="jm jn hh ji b fi js jp l jq jr">(dir_l and game.is_collision(point_d)),</span><span id="9b42" class="jm jn hh ji b fi js jp l jq jr"># Move direction</span><span id="2303" class="jm jn hh ji b fi js jp l jq jr">dir_l,</span><span id="adbc" class="jm jn hh ji b fi js jp l jq jr">dir_r,</span><span id="116c" class="jm jn hh ji b fi js jp l jq jr">dir_u,</span><span id="0b15" class="jm jn hh ji b fi js jp l jq jr">dir_d,</span><span id="47b8" class="jm jn hh ji b fi js jp l jq jr"># Food location</span><span id="865b" class="jm jn hh ji b fi js jp l jq jr">game.food.x &lt; game.head.x, # food left</span><span id="569d" class="jm jn hh ji b fi js jp l jq jr">game.food.x &gt; game.head.x, # food right</span><span id="1783" class="jm jn hh ji b fi js jp l jq jr">game.food.y &lt; game.head.y, # food up</span><span id="520c" class="jm jn hh ji b fi js jp l jq jr">game.food.y &gt; game.head.y # food down</span><span id="0adf" class="jm jn hh ji b fi js jp l jq jr">]</span><span id="0c67" class="jm jn hh ji b fi js jp l jq jr">return np.array(state, dtype=int)</span><span id="3003" class="jm jn hh ji b fi js jp l jq jr">def remember(self, state, action, reward, next_state, done):</span><span id="7f6a" class="jm jn hh ji b fi js jp l jq jr">self.memory.append((state, action, reward, next_state, done)) # popleft if MAX_MEMORY is reached</span><span id="03d1" class="jm jn hh ji b fi js jp l jq jr">def train_long_memory(self):</span><span id="f3ab" class="jm jn hh ji b fi js jp l jq jr">if len(self.memory) &gt; BATCH_SIZE:</span><span id="0f9e" class="jm jn hh ji b fi js jp l jq jr">mini_sample = random.sample(self.memory, BATCH_SIZE) # list of tuples</span><span id="3965" class="jm jn hh ji b fi js jp l jq jr">else:</span><span id="487b" class="jm jn hh ji b fi js jp l jq jr">mini_sample = self.memory</span><span id="4795" class="jm jn hh ji b fi js jp l jq jr">states, actions, rewards, next_states, dones = zip(*mini_sample)</span><span id="006a" class="jm jn hh ji b fi js jp l jq jr">self.trainer.train_step(states, actions, rewards, next_states, dones)</span><span id="4141" class="jm jn hh ji b fi js jp l jq jr">#for state, action, reward, nexrt_state, done in mini_sample:</span><span id="a8d1" class="jm jn hh ji b fi js jp l jq jr"># self.trainer.train_step(state, action, reward, next_state, done)</span><span id="1411" class="jm jn hh ji b fi js jp l jq jr">def train_short_memory(self, state, action, reward, next_state, done):</span><span id="d25a" class="jm jn hh ji b fi js jp l jq jr">self.trainer.train_step(state, action, reward, next_state, done)</span><span id="a8ad" class="jm jn hh ji b fi js jp l jq jr">def get_action(self, state):</span><span id="268e" class="jm jn hh ji b fi js jp l jq jr"># random moves: tradeoff exploration / exploitation</span><span id="a491" class="jm jn hh ji b fi js jp l jq jr">self.epsilon = 80 - self.n_games</span><span id="7333" class="jm jn hh ji b fi js jp l jq jr">final_move = [0,0,0]</span><span id="8f46" class="jm jn hh ji b fi js jp l jq jr">if random.randint(0, 200) &lt; self.epsilon:</span><span id="71b0" class="jm jn hh ji b fi js jp l jq jr">move = random.randint(0, 2)</span><span id="e43a" class="jm jn hh ji b fi js jp l jq jr">final_move[move] = 1</span><span id="761c" class="jm jn hh ji b fi js jp l jq jr">else:</span><span id="8899" class="jm jn hh ji b fi js jp l jq jr">state0 = torch.tensor(state, dtype=torch.float)</span><span id="679a" class="jm jn hh ji b fi js jp l jq jr">prediction = self.model(state0)</span><span id="2234" class="jm jn hh ji b fi js jp l jq jr">move = torch.argmax(prediction).item()</span><span id="5969" class="jm jn hh ji b fi js jp l jq jr">final_move[move] = 1</span><span id="ab3f" class="jm jn hh ji b fi js jp l jq jr">return final_move</span><span id="a4ca" class="jm jn hh ji b fi js jp l jq jr">def train():</span><span id="0fcc" class="jm jn hh ji b fi js jp l jq jr">record = 0</span><span id="375b" class="jm jn hh ji b fi js jp l jq jr">agent = Agent()</span><span id="17c6" class="jm jn hh ji b fi js jp l jq jr">game = SnakeGameAI()</span><span id="8d7e" class="jm jn hh ji b fi js jp l jq jr">while True:</span><span id="7cd8" class="jm jn hh ji b fi js jp l jq jr"># get old state</span><span id="c6ff" class="jm jn hh ji b fi js jp l jq jr">state_old = agent.get_state(game)</span><span id="5106" class="jm jn hh ji b fi js jp l jq jr"># get move</span><span id="f7a8" class="jm jn hh ji b fi js jp l jq jr">final_move = agent.get_action(state_old)</span><span id="157e" class="jm jn hh ji b fi js jp l jq jr"># perform move and get new state</span><span id="d851" class="jm jn hh ji b fi js jp l jq jr">reward, done, score = game.play_step(final_move)</span><span id="f338" class="jm jn hh ji b fi js jp l jq jr">state_new = agent.get_state(game)</span><span id="bfaa" class="jm jn hh ji b fi js jp l jq jr"># train short memory</span><span id="eb3a" class="jm jn hh ji b fi js jp l jq jr">agent.train_short_memory(state_old, final_move, reward, state_new, done)</span><span id="ac18" class="jm jn hh ji b fi js jp l jq jr"># remember</span><span id="4715" class="jm jn hh ji b fi js jp l jq jr">agent.remember(state_old, final_move, reward, state_new, done)</span><span id="1b1d" class="jm jn hh ji b fi js jp l jq jr">if done:</span><span id="c08a" class="jm jn hh ji b fi js jp l jq jr"># train long memory, plot result</span><span id="d407" class="jm jn hh ji b fi js jp l jq jr">game.reset()</span><span id="6c4d" class="jm jn hh ji b fi js jp l jq jr">agent.n_games += 1</span><span id="e38e" class="jm jn hh ji b fi js jp l jq jr">agent.train_long_memory()</span><span id="73e5" class="jm jn hh ji b fi js jp l jq jr">if score &gt; record:</span><span id="79cc" class="jm jn hh ji b fi js jp l jq jr">record = score</span><span id="37d7" class="jm jn hh ji b fi js jp l jq jr">agent.model.save()</span><span id="1804" class="jm jn hh ji b fi js jp l jq jr">print('Game', agent.n_games, 'Score', score, 'Record:', record)</span><span id="7a86" class="jm jn hh ji b fi js jp l jq jr">if __name__ == '__main__':</span><span id="aa86" class="jm jn hh ji b fi js jp l jq jr">train()</span></pre><p id="8daa" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">关于环境，请参考PE的视频，因为他用一种美丽的方式解释说，我不能用文字复制。接下来我们可以继续讨论模型，我发现PE的解释中缺少这一部分。这背后的代码是</p><pre class="jd je jf jg fd jh ji jj jk aw jl bi"><span id="1c3d" class="jm jn hh ji b fi jo jp l jq jr">import torch</span><span id="9ed4" class="jm jn hh ji b fi js jp l jq jr">import torch.nn as nn</span><span id="445d" class="jm jn hh ji b fi js jp l jq jr">import torch.optim as optim</span><span id="4f4d" class="jm jn hh ji b fi js jp l jq jr">import torch.nn.functional as F</span><span id="170a" class="jm jn hh ji b fi js jp l jq jr">import os</span><span id="349d" class="jm jn hh ji b fi js jp l jq jr">class Linear_QNet(nn.Module):</span><span id="8530" class="jm jn hh ji b fi js jp l jq jr">def __init__(self, input_size, hidden_size, output_size):</span><span id="7802" class="jm jn hh ji b fi js jp l jq jr">super().__init__()</span><span id="0a96" class="jm jn hh ji b fi js jp l jq jr">self.linear1 = nn.Linear(input_size, hidden_size)</span><span id="7632" class="jm jn hh ji b fi js jp l jq jr">self.linear2 = nn.Linear(hidden_size, output_size)</span><span id="7297" class="jm jn hh ji b fi js jp l jq jr">def forward(self, x):</span><span id="c044" class="jm jn hh ji b fi js jp l jq jr">x = F.relu(self.linear1(x))</span><span id="ec86" class="jm jn hh ji b fi js jp l jq jr">x = self.linear2(x)</span><span id="bc9c" class="jm jn hh ji b fi js jp l jq jr">return x</span><span id="7ac5" class="jm jn hh ji b fi js jp l jq jr">def save(self, file_name='model.pth'):</span><span id="beba" class="jm jn hh ji b fi js jp l jq jr">model_folder_path = './model'</span><span id="48e7" class="jm jn hh ji b fi js jp l jq jr">if not os.path.exists(model_folder_path):</span><span id="a72c" class="jm jn hh ji b fi js jp l jq jr">os.makedirs(model_folder_path)</span><span id="6e7d" class="jm jn hh ji b fi js jp l jq jr">file_name = os.path.join(model_folder_path, file_name)</span><span id="9abc" class="jm jn hh ji b fi js jp l jq jr">torch.save(self.state_dict(), file_name)</span><span id="9a61" class="jm jn hh ji b fi js jp l jq jr">class QTrainer:</span><span id="a964" class="jm jn hh ji b fi js jp l jq jr">def __init__(self, model, lr, gamma):</span><span id="b0d7" class="jm jn hh ji b fi js jp l jq jr">self.lr = lr</span><span id="021a" class="jm jn hh ji b fi js jp l jq jr">self.gamma = gamma</span><span id="face" class="jm jn hh ji b fi js jp l jq jr">self.model = model</span><span id="cc75" class="jm jn hh ji b fi js jp l jq jr">self.optimizer = optim.Adam(model.parameters(), lr=self.lr)</span><span id="61e3" class="jm jn hh ji b fi js jp l jq jr">self.criterion = nn.MSELoss()</span><span id="dac8" class="jm jn hh ji b fi js jp l jq jr">def train_step(self, state, action, reward, next_state, done):</span><span id="b3ad" class="jm jn hh ji b fi js jp l jq jr">state = torch.tensor(state, dtype=torch.float)</span><span id="c2da" class="jm jn hh ji b fi js jp l jq jr">next_state = torch.tensor(next_state, dtype=torch.float)</span><span id="9c1d" class="jm jn hh ji b fi js jp l jq jr">action = torch.tensor(action, dtype=torch.long)</span><span id="4e10" class="jm jn hh ji b fi js jp l jq jr">reward = torch.tensor(reward, dtype=torch.float)</span><span id="d006" class="jm jn hh ji b fi js jp l jq jr"># (n, x)</span><span id="023c" class="jm jn hh ji b fi js jp l jq jr">if len(state.shape) == 1:</span><span id="219f" class="jm jn hh ji b fi js jp l jq jr"># (1, x)</span><span id="0e21" class="jm jn hh ji b fi js jp l jq jr">state = torch.unsqueeze(state, 0)</span><span id="88bc" class="jm jn hh ji b fi js jp l jq jr">next_state = torch.unsqueeze(next_state, 0)</span><span id="a551" class="jm jn hh ji b fi js jp l jq jr">action = torch.unsqueeze(action, 0)</span><span id="65c2" class="jm jn hh ji b fi js jp l jq jr">reward = torch.unsqueeze(reward, 0)</span><span id="fe79" class="jm jn hh ji b fi js jp l jq jr">done = (done, )</span><span id="f089" class="jm jn hh ji b fi js jp l jq jr"># 1: predicted Q values with current state</span><span id="732d" class="jm jn hh ji b fi js jp l jq jr">pred = self.model(state)</span><span id="5ef0" class="jm jn hh ji b fi js jp l jq jr">target = pred.clone()</span><span id="e255" class="jm jn hh ji b fi js jp l jq jr">for idx in range(len(done)):</span><span id="bd57" class="jm jn hh ji b fi js jp l jq jr">Q_new = reward[idx]</span><span id="5837" class="jm jn hh ji b fi js jp l jq jr">if not done[idx]:</span><span id="0746" class="jm jn hh ji b fi js jp l jq jr">Q_new = reward[idx] + self.gamma * torch.max(self.model(next_state[idx]))</span><span id="0328" class="jm jn hh ji b fi js jp l jq jr">target[idx][torch.argmax(action[idx]).item()] = Q_new</span><span id="88d6" class="jm jn hh ji b fi js jp l jq jr"># 2: Q_new = r + y * max(next_predicted Q value) -&gt; only do this if not done</span><span id="7455" class="jm jn hh ji b fi js jp l jq jr"># pred.clone()</span><span id="3e61" class="jm jn hh ji b fi js jp l jq jr"># preds[argmax(action)] = Q_new</span><span id="4f4c" class="jm jn hh ji b fi js jp l jq jr">self.optimizer.zero_grad()</span><span id="5965" class="jm jn hh ji b fi js jp l jq jr">loss = self.criterion(target, pred)</span><span id="b02b" class="jm jn hh ji b fi js jp l jq jr">loss.backward()</span><span id="8211" class="jm jn hh ji b fi js jp l jq jr">self.optimizer.step()</span></pre><p id="fa06" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">该模型是在pytorch中实现的一个非常轻量级的线性模型，py torch是一个非常通用的机器学习库。我选择pytorch，而不是我通常选择的tensorflow，因为与pytorch模型相比，实现pytorch模型很简单。该模型接受11个值作为输入，具有256个节点作为隐藏层，并输出从0到2的值作为输出。我们用这几行代码把每个参数转换成张量</p><pre class="jd je jf jg fd jh ji jj jk aw jl bi"><span id="c6bf" class="jm jn hh ji b fi jo jp l jq jr">state = torch.tensor(state, dtype=torch.float)</span><span id="7c1b" class="jm jn hh ji b fi js jp l jq jr">next_state = torch.tensor(next_state, dtype=torch.float)</span><span id="f4b8" class="jm jn hh ji b fi js jp l jq jr">action = torch.tensor(action, dtype=torch.long)</span><span id="84d9" class="jm jn hh ji b fi js jp l jq jr">reward = torch.tensor(reward, dtype=torch.float)</span></pre><p id="3e1d" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">并且这些参数中的每一个然后被取消排队以使它们与神经网络的输入层兼容，并且done参数被转换成具有一个元素的元组</p><pre class="jd je jf jg fd jh ji jj jk aw jl bi"><span id="d8b1" class="jm jn hh ji b fi jo jp l jq jr">state = torch.unsqueeze(state, 0)</span><span id="3a0e" class="jm jn hh ji b fi js jp l jq jr">next_state = torch.unsqueeze(next_state, 0)</span><span id="29b6" class="jm jn hh ji b fi js jp l jq jr">action = torch.unsqueeze(action, 0)</span><span id="6bf9" class="jm jn hh ji b fi js jp l jq jr">reward = torch.unsqueeze(reward, 0)</span><span id="1c6e" class="jm jn hh ji b fi js jp l jq jr">done = (done, )</span></pre><p id="c86b" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">完成所有这些后，我们计算预测结果和模型提供的结果，并使用它们计算损失。</p><pre class="jd je jf jg fd jh ji jj jk aw jl bi"><span id="37cb" class="jm jn hh ji b fi jo jp l jq jr">Q_new = reward[idx]</span><span id="52f9" class="jm jn hh ji b fi js jp l jq jr">if not done[idx]:</span><span id="a8dc" class="jm jn hh ji b fi js jp l jq jr">Q_new = reward[idx] + self.gamma * torch.max(self.model(next_state[idx]))</span><span id="b5f3" class="jm jn hh ji b fi js jp l jq jr">target[idx][torch.argmax(action[idx]).item()] = Q_new</span><span id="2f12" class="jm jn hh ji b fi js jp l jq jr"># 2: Q_new = r + y * max(next_predicted Q value)</span></pre><p id="c245" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">之后，我们简单地优化模型及其参数</p><pre class="jd je jf jg fd jh ji jj jk aw jl bi"><span id="842c" class="jm jn hh ji b fi jo jp l jq jr">self.optimizer.zero_grad()</span><span id="81eb" class="jm jn hh ji b fi js jp l jq jr">loss = self.criterion(target, pred)</span><span id="81e4" class="jm jn hh ji b fi js jp l jq jr">loss.backward()</span><span id="b7d3" class="jm jn hh ji b fi js jp l jq jr">self.optimizer.step()</span></pre><p id="5de8" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">这种模型和训练方法产生如下结果:在30分钟的训练后完成了<a class="ae jc" href="https://youtu.be/kxFVMeoqzkM" rel="noopener ugc nofollow" target="_blank">https://youtu.be/kxFVMeoqzkM</a>。</p><div class="jt ju ez fb jv jw"><a rel="noopener follow" target="_blank" href="/mlearning-ai/mlearning-ai-submission-suggestions-b51e2b130bfb"><div class="jx ab dw"><div class="jy ab jz cl cj ka"><h2 class="bd hi fi z dy kb ea eb kc ed ef hg bi translated">Mlearning.ai提交建议</h2><div class="kd l"><h3 class="bd b fi z dy kb ea eb kc ed ef dx translated">如何成为Mlearning.ai上的作家</h3></div><div class="ke l"><p class="bd b fp z dy kb ea eb kc ed ef dx translated">medium.com</p></div></div><div class="kf l"><div class="kg l kh ki kj kf kk kl jw"/></div></div></a></div><p id="ad40" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><a class="ae jc" rel="noopener" href="/mlearning-ai/mlearning-ai-submission-suggestions-b51e2b130bfb"> <strong class="ig hi">成为作家</strong> </a></p></div></div>    
</body>
</html>