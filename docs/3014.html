<html>
<head>
<title>Azure Machine learning running spacy NLP</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Azure机器学习运行spacy NLP</h1>
<blockquote>原文：<a href="https://medium.com/mlearning-ai/azure-machine-learning-running-spacy-nlp-617326e3dea3?source=collection_archive---------2-----------------------#2022-07-09">https://medium.com/mlearning-ai/azure-machine-learning-running-spacy-nlp-617326e3dea3?source=collection_archive---------2-----------------------#2022-07-09</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><h1 id="b718" class="ie if hh bd ig ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb bi translated">使用Azure机器学习为训练和评分建立端到端管道</h1><h1 id="0e5e" class="ie if hh bd ig ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb bi translated">先决条件</h1><ul class=""><li id="7da5" class="jc jd hh je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt bi translated">Azure帐户</li><li id="f89a" class="jc jd hh je b jf ju jh jv jj jw jl jx jn jy jp jq jr js jt bi translated">Azure存储</li><li id="0e7f" class="jc jd hh je b jf ju jh jv jj jw jl jx jn jy jp jq jr js jt bi translated">Azure机器学习服务</li></ul><h1 id="accb" class="ie if hh bd ig ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb bi translated">密码</h1><ul class=""><li id="357e" class="jc jd hh je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt bi translated">该示例代码展示了如何使用sdk创建和运行培训和推理aml管道</li><li id="0354" class="jc jd hh je b jf ju jh jv jj jw jl jx jn jy jp jq jr js jt bi translated">不是实际的实现</li><li id="d50b" class="jc jd hh je b jf ju jh jv jj jw jl jx jn jy jp jq jr js jt bi translated">训练和推理代码是示例，还不能用于生产</li><li id="6170" class="jc jd hh je b jf ju jh jv jj jw jl jx jn jy jp jq jr js jt bi translated">上下文已准备好用于生产</li><li id="24ac" class="jc jd hh je b jf ju jh jv jj jw jl jx jn jy jp jq jr js jt bi translated">在python 3.8中用azure ML内核测试了这段代码</li><li id="a355" class="jc jd hh je b jf ju jh jv jj jw jl jx jn jy jp jq jr js jt bi translated">让我们配置要运行的工作区</li><li id="6e9b" class="jc jd hh je b jf ju jh jv jj jw jl jx jn jy jp jq jr js jt bi translated">下面的代码假设输入数据设置为ADLS gen2，数据集是为输入和输出创建的。</li><li id="77a3" class="jc jd hh je b jf ju jh jv jj jw jl jx jn jy jp jq jr js jt bi translated">当我们在存储中有输入和输出时，任何消费应用程序都可以得到结果</li><li id="90d2" class="jc jd hh je b jf ju jh jv jj jw jl jx jn jy jp jq jr js jt bi translated">以下代码仅用于批处理。</li></ul><pre class="jz ka kb kc fd kd ke kf kg aw kh bi"><span id="c2ff" class="ki if hh ke b fi kj kk l kl km">import azureml.core<br/>from azureml.core import Workspace, Datastore</span><span id="d5fe" class="ki if hh ke b fi kn kk l kl km">ws = Workspace.from_config()</span></pre><ul class=""><li id="be0e" class="jc jd hh je b jf ko jh kp jj kq jl kr jn ks jp jq jr js jt bi translated">接下来是配置工作区默认数据存储</li></ul><pre class="jz ka kb kc fd kd ke kf kg aw kh bi"><span id="b0b5" class="ki if hh ke b fi kj kk l kl km"># Default datastore <br/>def_data_store = ws.get_default_datastore()</span><span id="cb05" class="ki if hh ke b fi kn kk l kl km"># Get the blob storage associated with the workspace<br/>def_blob_store = Datastore(ws, "workspaceblobstore")</span><span id="e57f" class="ki if hh ke b fi kn kk l kl km"># Get file storage associated with the workspace<br/>def_file_store = Datastore(ws, "workspacefilestore")</span></pre><ul class=""><li id="753a" class="jc jd hh je b jf ko jh kp jj kq jl kr jn ks jp jq jr js jt bi translated">接下来创建计算集群</li></ul><pre class="jz ka kb kc fd kd ke kf kg aw kh bi"><span id="31be" class="ki if hh ke b fi kj kk l kl km">from azureml.core.compute import ComputeTarget, AmlCompute</span><span id="98fa" class="ki if hh ke b fi kn kk l kl km">compute_name = "cpu-cluster"<br/>vm_size = "STANDARD_NC6"<br/>if compute_name in ws.compute_targets:<br/>    compute_target = ws.compute_targets[compute_name]<br/>    if compute_target and type(compute_target) is AmlCompute:<br/>        print('Found compute target: ' + compute_name)<br/>else:<br/>    print('Creating a new compute target...')<br/>    provisioning_config = AmlCompute.provisioning_configuration(vm_size=vm_size,  # STANDARD_NC6 is GPU-enabled<br/>                                                                min_nodes=0,<br/>                                                                max_nodes=4)<br/>    # create the compute target<br/>    compute_target = ComputeTarget.create(<br/>        ws, compute_name, provisioning_config)</span><span id="d266" class="ki if hh ke b fi kn kk l kl km">    # Can poll for a minimum number of nodes and for a specific timeout.<br/>    # If no min node count is provided it will use the scale settings for the cluster<br/>    compute_target.wait_for_completion(<br/>        show_output=True, min_node_count=None, timeout_in_minutes=20)</span><span id="d3f5" class="ki if hh ke b fi kn kk l kl km">    # For a more detailed view of current cluster status, use the 'status' property<br/>    print(compute_target.status.serialize())</span></pre><ul class=""><li id="5789" class="jc jd hh je b jf ko jh kp jj kq jl kr jn ks jp jq jr js jt bi translated">我们只使用CPU集群。如果需要，可以选择GPU</li><li id="f353" class="jc jd hh je b jf ju jh jv jj jw jl jx jn jy jp jq jr js jt bi translated">导入AML库</li></ul><pre class="jz ka kb kc fd kd ke kf kg aw kh bi"><span id="9869" class="ki if hh ke b fi kj kk l kl km">from azureml.core import Dataset<br/>from azureml.data.dataset_factory import DataType<br/>from azureml.pipeline.steps import PythonScriptStep<br/>from azureml.data import OutputFileDatasetConfig<br/>from azureml.core import Workspace, Datastore</span><span id="e313" class="ki if hh ke b fi kn kk l kl km">datastore = ws.get_default_datastore()</span></pre><ul class=""><li id="f519" class="jc jd hh je b jf ko jh kp jj kq jl kr jn ks jp jq jr js jt bi translated">为计算创建环境配置</li></ul><pre class="jz ka kb kc fd kd ke kf kg aw kh bi"><span id="63ff" class="ki if hh ke b fi kj kk l kl km">from azureml.core.runconfig import RunConfiguration<br/>from azureml.core.conda_dependencies import CondaDependencies<br/>from azureml.core import Environment </span><span id="9fcd" class="ki if hh ke b fi kn kk l kl km">aml_run_config = RunConfiguration()<br/># `compute_target` as defined in "Azure Machine Learning compute" section above<br/>aml_run_config.target = compute_target</span><span id="b21a" class="ki if hh ke b fi kn kk l kl km">USE_CURATED_ENV = True<br/>if USE_CURATED_ENV :<br/>    curated_environment = Environment.get(workspace=ws, name="AzureML-Tutorial")<br/>    aml_run_config.environment = curated_environment<br/>else:<br/>    aml_run_config.environment.python.user_managed_dependencies = False<br/>    <br/>    # Add some packages relied on by data prep step<br/>    aml_run_config.environment.python.conda_dependencies = CondaDependencies.create(<br/>        conda_packages=['pandas','scikit-learn','seaborn','tqdm'], <br/>        pip_packages=['azureml-sdk', 'azureml-dataprep[fuse,pandas]','seaborn','tqdm', 'spacy'], <br/>        pin_sdk_version=False)</span></pre><ul class=""><li id="0995" class="jc jd hh je b jf ko jh kp jj kq jl kr jn ks jp jq jr js jt bi translated">现在让我们编写train.py代码</li><li id="bc6a" class="jc jd hh je b jf ju jh jv jj jw jl jx jn jy jp jq jr js jt bi translated">创建一个新文件作为文本文件，并重命名为train.py</li></ul><pre class="jz ka kb kc fd kd ke kf kg aw kh bi"><span id="486b" class="ki if hh ke b fi kj kk l kl km">import sys<br/>import subprocess</span><span id="82bb" class="ki if hh ke b fi kn kk l kl km">subprocess.check_call([sys.executable, '-m', 'pip', 'install', 'spacy'])<br/>subprocess.check_call([sys.executable, '-m', 'spacy', 'download', 'en_core_web_sm'])</span><span id="791d" class="ki if hh ke b fi kn kk l kl km">import spacy<br/>nlp = spacy.load('en_core_web_sm')</span><span id="5fd5" class="ki if hh ke b fi kn kk l kl km">about_text = ('Gus Proto is a Python developer currently'<br/>              ' working for a London-based Fintech'<br/>              ' company. He is interested in learning'<br/>              ' Natural Language Processing.')<br/>about_doc = nlp(about_text)<br/>sentences = list(about_doc.sents)<br/>len(sentences)</span><span id="b2af" class="ki if hh ke b fi kn kk l kl km">for sentence in sentences:<br/>    print (sentence)</span></pre><ul class=""><li id="c1fa" class="jc jd hh je b jf ko jh kp jj kq jl kr jn ks jp jq jr js jt bi translated">以上代码应该是train文件夹</li><li id="1dee" class="jc jd hh je b jf ju jh jv jj jw jl jx jn jy jp jq jr js jt bi translated">如果没有，请创建一个新的</li><li id="8de8" class="jc jd hh je b jf ju jh jv jj jw jl jx jn jy jp jq jr js jt bi translated">上面的代码除了打印句子之外没做什么</li><li id="73e9" class="jc jd hh je b jf ju jh jv jj jw jl jx jn jy jp jq jr js jt bi translated">以上代码可以根据您的情况进行编辑</li><li id="189d" class="jc jd hh je b jf ju jh jv jj jw jl jx jn jy jp jq jr js jt bi translated">还可以添加添加运行信息的代码</li><li id="d2bb" class="jc jd hh je b jf ju jh jv jj jw jl jx jn jy jp jq jr js jt bi translated">接下来，我们设置培训管道</li></ul><pre class="jz ka kb kc fd kd ke kf kg aw kh bi"><span id="def3" class="ki if hh ke b fi kj kk l kl km">train_source_dir = "./train"<br/>train_entry_point = "train.py"<br/></span><span id="6000" class="ki if hh ke b fi kn kk l kl km">    <br/>train_step = PythonScriptStep(<br/>    script_name=train_entry_point,<br/>    source_directory=train_source_dir,<br/>    ##arguments=["--input_data", ds_input],<br/>    compute_target=compute_target, # , "--training_results", training_results<br/>    runconfig=aml_run_config,<br/>    allow_reuse=False<br/>)</span></pre><ul class=""><li id="b6be" class="jc jd hh je b jf ko jh kp jj kq jl kr jn ks jp jq jr js jt bi translated">创建管道步骤</li></ul><pre class="jz ka kb kc fd kd ke kf kg aw kh bi"><span id="40f1" class="ki if hh ke b fi kj kk l kl km"># list of steps to run (`compare_step` definition not shown)<br/>compare_models = [train_step]</span><span id="1992" class="ki if hh ke b fi kn kk l kl km">from azureml.pipeline.core import Pipeline</span><span id="2d31" class="ki if hh ke b fi kn kk l kl km"># Build the pipeline<br/>pipeline1 = Pipeline(workspace=ws, steps=train_step)</span></pre><ul class=""><li id="7027" class="jc jd hh je b jf ko jh kp jj kq jl kr jn ks jp jq jr js jt bi translated">验证管道</li></ul><pre class="jz ka kb kc fd kd ke kf kg aw kh bi"><span id="444f" class="ki if hh ke b fi kj kk l kl km">pipeline1.validate()<br/>print("Pipeline validation complete")</span></pre><ul class=""><li id="8ee5" class="jc jd hh je b jf ko jh kp jj kq jl kr jn ks jp jq jr js jt bi translated">运行培训管道</li></ul><pre class="jz ka kb kc fd kd ke kf kg aw kh bi"><span id="7686" class="ki if hh ke b fi kj kk l kl km">from azureml.core import Experiment</span><span id="44ba" class="ki if hh ke b fi kn kk l kl km"># Submit the pipeline to be run<br/>pipeline_run1 = Experiment(ws, 'Spacy_Pipeline_Notebook').submit(pipeline1)<br/>pipeline_run1.wait_for_completion()</span></pre><ul class=""><li id="97ba" class="jc jd hh je b jf ko jh kp jj kq jl kr jn ks jp jq jr js jt bi translated">显示输出</li></ul><pre class="jz ka kb kc fd kd ke kf kg aw kh bi"><span id="e635" class="ki if hh ke b fi kj kk l kl km">from azureml.widgets import RunDetails</span><span id="0ee6" class="ki if hh ke b fi kn kk l kl km">RunDetails(pipeline_run1).show()</span></pre><ul class=""><li id="00c6" class="jc jd hh je b jf ko jh kp jj kq jl kr jn ks jp jq jr js jt bi translated">接下来，使用synapse integrate或Azure data factory为再培训创建管道</li></ul><pre class="jz ka kb kc fd kd ke kf kg aw kh bi"><span id="4b8e" class="ki if hh ke b fi kj kk l kl km">from azureml.pipeline.core.graph import PipelineParameter</span><span id="d803" class="ki if hh ke b fi kn kk l kl km">pipeline_param = PipelineParameter(<br/>  name="pipeline_arg",<br/>  default_value=10)</span></pre><ul class=""><li id="a4c2" class="jc jd hh je b jf ko jh kp jj kq jl kr jn ks jp jq jr js jt bi translated">发布管道</li></ul><pre class="jz ka kb kc fd kd ke kf kg aw kh bi"><span id="e603" class="ki if hh ke b fi kj kk l kl km">published_pipeline1 = pipeline_run1.publish_pipeline(<br/>     name="Published_Spacy_Pipeline_Notebook",<br/>     description="Spacy_Pipeline_Notebook Published Pipeline Description",<br/>     version="1.0")</span></pre><ul class=""><li id="94f3" class="jc jd hh je b jf ko jh kp jj kq jl kr jn ks jp jq jr js jt bi translated">上述训练脚本中没有使用管道参数，只是为了说明如何传递</li><li id="d3b0" class="jc jd hh je b jf ju jh jv jj jw jl jx jn jy jp jq jr js jt bi translated">要执行上述管道，我们首先需要许可</li><li id="b7e8" class="jc jd hh je b jf ju jh jv jj jw jl jx jn jy jp jq jr js jt bi translated">设置Azure服务主体</li><li id="03b9" class="jc jd hh je b jf ju jh jv jj jw jl jx jn jy jp jq jr js jt bi translated">为参与者提供AML工作区的访问权限，以运行管道</li></ul><pre class="jz ka kb kc fd kd ke kf kg aw kh bi"><span id="2b27" class="ki if hh ke b fi kj kk l kl km">from azureml.core.authentication import TokenAuthentication, Audience</span><span id="1331" class="ki if hh ke b fi kn kk l kl km"># This is a sample method to retrieve token and will be passed to TokenAuthentication<br/>def get_token_for_audience(audience):<br/>    from adal import AuthenticationContext<br/>    client_id = "clientid"<br/>    client_secret = "xxxxxxxxxxxxxxxx"<br/>    tenant_id = "tenantid"<br/>    auth_context = AuthenticationContext("https://login.microsoftonline.com/{}".format(tenant_id))<br/>    resp = auth_context.acquire_token_with_client_credentials(audience,client_id,client_secret)<br/>    token = resp["accessToken"]<br/>    return token<br/></span><span id="29e1" class="ki if hh ke b fi kn kk l kl km">token_auth = TokenAuthentication(get_token_for_audience=get_token_for_audience)</span></pre><ul class=""><li id="8411" class="jc jd hh je b jf ko jh kp jj kq jl kr jn ks jp jq jr js jt bi translated">创建授权标题</li></ul><pre class="jz ka kb kc fd kd ke kf kg aw kh bi"><span id="1cac" class="ki if hh ke b fi kj kk l kl km">headerInfo = {'Authorization': 'Bearer ' + aad_token + ''}</span></pre><ul class=""><li id="672e" class="jc jd hh je b jf ko jh kp jj kq jl kr jn ks jp jq jr js jt bi translated">现在调用发布的管道</li></ul><pre class="jz ka kb kc fd kd ke kf kg aw kh bi"><span id="2232" class="ki if hh ke b fi kj kk l kl km">from azureml.pipeline.core import PublishedPipeline<br/>import requests</span><span id="b08d" class="ki if hh ke b fi kn kk l kl km">response = requests.post(published_pipeline1.endpoint, <br/>                         headers=headerInfo,<br/>                         json={"ExperimentName": "Published_Spacy_Pipeline_Notebook",<br/>                               "ParameterAssignments": {"pipeline_arg": 20}})</span></pre><ul class=""><li id="1b58" class="jc jd hh je b jf ko jh kp jj kq jl kr jn ks jp jq jr js jt bi translated">现在转到实验页面，等待实验完成</li><li id="1054" class="jc jd hh je b jf ju jh jv jj jw jl jx jn jy jp jq jr js jt bi translated">一旦实验完成，下一步我们可以尝试分数管道</li><li id="e185" class="jc jd hh je b jf ju jh jv jj jw jl jx jn jy jp jq jr js jt bi translated">首先创建一个score.py文件</li></ul><pre class="jz ka kb kc fd kd ke kf kg aw kh bi"><span id="c592" class="ki if hh ke b fi kj kk l kl km">import sys<br/>import subprocess</span><span id="e70c" class="ki if hh ke b fi kn kk l kl km">subprocess.check_call([sys.executable, '-m', 'pip', 'install', 'spacy'])<br/>subprocess.check_call([sys.executable, '-m', 'spacy', 'download', 'en_core_web_sm'])</span><span id="630c" class="ki if hh ke b fi kn kk l kl km">import spacy<br/>nlp = spacy.load('en_core_web_sm')</span><span id="69d0" class="ki if hh ke b fi kn kk l kl km">about_text = ('Gus Proto is a Python developer currently'<br/>              ' working for a London-based Fintech'<br/>              ' company. He is interested in learning'<br/>              ' Natural Language Processing.')<br/>about_doc = nlp(about_text)<br/>sentences = list(about_doc.sents)<br/>len(sentences)</span><span id="0b7f" class="ki if hh ke b fi kn kk l kl km">for sentence in sentences:<br/>    print (sentence)</span></pre><ul class=""><li id="486d" class="jc jd hh je b jf ko jh kp jj kq jl kr jn ks jp jq jr js jt bi translated">创建推理管道</li></ul><pre class="jz ka kb kc fd kd ke kf kg aw kh bi"><span id="9537" class="ki if hh ke b fi kj kk l kl km">train_source_dir = "./inference"<br/>train_entry_point = "score.py"<br/></span><span id="2366" class="ki if hh ke b fi kn kk l kl km">    <br/>train_step = PythonScriptStep(<br/>    script_name=train_entry_point,<br/>    source_directory=train_source_dir,<br/>    ##arguments=["--input_data", ds_input],<br/>    compute_target=compute_target, # , "--training_results", training_results<br/>    runconfig=aml_run_config,<br/>    allow_reuse=False<br/>)</span></pre><ul class=""><li id="7899" class="jc jd hh je b jf ko jh kp jj kq jl kr jn ks jp jq jr js jt bi translated">创建管道步骤</li></ul><pre class="jz ka kb kc fd kd ke kf kg aw kh bi"><span id="4b46" class="ki if hh ke b fi kj kk l kl km"># list of steps to run (`compare_step` definition not shown)<br/>compare_models = [train_step]</span><span id="b6c9" class="ki if hh ke b fi kn kk l kl km">from azureml.pipeline.core import Pipeline</span><span id="ed26" class="ki if hh ke b fi kn kk l kl km"># Build the pipeline<br/>pipeline1 = Pipeline(workspace=ws, steps=train_step)</span></pre><ul class=""><li id="e6bb" class="jc jd hh je b jf ko jh kp jj kq jl kr jn ks jp jq jr js jt bi translated">验证管道</li></ul><pre class="jz ka kb kc fd kd ke kf kg aw kh bi"><span id="f520" class="ki if hh ke b fi kj kk l kl km">pipeline1.validate()<br/>print("Pipeline validation complete")</span></pre><ul class=""><li id="1c49" class="jc jd hh je b jf ko jh kp jj kq jl kr jn ks jp jq jr js jt bi translated">提交管道运行。</li><li id="9dc1" class="jc jd hh je b jf ju jh jv jj jw jl jx jn jy jp jq jr js jt bi translated">进行实验并等待管道完成</li></ul><pre class="jz ka kb kc fd kd ke kf kg aw kh bi"><span id="d6fc" class="ki if hh ke b fi kj kk l kl km">from azureml.core import Experiment</span><span id="e77f" class="ki if hh ke b fi kn kk l kl km"># Submit the pipeline to be run<br/>pipeline_run1 = Experiment(ws, 'Spacy_Pipeline_Inferencing').submit(pipeline1)<br/>pipeline_run1.wait_for_completion()</span></pre><ul class=""><li id="8e2c" class="jc jd hh je b jf ko jh kp jj kq jl kr jn ks jp jq jr js jt bi translated">一旦实验成功，我们就好了。</li></ul><p id="7537" class="pw-post-body-paragraph kt ku hh je b jf ko kv kw jh kp kx ky jj kz la lb jl lc ld le jn lf lg lh jp ha bi translated">原文—<a class="ae li" href="https://github.com/balakreshnan/Samples2022/blob/main/AzureML/spacyetoe.md" rel="noopener ugc nofollow" target="_blank">samples 2022/spacyetoe . MD at main balakreshnan/samples 2022(github.com)</a></p><div class="lj lk ez fb ll lm"><a rel="noopener follow" target="_blank" href="/mlearning-ai/mlearning-ai-submission-suggestions-b51e2b130bfb"><div class="ln ab dw"><div class="lo ab lp cl cj lq"><h2 class="bd hi fi z dy lr ea eb ls ed ef hg bi translated">Mlearning.ai提交建议</h2><div class="lt l"><h3 class="bd b fi z dy lr ea eb ls ed ef dx translated">如何成为Mlearning.ai上的作家</h3></div><div class="lu l"><p class="bd b fp z dy lr ea eb ls ed ef dx translated">medium.com</p></div></div><div class="lv l"><div class="lw l lx ly lz lv ma mb lm"/></div></div></a></div></div></div>    
</body>
</html>