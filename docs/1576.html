<html>
<head>
<title>Age Detection using CNN with Keras — with source code</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">年龄检测使用CNN与Keras与源代码</h1>
<blockquote>原文：<a href="https://medium.com/mlearning-ai/age-detection-using-cnn-with-keras-with-source-code-easiest-way-easy-implementation-57c107b23bc4?source=collection_archive---------1-----------------------#2022-01-07">https://medium.com/mlearning-ai/age-detection-using-cnn-with-keras-with-source-code-easiest-way-easy-implementation-57c107b23bc4?source=collection_archive---------1-----------------------#2022-01-07</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><p id="aec9" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">所以伙计们，在今天的博客中，我们将在Keras的帮助下使用CNN实现年龄检测。这将是一个非常有趣的项目，所以没有任何进一步的到期。</p><p id="0ff2" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi">在这里阅读带源代码的整篇文章—</strong><a class="ae jc" href="https://machinelearningprojects.net/age-detection-using-cnn-with-keras/" rel="noopener ugc nofollow" target="_blank">https://machine learning projects . net/age-detection-using-CNN-with-keras/</a></p><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es jd"><img src="../Images/68fe9a3a2c6a0a15cb16840e9f29beef.png" data-original-src="https://miro.medium.com/v2/resize:fit:1200/1*_ylEzV5KuUyAwZUKeiYChA.gif"/></div></figure><h1 id="bdbe" class="jl jm hh bd jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki bi translated">让我们开始吧…</h1><h1 id="5607" class="jl jm hh bd jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki bi translated">用于训练模型的代码…</h1><h2 id="ef0e" class="kj jm hh bd jn kk kl km jr kn ko kp jv ip kq kr jz it ks kt kd ix ku kv kh kw bi translated">步骤1-导入所有必需的库。</h2><pre class="je jf jg jh fd kx ky kz la aw lb bi"><span id="0a2a" class="kj jm hh ky b fi lc ld l le lf">import cv2<br/>import pandas as pd<br/>import os<br/>import seaborn as sns<br/>import matplotlib.pyplot as plt<br/>from tensorflow.keras.preprocessing.image import ImageDataGenerator<br/>from tensorflow.keras.models import Sequential<br/>from tensorflow.keras.layers import Conv2D, Dense, Dropout, Flatten, AveragePooling2D, GlobalAveragePooling2D<br/>from tensorflow.keras.callbacks import ModelCheckpoint<br/>import numpy as np<br/>from sklearn.model_selection import train_test_split<br/>from keras.utils import np_utils<br/><br/>np.random.seed(42)<br/>tf.random.set_seed(42)</span></pre><h2 id="7b3d" class="kj jm hh bd jn kk kl km jr kn ko kp jv ip kq kr jz it ks kt kd ix ku kv kh kw bi translated">步骤2-读取输入图像并提取它们的标签。</h2><pre class="je jf jg jh fd kx ky kz la aw lb bi"><span id="6440" class="kj jm hh ky b fi lc ld l le lf">all_images = os.listdir('combined_faces/')<br/>ranges = ['1-2','3-9','10-20','21-27','28-45','46-65','66-116']<br/><br/>X = []<br/>y = []<br/><br/>l = len(all_images)<br/><br/>for a in range(l):<br/>    X.append(cv2.imread(f'combined_faces/{all_images[a]}',0))<br/>    age = int(all_images[a].split('_')[0])<br/>    <br/>    if age&gt;=1 and age&lt;=2:<br/>        y.append(0)<br/>    elif age&gt;=3 and age&lt;=9:<br/>        y.append(1)<br/>    elif age&gt;=10 and age&lt;=20:<br/>        y.append(2)<br/>    elif age&gt;=21 and age&lt;=27:<br/>        y.append(3)<br/>    elif age&gt;=28 and age&lt;=45:<br/>        y.append(4)<br/>    elif age&gt;=46 and age&lt;=65:<br/>        y.append(5)<br/>    elif age&gt;=66 and age&lt;=116:<br/>        y.append(6)<br/>    print(str(a)+'/'+str(l))<br/><br/>np.savez_compressed('compressed image data.npz',x=X,y=y)</span></pre><ul class=""><li id="8099" class="lg lh hh ig b ih ii il im ip li it lj ix lk jb ll lm ln lo bi translated">在这里，我们以灰度模式读取图像，并将它们存储在X数组中。</li><li id="d9c1" class="lg lh hh ig b ih lp il lq ip lr it ls ix lt jb ll lm ln lo bi translated">我们将他们的年龄存储在y数组中。</li><li id="1b2a" class="lg lh hh ig b ih lp il lq ip lr it ls ix lt jb ll lm ln lo bi translated">最后，我们将X和y数组保存为<a class="ae jc" href="https://numpy.org/doc/stable/reference/generated/numpy.savez_compressed.html" rel="noopener ugc nofollow" target="_blank"> npz压缩格式</a>，这样我们就不需要一次又一次地读取图像。</li></ul><p id="c7ff" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">如何加载压缩的npz数据…</p><pre class="je jf jg jh fd kx ky kz la aw lb bi"><span id="1bb2" class="kj jm hh ky b fi lc ld l le lf">loaded = np.load('compressed image data.npz')<br/><br/>X = loaded['x']<br/>y = loaded['y']</span></pre><h2 id="c245" class="kj jm hh bd jn kk kl km jr kn ko kp jv ip kq kr jz it ks kt kd ix ku kv kh kw bi translated">第三步——想象一幅图像。</h2><pre class="je jf jg jh fd kx ky kz la aw lb bi"><span id="8c53" class="kj jm hh ky b fi lc ld l le lf">plt.imshow(X[0],cmap=’gray’)</span></pre><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es lu"><img src="../Images/a78da655084c0e88ce4c6462bd7b04e2.png" data-original-src="https://miro.medium.com/v2/resize:fit:790/format:webp/0*oLdLXB8PBaXSBSLr.png"/></div></figure><h2 id="19c6" class="kj jm hh bd jn kk kl km jr kn ko kp jv ip kq kr jz it ks kt kd ix ku kv kh kw bi translated">步骤4-一个热编码y阵列。</h2><pre class="je jf jg jh fd kx ky kz la aw lb bi"><span id="3e30" class="kj jm hh ky b fi lc ld l le lf">y = np_utils.to_categorical(y)<br/>y</span></pre><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es lv"><img src="../Images/4397344fb1e9e45e7bd9774681b957da.png" data-original-src="https://miro.medium.com/v2/resize:fit:1248/format:webp/0*3n-6D2OkW9IhUXJq.png"/></div></figure><ul class=""><li id="d7fb" class="lg lh hh ig b ih ii il im ip li it lj ix lk jb ll lm ln lo bi translated">在这里，我们只是使用<a class="ae jc" href="https://www.tensorflow.org/api_docs/python/tf/keras/utils/to_categorical" rel="noopener ugc nofollow" target="_blank">NP _ utils . to _ categorial</a>对y数组进行一次热编码。</li></ul><h2 id="6743" class="kj jm hh bd jn kk kl km jr kn ko kp jv ip kq kr jz it ks kt kd ix ku kv kh kw bi translated">步骤5-训练测试使用CNN模型分割用于创建年龄检测的数据。</h2><pre class="je jf jg jh fd kx ky kz la aw lb bi"><span id="e869" class="kj jm hh ky b fi lc ld l le lf">X_train, X_test, y_train, y_test = train_test_split(X, y, test_size=0.30, random_state=42)<br/><br/>X_train = np.array(X_train).reshape(-1,200,200,1)<br/>X_test = np.array(X_test).reshape(-1,200,200,1)</span></pre><ul class=""><li id="0389" class="lg lh hh ig b ih ii il im ip li it lj ix lk jb ll lm ln lo bi translated">我们正在对这里的数据进行训练测试分割，并以正确的格式对X进行整形，以便在后续步骤中将其输入模型。</li></ul><h2 id="e573" class="kj jm hh bd jn kk kl km jr kn ko kp jv ip kq kr jz it ks kt kd ix ku kv kh kw bi translated">步骤6 —初始化一些常量。</h2><pre class="je jf jg jh fd kx ky kz la aw lb bi"><span id="7d6b" class="kj jm hh ky b fi lc ld l le lf">IMG_HEIGHT = 200<br/>IMG_WIDTH = 200<br/>IMG_SIZE = (IMG_HEIGHT,IMG_WIDTH)<br/>batch_size = 128<br/>epochs = 60</span></pre><h2 id="a709" class="kj jm hh bd jn kk kl km jr kn ko kp jv ip kq kr jz it ks kt kd ix ku kv kh kw bi translated">步骤7-为数据扩充创建ImageDataGenerator对象。</h2><pre class="je jf jg jh fd kx ky kz la aw lb bi"><span id="b1d9" class="kj jm hh ky b fi lc ld l le lf">train_datagen = ImageDataGenerator(rescale=1./255,<br/>                                   horizontal_flip=True,<br/>                                   shear_range=0.2,<br/>                                   zoom_range=0.2,<br/>                                   height_shift_range=0.1,<br/>                                   width_shift_range=0.1,<br/>                                   rotation_range=15)<br/><br/>test_datagen = ImageDataGenerator(rescale=1./255)</span></pre><ul class=""><li id="4243" class="lg lh hh ig b ih ii il im ip li it lj ix lk jb ll lm ln lo bi translated">使用<a class="ae jc" href="https://keras.io/api/preprocessing/image/" rel="noopener ugc nofollow" target="_blank"> ImageDataGenerator </a>创建数据扩充对象。</li></ul><h2 id="9371" class="kj jm hh bd jn kk kl km jr kn ko kp jv ip kq kr jz it ks kt kd ix ku kv kh kw bi translated">步骤8-使用CNN模型增加年龄检测的数据。</h2><pre class="je jf jg jh fd kx ky kz la aw lb bi"><span id="064c" class="kj jm hh ky b fi lc ld l le lf">train_data = train_datagen.flow(X_train,y_train,batch_size)<br/>test_data = test_datagen.flow(X_test,y_test,batch_size)</span></pre><ul class=""><li id="42ea" class="lg lh hh ig b ih ii il im ip li it lj ix lk jb ll lm ln lo bi translated">最后使用<a class="ae jc" href="https://keras.io/api/preprocessing/image/" rel="noopener ugc nofollow" target="_blank">流程</a>扩充数据。</li></ul><h2 id="eb28" class="kj jm hh bd jn kk kl km jr kn ko kp jv ip kq kr jz it ks kt kd ix ku kv kh kw bi translated">步骤9 —使用CNN模型创建年龄检测。</h2><pre class="je jf jg jh fd kx ky kz la aw lb bi"><span id="5d28" class="kj jm hh ky b fi lc ld l le lf">final_cnn = Sequential()<br/><br/>final_cnn.add(Conv2D(filters=32, kernel_size=3, activation='relu', input_shape=(200, 200, 1)))    # 3rd dim = 1 for grayscale images.<br/>final_cnn.add(AveragePooling2D(pool_size=(2,2)))<br/><br/>final_cnn.add(Conv2D(filters=64, kernel_size=3, activation='relu'))<br/>final_cnn.add(AveragePooling2D(pool_size=(2,2)))<br/><br/>final_cnn.add(Conv2D(filters=128, kernel_size=3, activation='relu'))<br/>final_cnn.add(AveragePooling2D(pool_size=(2,2)))<br/><br/>final_cnn.add(Conv2D(filters=256, kernel_size=3, activation='relu'))<br/>final_cnn.add(AveragePooling2D(pool_size=(2,2)))<br/><br/>final_cnn.add(GlobalAveragePooling2D())<br/><br/>final_cnn.add(Dense(132, activation='relu'))<br/><br/>final_cnn.add(Dense(7, activation='softmax'))<br/><br/>final_cnn.compile(loss='categorical_crossentropy', optimizer='adam', metrics=['accuracy'])<br/><br/>final_cnn.summary()</span></pre><ul class=""><li id="2cbe" class="lg lh hh ig b ih ii il im ip li it lj ix lk jb ll lm ln lo bi translated">在这里，我们已经创建并编译了我们的模型。</li></ul><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es lw"><img src="../Images/6e6c9a8162504ed78eed87ddb072069e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1394/format:webp/0*UfOLnlBOxa91NHrG.png"/></div></figure><h2 id="6741" class="kj jm hh bd jn kk kl km jr kn ko kp jv ip kq kr jz it ks kt kd ix ku kv kh kw bi translated">步骤10——创建一个模型检查点来保存最好的模型。</h2><pre class="je jf jg jh fd kx ky kz la aw lb bi"><span id="c92d" class="kj jm hh ky b fi lc ld l le lf">checkpoint = ModelCheckpoint(filepath="final_cnn_model_checkpoint.h5",<br/>                             monitor='val_accuracy',<br/>                             save_best_only=True,<br/>                             save_weights_only=False,<br/>                             verbose=1<br/>                            )</span></pre><ul class=""><li id="e9c5" class="lg lh hh ig b ih ii il im ip li it lj ix lk jb ll lm ln lo bi translated"><a class="ae jc" href="https://keras.io/api/callbacks/model_checkpoint/" rel="noopener ugc nofollow" target="_blank">模型检查点</a>只是Keras中的一个简单回调，它表示只存储最好的模型。</li><li id="c0a5" class="lg lh hh ig b ih lp il lq ip lr it ls ix lt jb ll lm ln lo bi translated">这里的最佳模型是指具有最高价值的模型。</li></ul><h2 id="abac" class="kj jm hh bd jn kk kl km jr kn ko kp jv ip kq kr jz it ks kt kd ix ku kv kh kw bi translated">步骤11-使用CNN模型训练年龄检测。</h2><pre class="je jf jg jh fd kx ky kz la aw lb bi"><span id="3b78" class="kj jm hh ky b fi lc ld l le lf">history = final_cnn.fit(train_data,<br/>                    batch_size=batch_size,<br/>                    validation_data=test_data,<br/>                    epochs=epochs,<br/>                    callbacks=[checkpoint],<br/>                    shuffle=False    <br/>                    )</span></pre><h2 id="3a21" class="kj jm hh bd jn kk kl km jr kn ko kp jv ip kq kr jz it ks kt kd ix ku kv kh kw bi translated">第12步——想象培训过程。</h2><pre class="je jf jg jh fd kx ky kz la aw lb bi"><span id="eb7e" class="kj jm hh ky b fi lc ld l le lf">plotting_data_dict = history.history<br/><br/>plt.figure(figsize=(12,8))<br/><br/>test_loss = plotting_data_dict['val_loss']<br/>training_loss = plotting_data_dict['loss']<br/>test_accuracy = plotting_data_dict['val_accuracy']<br/>training_accuracy = plotting_data_dict['accuracy']<br/><br/>epochs = range(1,len(test_loss)+1)<br/><br/>plt.subplot(121)<br/>plt.plot(epochs,test_loss,marker='X',label='test_loss')<br/>plt.plot(epochs,training_loss,marker='X',label='training_loss')<br/>plt.legend()<br/><br/>plt.subplot(122)<br/>plt.plot(epochs,test_accuracy,marker='X',label='test_accuracy')<br/>plt.plot(epochs,training_accuracy,marker='X',label='training_accuracy')<br/>plt.legend()<br/><br/>plt.savefig('training.png')</span></pre><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="ly lz di ma bf mb"><div class="er es lx"><img src="../Images/52f65d8b74833109b54679f69b649a89.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*xMd-OMT7rF6aeSCf.png"/></div></div></figure><h1 id="b8c1" class="jl jm hh bd jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki bi translated">代码为生活摄像头预测年龄检测使用CNN…</h1><pre class="je jf jg jh fd kx ky kz la aw lb bi"><span id="c5ac" class="kj jm hh ky b fi lc ld l le lf">import cv2<br/>import imutils<br/>import numpy as np<br/>from tensorflow.keras.models import load_model<br/><br/>model = load_model('age_detect_cnn_model.h5')<br/><br/>detector = cv2.CascadeClassifier('haarcascade_frontalface_default.xml')<br/><br/>ranges = ['1-2','3-9','10-20','21-27','28-45','46-65','66-116']<br/><br/>cam = cv2.VideoCapture(0)<br/><br/>while 1:<br/>    ret,frame = cam.read()<br/>    if ret:<br/>        faces = detector.detectMultiScale(frame,1.3,5)<br/>        for x,y,w,h in faces:<br/>            face = frame[y:y+h,x:x+w]<br/>            face = cv2.cvtColor(face,cv2.COLOR_BGR2GRAY)<br/>            face = cv2.resize(face,(200,200))<br/>            face = face.reshape(1,200,200,1)<br/>            age = model.predict(face)<br/>            cv2.rectangle(frame,(x,y),(x+w,y+h),(255,0,0),2)<br/>            cv2.rectangle(frame,(x,y+h),(x+w,y+h+50),(255,0,0),-1)<br/>            cv2.putText(frame,ranges[np.argmax(age)],(x+65,y+h+35),cv2.FONT_HERSHEY_DUPLEX,0.8,(255,255,255),2)<br/>            <br/>        cv2.imshow('Live',frame)<br/>        <br/>        <br/>    if cv2.waitKey(1)==27:<br/>        break<br/><br/>cam.release()<br/>cv2.destroyAllWindows()</span></pre><ul class=""><li id="5170" class="lg lh hh ig b ih ii il im ip li it lj ix lk jb ll lm ln lo bi translated">第1–4行—导入所需的库。</li><li id="9ed1" class="lg lh hh ig b ih lp il lq ip lr it ls ix lt jb ll lm ln lo bi translated">第6行—加载我们上面训练的年龄检测器模型。</li><li id="3710" class="lg lh hh ig b ih lp il lq ip lr it ls ix lt jb ll lm ln lo bi translated">第8行——使用Haarcascades检测帧中的人脸。</li><li id="e5cb" class="lg lh hh ig b ih lp il lq ip lr it ls ix lt jb ll lm ln lo bi translated">第10行——创建一个年龄范围数组，我们在此数组上训练我们的模型。</li><li id="57c5" class="lg lh hh ig b ih lp il lq ip lr it ls ix lt jb ll lm ln lo bi translated">第12行—启动VideoCapture对象以访问网络摄像头。</li><li id="bded" class="lg lh hh ig b ih lp il lq ip lr it ls ix lt jb ll lm ln lo bi translated">第14–32行—从网络摄像头读取图像，检测面部，裁剪面部，灰度化面部，调整面部大小，将其整形为Keras模型预测所需的(1，200，200，1)格式，然后最终预测年龄范围并显示在最终图像上。</li><li id="081c" class="lg lh hh ig b ih lp il lq ip lr it ls ix lt jb ll lm ln lo bi translated">第34–35行—释放相机对象并销毁所有窗口。</li></ul><h1 id="29c1" class="jl jm hh bd jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki bi translated">使用CNN的年龄检测的最终结果…</h1><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es jd"><img src="../Images/68fe9a3a2c6a0a15cb16840e9f29beef.png" data-original-src="https://miro.medium.com/v2/resize:fit:1200/1*_ylEzV5KuUyAwZUKeiYChA.gif"/></div><figcaption class="mc md et er es me mf bd b be z dx">Live age detection</figcaption></figure><p id="4541" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">如果对CNN的年龄检测有任何疑问，请通过电子邮件或LinkedIn联系我。</p><p id="3af3" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi"> <em class="mg">探索更多机器学习、深度学习、计算机视觉、NLP、Flask项目访问我的博客— </em> </strong> <a class="ae jc" href="https://machinelearningprojects.net/" rel="noopener ugc nofollow" target="_blank"> <strong class="ig hi"> <em class="mg">机器学习项目</em> </strong> </a></p><p id="56be" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi">如需进一步的代码解释和源代码，请访问此处</strong>—<a class="ae jc" href="https://machinelearningprojects.net/age-detection-using-cnn-with-keras/" rel="noopener ugc nofollow" target="_blank">https://machine learning projects . net/age-detection-using-CNN-with-keras/</a></p><p id="c4de" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><em class="mg">所以这就是我写给这个博客的所有内容，感谢你阅读它，我希望你在阅读完这篇文章后会有所收获，直到下一次👋… </em></p><p id="95b2" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi"> <em class="mg">看我以前的帖子:</em> </strong> <a class="ae jc" href="https://machinelearningprojects.net/cats-and-dogs-classifier/" rel="noopener ugc nofollow" target="_blank"> <strong class="ig hi"> <em class="mg"> CATS和DOGS的量词——最简单的方法</em> </strong> </a></p><div class="mh mi ez fb mj mk"><a rel="noopener follow" target="_blank" href="/mlearning-ai/mlearning-ai-submission-suggestions-b51e2b130bfb"><div class="ml ab dw"><div class="mm ab mn cl cj mo"><h2 class="bd hi fi z dy mp ea eb mq ed ef hg bi translated">Mlearning.ai提交建议</h2><div class="mr l"><h3 class="bd b fi z dy mp ea eb mq ed ef dx translated">如何成为Mlearning.ai上的作家</h3></div><div class="ms l"><p class="bd b fp z dy mp ea eb mq ed ef dx translated">medium.com</p></div></div><div class="mt l"><div class="mu l mv mw mx mt my jj mk"/></div></div></a></div></div></div>    
</body>
</html>